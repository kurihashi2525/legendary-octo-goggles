<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€æœ€çµ‚å®Ÿè£…ç‰ˆã€‘AIè¨˜è€…ä»˜ããƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨</title>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@700&display=swap" rel="stylesheet">
 <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
/* styleã‚¿ã‚°å†…ã®åˆ†ã‹ã‚Šã‚„ã™ã„å ´æ‰€ã«è¿½åŠ  */

/* â–¼â–¼â–¼ å‹¢åŠ›å›³åˆ†æã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®CSSï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿®æ­£ç‰ˆï¼‰â–¼â–¼â–¼ */
#analysis-stage {
    background: radial-gradient(ellipse at center, rgba(15, 23, 42, 1) 0%, rgba(0, 0, 0, 1) 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    padding: 2rem; /* å†…å´ã«ä½™ç™½ã‚’è¿½åŠ  */
}
.round-column {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    height: 100%;
}
.analysis-matchup {
    margin: 10px 0;
    position: relative;
}
.analysis-team {
    padding: 4px 10px;
    background-color: rgba(0, 183, 255, 0.2);
    border: 1px solid rgba(0, 183, 255, 0.7);
    color: #e0f2fe;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.9rem;
    margin: 4px 0;
    transition: all 0.5s ease-in-out;
    opacity: 0;
    width: 150px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    /* â–¼â–¼â–¼ ä»¥ä¸‹ã®2è¡Œã‚’å‰Šé™¤ã€ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ â–¼â–¼â–¼ */
    /* position: absolute; */
    /* â–²â–²â–² */
}
.analysis-team.show {
    opacity: 1;
}
.analysis-team.highlight {
    background-color: rgba(255, 204, 0, 0.4);
    border-color: rgba(255, 204, 0, 1);
    color: white;
    transform: scale(1.1);
    box-shadow: 0 0 15px rgba(255, 204, 0, 0.7);
}

/* å‹ã¡ä¸ŠãŒã‚Šç·šã®ã‚¹ã‚¿ã‚¤ãƒ« */
.matchup-connector {
    position: absolute;
    top: 50%;
    right: -20px;
    width: 20px;
    height: 2px;
    background-color: rgba(0, 183, 255, 0.5);
}
.round-connector {
    position: absolute;
    top: 25%;
    right: -30px;
    width: 2px;
    height: 50%;
    background-color: rgba(0, 183, 255, 0.5);
}
/* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */

/* ã¾ã¨ã‚ã‚µã‚¤ãƒˆã®ãƒ­ã‚´ã‚¹ã‚¿ã‚¤ãƒ« */
.matome-site-logo-container {
    position: relative;
    width: 80px; /* ãƒ­ã‚´ã®å¹… */
    height: 50px; /* ãƒ­ã‚´ã®é«˜ã• */
    overflow: hidden;
    border-radius: 5px; /* è§’ã‚’å°‘ã—ä¸¸ã‚ã‚‹ */
    box-shadow: 0 2px 4px rgba(0,0,0,0.3); /* å½±ã§ç«‹ä½“æ„Ÿã‚’å‡ºã™ */
}

.matome-site-logo-bg {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ç”»åƒã‚’ã‚³ãƒ³ãƒ†ãƒŠã«åˆã‚ã›ã¦è¡¨ç¤º */
    position: absolute;
    top: 0;
    left: 0;
    filter: brightness(0.7) blur(1px); /* å°‘ã—æš—ãã€ã¼ã‹ã—ã¦æ–‡å­—ã‚’èª­ã¿ã‚„ã™ã */
}

.matome-site-logo-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    font-size: 0.9rem; /* æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8); /* æ–‡å­—ã®è¦–èªæ€§ã‚’é«˜ã‚ã‚‹å½± */
    white-space: nowrap; /* ãƒ†ã‚­ã‚¹ãƒˆã®æŠ˜ã‚Šè¿”ã—ã‚’é˜²ã */
}

/* æ–°ã—ã„ã¾ã¨ã‚ã‚µã‚¤ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º (TailwindCSS JIT mode with plugins is better, but this is a quick fix) */
.scrollbar-thin {
    scrollbar-width: thin;
    scrollbar-color: #a0aec0 #edf2f7; /* thumb color track color */
}

.scrollbar-thin::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.scrollbar-thin::-webkit-scrollbar-thumb {
    background-color: #a0aec0; /* gray-400 */
    border-radius: 10px;
    border: 2px solid #edf2f7; /* gray-200 */
}

.scrollbar-thin::-webkit-scrollbar-track {
    background-color: #edf2f7; /* gray-200 */
    border-radius: 10px;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ­ã‚´ç”»åƒã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¸¦æ–¹å‘ã«ä¸­å¤®æƒãˆ */
#integrated-matome-modal .flex.justify-between.items-center img {
    vertical-align: middle;
}

/* ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.matome-tab-btn {
    position: relative;
    z-index: 1;
    margin-right: -1px; /* ã‚¿ãƒ–é–“ã®éš™é–“ã‚’ãªãã™ */
    border: 1px solid #e2e8f0; /* gray-300 */
    border-bottom: none;
    background-color: #f7fafc; /* gray-50 */
}
.matome-tab-btn.active {
    background-color: #2563eb; /* blue-600 */
    color: white;
    border-color: #2563eb; /* active tab border color */
    border-bottom-color: transparent;
    z-index: 2;
}

/* è¨˜äº‹ãƒªãƒ³ã‚¯ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
.matome-article-link p.font-bold:hover {
    color: #2563eb; /* blue-600 */
    text-decoration: underline;
}

/* BBSã‚³ãƒ¡ãƒ³ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
.bbs-comment {
    background-color: #ffffff;
    border: 1px solid #e2e8f0;
    padding: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}
.bbs-comment p.font-semibold {
    color: #4a5568; /* gray-700 */
    font-size: 0.875rem; /* text-sm */
    margin-bottom: 0.25rem;
}
.bbs-comment p.text-gray-800 {
    color: #2d3748; /* gray-800 */
    line-height: 1.5;
}

/* â–¼â–¼â–¼ æ–°ã—ã„ãƒ­ãƒ¼ãƒ€ãƒ¼ç”¨ã®CSS â–¼â–¼â–¼ */
.loader {
    text-align: center;
    padding: 40px 20px;
    font-style: italic;
    color: #4b5563; /* gray-600 */
    font-size: 1.1rem;
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 8px;
    margin: 1rem 0;
}

.loader .ellipsis span {
    opacity: 0;
    animation: pulse-ellipsis 1.4s infinite;
}
.loader .ellipsis span:nth-child(1) { animation-delay: 0s; }
.loader .ellipsis span:nth-child(2) { animation-delay: 0.2s; }
.loader .ellipsis span:nth-child(3) { animation-delay: 0.4s; }

@keyframes pulse-ellipsis {
    0% { opacity: 0.2; }
    50% { opacity: 1; }
    100% { opacity: 0.2; }
}
/* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */

/* â–¼â–¼â–¼ ç¦ã€…ã—ã„é›°å›²æ°—ç”¨ã®CSS â–¼â–¼â–¼ */
.dread-mode-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(127, 29, 29, 0.5); /* ä¸æ°—å‘³ãªèµ¤è‰²ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    z-index: 199; /* æŠ½é¸ä¼šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã™ãä¸‹ */
    pointer-events: none;
    animation: fadeIn 0.5s forwards;
}

#lottery-pot.dread {
    background-color: #7f1d1d; /* red-900 */
    border-color: #fca5a5; /* red-300 */
    animation: pulse-dread 1s infinite;
}

@keyframes pulse-dread {
    0%, 100% {
        transform: scale(1.05);
        box-shadow: 0 0 15px 5px rgba(255, 100, 100, 0.7);
    }
    50% {
        transform: scale(1.1);
        box-shadow: 0 0 30px 15px rgba(255, 100, 100, 0.9);
    }
}
/* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠ½é¸ä¼šã‚¤ãƒ™ãƒ³ãƒˆç”¨ã®CSS â–¼â–¼â–¼ */
#drawn-team-container.fade-in-out {
    animation: fadeInOut 2.5s ease-in-out forwards;
}

@keyframes fadeInOut {
    0% { opacity: 0; transform: scale(0.8); }
    20%, 80% { opacity: 1; transform: scale(1); }
    100% { opacity: 0; transform: scale(0.8); }
}

.lottery-slot {
    border: 1px solid #d1d5db;
    background-color: #f3f4f6;
    padding: 4px 8px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 4px;
    transition: all 0.3s ease-in-out;
}
.lottery-slot.filled {
    background-color: #fffbeb; /* amber-100 */
    border-color: #f59e0b; /* amber-500 */
    font-weight: 700;
    transform: scale(1.05);
}
.lottery-slot.highlight {
    background-color: #ef4444; /* red-500 */
    color: white;
    border-color: #b91c1c; /* red-700 */
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
.animate-fade-in-up {
    animation: fadeInUp 0.5s ease-out forwards;
}
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
/* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */

/* Weather Effects */
.rain {
    position: absolute;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2;
}
.drop {
    position: absolute;
    bottom: 100%;
    width: 1px;
    height: 50px;
    background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.4));
    animation: drop 0.5s linear infinite;
}
@keyframes drop {
    to { transform: translateY(100vh); }
}

.sunshine {
    position: absolute;
    top: -50px;
    left: -50px;
    width: 100px;
    height: 100px;
    z-index: 2;
}
.sun {
    position: absolute;
    width: 100px;
    height: 100px;
    background: radial-gradient(circle, rgba(255,255,220,0.8) 0%, rgba(255,255,220,0) 60%);
    border-radius: 50%;
}
.sun-flare {
    position: absolute;
    width: 200px;
    height: 200px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    animation: flare 5s infinite;
}
@keyframes flare {
    0% { transform: scale(1); opacity: 0.1; }
    50% { transform: scale(1.2); opacity: 0.2; }
    100% { transform: scale(1); opacity: 0.1; }
}

/* Weather Control Buttons */
.weather-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.5);
    background-color: rgba(255, 255, 255, 0.2);
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}
.weather-btn:hover {
    background-color: rgba(255, 255, 255, 0.4);
    border-color: white;
}

/* â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ  â–¼â–¼â–¼ */
        .subtitle-text {
            color: white;
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.7);
        }
        .setup-header {
            color: white !important; /* Tailwind CSSã‚ˆã‚Šå„ªå…ˆã•ã›ã‚‹ */
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.7);
            border-bottom-color: rgba(255, 255, 255, 0.5) !important; /* ä¸‹ç·šã‚‚ç™½ã£ã½ãã™ã‚‹ */
        }
        /* â–²â–²â–² â–²â–²â–² */

/* â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ  â–¼â–¼â–¼ */
     .main-title {
            font-family: 'Yuji Syuku', serif;
            font-size: 3rem; /* å°‘ã—å¤§ããã—ã¦è¿«åŠ›ã‚’å‡ºã™ */
            letter-spacing: 0.2em; /* æ–‡å­—é–“ã‚’èª¿æ•´ */
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
            animation: fadeIn 2s ease-in-out; /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        }

        .subtitle-text {
            color: white;
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.7);
            animation: fadeIn 2.2s ease-in-out; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  */
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã‚’ã‚¬ãƒ©ã‚¹ãƒ‘ãƒãƒ«é¢¨ã« */
        .setup-card {
            background-color: rgba(10, 10, 20, 0.65) !important; /* åŠé€æ˜èƒŒæ™¯ã‚’å„ªå…ˆ */
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px); /* èƒŒæ™¯ã‚’ã¼ã‹ã™ï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰ */
            padding: 2.5rem !important; /* paddingã‚’èª¿æ•´ */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            animation: fadeIn 1.5s ease-in-out;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .setup-header {
            color: white !important;
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.7);
            border-bottom-color: rgba(255, 255, 255, 0.5) !important;
        }

        /* ãƒãƒ¼ãƒ ä¸€è¦§ã‚¨ãƒªã‚¢ã‚’åç°¿é¢¨ã« */
        #teams-list {
            background-color: rgba(0, 0, 0, 0.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #f0f0f0 !important;
            font-size: 0.9rem;
            line-height: 1.6;
            padding: 1.5rem !important;
        }

        /* ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  */
        #setup .mt-8 {
            animation: fadeIn 2.5s ease-in-out;
        }

        /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾© */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

/* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */

/* â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ  â–¼â–¼â–¼ */
#news-ticker-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    display: flex;
    align-items: center;
    z-index: 50; /* ä»–ã®è¦ç´ ã‚ˆã‚Šæ‰‹å‰ã« */
    height: 30px;
    font-family: 'Noto Sans JP', sans-serif;
    border-top: 1px solid rgba(255, 255, 255, 0.3);
}
.ticker-label {
    background-color: #e53935; /* èµ¤è‰² */
    font-weight: bold;
    padding: 0 12px;
    height: 100%;
    display: flex;
    align-items: center;
    font-size: 0.9rem;
}
.ticker-content {
    flex-grow: 1;
    overflow: hidden; /* ã¯ã¿å‡ºã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’éš ã™ */
    padding-left: 1rem;
}
#ticker-text {
    white-space: nowrap; /* ãƒ†ã‚­ã‚¹ãƒˆã‚’æ”¹è¡Œã•ã›ãªã„ */
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã‚’å°‘ã—é•·ã‚ã«è¨­å®šã—ã¦ã‚†ã£ãã‚Šæµã™ */
    animation: scroll-ticker 40s linear infinite;
}
@keyframes scroll-ticker {
    0% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
}
/* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */

/* å†™å®Ÿçš„ãªå¤©å€™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
   /* å†™å®Ÿçš„ãªå¤©å€™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆâ˜…èª¿æŸ»ãƒ¢ãƒ¼ãƒ‰â˜…ï¼‰ */
/* èƒŒæ™¯ç”»åƒ */
.ballpark-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1; /* Layer 1 (Bottom) */
    /* â–¼â–¼â–¼ This line is the only change â–¼â–¼â–¼ */
    background-image: url('ballpark.jpg'); /* Use the local image */
    /* â–²â–²â–² END OF CHANGE â–²â–²â–² */
    background-size: cover;
    background-position: center;
    filter: blur(2px) brightness(0.7);
    animation: subtle-breathing 20s ease-in-out infinite;
}
/* åœŸåŸƒã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚³ãƒ³ãƒ†ãƒŠ */
#dust-container {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã®é‚ªé­”ã‚’ã—ãªã„ */
    z-index: 2; /* éšå±¤2ï¼ˆä¸­é–“ï¼‰ */
}
/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚³ãƒ³ãƒ†ãƒŠ */
#app-container {
    position: relative; /* z-indexã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ */
    z-index: 3; /* éšå±¤3ï¼ˆä¸€ç•ªæ‰‹å‰ï¼‰ */
}
@keyframes subtle-breathing {
    0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); }
}
.dust-particle {
    position: absolute; background-color: rgba(255, 255, 255, 0.5);
    border-radius: 50%; opacity: 0; animation: drift-up linear infinite;
}
@keyframes drift-up {
    0% { transform: translateY(100vh) translateX(var(--x-start)); opacity: 0; }
    10% { opacity: 1; } 90% { opacity: 1; }
    100% { transform: translateY(-100px) translateX(var(--x-end)); opacity: 0; }
}
/* Input field color-coding */
.result-hit { background-color: #eff6ff !important; color: #1d4ed8; } /* Blue for hits */
.result-out { background-color: #fee2e2 !important; color: #b91c1c; } /* Red for outs */
.result-on-base { background-color: #f0fdf4 !important; color: #15803d; } /* Green for walks, etc. */

.clickable-team-name {
    cursor: pointer;
    transition: color 0.2s;
}
.clickable-team-name:hover {
    color: #1d4ed8; /* blue-700 */
}
        body { 
    font-family: 'Inter', 'Noto Sans JP', sans-serif; 
}
.setup-card { 
    background-color: transparent; /* èƒŒæ™¯ã‚’é€æ˜ã« */
    padding: 24px; 
    border-radius: 12px; 
    box-shadow: none; /* å½±ã‚’å‰Šé™¤ */
    margin-bottom: 24px;
}
.display-card {
    background-color: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 24px;
}
        #main-bracket-container { display: flex; justify-content: center; padding: 20px; font-size: 12px; overflow-x: auto; border: 1px solid #e5e7eb; background-color: #f9fafb; border-radius: 8px;}
        .bracket-half { display: flex; }
        .bracket-half.right { flex-direction: row-reverse; }
        .bracket-final { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0 10px; flex-shrink: 0; min-width: 60px; }
        .bracket-final .final-matchup { border: 2px solid #f59e0b; background-color: #fffbeb; border-radius: 6px; padding: 5px; margin-top: 10px; }
        .bracket-final .winner-box { font-weight: bold; color: #b45309; text-align: center; padding: 10px 20px; white-space: nowrap; font-size: 1.25rem; }
        .bracket-final .final-title { font-weight: 600; color: #4b5563; margin-bottom: 10px; writing-mode: vertical-rl; letter-spacing: 2px; }
        .round { display: flex; flex-direction: column; justify-content: space-around; flex-shrink: 0; width: 230px; padding: 0 10px; }
        .matchup { margin: 8px 0; position: relative; display: flex; flex-direction: column; justify-content: center; flex-grow: 1; }
        .team-slot { display: flex; align-items: center; background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 4px; transition: background-color 0.3s; position: relative; }
        .team-slot:last-of-type { margin-bottom: 0; }
        .team-name { flex-grow: 1; padding: 6px 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .team-name .rank { font-weight: bold; margin-right: 4px; }
        .team-name .rank-A { color: #ef4444; }
        .team-name .rank-B { color: #f97316; }
        .team-name .rank-C { color: #eab308; }
        .team-name .rank-D { color: #3b82f6; }
        .team-name .rank-E { color: #6b7280; }
        .team-name.seed { font-weight: bold; color: #ca8a04; }
        .score-input { width: 40px; padding: 6px 4px; border-left: 1px solid #e5e7eb; text-align: center; background-color: #fff; }
        .win-btn { background-color: #d1d5db; color: #fff; border: none; padding: 6px 8px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .team-slot:not(.empty) .win-btn { background-color: #3b82f6; }
        .team-slot:not(.empty):hover .win-btn { background-color: #2563eb; }
        .team-slot.winner { background-color: #dbeafe; border-color: #93c5fd; font-weight: 600; }
        .team-slot.loser { background-color: #f3f4f6; opacity: 0.6; }
        .team-slot.empty .team-name { color: #9ca3af; }
        .team-slot.empty .score-input, .team-slot.empty .win-btn, .team-slot.empty .details-btn { display: none; }
        .matchup::after { content: ''; position: absolute; top: 50%; width: 10px; height: 2px; background-color: #cbd5e1; }
        .bracket-half.left .matchup::after { right: -10px; }
        .bracket-half.right .matchup::after { left: -10px; }
        .round.subsequent-round .matchup::before { content: ''; position: absolute; top: -8px; height: calc(100% + 16px); width: 2px; background-color: #cbd5e1; }
        .bracket-half.left .round.subsequent-round .matchup::before { right: -10px; }
        .bracket-half.right .round.subsequent-round .matchup::before { left: -10px; }
        .hidden { display: none; }
        .news-article { border-left: 4px solid #3b82f6; cursor: pointer; transition: background-color 0.2s; }
        #modal-bg { background-color: rgba(0,0,0,0.5); }
        .confirm-modal, .details-modal, .save-load-modal, .newspaper-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .confirm-modal-content, .details-modal-content, .save-load-modal-content, .newspaper-modal-content { background-color: white; padding: 24px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .details-modal-content { width: 95%; max-width: 1000px; max-height: 90vh; overflow-y: auto;}
        .save-load-modal-content { width: 95%; max-width: 500px; }
        .newspaper-modal-content { width: 95%; max-width: 800px; max-height: 95vh; overflow-y: auto; }
        .confirm-modal-content { text-align: center; }
        .loader { text-align: center; padding: 20px; font-style: italic; color: #6b7280; }
        .details-btn { background-color: #6b7280; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: auto; margin-right: 2px; }
        .details-btn:hover { background-color: #4b5563; }
        .matchup-footer { text-align: center; margin-top: 2px; display: flex; justify-content: center; align-items: center; gap: 4px;}
        .stats-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .stats-table th, .stats-table td { border: 1px solid #e5e7eb; padding: 4px 6px; text-align: center; }
        .stats-table th { background-color: #f3f4f6; }
        .stats-table input { width: 100%; border: none; text-align: center; background: transparent;}
        .stats-table input:focus { outline: 1px solid #3b82f6; }
        .modal-body-scroll { max-height: 70vh; overflow-y: auto; }
        #save-code-output { word-break: break-all; background-color: #f3f4f6; padding: 8px; border-radius: 4px; max-height: 200px; overflow-y: auto; user-select: all; }
        .bbs-comment { background-color: #ffffff; border: 1px solid #e5e7eb; padding: 8px 12px; border-radius: 8px; font-size: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .match-summary-input { resize: none; height: 40px; }
        .article-error { background-color: #fee2e2; border-left: 4px solid #ef4444; color: #b91c1c; padding: 1rem; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .retry-btn { background-color: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; }
        .retry-btn:hover { background-color: #dc2626; }
        .namco-news-item { cursor: pointer; transition: background-color 0.2s; }
        .namco-news-tag { background-color: #f97316; color: white; font-size: 0.75rem; padding: 2px 8px; border-radius: 9999px; margin-left: 8px; }
      
.region-map-scroll-container {
    display: flex;
    overflow-x: auto;
    padding-bottom: 16px; /* Space for the scrollbar */
    gap: 16px;
}
.region-column { 
    flex: 0 0 250px; /* Prevent cards from shrinking */
    background-color: #ffffff; 
    border: 1px solid #e5e7eb; 
    border-radius: 8px; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
}
.region-header { 
    padding: 12px 16px; 
    background-color: #f9fafb; 
    border-bottom: 1px solid #e5e7eb; 
}
.region-title { 
    font-weight: 700; 
    font-size: 1.1rem; 
    color: #1f2937; 
}
.region-stats { 
    font-size: 0.8rem; 
    color: #4b5563; 
    font-weight: 500;
}
.region-team-list { 
    list-style: none; 
    padding: 12px 16px; 
    margin: 0;
    flex-grow: 1; /* Allow list to fill space */
}
.region-team { 
    padding: 6px 0; 
    font-size: 0.9rem;
    border-bottom: 1px solid #f3f4f6;
}
.region-team:last-child {
    border-bottom: none;
}
.team-surviving { 
    font-weight: 500; 
    color: #1f2937; 
}
.team-eliminated { 
    color: #9ca3af; 
    text-decoration: line-through; 
}
         .scorebook-font {
            font-family: 'Yuji Syuku', serif;
        }
        .newspaper-container { font-family: 'Noto Serif JP', serif; padding: 2rem; background-color: #fdfdf8; }
        .newspaper-early { filter: grayscale(100%); border: 2px solid #333; }
        .newspaper-late { border: 2px solid #a10e25; }
        .newspaper-header { text-align: center; border-bottom: 4px double #333; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .newspaper-title { font-size: 1.2rem; font-weight: 700; }
        .newspaper-date { font-size: 0.8rem; }
        .newspaper-content { display: flex; gap: 1.5rem; }
        .newspaper-main-headline { writing-mode: vertical-rl; text-orientation: mixed; font-size: 2.5rem; font-weight: 700; letter-spacing: 0.2em; border-right: 2px solid #333; padding-right: 1rem; margin-right: 1rem; }
        .newspaper-late .newspaper-main-headline { color: #a10e25; border-right-color: #a10e25;}
        .newspaper-body-content { flex-grow: 1; }
        .newspaper-sub-headline { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; border-bottom: 1px solid #666; padding-bottom: 0.5rem; }
        .newspaper-late .newspaper-sub-headline { color: #333; }
        .newspaper-text { font-family: 'Noto Sans JP', sans-serif; column-count: 3; column-gap: 1.5rem; text-align: justify; font-size: 0.9rem; line-height: 1.8; }
        .newspaper-early .newspaper-text { column-count: 2; }
        .newspaper-score-box { border: 2px solid #333; padding: 1rem; text-align: center; margin-top: 1rem; }
        .newspaper-score-box h3 { font-weight: 700; margin-bottom: 0.5rem; font-size: 1.1rem; }
        .newspaper-score-box .score { font-size: 2rem; font-weight: 700; }
        .newspaper-late .newspaper-score-box { background-color: #fff8f8; border-color: #a10e25; }
        .newspaper-image-placeholder { width: 100%; height: 200px; background-color: #e0e0e0; margin: 1rem 0; display: flex; align-items: center; justify-content: center; font-family: 'Noto Sans JP', sans-serif; color: #888; border: 1px dashed #aaa; }
        .rivalry-match .team-slot { border: 2px solid #ef4444 !important; background-color: #fff1f2; }
        .feud-match .team-slot { border: 2px solid #8b5cf6 !important; background-color: #f5f3ff; }
        .rivalry-match .team-slot.winner { background-color: #fecaca; }
        .feud-match .team-slot.winner { background-color: #ddd6fe; }
   Â 
/* è©³ç´°å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
/* è©³ç´°å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæœ€çµ‚ç‰ˆï¼‰ */

/* â–¼â–¼â–¼ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³èª¬æ˜ç”¨ã®CSS â–¼â–¼â–¼ */
.match-schedule {
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 11px;
            font-weight: 600;
            color: #4b5563; /* gray-600 */
            text-align: center;
            padding: 2px 0;
            border-top: 1px dashed #cbd5e1; /* gray-300 */
            border-bottom: 1px dashed #cbd5e1; /* gray-300 */
            margin-top: 3px;
            background-color: #f9fafb; /* gray-50 */
        }
/* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */
#animation-stage {
    font-size: 0.75rem; /* å…¨ä½“ã®æ–‡å­—ã‚µã‚¤ã‚ºã‚’å°ã•ã‚ã« */
    transition: background-color 0.5s ease;
}
.anim-region, .anim-block, .anim-bracket {
    border: 1px solid #ccc;
    background-color: white;
    padding: 8px;
    margin: 5px;
    border-radius: 4px;
    text-align: center;
    opacity: 0;
    transition: all 0.5s ease-in-out;
    position: relative; /* å­è¦ç´ ã®çµ¶å¯¾é…ç½®åŸºæº– */
}
.anim-team {
    display: inline-block;
    background-color: #e0f2fe; /* blue-100 */
    border: 1px solid #7dd3fc; /* blue-300 */
    color: #0c4a6e; /* blue-800 */
    padding: 2px 5px;
    margin: 1px;
    border-radius: 3px;
    font-weight: 500;
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.3s ease-in-out;
}
.anim-team.seed {
    background-color: #fef9c3; /* yellow-100 */
    border-color: #facc15; /* yellow-400 */
    color: #713f12; /* yellow-900 */
    font-weight: bold;
}
.anim-team.winner {
    background-color: #dcfce7; /* green-100 */
    border-color: #4ade80; /* green-400 */
    color: #14532d; /* green-900 */
    font-weight: bold;
}
.anim-team.loser {
    background-color: #f1f5f9; /* slate-100 */
    border-color: #cbd5e1; /* slate-300 */
    color: #64748b; /* slate-500 */
    opacity: 0.6 !important;
    text-decoration: line-through;
}
.anim-team.show, .anim-region.show, .anim-block.show, .anim-bracket.show {
    opacity: 1;
    transform: scale(1);
}
.anim-highlight {
    box-shadow: 0 0 15px 5px rgba(251, 191, 36, 0.7); /* amber-400 */
    transform: scale(1.1) !important;
    z-index: 10;
}
.anim-arrow {
    position: absolute;
    width: 0;
    height: 0;
    border-top: 5px solid transparent;
    border-bottom: 5px solid transparent;
    opacity: 0;
    transition: opacity 0.5s ease-in-out 0.5s; /* å°‘ã—é…ã‚Œã¦è¡¨ç¤º */
}
.anim-arrow.right {
    border-left: 8px solid #60a5fa; /* blue-400 */
}
.anim-arrow.show {
    opacity: 1;
}

.details-table { 
    border-collapse: collapse; 
    font-size: 12px; 
    
}
/* â–¼â–¼â–¼ ã“ã®æ–°ã—ã„ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ  â–¼â–¼â–¼ */
.details-table th {
    white-space: nowrap; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ–‡å­—ãŒæŠ˜ã‚Šè¿”ã•ãªã„ã‚ˆã†ã«ã™ã‚‹ */
}
/* â–²â–²â–² â–²â–²â–² */
.details-table td { 
    border: 1px solid #e5e7eb; 
    padding: 4px; 
    text-align: center; 
    vertical-align: middle; 
}
.details-table th { background-color: #f9fafb; font-weight: 600; }
.details-table input, .details-table select { width: 100%; border: none; text-align: center; background: transparent; font-size: 12px; }
.details-table input:focus, .details-table select:focus { outline: 1px solid #3b82f6; }

/* â˜…åˆ—å¹…è¨­å®šâ˜… */
/* ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ãƒ†ãƒ¼ãƒ–ãƒ« */
#inning-score-table { table-layout: auto; width: auto; } /* ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã¯è‡ªå‹•å¹… */
#inning-score-table .col-team { min-width: 120px; text-align: left; padding-left: 8px; }
#inning-score-table .col-inning-score { width: 40px; }
#inning-score-table .col-total { width: 50px; }
#inning-score-table .col-add-inning { width: 40px; }

/* â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼ */
/* æŠ•æ‰‹æˆç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« */
.details-table[id^="pitching-table"] .col-pitcher-result { min-width: 50px; }
.details-table[id^="pitching-table"] .col-pitcher-name { min-width: 130px; } /* é¸æ‰‹åæ¬„ã‚’åºƒã */
.details-table[id^="pitching-table"] .col-pitcher-throw-bat { min-width: 80px; }
.details-table[id^="pitching-table"] .col-pitcher-style { min-width: 110px; } /* æŠ•ã’æ–¹ (ã‚¹ãƒªãƒ¼ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼) */
.details-table[id^="pitching-table"] .col-pitcher-type { min-width: 80px; }
.details-table[id^="pitching-table"] .col-pitcher-velocity { min-width: 80px; }
.details-table[id^="pitching-table"] .col-stat { min-width: 60px; } /* å›æ•°, æ‰“è€…, çƒæ•° etc. */
/* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* æ‰“æ’ƒæˆç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« */
/* â˜…åˆ—å¹…è¨­å®šï¼ˆmin-widthã§æœ€ä½å¹…ã‚’ä¿è¨¼ï¼‰â˜… */
.batting-table .col-order { min-width: 40px; }
.batting-table .col-number { min-width: 60px; }
.batting-table .col-throw-bat { min-width: 80px; } /* ã€ŒæŠ•/æ‰“ã€åˆ—ã®å¹…ã‚’ç¢ºä¿ */
.batting-table .col-player { min-width: 120px; }
.batting-table .col-pos { min-width: 100px; }
.batting-table .col-sub-type { min-width: 80px; }
.batting-table .col-inning { min-width: 400px; }  /* â†ãŠå¥½ã¿ã®å¹…ã«èª¿æ•´ã—ã¦ãã ã•ã„ */
/* â–²â–²â–² â–²â–²â–² */
Â  Â  Â  Â  .add-row-btn { background-color: #e5e7eb; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-top: 4px; }

Â  Â  Â  Â  .add-row-btn:hover { background-color: #d1d5db; }ã€€



ã€€ </style>
</head>
<body class="p-4 md:p-8">
     <audio id="lottery-bgm" src="./bgm.mp3" loop preload="auto"></audio>
    <div class="ballpark-background"></div>
    <div id="dust-container"></div>
 <div id="rain-container" class="rain hidden"></div>
    <div id="sun-container" class="sunshine hidden">
        <div class="sun"></div>
        <div class="sun-flare"></div>
    </div>
    <div id="app-container" class="max-w-full mx-auto">
/div>

<div id="news-ticker-container">
    <div class="ticker-label">NEWS</div>
    <div class="ticker-content">
        <p id="ticker-text"></p>
    </div>
</div>

    <div id="weather-controls" class="fixed bottom-4 right-4 z-10">
        <div class="flex gap-2 p-2 bg-black bg-opacity-20 rounded-lg">
            <button id="unmute-btn" class="weather-btn">ğŸ”‡</button>
            <button class="weather-btn" data-weather="sun">â˜€ï¸</button>
            <button class="weather-btn" data-weather="rain">ğŸŒ§ï¸</button>
            <button class="weather-btn" data-weather="none">ğŸ’¨</button>
        </div>
    </div>
        
<div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center z-[200]">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 class="text-xl font-bold">è¨­å®š</h3>
            <button id="settings-modal-close-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <span class="font-semibold">è©¦åˆè¨˜äº‹ã®è‡ªå‹•ç”Ÿæˆ</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggle-article-generation" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <div class="flex items-center justify-between">
                <span class="font-semibold">æ²ç¤ºæ¿ã®è‡ªå‹•ç”Ÿæˆ</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggle-bbs-generation" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
        </div>
    </div>
</div>



        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white main-title">AIè¨˜è€…ä»˜ããƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨</h1>
            <p id="tournament-year-display" class="mt-2 subtitle-text">ï¼ˆæœ€çµ‚å®Ÿè£…ç‰ˆï¼‰</p>
        </div>

        <div id="setup" class="setup-card">
             <div class="w-full">
                 <h2 class="text-xl font-semibold mb-4 border-b pb-2 setup-header">å‚åŠ ãƒãƒ¼ãƒ  (64ãƒãƒ¼ãƒ )</h2>
                 <textarea id="teams-list" class="w-full h-96 p-3 border border-gray-300 rounded-lg" readonly></textarea>
             </div>
             <div class="mt-8 text-center">
                 <button id="resume-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 shadow-md mb-4 w-full md:w-auto">
                   å†é–‹ï¼ˆåˆã„è¨€è‘‰å…¥åŠ›ï¼‰
                 </button>
                 <button id="generate-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 shadow-md w-full md:w-auto">
                     æ–°ã—ã„ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’é–‹å§‹
                 </button>
ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<button id="help-btn" class="bg-gray-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-600 shadow-md mt-4 w-full md:w-auto">
    éŠã³æ–¹
</button>
 <button id="show-matome-site-btn" class="bg-orange-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-orange-600 shadow-md mt-4 w-full md:w-auto">
    ğŸ“° ã¾ã¨ã‚ã‚µã‚¤ãƒˆã‚’è¦‹ã‚‹
    </button>            
 </div>
        </div>




        <div id="tournament-display" class="hidden">
            <div id="autumn-regional-blocks-container" class="display-card hidden"></div>
            <div id="autumn-ranking-playoffs-container" class="display-card hidden"></div>
            <button id="skip-autumn-blocks-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 shadow-md hidden">åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸ã‚’ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-autumn-ranking-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 shadow-md hidden">åœ°åŒºé †ä½æ±ºå®šæˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-autumn-main-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 shadow-md hidden">çœŒå¤§ä¼šæœ¬æˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-spring-qualifiers-btn" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 shadow-md hidden">æ˜¥å­£åœ°åŒºäºˆé¸ã‚’ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-spring-round1-btn" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 shadow-md hidden">æ˜¥å­£çœŒå¤§ä¼š1å›æˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-spring-main-btn" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 shadow-md hidden">æ˜¥å­£çœŒå¤§ä¼š2å›æˆ¦ä»¥é™ã‚’ã‚¹ã‚­ãƒƒãƒ—</button>


            <div id="autumn-controls" class="text-center my-4 hidden">
                <button id="start-ranking-playoffs-btn" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-purple-700 shadow-md hidden">
                    åœ°åŒºå†…é †ä½æ±ºå®šæˆ¦ã¸é€²ã‚€
                </button>
                <button id="start-main-tournament-btn" class="bg-teal-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-teal-700 shadow-md hidden">
                    çœŒå¤§ä¼šæœ¬æˆ¦ã¸é€²ã‚€
                </button>

            </div>

            

<div id="region-map-section" class="display-card hidden scorebook-font">
                 <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">åœ°åŒºåˆ¥ å‹ã¡æ®‹ã‚ŠçŠ¶æ³</h2>
                 <div id="region-map-container" class="w-full"></div>
            </div>
             <div id="namco-news-section" class="hidden display-card border-2 border-orange-400">
                 <h2 class="text-xl font-bold text-orange-600 mb-3 text-center">ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</h2>
                 <div id="namco-news-content" class="space-y-2"></div>
             </div>
            <div class="flex justify-between items-start mb-4">
                <div>
                    <button id="generate-summary-btn" class="hidden bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 shadow-md">
                        ã“ã“ã¾ã§ã®å¤§ä¼šãƒã‚¤ãƒ©ã‚¤ãƒˆè¨˜äº‹ã‚’ç”Ÿæˆ
                    </button>
                    <button id="next-tournament-btn" class="hidden bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 shadow-md">
                        æ¬¡ã®å¤§ä¼šã¸é€²ã‚€
                    </button>
                </div>
               <div class="ml-auto">
                    <div class="flex items-center justify-end space-x-2">
                        <button id="skip-r1-btn" class="hidden bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 shadow-md">1å›æˆ¦ã‚¹ã‚­ãƒƒãƒ—</button>
                        <button id="skip-r2-btn" class="hidden bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 shadow-md">2å›æˆ¦ã‚¹ã‚­ãƒƒãƒ—</button>
                        <button id="skip-r3-btn" class="hidden bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 shadow-md">3å›æˆ¦ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-r4-btn" class="hidden bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 shadow-md">æº–ã€…æ±ºå‹ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-r5-btn" class="hidden bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 shadow-md">æº–æ±ºå‹ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-final-btn" class="hidden bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 shadow-md">æ±ºå‹ã‚¹ã‚­ãƒƒãƒ—</button>

                        <span id="save-feedback" class="text-gray-600 font-bold opacity-0 transition-opacity duration-500"></span>
<button id="show-matome-site-btn" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 shadow-md">
    ğŸ“° ã¾ã¨ã‚
    </button>
                        

   <button id="open-settings-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 shadow-md">âš™ï¸ è¨­å®š</button>
<button id="save-btn" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 shadow-md">ã‚»ãƒ¼ãƒ–</button>
                        <button id="reset-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 shadow-md">ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                    <div id="skip-loader-container" class="h-6 text-right mt-1">
                         <span id="skip-loader" class="hidden text-sm text-gray-600 font-bold">è©¦åˆã‚’é€²è¡Œã—ã¦ã„ã¾ã™...</span>
                    </div>
                </div>
            </div>
            <div id="main-bracket-wrapper" class="display-card scorebook-font">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨</h2>
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4 rounded-md text-sm">
                    <p><b>PCã§ã®è¡¨ç¤ºã«ã¤ã„ã¦:</b> ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®å…¨ä½“ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ã€è¡¨ã®ã‚¨ãƒªã‚¢å†…ã§ãƒã‚¦ã‚¹ã®ãƒ›ã‚¤ãƒ¼ãƒ«ã‚’å›ã—ãªãŒã‚‰ <b>Shiftã‚­ãƒ¼</b> ã‚’æŠ¼ã™ã‹ã€è¡¨ã®ä¸‹ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’ç›´æ¥ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã“ã¨ã§ã€å·¦å³ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã¾ã™ã€‚</p>
                </div>
                <div id="main-bracket-container"></div>
            </div>
            <div id="news-section" class="display-card">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">æ³¨ç›®ãƒ‹ãƒ¥ãƒ¼ã‚¹</h2>
                <div id="news-articles" class="space-y-4">
                    <p class="text-gray-500 text-center">ã¾ã ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                </div>
            </div>
             <div id="daiya-bbs-section" class="hidden display-card border-4 border-green-600">
                 <h2 id="daiya-bbs-title" class="text-2xl font-bold text-green-800 mb-4 text-center">ã€ç‰¹è¨­ã€‘ä»£çŸ¢æ± å¿œæ´æ²ç¤ºæ¿</h2>
                 <div id="daiya-bbs-comments" class="space-y-3">
                     <p class="text-gray-500 text-center">ã¾ã åå¿œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                 </div>
             </div>
             <div id="bbs-section" class="display-card">
                 <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">æ²ç¤ºæ¿ã®åå¿œ</h2>
<div class="mb-4 p-4 border rounded-lg bg-white">
    <form id="main-comment-form">
        <textarea id="main-comment-textarea" class="w-full p-2 border rounded" rows="2" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãè¾¼ã‚€... (ä¾‹: ä»Šæ—¥ã®å§«å·ã¯ãƒ¬ãƒ™ãƒã ã£ãŸã‚ï¼)" required></textarea>
        <div class="text-right mt-2">
            <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">æŠ•ç¨¿ã™ã‚‹</button>
        </div>
    </form>
</div>
                 <div id="bbs-comments" class="space-y-3">
                     <p class="text-gray-500 text-center">ã¾ã åå¿œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                 </div>
             </div>
        </div>
    </div>

    <div id="news-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div id="modal-bg" class="absolute inset-0"></div>
        <div class="relative bg-white rounded-lg shadow-xl max-w-2xl w-full m-4">
            <div class="p-6 modal-body-scroll">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-900"></h3>
                <div id="modal-meta" class="text-gray-400 text-sm mt-2 flex items-center gap-4"></div>
                <p id="modal-body" class="mt-4 text-gray-600 whitespace-pre-wrap"></p>
            </div>
            <button id="modal-close" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>
    
  
<div id="integrated-matome-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-[200]">
    <div class="bg-gray-100 p-2 md:p-4 rounded-lg shadow-xl w-full max-w-7xl max-h-[95vh] flex flex-col overflow-hidden">
        
        <div class="flex justify-between items-center mb-2 px-2 md:px-0">
            <h2 class="text-2xl md:text-3xl font-extrabold text-red-700 font-sans tracking-wide">
                <img src="koshien.jpg" alt="ãªã‚“Jã‚¹ã‚¿ã‚¸ã‚¢ãƒ " class="h-10 md:h-12 inline-block mr-2">
                ä¿ºãŸã¡ã®ç”²å­åœ’é€Ÿå ±ï¼ ãªã‚“Jã¾ã¨ã‚
            </h2>
            <button id="matome-modal-close-btn" class="text-gray-400 hover:text-gray-600">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="flex border-b border-gray-300 bg-white shadow-sm mb-3 text-sm md:text-base sticky top-0 z-10">
            <button class="matome-tab-btn active bg-blue-600 text-white py-2 px-4 rounded-t hover:bg-blue-700 transition-colors" data-tab="top">ãƒˆãƒƒãƒ—</button>
            <button class="matome-tab-btn text-gray-700 py-2 px-4 hover:bg-gray-100 transition-colors" data-tab="blog">ã“ã®ãƒ–ãƒ­ã‚°ã«ã¤ã„ã¦</button>
            <button class="matome-tab-btn text-gray-700 py-2 px-4 hover:bg-gray-100 transition-colors" data-tab="twitter">Twitter</button>
            <button class="matome-tab-btn text-gray-700 py-2 px-4 hover:bg-gray-100 transition-colors" data-tab="antenna">ãªã‚“Jã‚¢ãƒ³ãƒ†ãƒŠ</button>
            <button class="matome-tab-btn text-gray-700 py-2 px-4 hover:bg-gray-100 transition-colors" data-tab="baseball-mag">BaseBall MAG</button>
            </div>

        <div id="matome-content-area" class="flex-grow overflow-y-auto bg-gray-50 p-2 md:p-4 rounded-b-lg scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-200">
            
            <div id="matome-tab-top" class="matome-tab-content grid grid-cols-1 md:grid-cols-3 gap-4 active">
                
                <div class="md:col-span-2 space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">ğŸ”¥ æœ¬æ—¥ã®æ³¨ç›®è¨˜äº‹</h3>
                        <div id="matome-articles-container" class="space-y-2">
                            <div class="loader text-center py-8">è¨˜äº‹ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">âœ… ã¾ã¨ã‚</h3>
                        <ul class="list-none space-y-1">
                            <li class="flex items-start"><span class="text-blue-500 mr-2">âœ…</span><a href="#" class="text-gray-700 hover:text-blue-600">é‡çƒéƒ¨å“¡(14)ã€Œç”²å­åœ’ã¯èˆˆå‘³ãªã„ã€</a></li>
                            <li class="flex items-start"><span class="text-blue-500 mr-2">âœ…</span><a href="#" class="text-gray-700 hover:text-blue-600">DeNAãƒ»ã‚¸ãƒ£ã‚¯ã‚½ãƒ³ã€è¡æ’ƒã®ã‚¹ãƒªãƒ¼ãƒ©ãƒ³ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³ï½—ï½—ï½—ï½—ï½—ï½—</a></li>
                            <li class="flex items-start"><span class="text-blue-500 mr-2">âœ…</span><a href="#" class="text-gray-700 hover:text-blue-600">ã€ç”»åƒã€‘ã€Œä¸‹ç€ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ã€ãƒ‘ã‚¹ï½—ï½—ï½—ï½—ï½—ï½—ï½—ï½—ï½—</a></li>
                            <li class="flex items-start"><span class="text-blue-500 mr-2">âœ…</span><a href="#" class="text-gray-700 hover:text-blue-600">ã€æ‚²å ±ã€‘ãƒ¬ãƒ³ãƒãƒ³ã§ç°¡å˜ã«æ—¨ã„ãƒãƒ†ãƒå‘³ä»˜ã‘ã‚‰ã‚Œã‚‹ãƒ©ã‚¤ãƒ•ãƒãƒƒã‚¯ãŒãƒ¤ãƒã‚¤</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-white p-2 rounded-lg shadow-md text-center">
                        <h3 class="text-md font-bold text-gray-800 border-b pb-1 mb-2">ä»–ç¤¾ã‹ã‚‰ä¹—ã‚Šæ›ãˆã§</h3>
                        <img src="sumaho.jpg" alt="åºƒå‘Š" class="w-full h-auto rounded">
                        <p class="text-sm text-gray-600 mt-1">äººæ°—ã‚¹ãƒãƒ›<span class="text-xl font-bold text-red-600">500</span>å††ï¼</p>
                        <p class="text-xs text-gray-500">2025/8/31ã¾ã§</p>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">ğŸ’¡ ãªã‚“Jã‚¢ãƒ³ãƒ†ãƒŠ</h3>
                        <ul class="list-none space-y-1 text-sm">
                            <li><a href="#" class="text-gray-700 hover:text-blue-600">ãªã‚“J PRIDE: å·¨äººå²¡æœ¬å’ŒçœŸ(28) .300 40æœ¬ 100æ‰“ç‚¹</a></li>
                            <li><a href="#" class="text-gray-700 hover:text-blue-600">MLB NEWS: å¤§è°·ç¿”å¹³ã€æœ¬æ—¥ã‚‚äºŒåˆ€æµã§å¤§æ´»èº</a></li>
                            <li><a href="#" class="text-gray-700 hover:text-blue-600">ã¾ã¨ã‚ãƒ’ã‚¹ãƒˆãƒªã‚¢: æ˜”ã®ãªã‚“Jã‚¹ãƒ¬ã‚’æŒ¯ã‚Šè¿”ã‚‹</a></li>
                        </ul>
                    </div>
                    
                </div>
            </div>

            <div id="matome-tab-blog" class="matome-tab-content hidden p-4 bg-white rounded-lg shadow-md">
                <h3 class="text-xl font-bold">ã“ã®ãƒ–ãƒ­ã‚°ã«ã¤ã„ã¦</h3>
                <p class="mt-2 text-gray-700">å½“ãƒ–ãƒ­ã‚°ã€Œä¿ºãŸã¡ã®ç”²å­åœ’é€Ÿå ±ï¼ ãªã‚“Jã¾ã¨ã‚ã€ã¯ã€æ¶ç©ºã®é«˜æ ¡é‡çƒãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã¨ç¾å®Ÿä¸–ç•Œã®ãªã‚“Jãƒã‚¿ã‚’èåˆã•ã›ãŸã€å”¯ä¸€ç„¡äºŒã®ã¾ã¨ã‚ã‚µã‚¤ãƒˆã§ã™ã€‚</p>
                <p class="mt-2 text-gray-700">é‡çƒã«é–¢ã™ã‚‹è©±é¡Œã‚’ä¸­å¿ƒã«ã€æ™‚äº‹ãƒã‚¿ã‚„èŠ¸èƒ½ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€å­¦æ­´ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹ã‹ã‚‰æ´¾ç”Ÿã™ã‚‹è­°è«–ã¾ã§ã€ãªã‚“Jã§è©±é¡Œã«ãªã£ãŸæ§˜ã€…ãªã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç‹¬è‡ªã®è¦–ç‚¹ã§ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚</p>
                <p class="mt-2 text-gray-700">ç®¡ç†äººã€Œç”²å­åœ’ã®ç”³ã—å­ã€ãŒã€æ—¥å¤œå·¡å›ã—ã€ãƒ›ãƒƒãƒˆãªæƒ…å ±ã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚</p>
            </div>
            <div id="matome-tab-twitter" class="matome-tab-content hidden p-4 bg-white rounded-lg shadow-md">
                <h3 class="text-xl font-bold">Twitter</h3>
                <p class="mt-2 text-gray-700">@koshien_nanjã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã€æ—¥ã€…ç†±ã„å®Ÿæ³ã‚’ã—ã¦ã„ã¾ã™ï¼</p>
                <div class="mt-4 bg-gray-100 p-3 rounded">
                    <p class="font-bold">ãªã‚“Jã¾ã¨ã‚é€Ÿå ± @koshien_nanj</p>
                    <p class="text-sm mt-1">ä»Šæ—¥ã®è©¦åˆã‚‚ç†±ã™ãã‚‹ï¼â—‹â—‹é«˜æ ¡ã€ã¾ã•ã‹ã®é€†è»¢ã‚µãƒ¨ãƒŠãƒ©å‹ã¡ï½—ï½—ï½— #é«˜æ ¡é‡çƒ #ç”²å­åœ’ <span class="text-blue-500">#ãªã‚“J</span></p>
                    <p class="text-xs text-gray-500 mt-2">1æ™‚é–“å‰</p>
                </div>
                <div class="mt-4 bg-gray-100 p-3 rounded">
                    <p class="font-bold">ãªã‚“Jã¾ã¨ã‚é€Ÿå ± @koshien_nanj</p>
                    <p class="text-sm mt-1">ã€æ‚²å ±ã€‘ãƒ¯ã‚¤ã®å¿œæ´ã—ã¦ãŸé«˜æ ¡ã€åˆæˆ¦æ•—é€€â€¦ä»Šå¹´ã¯ã‚‚ã†çµ‚ã‚ã‚Šã‚„â€¦ <span class="text-blue-500">#ç”²å­åœ’ã®å¤</span></p>
                    <p class="text-xs text-gray-500 mt-2">3æ™‚é–“å‰</p>
                </div>
            </div>
            <div id="bbs-thread-display-area" class="hidden p-4 bg-white rounded-lg shadow-md flex flex-col h-full">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 id="bbs-thread-title" class="text-xl md:text-2xl font-bold text-gray-800"></h3>

<div>
                        <button id="retry-matome-thread-btn" class="bg-red-600 text-white font-bold py-1 px-3 rounded hover:bg-red-700 text-sm hidden" data-match-id="">
                            å†ç”Ÿæˆ
                        </button>

                    <button id="bbs-thread-back-btn" class="bg-blue-500 text-white font-bold py-1 px-3 rounded hover:bg-blue-600 text-sm">
                        ä¸€è¦§ã«æˆ»ã‚‹
                    </button>
                </div>
</div>
                <div id="bbs-thread-content" class="overflow-y-auto space-y-4 flex-grow">
                    <div class="loader text-center py-8">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                </div>
                <div class="mt-4 p-3 bg-gray-50 rounded-lg border-t text-sm text-gray-600">
                    <p>ã‚³ãƒ¡ãƒ³ãƒˆã¯ã€AIã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆã§ã™ã€‚ç‰¹å®šã®æ„è¦‹ã‚„äººç‰©ã‚’æ„å›³ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                </div>
            </div>

        </div>
    </div>
</div>

  <div id="confirm-modal" class="confirm-modal hidden">
        <div class="confirm-modal-content">
            <p id="confirm-modal-text" class="mb-4 text-lg"></p>
            <button id="confirm-ok" class="bg-red-600 text-white px-6 py-2 rounded-lg mr-2">ã¯ã„</button>
            <button id="confirm-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">ã„ã„ãˆ</button>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="details-modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
        <h3 class="text-xl font-bold mb-4 text-center border-b pb-3">è©¦åˆè©³ç´°å…¥åŠ›</h3>
        <div id="details-modal-body" class="overflow-y-auto space-y-6 flex-grow pr-2"> {/* pr-2 ã‚’è¿½åŠ ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã¨ã®éš™é–“ã‚’ä½œã‚‹ */}
            </div>
        
                <div class="mt-6 text-center border-t pt-4">
            <button id="details-save" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 mr-4">
                ã“ã®å†…å®¹ã§ä¿å­˜
            </button>
            <button id="details-close" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
        </div>
               
    </div>
</div>
            



    
    <div id="save-load-modal" class="save-load-modal hidden">
        <div class="save-load-modal-content">
            <div class="flex border-b">
                <button id="save-tab-btn" class="px-4 py-2 font-semibold border-b-2 border-blue-500">ã‚»ãƒ¼ãƒ– (åˆã„è¨€è‘‰ã®ç™ºè¡Œ)</button>
                <button id="load-tab-btn" class="px-4 py-2 text-gray-500">ãƒ­ãƒ¼ãƒ‰ (åˆã„è¨€è‘‰ã®å…¥åŠ›)</button>
            </div>
            <div id="save-tab-content" class="py-4">
                <p class="text-sm mb-2">ç¾åœ¨ã®é€²è¡ŒçŠ¶æ³ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®ã€Œåˆã„è¨€è‘‰ã€ã‚’ç™ºè¡Œã—ã¾ã™ã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                <button id="generate-save-code-btn" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">åˆã„è¨€è‘‰ã‚’ç™ºè¡Œ</button>
                <div id="save-code-area" class="hidden mt-4">
                    <p class="text-sm font-bold text-green-600">åˆã„è¨€è‘‰ãŒç™ºè¡Œã•ã‚Œã¾ã—ãŸã€‚ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å®‰å…¨ãªå ´æ‰€ã«ä¿ç®¡ã—ã¦ãã ã•ã„ã€‚</p>
                    <div class="flex items-center mt-2">
                        <div id="save-code-output" class="flex-grow text-xs"></div>
                        <button id="copy-save-code-btn" class="ml-2 bg-gray-200 px-3 py-1 rounded text-xs font-semibold hover:bg-gray-300">ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    <p id="copy-feedback" class="text-xs text-green-600 mt-1 h-4"></p>
                </div>
            </div>
            <div id="load-tab-content" class="py-4 hidden">
                <p class="text-sm mb-2">ä¿å­˜ã—ãŸã€Œåˆã„è¨€è‘‰ã€ã‚’ä»¥ä¸‹ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
                <textarea id="load-code-input" placeholder="åˆã„è¨€è‘‰ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘" class="w-full h-32 p-2 border rounded mb-2"></textarea>
                <button id="load-from-code-btn" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">ã“ã®ãƒ‡ãƒ¼ã‚¿ã§å†é–‹ã™ã‚‹</button>
            </div>
             <div class="mt-4 text-right">
                 <button id="save-load-close" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">é–‰ã˜ã‚‹</button>
             </div>
        </div>
    </div>

    <div id="newspaper-modal" class="newspaper-modal hidden">
        <div class="newspaper-modal-content">
            <div id="newspaper-modal-body"></div>
            <div class="mt-4 text-center">
                <button id="newspaper-close" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>


<div id="feedback-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-[150]">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
        <h3 class="text-xl font-bold mb-4 text-center border-b pb-3">AIè¨˜è€…ã¸ã®è¿½åŠ æŒ‡ç¤º</h3>
        <div class="space-y-4">
            <div>
                <label for="feedback-include" class="block text-sm font-medium text-gray-700">âœ… ã“ã®è¦ç´ ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„</label>
                <textarea id="feedback-include" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹ï¼šæ®Šå‹²æ‰“ã‚’æ”¾ã£ãŸã€‡ã€‡é¸æ‰‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸­å¿ƒã«ã€‚&#10;ä¾‹ï¼šæ•—ã‚ŒãŸâ–³â–³é«˜æ ¡ã®ã‚¨ãƒ¼ã‚¹ã®æ¶™ã«ã‚‚è§¦ã‚Œã¦ã»ã—ã„ã€‚"></textarea>
            </div>
            <div>
                <label for="feedback-exclude" class="block text-sm font-medium text-gray-700">âŒ ã“ã®è¦ç´ ãƒ»å±•é–‹ã¯é¿ã‘ã¦ãã ã•ã„</label>
                <textarea id="feedback-exclude" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹ï¼šç›£ç£ã®é‡‡é…ãƒŸã‚¹ã¨ã„ã†è«–èª¿ã¯ã‚‚ã†ã„ã„ã€‚&#10;ä¾‹ï¼šã‚ã‚ŠããŸã‚Šãªã€Œå…¨å“¡é‡çƒã€ã¨ã„ã†è¨€è‘‰ã¯ä½¿ã‚ãªã„ã§ã€‚"></textarea>
            </div>
        </div>
        <div class="mt-6 text-center border-t pt-4">
            <button id="feedback-submit-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg mr-2">ã“ã®æŒ‡ç¤ºã§å†ç”Ÿæˆ</button>
            <button id="feedback-cancel-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<div id="review-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <h3 class="text-xl font-bold mb-4 text-center border-b pb-3">AIè¨˜äº‹ã®æœ€çµ‚ç¢ºèªãƒ»ç·¨é›†</h3>
        <div class="overflow-y-auto space-y-4 flex-grow">
            <div>
                <label for="review-title" class="block text-sm font-medium text-gray-700">ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" id="review-title" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="review-body" class="block text-sm font-medium text-gray-700">æœ¬æ–‡</label>
                <textarea id="review-body" rows="15" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 whitespace-pre-wrap"></textarea>
            </div>
        </div>
        <div class="mt-6 text-center border-t pt-4">
            <button id="review-save-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg mr-2">ã“ã®è¨˜äº‹ã§ç¢ºå®š</button>
            <button id="review-cancel-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<div id="lottery-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-[200] font-sans">
    <div id="lottery-content" class="bg-white rounded-lg shadow-2xl w-full max-w-6xl h-[95vh] flex flex-col p-6">
        <h2 class="text-4xl font-bold text-center mb-4 scorebook-font text-gray-800 tracking-widest">å¤ã®é«˜æ ¡é‡çƒ çµ„ã¿åˆã‚ã›æŠ½é¸ä¼š</h2>
        <div id="lottery-stage" class="flex-grow bg-gray-800 rounded p-4 flex gap-4 overflow-hidden relative border-4 border-gray-600">
            <div class="w-1/3 flex flex-col items-center justify-between bg-gray-200 rounded-lg shadow-inner p-4">
                <div id="lottery-pot-container" class="w-full flex flex-col items-center">
                    <p id="pot-name" class="text-2xl font-bold text-gray-700 mb-2">Aã‚·ãƒ¼ãƒ‰</p>
                    <div id="lottery-pot" class="w-48 h-48 bg-red-800 border-4 border-yellow-400 text-white flex items-center justify-center text-5xl font-bold shadow-lg rounded-full cursor-pointer transition-transform duration-200 hover:scale-105">
                        æŠ½é¸
                    </div>
                </div>
                <div id="drawn-team-container" class="w-full h-32 border-4 border-dashed border-gray-400 rounded-lg flex items-center justify-center opacity-0 bg-white">
                    <p id="drawn-team" class="text-4xl font-bold text-gray-800"></p>
                </div>
            </div>
            <div id="lottery-bracket" class="w-2/3 grid grid-cols-2 gap-x-4 h-full overflow-y-auto p-2 bg-gray-100 rounded-lg shadow-inner">
                <div id="lottery-bracket-left" class="space-y-1"></div>
                <div id="lottery-bracket-right" class="space-y-1"></div>
            </div>
        </div>
        <div class="h-32 flex flex-col justify-between pt-4">
            <div id="lottery-commentary" class="h-20 text-center text-2xl font-semibold text-gray-800 bg-yellow-100 border-2 border-yellow-300 rounded p-2 flex items-center justify-center">
                <p>é™å²¡å¤§ä¼š æŠ½é¸ä¼šã¸ã‚ˆã†ã“ãã€‚ä¸»å°†ã¯æŠ½é¸ç®±ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¯ã‚¸ã‚’å¼•ã„ã¦ãã ã•ã„ã€‚</p>
            </div>
            <div id="lottery-controls" class="text-center">
    <button id="start-lottery-btn" class="bg-blue-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-blue-700">æŠ½é¸ã‚’é–‹å§‹</button>
    <button id="skip-lottery-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 ml-4">ã‚¹ã‚­ãƒƒãƒ—</button>
</div>
        </div>
    </div>
</div>

<div id="analysis-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden flex flex-col items-center justify-center z-[250] p-4 font-sans">
    <div class="w-full max-w-6xl h-full flex flex-col">
        <div class="flex-shrink-0 flex justify-between items-center mb-4">
            <div id="analysis-block-tabs" class="flex space-x-1 p-1 bg-gray-800 rounded-lg">
                <button class="analysis-block-tab-btn px-4 py-2 rounded-md text-sm font-bold transition-colors" data-block="A">Aãƒ–ãƒ­ãƒƒã‚¯</button>
                <button class="analysis-block-tab-btn px-4 py-2 rounded-md text-sm font-bold transition-colors" data-block="B">Bãƒ–ãƒ­ãƒƒã‚¯</button>
                <button class="analysis-block-tab-btn px-4 py-2 rounded-md text-sm font-bold transition-colors" data-block="C">Cãƒ–ãƒ­ãƒƒã‚¯</button>
                <button class="analysis-block-tab-btn px-4 py-2 rounded-md text-sm font-bold transition-colors" data-block="D">Dãƒ–ãƒ­ãƒƒã‚¯</button>
            </div>
            <button id="analysis-modal-close-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
        </div>
        
        <div id="analysis-stage" class="flex-grow bg-gray-900 rounded-lg relative overflow-hidden">
            </div>

        <div id="analysis-narration-box" class="flex-shrink-0 h-28 mt-4 bg-gray-800 border-t-2 border-cyan-500 rounded-b-lg p-4 overflow-y-auto">
            <p id="analysis-narration-text" class="text-white text-lg leading-relaxed whitespace-pre-wrap"></p>
        </div>
    </div>
</div>

<div id="interview-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-[300]">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 m-4 animate-fade-in-up">
        <h3 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">æŠ½é¸ä¼šå¾Œ ä¸»å°†ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼</h3>
        <div id="interview-content" class="space-y-4 max-h-[60vh] overflow-y-auto"></div>
        <div class="text-center mt-6">
            <button id="close-interview-btn" class="bg-blue-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-blue-700">å¤§ä¼šã‚’å§‹ã‚ã‚‹</button>
        </div>
    </div>
</div>

<div id="help-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <h3 class="text-xl font-bold mb-4 text-center border-b pb-3">AIè¨˜è€…ä»˜ããƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ å–æ‰±èª¬æ˜æ›¸ (Ver. ç§‹/æ˜¥å¯¾å¿œç‰ˆ)</h3>
        <div class="overflow-y-auto space-y-6 flex-grow pr-4 text-gray-700">

            <div>
                <h4 class="font-bold text-lg text-blue-700 mb-2">ã¯ã˜ã‚ã«ï¼šã‚ãªãŸã ã‘ã®é«˜æ ¡é‡çƒå²ã‚’å‰µã‚‹</h4>
                <p class="text-sm">
                    ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ç›®çš„ã¯ã€å˜ã«è©¦åˆã®å‹ã¡è² ã‘ã‚’æ±ºã‚ã‚‹ã“ã¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚ãªãŸã®é‡‡é…ã‚„å…¥åŠ›ã—ãŸè©³ç´°ãªè©¦åˆå†…å®¹ã«åŸºã¥ãã€AIãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã€Œãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã€ã€Œæ²ç¤ºæ¿ã®åå¿œã€ã€Œã¾ã¨ã‚ã‚µã‚¤ãƒˆé¢¨ã‚¹ãƒ¬ãƒƒãƒ‰ã€ã€æ™‚ã«ã¯ã€Œå¯†ç€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ã€ã‚’ç”Ÿæˆã—ã¾ã™ã€‚å¤ã®ç”²å­åœ’ã€ç§‹ã®æ–°ãƒãƒ¼ãƒ ã€æ˜¥ã®é¸æŠœã¸ã¨ç¶šãä¸€å¹´é–“ã®ãƒ‰ãƒ©ãƒã‚’é€šã˜ã¦ã€ã‚ãªãŸã ã‘ã®å”¯ä¸€ç„¡äºŒã®é«˜æ ¡é‡çƒã®æ­´å²ã‚’å‰µã‚Šä¸Šã’ã€ãã®ç›®æ’ƒè€…ã¨ãªã‚‹ã“ã¨ãŒã€ã“ã®ã‚²ãƒ¼ãƒ ã®æœ€å¤§ã®é†é†å‘³ã§ã™ã€‚
                </p>
            </div>

            <div>
                <h4 class="font-bold text-lg text-blue-700 mb-2">åŸºæœ¬çš„ãªã‚²ãƒ¼ãƒ ã®æµã‚Œ</h4>
                <ol class="list-decimal list-inside space-y-2 text-sm">
                    <li><strong>ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆé–‹å§‹:</strong> ã€Œæ–°ã—ã„ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’é–‹å§‹ã€ãƒœã‚¿ãƒ³ã§ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã¾ã™ã€‚åˆå›ã¯å¤ã®é™å²¡çœŒå¤§ä¼šã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚æŠ½é¸ä¼šã‚¤ãƒ™ãƒ³ãƒˆã‚’çµŒã¦ã€çµ„ã¿åˆã‚ã›ãŒæ±ºå®šã•ã‚Œã¾ã™ã€‚</li>
                    <li><strong>ã‚¹ã‚³ã‚¢å…¥åŠ›:</strong> ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®å„è©¦åˆã‚«ãƒ¼ãƒ‰ã«ã€åŠè§’æ•°å­—ã§æœ€çµ‚ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›ã—ã¾ã™ã€‚</li>
                    <li><strong>å‹è€…æ±ºå®š:</strong> ã‚¹ã‚³ã‚¢å…¥åŠ›å¾Œã€å‹ã£ãŸæ–¹ã®ãƒãƒ¼ãƒ ã®é’ã„ã€Œâ–¶ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚</li>
                    <li><strong>AIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ:</strong> å‹è€…ãŒæ±ºã¾ã‚‹ã¨ã€AIãŒè‡ªå‹•ã§è©¦åˆã«é–¢ã™ã‚‹ã€Œãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã€ã‚„ã€Œæ²ç¤ºæ¿ã®åå¿œã€ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ï¼ˆè¨­å®šã§ON/OFFå¯èƒ½ï¼‰</li>
                    <li><strong>è©³ç´°å…¥åŠ› (ä»»æ„ãƒ»æ¨å¥¨):</strong> è©¦åˆã‚«ãƒ¼ãƒ‰ã®ã€Œè©³ç´°å…¥åŠ›ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ã‚„å€‹äººæˆç¸¾ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€AIãŒç”Ÿæˆã™ã‚‹ç‰©èªã®ãƒªã‚¢ãƒªãƒ†ã‚£ã¨æ·±ã¿ãŒæ ¼æ®µã«å‘ä¸Šã—ã¾ã™ã€‚</li>
                    <li><strong>å¤§ä¼šé€²è¡Œ:</strong> å…¨ã¦ã®è©¦åˆãŒçµ‚äº†ã™ã‚‹ã¨ã€å„ªå‹ãƒãƒ¼ãƒ ãŒæ±ºå®šã—ã¾ã™ã€‚å¤ã®å¤§ä¼šçµ‚äº†å¾Œã¯è‡ªå‹•çš„ã«ç§‹ã®å¤§ä¼šã¸ã€ç§‹ã®å¾Œã¯æ˜¥ã¸ã€æ˜¥ã®å¾Œã¯æ¬¡ã®å¹´ã®å¤ã¸ã¨é€²ã¿ã¾ã™ã€‚</li>
                    <li><strong>ã‚»ãƒ¼ãƒ–ï¼†ãƒ­ãƒ¼ãƒ‰:</strong> ã€Œã‚»ãƒ¼ãƒ–ã€ãƒœã‚¿ãƒ³ã§ã„ã¤ã§ã‚‚é€²è¡ŒçŠ¶æ³ã‚’ã€Œåˆã„è¨€è‘‰ã€ã¨ã—ã¦ä¿å­˜ã§ãã¾ã™ã€‚ã€Œå†é–‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€Œåˆã„è¨€è‘‰ã€ã‚’å…¥åŠ›ã™ã‚Œã°ã€ä¸­æ–­ã—ãŸã¨ã“ã‚ã‹ã‚‰å†é–‹ã§ãã¾ã™ã€‚</li>
                </ol>
            </div>

            <div>
                <h4 class="font-bold text-lg text-orange-700 mb-2">ã€é‡è¦ã€‘ä¸€å¹´é–“ã®å¤§ä¼šã‚µã‚¤ã‚¯ãƒ«ã¨ãƒ«ãƒ¼ãƒ«</h4>
                <p class="text-sm mb-3">
                    ã“ã®ä¸–ç•Œã§ã¯ã€é«˜æ ¡é‡çƒã®ä¸€å¹´é–“ï¼ˆå¤â†’ç§‹â†’æ˜¥ï¼‰ãŒè‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã€‚å„å¤§ä¼šã«ã¯ç•°ãªã‚‹ç›®çš„ã¨ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚Šã€ãã‚Œãã‚ŒãŒæ¬¡ã®å¤§ä¼šã®ã‚·ãƒ¼ãƒ‰æ¨©ãªã©ã«å½±éŸ¿ã—ã¾ã™ã€‚
                </p>
                <div class="space-y-4">
                    <div class="p-4 border rounded-lg bg-yellow-50">
                        <h5 class="font-semibold text-gray-800">å¤ã®å¤§ä¼š (ç”²å­åœ’ã¸ã®é“)</h5>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            <li>3å¹´ç”Ÿã«ã¨ã£ã¦æœ€å¾Œã®å¤§ä¼šã€‚64æ ¡ã«ã‚ˆã‚‹ä¸€ç™ºå‹è² ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã€‚</li>
                            <li>æ˜¥å­£å¤§ä¼šã®ãƒ™ã‚¹ãƒˆ8ãŒã‚·ãƒ¼ãƒ‰æ ¡ã¨ãªã‚Šã¾ã™ã€‚</li>
                            <li>å„ªå‹æ ¡ã¯å¤ã®ç”²å­åœ’ã«å‡ºå ´ã—ãŸã¨ã¿ãªã•ã‚Œã€AIãŒãã®å…¨å›½ã§ã®æˆ¦ç¸¾ï¼ˆä¾‹: å…¨å›½ãƒ™ã‚¹ãƒˆ8ã€ç”²å­åœ’åˆæˆ¦æ•—é€€ãªã©ï¼‰ã‚’è‡ªå‹•ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã€è¨˜éŒ²ã—ã¾ã™ã€‚</li>
                            <li>å¤§ä¼šå‰ã«ã¯çµ„ã¿åˆã‚ã›æŠ½é¸ä¼šã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¾ã™ã€‚</li>
                        </ul>
                    </div>

                    <div class="p-4 border rounded-lg bg-purple-50">
                        <h5 class="font-semibold text-gray-800">ç§‹ã®å¤§ä¼š (æ–°ãƒãƒ¼ãƒ å§‹å‹•ãƒ»ã‚»ãƒ³ãƒãƒ„ã¸ã®åºç« )</h5>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            <li>1,2å¹´ç”Ÿã®æ–°ãƒãƒ¼ãƒ ã§æŒ‘ã‚€æœ€åˆã®å…¬å¼æˆ¦ã€‚</li>
                            <li>ã¾ãšã€æ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨ãƒ»ä¼Šè±†ã®4åœ°åŒºã«åˆ†ã‹ã‚Œã¦åœ°åŒºäºˆé¸ã‚’è¡Œã„ã¾ã™ã€‚
                                <div class="mt-2 mb-2 p-2 bg-purple-100 rounded text-xs border border-purple-300">
                                    <p class="font-semibold mb-1">åœ°åŒºäºˆé¸ã®ä»•çµ„ã¿:</p>
                                    <p class="mb-1"><strong>æ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨åœ°åŒº (å„5æ ):</strong></p>
                                    <pre class="whitespace-pre-wrap leading-tight">
[åœ°åŒº20ãƒãƒ¼ãƒ ]
    â”‚
    â”œâ”€â–¶ [ãƒ–ãƒ­ãƒƒã‚¯A (5)] â”€â–¶ å„ªå‹ (çœŒ) / æº–å„ªå‹ â”
    â”œâ”€â–¶ [ãƒ–ãƒ­ãƒƒã‚¯B (5)] â”€â–¶ å„ªå‹ (çœŒ) / æº–å„ªå‹ â”¤
    â”œâ”€â–¶ [ãƒ–ãƒ­ãƒƒã‚¯C (5)] â”€â–¶ å„ªå‹ (çœŒ) / æº–å„ªå‹ â”¼â”€â–¶ [ç¬¬5ä»£è¡¨æ±ºå®šæˆ¦ (4)] â”€â–¶ å„ªå‹ (çœŒ)
    â””â”€â–¶ [ãƒ–ãƒ­ãƒƒã‚¯D (5)] â”€â–¶ å„ªå‹ (çœŒ) / æº–å„ªå‹ â”˜   (æ•—è€…å¾©æ´»)</pre>
                                    <p class="mt-1"><strong>ä¼Šè±†åœ°åŒº (1æ ):</strong></p>
                                    <pre class="whitespace-pre-wrap leading-tight">[ä¼Šè±†4ãƒãƒ¼ãƒ ] â”€â–¶ [ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ] â”€â–¶ å„ªå‹ (çœŒ)</pre>
                                </div>
                            </li>
                            <li>å„åœ°åŒºäºˆé¸ã‚’å‹ã¡æŠœã„ãŸè¨ˆ16ãƒãƒ¼ãƒ ãŒçœŒå¤§ä¼šæœ¬æˆ¦ (ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ) ã«é€²å‡ºã—ã¾ã™ã€‚
                                <div class="mt-2 mb-2 p-2 bg-purple-100 rounded text-xs border border-purple-300">
                                    <p class="font-semibold mb-1">çœŒå¤§ä¼šæœ¬æˆ¦ (16ãƒãƒ¼ãƒ ):</p>
                                    <pre class="whitespace-pre-wrap leading-tight">
    â”Œâ”€ æ±éƒ¨ä»£è¡¨ (5) â”
    â”œâ”€ ä¸­éƒ¨ä»£è¡¨ (5) â”¤
    â”œâ”€ è¥¿éƒ¨ä»£è¡¨ (5) â”¼â”€â–¶ [çœŒå¤§ä¼š (16ãƒãƒ¼ãƒ T)] â”€â–¶ å„ªå‹/æº–å„ªå‹ (ã‚»ãƒ³ãƒãƒ„æœ‰åŠ›)
    â””â”€ ä¼Šè±†ä»£è¡¨ (1) â”˜                       â””â”€â–¶ ãƒ™ã‚¹ãƒˆ8ä»¥ä¸Š (æ˜¥å­£ã‚·ãƒ¼ãƒ‰)</pre>
                                </div>
                            </li>
                            <li>çœŒå¤§ä¼šã®**å„ªå‹ãƒ»æº–å„ªå‹æ ¡**ã¯ã€æ˜¥ã®ã‚»ãƒ³ãƒãƒ„ç”²å­åœ’ã¸ã®å‡ºå ´æ¨©ã‚’å¾—ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆAIãŒç¢ºç‡ã§åˆ¤å®šï¼‰ã€‚</li>
                            <li>çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8ä»¥ä¸Šã®æˆç¸¾ã‚’åã‚ã‚‹ã¨ã€æ¬¡ã®**æ˜¥å­£å¤§ä¼šã®ã‚·ãƒ¼ãƒ‰æ¨©**ã‚’ç²å¾—ã§ãã¾ã™ã€‚</li>
                        </ul>
                    </div>

                    <div class="p-4 border rounded-lg bg-green-50">
                        <h5 class="font-semibold text-gray-800">æ˜¥ã®å¤§ä¼š (å¤ã®ã‚·ãƒ¼ãƒ‰æ¨©ç²å¾—æˆ¦)</h5>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            <li>å¤ã®å¤§ä¼šã®å‰å“¨æˆ¦ã¨ãªã‚‹é‡è¦ãªå¤§ä¼šã€‚</li>
                            <li>ç§‹å­£å¤§ä¼šãƒ™ã‚¹ãƒˆ8ã®ãƒãƒ¼ãƒ ã¯ã‚·ãƒ¼ãƒ‰æ ¡ã¨ãªã‚Šã€çœŒå¤§ä¼š2å›æˆ¦ã‹ã‚‰ç™»å ´ã—ã¾ã™ã€‚</li>
                            <li>ãã‚Œä»¥å¤–ã®å…¨ãƒãƒ¼ãƒ ã¯ã€ã¾ãšåœ°åŒºäºˆé¸ã«å‚åŠ ã—ã€å„åœ°åŒºä»£è¡¨æ  (æ±5, ä¸­5, è¥¿5, ä¼Šè±†1) ã‚’äº‰ã„ã¾ã™ã€‚</li>
                            <li>åœ°åŒºäºˆé¸ã‚’çªç ´ã—ãŸ16ãƒãƒ¼ãƒ ãŒã€çœŒå¤§ä¼š1å›æˆ¦ã§å¯¾æˆ¦ã—ã¾ã™ã€‚</li>
                            <li>1å›æˆ¦ã®å‹è€…8ãƒãƒ¼ãƒ ãŒã€2å›æˆ¦ã§å¾…ã¤ã‚·ãƒ¼ãƒ‰8ãƒãƒ¼ãƒ ã¨å¯¾æˆ¦ã—ã¾ã™ï¼ˆè¨ˆ16ãƒãƒ¼ãƒ ã«ã‚ˆã‚‹æœ¬æˆ¦ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆï¼‰ã€‚</li>
                            <li>ã“ã®å¤§ä¼šã§**ãƒ™ã‚¹ãƒˆ8**ä»¥ä¸Šã®æˆç¸¾ã‚’åã‚ã‚‹ã¨ã€æ¬¡ã®**å¤ã®å¤§ä¼šã®ã‚·ãƒ¼ãƒ‰æ¨©**ã‚’ç²å¾—ã§ãã¾ã™ã€‚
                                <div class="mt-2 mb-2 p-2 bg-green-100 rounded text-xs border border-green-300">
                                    <p class="font-semibold mb-1">çœŒå¤§ä¼šã®ä»•çµ„ã¿:</p>
                                    {/* Mermaid Diagram Code Block - Requires Mermaid.js library */}
                                    <pre><code class="language-mermaid">
graph TD
    subgraph çœŒå¤§ä¼š
        R1[1å›æˆ¦ (äºˆé¸çªç ´16ãƒãƒ¼ãƒ )] --> |å‹è€…8ãƒãƒ¼ãƒ | R2
        subgraph æœ¬æˆ¦ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ
            S[ã‚·ãƒ¼ãƒ‰8ãƒãƒ¼ãƒ  (ç§‹ãƒ™ã‚¹ãƒˆ8)] --> R2{2å›æˆ¦ (16ãƒãƒ¼ãƒ )}
            R2 --> QF{æº–ã€…æ±ºå‹ (ãƒ™ã‚¹ãƒˆ8)}
            QF --> SF{æº–æ±ºå‹ (ãƒ™ã‚¹ãƒˆ4)}
            SF --> F{æ±ºå‹}
        end
        QF --â–¶ |å¤ã®ã‚·ãƒ¼ãƒ‰æ¨©ç²å¾—| SumSeed(å¤ã®å¤§ä¼šã‚·ãƒ¼ãƒ‰æ¨©)
    end

    subgraph åœ°åŒºäºˆé¸
        O[ã‚·ãƒ¼ãƒ‰ä»¥å¤–ã®ãƒãƒ¼ãƒ ] --> RegQ{åœ°åŒºäºˆé¸}
        RegQ --> |16ãƒãƒ¼ãƒ | R1
    end

    style S fill:#f9f,stroke:#333,stroke-width:2px
    style SumSeed fill:#ccf,stroke:#333,stroke-width:2px
                                    </code></pre>
                                    <p class="mt-1 text-gray-500">(å›³ã®èª¬æ˜) ã‚·ãƒ¼ãƒ‰æ ¡ã¯2å›æˆ¦ã‹ã‚‰ç™»å ´ã€‚åœ°åŒºäºˆé¸çªç ´çµ„ã¯1å›æˆ¦ã‹ã‚‰æˆ¦ã„ã€å‹ã¡ä¸ŠãŒã‚‹ã¨ã‚·ãƒ¼ãƒ‰æ ¡ã¨å¯¾æˆ¦ã€‚ãƒ™ã‚¹ãƒˆ8ä»¥ä¸Šã§å¤ã®ã‚·ãƒ¼ãƒ‰æ¨©ç²å¾—ã€‚</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div>
                <h4 class="font-bold text-lg text-teal-700 mb-2">ã€æœ€é‡è¦ã€‘è©³ç´°å…¥åŠ›ï¼šç‰©èªã‚’æ·±åŒ–ã•ã›ã‚‹éµ</h4>
                <p class="text-sm mb-3">
                    è©¦åˆçµæœã®ã‚¹ã‚³ã‚¢ã ã‘ã§ãªãã€ã€Œè©³ç´°å…¥åŠ›ã€ã‚’è¡Œã†ã“ã¨ã§ã€AIãŒç”Ÿæˆã™ã‚‹è¨˜äº‹ã‚„ã‚³ãƒ¡ãƒ³ãƒˆã®è³ªãŒåŠ‡çš„ã«å‘ä¸Šã—ã€ã‚ˆã‚Šæ·±ã¿ã®ã‚ã‚‹ç‰©èªãŒç”Ÿã¾ã‚Œã¾ã™ã€‚é¢å€’ã§ã‚‚ã€ãœã²å…¥åŠ›ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
                </p>
                <ul class="list-disc list-inside space-y-2 text-sm bg-teal-50 p-4 rounded-lg">
                    <li><strong>ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢:</strong> è©¦åˆå±•é–‹ã‚’AIã«ä¼ãˆã¾ã™ã€‚ã€Œåˆå›ã«å¤§é‡å¾—ç‚¹ã—ãŸè©¦åˆã€ã¨ã€Œ9å›ã«é€†è»¢ã‚µãƒ¨ãƒŠãƒ©ã—ãŸè©¦åˆã€ã§ã¯ã€ç”Ÿæˆã•ã‚Œã‚‹è¨˜äº‹ã®ãƒ‰ãƒ©ãƒæ€§ãŒå…¨ãç•°ãªã‚Šã¾ã™ã€‚å»¶é•·æˆ¦ã¯ã€Œ+å›ã€ãƒœã‚¿ãƒ³ã§è¿½åŠ ã§ãã¾ã™ã€‚</li>
                    <li><strong>æ‰“æ’ƒæˆç¸¾:</strong>
                        <ul class="list-circle list-inside ml-4 text-xs">
                            <li>**æ‰“å¸­çµæœ:** ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰çµæœãƒ»æ–¹å‘ãƒ»æ‰“ç‚¹ãªã©ã‚’é¸æŠã—ã¾ã™ã€‚1ã‚¤ãƒ‹ãƒ³ã‚°ã«è¤‡æ•°æ‰“å¸­ã‚ã£ãŸå ´åˆã¯ã€Œ+2æ‰“å¸­ç›®ã‚’è¿½åŠ ã€ã§å…¥åŠ›ã§ãã¾ã™ã€‚</li>
                            <li>**èµ°å¡:** ã€Œ+èµ°è€…ãƒ—ãƒ¬ãƒ¼ã‚’è¿½åŠ ã€ã§ç›—å¡ã€é€²å¡ã€èµ°å¡æ­»ãªã©ã‚’å…¥åŠ›ã§ãã¾ã™ã€‚</li>
                            <li>**å‡ºå ´:** ä»£æ‰“ãƒ»ä»£èµ°ãƒ»å®ˆå‚™äº¤ä»£ãªã©ã®æƒ…å ±ã¯ã€äº¤ä»£é¸æ‰‹ã®æ´»èºã‚’æå†™ã™ã‚‹ä¸Šã§é‡è¦ã§ã™ã€‚</li>
                            <li>AIã¯ã“ã“ã§ã®å…¥åŠ›ã«åŸºã¥ãã€ãã®è©¦åˆã®ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚’ç‰¹å®šã—ã€è¨˜äº‹ã®ä¸­å¿ƒäººç‰©ã¨ã—ã¦æå†™ã—ã¾ã™ã€‚</li>
                        </ul>
                    </li>
                    <li><strong>æŠ•æ‰‹æˆç¸¾:</strong> æŠ•æ‰‹åã€æŠ•çƒå›ã€å¤±ç‚¹ã€å¥ªä¸‰æŒ¯ãªã©ã‚’å…¥åŠ›ã—ã¾ã™ã€‚å…ˆç™ºå®ŒæŠ•ã€ãƒªãƒªãƒ¼ãƒ•æˆåŠŸã€ç‚ä¸Šãªã©ã€æŠ•æ‰‹ã®æ´»èºã‚„è‹¦é—˜ãŒè¨˜äº‹ã«åæ˜ ã•ã‚Œã¾ã™ã€‚ã€Œ+æŠ•æ‰‹ã‚’è¿½åŠ ã€ã§ç¶™æŠ•ã‚‚è¨˜éŒ²ã§ãã¾ã™ã€‚</li>
                    <li><strong>è©¦åˆã®æ±ºã‚æ‰‹ (ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢):</strong> ã‚¹ã‚³ã‚¢å…¥åŠ›æ¬„ã®ä¸‹ã«ã‚ã‚‹å°ã•ãªãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã§ã™ã€‚ã“ã“ã«**æœ€ã‚‚ä¼ãˆãŸã„è©¦åˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ**ï¼ˆä¾‹ï¼šã€Œã‚¨ãƒ¼ã‚¹ã€‡ã€‡ã€æ°—è¿«ã®150çƒå®ŒæŠ•å‹åˆ©ã€ã€Œä¼å…µâ–³â–³ã®ã‚µãƒ¨ãƒŠãƒ©æ‰“ã€ãªã©ï¼‰ã‚’ç°¡æ½”ã«å…¥åŠ›ã™ã‚‹ã¨ã€AIã¯ä»–ã®ã©ã®æƒ…å ±ã‚ˆã‚Šã‚‚ã“ã‚Œã‚’**æœ€å„ªå…ˆ**ã—ã€è¨˜äº‹å…¨ä½“ã®ãƒ†ãƒ¼ãƒã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚</li>
                </ul>
                <p class="text-xs mt-2 text-gray-600">â€»è©³ç´°å…¥åŠ›ç”»é¢ã®ã€Œå…ˆæ”»ãƒ»å¾Œæ”»ã‚’å…¥ã‚Œæ›¿ãˆã€ãƒœã‚¿ãƒ³ã§ã€å…¥åŠ›å†…å®¹ã”ã¨ãƒãƒ¼ãƒ ã‚’å…¥ã‚Œæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</p>
                <p class="text-xs mt-1 text-gray-600">â€»ã‚¹ã‚³ã‚¢å…¥åŠ›æ¬„ã®æ¨ªã«ã‚ã‚‹ã€ŒğŸ²ã€ãƒœã‚¿ãƒ³ã§ã€ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ã¦AIãŒãŠã¾ã‹ã›ã§è©³ç´°å†…å®¹ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</p>
            </div>

            <div>
                <h4 class="font-bold text-lg text-indigo-700 mb-2">AIãŒç”Ÿæˆã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹:</strong> è©¦åˆçµæœã‚„å¤§ä¼šã®å±•æœ›ã€æ™‚ã«ã¯ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«ç–‘æƒ‘(!)ãªã©ã€æ§˜ã€…ãªè¨˜äº‹ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã€Œæœ¬æ–‡ã€ãƒœã‚¿ãƒ³ã§å†…å®¹ã‚’èª­ã‚ã¾ã™ã€‚è¨˜äº‹ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’åˆã‚ã›ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã€Œå†ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€AIã«è¿½åŠ æŒ‡ç¤ºã‚’ä¸ãˆã¦è¨˜äº‹ã‚’æ›¸ãç›´ã•ã›ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ©Ÿèƒ½ï¼‰ã€‚</li>
                    <li><strong>æ²ç¤ºæ¿ã®åå¿œ:</strong> AIãŒåŒ¿åæ²ç¤ºæ¿ã®ãƒ•ã‚¡ãƒ³ã«ãªã‚Šãã‚Šã€è©¦åˆçµæœã‚„ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«å¯¾ã—ã¦ãƒªã‚¢ãƒ«ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã‚ãªãŸã‚‚ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã§ãã€AIãƒ•ã‚¡ãƒ³ãŒãã‚Œã«è¿”ä¿¡ã—ã¦ãã‚Œã¾ã™ã€‚</li>
                    <li><strong>ã¾ã¨ã‚ã‚µã‚¤ãƒˆé¢¨ã‚¹ãƒ¬ãƒƒãƒ‰:</strong> ã€ŒğŸ“° ã¾ã¨ã‚ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§ã€ç¾å®Ÿã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¨ã‚²ãƒ¼ãƒ å†…ã®è©¦åˆçµæœãŒæ··åœ¨ã—ãŸã€ãªã‚“Jã¾ã¨ã‚ã‚µã‚¤ãƒˆé¢¨ã®è¡¨ç¤ºãŒæ¥½ã—ã‚ã¾ã™ã€‚å„è¨˜äº‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®è©±é¡Œã«é–¢ã™ã‚‹AIç”Ÿæˆã®æ²ç¤ºæ¿ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’èª­ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚</li>
                    <li><strong>ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ãƒ‹ãƒ¥ãƒ¼ã‚¹:</strong> ç³»åˆ—æ ¡ï¼ˆ765ç·åˆã€283å­¦åœ’ãªã©ï¼‰ã®è©¦åˆçµæœã‚„çµ„ã¿åˆã‚ã›ã«é–¢ã™ã‚‹ã€ä¼æ¥­å…¬å¼ç™ºè¡¨é¢¨ã®ãŠçŸ¥ã‚‰ã›ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</li>
                    <li><strong>ã‚¹ãƒãƒ¼ãƒ„æ–°è:</strong> å¤§ä¼šãŒé€²ã‚€ã¨ï¼ˆæº–ã€…æ±ºå‹ä»¥é™ï¼‰ã€AIãŒãã®æ—¥ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ä¸€é¢è¨˜äº‹ã«ã—ãŸã‚¹ãƒãƒ¼ãƒ„æ–°èé¢¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã€Œæ–°èã‚’èª­ã‚€ã€ãƒœã‚¿ãƒ³ã§è¡¨ç¤ºã§ãã¾ã™ã€‚</li>
                    <li><strong>å¯†ç€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼:</strong> ç‰¹å®šã®ãƒãƒ¼ãƒ ï¼ˆå¼·è±ªã€å¤è±ªã€é€†å¢ƒæ ¡ãªã©ï¼‰ã«ç„¦ç‚¹ã‚’å½“ã¦ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼è¨˜äº‹ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚è©¦åˆã®å‹æ•—ã«å¿œã˜ã¦é€£è¼‰å½¢å¼ã§ç‰©èªãŒé€²è¡Œã—ã¾ã™ã€‚</li>
                </ul>
            </div>

             <div>
                <h4 class="font-bold text-lg text-pink-700 mb-2">ãã®ä»–ã®æ©Ÿèƒ½</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>ãƒãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®ãƒãƒ¼ãƒ åã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®ãƒãƒ¼ãƒ ã®éå»ã®æœ€é«˜æˆç¸¾ã‚„ç›´è¿‘ã®æˆç¸¾ã€ç²å¾—ã—ãŸç§°å·ï¼ˆä¾‹ï¼šã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒ©ãƒ¼ï¼‰ãªã©ã‚’ç¢ºèªã§ãã¾ã™ã€‚</li>
                    <li><strong>ã‚¹ã‚­ãƒƒãƒ—æ©Ÿèƒ½:</strong> å„å¤§ä¼šã‚„ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã«ç”¨æ„ã•ã‚ŒãŸã€Œã‚¹ã‚­ãƒƒãƒ—ã€ãƒœã‚¿ãƒ³ã‚’ä½¿ã†ã¨ã€è©¦åˆçµæœã‚’è‡ªå‹•ã§ï¼ˆãƒ©ãƒ³ã‚¯å·®ãªã©ã‚’è€ƒæ…®ã—ã¦ï¼‰ç”Ÿæˆã—ã€å¤§ä¼šã‚’é«˜é€Ÿã§é€²è¡Œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</li>
                    <li><strong>è¨­å®š:</strong> ç”»é¢å³ä¸Šã®ã€Œâš™ï¸ è¨­å®šã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚„æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆã®è‡ªå‹•ç”Ÿæˆã‚’ON/OFFã§ãã¾ã™ã€‚</li>
                    <li><strong>æŠ½é¸ä¼š/å‹¢åŠ›å›³åˆ†æ:</strong> å¤ã®å¤§ä¼šé–‹å§‹æ™‚ã«ã¯æŠ½é¸ä¼šã‚¤ãƒ™ãƒ³ãƒˆãŒã€æŠ½é¸å¾Œã«ã¯å„ãƒ–ãƒ­ãƒƒã‚¯ã®å‹¢åŠ›å›³ã‚’AIãŒåˆ†æãƒ»è§£èª¬ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
                 </ul>
            </div>

            <div>
                <h4 class="font-bold text-lg text-red-700 mb-2">ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>ã‚¨ãƒ©ãƒ¼ã§å‹•ä½œãŒãŠã‹ã—ããªã£ãŸ / ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹:</strong> æœ€ã‚‚å¤šã„åŸå› ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å¤ã„ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¨ã€æœ€æ–°ç‰ˆã®ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã®é–“ã§çŸ›ç›¾ãŒç”Ÿã˜ã¦ã„ã‚‹ã“ã¨ã§ã™ã€‚**ã€Œãƒªã‚»ãƒƒãƒˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä¸€åº¦å®Œå…¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¦ã‹ã‚‰**ã€Œæ–°ã—ã„ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’é–‹å§‹ã€ã™ã‚‹ã¨è§£æ±ºã™ã‚‹ã“ã¨ãŒã»ã¨ã‚“ã©ã§ã™ã€‚é–‹ç™ºä¸­ã®ä»•æ§˜å¤‰æ›´å¾Œã¯ç‰¹ã«ãƒªã‚»ãƒƒãƒˆã‚’ãŠè©¦ã—ãã ã•ã„ã€‚</li>
                    <li><strong>AIã®è¨˜äº‹ã‚„ã‚³ãƒ¡ãƒ³ãƒˆãŒãŠã‹ã—ã„ / äº‹å®Ÿã¨é•ã†:</strong> AIã«ä¸ãˆã‚‹æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹ã‹ã€AIãŒç¨€ã«å‹˜é•ã„ã‚’ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
                        <ul class="list-circle list-inside ml-4 text-xs">
                            <li>è¨˜äº‹ã®å ´åˆã¯ã€ã€Œå†ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¸ãˆã¦ã¿ã¦ãã ã•ã„ã€‚</li>
                            <li>æ€ã£ãŸã‚ˆã†ãªè¨˜äº‹ã«ãªã‚‰ãªã„å ´åˆã€è©³ç´°å…¥åŠ›ã§ã‚ˆã‚Šå¤šãã®æƒ…å ±ï¼ˆç‰¹ã«æ•—ã‚ŒãŸãƒãƒ¼ãƒ ã®æˆç¸¾ã‚„ã€æ´»èºã—ãŸé¸æ‰‹åï¼‰ã‚’å…·ä½“çš„ã«å…¥åŠ›ã—ãŸã‚Šã€ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€æ¬„ã‚’æ´»ç”¨ã—ãŸã‚Šã™ã‚‹ã¨æ”¹å–„ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</li>
                        </ul>
                    </li>
                     <li><strong>ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆåˆã„è¨€è‘‰ï¼‰ãŒèª­ã¿è¾¼ã‚ãªã„:</strong> ã‚³ãƒ¼ãƒ‰ãŒæ›´æ–°ã•ã‚Œã‚‹ã¨ã€å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®åˆã„è¨€è‘‰ã¯èª­ã¿è¾¼ã‚ãªããªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã”äº†æ‰¿ãã ã•ã„ã€‚</li>
                </ul>
            </div>

       </div> <div id="tournament-animation-section" class="mt-6 border-t pt-4">

                <h4 class="font-bold text-lg text-purple-700 mb-3 text-center">å›³è§£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¦‹ã‚‹å¤§ä¼šã‚·ã‚¹ãƒ†ãƒ </h4>

                <div class="flex justify-center space-x-4 mb-4">

                    <button id="show-autumn-anim-btn" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">ğŸ‚ ç§‹å­£å¤§ä¼šã‚’è¦‹ã‚‹</button>

                    <button id="show-spring-anim-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">ğŸŒ¸ æ˜¥å­£å¤§ä¼šã‚’è¦‹ã‚‹</button>

                </div>

                <div id="animation-stage" class="bg-gray-100 p-4 rounded min-h-[300px] border relative overflow-hidden flex flex-col justify-center items-center">

                    <p id="anim-placeholder" class="text-gray-500">ä¸Šã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹</p>

                </div>

                <p id="animation-narration" class="mt-3 text-center text-sm font-semibold h-10"></p>

                <div class="flex justify-center space-x-4 mt-3">

                    <button id="prev-step-btn" class="bg-gray-400 text-white px-4 py-1 rounded hover:bg-gray-500 disabled:opacity-50" disabled>ï¼œ å‰ã¸</button>

                    <button id="next-step-btn" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600 disabled:opacity-50" disabled>æ¬¡ã¸ ï¼</button>

                </div>

            </div>

            </div> <div class="mt-6 text-center border-t pt-4">

            <button id="help-modal-close" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">é–‰ã˜ã‚‹</button>

        </div>

    </div> </div>

<div id="team-status-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 id="status-modal-team-name" class="text-2xl font-bold text-gray-800"></h3>
            <button id="status-modal-close" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="space-y-4">
            <div>
                <h4 class="font-semibold text-sm text-gray-500 uppercase tracking-wider">æœ€é«˜æˆ¦ç¸¾</h4>
                <p id="status-modal-best" class="text-lg text-amber-600 font-bold"></p>
            </div>
            <div>
                <h4 class="font-semibold text-sm text-gray-500 uppercase tracking-wider">ç›´è¿‘ã®æˆç¸¾</h4>
                <div id="status-modal-history" class="space-y-1 text-gray-700"></div>
            </div>
            <div>
                <h4 class="font-semibold text-sm text-gray-500 uppercase tracking-wider">ç§°å·</h4>
                <div id="status-modal-traits" class="flex flex-wrap gap-2"></div>
            </div>
            
</div>

            <div>
                <h4 class="font-semibold text-sm text-gray-500 uppercase tracking-wider">ä»Šå¤§ä¼š ãƒãƒ¼ãƒ æˆç¸¾</h4>
                <p id="status-modal-team-stats" class="text-lg text-blue-700 font-bold"></p>
            </div>
            

            <div>
                <h4 class="font-semibold text-sm text-gray-500 uppercase tracking-wider">ç›£ç£</h4>
                <div id="status-modal-coach" class="text-gray-700"></div>
            </div>
            </div>
    </div>
</div>
<script type="module">

const BATTING_RESULTS = {
    hits: ['å®‰', 'äºŒå¡æ‰“', 'ä¸‰å¡æ‰“', 'æœ¬å¡æ‰“'],
    outs: ['ä¸‰æŒ¯', 'ã‚´ãƒ­', 'é£›', 'é‚ª', 'ç›´', 'ä½µæ®º'],
    walks: ['å››çƒ', 'æ­»çƒ', 'æ•¬é '],
    sacrifices: ['çŠ æ‰“', 'çŠ é£›', 'çŠ å¤±'], // â† ã“ã“ã«è¿½åŠ 
    other: ['é‡é¸', 'ã‚¨ãƒ©ãƒ¼']
};
const DIRECTIONS = ['æŠ•', 'æ•', 'ä¸€', 'äºŒ', 'ä¸‰', 'éŠ', 'å·¦', 'ä¸­', 'å³'];
const RBIS = ['1ç‚¹', '2ç‚¹', '3ç‚¹', '4ç‚¹'];

    // --- ãƒ©ã‚¤ãƒãƒ«é–¢ä¿‚ã¨ç§°å·ã®å®šç¾© ---
    const RIVALRIES = [
        { teams: ["é™å²¡", "æ›å·è¥¿"], type: "å…¬ç«‹ã®è¦‡æ¨©äº‰ã„" },
        { teams: ["283å­¦åœ’", "é™å²¡å•†æ¥­"], type: "ä¼çµ±ã¨ç‹è€…ã®è¦‡æ¨©å¯¾æ±º" },
        { teams: ["765ç·åˆé«˜æ ¡", "é™å²¡"], type: "æ–°æ—§ç‹è€…å¯¾æ±º" },
        { teams: ["é™å²¡", "é™å²¡å•†æ¥­"], type: "ä¼çµ±ã®ä¸€æˆ¦" }
    ];
    const TITLES = {
        GIANT_KILLER: { id: 'giant_killer', name: 'ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒ©ãƒ¼', desc: 'æ ¼ä¸Šã®å¼·è±ªæ ¡ã‚’å€’ã—ãŸå®Ÿç¸¾ã‚’æŒã¤ã€‚' },
        REPECHAGE_KING: { id: 'repechage_king', name: 'ä¸å±ˆã®æ•—è€…å¾©æ´»çµ„', desc: 'æ•—è€…å¾©æ´»æˆ¦ã‹ã‚‰é€™ã„ä¸ŠãŒã£ã¦ããŸå®Ÿç¸¾ãŒã‚ã‚Šã€éå¸¸ã«ç²˜ã‚Šå¼·ã„ã€‚' },
        WALL_OF_TOKYO: { id: 'wall_of_tokyo', name: 'è¥¿æ±äº¬ã®å£', desc: 'è¥¿æ±äº¬åœ°åŒºã«ç«‹ã¡ã¯ã ã‹ã‚‹çµ¶å¯¾çš„å¼·è€…ã€‚' } // ä¾‹
    };
const tournamentNameMap = { summer: 'å¤å­£å¤§ä¼š', autumn: 'ç§‹å­£å¤§ä¼š', spring: 'æ˜¥å­£å¤§ä¼š' };

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆã‚‹ â–¼â–¼â–¼
const SCANDAL_DEFINITIONS = [
    {
        id: 'overpractice',
        condition: (teamName) => ['A', 'B'].includes(calculateRank(teamName, tournamentState)),
        
        // æ–‡å­—åˆ—ã‹ã‚‰é–¢æ•°ã«å¤‰æ›´
        rumorTitle: (teamName) => `ã€é€±åˆŠç†±é—˜ã€‘${teamName}ã«ã€Œé•æ³•ç·´ç¿’ã€ç–‘æƒ‘ã‹ï¼Ÿ`,
        rumorBody: (teamName) => `å¼·è±ªã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹${teamName}ã ãŒã€ãã®å¼·ã•ã®è£ã«ã¯ã€é«˜æ ¡é‡çƒé€£ç›ŸãŒå®šã‚ã‚‹ç·´ç¿’æ™‚é–“è¦å®šã‚’å¤§å¹…ã«è¶…éã™ã‚‹ã»ã©ã®çŒ›ç·´ç¿’ãŒã‚ã‚‹ã¨ã„ã†ã‚¿ãƒ¬ã‚³ãƒŸãŒæœ¬èªŒã«å¯„ã›ã‚‰ã‚ŒãŸã€‚æ·±å¤œã¾ã§ãƒãƒƒãƒˆã®éŸ³ãŒé³´ã‚ŠéŸ¿ãã¨ã„ã†è¿‘éš£ä½æ°‘ã®è¨¼è¨€ã‚‚ã‚ã‚Šã€ä»Šå¾Œã®å‹•å‘ãŒæ³¨ç›®ã•ã‚Œã‚‹ã€‚`,
        
        consequences: {
            report: {
                // ã“ã¡ã‚‰ã‚‚åŒæ§˜ã«é–¢æ•°ã«å¤‰æ›´
                outcomeTitle: (teamName) => `ã€é€Ÿå ±ã€‘${teamName}ã€ç·´ç¿’è¦å®šé•åã§å…¬å¼æˆ¦ã‚’è¾é€€`,
                outcomeBody: (teamName) => `å…ˆæ—¥ã€é€±åˆŠèªŒã§å ±ã˜ã‚‰ã‚ŒãŸ${teamName}ã®ç·´ç¿’æ™‚é–“è¦å®šé•åå•é¡Œã§ã€é«˜é‡é€£ã¯èª¿æŸ»ã®çµæœã€é•åã®äº‹å®Ÿã‚’èªå®šã€‚åŒæ ¡ã¯äº‹æ…‹ã‚’é‡ãå—ã‘æ­¢ã‚ã€ä»Šå¤§ä¼šã®æ®‹ã‚Šè©¦åˆã‚’è¾é€€ã™ã‚‹ã“ã¨ã‚’ç™ºè¡¨ã—ãŸã€‚`,
                applyEffect: (teamName, state) => {
        if (state.teamRecords[teamName]) {
            state.teamRecords[teamName].penalty = 'forfeit';
        }

        const currentMatch = findCurrentMatchForTeam(teamName, state);
        if (!currentMatch) return; // è©²å½“ã™ã‚‹è©¦åˆãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

        const opponent = currentMatch.team1 === teamName ? currentMatch.team2 : currentMatch.team1;

        // ç›¸æ‰‹ãŒã„ãªã„å ´åˆï¼ˆã‚·ãƒ¼ãƒ‰ãªã©ï¼‰ã¯ã€å˜ã«è² ã‘æ‰±ã„ã«ã™ã‚‹
        if (!opponent) {
            currentMatch.winner = `(ä¸æˆ¦æ•—)`;
            currentMatch.team1 = teamName;
            currentMatch.team2 = null;
            return;
        }

        // ä¸æˆ¦å‹ã¨ã—ã¦è©¦åˆçµæœã‚’è¨˜éŒ²
        currentMatch.winner = opponent;
        currentMatch.summary = `${teamName}ã®ä¸ç¥¥äº‹ã«ã‚ˆã‚‹ä¸æˆ¦å‹`;

        if (currentMatch.team1 === opponent) {
            currentMatch.score1 = 'W'; // Win
            currentMatch.score2 = 'L'; // Lose
        } else {
            currentMatch.score1 = 'L';
            currentMatch.score2 = 'W';
        }

        // ãƒãƒ¼ãƒ è¨˜éŒ²ã‚’æ›´æ–°
        if(state.teamRecords[opponent]) state.teamRecords[opponent].wins++;
        if(state.teamRecords[teamName]) state.teamRecords[teamName].losses++;
        
        // å‹è€…ã‚’æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸è‡ªå‹•ã§é€²ã‚ã‚‹
        advanceWinnerToNextRound(currentMatch, opponent, state);
    }
            },
            ignore: {
                outcomeTitle: (teamName) => `${teamName}ã®ç·´ç¿’å•é¡Œã€é«˜é‡é€£ã¯ã€Œäº‹å®Ÿç¢ºèªã§ããšã€`,
                outcomeBody: (teamName) => `å…ˆæ—¥ã€ä¸€éƒ¨é€±åˆŠèªŒã§å ±ã˜ã‚‰ã‚ŒãŸ${teamName}ã®ç·´ç¿’æ™‚é–“ã«é–¢ã™ã‚‹ç–‘æƒ‘ã«å¯¾ã—ã€é«˜é‡é€£ã¯ã€Œç¾æ™‚ç‚¹ã§é•åã®äº‹å®Ÿã¯ç¢ºèªã§ããªã‹ã£ãŸã€ã¨ç™ºè¡¨ã€‚å™‚ã¯å™‚ã®ã¾ã¾ã€çƒå…ãŸã¡ã®å¤ã¯ç¶šãã€‚`,
                applyEffect: (teamName, state) => { /* ä½•ã‚‚ã—ãªã„ */ }
            }
        }
    }
];
// â–²â–²â–² ã“ã“ã¾ã§ç½®ãæ›ãˆ â–²â–²â–²
    // --- DOM Elements ---
    const setupEl = document.getElementById('setup');
    const tournamentDisplayEl = document.getElementById('tournament-display');
    const teamsTextarea = document.getElementById('teams-list');
    const generateBtn = document.getElementById('generate-btn');
    const resumeBtn = document.getElementById('resume-btn');
    const resetBtn = document.getElementById('reset-btn');
    const nextTournamentBtn = document.getElementById('next-tournament-btn');
    const saveBtn = document.getElementById('save-btn');
    const mainBracketContainer = document.getElementById('main-bracket-container');
    const mainBracketWrapper = document.getElementById('main-bracket-wrapper');
    const newsContainer = document.getElementById('news-articles');
    const bbsCommentsContainer = document.getElementById('bbs-comments');
    const daiyaBbsSection = document.getElementById('daiya-bbs-section');
    const daiyaBbsCommentsContainer = document.getElementById('daiya-bbs-comments');
    const namcoNewsSection = document.getElementById('namco-news-section');
    const namcoNewsContent = document.getElementById('namco-news-content');
    const tournamentYearDisplay = document.getElementById('tournament-year-display');
    const generateSummaryBtn = document.getElementById('generate-summary-btn');
    const skipR1Btn = document.getElementById('skip-r1-btn');
    const skipR2Btn = document.getElementById('skip-r2-btn');
    const skipR3Btn = document.getElementById('skip-r3-btn');

    const skipLoader = document.getElementById('skip-loader');
const skipR4Btn = document.getElementById('skip-r4-btn');
const skipR5Btn = document.getElementById('skip-r5-btn');
const skipFinalBtn = document.getElementById('skip-final-btn');
    // Autumn Tournament UI
    const autumnRegionalContainer = document.getElementById('autumn-regional-blocks-container');
    const autumnRankingContainer = document.getElementById('autumn-ranking-playoffs-container');
    const autumnControls = document.getElementById('autumn-controls');
    const startRankingPlayoffsBtn = document.getElementById('start-ranking-playoffs-btn');
    const startMainTournamentBtn = document.getElementById('start-main-tournament-btn');
// â–¼â–¼â–¼ ã“ã“ã‹ã‚‰3è¡Œè¿½åŠ  â–¼â–¼â–¼
const skipAutumnBlocksBtn = document.getElementById('skip-autumn-blocks-btn');
const skipAutumnRankingBtn = document.getElementById('skip-autumn-ranking-btn');
const skipAutumnMainBtn = document.getElementById('skip-autumn-main-btn');
// â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–²
// â–¼â–¼â–¼ ã“ã“ã‹ã‚‰3è¡Œè¿½åŠ  â–¼â–¼â–¼
const skipSpringQualifiersBtn = document.getElementById('skip-spring-qualifiers-btn');
const skipSpringRound1Btn = document.getElementById('skip-spring-round1-btn');
const skipSpringMainBtn = document.getElementById('skip-spring-main-btn');
// â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–²
    // Modals
    const newsModal = document.getElementById('news-modal');
    const modalBg = document.getElementById('modal-bg');
    const modalClose = document.getElementById('modal-close');
    const confirmModal = document.getElementById('confirm-modal');
    const detailsModal = document.getElementById('details-modal');
    const saveLoadModal = document.getElementById('save-load-modal');
    const saveTabBtn = document.getElementById('save-tab-btn');
    const loadTabBtn = document.getElementById('load-tab-btn');
    const saveTabContent = document.getElementById('save-tab-content');
    const loadTabContent = document.getElementById('load-tab-content');
    const generateSaveCodeBtn = document.getElementById('generate-save-code-btn');
    const loadFromCodeBtn = document.getElementById('load-from-code-btn');
    const saveLoadCloseBtn = document.getElementById('save-load-close');
    const copySaveCodeBtn = document.getElementById('copy-save-code-btn');
    const newspaperModal = document.getElementById('newspaper-modal');
    const newspaperModalBody = document.getElementById('newspaper-modal-body');
    const newspaperCloseBtn = document.getElementById('newspaper-close');

    
    // --- State Management ---
    let tournamentState = {};
    let currentMatchIdForDetails = null;
    let articleForRegeneration = null; 
    let soundEffects = {};
let currentBlock = 'A';
    const UNDERDOG_TEAMS = ["è™åºœå³¶ç·åˆ", "æµœæ¾ç‰¹æ”¯", "å·æ ¹", "ä¼Šè±†ç·åˆ", "æ¹–è¥¿", "å°å±±", "æ–°å±…", "ç†±æµ·", "ä¼Šè±†ä¸­å¤®", "å³¶ç”°", "å³¶ç”°å·¥æ¥­", "è£¾é‡"];
    const POWERHOUSE_TEAMS = ["283å­¦åœ’", "å¸¸è‘‰èŠå·", "é™å²¡", "æ›å·è¥¿", "é™å²¡å•†æ¥­", "è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼", "765ç·åˆé«˜æ ¡"];
ã€€ã€€const POWERHOUSE_REVIVAL_TEAMS = ["æµœæ¾å•†æ¥­", "é™æ¸…", "é£›é¾"];
ã€€ã€€const ONE_MAN_TEAMS = ["å¯Œå£«å®®åŒ—"];

// â–¼â–¼â–¼ ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã€æ—¢å­˜ã®SoundManagerã‚’å®Œå…¨ã«ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
// â–¼â–¼â–¼ ã‚µã‚¦ãƒ³ãƒ‰ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  â–¼â–¼â–¼
// â–¼â–¼â–¼ ã‚µã‚¦ãƒ³ãƒ‰ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œãƒ»æœ€çµ‚å®Œæˆç‰ˆï¼‰â–¼â–¼â–¼
// â–¼â–¼â–¼ BGMç®¡ç†ã«ç‰¹åŒ–ã—ãŸæ–°ã—ã„ã‚µã‚¦ãƒ³ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ â–¼â–¼â–¼
// â–¼â–¼â–¼ BGMã®éŸ³é‡èª¿æ•´æ©Ÿèƒ½ä»˜ãã‚µã‚¦ãƒ³ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ â–¼â–¼â–¼
const SoundManager = {
    bgm: null,
    isReady: false,
    volume: 0.07, // BGMã®éŸ³é‡ã‚’è¨­å®š (0.0ãŒãƒŸãƒ¥ãƒ¼ãƒˆ, 1.0ãŒæœ€å¤§)

    init() {
        this.bgm = document.getElementById('lottery-bgm');
        
        const unlockAudio = () => {
            if (!this.isReady && this.bgm) {
                this.isReady = true;
                this.bgm.volume = this.volume; // åˆæœŸéŸ³é‡ã‚’è¨­å®š
                this.bgm.play().catch(e => console.error("BGM unlock failed:", e));
                this.bgm.pause();
                console.log("BGM ready.");
            }
            document.body.removeEventListener('click', unlockAudio);
        };
        
        document.body.addEventListener('click', unlockAudio, { once: true });
    },

    startBgm() {
        if (this.isReady && this.bgm) {
            this.bgm.volume = this.volume; // å†ç”Ÿå‰ã«éŸ³é‡ã‚’è¨­å®š
            this.bgm.currentTime = 0;
            this.bgm.play().catch(e => console.error("BGM play failed:", e));
        }
    },

    stopBgm() {
        if (this.bgm) {
            this.bgm.pause();
            this.bgm.currentTime = 0;
        }
    }
};
// â–²â–²â–²
// â–²â–²â–²
// â–²â–²â–² â–²â–²â–²
// â–²â–²â–²

    // â–¼â–¼â–¼ 100ç¨®é¡ã®æ—¥æœ¬ã®è‹—å­—ãƒªã‚¹ãƒˆ â–¼â–¼â–¼
const JAPANESE_SURNAMES = [
    "ä½è—¤", "éˆ´æœ¨", "é«˜æ©‹", "ç”°ä¸­", "ä¼Šè—¤", "æ¸¡è¾º", "å±±æœ¬", "ä¸­æ‘", "å°æ—", "åŠ è—¤",
    "å‰ç”°", "å±±ç”°", "ä½ã€…æœ¨", "å±±å£", "æ¾æœ¬", "äº•ä¸Š", "æœ¨æ‘", "æ—", "æ–è—¤", "æ¸…æ°´",
    "å±±å´", "æ£®", "æ± ç”°", "æ©‹æœ¬", "é˜¿éƒ¨", "çŸ³å·", "å±±ä¸‹", "ä¸­å³¶", "çŸ³äº•", "å°å·",
    "å‰ç”°", "å²¡ç”°", "é•·è°·å·", "è—¤ç”°", "å¾Œè—¤", "æ‘ä¸Š", "è¿‘è—¤", "å‚æœ¬", "é è—¤", "é’æœ¨",
    "è—¤äº•", "è¥¿æ‘", "ä¸‰æµ¦", "å²¡æœ¬", "æ¾ç”°", "ä¸­å·", "ä¸­é‡", "åŸç”°", "å°é‡", "ç”°æ‘",
    "ç«¹å†…", "é‡‘å­", "å’Œç”°", "ä¸­å±±", "çŸ³ç”°", "ä¸Šç”°", "æ£®ç”°", "åŸ", "æŸ´ç”°", "é…’äº•",
    "å·¥è—¤", "æ¨ªå±±", "å®®å´", "å®®æœ¬", "å†…ç”°", "é«˜æœ¨", "å®‰è—¤", "è°·å£", "å¤§é‡", "ä¸¸å±±",
    "ä»Šäº•", "é«˜ç”°", "è—¤åŸ", "æ­¦ç”°", "æ¾äº•", "æ‰å±±", "æ‘ç”°", "å¤§å¡š", "åƒè‘‰", "å²©å´",
    "æ¡œäº•", "é‡å£", "æ¾å°¾", "èŠåœ°", "é‡æ‘", "æ–°äº•", "æ¸¡éƒ¨", "ä½é‡", "å®‰ç”°", "å®®ç”°",
    "å°å³¶", "å¤§è¥¿", "æ‰æœ¬", "å¸‚å·", "å¤å·", "ä¹…ä¿", "å·å´", "é£¯ç”°", "ä¸­ç”°", "å €"
];

// â–¼â–¼â–¼ ã‚µã‚¦ãƒ³ãƒ‰ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  â–¼â–¼â–¼

// â–²â–²â–²

// --- Team Master Data ---
    const TEAM_DATA = {
    "å¤©ç«œ": {
        name_yomi: "ã¦ã‚“ã‚Šã‚…ã†",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 38,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "å‰µéƒ¨3å¹´ç›®ã«ã—ã¦ãƒ™ã‚¹ãƒˆ16å…¥ã‚Šã‚’æœãŸã—ãŸæœŸå¾…ã®æ–°èˆˆå‹¢åŠ›ã€‚æ–°ä»»ã®å¿—è³€ç›£ç£ã®ä¸‹ã€æŒ‘æˆ¦è€…ã¨ã—ã¦ã®ã³ã®ã³ã¨ãƒ—ãƒ¬ãƒ¼ã—ãŸæ˜¨å¹´ã¨ã¯ä¸€è»¢ã€ä»Šå¹´ã¯ä»–æ ¡ã‹ã‚‰ã®ãƒãƒ¼ã‚¯ã‚‚å³ã—ããªã‚‹ã€‚æ˜¨å¹´ã®èºé€²ãŒãƒ•ãƒ­ãƒƒã‚¯ã§ãªã‹ã£ãŸã“ã¨ã‚’è¨¼æ˜ã§ãã‚‹ã‹ã€çœŸä¾¡ãŒå•ã‚ã‚Œã‚‹å¤ã¨ãªã‚‹ã€‚è¥¿éƒ¨åœ°åŸŸã®å­¦æ ¡ã‹ã‚‰ã®ç”²å­åœ’ã§ã®æˆç¸¾ãŒä¹ã—ã„ãŸã‚ã€çªå¦‚ç¾ã‚ŒãŸå½—æ˜Ÿã«æœŸå¾…ã®å£°ã‚‚å¤šã„ã€‚ã‚¨ãƒ¼ã‚¹ã®ä¸‰æ©‹ã‚„ãƒªãƒ¼ãƒ‰ã‚ªãƒ•ãƒãƒ³ã®ç”°å³¶ã‚’ç­†é ­ã«éƒ¨å“¡æ•°ã¯å°‘ãªã„ãªãŒã‚‰ã‚‚åŠ›ã®ã‚ã‚‹é¸æ‰‹ã‚‚å¤šã„ã€‚ãƒãƒ¼ãƒ ã¨ã—ã¦ã®ç›®æ¨™ã¯æ˜¨å¹´ã‚’è¶…ãˆã‚‹ãƒ™ã‚¹ãƒˆ8ã§ã¯ãªãç”²å­åœ’å‡ºå ´ã€‚è¥¿éƒ¨åœ°åŸŸã®é›„ã¨ãªã‚‹ãŸã‚ã«ã€ã¾ãšã¯ä»Šå¹´ã€ã©ã“ã¾ã§ä¸Šä½å‹¢ã«é£Ÿã‚‰ã„ã¤ã‘ã‚‹ã‹ãŒæ­£å¿µå ´ã§ã‚ã‚‹ã€‚ã€‚",
        coach: { name: 'å¿—è³€ å‰›', style: 'è‚²æˆä¸Šæ‰‹', experience: 'æ–°ä»»' }
    },
    "æ¡é™½": {
        name_yomi: "ã¨ã†ã‚ˆã†",
        region: "æ±éƒ¨",
        type: "ç§ç«‹",
        deviation: 80,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        last: "åˆæˆ¦æ•—é€€",
        info: "å…ƒãƒ—ãƒ­ã®å…ƒæœ¨ç›£ç£ã‚’æ‹›è˜ã—ã€å¼·åŒ–ã«ä¹—ã‚Šå‡ºã—ãŸæ–°èˆˆç§ç«‹ã€‚ãƒ—ãƒ­æµã®å³ã—ã„ç·´ç¿’ã¯ãƒãƒ¼ãƒ å†…ã«è»‹è½¢ã‚‚ç”Ÿã‚“ã§ã„ã‚‹ãŒã€å€‹ã€…ã®èƒ½åŠ›ã¯é£›èºçš„ã«å‘ä¸Šã—ã¦ãŠã‚Šã€140kmä»¥ä¸Šã‚’è¨ˆæ¸¬ã™ã‚‹é¸æ‰‹ãŒ6äººã‚‚ã„ã‚‹ãªã©ã€ãã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã¯è¨ˆã‚ŠçŸ¥ã‚Œãªã„ã€‚ç›£ç£ã®æŒ‡å°æ–¹é‡ãŒãƒãƒ¼ãƒ ã¨ã—ã¦å®Œå…¨ã«å™›ã¿åˆã£ãŸæ™‚ã€ä¸€æ°—ã«å¤§ä¼šã®ä¸»å½¹ã¸èºã‚Šå‡ºã‚‹å¯èƒ½æ€§ã‚’ç§˜ã‚ã¦ã„ã‚‹ã€‚",
        coach: { name: 'å…ƒæœ¨ å¤§ä»‹', style: 'ç©æ¥µæ‰“æ’ƒ', experience: 'ãƒ—ãƒ­OB' }
    },
    "æµœæ¾å•†æ¥­": {
        name_yomi: "ã¯ã¾ã¾ã¤ã—ã‚‡ã†ãã‚‡ã†",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 32,
        best: "ç”²å­åœ’å„ªå‹",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "30å¹´å‰ã®ç”²å­åœ’å„ªå‹æ ¡ã¨ã—ã¦é‡çƒãƒ•ã‚¡ãƒ³ã®é–“ã§ã¯çŸ¥ååº¦ã®ã‚ã‚‹é«˜æ ¡ã€‚è¿‘å¹´ã¯ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã‚„æ–°èˆˆç§ç«‹ã®å°é ­ã«ã‚ˆã‚Šä½è¿·ã—ã¦ãŠã‚Šã€æ˜”ã®ã‚ˆã†ãªåœ§å€’çš„ãªå¼·ã•ã¯ãªã„ãŒã€ä»Šã‚‚ãªãŠä¸­å …ãƒ¬ãƒ™ãƒ«ã®å®ŸåŠ›æ ¡ã¨ã—ã¦è™è¦–çœˆã€…ã¨è–åœ°ã‚’ç‹™ã£ã¦ã„ã‚‹ã€‚è¼ã‹ã—ã„æ „å…‰ã‚’å–ã‚Šæˆ»ã™ã¹ãã€ä»Šå¤§ä¼šã§ã®èºé€²ã«æœŸå¾…ã—ãŸã„ã„ã€‚",
        coach: { name: 'ä¼Šæ­¦ é›…ä¹‹', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "åˆæ˜Ÿå­¦åœ’": {
        name_yomi: "ã¯ã¤ã¼ã—ãŒããˆã‚“",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 110,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "å…¨å›½ã§å”¯ä¸€ã‚¢ã‚¤ãƒ‰ãƒ«ç§‘ã‚’æŒã¤å­¦æ ¡ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã¦ã„ã‚‹å‰µç«‹3å¹´ç›®ã®ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ç³»åˆ—æ ¡ã€‚å…¨å›½ã‹ã‚‰ã‚¢ã‚¤ãƒ‰ãƒ«ç§‘ã‚’ç›®å½“ã¦ã«å—é¨“ã™ã‚‹äººã‚‚å¤šãã€å­¦æ ¡ã¨ã—ã¦ã®æ³¨ç›®åº¦ã‚‚é«˜ã„ã€‚ç”·å¥³æ¯”ã§ã¯å­¦æ ¡ã®ç‰¹è‰²ã‚‚ç›¸ã¾ã£ã¦é©šç•°ã®8å‰²ãŒå¥³å­ã§ã‚ã‚‹ã€‚å‰µéƒ¨3å¹´ç›®ã®é‡çƒéƒ¨ã¨ã—ã¦ã®è¨­å‚™ã¯ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ç³»åˆ—ã¨ã„ã†ã“ã¨ã‚‚ã‚ã‚Šæ•´ã£ã¦ãŠã‚Šã€ç›´è¿‘ã®ç·´ç¿’è©¦åˆã§ã¯ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³ã‚‚è¤‡æ•°é£›ã³å‡ºã™ãªã©ã€é¸æ‰‹ã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚‚ä½ãã¯ãªã„ã€‚ç·´ç¿’ã§ã¯ã‚¢ã‚¤ãƒ‰ãƒ«ç§‘ã®ç”Ÿå¾’ã¨ã®åˆåŒãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’çµ„ã‚€ã“ã¨ã‚‚ã‚ã‚Šã€é•ã†å­¦ç§‘ã§ã‚ã‚Œã©ã€ãŠäº’ã„ã‚¢ã‚¹ãƒªãƒ¼ãƒˆã®è¦–ç‚¹ã§ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’é€ã‚Šã‚ã†ãªã©å­¦æ ¡ã®ç‰¹è‰²ã‚’æ´»ã‹ã—ãŸç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚‚ã‚ã‚‹ã€‚é‡çƒéƒ¨ã§ç›®ç«‹ã£ãŸå®Ÿç¸¾ã¯ãªã„ãŒã€ã‚¢ã‚¤ãƒ‰ãƒ«ç§‘ã§ã¯ãªãã€Œé‡çƒã®åˆæ˜Ÿã€ã¨å‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«èºé€²ã—ã¦ã»ã—ã„",
        coach: { name: 'çŸ³å· å®Ÿ', style: 'è‚²æˆä¸Šæ‰‹', experience: 'ä¸­å …' }
    },
    "æµœæ¾ç‰¹æ”¯": {
        name_yomi: "ã¯ã¾ã¾ã¤ã¨ãã—",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 45,
        best: "ãªã—",
        last: "ãªã—",
        info: "å‰µéƒ¨ä¸€å¹´ç›®ã€å…¨å“¡1å¹´ç”Ÿã€‚çœŒå†…åˆã®è©¦ã¿ã¨ã—ã¦ã€ç‰¹åˆ¥æ”¯æ´å­¦æ ¡ã«è¨­ç«‹ã•ã‚ŒãŸé‡çƒéƒ¨ã€‚è¦–è¦šéšœå®³ã€è´è¦šéšœå®³ã€çŸ¥çš„éšœå®³ã€è‚¢ä½“ä¸è‡ªç”±ã€ç—…å¼±ãƒ»èº«ä½“è™šå¼±ã®å­ã©ã‚‚ã‚’å¯¾è±¡ã¨ã—ãŸç‰¹åˆ¥æ”¯æ´å­¦æ ¡ã¯ã€å…¨å›½ã«ãŠã‚ˆã1100æ ¡ã‚ã‚‹ã€‚ãã®ä¸­ã§é«˜é‡é€£ã«åŠ ç›Ÿã—ã€å˜ç‹¬ãƒãƒ¼ãƒ ã¨ã—ã¦å…¬å¼æˆ¦ã«å‡ºå ´ã—ã¦ã„ã‚‹ã®ã¯ã€ã“ã®æµœæ¾ç‰¹åˆ¥æ”¯æ´å­¦æ ¡ã ã‘ã ã€‚éƒ¨å“¡ãŸã¡ã¯ã€é‡çƒã®ãƒ«ãƒ¼ãƒ«ã‚’è¦šãˆã‚‹ã“ã¨ã‚„ã€ä»²é–“ã¨å£°ã‚’æ›ã‘åˆã†ã“ã¨ã€ãã®ä¸€ã¤ä¸€ã¤ãŒå¤§ããªæŒ‘æˆ¦ã ã€‚åŒ—æ‘ç›£ç£ã¯ã€é‡çƒã®æŠ€è¡“ä»¥å‰ã«ã€å½¼ã‚‰ãŒé‡çƒã¨ã„ã†ã‚¹ãƒãƒ¼ãƒ„ã‚’å¿ƒã‹ã‚‰æ¥½ã—ã¿ã€è‡ªåˆ†ã‚’è¡¨ç¾ã™ã‚‹å–œã³ã‚’çŸ¥ã£ã¦ã‚‚ã‚‰ã†ã«ã¯ã©ã†ã™ã‚Œã°è‰¯ã„ã®ã‹ã€ç­”ãˆã®ãªã„å•ã„ã«æ—¥ã€…å‘ãåˆã£ã¦ã„ã‚‹ã€‚ã—ã‹ã—ã€æ˜¥ã®ç·´ç¿’è©¦åˆã§ä»Šå¤§ä¼šç¬¬ä¸€ã‚·ãƒ¼ãƒ‰ã®283å­¦åœ’ã¨ã®æ‹›å¾…è©¦åˆã§å–«ã—ãŸã€52-0ã€ã®å¤§æ•—ã¯ã€å½¼ã‚‰ã‹ã‚‰é‡çƒã®æ¥½ã—ã•ã‚’æ ¹ã“ããå¥ªã„å»ã£ãŸã€‚éƒ¨å®¤ä»£ã‚ã‚Šã®ç†ç§‘æº–å‚™å®¤ã«ã¯ã€å½¼ã‚‰ã®é‡çƒãƒãƒ¼ãƒˆãŒç½®ã‹ã‚Œã¦ãŠã‚Šã€ä¸­ã‚’è¦‹ã‚‹ã¨ã€ŒãŸã®ã—ããªã„ã€ã€Œã“ã‚ã„ã€ã¨ã„ã£ãŸæ–‡é¢ãŒå¤šãè¦‹å—ã‘ã‚‰ã‚ŒãŸã€‚ã‚¨ãƒ©ãƒ¼ã‚’ã™ã‚Œã°ä¸‹ã‚’å‘ã„ã¦æ³£ãå‡ºã—ã€æ‰“å¸­ã§ã¯ãƒ‡ãƒƒãƒ‰ãƒœãƒ¼ãƒ«ã‚’æ€–ãŒã£ã¦è…°ãŒå¼•ã‘ã‚‹ã€‚ãã—ã¦ã€ãªã«ã‚ˆã‚ŠçŸ¥çš„éšœå®³ã‚’æŒã£ãŸå­ãŒç¡¬å¼é‡çƒã‚’è¡Œã†ã“ã¨ã«ã¤ã„ã¦ã®å®‰å…¨æ€§ã‚’å•ã‚ã‚Œã‚‹å£°ãŒå¤šã€…ã‚ã£ãŸã€‚åŒ—æ‘ç›£ç£ã¯å‹åˆ©ã§ã¯ãªãã€è©¦åˆã‚’æˆç«‹ã•ã›ã‚‹ã“ã¨ã€ã®çµ¶æœ›çš„ãªé›£ã—ã•ã«ç›´é¢ã—ã¦ã„ã‚‹ã€‚å¤ã®ç›®æ¨™ã¯9å›ã‚’æˆ¦ã„æŠœãã€ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã«ã€0ã€ä»¥å¤–ã®æ•°å­—ã‚’ç¯ã™ã“ã¨ã€‚ãã‚Œã¯ç”²å­åœ’å‡ºå ´ã‚ˆã‚Šã‚‚é¥ã‹ã«é«˜ãã€ãã—ã¦åˆ‡å®Ÿãªå£ã ã€‚",
        coach: { name: 'åŒ—æ‘ å¤§è¼”', style: 'å…¨å“¡é‡çƒ', experience: 'æ–°ä»»' }
    },
    "765ç·åˆé«˜æ ¡": {
        name_yomi: "ãªã‚€ã“ãã†ã”ã†",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 75,
        best: "ç”²å­åœ’ãƒ™ã‚¹ãƒˆ16",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "å¤§æ‰‹ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ãŒæ¯ä½“ã¨ãªã‚‹ã€çœŒå†…å±ˆæŒ‡ã®è³‡é‡‘åŠ›ã¨è¨­å‚™ã‚’èª‡ã‚‹ç§ç«‹æ ¡ã€‚é»’äº•ç›£ç£ã®å¾¹åº•ã—ãŸç®¡ç†é‡çƒã®ä¸‹ã€å€‹ã€…ã®èƒ½åŠ›ãŒé«˜ãã€å¤§å´©ã‚Œã—ãªã„å®‰å®šã—ãŸæˆ¦ã„ã¶ã‚ŠãŒç‰¹å¾´ã€‚ï¼’å¹´å‰ã«ã¯ç”²å­åœ’åˆå‡ºå ´ã‚‚æœãŸã—ã€ç ´ç«¹ã®å‹¢ã„ã§ãƒ™ã‚¹ãƒˆ16ã¾ã§å‹ã¡é€²ã¿ã€ä¸€èºæœ‰åæ ¡ã¨ãªã£ãŸã®ã¯è¨˜æ†¶ã«æ–°ã—ã„ã ã‚ã†ã€‚ã—ã‹ã—æ˜¨å¹´ã®å¤ã¯ï¼’å›æˆ¦æ•—é€€ã€ç§‹ã¯åˆæˆ¦æ•—é€€ã€æ˜¥ã‚‚åˆæˆ¦æ•—é€€ã¨è‹¦ã—ã„æ™‚æœŸãŒç¶šã„ã¦ã„ã‚‹ã€‚è–åœ°ã‚’çŸ¥ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã¯ä»Šã®3å¹´ç”Ÿã®ã¿ã¨ãªã£ãŸä»Šã€é€†è¥²ã‚’èª“ã„å†ã³ç”²å­åœ’ã‚’ç›®æŒ‡ã™ã€‚ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã§ã¯ã‚ã‚‹ãŒãã®å®ŸåŠ›ã¯ã‚·ãƒ¼ãƒ‰æ ¡ç´šã§ã‚ã‚Šä»Šå¤§ä¼šã®ãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ã¨è¨€ã£ã¦ã‚‚éè¨€ã§ã¯ãªã„ã ã‚ã†",
        popularity: true,
        coach: { name: 'é»’äº• å´‡ç”·', style: 'ç·åˆåŠ›', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "å·æ ¹": {
        name_yomi: "ã‹ã‚ã­",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 53,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "åˆæˆ¦æ•—é€€",
        info: "ä»Šå¹´åº¦é™ã‚Šã§ã®é–‰æ ¡ãŒæ±ºã¾ã£ã¦ãŠã‚Šã€é‡çƒéƒ¨ã«ã¨ã£ã¦ã¯ã“ã‚ŒãŒæœ€å¾Œã®å¤ã¨ãªã‚‹ã€‚ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰è„‡ã§ã¯æ ¡èˆã®è§£ä½“ä½œæ¥­ãŒé€²ã‚€ã¨ã„ã†ç•°ä¾‹ã®ç’°å¢ƒã ãŒã€é¸æ‰‹ãŸã¡ã¯å‹•æºã‚’è¦‹ã›ãšç·´ç¿’ã«æ‰“ã¡è¾¼ã‚€ã€‚ç›£ç£ãƒ»é¸æ‰‹ã¨ã‚‚ã«å¤§ä¼šçµ‚äº†å¾Œã¯ãã‚Œãã‚Œåˆ¥ã®é“ã‚’æ­©ã‚€ã“ã¨ã«ãªã‚‹ã€‚ã€Œæ¯æ ¡ã®åã‚’åˆ»ã¿ãŸã„ã€ã¨ã„ã†æƒ³ã„ã¯ä¸€ã¤ã€‚æœ‰çµ‚ã®ç¾ã‚’é£¾ã‚‹ã¹ãã€ãƒãƒ¼ãƒ ã®å£«æ°—ã¯éå¸¸ã«é«˜ã„ã€‚",
        coach: { name: 'éˆ´æœ¨ èª ', style: 'å …å®Ÿ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "283å­¦åœ’": {
        name_yomi: "ã¤ã°ã•ãŒããˆã‚“",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 60,
        best: "ç”²å­åœ’1å›æˆ¦",
        last: "çœŒå„ªå‹(ç”²å­åœ’åˆæˆ¦æ•—é€€)",
        info: "æ˜¨å¹´åº¦ã®çœŒå¤§ä¼šç‹è€…ã€‚ã‚¨ãƒ¼ã‚¹ç™½ç€¬ã€äºŒåˆ€æµã®å§«å·ã‚„åç‹ã€èŠ±æµ·å’²ãªã©ï¼‘å¹´æ¬¡ã‹ã‚‰ã®ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ãƒ¡ãƒ³ãƒãƒ¼ã‚’è»¸ã«æŠ•æ‰“ã®ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚ŒãŸå¼·è±ªæ ¡ã€‚ã€‚ã—ã‹ã—ã€åˆå‡ºå ´ã¨ãªã£ãŸæ˜¨å¹´ã®å¤ã®ç”²å­åœ’ã§ã¯åˆæˆ¦ã®æµ¦å’Œå­¦é™¢æˆ¦ã«7-9ã§æ•—æˆ¦ã—æ¶™ã‚’é£²ã¿ã€å…¨å›½ã®å£ã‚’ç—›æ„Ÿã—ãŸã€‚æ–°ãƒãƒ¼ãƒ ã«ãªã£ã¦ã‹ã‚‰ã¯æ¨‹å£ã‚„èŠ±æµ·ä½‘ãªã©ã®æ–°æˆ¦åŠ›ã‚‚å°é ­ã—ã€æ˜¥ã®å¤§ä¼šã§ã¯åœ§å€’çš„ãªæˆ¦ã„ã§å„ªå‹ã—ã€ç¬¬ï¼‘ã‚·ãƒ¼ãƒ‰ã«å›è‡¨ã€‚åå°†ãƒ»å¤©äº•ç›£ç£ã¯ã€æ˜¨å¹´ã®çµŒé¨“ã‚’ç³§ã«ã€çœŒå†…é€£è¦‡ã¨ãã®å…ˆã®ã€Œå…¨å›½ã§ã®ä¸€å‹ã€ã‚’è¦‹æ®ãˆã‚‹ã€‚ç‹è€…ã¨ã—ã¦ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‚’ã¯ã­ã®ã‘ã€å†ã³é ‚ç‚¹ã«ç«‹ã¦ã‚‹ã‹æ³¨ç›®ãŒé›†ã¾ã‚‹ã€‚",
        popularity: true,
        coach: { name: 'å¤©äº• åŠª', style: 'IDé‡çƒ', experience: 'åå°†' }
    },
    "å³¶ç”°å·¥æ¥­": {
        name_yomi: "ã—ã¾ã ã“ã†ãã‚‡ã†",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 41,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "çœŒå†…ã§ã‚‚æœ‰æ•°ã®å·¥æ¥­é«˜æ ¡ã§ã€éƒ¨å“¡ã®å¤šããŒæŠ€è¡“è·ã‚’ç›®æŒ‡ã—ã¦ã„ã‚‹ã€‚å®Ÿç¿’ãªã©ã§ç·´ç¿’æ™‚é–“ãŒé™ã‚‰ã‚Œã‚‹ãƒãƒ³ãƒ‡ã‚’ã€ç”°ä¸­ç›£ç£ãŒå©ãè¾¼ã‚€ã€Œæ ¹æ€§é‡çƒã€ã§ã‚«ãƒãƒ¼ã€‚æœ€å¾Œã¾ã§è«¦ã‚ãªã„ç²˜ã‚Šå¼·ã•ãŒãƒãƒ¼ãƒ ã®æŒã¡å‘³ã€‚ã‚¹ã‚¿ãƒ¼é¸æ‰‹ã¯ä¸åœ¨ã ãŒã€ä¸€ä¸¸ã¨ãªã£ãŸæ™‚ã®çµæŸåŠ›ã¯é«˜ãã€å¼·è±ªæ ¡ã«ã¨ã£ã¦ã¯ã‚„ã‚Šã«ãã„ç›¸æ‰‹ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹ã€‚ã€‚",
        coach: { name: 'ç”°ä¸­ é‰„å¹³', style: 'æ ¹æ€§é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "ç£ç”°å—": {
        name_yomi: "ã„ã‚ãŸã¿ãªã¿",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 63,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "åˆæˆ¦æ•—é€€",
        info: "å…¨å›½ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã®é€²å­¦æ ¡ã€‚é‡çƒã¯ã€Œæ–‡æ­¦ä¸¡é“ã€ã‚’æ²ã’ã‚‹èª²å¤–æ´»å‹•ã®ä¸€ç’°ã ãŒã€ãã®å®ŸåŠ›ã¯ä¾®ã‚Œãªã„ã€‚é¸æ‰‹å€‹ã€…ã®é‡çƒIQãŒé«˜ãã€ãƒ‡ãƒ¼ã‚¿ã‚’é§†ä½¿ã—ãŸç·»å¯†ãªæˆ¦è¡“ã‚’å¾—æ„ã¨ã™ã‚‹ã€‚çŸ¥æ€§æ´¾é›†å›£ãŒã€å¤ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã«æ—‹é¢¨ã‚’å·»ãèµ·ã“ã™ã€‚ä½™è«‡ã ãŒã€å…¨å›½åˆ¶è¦‡ã®çµŒé¨“ã‚’æŒã¤ã‚µãƒƒã‚«ãƒ¼éƒ¨ãŒå¿œæ´ã«é§†ã‘ã¤ã‘ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã€ãã®ç‹¬ç‰¹ã®å¿œæ´ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚åç‰©ã¨ãªã£ã¦ã„ã‚‹ã€‚ã¡ãªã¿ã«ã‚µãƒƒã‚«ãƒ¼å½¢å¼ã®é‡çƒå¿œæ´ãŒçã—ã„ã¨ã„ã†ã“ã¨ã§ã€ã“ã‚Œã‚’ç›®å½“ã¦ã«è©¦åˆã«è¦‹ã«æ¥ã‚‹ã¨ã„ã†éš ã‚Œãƒ•ã‚¡ãƒ³ã‚‚å¤šã„ã€‚",
        coach: { name: 'ä¸­ç”° è­²äºŒ', style: 'å®ˆå‚™é‡è¦–', experience: 'ä¸­å …' }
    },
    "ä¸‰å³¶åŒ—": {
        name_yomi: "ã¿ã—ã¾ããŸ",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 20,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        info: "2å¹´ç”Ÿã‚¨ãƒ¼ã‚¹å·¦è…•ãƒ»æ¦›åã‚’æ“ã™ã‚‹å…¬ç«‹ã®å®ŸåŠ›æ ¡ã€‚max148ã‚­ãƒ­ã®çƒé€Ÿã‚’æŒã¤æ¦›åã®æŠ•çƒãŒè©¦åˆã®éµã‚’æ¡ã‚‹ãŒã€æ‰“ç·šãŒã‚¨ãƒ¼ã‚¹ã‚’æ´è­·ã§ãã‚‹ã‹ãŒé•·å¹´ã®èª²é¡Œã€‚çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ã®å­˜åœ¨ã«é ¼ã‚‹ã ã‘ã§ãªãã€ãƒãƒ¼ãƒ å…¨ä½“ã§å¾—ç‚¹ã‚’å¥ªã†ç·åˆåŠ›ãŒè©¦ã•ã‚Œã‚‹ã€‚å®‰å®šã—ã¦ä¸Šä½ã«é€²å‡ºã™ã‚‹åŠ›ã¯ååˆ†ã«æŒã£ã¦ã„ã‚‹ã€‚",
        coach: { name: 'å¤§å· é€', style: 'æŠ•æ‰‹ä¸­å¿ƒ', experience: 'ä¸­å …' }
    },
    "é™å²¡": {
        name_yomi: "ã—ãšãŠã‹",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 105,
        best: "ç”²å­åœ’3å›æˆ¦",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4",
        info: "å‰µç«‹93å¹´ã€ç”²å­åœ’å‡ºå ´13å›ã€‚ãã—ã¦ã‚¹ãƒãƒ¼ãƒ„ã«åŠ›ã‚’å…¥ã‚ŒãªãŒã‚‰ã‚‚å‹‰å­¦ã§ã‚‚å„ªç§€ã€‚ãã®è¼ã‹ã—ã„æ­´å²ã€å®Ÿç¸¾ã¯åœ°å…ƒæ°‘ã®ã¿ãªã‚‰ãšçœŒæ°‘ã®èª‡ã‚Šã€ã¾ãŸæ†§ã‚Œã§ã‚‚ã‚ã‚Šã€è€è‹¥ç”·å¥³å•ã‚ãšåœ°å…ƒæ°‘ã«æ„›ã•ã‚Œã‚‹ä¼çµ±æ ¡ã§ã‚ã‚‹ã€‚è¿‘å¹´ã¯ä»–æ ¡ã®ç§ç«‹ã‚„ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã¨ã®é¸æ‰‹ç²å¾—ç«¶äº‰ã«ä¸€ã¤é…ã‚Œã‚’ã¨ã£ã¦ãŠã‚Šã€ç”²å­åœ’ã‹ã‚‰ã¯é ã–ã‹ã£ã¦ã„ã‚‹ãŒã€æ­´å²ã¯åšãã€ç§ç«‹ä¸¦ã¿ã®è¨­å‚™ã¨OBã‹ã‚‰ã®åšã„æ”¯æ´ã€ãã—ã¦ã€ãªã«ã‚ˆã‚Šã‚‚ä»£çŸ¢æ±ã®è©¦åˆãŒã‚ã‚‹éš›ã«ã¯çƒå ´ã«å¤šãã®OBãŒé§†ã‘ä»˜ã‘ã€å¤§å¿œæ´å›£ã‚’çµæˆã—ã€ç›¸æ‰‹ã‚’åœ§å€’ã™ã‚‹ã€‚è¿‘å¹´ã¯ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ãŒçœŒå†…ã‚’ç‰›è€³ã‚Šã‹ã‘ã¦ã„ã‚‹ãŸã‚ã€å…¬ç«‹ã®å¸Œæœ›ã®æ˜Ÿã¨ã—ã¦ãƒ¡ãƒ‡ã‚£ã‚¢ã«å–ã‚Šä¸Šã’ã‚‰ã‚Œã‚‹ã“ã¨ã‚‚å¤šã„ã€‚çœŒå†…ã‚’å¸­å·»ã™ã‚‹ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã¸ã®ã€å…¬ç«‹æœ€å¾Œã®ç ¦ã€ã¨ã—ã¦ã€ãã®å­˜åœ¨ã¯è±¡å¾´çš„ãªæ„å‘³ã‚’æŒã¡å§‹ã‚ãŸã€‚åå°†ãƒ»é«˜å³¶ã¯ä¼çµ±ã¨ç¾ä»£é‡çƒã®èåˆã«è…å¿ƒã™ã‚‹ã€‚ã“ã‚Œã¯å˜ãªã‚‹é«˜æ ¡é‡çƒã§ã¯ãªã„ã€‚åœ°åŸŸã®èª‡ã‚Šã¨æœªæ¥ã‚’ã‹ã‘ãŸä»£ç†æˆ¦äº‰ãªã®ã ã€‚",
        popularity: true,
        coach: { name: 'é«˜å³¶ ç¤¼', style: 'ä¼çµ±é‡çƒ', experience: 'åå°†' }
    },
    "é£›é¾": {
        name_yomi: "ã²ã‚Šã‚…ã†",
        region: "æ±éƒ¨",
        type: "ç§ç«‹",
        deviation: 99,
        best: "ç”²å­åœ’2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "ã‹ã¤ã¦ã¯ç”²å­åœ’å‡ºå ´çµŒé¨“ã‚‚ã‚ã‚‹ç§ç«‹æ ¡ã ãŒã€æ•°å¹´å‰ã«èµ·ããŸä¸ç¥¥äº‹ã®å½±éŸ¿ã§ãƒãƒ¼ãƒ ã¯ä½è¿·ã€‚ç¾åœ¨ã¯è‹¥ãæ—ç”°ç›£ç£ã¨å…±ã«ã€å¤±ã‚ã‚ŒãŸä¿¡é ¼ã‚’å–ã‚Šæˆ»ã™ã¹ãå†å»ºã®é“ã‚’æ­©ã‚“ã§ã„ã‚‹ã€‚åœ°åŸŸã¸ã®æ¸…æƒæ´»å‹•ãªã©ã‚’é€šã˜ã¦åœ°é“ãªåŠªåŠ›ã‚’ç¶šã‘ã¦ãŠã‚Šã€ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®çµæœã§å®Œå…¨å¾©æ´»ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã—ãŸã„ã¨ã“ã‚ã ã€‚ã€‚",
        coach: { name: 'æ—ç”° å¥å¤ªéƒ', style: 'æ©Ÿå‹•åŠ›é‡çƒ', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼": {
        name_yomi: "ã›ã„ã‚Œã„ãã‚Šã™ã¨ãµããƒ¼",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 94,
        best: "ç”²å­åœ’2å›æˆ¦",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        info: "æ¯å¹´å„ªå‹å€™è£œã«æŒ™ã’ã‚‰ã‚Œã‚‹è¥¿éƒ¨åœ°åŒºã®é›„ã€‚åå°†ãƒ»ç‰‡å²¡ç›£ç£ãŒç¯‰ãä¸Šã’ãŸæŠ•æ‰‹ã‚’ä¸­å¿ƒã¨ã—ãŸå …å®ˆã¯å…¨å›½ãƒ¬ãƒ™ãƒ«ã¨è©•ã•ã‚Œã‚‹ã€‚ã—ã‹ã—ã€ãã®å …å®Ÿã•ã‚†ãˆã«æ‰“ç·šãŒæ¹¿ã‚ŠãŒã¡ã§ã€ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆçµ‚ç›¤ã§æ¶™ã‚’é£²ã‚€å±•é–‹ãŒç¶šãã€‚ã‚¿ãƒ¬ãƒ³ãƒˆã¯æƒã£ã¦ãŠã‚Šã€æ‚²é¡˜ã®ç”²å­åœ’å‡ºå ´ã«å‘ã‘ã¦ã€ä¼çµ±ã®å®ˆå‚™åŠ›ã«åŠ ãˆã¦å¾—ç‚¹åŠ›ã‚’ã©ã†å‘ä¸Šã•ã›ã‚‹ã‹ã€‚é•·å¹´ã®èª²é¡Œã§ã‚ã‚‹ã€Œãƒ™ã‚¹ãƒˆ8ã®å£ã€ã‚’è¶Šãˆã‚‰ã‚Œã‚‹ã‹ãŒä»Šå¤§ä¼šã®ç„¦ç‚¹ã¨ãªã‚‹ã€‚",
        popularity: true,
        coach: { name: 'ç‰‡å²¡ é‰„å¿ƒ', style: 'å®ˆå‚™é‡è¦–', experience: 'åå°†' }
    },
    "è£¾é‡": {
        name_yomi: "ã™ãã®",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 48,
        best: "ãªã—",
        last: "ãªã—",
        info: "ã‚¨ãƒ¼ã‚¹ã®èŒ‚é‡ãŒä¸­å¿ƒã¨ãªã£ã¦å‰µéƒ¨ã•ã‚ŒãŸæ–°ã—ã„ãƒãƒ¼ãƒ ã€‚éƒ¨å“¡ã®ã»ã¨ã‚“ã©ãŒé«˜æ ¡ã‹ã‚‰é‡çƒã‚’å§‹ã‚ãŸåˆå¿ƒè€…ã§ã‚ã‚Šã€æˆ¦åŠ›ã¨ã—ã¦ã¯æœªçŸ¥æ•°ã€‚èŒ‚é‡ã®åœ§å€’çš„ãªå€‹äººæŠ€ã§ã©ã“ã¾ã§å‹ã¡ä¸ŠãŒã‚Œã‚‹ã‹ãŒæ³¨ç›®ã•ã‚Œã‚‹ã€‚ãƒãƒ¼ãƒ ã¨ã—ã¦ã®ä¸€ä½“æ„ŸãŒç”Ÿã¾ã‚Œã‚Œã°ã€é¢ç™½ã„å­˜åœ¨ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚",
        coach: { name: 'èŒ‚é‡ å¾éƒ', style: 'è¶…æ”»æ’ƒå‹', experience: 'æ–°ä»»' }
    },
    "å¯Œå£«å®®åŒ—": {
        name_yomi: "ãµã˜ã®ã¿ã‚„ããŸ",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 51,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "åˆæˆ¦æ•—é€€",
        info: "ãƒ—ãƒ­æ³¨ç›®ã®max158kmã®æœ¬æ ¼æ´¾å³è…•ãƒ»æ–è—¤ã‚’æ“ã™ã‚‹å…¬ç«‹æ ¡ã€‚å½¼ã®å­˜åœ¨ã«ã‚ˆã‚Šã€ä¾‹å¹´ä»¥ä¸Šã®æ³¨ç›®ã‚’é›†ã‚ã¦ã„ã‚‹ã€‚ä½ã€…æœ¨ç›£ç£ã¯ã‚¨ãƒ¼ã‚¹ã¸ã®è² æ‹…ã‚’è€ƒæ…®ã—ã¤ã¤ã€ãƒãƒ¼ãƒ å…¨ä½“ã®åº•ä¸Šã’ã‚’å›³ã‚‹ã€‚æ–è—¤ã®å¿«æŠ•ã¯ã‚‚ã¡ã‚ã‚“ã€å½¼ã‚’æ”¯ãˆã‚‹é‡æ‰‹é™£ã®å¥®èµ·ãŒã€ä¸Šä½é€²å‡ºã¸ã®éµã¨ãªã‚‹ã€‚",
        coach: { name: 'ä½ã€…æœ¨ æœ—', style: 'æŠ•æ‰‹ä¸­å¿ƒ', experience: 'ä¸­å …' }
    },
    "ç¾åŸå­¦åœ’": {
        name_yomi: "ã¿ã—ã‚ãŒããˆã‚“",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 81,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ç³»åˆ—æ ¡ã®è‰åˆ†ã‘çš„å­˜åœ¨ã€‚ã‹ã¤ã¦ã¯ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸­å¿ƒã ã£ãŸãŒã€è¿‘å¹´ã¯åŒã˜ç³»åˆ—ã®765ç·åˆã‚„283å­¦åœ’ã«æœ‰åŠ›é¸æ‰‹ãŒé›†ã¾ã‚Šã€è‹¦æˆ¦ã‚’å¼·ã„ã‚‰ã‚Œã¦ã„ã‚‹ã€‚ä¸‰åŸç›£ç£ã®ä¸‹ã€ãƒ—ãƒ©ã‚¤ãƒ‰ã‚’ã‹ã‘ãŸæˆ¦ã„ã§å¤è±ªã®æ„åœ°ã‚’è¦‹ã›ã€ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§ã®åºåˆ—ã‚’è¦†ã—ãŸã„ã¨ã“ã‚ã ã€‚",
        coach: { name: 'ä¸‰åŸ å¸¸å‹™', style: 'ã‚¨ãƒªãƒ¼ãƒˆé‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æ²¼æ´¥é«˜å°‚": {
        name_yomi: "ã¬ã¾ã¥ã“ã†ã›ã‚“",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 18,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "å…¨å›½ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã®åå·®å€¤ã‚’èª‡ã‚‹è¶…é€²å­¦æ ¡ã€‚ç›¸æ‰‹ãƒãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾¹åº•çš„ã«åˆ†æã—ã€ç¢ºç‡ã«åŸºã¥ã„ãŸæˆ¦è¡“ã‚’çµ„ã¿ç«‹ã¦ã‚‹ã€Œã‚·ãƒ³ã‚­ãƒ³ã‚°ãƒ»ãƒ™ãƒ¼ã‚¹ãƒœãƒ¼ãƒ«ã€ãŒæŒã¡å‘³ã€‚èº«ä½“èƒ½åŠ›ã§ã¯ä»–æ ¡ã«åŠ£ã‚‹éƒ¨åˆ†ã‚‚ã‚ã‚‹ãŒã€ãã®çŸ¥æ€§ã§è£œã£ã¦ä½™ã‚Šã‚ã‚‹ã€‚ã‚»ã‚ªãƒªãƒ¼ã®ç©´ã‚’çªãæˆ¦ã„æ–¹ã¯ã€ã©ã‚“ãªå¼·è±ªã«ã¨ã£ã¦ã‚‚è„…å¨ã¨ãªã‚‹ã€‚ã€‚",
        coach: { name: 'äº¬å¤§ ä¸€éƒ', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'ä¸­å …' }
    },
    "ä¸‰å³¶å—": {
        name_yomi: "ã¿ã—ã¾ã¿ãªã¿",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 42,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æ•°å¹´å‰ã«21ä¸–ç´€æ ã¨ã—ã¦ç”²å­åœ’ã«å‡ºå ´ã—ãŸçµŒé¨“ã‚’æŒã¤ã€‚æ•°å¹´å‰ã»ã©ã®åŠ›ã¯ãªã„ãŒã€ä»Šå¹´ã®ãƒãƒ¼ãƒ ã¯å…¨å“¡é‡çƒã§ç›¸æ‰‹ã«æŒ‘ã¿ã€å®ˆå‚™ã§ãƒªã‚ºãƒ ã‚’ä½œã‚ŠãªãŒã‚‰ã€ã¤ãªããƒãƒƒãƒ†ã‚£ãƒ³ã‚°ã§å¾—ç‚¹ã™ã‚‹é‡çƒãŒç‰¹é•·ã€‚ã‚¨ãƒ¼ã‚¹ã®å‰ç”°ã¨ä¸»ç ²ã®æ‰“å·ã‚’ä¸­å¿ƒã«ã€æ³¥è‡­ã„é‡çƒã§ã“ã®å¤ã¯ä¸‹å…‹ä¸Šã§ç”²å­åœ’ã¾ã§å‹ã¡ä¸ŠãŒã‚‹ã€‚",
        popularity: true,
        coach: { name: 'å‰ç”° è¼å¤«', style: 'å…¨å“¡é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "å¾¡æ®¿å ´å—": {
        name_yomi: "ã”ã¦ã‚“ã°ã¿ãªã¿",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 34,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "50å¹´ã¶ã‚Šã¨ãªã‚‹ãƒ™ã‚¹ãƒˆ16ã«é€²å‡ºã—ãŸæ˜¨å¹´ã®èºé€²ã§ã€åœ°å…ƒã‚’å¤§ã„ã«æ²¸ã‹ã›ãŸå…¬ç«‹æ ¡ã€‚ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’å¾—æ„ã¨ã™ã‚‹å±±å†…ç›£ç£ã®æŒ‡å°ã®ä¸‹ã€æ´¾æ‰‹ã•ã¯ãªã„ãŒå …å®Ÿãªé‡çƒã§å‹ã¡ä¸ŠãŒã£ãŸã€‚å‘¨å›²ã®ã€Œã¾ãã‚Œã€ã¨ã„ã†å£°ã‚’è¦†ã—ã€è‡ªåˆ†ãŸã¡ã®å®ŸåŠ›ãŒæœ¬ç‰©ã§ã‚ã‚‹ã“ã¨ã‚’è¨¼æ˜ã—ãŸã„ä»Šå¤§ä¼šã¯ã€çœŸä¾¡ã‚’å•ã‚ã‚Œã‚‹é‡è¦ãªå¤ã¨ãªã‚‹ã€‚ã€‚",
        coach: { name: 'å±±å†… æµ©å¸', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "æ›å·è¥¿": {
        name_yomi: "ã‹ã‘ãŒã‚ã«ã—",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 91,
        best: "ç”²å­åœ’2å›æˆ¦",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4",
        info: "é™å²¡é«˜æ ¡ã¨ä¸¦ã¶ã‚¹ãƒãƒ¼ãƒ„ãŒç››ã‚“ãªçœŒå†…äºŒå¤§å…¬ç«‹æ ¡ã€‚ã‚µãƒƒã‚«ãƒ¼éƒ¨ãªã©ãŒå…¨å›½çš„ã«æœ‰åãªã‚¹ãƒãƒ¼ãƒ„å¼·è±ªæ ¡ã§ã‚ã‚Šã€é‡çƒéƒ¨ã‚‚æ¯å¹´å®‰å®šã—ã¦ä¸Šä½ã«é€²å‡ºã™ã‚‹å®ŸåŠ›ã‚’æŒã¤ãŒã€ã‚ã¨ä¸€æ­©ã§ç”²å­åœ’ã«å±Šã‹ãªã„ã‚·ãƒ¼ã‚ºãƒ³ãŒç¶šãã€‚åå°†ãƒ»å††å ‚ç›£ç£ãŒæ²ã’ã‚‹ã€å¸¸è­˜ã«ã¨ã‚‰ã‚ã‚Œãªã„å¤§èƒ†ãªé‡‡é…ã¯ã€å¤šãã®ãƒ•ã‚¡ãƒ³ã‚’é­…äº†ã—ã¦ã„ã‚‹ã€‚ä»Šå¹´ã“ãä»–ç«¶æŠ€ã®è¼ã‹ã—ã„å®Ÿç¸¾ã«è¿½ã„ã¤ããŸã„ã€‚ã€‚",
        coach: { name: 'å††å ‚ å®ˆ', style: 'è¶…æ¬¡å…ƒé‡çƒ', experience: 'åå°†' }
    },
    "æµœæ¾å¸‚ç«‹": {
        name_yomi: "ã¯ã¾ã¾ã¤ã„ã¡ã‚Šã¤",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 55,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æ¯å¹´å®‰å®šã—ãŸåŠ›ã‚’æŒã¤ä¸­å …å…¬ç«‹æ ¡ã ãŒã€ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆä¸­ç›¤ã§å¼·è±ªæ ¡ã¨å½“ãŸã‚Šæ•—é€€ã™ã‚‹ã“ã¨ãŒå¤šãã€ã€Œå£ã€ã‚’è¶Šãˆã‚‰ã‚Œãšã«ã„ã‚‹ã€‚ã“ã®çŠ¶æ³ã‚’æ‰“ç ´ã™ã¹ãã€ãƒ™ãƒ†ãƒ©ãƒ³ã®å±±å£ç›£ç£ã¯ä»Šå¹´ã¯æ©Ÿå‹•åŠ›é‡çƒã«ç‰¹åŒ–ã€‚å¡ã«å‡ºã‚Œã°ç©æ¥µçš„ã«æ¬¡ã®å¡ã‚’ç‹™ã†ã€ã—ã¤ã“ã„é‡çƒã§ç•ªç‹‚ã‚ã›ã‚’ç‹™ã†ã€‚ã€‚",
        coach: { name: 'å±±å£ ä¸€', style: 'æ©Ÿå‹•åŠ›é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æµœæ¾å­¦é™¢": {
        name_yomi: "ã¯ã¾ã¾ã¤ãŒãã„ã‚“",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 52,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "ä½“è‚²ç§‘ã®ã¿ã§æ§‹æˆã•ã‚Œã‚‹é€šä¿¡åˆ¶ã®ç§ç«‹æ ¡ã€‚å…¨å›½ã‹ã‚‰é¸æ‰‹ãŒé›†ã¾ã‚Šã€å¯®ç”Ÿæ´»ã‚’é€ã‚ŠãªãŒã‚‰é‡çƒã«æ‰“ã¡è¾¼ã‚“ã§ã„ã‚‹ã€‚ã‚µãƒƒã‚«ãƒ¼ç•Œã§å®Ÿç¸¾ã®ã‚ã‚‹å²¡ç”°ç›£ç£ãŒã€ç«¶æŠ€ã®å£æ ¹ã‚’è¶Šãˆã¦æŒ‡å°ã«ã‚ãŸã£ã¦ãŠã‚Šã€ãã®è‚²æˆæ‰‹è…•ã«æ³¨ç›®ãŒé›†ã¾ã‚‹ã€‚ç‹¬ç‰¹ã®ç’°å¢ƒã§è‚²ã£ãŸé¸æ‰‹ãŸã¡ãŒã€ãƒãƒ¼ãƒ ã¨ã—ã¦ã©ã†æ©Ÿèƒ½ã™ã‚‹ã‹ãŒéµã€‚",
        coach: { name: 'å²¡ç”° æ­¦å²', style: 'è‚²æˆä¸Šæ‰‹', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "ç„¼æ´¥æ°´ç”£": {
        name_yomi: "ã‚„ã„ã¥ã™ã„ã•ã‚“",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 44,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æ¸¯ç”ºã«æ ¹ã–ã—ãŸæ°´ç”£é«˜æ ¡ã§ã€ã‚¹ã‚¿ãƒ³ãƒ‰ã«ç¿»ã‚‹å¤§æ¼æ——ãŒãƒãƒ¼ãƒ ã®ã‚·ãƒ³ãƒœãƒ«ã€‚ä¸€æ˜¨å¹´ã®ãƒ™ã‚¹ãƒˆ16é€²å‡ºã¨ã„ã†å®Ÿç¸¾ã‚‚ã‚ã‚Šã€åœ°å…ƒã®æœŸå¾…ã¯å¤§ãã„ã€‚æµœç”°ç›£ç£ãŒç‡ã„ã‚‹ãƒãƒ¼ãƒ ã¯ã€ãƒãƒ£ãƒ³ã‚¹ã§ã®é›†ä¸­æ‰“ã‚’å¾—æ„ã¨ã™ã‚‹æ”»æ’ƒçš„ãªé‡çƒãŒæŒã¡å‘³ã€‚æ˜¨å¹´ã®ä¸æŒ¯ã‚’ä¹—ã‚Šè¶Šãˆã€å†ã³ã€Œå¤§æ¼ã€ã‚’ç‹™ã†ã€‚",
        coach: { name: 'æµœç”° å¤§å‰', style: 'ç©æ¥µæ‰“æ’ƒ', experience: 'ä¸­å …' }
    },
    "è¢‹äº•": {
        name_yomi: "ãµãã‚ã„",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 59,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        last: "åˆæˆ¦æ•—é€€",
        info: "çœŒå†…æœ‰æ•°ã®ãƒãƒ³ãƒ¢ã‚¹æ ¡ã§ã€æ¯å¹´ä¸€å®šæ•°ã®æœ‰æœ›ãªæ–°å…¥ç”ŸãŒå…¥éƒ¨ã™ã‚‹ã€‚çªå‡ºã—ãŸã‚¹ã‚¿ãƒ¼é¸æ‰‹ã¯ã„ãªã„ã‚‚ã®ã®ã€å…¨éƒ¨å“¡ã®ãƒ¬ãƒ™ãƒ«ãŒé«˜ãã€ç·åˆåŠ›ã§å‹è² ã™ã‚‹ãƒãƒ¼ãƒ ã€‚ãƒ™ãƒ†ãƒ©ãƒ³åƒè‘‰ç›£ç£ã®ä¸‹ã€é¸æ‰‹å±¤ã®åšã•ã‚’æ´»ã‹ã—ãŸå¤šå½©ãªæˆ¦è¡“ãŒå¼·ã¿ã€‚æ˜¨å¹´ã®åˆæˆ¦æ•—é€€ã®é›ªè¾±ã‚’èª“ã†ã€‚ã€‚",
        coach: { name: 'åƒè‘‰ ç¹', style: 'ç·åˆåŠ›', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æµœæ¾åŸåŒ—å·¥æ¥­": {
        name_yomi: "ã¯ã¾ã¾ã¤ã˜ã‚‡ã†ã»ãã“ã†ãã‚‡ã†",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 66,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4",
        last: "åˆæˆ¦æ•—é€€",
        info: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4ã®çµŒé¨“ã‚‚ã‚ã‚‹å…¬ç«‹æ ¡ã€‚å…ƒãƒ—ãƒ­ã®é‡‘æœ¬ç›£ç£ãŒæ³¨å…¥ã™ã‚‹ã€ç©æ¥µæœæ•¢ãªãƒ•ãƒ«ã‚¹ã‚¤ãƒ³ã‚°é‡çƒãŒãƒãƒ¼ãƒ ã®ä»£åè©ã€‚ãã®æ”»æ’ƒçš„ãªã‚¹ã‚¿ã‚¤ãƒ«ã¯ã€æ™‚ã«ãƒ©ãƒ•ãƒ—ãƒ¬ãƒ¼ã¨æ‰¹åˆ¤ã•ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚‹ãŒã€å‹åˆ©ã¸ã®åŸ·å¿µã¯ã©ã®ãƒãƒ¼ãƒ ã‚ˆã‚Šã‚‚å¼·ã„ã€‚æ˜¨å¹´ã®åˆæˆ¦æ•—é€€ã‹ã‚‰é€™ã„ä¸ŠãŒã‚Šã€å†ã³é ‚ç‚¹ã‚’ç›®æŒ‡ã™ã€‚ã€‚",
        coach: { name: 'é‡‘æœ¬ çŸ¥æ†²', style: 'ç©æ¥µæ‰“æ’ƒ', experience: 'ãƒ—ãƒ­OB' }
    },
    "ç£ç”°æ±": {
        name_yomi: "ã„ã‚ãŸã²ãŒã—",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 90,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "è½Ÿç›£ç£ã®ã€Œæ‰“æ’ƒã“ãæ­£ç¾©ã€ã¨ã„ã†å“²å­¦ã«åŸºã¥ãã€ç·´ç¿’ã®å¤§éƒ¨åˆ†ã‚’æ‰“æ’ƒç·´ç¿’ã«è²»ã‚„ã™è¶…æ”»æ’ƒå‹ãƒãƒ¼ãƒ ã€‚ãã®ç ´å£ŠåŠ›ã¯çœŒå†…ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã§ã€å¤§é‡å¾—ç‚¹ã§è©¦åˆã‚’ã²ã£ãã‚Šè¿”ã™åŠ›ã‚’æŒã¤ã€‚ä¸€æ–¹ã§ã€å®ˆå‚™åŠ›ã«èª²é¡Œã‚’æ®‹ã—ã¦ãŠã‚Šã€è©¦åˆå±•é–‹ãŒéå¸¸ã«ä¸å®‰å®šãªã®ãŒç‰¹å¾´ã€‚è¦³å®¢ã‚’é­…äº†ã™ã‚‹ã€ã‚¹ãƒªãƒªãƒ³ã‚°ãªè©¦åˆé‹ã³ã§å‹ã¡ä¸ŠãŒã‚Šã‚’ç‹™ã†ã€‚ã€‚",
        coach: { name: 'è½Ÿ é›·è”µ', style: 'æ‰“æ’ƒåé‡', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "é™å²¡å•†æ¥­": {
        name_yomi: "ã—ãšãŠã‹ã—ã‚‡ã†ãã‚‡ã†",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 57,
        best: "ç”²å­åœ’å„ªå‹",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        info: "ç”²å­åœ’å„ªå‹çµŒé¨“ã‚‚ã‚ã‚‹ä¼çµ±æ ¡ã§ã€æ¯å¹´å„ªå‹å€™è£œã®ç­†é ­ã«æŒ™ã’ã‚‰ã‚Œã‚‹ã€‚ã‚¨ãƒ¼ã‚¹æˆå®®ã‚’ç­†é ­ã¨ã™ã‚‹æŠ•æ‰‹åŠ›ã¯å…¨å›½å±ˆæŒ‡ã®ãƒ¬ãƒ™ãƒ«ã‚’èª‡ã‚‹ã€‚æ˜¨å¹´ã®å¤§ä¼šã§ã¯æº–ã€…æ±ºå‹ã§æ•—é€€ã—ã¦ãŠã‚Šã€ä»Šå¹´ã¯ç‹åº§å¥ªé‚„ã‚’ç›®æŒ‡ã™ã€‚åå°†ãƒ»å›½å‹ç›£ç£ã®ä¸‹ã€æŠ•æ‰“ã«éš™ãŒãªãã€ç·åˆåŠ›ã¯çœŒå†…ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã€‚ã€‚",
        popularity: true,
        coach: { name: 'å›½å‹ åºƒé‡', style: 'ç·åˆåŠ›', experience: 'åå°†' }
    },
    "å¾¡æ®¿å ´è¥¿": {
        name_yomi: "ã”ã¦ã‚“ã°ã«ã—",
        region: "æ±éƒ¨",
        type: "ç§ç«‹",
        deviation: 96,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆä¸­ç›¤ã®å¤§ããªå£ã¨ã—ã¦ã€æ¯å¹´å®‰å®šã—ãŸåŠ›ã‚’è¦‹ã›ã‚‹ç§ç«‹ã®å®ŸåŠ›æ ¡ã€‚ãƒ™ãƒ†ãƒ©ãƒ³ç”°å´ç›£ç£ãŒç¯‰ãä¸Šã’ãŸå …å®Ÿãªé‡çƒã¯ã€ã©ã®ãƒãƒ¼ãƒ ã«ã¨ã£ã¦ã‚‚ã‚„ã‚Šã«ãã„ã€‚ä¸€æ–¹ã§ã€è¿‘å¹´ã¯ãƒ™ã‚¹ãƒˆ8å‰å¾Œã§ã®æ•—é€€ãŒç¶šãã€ä¸Šä½é€²å‡ºã«ã¯èª²é¡Œã‚‚æ®‹ã‚‹ã€‚å¼·è±ªæ ¡ã«ã¨ã£ã¦ã¯å„ä»‹ãªã€Œé–€ç•ªã€ã‹ã‚‰è„±å´ã—ã€é ‚ç‚¹ã‚’ç‹™ãˆã‚‹ã‹ãŒå•ã‚ã‚Œã‚‹ã€‚ã€‚",
        coach: { name: 'ç”°å´ åœ­ä»‹', style: 'å …å®Ÿ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "èª æµ": {
        name_yomi: "ã›ã„ã‘ã„",
        region: "æ±éƒ¨",
        type: "ç§ç«‹",
        deviation: 38,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "åˆæˆ¦æ•—é€€",
        info: "ã‹ã¤ã¦ã¯ç”²å­åœ’ã«ã‚‚å‡ºå ´ã—ãŸå¤è±ªã ãŒã€è¿‘å¹´ã¯éƒ¨å“¡ä¸è¶³ã«æ‚©ã¿ä½è¿·ã—ã¦ã„ã‚‹ã€‚å‹åˆ©ã®ãŸã‚ãªã‚‰æ‰‹æ®µã‚’é¸ã°ãªã„ãƒ™ãƒ†ãƒ©ãƒ³å½±å±±ç›£ç£ã®éæƒ…ãªé‡‡é…ã¯ã€ç‰©è­°ã‚’é†¸ã™ã“ã¨ã‚‚å°‘ãªããªã„ã€‚ã—ã‹ã—ã€æµã¾ã‚Œãªã„æˆ¦åŠ›ã§å‹ã¡ä¸ŠãŒã‚‹ãŸã‚ã€ç¶ºéº—äº‹ã ã‘ã§ã¯æ¸ˆã¾ã•ã‚Œãªã„ã¨ã„ã†ãƒãƒ¼ãƒ ã®ç¾å®Ÿã‚‚è¡¨ã—ã¦ã„ã‚‹ã€‚ã€‚",
        coach: { name: 'å½±å±± ç§€è·¯', style: 'ãƒ©ãƒ•ãƒ—ãƒ¬ãƒ¼', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "ç§‘å­¦æŠ€è¡“": {
        name_yomi: "ã‹ãŒããã˜ã‚…ã¤",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 23,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "VRãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚„AIã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿è§£æãªã©ã€æœ€æ–°æŠ€è¡“ã‚’ç©æ¥µçš„ã«å°å…¥ã—ã¦ã„ã‚‹æ–°æ™‚ä»£ã®ç§ç«‹æ ¡ã€‚ãã®å…ˆé€²çš„ãªå–ã‚Šçµ„ã¿ã¯ãƒ¡ãƒ‡ã‚£ã‚¢ã§ã‚‚åº¦ã€…å–ã‚Šä¸Šã’ã‚‰ã‚Œã€çŸ¥ååº¦ã¯é«˜ã„ã€‚é€Ÿæ°´ç›£ç£ã®ä¸‹ã€ç§‘å­¦çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§é¸æ‰‹ã®èƒ½åŠ›ã‚’æœ€å¤§é™ã«å¼•ãå‡ºã™ã€‚ãƒ‡ãƒ¼ã‚¿é‡çƒãŒä¼çµ±çš„ãªå¼·è±ªæ ¡ã«ã©ã“ã¾ã§é€šç”¨ã™ã‚‹ã®ã‹ã€æ³¨ç›®ãŒé›†ã¾ã‚‹ã€‚ã€‚",
        coach: { name: 'é€Ÿæ°´ å¥¨', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'ä¸­å …' }
    },
    "å°å±±": {
        name_yomi: "ãŠã‚„ã¾",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 49,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "äººå£1ä¸‡äººã®å°ã•ãªç”ºã«ã‚ã‚‹ã€å…¨æ ¡ç”Ÿå¾’100äººã«ã‚‚æº€ãŸãªã„å°è¦æ¨¡æ ¡ã€‚ç”ºã®æœŸå¾…ã‚’ä¸€èº«ã«èƒŒè² ã„ã€å½¼ã‚‰ã¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç«‹ã¤ã€‚ãƒãƒ£ãƒ³ã‚¹æ™‚ã«å…¨æ ¡ç”Ÿå¾’ã¨ç”ºæ°‘ãŒä¸€ä½“ã¨ãªã£ã¦è¸Šã‚‹ã€å°å±±èˆè¸Šã€ã¯ã€ç›¸æ‰‹ãƒãƒ¼ãƒ ã‚’å‘‘ã¿è¾¼ã‚€ç‹¬ç‰¹ã®é›°å›²æ°—ã‚’ç”Ÿã¿å‡ºã™ã€‚ãƒ™ãƒ†ãƒ©ãƒ³çŒ«ç”°ç›£ç£ã®ä¸‹ã€ä½“æ ¼ã§ã¯åŠ£ã‚‹é¸æ‰‹ãŸã¡ãŒæ©Ÿå‹•åŠ›ã§æ»ãå›ã™ã€‚ç”ºå…¨ä½“ã®æƒ³ã„ãŒã€å¥‡è·¡ã‚’èµ·ã“ã™ã‹ã‚‚ã—ã‚Œãªã„ã€‚",
        coach: { name: 'çŒ«ç”° æ¨©è”µ', style: 'æ©Ÿå‹•åŠ›é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "è™åºœå³¶ç·åˆ": {
        name_yomi: "ã“ãµã¨ã†ãã†ã”ã†",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 47,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "åˆæˆ¦æ•—é€€",
        info: "æœ¬åœŸã‹ã‚‰å®šæœŸèˆ¹ã§4æ™‚é–“ã€‚å°é¢¨ãŒæ¥ã‚Œã°1é€±é–“ã¯å­¤å³¶ã¨åŒ–ã™ã€‚ãã‚ŒãŒè™åºœå³¶ã ã€‚ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã¯å¡©å®³ã§èŠç”ŸãŒã¾ã ã‚‰ã«æ¯ã‚Œã€é›¨ãŒé™ã‚Œã°æ²¼åœ°ã¨åŒ–ã™ã€‚ç·´ç¿’ç›¸æ‰‹ã¯æ¼ã®åˆé–“ã«é›†ã¾ã‚‹å³¶ã®è‰é‡çƒãƒãƒ¼ãƒ ã®åœ°å…ƒã®æ–¹ã€…ã€‚å½¼ã‚‰ã‹ã‚‰æ•™ã‚ã‚‹ã®ã¯ã€æ°—åˆã€ã¨ã€æ½®ã®æµã‚Œã®èª­ã¿æ–¹ã€ã ã€‚æœ¬åœŸã®ä»–æ ¡ã®æƒ…å ±ã¯ã€æœˆã«ä¸€åº¦å±Šãé‡çƒé›‘èªŒã ã‘ã€‚ã—ã‹ã—ã€ã“ã®çµ¶æœ›çš„ãªãƒãƒ³ãƒ‡ãŒå½¼ã‚‰ã®é­‚ã‚’é‹¼é‰„ã«å¤‰ãˆãŸã€‚ãã®é€†å¢ƒãŒã€Œè™åºœå³¶ã‚¹ãƒ”ãƒªãƒƒãƒ„ã€ã¨å‘¼ã°ã‚Œã‚‹å¼·é­ãªç²¾ç¥åŠ›ã¨ãƒãƒ¼ãƒ ã®çµæŸã‚’è‚²ã‚“ã ã€‚è©¦åˆã®æ—¥ã«ã¯å³¶æ°‘ãŒå¤§æŒ™ã—ã¦å¿œæ´ã«é§†ã‘ã¤ã‘ã‚‹ãªã©ã€åœ°åŸŸã¨ã®çµ†ã¯ã©ã“ã‚ˆã‚Šã‚‚å¼·ã„ã€‚å™‚ã«ã‚ˆã‚‹ã¨å³¶æ°‘ã®ç´„åŠæ•°ã«ã‚‚åŠã¶ã‚‰ã—ã„ã€‚ã‚‚ã¯ã‚„ã“ã‚Œã¯å˜ãªã‚‹ã‚¹ãƒãƒ¼ãƒ„ã§ã¯ãªã„ã€‚å³¶ãŒã€ç”Ÿãã‚‹ãŸã‚ã«æˆ¦ã†ç‰©èªã ã€‚",
        coach: { name: 'å³¶è¢‹ è­²äºŒ', style: 'å…¨å“¡é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "çŸ¥å¾³": {
        name_yomi: "ã¡ã¨ã",
        region: "æ±éƒ¨",
        type: "ç§ç«‹",
        deviation: 71,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        last: "åˆæˆ¦æ•—é€€",
        info: "ã€åŠ›ã“ãå…¨ã¦ã€ã‚’æ ¡è¨“ã«æ²ã’ã€ç·´ç¿’ã®ã»ã¨ã‚“ã©ã‚’ã‚¦ã‚¨ã‚¤ãƒˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«è²»ã‚„ã™è„³ç­‹é›†å›£ã€‚é‡‘å‰›ç›£ç£ã®æŒ‡å°ã®ä¸‹ã€å…¨é¸æ‰‹ãŒãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹100kgä»¥ä¸Šã‚’èª‡ã‚‹ãƒ‘ãƒ¯ãƒ¼ã¯æœ¬ç‰©ã ã€‚ã—ã‹ã—ã€ãã®å¤§å‘³ãªé‡çƒã¯ã€æ „é¤Šç®¡ç†ã‚„ç§‘å­¦çš„ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å–ã‚Šå…¥ã‚Œã‚‹å¼·è±ªæ ¡ã®å‰ã«ã€ã„ã¤ã‚‚ã‚ã¨ä¸€æ­©ã§å±ˆã—ã¦ããŸã€‚ç­‹è‚‰ã¯è£åˆ‡ã‚‰ãªã„ã€‚ãã®è¨€è‘‰ã‚’ä¿¡ã˜ã€å½¼ã‚‰ã¯ä»Šæ—¥ã‚‚é‰„ã‚¢ãƒ¬ã‚¤ã‚’æ¡ã‚‹ã€‚",
        coach: { name: 'é‡‘å‰› æ¯…', style: 'ãƒ‘ãƒ¯ãƒ¼é‡çƒ', experience: 'ä¸­å …' }
    },
    "é™æ¸…": {
        name_yomi: "ã›ã„ã›ã„",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 55,
        best: "ç”²å­åœ’å„ªå‹",
        last: "åˆæˆ¦æ•—é€€",
        info: "åŠä¸–ç´€å‰ã«ç”²å­åœ’5é€£è¦‡ã‚’é”æˆã—ãŸä¼èª¬çš„ãªå¤è±ªã€‚è¿‘å¹´ã¯ä½è¿·ãŒç¶šããŒã€ãã®åå‰ã¯ä»Šã‚‚é«˜æ ¡é‡çƒãƒ•ã‚¡ãƒ³ã«ç•æ•¬ã®å¿µã‚’æŠ±ã‹ã›ã¦ã„ã‚‹ã€‚ã‹ã¤ã¦ã®åå°†ã®è¡€ã‚’å¼•ãçŠ¬é£¼ç›£ç£ãŒã€ä¼çµ±ã®å …å®ˆã‚’å¾©æ´»ã•ã›ã€ã€Œå¸å›½ã®å†å»ºã€ã‚’ç›®æŒ‡ã™ã€‚å¤è±ªå¾©æ´»ã¸ã®é“ã®ã‚Šã¯é™ºã—ã„ãŒã€ãã®ä¸€æŒ™æ‰‹ä¸€æŠ•è¶³ã«æ³¨ç›®ãŒé›†ã¾ã‚‹ã€‚ã€‚",
        coach: { name: 'çŠ¬é£¼ è³¢äºº', style: 'å®ˆå‚™é‡è¦–', experience: 'åå°†' }
    },
    "æ—¥å¤§ä¸‰å³¶": {
        name_yomi: "ã«ã¡ã ã„ã¿ã—ã¾",
        region: "æ±éƒ¨",
        type: "ç§ç«‹",
        deviation: 96,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "2022å¹´ã®æ˜¥å¤é€£ç¶šç”²å­åœ’å‡ºå ´ãŒè¨˜æ†¶ã«æ–°ã—ã„æ—¥å¤§ä¸‰å³¶ã€‚æ˜¨ç§‹ã¯çœŒå¤§ä¼š3å›æˆ¦ã§æ•—é€€ã—ã€æ°—åˆã‚’å…¥ã‚Œç›´ã—ãŸã¨ã“ã‚ã ã€‚æŒ‡æ®ã‚’ã¨ã‚‹ã®ã¯æ°¸ç”°è£•æ²»ç›£ç£ã ã€‚å ±å¾³å­¦åœ’ï¼ˆå…µåº«ï¼‰æ™‚ä»£ã«ã¯å…¨å›½åˆ¶è¦‡ã‚’å«ã‚€ã€æ˜¥å¤é€šç®—18å›ã®ç”²å­åœ’å‡ºå ´ã€‚2020å¹´ã«æ—¥å¤§ä¸‰å³¶ã«èµ´ä»»ã™ã‚‹ã¨ã€2022å¹´ã«ã¯æ˜¥å¤é€£ç¶šã§ç”²å­åœ’ã«å°ã„ãŸã€‚ä»Šãƒãƒ¼ãƒ ã‚‚ç™¾æˆ¦éŒ¬ç£¨ã®åå°†ã‹ã‚‰å…¨å“¡é‡çƒã®å¤§åˆ‡ã•ã€å‹è² ã«å¯¾ã™ã‚‹å³ã—ã•ã‚’å­¦ã³ã€é¸æ‰‹ãŸã¡ã®é¡”ã¤ããŒå°‘ã—ãšã¤å¤‰ã‚ã£ã¦ããŸã€‚åå°†ã®å°±ä»»ã‹ã‚‰4å¹´ãŒéãã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã€‚ã€‚",
        coach: { name: 'å°å’Œç”° é›…äºº', style: 'å …å®Ÿ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æµœæ¾é–‹èª é¤¨": {
        name_yomi: "ã¯ã¾ã¾ã¤ã‹ã„ã›ã„ã‹ã‚“",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 120,
        best: "ç”²å­åœ’2å›æˆ¦",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã¯çœŒå†…ãƒˆãƒƒãƒ—ã¨ã‚‚ç§°ã•ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚‹ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆå±ˆæŒ‡ã®ãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ã€‚2023å¹´ã«ã¯ç”²å­åœ’å‡ºå ´ã‚‚æœãŸã—ã€ä¸€èºå¼·è±ªã¨ã—ã¦ã®åèª‰ã‚’ç¯‰ã„ãŸã€‚ç­–å£«ãƒ»ä½é‡ç›£ç£ãŒç‡ã„ã‚‹ãƒãƒ¼ãƒ ã¯ã€ç›¸æ‰‹ãƒãƒ¼ãƒ ã®å¾¹åº•çš„ãªåˆ†æã«åŸºã¥ã„ãŸå¥‡ç­–ã‚’å¾—æ„ã¨ã™ã‚‹ã€‚ãã®äºˆæ¸¬ä¸èƒ½ãªæˆ¦ã„ã¶ã‚Šã¯ã€ã€ã²ã¨ãŸã³æ³¢ã«ä¹—ã‚Œã°ä¸€æ°—ã«å‹ã¡ä¸ŠãŒã‚‹åŠ›ã‚’æŒã£ã¦ã„ã‚‹ã€‚ã€‚",
        coach: { name: 'ä½é‡ ç§€å¹¸', style: 'å¥‡ç­–', experience: 'ç­–å£«' }
    },
    "æ±æµ·å¤§ç¿”æ´‹": {
        name_yomi: "ã¨ã†ã‹ã„ã ã„ã—ã‚‡ã†ã‚ˆã†",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 61,
        best: "çœŒæº–å„ªå‹",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "ä¸€æ˜¨å¹´ã®å¤ã¯ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã‹ã‚‰æ±ºå‹ã¾ã§å‹ã¡é€²ã‚€ã‚‚765ç·åˆã«æ•—ã‚Œã€æº–å„ªå‹ã€‚æ–°ã—ã„ã‚¹ã‚¿ã‚¤ãƒ«ã§ä»Šå¤ã“ãç”²å­åœ’ã¸ï¼å‹åˆ©ã¸ã®åŸ·å¿µã‚’å¼•ãç¶™ãç¾ãƒãƒ¼ãƒ ã®ç‰¹å¾´ã¯ã€Œæ©Ÿå‹•åŠ›ã€ã€‚å‰ãƒãƒ¼ãƒ ã¨ã¯ã¾ãŸé•ã£ãŸã‚¹ã‚¿ã‚¤ãƒ«ã«æœŸå¾…ãŒã‹ã‹ã‚‹ã€‚æ©Ÿå‹•åŠ›ä»¥å¤–ã‚‚ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã—ã¦ã„ã‚‹ã€‚æŠ•æ‰‹ã¯140ã‚­ãƒ­å³è…•ã®ç”˜ç”°åœ­æ¾„ï¼ˆ2å¹´ï¼‰ãŒå›è‡¨ã€‚èª²é¡Œã ã£ãŸ2ç•ªæ‰‹ã‚‚ã€1å¹´ç”Ÿã‚’ä¸­å¿ƒã«å°é ­ã—ã¤ã¤ã‚ã‚‹ã€‚ä¸€æ–¹ã®æ”»æ’ƒåŠ›ã¯7è©¦åˆè¨ˆ90å®‰æ‰“ã‚’å©ãå‡ºã—ãŸæ˜¨å¹´ã®ãƒãƒ¼ãƒ ã«æ¯”ã¹ã¦åŠ£ã‚‹ãŒã€æ©Ÿå‹•åŠ›ã‚’ä½¿ã£ãŸé‡çƒã‚’å±•é–‹ã€‚ãƒãƒ¼ãƒ ãƒŠãƒ³ãƒãƒ¼ãƒ¯ãƒ³ã®ä¿Šè¶³ãƒ»æ¾ä¸‹æ®äººï¼ˆ2å¹´ï¼å¤–é‡æ‰‹ï¼‰ã‚„å²¸å·ã‚’ç­†é ­ã«è¶³ã®é€Ÿã„é¸æ‰‹ãŒå¤šã„ã®ã‚‚è¿½ã„é¢¨ã¨ãªã£ã¦ã„ã‚‹ã€‚å®ˆã‚Šã‹ã‚‰ãƒªã‚ºãƒ ã‚’ä½œã‚Šã€1ç‚¹ãšã¤ç©ã¿é‡ã­ã¦ã„ããƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ãŒæµ¸é€ã—ã¦ããŸã€Œã‚¿ãƒ†ã‚¸ãƒè»å›£ã€ã€‚2004å¹´å¤ä»¥æ¥ã¨ãªã‚‹ç”²å­åœ’ã«å‘ã‘ã¦ç‰™ã‚’ç ”ãã€‚ã€‚",
        coach: { name: 'é ˆç”° å¹¸é›„', style: 'ç·åˆåŠ›', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "283å­¦åœ’B": {
        name_yomi: "ã¤ã°ã•ãŒããˆã‚“B",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 59,
        best: "ãªã—",
        last: "ãªã—",
        info: "ç‹è€…ãƒ»283å­¦åœ’ã®ã€äºŒè»ã€ã€‚æ˜¨å¹´ã®å„ªå‹ã«ã‚ˆã‚Šéƒ¨å“¡æ•°ãŒæ€¥æ¿€ã«å¢—åŠ ã—ãŸ283å­¦åœ’ã€‚ä¸€æ™‚ã¯100äººã‚‚è¶…ãˆãŸãŸã‚ã€ãã‚Œã«ä¼´ã„ã€ç•°ä¾‹ã®æªç½®ã¨ã—ã¦è¨­ç«‹ã•ã‚ŒãŸBãƒãƒ¼ãƒ ã€‚Aãƒãƒ¼ãƒ ã«ä¸ŠãŒã‚Œãªã‹ã£ãŸé¸æ‰‹ã§æ§‹æˆã•ã‚Œã¦ã„ã‚‹ãŒã€ç›£ç£ã«å°±ä»»ã—ãŸä¸ƒè‰ã®æ‰‹è…•ã‚‚ã‚ã‚Šã€ãã®å®ŸåŠ›ã¯ä¾®ã‚Œãªã„ã€‚ã€Œæ‰“å€’Aãƒãƒ¼ãƒ ã€ã‚’æ²ã’ã€ãƒãƒ³ã‚°ãƒªãƒ¼ç²¾ç¥ã¯æœ¬å®¶ä»¥ä¸Šã€‚å…¬å¼æˆ¦ã§ã®å…„å¼Ÿå¯¾æ±ºãŒå®Ÿç¾ã™ã‚Œã°ã€å¤§ããªæ³¨ç›®ã‚’é›†ã‚ã‚‹ã ã‚ã†ã€‚çœŒå†…ã‹ã‚‰ã¯åŒã˜çœŒå†…ã«åŒã˜é«˜æ ¡ã®ãƒãƒ¼ãƒ ã®äºŒã¤ç›®ã‚’ä½œã‚Šå¤§ä¼šã«å‚åŠ ã•ã›ã‚‹ã®ã¯é•åè¡Œç‚ºãªã®ã§ã¯ã€ã¨ã„ã†å£°ãŒå¤šãä¸ŠãŒã£ãŸãŒã€çœŒå†…ã¯ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ãŒç‰›è€³ã£ã¦ã„ã‚‹ãŸã‚ã€ã”ã‚ŠæŠ¼ã—ã§å¯æ±ºã•ã›ãŸã€‚",
        coach: { name: 'ä¸ƒè‰ ã¯ã¥ã', style: 'è‚²æˆä¸Šæ‰‹', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "ä¼Šè±†ä¼Šæ±": {
        name_yomi: "ã„ãšã„ã¨ã†",
        region: "ä¼Šè±†",
        type: "å…¬ç«‹",
        deviation: 43,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æ•°å¹´å‰ã«å…±å­¦åŒ–ã—ãŸå…ƒå¥³å­é«˜ã§ã€é‡çƒéƒ¨ã¯å‰µéƒ¨ã¾ã‚‚ãªã„æ–°ã—ã„ãƒãƒ¼ãƒ ã€‚å­¦æ ¡å´ã®å…¨é¢çš„ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å—ã‘ã€æœŸå¾…ã®è‹¥æ‰‹ã€ä¼Šé›†é™¢ç›£ç£ãŒæŒ‡å°ã«ã‚ãŸã‚‹ã€‚å…¨å›½ãƒ¬ãƒ™ãƒ«ã¨åé«˜ã„å¹å¥æ¥½éƒ¨ã®å¿œæ´ã‚‚ãƒãƒ¼ãƒ ã®å¤§ããªæ­¦å™¨ã€‚ã¾ã ç™ºå±•é€”ä¸Šã ãŒã€ä»Šå¾Œã®æˆé•·ãŒæœŸå¾…ã•ã‚Œã‚‹æ³¨ç›®æ ªã ã€‚ã€‚",
        coach: { name: 'ä¼Šé›†é™¢ éš¼äºº', style: 'æ©Ÿå‹•åŠ›é‡çƒ', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "å¯Œå£«æ±": {
        name_yomi: "ãµã˜ã²ãŒã—",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 63,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "å¯Œå£«æ±ã¯æœ€ä¸Šç´šç”Ÿã®å¥®èµ·ã«æ³¨ç›®ã ã€‚æ˜¨å¹´ã¯ï¼”äººã—ã‹ã„ãªã„ï¼“å¹´ç”Ÿå…¨å“¡ãŒæ´»èºã‚’è¦‹ã›ã€åˆæˆ¦ã§ç”²å­åœ’å‡ºå ´çµŒé¨“ã‚‚ã‚ã‚‹å¯Œå£«å®®åŒ—ã‚’ï¼—â€•ï¼–ã§ç ´ã£ãŸã€‚ä¸€ç·’ã«ãƒ—ãƒ¬ãƒ¼ã—ãŸå²©ç”°ä¸»å°†ï¼ˆï¼“å¹´ï¼‰ã¯ã€Œãã†ã„ã†ä¸Šç´šç”Ÿã®å§¿ã‚’ä»Šå¹´ã‚‚å¾Œè¼©ãŸã¡ã«è¦‹ã›ãŸã„ã€ã¨æ„æ°—è¾¼ã‚€ã€‚ã‚¨ãƒ¼ã‚¹ã®çœå±±ï¼ˆï¼“å¹´ï¼‰ã¯ã€ï¼”æ—¥ã®æ‹›å¾…è©¦åˆã§æ—¥å¤§ä¸‰å³¶ã«ï¼‘å¤±ç‚¹å®ŒæŠ•å‹åˆ©ã€‚è‡ªä¿¡ã‚’èƒ¸ã«ã€Œãƒãƒ¼ãƒ ã‚’é¼“èˆã™ã‚‹æŠ•çƒã‚’ã—ãŸã„ã€ã¨å¤§èˆå°ã‚’è¦‹æ®ãˆã‚‹ã€‚ã€‚",
        coach: { name: 'é«˜æ©‹ ç•™ç¾', style: 'å®ˆå‚™é‡è¦–', experience: 'ä¸­å …' }
    },
    "å¸¸è‘‰èŠå·": {
        name_yomi: "ã¨ã“ã¯ãããŒã‚",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 55,
        best: "ç”²å­åœ’æº–å„ªå‹",
        last: "çœŒæº–å„ªå‹",
        info: "ç¹”ç”°ç›£ç£ãŒç‡ã„ã‚‹ã€è¶…æ”»æ’ƒçš„ãªé‡çƒã‚’æ¨™æ¦œã™ã‚‹ç§ç«‹æ ¡ã€‚æ˜¨å¹´ã®çœŒå¤§ä¼šã§ã¯ã€ãã®åœ§å€’çš„ãªæ‰“æ’ƒåŠ›ã§æº–å„ªå‹ã«è¼ã„ãŸã€‚å®ˆå‚™ã«èª²é¡Œã‚’æ®‹ã™ã‚‚ã®ã®ã€ã€Œç‚¹ã‚’å–ã‚‰ã‚ŒãŸã‚‰å–ã‚Šè¿”ã™ã€ã¨ã„ã†ã‚¹ã‚¿ã‚¤ãƒ«ã¯å¤šãã®ãƒ•ã‚¡ãƒ³ã‚’é­…äº†ã—ã¦ã„ã‚‹ã€‚ä»Šå¹´ã‚‚ãã®ç ´å£Šçš„ãªæ‰“ç·šã¯å¥åœ¨ã§ã€é ‚ç‚¹ã‚’ç›®æŒ‡ã™ã€‚ã€‚",
        coach: { name: 'ç¹”ç”° ä¿¡é•·', style: 'è¶…æ”»æ’ƒå‹', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "å¸¸è‘‰æ©˜": {
        name_yomi: "ã¨ã“ã¯ãŸã¡ã°ãª",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 92,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æŠ•æ‰‹é™£ã¯ç·©æ€¥ã‚’ã¤ã‘ã‚‹ä¸‰æµ¦ã€æ€ã„åˆ‡ã‚Šã®ã„ã„å±±å£ã‚‰ãŒä¸»æˆ¦ã‚’äº‰ã†ã€‚æ‰“ç·šã¯é•·æ‰“åŠ›ãŒã‚ã‚‹ãƒ–ãƒ©ãƒ³ã‚³ã€ä¸­æ‘ã‚‰ä¸­è»¸ãŒä¿¡é ¼ã§ãã‚‹ã€‚çŸ³å·ã€ãƒ¢ãƒ¼ã‚¬ãƒ³ã‚‰ä¸Šä½ãŒå‡ºã¦ã€å¾—ç‚¹æ©Ÿã‚’ã¤ãã‚ŠãŸã„ã€‚ä¸‹ä½æ‰“ç·šã®å……å®ŸãŒéµã€‚å®ˆå‚™ã¯ä¸€å¹´ç”Ÿã®æ™‚ã‹ã‚‰è©¦åˆã«å‡ºã¦ã„ã‚‹éŠæ’ƒæ¢¶è°·ã€æ˜¨å¹´ã‚’çµŒé¨“ã—ãŸæ•æ‰‹é¶´å²¡ã‚‰ã‚»ãƒ³ã‚¿ãƒ¼ãƒ©ã‚¤ãƒ³ãŒè»¸ã€‚ç¢ºå®Ÿã«ã‚¢ã‚¦ãƒˆã‚’å–ã‚Œã‚‹å®‰å®šæ„ŸãŒæŒã¡å‘³ã ã€‚",
        coach: { name: 'æ¸¡è¾º å…ƒæ™º', style: 'ç·åˆåŠ›', experience: 'åå°†' }
    },
    "è—¤ææ˜èª ": {
        name_yomi: "ãµã˜ãˆã ã‚ã„ã›ã„",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 90,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        info: "ã€Œé›‘è‰è»å›£ã€ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã€å …å®Ÿãªå®ˆå‚™ã¨æ‰‹å …ã„æ”»ã‚ã®é‡çƒãŒæŒã¡å‘³ã®ãƒãƒ³ã‚°ãƒªãƒ¼ç²¾ç¥ã®å¼·ã„ãƒãƒ¼ãƒ ã€‚ãƒ™ãƒ†ãƒ©ãƒ³çŒªç‹©ç›£ç£ã®æŒ‡å°ã®ä¸‹ã€å€‹ã€…ã®é¸æ‰‹ã®èƒ½åŠ›ã¯éå¸¸ã«é«˜ã„ã€‚ãƒãƒ¼ãƒ ã¨ã—ã¦å™›ã¿åˆã£ãŸæ™‚ã®çˆ†ç™ºåŠ›ã¯ã€å„ªå‹å€™è£œã‚’ã‚‚è„…ã‹ã™ã€‚è¿‘å¹´ç€ã€…ã¨çµæœã‚’å‡ºã—ã¦ãŠã‚Šã€ä»Šå¤§ä¼šã¯æ˜¥ã®å¤§ä¼šã§ä¸Šä½ã®æˆç¸¾ã‚’åã‚ãŸã“ã¨ã«ã‚ˆã‚Šã€ã‚·ãƒ¼ãƒ‰æ ¡ã¨ã—ã¦å›è‡¨ã—ã¦ã„ã‚‹ã€‚ã€Œé©å‘½ã€ã®æ™‚ã¯è¿‘ã„ã€‚",
        coach: { name: 'çŒªç‹© èŒ‚', style: 'æŠ•æ‰‹ä¸­å¿ƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "é§¿æ²³ç·åˆ": {
        name_yomi: "ã™ã‚‹ãŒãã†ã”ã†",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 47,
        best: "çœŒå¤§ä¼šæº–å„ªå‹",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "2019å¹´å¤ã«åˆã®çœŒæ±ºå‹é€²å‡ºã‚’æœãŸã—ãŸé§¿æ²³ç·åˆã€‚æ˜¨å¤ã®ã€Œ2020å¹´å¤å­£é™å²¡çœŒé«˜ç­‰å­¦æ ¡é‡çƒå¤§ä¼šçµæœã€ã§ã‚‚ãƒ™ã‚¹ãƒˆ4å…¥ã‚Šã€‚æ‚²é¡˜ã®ç”²å­åœ’ãŒæ‰‹ã®å±Šãä½ç½®ã¾ã§ãã¦ã„ã‚‹ã€‚åŒæ ¡ã¯ãƒãƒ¼ãƒ åŠ›ãŒå¹´ã€…ä¸Šæ˜‡ã™ã‚‹ã¨åŒæ™‚ã«ã€ä¸Šã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§æ´»èºã™ã‚‹å’æ¥­ç”ŸãŒå¢—ãˆã¦ã„ã‚‹ã€‚2018å¹´ã«ç¤¾ä¼šäººé‡çƒã‚’çµŒã¦OBã®æ‰å±±ä¸€æ¨¹ï¼ˆç¦å²¡ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯ï¼‰ãŒãƒ—ãƒ­å…¥ã‚Šã€‚æœ€é€Ÿ157ã‚­ãƒ­ã®å‰›é€Ÿçƒã‚’æ­¦å™¨ã«ä»Šå­£ã¯ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸€è§’ã¨ã—ã¦æœŸå¾…ã•ã‚Œã‚‹ã€‚ã•ã‚‰ã«ã€2019å¹´ã®ãƒ‰ãƒ©ãƒ•ãƒˆã§æŒ‡åã•ã‚ŒãŸç´…æ—å¼˜å¤ªéƒï¼ˆã‚ªãƒªãƒƒã‚¯ã‚¹ï¼‰ã¯ãƒ—ãƒ­1å¹´ç›®ã‹ã‚‰1è»æˆ¦ã«å‡ºå ´ã€‚å°†æ¥ã®ä¸»è»¸å€™è£œã¨ã—ã¦æ³¨ç›®ã‚’é›†ã‚ã¦ã„ã‚‹ã€‚æœŸå¾…ã®è‹¥æ‰‹ãƒ»è—¤å´ç›£ç£ãŒæŒã¡è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿é‡çƒã‚’æ­¦å™¨ã«ã€ç€å®Ÿã«åŠ›ã‚’ã¤ã‘ã¦ã„ã‚‹ã€‚ç›¸æ‰‹ã®æ²¹æ–­ã‚’çªãæƒ…å ±æˆ¦ã‚’å¾—æ„ã¨ã—ã€ä¸‹é¦¬è©•ã‚’è¦†ã™ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã¯ååˆ†ã€‚æ ¡åã¨ã¯è£è…¹ã«ã€å†·é™æ²ˆç€ãªé‡çƒã§ç•ªç‹‚ã‚ã›ã‚’ç‹™ã†ã€‚ã€‚",
        coach: { name: 'è—¤å´ è©©ç¹”', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "åŠ è—¤å­¦åœ’": {
        name_yomi: "ã‹ã¨ã†ãŒããˆã‚“",
        region: "æ±éƒ¨",
        type: "ç§ç«‹",
        deviation: 99,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æŠ•æ‰‹é™£ã¯ç·©æ€¥ã‚’ã¤ã‘ã‚‹å¶‹ã€æ€ã„åˆ‡ã‚Šã®ã„ã„æ¦æœ¬ã‚‰ãŒä¸»æˆ¦ã‚’äº‰ã†ã€‚æ‰“ç·šã¯é•·æ‰“åŠ›ãŒã‚ã‚‹å³ç”°ã€å¯ºç”°ã‚‰ä¸­è»¸ãŒä¿¡é ¼ã§ãã‚‹ã€‚å·å´ã‚‰ä¸Šä½ãŒå‡ºã¦ã€å¾—ç‚¹æ©Ÿã‚’ã¤ãã‚ŠãŸã„ã€‚ä¸‹ä½æ‰“ç·šã®å……å®ŸãŒéµã€‚å®ˆå‚™ã¯ä¸€å¹´ç”Ÿã®æ™‚ã‹ã‚‰è©¦åˆã«å‡ºã¦ã„ã‚‹éŠæ’ƒå‚å£ã€æ˜¨å¹´ã‚’çµŒé¨“ã—ãŸæ•æ‰‹å¤ç”°ã‚‰ã‚»ãƒ³ã‚¿ãƒ¼ãƒ©ã‚¤ãƒ³ãŒè»¸ã€‚å¤ã¾ã§ã«ç¢ºå®Ÿã«ã‚¢ã‚¦ãƒˆã‚’å–ã‚Œã‚‹å®‰å®šæ„Ÿã‚’èº«ã«ã¤ã‘ãŸã„ç›´è¿‘ã®ç·´ç¿’è©¦åˆã§ã¯æ±æµ·å¤§ç¿”æ´‹ã«ã‚‚å‹åˆ©ã™ã‚‹ãªã©ä»Šå¤§ä¼šã®å„ªå‹å€™è£œã¨è¨€ã£ã¦ã‚‚éè¨€ã§ã¯ãªã„",
        coach: { name: 'é°¯æ°´ ç­‰', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "æµœæ¾å·¥æ¥­": {
        name_yomi: "ã¯ã¾ã¾ã¤ã“ã†ãã‚‡ã†",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 64,
        best: "ç”²å­åœ’ãƒ™ã‚¹ãƒˆ8",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ç´„30å¹´å‰ã«ç”²å­åœ’ãƒ™ã‚¹ãƒˆ8ã«é€²å‡ºã—ã€ã€Œæµœå·¥æ—‹é¢¨ã€ã‚’å·»ãèµ·ã“ã—ãŸã“ã¨ã§çŸ¥ã‚‰ã‚Œã‚‹ã€‚è¿‘å¹´ã¯ä½è¿·ã—ã¦ã„ãŸãŒã€å½“æ™‚ã®ã‚¨ãƒ¼ã‚¹ã ã£ãŸé’è‘‰ãŒç›£ç£ã«å°±ä»»ã—ã€å†å»ºã«ä¹—ã‚Šå‡ºã—ãŸã€‚ã‹ã¤ã¦ã®è‹±é›„ã®å¸°é‚„ã«ã€OBã‚„åœ°å…ƒã®æœŸå¾…ã‚‚é«˜ã¾ã£ã¦ã„ã‚‹ã€‚æ–°ã—ã„ä¸–ä»£ã®é¸æ‰‹ãŸã¡ã¨å…±ã«ã€å†ã³è–åœ°ã‚’ç›®æŒ‡ã™ã€‚ã€‚",
        coach: { name: 'é’è‘‰ å¥å¸', style: 'è‚²æˆä¸Šæ‰‹', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "ä¼Šè±†ç·åˆ": {
        name_yomi: "ã„ãšãã†ã”ã†",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 43,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "ã‚¨ãƒ¼ã‚¹ã¯æœ€é€Ÿï¼‘ï¼“ï¼–ã‚­ãƒ­ã®åŠ›ã®ã‚ã‚‹ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã§å‹è² ã™ã‚‹ã€‚æ‰“æ’ƒé™£ã«æ´¾æ‰‹ã•ã¯ãªã„ã‚‚ã®ã®èµ°å¡ã‚„æˆ¦è¡“ã«ç£¨ãã‚’ã‹ã‘ã€è¶³ã‚Šãªã„é•·æ‰“åŠ›ã‚’ã‚«ãƒãƒ¼ã™ã‚‹ã€‚è½ã¡ç€ã„ãŸé›°å›²æ°—ã§é‡çƒã«å–ã‚Šçµ„ã‚“ã§ã„ã‚‹ã€‚å°¾å³¶å¤ªéƒç›£ç£ã®æŒ‡å°ã¯ã€å …å®Ÿãªå®ˆå‚™ã¨ç¢ºå®Ÿãªãƒãƒ³ãƒˆãªã©ã‚’é‡è¦–ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã€‚æ´¾æ‰‹ã•ã¯ãªã„ãŒã€å¤§å´©ã‚Œã—ãªã„å®‰å®šæ„ŸãŒã‚ã‚‹ã€‚ã€‚",
        coach: { name: 'å°¾å³¶ å¤ªéƒ', style: 'å®ˆå‚™é‡è¦–', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "å¯Œå£«å®®è¥¿": {
        name_yomi: "ãµã˜ã®ã¿ã‚„ã«ã—",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 58,
        best: "ç”²å­åœ’ãƒ™ã‚¹ãƒˆ16",
        last: "åˆæˆ¦æ•—é€€",
        info: "ç´„30å¹´å‰ã«ç”²å­åœ’å‡ºå ´çµŒé¨“ã®ã‚ã‚‹å¤è±ªã€‚è¿‘å¹´ã¯ç§ç«‹æ ¡ã®å°é ­ã«æŠ¼ã•ã‚Œã€ä¸Šä½é€²å‡ºã‹ã‚‰é ã–ã‹ã£ã¦ã„ã‚‹ã€‚OBã‚„åœ°å…ƒãƒ•ã‚¡ãƒ³ã®ã€Œå¾©æ´»ã‚’ã€ã¨ã„ã†æœŸå¾…ãŒã€æ™‚ã«é¸æ‰‹ãŸã¡ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã«ãªã‚‹ã“ã¨ã‚‚ã€‚ãƒ™ãƒ†ãƒ©ãƒ³æ‹³å´ç›£ç£ã¯ã€é¸æ‰‹ãŸã¡ãŒæ°—è² ã‚ãšã«å®ŸåŠ›ã‚’ç™ºæ®ã§ãã‚‹ç’°å¢ƒä½œã‚Šã«åŠªã‚ã¦ã„ã‚‹ã€‚",
        coach: { name: 'æ‹³å´ å²éƒ', style: 'ç©æ¥µæ‰“æ’ƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "å¯Œå£«å¸‚ç«‹": {
        name_yomi: "ãµã˜ã„ã¡ã‚Šã¤",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 61,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ã‚»ã‚¤ãƒãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ã„ã¡æ—©ãå°å…¥ã—ã€ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸé‡çƒã‚’å¾¹åº•ã™ã‚‹ç§ç«‹æ ¡ã€‚èµ¤å¶ºç›£ç£ã®é‡‡é…ã¯ã€é¸æ‰‹ã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚„ç›¸æ‰‹ã¨ã®ç›¸æ€§ãªã©ã€ã‚ã‚‰ã‚†ã‚‹æƒ…å ±ã‚’åˆ†æã—ãŸä¸Šã§æ±ºå®šã•ã‚Œã‚‹ã€‚ãã®åˆç†çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€æ™‚ã«éæƒ…ã¨ã‚‚æ˜ ã‚‹ãŒã€ç€å®Ÿã«çµæœã‚’æ®‹ã—ã¦ã„ã‚‹ã€‚",
        coach: { name: 'èµ¤å¶º è­²äºŒ', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'ä¸­å …' }
    },
    "ã‚ªã‚¤ã‚¹ã‚«æµœæ¾å›½éš›": {
        name_yomi: "ãŠã„ã™ã‹ã¯ã¾ã¾ã¤ã“ãã•ã„",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 49,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "çœŒå†…ã‚’ç‰›è€³ã‚‹å·¨å¤§è³‡æœ¬ã€ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã€ã«å¯¾æŠ—ã™ã¹ãã€åœ°å…ƒã®æœ‰å¿—ã€ã‚ªã‚¤ã‚¹ã‚«ã‚°ãƒ«ãƒ¼ãƒ—ã€ãŒè¨­ç«‹ã—ãŸç•°è‰²ã®é«˜æ ¡ã€‚æ½¤æ²¢ãªè³‡é‡‘ã‚’æŒã¤ãƒŠãƒ ã‚³ç³»åˆ—æ ¡ã¨ã¯å¯¾ç…§çš„ã«ã€å½¼ã‚‰ãŒæŒã¤ã®ã¯åéª¨ç²¾ç¥ã¨çµæŸåŠ›ã ã‘ã ã€‚ã€Œä¼èª¬ã€ã¨ç§°ã•ã‚Œã‚‹æ¡ç”Ÿç›£ç£ã®æŒ‡å°ã¯ã€æŠ€è¡“ã‚ˆã‚Šã‚‚ç²¾ç¥çš„ãªå¼·ã•ã‚’é‡è¦–ã™ã‚‹ã€‚ãã®ç†±ã„ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ã¨åéª¨ç²¾ç¥ã¯å¤šãã®ãƒ•ã‚¡ãƒ³ã‚’æƒ¹ãã¤ã‘ã¦ãŠã‚Šã€å¤§ä¼šã®æ³¢ä¹±è¦å› ã¨ã—ã¦æ³¨ç›®ã•ã‚Œã¦ã„ã‚‹ã€‚",
        coach: { name: 'æ¡ç”Ÿ ä¸€é¦¬', style: 'æ ¹æ€§é‡çƒ', experience: 'ä¼èª¬' }
    },
    "æ–°å±…": {
        name_yomi: "ã‚ã‚‰ã„",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 48,
        best: "çœŒå¤§ä¼šåˆæˆ¦æ•—é€€",
        last: "åˆæˆ¦æ•—é€€",
        info: "å¤ã®å¤§ä¼šã€å…¬å¼æˆ¦é€šç®—0å‹32æ•—ã€‚ãã‚ŒãŒã“ã®å­¦æ ¡ã®æ­´å²ã®å…¨ã¦ã ã€‚é•·å¹´å…¬å¼æˆ¦ã§ã®å‹åˆ©ã‹ã‚‰é ã–ã‹ã£ã¦ãŠã‚Šã€éƒ¨å“¡æ•°ã‚‚å¸¸ã«ã‚®ãƒªã‚®ãƒªã¨ã„ã†å³ã—ã„çŠ¶æ³ãŒç¶šãå…¬ç«‹æ ¡ã€‚ç·´ç¿’ç’°å¢ƒã‚‚æµã¾ã‚Œã¦ã„ã‚‹ã¨ã¯è¨€ãˆãªã„ãŒã€é¸æ‰‹ãŸã¡ã¯é‡çƒãŒå¥½ãã ã¨ã„ã†ç´”ç²‹ãªæ°—æŒã¡ã§ç™½çƒã‚’è¿½ã„ç¶šã‘ã¦ã„ã‚‹ã€‚ãƒãƒ¼ãƒ ã®æ‚²é¡˜ã¯ã€ã¾ãšã€Œå…¬å¼æˆ¦ã§ä¸€å‹ã€ã‚’æŒ™ã’ã‚‹ã“ã¨ã€‚ãã®ç¬é–“ã«å‘ã‘ã¦ã€ã²ãŸã‚€ããªåŠªåŠ›ã‚’é‡ã­ã‚‹ã€‚",
        coach: { name: 'ç”°ä¸­ ä¸€éƒ', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "éŸ®å±±": {
        name_yomi: "ã«ã‚‰ã‚„ã¾",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 68,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "åˆæˆ¦æ•—é€€",
        info: "çœŒã®ã‚·ãƒ³ãƒœãƒ«ã€ä¼Šè±†å±±ã€ã®éº“ã«ã‚ã‚‹çœŒå†…å±ˆæŒ‡ã®é€²å­¦æ ¡ã€‚å½¼ã‚‰ã®åç‰©ã¯ã€é™ºã—ã„å±±é“ã‚’æ¯æ—¥é§†ã‘ä¸ŠãŒã‚‹åœ°ç„ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã ã€‚ãã‚Œã§é›ãˆä¸Šã’ã‚‰ã‚ŒãŸå¼·é­ãªè¶³è…°ã¯ã€ä»–æ ¡ã®è„…å¨ã€‚ãƒ™ãƒ†ãƒ©ãƒ³å±±è·¯ç›£ç£ãŒç‡ã„ã‚‹æ©Ÿå‹•åŠ›é‡çƒã¯ã€ä¸€åº¦å‡ºå¡ã‚’è¨±ã™ã¨æ­¢ã¾ã‚‰ãªã„ã€‚å±±ã®æ°‘ã®èª‡ã‚Šã‚’èƒ¸ã«ã€ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’åµã®ã‚ˆã†ã«é§†ã‘å·¡ã‚‹ã€‚",
        coach: { name: 'å±±è·¯ å’Œå¼˜', style: 'æ©Ÿå‹•åŠ›é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "é™å²¡å­¦åœ’": {
        name_yomi: "ã—ãšãŠã‹ãŒããˆã‚“",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 61,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "å‰µéƒ¨19å¹´ã®æ–°èˆˆå‹¢åŠ›ãªãŒã‚‰ã€ç”²å­åœ’å‡ºå ´çµŒé¨“ã‚’æŒã¤å®ŸåŠ›æ ¡ã€‚ã—ã‹ã—æ›´ãªã‚‹é£›èºã®ãŸã‚ã€å­¦æ ¡ã¯å¤§ããªè³­ã‘ã«å‡ºãŸã€‚ã‹ã¤ã¦å¸ç‹å®Ÿæ¥­ã‚’ç”²å­åœ’5é€£è¦‡ã«å°ã„ãŸä¼èª¬ã®åå°†ãƒ»åœ‹æ‘ç›£ç£ã‚’æ‹›è˜ã—ãŸã®ã ã€‚è¦å¾‹ã‚’é‡ã‚“ã˜ã‚‹ãƒ™ãƒ†ãƒ©ãƒ³ç›£ç£ã®ä¸‹ã€æ‰èƒ½ã‚ã‚‹é¸æ‰‹ãŸã¡ãŒã©ã†èåˆã™ã‚‹ã®ã‹ã€å„ªå‹å€™è£œã®ä¸€è§’ã¨ã—ã¦å¤§ããªæ³¨ç›®ã‚’é›†ã‚ã¦ã„ã‚‹ã€‚ã€‚",
        coach: { name: 'åœ‹æ‘ éš¼', style: 'ç·åˆåŠ›', experience: 'åå°†' }
    },
    "å¸‚ç«‹æ²¼æ´¥": {
        name_yomi: "ã„ã¡ã‚Šã¤ã¬ã¾ã¥",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 62,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "åˆæˆ¦æ•—é€€",
        info: "å…¨å›½ãƒ¬ãƒ™ãƒ«ã®å¹å¥æ¥½éƒ¨ãŒå¥ã§ã‚‹å¿œæ´ã¯ã€å¸‚æ²¼ã‚µã‚¦ãƒ³ãƒ‰ã€ã¨ã—ã¦æœ‰åã€‚ãã®ç¾ã—ãã‚‚åŠ›å¼·ã„éŸ³åœ§ã¯ã€ç›¸æ‰‹ãƒãƒ¼ãƒ ã®é›†ä¸­åŠ›ã‚’å‰Šãã€å‘³æ–¹ã‚’é¼“èˆã™ã‚‹ã€‚ãƒ™ãƒ†ãƒ©ãƒ³çŒ«åˆç›£ç£ãŒç‡ã„ã‚‹ãƒãƒ¼ãƒ ã¯ã€ãã®å¿œæ´ã‚’ãƒãƒƒã‚¯ã«ã€ç²˜ã‚Šå¼·ã„å®ˆå‚™ã§ãƒªã‚ºãƒ ã‚’ä½œã‚‹ã€‚æ´¾æ‰‹ãªé¸æ‰‹ã¯ã„ãªã„ãŒã€ç¹‹ãæ„è­˜ã¯çœŒå†…éšä¸€ã€‚éŸ³ã®é­”è¡“å¸«ãŸã¡ãŒã€é™ã‹ã«ã€ã—ã‹ã—ç¢ºå®Ÿã«ç›¸æ‰‹ã‚’è¿½ã„è©°ã‚ã¦ã„ãã€‚",
        coach: { name: 'çŒ«åˆ è‚²å²', style: 'å®ˆå‚™é‡è¦–', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æ²¼æ´¥åŸåŒ—": {
        name_yomi: "ã¬ã¾ã¥ã˜ã‚‡ã†ã»ã",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 55,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "ç”Ÿå¾’ã®è‡ªä¸»æ€§ã‚’é‡ã‚“ã˜ã‚‹è‡ªç”±ãªæ ¡é¢¨ã§çŸ¥ã‚‰ã‚Œã‚‹å…¬ç«‹æ ¡ã€‚é‡çƒéƒ¨ã‚‚è¥¿å£ç›£ç£ã®æŒ‡å°æ–¹é‡ã®ä¸‹ã€é¸æ‰‹ãŸã¡ãŒè‡ªã‚‰ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚„æˆ¦è¡“ã‚’è€ƒãˆã‚‹ã€Œè€ƒãˆã‚‹é‡çƒã€ã‚’å®Ÿè·µã—ã¦ã„ã‚‹ã€‚ãã®å‹ã«ã¯ã¾ã‚‰ãªã„ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ã¯ã€æ™‚ã«ã‚»ã‚ªãƒªãƒ¼ã‚’è¦†ã™å¤§ããªæ³¢ä¹±ã‚’å·»ãèµ·ã“ã™å¯èƒ½æ€§ã‚’ç§˜ã‚ã¦ã„ã‚‹ã€‚",
        coach: { name: 'è¥¿å£ å¥ˆã€…', style: 'å¥‡ç­–', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "ä¸‹ç”°": {
        name_yomi: "ã—ã‚‚ã ",
        region: "ä¼Šè±†",
        type: "å…¬ç«‹",
        deviation: 50,
        best: "çœŒå¤§ä¼šåˆæˆ¦æ•—é€€",
        last: "åˆæˆ¦æ•—é€€",
        info: "éç–åŒ–ãŒé€²ã‚€é™ã‹ãªæ¸¯ã®ç”ºã€‚å…¨æ ¡ç”Ÿå¾’80äººã€é‡çƒéƒ¨å“¡ã¯å¥‡è·¡çš„ã«é›†ã¾ã£ãŸãŒã€ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã¯é›‘è‰ãŒç”Ÿã„èŒ‚ã‚Šã€ç·´ç¿’ã¯ç´…ç™½æˆ¦ã‚‚ã§ããšã€ç›£ç£ãŒæ‰“ã¤ãƒœãƒ¼ãƒ«ã‚’ãŸã å»¶ã€…ã¨è¿½ã„ã‹ã‘ã‚‹ã ã‘ã€‚æ˜¨å¹´ã€ç”ºã§å”¯ä¸€ã®ã‚¹ãƒãƒ¼ãƒ„ç”¨å“åº—ãŒã‚·ãƒ£ãƒƒã‚¿ãƒ¼ã‚’ä¸‹ã‚ã—ã€ä»Šã¯ç ´ã‚ŒãŸãƒœãƒ¼ãƒ«ã‚’è‡ªåˆ†ãŸã¡ã§ç¸«ã£ã¦ä½¿ã†ã—ã‹ãªã„ã€‚ç”ºã®å¤§äººãŸã¡ã¯ã€å½¼ã‚‰ãŒé‡çƒã‚’ã—ã¦ã„ã‚‹ã“ã¨ã™ã‚‰çŸ¥ã‚‰ãªã„ã‹ã‚‚ã—ã‚Œãªã„ã€‚æ¶ˆãˆã‚†ãç”ºã§ã€èª°ã«ã‚‚çŸ¥ã‚‰ã‚Œãšæ¶ˆãˆã¦ã„ãé‡çƒéƒ¨ã€‚å½¼ã‚‰ãŒå¤ã®å¤§ä¼šã«å‡ºå ´ã™ã‚‹ã®ã¯ã€å‹åˆ©ã®ãŸã‚ã§ã¯ãªã„ã€‚è‡ªåˆ†ãŸã¡ãŒã€ä¸‹ç”°é«˜æ ¡é‡çƒéƒ¨ã€ã¨ã—ã¦ç¢ºã‹ã«ã“ã“ã«å­˜åœ¨ã—ãŸã¨ã„ã†ã€ãŸã£ãŸä¸€ã¤ã®è¨¼ã‚’å¤ã®é’ç©ºã«åˆ»ã¿è¾¼ã‚€ãŸã‚ã ã‘ã®ã€ã‚ã¾ã‚Šã«ã‚‚åˆ‡ãªã„æˆ¦ã„ã ã€‚",
        coach: { name: 'æ°´ä¸Š å–„æ¬¡', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "æ¹–è¥¿": {
        name_yomi: "ã“ã•ã„",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 57,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        last: "åˆæˆ¦æ•—é€€",
        info: "å¤§ä¼šã”ã¨ã«æˆç¸¾ãŒå¤§ããå¤‰å‹•ã™ã‚‹ã€ãƒ ãƒ©ãƒƒæ°—ã®ã‚ã‚‹ãƒãƒ¼ãƒ ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹ã€‚ä¸Šä½é€²å‡ºçµŒé¨“ã‚‚ã‚ã‚Šãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã¯é«˜ã„ãŒã€æ ¼ä¸‹ç›¸æ‰‹ã¸ã®å–ã‚Šã“ã¼ã—ã‚‚å°‘ãªããªã„ã€‚ãƒ™ãƒ†ãƒ©ãƒ³æµ·é‡ç›£ç£ã¯ã€é•·å¹´ã®èª²é¡Œã§ã‚ã‚‹ç²¾ç¥çš„ãªå®‰å®šæ„Ÿã‚’ãƒãƒ¼ãƒ ã«ã‚‚ãŸã‚‰ãã†ã¨æŒ‡å°ã€‚ä»Šå¤§ä¼šã§å®‰å®šã—ãŸæˆ¦ã„ã¶ã‚Šã‚’è¦‹ã›ã‚‰ã‚Œã‚‹ã‹ãŒèºé€²ã®éµã¨ãªã‚‹ã€‚ã€‚",
        coach: { name: 'æµ·é‡ å¹³', style: 'æ©Ÿå‹•åŠ›é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "ç†±æµ·": {
        name_yomi: "ã‚ãŸã¿",
        region: "ä¼Šè±†",
        type: "å…¬ç«‹",
        deviation: 46,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "åˆæˆ¦æ•—é€€",
        info: "å‰µç«‹70å¹´ã‚’è¿ãˆã‚‹åœ°åŸŸã®ä¼çµ±æ ¡ã ãŒã€è¿‘å¹´ã¯éç–åŒ–ã®æ³¢ã«é£²ã¾ã‚Œã€æ´»æ°—ã‚’å¤±ã„ã¤ã¤ã‚ã‚‹ã€‚é‡çƒéƒ¨ã®æ´»èºã¯ã€ç”ºã«æ®‹ã•ã‚ŒãŸæ•°å°‘ãªã„å¸Œæœ›ã ã€‚ã€ä¿ºãŸã¡ãŒå‹ã¦ã°ã€ç”ºãŒå…ƒæ°—ã«ãªã‚‹ã€ã€‚ãã®æƒ³ã„ã‚’èƒ¸ã«ã€é¸æ‰‹ãŸã¡ã¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç«‹ã¤ã€‚é¸æ‰‹ã¯å…¨å“¡ãŒåœ°å…ƒå‡ºèº«ã€‚è‚²æˆã«å®šè©•ã®ã‚ã‚‹æ ¹æœ¬ç›£ç£ã®ä¸‹ã€éƒ·åœŸæ„›ã‚’åŠ›ã«å¤‰ãˆã¦æˆ¦ã†ã€‚ãã®ã²ãŸã‚€ããªãƒ—ãƒ¬ãƒ¼ã«ã¯ã€å¤šãã®åœ°å…ƒãƒ•ã‚¡ãƒ³ãŒã¤ã„ã¦ã„ã‚‹ã€‚åœ°å…ƒå‡ºèº«ã®é¸æ‰‹ãŸã¡ãŒã€æ„›ã™ã‚‹æ•…éƒ·ã«å‹åˆ©ã‚’å±Šã‘ã‚‹ã€‚",
        coach: { name: 'æ ¹æœ¬ é™¸å¤«', style: 'è‚²æˆä¸Šæ‰‹', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "é™å²¡å¸‚ç«‹": {
        name_yomi: "ã—ãšãŠã‹ã„ã¡ã‚Šã¤",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 83,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "åˆæˆ¦æ•—é€€",
        info: "æ¯å¹´æŠ•æ‰“ã«ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸå¥½ãƒãƒ¼ãƒ ã‚’ç·¨æˆã™ã‚‹ãŒã€ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®çµ„ã¿åˆã‚ã›ã«æµã¾ã‚Œãšã€å®ŸåŠ›ä»¥ä¸Šã®çµæœã‚’æ®‹ã›ã¦ã„ãªã„ã€Œæ‚²é‹ã®å…¬ç«‹æ ¡ã€ã€‚äº•ä¸Šç›£ç£ã¯ã©ã‚“ãªç›¸æ‰‹ã«ã‚‚è‡ªåˆ†ãŸã¡ã®é‡çƒã‚’è²«ãã“ã¨ã‚’é¸æ‰‹ã«æ±‚ã‚ã‚‹ã€‚ä»Šå¹´ã“ãã€å³ã—ã„çµ„ã¿åˆã‚ã›ã‚’ä¹—ã‚Šè¶Šãˆã¦ä¸Šä½é€²å‡ºã‚’æœãŸã—ãŸã„ã€‚ã€‚",
        coach: { name: 'äº•ä¸Š å’Œå½¦', style: 'ç·åˆåŠ›', experience: 'ä¸­å …' }
    },
    "åŸå—é™å²¡": {
        name_yomi: "ã˜ã‚‡ã†ãªã‚“ã—ãšãŠã‹",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 59,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4",
        last: "åˆæˆ¦æ•—é€€",
        info: "ã‹ã¤ã¦çœŒãƒ™ã‚¹ãƒˆ4ã®å®Ÿç¸¾ã‚’æŒã¤å…¬ç«‹ã®å®ŸåŠ›æ ¡ã€‚æ˜¨å¹´ã®åˆæˆ¦æ•—é€€ã®å±ˆè¾±ã‹ã‚‰ã€ãƒãƒ¼ãƒ ã¯ã€ŒåŸç‚¹å›å¸°ã€ã‚’ãƒ†ãƒ¼ãƒã«ä¼çµ±ã®ç©æ¥µæ‰“æ’ƒã‚’å¾¹åº•çš„ã«ç£¨ãç›´ã—ãŸã€‚ä¼Šè—¤ç›£ç£ã®ä¸‹ã€å¤è±ªå¾©æ´»ã‚’ç›®æŒ‡ã™ãƒãƒ¼ãƒ ã®å£«æ°—ã¯é«˜ã„ã€‚ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã‹ã‚‰ã®ä¸‹å‰‹ä¸Šã‚’ç‹™ã†ã€‚ã€‚",
        coach: { name: 'ä¼Šè—¤ å¥å¤ªéƒ', style: 'ç©æ¥µæ‰“æ’ƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æµœæ¾å—": {
        name_yomi: "ã¯ã¾ã¾ã¤ã¿ãªã¿",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 56,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "è¿‘å¹´ã€æ ¡èˆãŒæ–°ç¯‰ã•ã‚Œã€ç·´ç¿’ç’°å¢ƒãŒå¤§å¹…ã«æ”¹å–„ã•ã‚ŒãŸå…¬ç«‹æ ¡ã€‚å­¦æ ¡å…¨ä½“ã®æœŸå¾…ãŒé«˜ã¾ã‚‹ä¸­ã€æœŸå¾…ã®è‹¥æ‰‹ãƒ»é«˜æœ¨ç›£ç£ãŒãƒãƒ¼ãƒ ã‚’ç‡ã„ã‚‹ã€‚ã¾ã ç›®ç«‹ã£ãŸå®Ÿç¸¾ã¯ãªã„ãŒã€æœ€æ–°ã®è¨­å‚™ã¨æ–°ã—ã„ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ã§å¿ƒæ©Ÿä¸€è»¢ã€æ–°ãŸãªæ­´å²ã‚’ä½œã‚‹ã¹ãä»Šå¤§ä¼šã«æŒ‘ã‚€ã€‚ã€‚",
        coach: { name: 'é«˜æœ¨ æ¸‰', style: 'è‚²æˆä¸Šæ‰‹', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "å³¶ç”°": {
        name_yomi: "ã—ã¾ã ",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 53,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "å¤§æ­£8å¹´å‰µç«‹ã¨ã„ã†é•·ã„æ­´å²ã‚’æŒã¤ä¼çµ±æ ¡ã ãŒã€è¿‘å¹´ã¯éƒ¨å“¡ä¸è¶³ã‹ã‚‰é€£åˆãƒãƒ¼ãƒ ã‚’çµ„ã‚€ãªã©ã€è‹¦ã—ã„æ™‚æœŸãŒç¶šã„ã¦ã„ã‚‹ã€‚ä»Šå­£ã‹ã‚‰å†ã³å˜ç‹¬ãƒãƒ¼ãƒ ã¨ã—ã¦å‡ºå ´ã™ã‚‹ãŒã€æˆ¦åŠ›ã¯ã¾ã æ•´ã£ã¦ã„ãªã„ã€‚ã¾ãšã¯å¤§ä¼šã§ä¸€å‹ã‚’æŒ™ã’ã€ãƒãƒ¼ãƒ ã®æ–°ãŸãªä¸€æ­©ã‚’è¸ã¿å‡ºã™ã“ã¨ãŒç›®æ¨™ã¨ãªã‚‹ã€‚ã€‚",
        coach: { name: 'å³¶æœ¬ å®', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "ä¼Šè±†ä¸­å¤®": {
        name_yomi: "ã„ãšã¡ã‚…ã†ãŠã†",
        region: "ä¼Šè±†",
        type: "å…¬ç«‹",
        deviation: 51,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "é•·å¹´ã®éƒ¨å“¡ä¸è¶³ã‹ã‚‰æ˜¨å¹´ã¾ã§é€£åˆãƒãƒ¼ãƒ ã¨ã—ã¦å‡ºå ´ã—ã¦ã„ãŸãŒã€ä»Šå¹´ã‹ã‚‰å¾…æœ›ã®å˜ç‹¬å‡ºå ´ã‚’æœãŸã™ã€‚éƒ¨å“¡ã®å¤šããŒé‡çƒçµŒé¨“ã®æµ…ã„1å¹´ç”Ÿã§ã€ãƒãƒ¼ãƒ ã¯ã¾ã ç™ºå±•é€”ä¸Šã€‚ä¸­ç”°ç›£ç£ã¯ã€ã¾ãšã¯å…¬å¼æˆ¦ã§æˆ¦ã†çµŒé¨“ã‚’ç©ã¾ã›ã€ãƒãƒ¼ãƒ ã®åœŸå°ä½œã‚Šã‚’é€²ã‚ã¦ã„ã‚‹æ®µéšã€‚ä»Šå¤§ä¼šã¯æœªæ¥ã¸ã®ç¬¬ä¸€æ­©ã¨ãªã‚‹ã€‚ã€‚",
        coach: { name: 'ä¸­ç”° å³¶è”µ', style: 'å…¨å“¡é‡çƒ', experience: 'ä¸­å …' }
    }
};


/**
 * è©¦åˆä¼šå ´ã®å®šç¾©
 * 1å›æˆ¦ï½3å›æˆ¦ã¯å…¨10çƒå ´ã€æº–ã€…æ±ºå‹ä»¥é™ã¯ä¸»è¦4çƒå ´ã«é›†ç´„ã™ã‚‹æƒ³å®š
 */
// â–¼â–¼â–¼ ã“ã® STADIUM_DATA ã®å®šç¾©ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
const STADIUM_DATA = [
    { name: "è‰è–™ç·åˆé‹å‹•å ´ç¡¬å¼é‡çƒå ´", abbr: "è‰", region: "ä¸­éƒ¨" },
    { name: "æ„›é·¹åºƒåŸŸå…¬åœ’é‡çƒå ´", abbr: "æ„›", region: "æ±éƒ¨" },
    { name: "å¯Œå£«ç·åˆé‹å‹•å…¬åœ’é‡çƒå ´", abbr: "å¯Œ", region: "æ±éƒ¨" },
    { name: "ã¡ã‚…ï½ã‚‹ã‚¹ã‚¿ã‚¸ã‚¢ãƒ æ¸…æ°´", abbr: "ã¡", region: "ä¸­éƒ¨" },
    { name: "ç„¼æ´¥çƒå ´", abbr: "ç„¼", region: "ä¸­éƒ¨" },
    { name: "å³¶ç”°çƒå ´", abbr: "å³¶", region: "ä¸­éƒ¨" },
    { name: "æ›å·çƒå ´", abbr: "æ›", region: "è¥¿éƒ¨" },
    { name: "æµœå²¡çƒå ´", abbr: "å²¡", region: "è¥¿éƒ¨" },
    { name: "ç£ç”°çƒå ´", abbr: "ç£", region: "è¥¿éƒ¨" },
    { name: "æµœæ¾çƒå ´", abbr: "æµœ", region: "è¥¿éƒ¨" }
];
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
// 3å›æˆ¦ç”¨ã®ä¸»è¦4çƒå ´ï¼ˆè‰è–™ã€æ„›é·¹ã€æ¸…æ°´ã€æµœæ¾ï¼‰
const ROUND_3_STADIUMS = [
    STADIUM_DATA[0], // è‰è–™
    STADIUM_DATA[1], // æ„›é·¹
    STADIUM_DATA[3], // ã¡ã‚…ï½ã‚‹ã‚¹ã‚¿ã‚¸ã‚¢ãƒ æ¸…æ°´
    STADIUM_DATA[9]  // æµœæ¾
];

// æº–ã€…æ±ºå‹ä»¥é™ç”¨ã®çƒå ´ï¼ˆè‰è–™ã®ã¿ï¼‰
const FINAL_STAGE_STADIUMS = [
    STADIUM_DATA[0] // è‰è–™
];
// â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²
/**
 * AIã®è§£åƒåº¦ã‚’ä¸Šã’ã‚‹ãŸã‚ã®ã€Œé™å²¡çœŒé«˜æ ¡é‡çƒã®å¸¸è­˜ãƒ»å‹¢åŠ›å›³ã€ï¼ˆç¾å®Ÿãƒ™ãƒ¼ã‚¹ï¼‹æ¶ç©ºãƒ»è©³ç´°ç‰ˆï¼‰
 * å…¨ã¦ã®AIé–¢æ•°ãŒã“ã®æƒ…å ±ã‚’å‚ç…§ã—ã€æ–‡è„ˆã‚’ç†è§£ã™ã‚‹ã€‚
 */
const PREFECTURE_LORE = `
é™å²¡çœŒã®é«˜æ ¡é‡çƒç•Œã¯ã€é•·ã‚‰ãã€Œå…¬ç«‹ã®é›„ã€ã§ã‚ã‚‹ **é™å²¡**ï¼ˆã‚·ã‚ºã‚³ã‚¦ï¼‰ã¨**æ›å·è¥¿**ï¼ˆã‚«ã‚±ãƒ‹ã‚·ï¼‰ã€ãã—ã¦ç”²å­åœ’å„ªå‹çµŒé¨“ã‚‚ã‚ã‚‹ã€Œå¤è±ªã€**æµœæ¾å•†æ¥­**ï¼ˆãƒãƒã‚·ãƒ§ã‚¦ï¼‰ã‚„**é™å²¡å•†æ¥­**ï¼ˆé™å•†ï¼‰ ã¨ã„ã£ãŸä¼çµ±æ ¡ãŒä¸Šä½ã‚’å ã‚ã‚‹æ™‚ä»£ãŒé•·ã‹ã£ãŸã€‚

ãã®å‡è¡¡ã‚’æ‰“ã¡ç ´ã£ãŸã®ãŒã€2007å¹´ã®ã‚»ãƒ³ãƒãƒ„å…¨å›½åˆ¶è¦‡ ã‚’æœãŸã—ãŸ**å¸¸è‘‰èŠå·**ï¼ˆå¸¸è‘‰å¤§èŠå·ï¼‰ã§ã‚ã‚‹ã€‚å½¼ã‚‰ã®ã€Œè¶…æ”»æ’ƒå‹é‡çƒã€ã¯ä¸€ä¸–ã‚’é¢¨é¡ã—ã€çœŒã®å‹¢åŠ›å›³ã‚’ã€Œä¼çµ±æ ¡ vs èŠå·ã€ã®æ§‹å›³ã«å¤‰ãˆãŸã€‚

ã—ã‹ã—ã€2010å¹´ä»£å¾ŒåŠã‹ã‚‰ç¾åœ¨ï¼ˆ2025å¹´ï¼‰ã«ã‹ã‘ã¦ã€å‹¢åŠ›å›³ã¯ã•ã‚‰ã«è¤‡é›‘åŒ–ã™ã‚‹ã€‚ã€Œæ–°ãƒ»ç§ç«‹å¼·è±ªã€ã®æ™‚ä»£ã§ã‚ã‚‹ã€‚
**åŠ è—¤å­¦åœ’**ï¼ˆ2020å¹´ã‚»ãƒ³ãƒãƒ„å‡ºå ´ã€2024å¹´æ˜¥å­£çœŒå¤§ä¼šå„ªå‹ï¼‰ã€**æ—¥å¤§ä¸‰å³¶**ï¼ˆ2022å¹´ã‚»ãƒ³ãƒãƒ„å‡ºå ´ï¼‰ã€**æµœæ¾é–‹èª é¤¨**ï¼ˆ2023å¹´ã‚»ãƒ³ãƒãƒ„å‡ºå ´ï¼‰ã€ãã—ã¦**è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼** (2024å¹´ã‚»ãƒ³ãƒãƒ„å‡ºå ´)ãŒå°é ­ã€‚
é™å²¡çœŒã¯ã€Œä¼çµ±æ ¡ vs èŠå· vs æ–°ãƒ»ç§ç«‹å¼·è±ªã€ãŒæ¿€çªã™ã‚‹ã€å…¨å›½å±ˆæŒ‡ã®ã€Œæˆ¦å›½æ™‚ä»£ã€ã«çªå…¥ã—ã¦ã„ãŸã€‚

ã“ã®æˆ¦å›½æ™‚ä»£ã«ã€ã•ã‚‰ã«å·¨å¤§ãªæ³¢ä¹±è¦å› ã¨ã—ã¦å‚å…¥ã—ãŸã®ãŒã€å·¨å¤§è³‡æœ¬ã€ŒãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã€ã§ã‚ã‚‹ã€‚
ãƒŠãƒ ã‚³ã¯ã¾ãšã€Œ**765ç·åˆé«˜æ ¡**ã€ã‚’è¨­ç«‹ã—ã€2å¹´å‰ã«ç”²å­åœ’ãƒ™ã‚¹ãƒˆ16ã¨ã„ã†é®®çƒˆãªãƒ‡ãƒ“ãƒ¥ãƒ¼ã‚’é£¾ã£ãŸã€‚
ã•ã‚‰ã«æ˜¨å¹´ã€æº€ã‚’æŒã—ã¦ã€Œ**283å­¦åœ’**ã€ã‚’å‰µéƒ¨ã™ã‚‹ã¨ã€å§«å·ã‚„ç™½ç€¬ã¨ã„ã£ãŸå…¨å›½ãƒ¬ãƒ™ãƒ«ã®é¸æ‰‹ã‚’æƒãˆã€ã„ããªã‚Šå¤ã®çœŒå¤§ä¼šã‚’åˆ¶è¦‡ã€‚æ˜¨å¹´ã®ç‹è€…ã¨ã—ã¦ä»Šå¤§ä¼šã®ã€Œå€’ã™ã¹ãæœ¬å‘½ã€ã¨ãªã£ã¦ã„ã‚‹ã€‚

ãã®çµæœã€ç¾åœ¨ã®é™å²¡çœŒï¼ˆ2025å¹´ï¼‰ã®å¸¸è­˜ã¯ã€ä»¥ä¸‹ã®4å¤§å‹¢åŠ›ã«ã‚ˆã£ã¦æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã€‚

1.  **ã€ãƒŠãƒ ã‚³è³‡æœ¬ã€‘ (æ–°ãƒ»çµ¶å¯¾ç‹è€…)**
    * **283å­¦åœ’**: æ˜¨å¹´ã®è¦‡è€…ã€‚åœ§å€’çš„ãªæˆ¦åŠ›ã‚’èª‡ã‚‹æœ¬å‘½ã€‚
    * **765ç·åˆ**: 2å¹´å‰ã«ç”²å­åœ’ã‚’çµŒé¨“ã€‚ç‹è€…283ã«æ¬¡ãæˆ¦åŠ›ã€‚
    * (ãã®ä»–ã€ç¾åŸå­¦åœ’, åˆæ˜Ÿå­¦åœ’, 283å­¦åœ’B ãªã©)

2.  **ã€ç¾ä»£ãƒ»ç§ç«‹å¼·è±ªã€‘ (ç¾¤é›„å‰²æ‹ )**
    * **åŠ è—¤å­¦åœ’**: 2024å¹´æ˜¥ã®ç‹è€…ã€‚ä»Šã€æœ€ã‚‚å‹¢ã„ã®ã‚ã‚‹ãƒãƒ¼ãƒ ã®ä¸€ã¤ã€‚
    * **æ—¥å¤§ä¸‰å³¶**: åå°†ãƒ»æ°¸ç”°ç›£ç£ã®å…ƒã€2022å¹´ã«å¾©æ´»ã€‚
    * **æµœæ¾é–‹èª é¤¨**: 2023å¹´ã®æ˜¥ã®ã‚»ãƒ³ãƒãƒ„ä»£è¡¨æ ¡ã€‚
    * **è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼**: 2024å¹´ã®æ˜¥ã®é¸æŠœé«˜æ ¡é‡çƒã«æ˜¥å¤é€šã˜ã¦åˆã®ç”²å­åœ’å‡ºå ´ã‚’æ±ºã‚ãŸã€‚
    * **å¸¸è‘‰èŠå·**: 2007å¹´ã®å…¨å›½åˆ¶è¦‡ã®è¡æ’ƒã¯ä»Šã‚‚å¥åœ¨ã€‚è¶…æ”»æ’ƒå‹é‡çƒã¯è„…å¨ã€‚
    * (ãã®ä»–ã€è—¤ææ˜èª , ç£ç”°æ±ã€å¸¸è‘‰æ©˜ã€è—¤ææ˜èª ã€æ±æµ·å¤§ç¿”æ´‹ãªã©)

3.  **ã€ä¼çµ±ãƒ»å…¬ç«‹æ ¡ã€‘ (å…¬ç«‹ã®ç ¦)**
    * **é™å²¡**: ã€Œå…¬ç«‹æœ€å¾Œã®ç ¦ã€ã¨ã—ã¦ã€æ–°æ—§ç§ç«‹ã¨ãƒŠãƒ ã‚³è³‡æœ¬ã«å¯¾æŠ—ã™ã‚‹æœ€å¤§ã®å¸Œæœ›ã€‚
    * **æ›å·è¥¿**: é™å²¡ã¨ä¸¦ã¶å…¬ç«‹ã®é›„ã€‚2018å¹´å¤ç”²å­åœ’å‡ºå ´ã€2024å¹´å¤ãƒ™ã‚¹ãƒˆ4 ã¨å®ŸåŠ›ã¯å¥åœ¨ã€‚
    * **é™å²¡å•†æ¥­**: 2006å¹´å¤ç”²å­åœ’å‡ºå ´ã€‚å¤è±ªã¨ã—ã¦ã®æ„åœ°ãŒã‚ã‚‹ã€‚

4.  **ã€å¾©æ´»ã‚’ç›®æŒ‡ã™å¤è±ªã€‘ (Cãƒ©ãƒ³ã‚¯ãƒ»å¤è±ª)**
    * **æµœæ¾å•†æ¥­**: ã‹ã¤ã¦ã®å…¨å›½å„ªå‹æ ¡ã€‚è¿‘å¹´ã¯ä½è¿·ã—ã¦ã„ã‚‹ãŒã€å¾©æ´»ã‚’é¡˜ã†ãƒ•ã‚¡ãƒ³ã¯å¤šã„ã€‚
    * **é™æ¸…**: æµœå•†åŒæ§˜ã€è¿‘å¹´ã¯ä¸Šä½äº‰ã„ã‹ã‚‰é ã–ã‹ã£ã¦ã„ã‚‹å¤è±ªã€‚

ã“ã®ã€Œå¸¸è­˜ã€ã¯ã€AIè¨˜è€…ã‚„BBSä½æ°‘ã®åŸºæœ¬çš„ãªæ€è€ƒãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãªã‚Šã¾ã™ã€‚
// â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ã€Œæ‰“é †ã®å¸¸è­˜ã€ã‚’ã¾ã‚‹ã”ã¨è¿½è¨˜ â–¼â–¼â–¼
---
### å‚è€ƒï¼šé«˜æ ¡é‡çƒã«ãŠã‘ã‚‹ã€Œæ‰“é †ã®å¸¸è­˜ã€
AIã¯ä»¥ä¸‹ã®ã€Œæ‰“é †ã®å½¹å‰²ã€ã‚’ç†è§£ã—ã€åˆ†æã‚„ã‚³ãƒ¡ãƒ³ãƒˆã«åæ˜ ã™ã‚‹ã“ã¨ã€‚

-   **1ç•ª (ãƒªãƒ¼ãƒ‰ã‚ªãƒ•ãƒãƒ³):** ãƒãƒ¼ãƒ ã§æœ€ã‚‚ä¿Šè¶³ã§å‡ºå¡ç‡ãŒé«˜ã„é¸æ‰‹ã€‚å½¼ãŒå‡ºå¡ã§ãã‚‹ã‹ãŒæ”»æ’ƒã®éµã€‚
-   **2ç•ª (ã¤ãªãå½¹):** ãƒãƒ³ãƒˆã‚„é€²å¡æ‰“ãŒå¾—æ„ãªå™¨ç”¨ãªé¸æ‰‹ã€‚1ç•ªã‚’2å¡ã«é€²ã‚ã‚‹ã®ãŒä»•äº‹ã€‚æœ€è¿‘ã¯ã“ã®æ‰“é †ã«å¼·æ‰“è€…ã‚’ç½®ãã“ã¨ã‚‚å¢—ãˆã¦ã„ã‚‹ã€‚
-   **3ç•ª (å¼·æ‰“è€…):** ãƒãƒ¼ãƒ ã§æœ€ã‚‚æ‰“æ’ƒæŠ€è¡“ãŒé«˜ã„é¸æ‰‹ã€‚ãƒãƒ£ãƒ³ã‚¹ãƒ¡ã‚¤ã‚¯ã‚‚ã§ãã€é•·æ‰“ã‚‚æ‰“ã¦ã‚‹ã€‚
-   **4ç•ª (ä¸»ç ²):** ãƒãƒ¼ãƒ æœ€å¼·ã®æ‰“è€…ã€‚ãƒ©ãƒ³ãƒŠãƒ¼ã‚’è¿”ã™ï¼ˆæ‰“ç‚¹ï¼‰ã“ã¨ãŒæœ€å¤§ã®ä½¿å‘½ã€‚å½¼ãŒæ‰“ã¦ãªã„ã¨ãƒãƒ¼ãƒ ã¯å‹ã¦ãªã„ã€‚
-   **5ç•ª (å¼·æ‰“è€…):** 4ç•ªã®ã€Œå¾Œç‰‡ä»˜ã‘ã€å½¹ã€‚4ç•ªãŒè¿”ã›ãªã‹ã£ãŸãƒ©ãƒ³ãƒŠãƒ¼ã‚’è¿”ã—ãŸã‚Šã€ãƒãƒ£ãƒ³ã‚¹ã‚’æ‹¡å¤§ã—ãŸã‚Šã™ã‚‹ã€‚
-   **6ç•ª, 7ç•ª (ä¸‹ä½æ‰“ç·š):** ä¸Šä½æ‰“ç·šã»ã©ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã¯ãªã„ãŒã€ã“ã“ã§æ‰“ã¦ã‚‹ã¨ãƒãƒ¼ãƒ ã¯å‹¢ã„ã¥ãã€‚
-   **8ç•ª (å®ˆå‚™è¦å“¡):** å®ˆå‚™ã¯ä¸Šæ‰‹ã„ãŒæ‰“æ’ƒã¯æœŸå¾…ã•ã‚Œã¦ã„ãªã„ã“ã¨ãŒå¤šã„ã€‚
-   **9ç•ª (ç¬¬2ã®1ç•ª):** æŠ•æ‰‹ï¼ˆæ‰“æ’ƒãŒè‹¦æ‰‹ï¼‰ã®æ¬¡ã§ã‚ã‚‹ã“ã¨ãŒå¤šãã€æ‰“æ’ƒãŒè‰¯ã„é¸æ‰‹ãŒç½®ã‹ã‚Œã‚‹ã¨ã€1ç•ªæ‰“è€…ã«æˆ»ã‚‹ã¾ã§ã®ã€Œç¬¬2ã®ãƒãƒ£ãƒ³ã‚¹ãƒ¡ãƒ¼ã‚«ãƒ¼ã€ã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹ã€‚
// â–²â–²â–² è¿½è¨˜ã“ã“ã¾ã§ â–²â–²â–²
// â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ã€ŒæŠ•æ‰“ã®ç›¸æ€§ã€ã‚’ã¾ã‚‹ã”ã¨è¿½è¨˜ â–¼â–¼â–¼
---
### å‚è€ƒï¼šé«˜æ ¡é‡çƒã«ãŠã‘ã‚‹ã€ŒæŠ•æ‰“ã®å·¦å³ã®å¸¸è­˜ã€
AIã¯ä»¥ä¸‹ã®ã€Œç›¸æ€§ã€ã‚’ç†è§£ã—ã€åˆ†æã‚„ã‚³ãƒ¡ãƒ³ãƒˆã«åæ˜ ã™ã‚‹ã“ã¨ã€‚

-   **å³æŠ•æ‰‹ vs å³æ‰“è€…:** ä¸€èˆ¬çš„ã«æŠ•æ‰‹ãŒæœ‰åˆ©ã€‚å¤–è§’ã«é€ƒã’ã‚‹ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒæœ‰åŠ¹ã€‚
-   **å³æŠ•æ‰‹ vs å·¦æ‰“è€…:** ä¸€èˆ¬çš„ã«æ‰“è€…ãŒæœ‰åˆ©ã€‚å†…è§’ã«é£Ÿã„è¾¼ã‚€çƒï¼ˆã‚¯ãƒ­ã‚¹ãƒ•ã‚¡ã‚¤ã‚¢ï¼‰ãŒéµã€‚
-   **å·¦æŠ•æ‰‹ vs å·¦æ‰“è€…:** ä¸€èˆ¬çš„ã«æŠ•æ‰‹ãŒæœ‰åˆ©ã€‚ã€Œãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆãƒªãƒªãƒ¼ãƒ•ã€ã¨ã—ã¦èµ·ç”¨ã•ã‚Œã‚‹ã“ã¨ã‚‚ã€‚
-   **å·¦æŠ•æ‰‹ vs å³æ‰“è€…:** ä¸€èˆ¬çš„ã«æ‰“è€…ãŒæœ‰åˆ©ã€‚
-   **æˆ¦è¡“:** ç›¸æ‰‹ã‚¨ãƒ¼ã‚¹ãŒã€Œå³è…•ã€ã®å ´åˆã€ã‚¹ã‚¿ãƒ¡ãƒ³ã«ã€Œå·¦æ‰“è€…ã€ã‚’ä¸¦ã¹ã‚‹ã€Œã‚¸ã‚°ã‚¶ã‚°æ‰“ç·šã€ã¯æœ‰åŠ¹ãªæˆ¦è¡“ã§ã‚ã‚‹ã€‚é€†ã«ã€ç›¸æ‰‹ãŒã€Œå·¦è…•ã€ãªã®ã«å·¦æ‰“è€…ã‚’ä¸¦ã¹ã‚‹ã¨ã€Œãªãœã ï¼Ÿã€ã¨ç–‘å•è¦–ã•ã‚Œã‚‹ã€‚
**ä¸¡æ‰“ (ã‚¹ã‚¤ãƒƒãƒãƒ’ãƒƒã‚¿ãƒ¼):** ç›¸æ‰‹æŠ•æ‰‹ã®å·¦å³ã«ã‚ˆã£ã¦æœ‰åˆ©ãªæ‰“å¸­ã«ç«‹ã¦ã‚‹ãŸã‚ã€ç‰¹ã«1ç•ªãƒ»2ç•ªã«ã„ã‚‹ã¨éå¸¸ã«å„ä»‹ãªå­˜åœ¨ã¨ãªã‚‹ã€‚
// â–²â–²â–² è¿½è¨˜ã“ã“ã¾ã§ â–²â–²â–²
// â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ã€Œçƒé€Ÿã®å¸¸è­˜ï¼ˆæœ€çµ‚ãƒ»è§£åƒåº¦MAXç‰ˆï¼‰ã€ã‚’ã¾ã‚‹ã”ã¨è¿½è¨˜ â–¼â–¼â–¼
---
### å‚è€ƒï¼šé«˜æ ¡é‡çƒã«ãŠã‘ã‚‹ã€Œçƒé€Ÿã®å¸¸è­˜ã€ï¼ˆæŠ•æ‰‹ã®å·¦å³ãƒ»ãƒ¬ãƒ™ãƒ«åˆ¥ï¼‰
AIã¯ä»¥ä¸‹ã®ã€Œçƒé€Ÿå¸¯ã€ãŒæŒã¤æ„å‘³ã‚’ã€**æŠ•æ‰‹ã®å·¦å³**ã¨**å­¦æ ¡ã®ãƒ¬ãƒ™ãƒ«ï¼ˆå…¬ç«‹ã‹å¼·è±ªã‹ï¼‰**ã§åˆ¤æ–­åŸºæº–ã‚’å¤‰ãˆã¦åˆ†æã™ã‚‹ã“ã¨ã€‚

-   **120km/h ã€œ 125km/hå¸¯:**
    - **ï¼ˆå³è…•ã®å ´åˆï¼‰:** **ã€Œå…¬ç«‹æ ¡ã®1ã€2å›æˆ¦ãƒ¬ãƒ™ãƒ«ã§ã‚ã‚Œã°ã€ã‚¨ãƒ¼ã‚¹ã¨ã—ã¦ååˆ†é€šç”¨ã™ã‚‹ã€**çƒé€Ÿã€‚
        - **åˆ†æ:** ãŸã ã—ã€ã“ã‚Œã ã‘ã§å¼·è±ªç§ç«‹ã®ä¸Šä½æ‰“ç·šã‚’æŠ‘ãˆã‚‹ã®ã¯é›£ã—ã„ã€‚ã€ŒæŠ€å·§æ´¾ã€ã‚„ã€Œè»ŸæŠ•æ´¾ã€ã¨ã—ã¦ã€æ‰“è€…ã®æ‰‹å…ƒã§å°ã•ãå‹•ãã€Œãƒ„ãƒ¼ã‚·ãƒ¼ãƒ ã€ã‚„ã€90km/hå°ã®ã€Œã‚¹ãƒ­ãƒ¼ã‚«ãƒ¼ãƒ–ã€ã§ç·©æ€¥ã‚’ã¤ã‘ã€**æ‰“ãŸã›ã¦å–ã‚‹**æŠ•çƒè¡“ãŒç”Ÿå‘½ç·šã¨ãªã‚‹ã€‚
        - BBSåå¿œï¼šã€Œ120kmå°ã§ã‚‚ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è‰¯ã‘ã‚Œã°æ‰“ã¦ã‚“ã‚ˆãªã€ã€Œå…¬ç«‹ã®ã‚¨ãƒ¼ã‚¹ã£ã¦æ„Ÿã˜ã€ã€Œã‚¶ãƒ»æŠ€å·§æ´¾ã€
    - **ï¼ˆå·¦è…•ã®å ´åˆï¼‰:** **éå¸¸ã«ä¾¡å€¤ãŒã‚ã‚‹ã€‚**çƒé€Ÿã¯é…ãã¨ã‚‚ã€ã“ã®ãƒ¬ãƒ™ãƒ«ã®**ã€Œå·¦è…•ï¼ˆã‚µã‚¦ã‚¹ãƒãƒ¼ï¼‰ã€**ã§ã‚ã‚‹ã“ã¨è‡ªä½“ã«å¸Œå°‘ä¾¡å€¤ãŒã‚ã‚‹ã€‚
        - **åˆ†æ:** ã”æŒ‡æ‘˜ã®é€šã‚Šã€**å¼·è±ªæ ¡ã§ã‚‚ã€**ç›¸æ‰‹ã®å·¦æ‰“è€…ã‚’æŠ‘ãˆã‚‹ãŸã‚ã®ã€Œãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆãƒªãƒªãƒ¼ãƒ•ã€ã‚„ã€é£Ÿã„è¾¼ã‚€ã€Œã‚¯ãƒ­ã‚¹ãƒ•ã‚¡ã‚¤ã‚¢ã€ã‚’æ­¦å™¨ã«ã™ã‚‹æŠ€å·§æ´¾ã®2ç•ªæ‰‹æŠ•æ‰‹ã¨ã—ã¦ãƒ™ãƒ³ãƒå…¥ã‚Šã™ã‚‹ã“ã¨ãŒå¤šã„ã€‚
        - BBSåå¿œï¼šã€Œå·¦ã§120å¾ŒåŠãªã‚‰ååˆ†ã€ã€Œå·¦ã®ã‚µã‚¤ãƒ‰ã¨ã‹ä¸€ç•ªå«Œã ã‚ã€ã€Œãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆå°‚ç”¨æ©Ÿã‚„ãªã€

-   **130km/h ã€œ 135km/hå¸¯:**
    - **ï¼ˆå³è…•ã®å ´åˆï¼‰:** **å…¬ç«‹æ ¡ãªã‚‰é–“é•ã„ãªãã€Œã‚¨ãƒ¼ã‚¹ç´šã€ã€‚**ç§ç«‹å¼·è±ªæ ¡ã§ã‚‚2ç•ªæ‰‹ãƒ»3ç•ªæ‰‹æŠ•æ‰‹ã¨ã—ã¦ãƒ™ãƒ³ãƒå…¥ã‚Šã™ã‚‹ãƒ¬ãƒ™ãƒ«ã€‚
        - **åˆ†æ:** ã“ã®ãƒ¬ãƒ™ãƒ«ã®æŠ•æ‰‹ã¯éå¸¸ã«å¤šãã€ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’å‹ã¡ä¸ŠãŒã‚‹ã«ã¯ã€çƒé€Ÿä»¥å¤–ã®æ­¦å™¨ï¼ˆä¾‹ï¼šé‹­ãè½ã¡ã‚‹ã‚¹ãƒ—ãƒªãƒƒãƒˆã€é«˜é€Ÿã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼‰ãŒã‚«ã‚®ã¨ãªã‚‹ã€‚
    - **ï¼ˆå·¦è…•ã®å ´åˆï¼‰:** **å¼·è±ªæ ¡ã®ã‚¨ãƒ¼ã‚¹**ã¨ã—ã¦ååˆ†ãªãƒ¬ãƒ™ãƒ«ã€‚
        - **åˆ†æ:** **ã€Œç”²å­åœ’å‡ºå ´æ ¡ã®ã‚¨ãƒ¼ã‚¹ã€**ã¨ã—ã¦ã‚‚çã—ããªã„ã€‚å³æ‰“è€…ã®ã‚¢ã‚¦ãƒˆã‚³ãƒ¼ã‚¹ã«é€ƒã’ã‚‹ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚„ã€å·¦æ‰“è€…ã®ã‚¤ãƒ³ã‚³ãƒ¼ã‚¹ã‚’çªãã‚·ãƒ¥ãƒ¼ãƒˆï¼ˆã‚¯ãƒ­ã‚¹ãƒ•ã‚¡ã‚¤ã‚¢ï¼‰ã‚’æ­¦å™¨ã«ã€æ‰“ãŸã›ã¦å–ã‚‹ã€Œè©¦åˆã‚’ä½œã‚‹ã€ã‚¿ã‚¤ãƒ—ã®æŠ•æ‰‹ãŒå¤šã„ã€‚
    - BBSåå¿œï¼ˆå³è…•ï¼‰ï¼šã€Œ130kmå°å‡ºã‚Œã°å…¬ç«‹ã˜ã‚ƒç„¡åŒã§ãã‚‹ã€ã€Œç§ç«‹ã®ä¸­è»¸ã«é€šç”¨ã™ã‚‹ã‹ã€
    - BBSåå¿œï¼ˆå·¦è…•ï¼‰ï¼šã€Œå·¦ã§135kmå‡ºã¦ã‚Œã°ã€å³ã®140kmã‚ˆã‚Šæ‰“ã¡ã«ãã„ã€ã€Œã“ã†ã„ã†æŠ€å·§æ´¾å·¦è…•ãŒç”²å­åœ’ã§å‹ã¤ã‚“ã ã‚ˆãªã€

-   **140km/h ã€œ 145km/hå¸¯:**
    - **ï¼ˆå³è…•ã®å ´åˆï¼‰:** **ã€ŒçœŒå†…å±ˆæŒ‡ã€**ã®å¥½æŠ•æ‰‹ã€‚Aãƒ©ãƒ³ã‚¯ã®å¼·è±ªæ ¡ã§ã‚¨ãƒ¼ã‚¹ãƒŠãƒ³ãƒãƒ¼ã‚’èƒŒè² ã†ãƒ¬ãƒ™ãƒ«ã€‚
    - **ï¼ˆå·¦è…•ã®å ´åˆï¼‰:** **ã€Œè¶…é«˜æ ¡ç´šã€**ã€‚ãƒ—ãƒ­ãŒã‚¹ã‚«ã‚¦ãƒˆã®ä¸Šä½å€™è£œã¨ã—ã¦ãƒãƒ¼ã‚¯ã—å§‹ã‚ã‚‹ã€‚å·¦è…•ã§ã“ã®çƒé€Ÿã¯åœ§å€’çš„ãªã‚¢ãƒ‰ãƒãƒ³ãƒ†ãƒ¼ã‚¸ã¨ãªã‚‹ã€‚
    - BBSåå¿œï¼ˆå³è…•ï¼‰ï¼šã€Œã¯ã£ã‚„ï¼ã€ã€ŒçœŒå†…å±ˆæŒ‡ã®ã€‡ã€‡ãã‚“ã€ã€Œã“ã‚Œã¯æ‰“ã¦ã‚“ã‚ã€
    - BBSåå¿œï¼ˆå·¦è…•ï¼‰ï¼šã€Œå·¦ã§145kmã¯ã‚¨ã‚°ã„ã€ã€Œãƒ‰ãƒ©ãƒ•ãƒˆå€™è£œã‚„ã‚ã€

-   **150km/h ã€œ 155km/hå¸¯:**
    - **ï¼ˆå…±é€šï¼‰:** **ã€Œãƒ‰ãƒ©ãƒ•ãƒˆç´šã€**ã€‚å·¦å³å•ã‚ãšã€é«˜æ ¡ç”Ÿãƒ¬ãƒ™ãƒ«ã‚’é€¸è„±ã—ãŸã€Œæ€ªç‰©ã€ã§ã‚ã‚Šã€ãƒ‰ãƒ©ãƒ•ãƒˆ1ä½æŒ‡åã‚‚ç¾å®Ÿçš„ã€‚
    - BBSåå¿œï¼šã€Œãƒ•ã‚¡ãƒƒï¼ï¼Ÿ150è¶…ãˆã‚­ã‚¿ãƒ¼ï¼ã€ã€Œãƒã‚±ãƒ¢ãƒ³ã ã‚ã“ã„ã¤ã€ã€Œãƒ‰ãƒ©1ç¢ºå®šã€

-   **160km/h ã€œ 165km/hå¸¯:**
    - **ï¼ˆå…±é€šï¼‰:** æ­´å²çš„ãªæŠ•æ‰‹ã€‚
    - BBSåå¿œï¼šã€Œå¤§è°·ã‹ã‚ˆã€ã€Œæ¼«ç”»ã®ä¸–ç•Œã€
// â–²â–²â–² è¿½è¨˜ã“ã“ã¾ã§ â–²â–²â–²
`;
// â–²â–²â–² ã“ã“ã¾ã§ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆã¾ãŸã¯ä¸Šæ›¸ãï¼‰ â–²â–²â–²


    const DETAILED_TEAM_DATA = {
        "283å­¦åœ’": {
            summary: "å¤ã®é€£è¦‡ã®å…ˆã«ã€è–åœ°ã§ã®å‹åˆ©ã‚’ç›®æŒ‡ã™ã€‚æ˜¨å¹´ç‹è€…ã€å®ˆå‚™ã®ä¸€ä½“æ„Ÿã¨æ‰“ç·šã®ã¤ãªãŒã‚Šã‚’å¼·ã¿ã«ã€è©¦åˆã”ã¨ã«æˆé•·ã€‚ãƒãƒ¼ãƒ ã‚¹ãƒ­ãƒ¼ã‚¬ãƒ³ã¯ã€å¼·ã€ã€‚å€‹ã®æŠ€é‡ã«é ¼ã‚‰ãšã€ä¸€äººã²ã¨ã‚Šã®åŠ›ã‚’é›†ã‚ã¦æˆ¦ã†ã€‚å§«å·ç™½ç€¬ã®æŠ•æ‰‹ãƒªãƒ¬ãƒ¼ã¯å…¨å›½ãƒ”ã‚«ã‚¤ãƒ",
            players: [
                { name: "å§«å·", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "æŠ•æ‰“ã®ä¸­å¿ƒã€‚MAX151kmã®ç›´çƒã¨ã‚¹ãƒ—ãƒªãƒƒãƒˆã§ç›¸æ‰‹ã‚’åœ§å€’ã™ã‚‹ã€ãƒ—ãƒ­æ³¨ç›®ã®é«˜æ ¡é€šç®—42æœ¬å¡æ‰“ã®æ€ªç‰©ã€‚" },
                { name: "èŠ±æµ·å’²", year: 3, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "1å¹´å¤ã‹ã‚‰ãƒ™ãƒ³ãƒå…¥ã‚Šã‚’æœãŸã—ã¦ã„ã‚‹ã€çµŒé¨“è±Šå¯Œãªèµ°æ”»å®ˆä¸‰æ‹å­æƒã£ãŸã‚¹ãƒ©ãƒƒã‚¬ãƒ¼ã€‚æ”»å®ˆã®è¦ã¨ã—ã¦ç›£ç£ã‹ã‚‰ã®ä¿¡é ¼ã¯åšã„ã€‚" },
                { name: "éˆ´æœ¨", year: 2, position: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ", desc: "ãƒãƒ£ãƒ³ã‚¹ã«å¼·ã„ä»•äº‹äººã€‚" },
                { name: "åç‹", year: 3, position: "ã‚·ãƒ§ãƒ¼ãƒˆ", desc: "ç›£ç£ã‚‚çµ¶å¤§ãªä¿¡é ¼ã‚’å¯„ã›ã‚‹é‰„å£ã®å®ˆå‚™ã‚’èª‡ã‚‹åæ‰‹ã€‚ãƒãƒ£ãƒ³ã‚¹ãƒ¡ã‚¤ã‚¯ã‚‚å¾—æ„ãªæ‰“è€…ã€‚" },
                { name: "å…«å®®", year: 2, position: "ã‚µãƒ¼ãƒ‰", desc: "2å¹´ç”ŸãªãŒã‚‰5ç•ªã«åº§ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã‚¯ãƒ©ãƒƒãƒãƒ’ãƒƒã‚¿ãƒ¼ã€‚ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ãŒé«˜ã„ã€‚" },
                { name: "æ¨‹å£", year: 3, position: "ã‚»ã‚«ãƒ³ãƒ‰", desc: "å¼·è‚©å¼·æ‰“ã®ãƒ‘ãƒ¯ãƒ¼ãƒ’ãƒƒã‚¿ãƒ¼ã€‚å‹è² å¼·ã„æ‰“æ’ƒãŒå…‰ã‚‹ã€‚" },
                { name: "æœ‰æ –å·", year: 3, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "å¤§èˆå°ã«å¼·ã„ä¸»è»¸ã€‚å¤‰åŒ–çƒæ‰“ã¡ã®æŠ€è¡“ã¯ãƒãƒ¼ãƒ ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã€‚" },
                { name: "èŠ¹æ²¢", year: 2, position: "ãƒ¬ãƒ•ãƒˆ", desc: "å°æŠ€ã¨å®ˆå‚™ã‚»ãƒ³ã‚¹ãŒå…‰ã‚‹æ¸‹ã„é¸æ‰‹ã€‚ãƒãƒ£ãƒ³ã‚¹ã§ã®ä¸€æ‰“ã‚‚ã€‚" },
                { name: "èŠ±æµ·ä½‘", year: 1, position: "ãƒ©ã‚¤ãƒˆ", desc: "1å¹´ç”Ÿã®ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¹ã‚¿ãƒ¼ã€‚å…„ãƒ»å’²ã¨ã®é€£æºã‚‚æŠœç¾¤ã€‚æ—¢ã«é€šç®—13æœ¬å¡æ‰“ã€‚" },
                { name: "é»›", year: 2, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "ãƒãƒ¼ãƒ æœ€é€Ÿã®ç›´çƒã‚’æŒã¤ã€‚æ˜¥ã¯ãƒ¡ãƒ³ãƒãƒ¼å¤–ã®æ‚”ã—ã•ã‚’ãƒãƒã«å¾©èª¿ã‚’ç›®æŒ‡ã™ã€‚" },
 { name: "è¥¿åŸ", year: 2, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "çƒå¨ã®ã‚ã‚‹ç›´çƒã§æ‰“è€…ã‚’è©°ã¾ã‚‰ã›ã‚‹é€Ÿçƒæ´¾æŠ•æ‰‹ã€‚åˆ¶çƒã«èª²é¡Œã¯ã‚ã‚‹ã‚‚ã®ã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã¯ãƒ”ã‚«ã‚¤ãƒã€‚æ‰“è€…ã¨ã—ã¦ã®èƒ½åŠ›ã‚‚é«˜ã„" },
                { name: "ç™½ç€¬", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "è©¦åˆã®å¾ŒåŠã‚’ç· ã‚ã‚‹ã‚¯ãƒ­ãƒ¼ã‚¶ãƒ¼çš„å½¹å‰²ã®ã‚¨ãƒ¼ã‚¹ã€‚æœ€é€Ÿ155kmã®ä¼¸ã³ä¸ŠãŒã‚‹ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã‚’æ­¦å™¨ã«æ‰“è€…ã‚’æ¬¡ã€…ã¨æ‰“ã¡å–ã‚‹ã€‚æ˜¥ã®å¤§ä¼šã§ã¯é™å²¡é«˜æ ¡ç›¸æ‰‹ã«å®Œå…¨è©¦åˆã‚‚é”æˆã—ãŸã€‚" }
            ]
        },
        "å¸¸è‘‰èŠå·": {
            summary: "å€‹ã€…ã®ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãŒçµå®Ÿã—æ˜¨å¹´ã¯æº–å„ªå‹ã€‚å€‹äººæˆç¸¾ã®å¯è¦–åŒ–ã¨å®ŸåŠ›ä¸»ç¾©ã§ãƒãƒ¼ãƒ å†…ã®ç«¶äº‰ã‚’æ´»æ€§åŒ–ã•ã›ã€åˆã®ç”²å­åœ’ã‚’ç›®æŒ‡ã™ã€‚ã‚¹ãƒ­ãƒ¼ã‚¬ãƒ³ã¯ã€å€‹ã€…ã®èƒ½åŠ›é‡è¦–ã€ã€‚",
            players: [
                { name: "æ²–ç”°", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "æŠ•æ‰“ã®å¤§é»’æŸ±ã€‚MAX157kmã®é€Ÿçƒã‚’æŒã¤ä¸»ç ²ã€‚" },
                { name: "åœŸæ–¹", year: 3, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ä¸Šã®ç›£ç£ã€‚é«˜ã„ã‚¹ãƒ­ãƒ¼ã‚¤ãƒ³ã‚°æŠ€è¡“ã¨é«˜æ ¡é€šç®—28æœ¬å¡æ‰“ã®ãƒ‘ãƒ¯ãƒ¼ã‚’æŒã¤ã€‚" },
                { name: "å®®æœ¬", year: 3, position: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ", desc: "åŠ›å¼·ã„æ‰“æ’ƒã¨å‹è² å¼·ã•ãŒé­…åŠ›ã®3ç•ªæ‰“è€…ã€‚" },
                { name: "æŸ³ç”Ÿ", year: 2, position: "ã‚»ã‚«ãƒ³ãƒ‰", desc: "ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚»ãƒ³ã‚¹ã«å„ªã‚Œã‚‹2å¹´ç”Ÿã€‚è½ã¡ç€ã„ãŸãƒ—ãƒ¬ãƒ¼ãŒå…‰ã‚‹ã€‚" },
                { name: "è¿‘è—¤", year: 3, position: "ã‚µãƒ¼ãƒ‰", desc: "ã‚¬ãƒƒãƒ„ã‚ãµã‚Œã‚‹ãƒ—ãƒ¬ãƒ¼ã§ãƒãƒ¼ãƒ ã‚’å¼•ã£å¼µã‚‹5ç•ªæ‰“è€…ã€‚é«˜æ ¡é€šç®—46æœ¬å¡æ‰“ã€‚" },
                { name: "å‚æœ¬", year: 3, position: "ã‚·ãƒ§ãƒ¼ãƒˆ", desc: "èµ°æ”»å®ˆä¸‰æ‹å­æƒã£ãŸæŠœç¾¤ã®èº«ä½“èƒ½åŠ›ã‚’æŒã¤ã‚·ãƒ§ãƒ¼ãƒˆã€‚" },
                { name: "å²¡ç”°", year: 3, position: "ãƒ©ã‚¤ãƒˆ", desc: "é«˜æ ¡é€šç®—71æœ¬å¡æ‰“ã‚’èª‡ã‚‹çµ¶å¯¾çš„ãª4ç•ªã€‚æµã¾ã‚ŒãŸä½“æ ¼ã‹ã‚‰ã®å¼·æ‰“ãŒæ­¦å™¨ã€‚" },
                { name: "æ£®", year: 2, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "50m6ç§’ãƒ•ãƒ©ãƒƒãƒˆã®ä¿Šè¶³ã€‚æ”»å®ˆã«ã‚ãŸã‚ŠæŠœç¾¤ã®å‹è² å¼·ã•ã‚’è¦‹ã›ã‚‹ã€‚" },
                { name: "ä¸Šæ³‰", year: 3, position: "ãƒ¬ãƒ•ãƒˆ", desc: "ãƒãƒ©ãƒ³ã‚¹ã¨å‹è² å¼·ã„æ‰“æ’ƒãŒæ­¦å™¨ã€‚é€†è»¢åŠ‡ã®ãã£ã‹ã‘ã‚’ä½œã‚‹ã€‚" },
                { name: "æ‹", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "å·§ã¿ãªæŠ•çƒè¡“ã¨å¼·ã„ç²¾ç¥åŠ›ã‚’æŒã¤æ§ãˆæŠ•æ‰‹ã€‚MAX155kmã€‚" },
                { name: "ç–‹ç”°", year: 2, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "ã‚¯ãƒ¬ãƒãƒ¼ã•ã¨å¼·æ°—ã‚’å…¼ã­å‚™ãˆãŸ2å¹´ç”ŸæŠ•æ‰‹ã€‚æ˜¨å¤ã‚‚ç™»æ¿çµŒé¨“ã‚ã‚Šã€‚" }
            ]
        },
        "æ›å·è¥¿": {
            summary: "æ˜¨å¹´ãƒ™ã‚¹ãƒˆ4ã€‚é¸æ‰‹ã®é•·æ‰€ã‚’æ´»ã‹ã™é‡çƒã§ã€ç£¨ãä¸Šã’ãŸå®ˆå‚™åŠ›ã¨ã‚¿ã‚¤ãƒ—ã®é•ã†3å¹´ç”ŸæŠ•æ‰‹3äººã®ç¶™æŠ•ã‚’æ­¦å™¨ã«ã€2005å¹´ä»¥æ¥ã®å¤ã®è–åœ°ã‚’ç›®æŒ‡ã™ã€‚",
            players: [
                { name: "è±ªç‚å¯º", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "æœ€é€Ÿ158kmã®ç›´çƒã¨ç¸¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§æ‰“è€…ã‚’æ‰“ã¡å–ã‚‹çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ã€‚" },
                { name: "å††å ‚", year: 3, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "å†·é™ãªãƒªãƒ¼ãƒ‰ã§å¤šå½©ãªæŠ•æ‰‹é™£ã‚’å¼•ã£å¼µã‚‹æ‰‡ã®è¦ã€‚3ç•ªæ‰“è€…ã¨ã—ã¦ã‚‚æ´»èºã€‚" },
                { name: "å£å±±", year: 3, position: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ", desc: "190cmã®é•·èº«ã‚’ç”Ÿã‹ã—ãŸå®ˆå‚™ã¨é•·æ‰“åŠ›ãŒé­…åŠ›ã€‚" },
                { name: "åŠç”°", year: 3, position: "ã‚»ã‚«ãƒ³ãƒ‰", desc: "å°æŸ„ãªãŒã‚‰æ”»å®ˆã«å …å®Ÿãªãƒ—ãƒ¬ãƒ¼ã§ãƒãƒ¼ãƒ ã«è²¢çŒ®ã€‚" },
                { name: "ä¸€ãƒç€¬", year: 3, position: "ã‚µãƒ¼ãƒ‰", desc: "ãƒãƒ¼ãƒ ä¸€ã®æ‰“çƒã®é€Ÿã•ã‚’èª‡ã‚‹2ç•ªæ‰“è€…ã€‚" },
                { name: "åœŸé–€", year: 3, position: "ã‚·ãƒ§ãƒ¼ãƒˆ", desc: "ãƒŸã‚¹ã®å°‘ãªã„å …å®Ÿãªå®ˆå‚™ã§è©¦åˆã®ãƒªã‚ºãƒ ã‚’ä½œã‚‹å†…é‡ã®è¦ã€‚" },
                { name: "æŸ“å²¡", year: 3, position: "ãƒ¬ãƒ•ãƒˆ", desc: "ç›£ç£ã‚‚çµ¶å¤§ãªä¿¡é ¼ã‚’å¯„ã›ã‚‹å¤§ç ²ã€‚æ°—æŒã¡ã®å¼·ã•ã‚‚é­…åŠ›ã€‚" },
                { name: "é¢¨ä¸¸", year: 3, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "ã‚µã‚¤ã‚¯ãƒ«ãƒ’ãƒƒãƒˆé”æˆçµŒé¨“ã‚‚ã‚ã‚‹ãƒªãƒ¼ãƒ‰ã‚ªãƒ•ãƒãƒ³ã€‚ãƒŸãƒ¼ãƒˆåŠ›ãŒæ ¼æ®µã«ã‚¢ãƒƒãƒ—ã€‚" },
                { name: "æ —æ¾", year: 2, position: "ãƒ©ã‚¤ãƒˆ", desc: "åŠ›å¼·ã„ã‚¹ã‚¤ãƒ³ã‚°ã‹ã‚‰æ”¾ãŸã‚Œã‚‹é•·æ‰“ãŒé­…åŠ›ã®2å¹´ç”Ÿã€‚" },
                { name: "é¬¼é“", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "ã‚­ãƒ¬ã®ã‚ã‚‹ç¸¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨å†…è§’ã¸ã®ç›´çƒãŒé­…åŠ›ã®å³è…•ã€‚" },
                { name: "æ¾é‡", year: 2, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "MAX144kmã®ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã¨ã‚«ãƒƒãƒˆãƒœãƒ¼ãƒ«ãŒæ­¦å™¨ã®2å¹´ç”Ÿã€‚å¥ªä¸‰æŒ¯èƒ½åŠ›ãŒé«˜ã„ã€‚" }
            ]
        },
        "é™å²¡": {
            summary: "æŠ•æ‰“ã®å¤§é»’æŸ±ã‚’ä¸­å¿ƒã«ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãªãƒ™ãƒ¼ã‚¹ãƒœãƒ¼ãƒ«ã‚’å±•é–‹ã€‚æ”»ã‚ã®å§¿å‹¢ã‚’è²«ãã€è–åœ°ã‚’è¦‹æ®ãˆã‚‹ä¼çµ±æ ¡ã€‚ã©ã“ã‹ã‚‰ã§ã‚‚å¾—ç‚¹ã§ãã‚‹æ‰“ç·šãŒå¼·ã¿ã€‚",
            players: [
                { name: "å€‰ç”°", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "å¸¸æ™‚150kmè¶…ã®é€Ÿçƒã‚’æŠ•ã’ã‚‹æœ¬æ ¼æ´¾ã‚¨ãƒ¼ã‚¹ã€‚" },
                { name: "æ¾„å·", year: 3, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "å¼·è‚©å¼·æ‰“ã®å¸ä»¤å¡”ã€‚ç›—å¡é˜»æ­¢ç‡ã¯éšä¸€ã€‚4ç•ªã¨ã—ã¦ã‚‚ãƒãƒ¼ãƒ ã‚’èƒŒè² ã†" },
                { name: "èˆŸæ©‹", year: 3, position: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ", desc: "é«˜æ ¡é€šç®—63æœ¬å¡æ‰“ã®ãƒ—ãƒ­æ³¨ç›®ã‚¹ãƒ©ãƒƒã‚¬ãƒ¼ã€‚å¾—ç‚¹åœã§ã®å‹è² å¼·ã•ãŒå…‰ã‚‹ã€‚" },
                { name: "æ±Ÿé‡", year: 3, position: "ã‚»ã‚«ãƒ³ãƒ‰", desc: "ä¿Šè¶³ã¨åºƒã„å®ˆå‚™ç¯„å›²ãŒæ­¦å™¨ã®æ©Ÿå‹•åŠ›å†…é‡æ‰‹ã€‚" },
                { name: "æ¾æµª", year: 3, position: "ã‚µãƒ¼ãƒ‰", desc: "å¤§æŸ„ãªä½“ã®ç›®ç«‹ã¤ãƒ‘ãƒ¯ãƒ¼ãƒ’ãƒƒã‚¿ãƒ¼ã€‚å¤šå°‘ä½“å‹¢ãŒå´©ã‚Œã¦ã‚‚å¤–é‡ã®é ­ã‚’è¶…ãˆã‚‹" },
                { name: "åˆ¥æ´¥", year: 3, position: "ã‚·ãƒ§ãƒ¼ãƒˆ", desc: "è»½å¿«ãªãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒå…‰ã‚‹å®ˆå‚™è·äººã€‚ã¤ãªãå½¹ã‚‚ã“ãªã—ãªãŒã‚‰é•·æ‰“åŠ›ã‚‚å…‰ã‚‹ã€‚" },
                { name: "é•·å†…", year: 3, position: "ãƒ¬ãƒ•ãƒˆ", desc: "å°æŸ„ãªãŒã‚‰é«˜ã„èº«ä½“èƒ½åŠ›ã‚’æŒã¤ã€‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã®å¾Œã‚’æ‰“ã¡ãƒ©ãƒ³ãƒŠãƒ¼ã‚’æ®‹ã•ãªã„ã€‚" },
                { name: "é˜¿éƒ¨", year: 3, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "190cmã®å·¨ä½“ãŒãƒˆãƒ¬ãƒ¼ãƒ‰ãƒãƒ¼ã‚¯ã®ã‚¹ãƒ©ãƒƒã‚¬ãƒ¼ã€‚è„±åŠ›ã—ãŸãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç›®ãŒè¦šã‚ã‚‹ã‚ˆã†ãªæ‰“çƒã‚’ç¹°ã‚Šå‡ºã™ã€‚" },
                { name: "å¤§è°·", year: 3, position: "ãƒ©ã‚¤ãƒˆ", desc: "å®‰å®šã—ãŸæ‰“ç‡ã‚’èª‡ã‚‹å³æ‰“è€…ã€‚æ­£ç¢ºãªè¿”çƒã‚‚é­…åŠ›ã€‚" },
                { name: "å±±æœ¬", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "æœ€é€Ÿ152kmã®å‰›è…•ã€‚ãƒªãƒªãƒ¼ãƒ•ã‚‚å…ˆç™ºã‚‚ã“ãªã™ä¸‡èƒ½å‹ã€‚" },
                { name: "ç ‚ç”°", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "å·¦è…•ã‹ã‚‰å¤šå½©ãªå¤‰åŒ–çƒã‚’æŠ•ã’ã‚‹ã‚¯ãƒ­ãƒ¼ã‚¶ãƒ¼çš„å­˜åœ¨ã€‚" }
            ]
        },
        "è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼": {
            summary: "æ˜¨å¹´ãƒ™ã‚¹ãƒˆ8ã€‚é¸æ‰‹ã®é•·æ‰€ã‚’æ´»ã‹ã—ãŸæ”»æ’ƒåŠ›ã¨å …å®ˆã‚’æ­¦å™¨ã«é›ªè¾±ã‚’æœŸã™ã€‚ã‚¿ã‚¤ãƒ—ã®ç•°ãªã‚‹3äººã®æŠ•æ‰‹ã«ã‚ˆã‚‹ç¶™æŠ•ãŒå¼·ã¿ã€‚",
            players: [
                { name: "æ²¢æ‘", year: 2, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "æœ€é€Ÿ140kmã®ç›´çƒã¨å¤šå½©ãªå¤‰åŒ–çƒã§ä¸‰æŒ¯ã‚’å¥ªã†æ¬¡ä¸–ä»£ã‚¨ãƒ¼ã‚¹å·¦è…•ã€‚" },
                { name: "é™è°·", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "é•·èº«ã‹ã‚‰æŠ•ã’ä¸‹ã‚ã™ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨ã‚·ãƒ¥ãƒ¼ãƒˆãŒæ­¦å™¨ã®å¤§å‹å³è…•ã€‚" },
                { name: "å¾¡å¹¸", year: 3, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "æ”»å®ˆã«ã‚ãŸã‚‹é«˜ã„é‡çƒã‚»ãƒ³ã‚¹ã‚’èª‡ã‚‹ãƒ—ãƒ­æ³¨ç›®ã®å¸ä»¤å¡”ã€‚" },
                { name: "å‰åœ’", year: 2, position: "ä¸€å¡æ‰‹ï¼å¤–é‡æ‰‹", desc: "é«˜ã„æ‰“æ’ƒæŠ€è¡“ã¨å¼·è‚©ã‚’æŒã¤å¤§å‹é‡æ‰‹ã€‚" },
                { name: "å°æ¹Š", year: 3, position: "äºŒå¡æ‰‹", desc: "å …å®Ÿãªå®ˆå‚™ã¨å·§ã¿ãªãƒãƒƒãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãŒå…‰ã‚‹ã€‚" },
                { name: "é‡‘ä¸¸", year: 3, position: "ä¸‰å¡æ‰‹", desc: "æ‰“çƒåå¿œãŒé€Ÿãã€å¼·è‚©ãŒæ­¦å™¨ã€‚ä¸­è·é›¢ãƒ’ãƒƒã‚¿ãƒ¼ã€‚" },
                { name: "å€‰æŒ", year: 2, position: "ã‚·ãƒ§ãƒ¼ãƒˆ", desc: "ä¿Šæ•ãªå‹•ãã¨è¯éº—ãªå®ˆå‚™ãŒé­…åŠ›ã®å†…é‡ã®è¦ã€‚" },
                { name: "çµåŸ", year: 3, position: "ãƒ¬ãƒ•ãƒˆ", desc: "é•·æ‰“åŠ›ã‚’æ­¦å™¨ã«å¿«éŸ³ã‚’éŸ¿ã‹ã›ã‚‹å¼·æ‰“è€…ã€‚" },
                { name: "æ±æ¡", year: 3, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "å¼·è‚©ã¨ç¢ºå®Ÿãªæ•çƒã§å¤–é‡ã‚’çµ±ç‡ã™ã‚‹å®ˆå‚™è·äººã€‚" },
                { name: "ç™½å·", year: 3, position: "ãƒ©ã‚¤ãƒˆ", desc: "æ‰“æ’ƒã‚»ãƒ³ã‚¹ãŒå…‰ã‚‹å·¦æ‰“è€…ã€‚å†·é™ãªçŠ¶æ³åˆ¤æ–­ãŒæŒã¡å‘³ã€‚" }
            ]
        },



        "ä¸‰å³¶åŒ—": {
            summary: "é›ªè¾±ã‚’æœŸã™çŸ¥æ€§æ´¾è»å›£ã€‚çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹æ¦›åã‚’æ“ã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’é§†ä½¿ã—ãŸç·»å¯†ãªé‡çƒã§æ˜¨å¤ã®æ‚”ã—ã•ã‚’æ™´ã‚‰ã™ã€‚ãƒãƒ¼ãƒ ã‚¹ãƒ­ãƒ¼ã‚¬ãƒ³ã¯ã€çŸ¥ã¯åŠ›ãªã‚Šã€ã€‚",
            players: [
                { name: "æ¦›å", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "æœ€é€Ÿ140kmå¾ŒåŠã®ç›´çƒã¨é«˜é€Ÿã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ä¸‰æŒ¯ã®å±±ã‚’ç¯‰ãçµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ã€‚" },
                { name: "ç§‹ä¸¸", year: 3, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "å†·é™æ²ˆç€ãªãƒªãƒ¼ãƒ‰ã§ã‚¨ãƒ¼ã‚¹æ¦›åã‚’æ”¯ãˆã‚‹æ‰‡ã®è¦ã€‚" },
                { name: "å¤§å·", year: 3, position: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ", desc: "ãƒãƒ¼ãƒ ä¸å‹•ã®4ç•ªã€‚ä¸€æŒ¯ã‚Šã§è©¦åˆã®æµã‚Œã‚’å¤‰ãˆã‚‹ãƒ‘ãƒ¯ãƒ¼ãŒé­…åŠ›ã€‚" },
                { name: "ç¦åŸ", year: 3, position: "ã‚·ãƒ§ãƒ¼ãƒˆ", desc: "å“è¶Šã—ãŸãƒãƒƒãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¨é¸çƒçœ¼ã‚’æŒã¤1ç•ªæ‰“è€…ã€‚å®ˆå‚™ã‚‚å …å®Ÿã€‚" },
                { name: "ç”ºç”°", year: 3, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "èµ°æ”»å®ˆä¸‰æ‹å­æƒã£ãŸã‚¢ãƒ™ãƒ¬ãƒ¼ã‚¸ãƒ’ãƒƒã‚¿ãƒ¼ã€‚3ç•ªã‚’æ‹…ã†ã€‚" }
            ]
        },
        "é™å²¡å•†æ¥­": {
            summary: "ç‹åº§å¥ªé‚„ã¸ã€æºã‚‹ããªãã€ç‹å›½ã€ã®ãƒ—ãƒ©ã‚¤ãƒ‰ã€‚æ˜¨å¹´ã®é›ªè¾±ã«ç‡ƒãˆã‚‹çµ¶å¯¾ç‹è€…ã€‚æŠ•æ‰“ã«ã‚¿ãƒ¬ãƒ³ãƒˆã‚’æƒãˆã€æœ€å¼·å·¦è…•ãƒ»æˆå®®ã‚’è»¸ã«å†ã³å…¨å›½ã®é ‚ç‚¹ã‚’ç›®æŒ‡ã™ã€‚ã‚¹ãƒ­ãƒ¼ã‚¬ãƒ³ã¯ã€å¸¸å‹ã€ã€‚",
            players: [
                { name: "æˆå®®", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "ã€Œã‚­ãƒ³ã‚°ã€ã®ç•°åã‚’æŒã¤ä¸–ä»£æœ€å¼·å·¦è…•ã€‚MAX150km/hã®ç›´çƒã¨é­”çƒãƒã‚§ãƒ³ã‚¸ã‚¢ãƒƒãƒ—ã‚’æ“ã‚‹ã€‚" },
                { name: "ç¥è°·", year: 3, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "50m5ç§’å°ã®ä¿Šè¶³ã‚’èª‡ã‚‹ã€Œãƒãƒ¼ã‚¿ãƒ¼ã€ã€‚æ”»å®ˆã«è¦æ ¼å¤–ã®èº«ä½“èƒ½åŠ›ã‚’è¦‹ã›ã‚‹ã€‚" },
                { name: "ç™½æ²³", year: 3, position: "ã‚·ãƒ§ãƒ¼ãƒˆ", desc: "å“è¶Šã—ãŸé‡çƒã‚»ãƒ³ã‚¹ã¨è¯éº—ãªå®ˆå‚™ãŒå…‰ã‚‹å†…é‡ã®å¸ä»¤å¡”ã€‚" },
                { name: "å¤šç”°é‡", year: 2, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "ã€Œã‚­ãƒ³ã‚°ã€æˆå®®ã®å¥³æˆ¿å½¹ã‚’å°„æ­¢ã‚ãŸ2å¹´ç”Ÿæ•æ‰‹ã€‚å†·é™ãªãƒªãƒ¼ãƒ‰ãŒæŒã¡å‘³ã€‚" },
                { name: "å±±å²¡", year: 3, position: "ã‚µãƒ¼ãƒ‰", desc: "é ¼ã‚Œã‚‹4ç•ªæ‰“è€…ã€‚æ˜¨å¹´ã¯ï¼–ç•ªãªãŒã‚‰ã‚‚å¤§ä¼šæ‰“ç‚¹ç‹ãªã©ã«è¼ã„ãŸã€‚ä»Šå¹´ã¯æº€ã‚’æŒã—ã¦4ç•ªã«å›è‡¨ã—ã€å‹è² å¼·ã„æ‰“æ’ƒã‚’ã™ã‚‹ã€‚é«˜æ ¡é€šç®—61æœ¬ã€‚" }
            ]
        },
        "è—¤ææ˜èª ": {
            summary: "å®ˆã‚Šã‚’å›ºã‚ã¦è©¦åˆã‚’ã¤ãã‚‹æ˜èª ã‚‰ã—ã•ã¯å¥åœ¨ã€‚æŠ•æ‰‹ã¯å·¦è…•ã®å®‡å£ã€å·¦è…•å®®åŸã‚‰ãŒä¸­å¿ƒã§ã€æˆé•·è‘—ã—ã„æ•æ‰‹å®œé‡åº§ãŒãƒªãƒ¼ãƒ‰ã™ã‚‹ã€‚ï¼‘å¹´æ™‚ã‹ã‚‰ä¸»åŠ›ã®ä¸»å°†å®®åŸã¯ï¼‘ç•ªä¸­å …ã¨ã—ã¦æ”»å®ˆã§ãƒãƒ¼ãƒ ã‚’ã‘ã‚“å¼•ã€‚ä¸­è»¸ã®æ¯”å˜‰ã¯é•·æ‰“åŠ›ãŒã‚ã‚Šã€ã“ã“ãã®å ´é¢ã§æœŸå¾…ãŒã‹ã‹ã‚‹ã€‚ç·åŠ›æˆ¦ã§å‹åˆ©ã‚’ç©ã¿ä¸Šã’ã€é ‚ç‚¹ã‚’ç›®æŒ‡ã™ã€‚",
            players: [
                { name: "å®®åŸ", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "æ˜èª ã®æŠ•æ‰‹é™£ã‚’ï¼‘å¹´æ¬¡ã‹ã‚‰æ”¯ãˆã¦ããŸçµŒé¨“è±Šå¯Œãªã‚¨ãƒ¼ã‚¹å·¦è…•ã€‚140kmã‚’è¶…ãˆã‚‹ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã¨é‹­ã„ãƒ•ã‚©ãƒ¼ã‚¯ãŒæŒã¡å‘³" },
                { name: "å®œé‡åº§", year: 2, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "ä¸å‹•ã®4ç•ªã€‚é«˜æ ¡ç”Ÿé›¢ã‚Œã—ãŸãƒ‘ãƒ¯ãƒ¼ã‚’èª‡ã‚‹è¦æ ¼å¤–ã®é•·è·é›¢ç ²ã€‚ã€Œæ˜èª ã®é ­è„³ã€ã¨ç§°ã•ã‚Œã‚‹ãƒªãƒ¼ãƒ‰ã‚‚æ­¦å™¨ã€‚" },
                { name: "æ–°å£", year: 3, position: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ", desc: "ãƒãƒ£ãƒ³ã‚¹ã«å¼·ã„5ç•ªãƒãƒƒã‚¿ãƒ¼ã€‚å¤‰åŒ–çƒã¸ã®å¯¾å¿œãŒã†ã¾ãç°¡å˜ã«æ‰“ã¡å–ã‚‰ã‚Œãªã„" },
                { name: "æ¯”å˜‰", year: 3, position: "ã‚»ã‚«ãƒ³ãƒ‰", desc: "ãƒãƒ¼ãƒ ã®ä¸­æ ¸ã‚’æ‹…ã†ï¼“ç•ªãƒãƒƒã‚¿ãƒ¼ã€‚åºƒè§’ã«æ‰“ã¡åˆ†ã‘ã‚‹æŠ€è¡“ã¨å …å®Ÿãªå®ˆå‚™ãŒå…‰ã‚‹ã€‚" },
                { name: "å®®åŸ", year: 3, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "ä¿Šè¶³ãŒæ­¦å™¨ã®å¤–é‡æ‰‹ã€‚æ„å¤–ãªå‹è² å¼·ã•ã‚‚è¦‹ã›ã‚‹ã€‚" }
            ]
        }
    };
    const INITIAL_TEAM_POOL = Object.keys(TEAM_DATA);

    // --- Utility & State Functions ---
   

 function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }
    
    function saveState() {
        try {
            localStorage.setItem('tournamentState', JSON.stringify(tournamentState));
        } catch (e) {
            console.error("é€²è¡ŒçŠ¶æ³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
            showAlert("é€²è¡ŒçŠ¶æ³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
        }
    }
    
    function uint8ArrayToBase64(bytes) {
        let binary = '';
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
    }

    function getRankFromHistoryString(historyString) {

        if (historyString.includes('å„ªå‹')) return 1;

        if (historyString.includes('æº–å„ªå‹')) return 2;

        if (historyString.includes('ãƒ™ã‚¹ãƒˆ4')) return 4;

        if (historyString.includes('ãƒ™ã‚¹ãƒˆ8')) return 8;

        if (historyString.includes('ãƒ™ã‚¹ãƒˆ16')) return 16;

        if (historyString.includes('3å›æˆ¦')) return 16;

        if (historyString.includes('2å›æˆ¦')) return 32;

        if (historyString.includes('åˆæˆ¦æ•—é€€')) return 64;

        return 64;

    }
    function getRankString(rank) {
 // â˜…â˜…â˜… ã“ã®ifãƒ–ãƒ­ãƒƒã‚¯ã‚’é–¢æ•°ã®å…ˆé ­ã«è¿½åŠ  â˜…â˜…â˜…
    if (rank <= -1) {
        for (const key in KOSHIEN_RESULTS) {
            if (KOSHIEN_RESULTS[key].rank === rank) {
                return KOSHIEN_RESULTS[key].label;
            }
        }
    }
    // â˜…â˜…â˜… ã“ã“ã¾ã§è¿½åŠ  â˜…â˜…â˜…
        if (rank === 1) return "å„ªå‹";
        if (rank === 2) return "æº–å„ªå‹";
        if (rank <= 4) return "ãƒ™ã‚¹ãƒˆ4";
        if (rank <= 8) return "ãƒ™ã‚¹ãƒˆ8";
        if (rank <= 16) return "ãƒ™ã‚¹ãƒˆ16";
        if (rank <= 32) return "3å›æˆ¦æ•—é€€";
        if (rank <= 64) return "2å›æˆ¦æ•—é€€";
        return "åˆæˆ¦æ•—é€€";
    }
// --- Utility & State Functions --- ãªã©ã«è¿½åŠ 

/**
 * Creates a subtle, realistic dust particle animation.
 */
function createDustEffect() {
    const container = document.getElementById('dust-container');
    if (!container) return;
    
    const particleCount = 20; // The number of dust particles

    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'dust-particle';
        
        const size = Math.random() * 3 + 1; // Particle size between 1px and 4px
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        
        // Use CSS variables to randomize the start and end points of the animation
        particle.style.setProperty('--x-start', `${Math.random() * 100}vw`);
        particle.style.setProperty('--x-end', `${Math.random() * 100}vw`);
        
        particle.style.animationDuration = `${Math.random() * 20 + 10}s`; // Duration between 10s and 30s
        particle.style.animationDelay = `${Math.random() * 10}s`; // Stagger the start time
        
        container.appendChild(particle);
    }
}
/**
 * ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã®åˆè¨ˆç‚¹ã‚’æ›´æ–°ã™ã‚‹
 */
/**
/**
 * ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã®åˆè¨ˆç‚¹ã‚’æ›´æ–°ã™ã‚‹
 */
function updateTotalScores() {
    const table = document.getElementById('inning-score-table');
    if(!table) return;

    table.querySelectorAll('tbody tr').forEach(row => {
        const total = Array.from(row.querySelectorAll('input')).reduce((sum, input) => {
            const value = parseInt(input.value);
            return isNaN(value) ? sum : sum + value;
        }, 0);
        
        const totalCell = row.querySelector('.total-score');
        if (totalCell) {
            totalCell.textContent = total;
        }
    });
}
/**
 * æˆ¦ç¸¾ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿ã‚„ã™ã„æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹
 */
function formatRecordToString(record) {
    if (!record) return "ãƒ‡ãƒ¼ã‚¿ãªã—";
    const year = record.year.toString().slice(-2);
    const tournamentNameMap = { summer: 'å¤', autumn: 'ç§‹', spring: 'æ˜¥' };
    const tournament = tournamentNameMap[record.tournament] || '';
    const rank = getRankString(record.rank);
    // â˜…â˜…â˜… ä»¥ä¸‹ã®è¡Œã‚’å¤‰æ›´ â˜…â˜…â˜…
    const prefix = record.rank < 0 ? '' : 'çœŒå¤§ä¼š'; // ç”²å­åœ’æˆç¸¾ã®å ´åˆã¯ã€ŒçœŒå¤§ä¼šã€ã‚’ã¤ã‘ãªã„
    return `'${year} ${tournament}: ${prefix}${rank}`;
    // â˜…â˜…â˜… ã“ã“ã¾ã§å¤‰æ›´ â˜…â˜…â˜…
}

// AI Content Generation & Helpers ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ 

/**
 * ãƒãƒ¼ãƒ ã®ä»Šå¤§ä¼šã®è»Œè·¡ã‚’è¦ç´„ã™ã‚‹
 * (â˜…è©¦åˆå†…å®¹ã®è¦ç´„(narrativeSummary)ã‚’åæ˜ ã™ã‚‹æœ€çµ‚ç‰ˆ)
 *
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 * @param {string} currentMatchId - ç¾åœ¨å‡¦ç†ä¸­ã®è©¦åˆID (é›†è¨ˆã‹ã‚‰é™¤å¤–ã™ã‚‹ãŸã‚)
 * @returns {string} - AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã®ãƒãƒ¼ãƒ çŠ¶æ³è¦ç´„æ–‡
 */
function getCurrentTournamentPerformance(teamName, currentMatchId) {
    const teamRecord = tournamentState.teamRecords[teamName];
    if (!teamRecord) return "ä»Šå¤§ä¼šåˆæˆ¦ã€‚";

    const path = []; // å‹ã¡ä¸ŠãŒã‚Šå±¥æ­´ (ä¾‹: "1å›æˆ¦ã§ã€‡ã€‡ã« 8-1 ã§å‹åˆ©")
    const keyPerformances = new Set(); // æ´»èºãƒã‚¤ãƒ©ã‚¤ãƒˆ (ä¾‹: "éˆ´æœ¨ãŒ1å›æˆ¦ã§çŒ›æ‰“è³")
    const playerAggStats = {}; // ä»Šå¤§ä¼šã®å€‹äººæˆç¸¾é›†è¨ˆç”¨ (ä¾‹: { "éˆ´æœ¨": { ab: 8, h: 3, ... } })

    // --- 1. å…¨å¤§ä¼šã®è©¦åˆãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ ---
    const allMatches = { 
        ...tournamentState.matches, 
        ...(tournamentState.autumnData?.allMatches || {}),
        ...(tournamentState.springData?.allMatches || {}) 
    };
    
    // --- 2. ç¾åœ¨ã®å¤§ä¼šã«çµã‚Šè¾¼ã¿ ---
    const currentTournamentKey = tournamentState.currentTournament;
    
    const currentTournamentMatchIds = Object.keys(allMatches).filter(matchId => {
        let isCurrentTournamentMatch = false;
        
        if (currentTournamentKey === 'summer') {
            // å¤: 'L-', 'R-', 'F-' (çœŒå¤§ä¼šæœ¬æˆ¦ID)
            isCurrentTournamentMatch = matchId.startsWith('L-') || matchId.startsWith('R-') || matchId.startsWith('F-');
        } else if (currentTournamentKey === 'autumn') {
            // ç§‹: åœ°åŒºäºˆé¸ID ã¾ãŸã¯ (æœ¬æˆ¦ãƒ•ã‚§ãƒ¼ã‚ºãªã‚‰) çœŒå¤§ä¼šæœ¬æˆ¦ID
            const isRegional = matchId.startsWith('æ±éƒ¨-') || matchId.startsWith('ä¸­éƒ¨-') || matchId.startsWith('è¥¿éƒ¨-') || matchId.startsWith('ä¼Šè±†-');
            const isMain = matchId.startsWith('L-') || matchId.startsWith('R-') || matchId.startsWith('F-');
            isCurrentTournamentMatch = isRegional || (tournamentState.autumnPhase === 'main' && isMain);
        } else if (currentTournamentKey === 'spring') {
            // æ˜¥: åœ°åŒºäºˆé¸ID ã¾ãŸã¯ (æœ¬æˆ¦ãƒ•ã‚§ãƒ¼ã‚ºãªã‚‰) çœŒå¤§ä¼šæœ¬æˆ¦ID
            const isRegional = matchId.includes('-SB') || matchId.includes('-SREP') || matchId.includes('-SIZU');
            const isMain = matchId.startsWith('L-') || matchId.startsWith('R-') || matchId.startsWith('F-');
            isCurrentTournamentMatch = isRegional || (tournamentState.springPhase !== 'regional_qualifiers' && isMain);
        }
        
        return isCurrentTournamentMatch;
    });

    // --- 3. ä»Šå¤§ä¼šã®å…¨è©¦åˆã‚’åˆ†æ ---
    for (const matchId of currentTournamentMatchIds) {
        // å‡¦ç†ä¸­ã®è©¦åˆ(currentMatchId)è‡ªä½“ã¯é›†è¨ˆã‹ã‚‰é™¤å¤–
        if (matchId === currentMatchId) continue;
        
        const match = allMatches[matchId];
        
        // ãƒãƒ¼ãƒ ãŒé–¢ã‚ã£ãŸè©¦åˆã‹ã€å‹è€…ãŒæ±ºã¾ã£ã¦ã„ã‚‹ã‹
        if (match && match.winner && (match.team1 === teamName || match.team2 === teamName)) {
            const opponent = match.team1 === teamName ? match.team2 : match.team1;
            if (!opponent) continue; // ä¸æˆ¦å‹ãªã©ã¯é™¤å¤–
            
            const roundName = getRoundNameFromMatchId(matchId); // ãƒ©ã‚¦ãƒ³ãƒ‰åå–å¾—

            // A. å‹ã¡è©¦åˆã®å±¥æ­´ã‚’ç”Ÿæˆ
            if (match.winner === teamName) {
                
                if (currentTournamentKey === 'summer') {
                    // ã€å¤å¤§ä¼šã€‘ã‚¹ã‚³ã‚¢ã¨ãƒ©ãƒ³ã‚¯ã‚’å«ã‚€è¤‡é›‘ãªè¡¨ç¾
                    const winnerScore = (match.team1 === teamName ? match.score1 : match.score2) || 'W';
                    const loserScore = (match.team1 === teamName ? match.score2 : match.score1) || 'L';
                    const opponentRank = calculateRank(opponent, tournamentState);
                    
                    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä»Šå›ã®ä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
                    let narrativeSummary = "";
                    // 1. match.details ã«ä¿å­˜ã•ã‚ŒãŸè¦ç´„æ–‡ã‚’å–å¾—
                    if (match.details && match.details.narrativeSummary) {
                        // "ã€‡ã€‡ãŒå‹åˆ©ã‚’æ´ã‚“ã " ã‚„ "æŠ•æ‰‹æˆ¦ã¨ãªã£ãŸ" ãªã©ã®é‡è¤‡è¡¨ç¾ã‚’å‰Šé™¤
                        narrativeSummary = match.details.narrativeSummary
                            .replace(/ã§ã€?.*ãŒå‹åˆ©ã‚’æ´ã‚“ã /, '')
                            .replace(/ã§ã€?.*ãŒå‹åˆ©ã—ãŸ/, '')
                            .replace(/ã€?æ¯è©°ã¾ã‚‹æŠ•æ‰‹æˆ¦ã¨ãªã£ãŸ/, 'ã®æŠ•æ‰‹æˆ¦')
                            .replace(/ã€?å£®çµ¶ãªæ‰“æ’ƒæˆ¦ã¨ãªã£ãŸ/, 'ã®æ‰“æ’ƒæˆ¦');
                    }
                    
                    let pathText;
                    if (narrativeSummary) {
                        // è¦ç´„ãŒã‚ã‚‹å ´åˆ (ä¾‹: 9å›ã‚µãƒ¨ãƒŠãƒ©å‹ã¡)
                        pathText = `${roundName}ã§${opponent}(${opponentRank})ã« ${winnerScore}-${loserScore} ã§å‹åˆ© (${narrativeSummary})`;
                    } else {
                        // è¦ç´„ãŒãªã„å ´åˆ (è©³ç´°å…¥åŠ›ãªã—)
                        pathText = `${roundName}ã§${opponent}(${opponentRank})ã« ${winnerScore}-${loserScore} ã§å‹åˆ©`;
                    }
                    path.push(pathText);
                    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

                } else {
                    // ã€ç§‹ãƒ»æ˜¥å¤§ä¼šã€‘ã‚·ãƒ³ãƒ—ãƒ«ãªè¡¨ç¾
                    path.push(`${roundName} vs ${opponent}`);
                }
            }

            // B. å€‹äººæˆç¸¾ï¼ˆã‚­ãƒ¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼‰ã®åé›† (å¤‰æ›´ãªã—)
            if (match.details) {
                const teamKey = match.team1 === teamName ? 'team1' : 'team2';
                
                const pitchers = match.details.pitching?.[teamKey] || [];
                pitchers.forEach(p => {
                    if (p.name && p.result === 'W' && parseFloat(p.innings) >= 6) {
                        keyPerformances.add(`${p.name}ãŒ${roundName}ã§å¥½æŠ•`);
                    }
                });

                if (match.details.playerGameStats) {
                    const gameStats = match.details.playerGameStats[teamKey];
                    for (const playerName in gameStats) {
                        // ä»Šå¤§ä¼šã®é›†è¨ˆç”¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–
                        if (!playerAggStats[playerName]) {
                            playerAggStats[playerName] = { ab: 0, h: 0, hr: 0, rbi: 0 };
                        }
                        const agg = playerAggStats[playerName];
                        const game = gameStats[playerName];
                        
                        // ã“ã®è©¦åˆã®æˆç¸¾ã‚’åŠ ç®—
                        agg.ab += game.ab || 0;
                        agg.h += game.h || 0;
                        agg.hr += game.hr || 0;
                        agg.rbi += game.rbi || 0;
                        
                        // çŒ›æ‰“è³
                        if (gameStats[playerName].h >= 3) {
                            keyPerformances.add(`${playerName}ãŒ${roundName}ã§çŒ›æ‰“è³`);
                        }
                    }
                }
            }
        }
    } // (è©¦åˆãƒ«ãƒ¼ãƒ—çµ‚äº†)
    
    // --- 4. æœ€çµ‚çš„ãªæ–‡ç« ã®çµ„ã¿ç«‹ã¦ ---
    let summary = "";
    if (path.length === 0) {
        summary = "ä»Šå¤§ä¼šåˆæˆ¦ã€‚";
    } else {
        if (currentTournamentKey === 'summer') {
            summary = `ã“ã“ã¾ã§ã®å‹ã¡ä¸ŠãŒã‚Š: ${path.join('ã€')}ã€‚`;
        } else {
            // ç§‹ãƒ»æ˜¥ã¯ã€Œâ†’ã€ã§ã¤ãªã
            summary = `ã“ã“ã¾ã§ã®å‹ã¡ä¸ŠãŒã‚Š: ${path.join(' â†’ ')}ã€‚`;
        }
    }
    
    // 5. ä»Šå¤§ä¼šã®é€šç®—æˆç¸¾ã®åˆ†æ (å¤‰æ›´ãªã—)
    for (const playerName in playerAggStats) {
        const stats = playerAggStats[playerName];
        if (stats.ab >= 5) { // 5æ‰“æ•°ä»¥ä¸Šã®é¸æ‰‹ã‚’å¯¾è±¡
            const battingAverage = (stats.ab > 0) ? (stats.h / stats.ab) : 0;
            if (battingAverage >= 0.4) {
                keyPerformances.add(`${playerName}ãŒæ‰“ç‡${battingAverage.toFixed(3)}ã¨çµ¶å¥½èª¿`);
            } else if (battingAverage <= 0.2 && battingAverage > 0) { // 0å‰²ã¯ä¸æŒ¯ã¨è¨€ã‚ãªã„
                keyPerformances.add(`${playerName}ãŒæ‰“ç‡${battingAverage.toFixed(3)}ã¨ä¸æŒ¯`);
            }
        }
    }
    
    if (keyPerformances.size > 0) {
        summary += ` ä»Šå¤§ä¼šã®ä¸»ãªæ´»èº: ${Array.from(keyPerformances).join('ã€')}ã€‚`;
    }

    return summary;
}
// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼

// â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
/**
 * æœ¬æ ¼çš„ãªã¾ã¨ã‚ã‚µã‚¤ãƒˆã®HTMLã‚’ã€ç¾å®Ÿã¨æ¶ç©ºã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’èåˆã•ã›ã¦ç”Ÿæˆã™ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼ä¿®æ­£ãƒ»ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿å¼·åŒ–ç‰ˆï¼‰
 * @returns {Promise<string>} ç”Ÿæˆã•ã‚ŒãŸHTMLæ–‡å­—åˆ—
 */
/**
 * æœ¬æ ¼çš„ãªã¾ã¨ã‚ã‚µã‚¤ãƒˆã®HTMLã‚’ã€ã‚µãƒ¼ãƒãƒ¼ã¨é€šä¿¡ã—ã¦ç”Ÿæˆã™ã‚‹ï¼ˆè¤‡æ•°ã‚«ãƒ†ã‚´ãƒªå¯¾å¿œãƒ»æœ€çµ‚ç‰ˆï¼‰
 * @returns {Promise<string>} ç”Ÿæˆã•ã‚ŒãŸHTMLæ–‡å­—åˆ—
 */
async function generateMatomeSiteHtml() {
    let articles = [];
    
    // --- 1. å¼·åŒ–ã•ã‚ŒãŸã‚µãƒ¼ãƒãƒ¼æ©Ÿèƒ½ã«ã€ç¾å®Ÿã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ã¾ã¨ã‚ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ---
    try {
        const response = await fetch('/.netlify/functions/get-news');
        if (!response.ok) {
            throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`);
        }
        const realNewsArticles = await response.json();
        articles.push(...realNewsArticles);

    } catch (e) {
        console.error("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
        articles.push({ headline: "ã€é€Ÿå ±ã€‘ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚µãƒ¼ãƒãƒ¼ã€ãƒ€ã‚¦ãƒ³ä¸­", type: 'real', timestamp: Date.now(), category: 'ã‚·ã‚¹ãƒ†ãƒ ' });
    }

    // --- 2. ã‚²ãƒ¼ãƒ å†…ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å–å¾— ---
    const gameNewsList = tournamentState.news || [];
    gameNewsList.filter(n => n.context && n.context.dbMatch).slice(-5).forEach(gameNews => {
        const { winnerName, loserName, dbMatch } = gameNews.context;
        const winnerRank = calculateRank(winnerName, tournamentState);
        const loserRank = calculateRank(loserName, tournamentState);
        const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
        let gameTitle = `ã€é«˜æ ¡é‡çƒã€‘${winnerName}ãŒ${loserName}ã«å‹åˆ©ï¼`;

        if (rankValues[winnerRank] < rankValues[loserRank]) {
            gameTitle = `ã€è¶…çµ¶æ‚²å ±ã€‘${loserName}(${loserRank}ãƒ©ãƒ³ã‚¯)ã€æ ¼ä¸‹ã®${winnerName}(${winnerRank}ãƒ©ãƒ³ã‚¯)ã«è² ã‘ã‚‹ï½—ï½—ï½—ï½—`;
        } else if ((parseInt(dbMatch.score1) + parseInt(dbMatch.score2)) > 15) {
            gameTitle = `ã€ä¹±æ‰“æˆ¦ã€‘${winnerName}vs${loserName}ã€ã¨ã‚“ã§ã‚‚ãªã„è©¦åˆã«ãªã‚‹`;
        }
        
        articles.push({
            headline: gameTitle,
            type: 'game',
            matchId: dbMatch.id,
            timestamp: gameNews.timestamp,
            category: 'é«˜æ ¡é‡çƒ'
        });
    });

    // --- 3. å…¨è¨˜äº‹ã‚’ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ã‚½ãƒ¼ãƒˆã—ã¦HTMLã‚’ç”Ÿæˆ ---
    articles.sort((a, b) => b.timestamp - a.timestamp);

    if (articles.length === 0) {
        return '<p class="text-center text-gray-500">ã¾ã è¡¨ç¤ºã§ãã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
    }

    const categoryColors = {
        "é«˜æ ¡é‡çƒ": "bg-green-100 text-green-800",
        "ã‚¹ãƒãƒ¼ãƒ„": "bg-blue-100 text-blue-800",
        "ã‚¨ãƒ³ã‚¿ãƒ¡": "bg-pink-100 text-pink-800",
        "å›½å†…": "bg-indigo-100 text-indigo-800",
        "å›½éš›": "bg-teal-100 text-teal-800",
        "çµŒæ¸ˆ": "bg-yellow-100 text-yellow-800",
        "IT": "bg-purple-100 text-purple-800",
        "ç§‘å­¦": "bg-gray-200 text-gray-800",
        "ä¸»è¦": "bg-red-100 text-red-800",
    };

    return articles.map(article => {
        const time = new Date(article.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        const commentCount = Math.floor(Math.random() * 800) + 50;
        const color = categoryColors[article.category] || "bg-gray-100 text-gray-800";

        // â–¼â–¼â–¼ aã‚¿ã‚°ã®hrefå±æ€§ãªã©ã‚’ä¿®æ­£ â–¼â–¼â–¼
        // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ãŒä¿®æ­£ã®æ ¸å¿ƒã§ã™ â–¼â–¼â–¼
         // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ãŒä¿®æ­£ã®æ ¸å¿ƒã§ã™ â–¼â–¼â–¼
        const linkHref = article.type === 'real' ? `href="${article.url}" target="_blank" rel="noopener noreferrer"` : 'href="javascript:void(0)"';
        const dataAttributes = `data-headline="${article.headline}" data-type="${article.type}" data-category="${article.category}" data-match-id="${article.matchId || ''}"`;

        return `
            <a ${linkHref} class="matome-article-link block p-3 rounded-lg hover:bg-gray-100 transition-colors" ${dataAttributes}>
                <div class="flex items-center text-xs text-gray-500">
                    <span class="font-bold py-0.5 px-2 rounded-full ${color}">${article.category}</span>
                    <span class="ml-auto">${time}</span>
                </div>
                <p class="font-bold text-gray-800 mt-2 text-base">${article.headline}</p>
                <div class="text-right text-xs text-gray-500 mt-1">ã‚³ãƒ¡ãƒ³ãƒˆ: ${commentCount} ğŸ’¬</div>
            </a>
        `;
        // â–²â–²â–²
    }).join('');
}


/**
 * ã‚²ãƒ¼ãƒ å†…ã®è©¦åˆçµæœã«å¯¾ã™ã‚‹ã€ãªã‚“Jã¾ã¨ã‚ã‚µã‚¤ãƒˆé¢¨ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’AIã«ç”Ÿæˆã•ã›ã‚‹
 * (â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯èªè­˜ æœ€çµ‚ç‰ˆ)
 */
async function generateGameMatchBbsComments(matchContext) {
    // --- 1. contextã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–ã‚Šå‡ºã™ ---
    const { 
        winnerName, loserName, dbMatch, matchId, playerStatsText, 
        winnerJourney, loserJourney, nextOpponent, nextOpponentJourney, 
        winnerLineupChanges, loserLineupChanges, highlights 
    } = matchContext;

    // --- 2. AIã¸ã®æŒ‡ç¤ºã«å¿…è¦ãªæƒ…å ±ã‚’æº–å‚™ ---
    const score = `${dbMatch.score1}-${dbMatch.score2}`;
    const winnerData = TEAM_DATA[winnerName];
    const loserData = TEAM_DATA[loserName];
    const winnerDynamicInfo = generateDynamicTeamInfo(winnerName, winnerData, tournamentState.teamRecords[winnerName]);
    const loserDynamicInfo = generateDynamicTeamInfo(loserName, loserData, tournamentState.teamRecords[loserName]);
    const winnerRank = calculateRank(winnerName, tournamentState);
    const loserRank = calculateRank(loserName, tournamentState);

    // â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ãŒä»Šå›ã®ä¿®æ­£ç®‡æ‰€ â–¼â–¼â–¼
    // â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã‚’å–å¾—
    const winnerSeedRank = getSeedRankString(winnerName, tournamentState.seeds);
    const loserSeedRank = getSeedRankString(loserName, tournamentState.seeds);
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    // æ¬¡æˆ¦ç›¸æ‰‹æƒ…å ±ã‚’æº–å‚™ (å¤‰æ›´ãªã—)
    let nextOpponentText = 'æ¬¡ã®ç›¸æ‰‹ã¯æœªå®šã‚„ãªã€‚';
    if (nextOpponent) {
        if (nextOpponent.opponentName && nextOpponent.opponentName !== 'ï¼ˆæœªå®šï¼‰') {
            const nextOpponentSeed = getSeedRankString(nextOpponent.opponentName, tournamentState.seeds); // â˜…æ¬¡æˆ¦ç›¸æ‰‹ã®ã‚·ãƒ¼ãƒ‰ã‚‚å–å¾—
            nextOpponentText = `æ¬¡ã®${nextOpponent.roundName}ã®ç›¸æ‰‹ã¯${nextOpponent.opponentName}${nextOpponentSeed}(ãƒ©ãƒ³ã‚¯:${nextOpponent.opponentRank})ã‹ã€‚`;
        } else if (nextOpponent.decidingMatch) {
            const dm = nextOpponent.decidingMatch;
            const team1Seed = getSeedRankString(dm.team1, tournamentState.seeds); // â˜…
            const team2Seed = getSeedRankString(dm.team2, tournamentState.seeds); // â˜…
            nextOpponentText = `æ¬¡ã®${nextOpponent.roundName}ã®ç›¸æ‰‹ã¯ã€${dm.team1}${team1Seed}(${dm.rank1}ãƒ©ãƒ³ã‚¯)ã¨${dm.team2}${team2Seed}(${dm.rank2}ãƒ©ãƒ³ã‚¯)ã®å‹è€…ã‚„ãªã€‚`;
        }
    }
    const nextOpponentJourneyText = (nextOpponent && nextOpponentJourney) ? `ã¡ãªã¿ã«ã€ãã®${nextOpponent.opponentName}ã®ã“ã“ã¾ã§ã®è»Œè·¡ã¯ã€Œ${nextOpponentJourney}ã€ã€‚` : '';

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆæƒ…å ±ã‚’ãƒ†ã‚­ã‚¹ãƒˆåŒ– (å¤‰æ›´ãªã—)
    let highlightsText = 'ä¸»ãªå‡ºæ¥äº‹ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
    if (highlights && highlights.length > 0) {
        highlightsText = highlights.map(fact => `- ${fact.inning || ''}å› ${fact.team || ''} ${fact.player || ''}: ${fact.description}`).join('\n');
    }

    // ãƒ©ã‚¦ãƒ³ãƒ‰æƒ…å ±ã‚’æŠ½å‡º (å¤‰æ›´ãªã—)
    let roundName = "ä¸æ˜ãªãƒ©ã‚¦ãƒ³ãƒ‰";
    if (matchId && matchId.includes('-R')) {
        const roundNum = parseInt(matchId.split('-')[1].slice(1));
        const finalRound = tournamentState.is16team ? 4 : 6;
        const roundNameMap = { [finalRound]: 'æ±ºå‹', [finalRound-1]: 'æº–æ±ºå‹', [finalRound-2]: 'æº–ã€…æ±ºå‹' };
        if (tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'main_round2_onwards'){
             const springRoundMap = { 1: '2å›æˆ¦', 2: 'æº–ã€…æ±ºå‹', 3: 'æº–æ±ºå‹', 4: 'æ±ºå‹'};
             roundName = springRoundMap[roundNum] || `${roundNum}å›æˆ¦`;
        }
        else if (tournamentState.currentTournament === 'autumn' && tournamentState.autumnPhase !== 'main') roundName = "åœ°åŒºäºˆé¸/é †ä½æ±ºå®šæˆ¦";
        else if (tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'main_round1') roundName = "çœŒå¤§ä¼š1å›æˆ¦";
        else roundName = roundNameMap[roundNum] || `${roundNum}å›æˆ¦`;
    } else if (matchId === 'bracket') {
        roundName = "çµ„ã¿åˆã‚ã›æ±ºå®šæ™‚";
    }
    
    // ... (ãã®ä»–ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæº–å‚™ã¯å¤‰æ›´ãªã—) ...
    const hadaReportText = matchContext.hadaReportSummary
        ? `\n### ãƒ‡ãƒ¼ã‚¿6ï¼šè¨˜è€…ã®è¦–ç‚¹ï¼ˆç¾½ç”°ãƒ¬ãƒãƒ¼ãƒˆï¼‰\n${matchContext.hadaReportSummary}\n`
        : '';
    const calledGameText = matchContext.calledGame
        ? `\n- **ç‰¹è¨˜äº‹é …:** ${matchContext.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ `
        : '';
    const rivalryText = matchContext.rivalryType
        ? `\n- **ç‰¹è¨˜äº‹é …:** ã“ã®è©¦åˆã¯ã€Œ${matchContext.rivalryType}ã€ã¨ã„ã†å› ç¸ã®å¯¾æ±ºã§ã—ãŸã€‚`
        : '';
    const lineupChangesText = `- ${winnerName}: ${winnerLineupChanges}\n- ${loserName}: ${loserLineupChanges}`;
    let atmosphereText = '';
    if (matchContext.atmosphere_team1 || matchContext.atmosphere_team2) {
        atmosphereText = '\n### ãƒ‡ãƒ¼ã‚¿6ï¼šè©¦åˆå‰ã®é›°å›²æ°—ãƒ»å…¬ç´„\n';
        if (matchContext.atmosphere_team1) atmosphereText += `- ${dbMatch.team1}: ${matchContext.atmosphere_team1}\n`;
        if (matchContext.atmosphere_team2) atmosphereText += `- ${dbMatch.team2}: ${matchContext.atmosphere_team2}\n`;
    }
    let scheduleText = '';
    if (matchContext.schedule) {
        const sched = matchContext.schedule;
        const team1Region = TEAM_DATA[dbMatch.team1]?.region || 'ä¸æ˜';
        const team2Region = TEAM_DATA[dbMatch.team2]?.region || 'ä¸æ˜';
        let advantage = 'ãªã—';
        if (sched.region === team1Region && sched.region !== team2Region) advantage = `${dbMatch.team1}ã®åœ°å…ƒ`;
        else if (sched.region !== team1Region && sched.region === team2Region) advantage = `${dbMatch.team2}ã®åœ°å…ƒ`;
        scheduleText = `\n### ãƒ‡ãƒ¼ã‚¿7ï¼šçƒå ´æƒ…å ±\n- **çƒå ´:** ${sched.stadiumFull} (${sched.region}åœ°åŒº)\n- **åœ°ã®åˆ©:** ${advantage}\n`;
    }
    let ballQualityText = '';
    if (matchContext.team1BallQuality && matchContext.team2BallQuality) {
        ballQualityText = `\n### ãƒ‡ãƒ¼ã‚¿3ï¼šãƒãƒ¼ãƒ åˆ¥ æ‰“çƒå“è³ªãƒ¬ãƒãƒ¼ãƒˆ\n- ${matchContext.team1BallQuality}\n- ${matchContext.team2BallQuality}\n`;
    }
    
    // --- 3. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæŒ‡ç¤ºæ›¸ï¼‰ã®ä½œæˆ ---
    // â–¼â–¼â–¼ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿®æ­£ â–¼â–¼â–¼
    const prompt = `ã‚ãªãŸã¯ã€é™å²¡çœŒã®é«˜æ ¡é‡çƒã‚’è¦³æˆ¦ã—ã¦ã„ã‚‹ã€ãªã‚“Jã®é‡çƒãƒ•ã‚¡ãƒ³ã§ã™ã€‚
ä»¥ä¸‹ã®è©¦åˆãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€ãƒ•ã‚¡ãƒ³ãŸã¡ã®ãƒªã‚¢ãƒ«ãªä¼šè©±ã‚³ãƒ¡ãƒ³ãƒˆã‚’**25ã€œ30å€‹**ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰
${PREFECTURE_LORE}

### ç¾åœ¨ã®è©¦åˆçŠ¶æ³
- **å¤§ä¼š:** ${tournamentState.tournamentYear}å¹´åº¦ ${tournamentNameMap[tournamentState.currentTournament] || 'å¤§ä¼š'}
- **ãƒ©ã‚¦ãƒ³ãƒ‰:** ${roundName}
${scheduleText} 

### å‚è€ƒæƒ…å ±ï¼šé«˜æ ¡é‡çƒã«ãŠã‘ã‚‹èƒŒç•ªå·ã®æ„å‘³
- [#1]: ãƒãƒ¼ãƒ ã®çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹æŠ•æ‰‹ã€‚
- [#2-9]: åŸºæœ¬çš„ã«ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ã®é‡æ‰‹é™£ï¼ˆæ­£æ•æ‰‹ã€å†…é‡æ‰‹ã€å¤–é‡æ‰‹ï¼‰ã€‚
- **[#10]ä»¥é™:** æ§ãˆç•ªå·ã¨ã•ã‚Œã‚‹ãŒã€ãƒãƒ¼ãƒ äº‹æƒ…ã‚„ç›£ç£ã®æ–¹é‡ã«ã‚ˆã‚Šã€**èƒŒç•ªå·2æ¡ã®å®Ÿè³ªçš„ãªãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼**ï¼ˆä¾‹ï¼šå¼·åŠ›ãª2ç•ªæ‰‹æŠ•æ‰‹[#10]ã€æ‰“æ’ƒå°‚é–€ã®é¸æ‰‹ã€æœŸå¾…ã®1ãƒ»2å¹´ç”Ÿï¼‰ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‚‚å¤šã„ã€‚**2æ¡ã ã‹ã‚‰ã¨ã„ã£ã¦å®‰æ˜“ã«ã€Œæ§ãˆã€ã¨æ–­å®šã—ãªã„ã“ã¨ã€‚**

### ãƒ‡ãƒ¼ã‚¿1ï¼šè©¦åˆçµæœ
- **å‹åˆ©:** ${winnerName} ${winnerSeedRank} (ãƒ©ãƒ³ã‚¯: ${winnerRank})
- **æ•—åŒ—:** ${loserName} ${loserSeedRank} (ãƒ©ãƒ³ã‚¯: ${loserRank})
- **ã‚¹ã‚³ã‚¢:** ${score}
- **ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´:**
${lineupChangesText}
${calledGameText} 
${rivalryText} 
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹è©¦åˆã®æ±ºã‚æ‰‹:** ${dbMatch.summary || 'ç‰¹ã«ãªã—'}

### ãƒ‡ãƒ¼ã‚¿2ï¼šãƒãƒ¼ãƒ ã®èƒŒæ™¯
- **${winnerName} ${winnerSeedRank}**: ${winnerDynamicInfo}
- **${loserName} ${loserSeedRank}**: ${loserDynamicInfo}

### ãƒ‡ãƒ¼ã‚¿3ï¼šã“ã®è©¦åˆã®å€‹äººæˆç¸¾ (æœ€çµ‚çµæœã®è¦ç´„)
${playerStatsText || 'å€‹äººæˆç¸¾ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}

### ãƒ‡ãƒ¼ã‚¿4ï¼šè©¦åˆã®ä¸»ãªå‡ºæ¥äº‹ (ãƒã‚¤ãƒ©ã‚¤ãƒˆ)
${highlightsText}
${ballQualityText} 

### ãƒ‡ãƒ¼ã‚¿5ï¼šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆå…¨ä½“ã®çŠ¶æ³
- **${winnerName}ã®è»Œè·¡(å‹ã¡ä¸ŠãŒã‚Š)**: ${winnerJourney || 'ä»Šå¤§ä¼šåˆæˆ¦'}
- **æ¬¡ã®è©¦åˆ**: ${nextOpponentText} ${nextOpponentJourneyText}
${atmosphereText}
${hadaReportText}

### æŒ‡ç¤º
ã‚ãªãŸã¯ä»Šã€ä¸Šè¨˜ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’çœºã‚ãªãŒã‚‰ã€ä»–ã®ãƒ•ã‚¡ãƒ³ã¨ä¼šè©±ã—ã¦ã„ã¾ã™ã€‚**ç¾åœ¨ã®è©¦åˆãŒã€Œ${roundName}ã€ã§ã‚ã‚‹ã“ã¨**ã€**å‹è€…ã®è»Œè·¡**ã€**æ¬¡ã®è©¦åˆæƒ…å ±**ã‚’è¸ã¾ãˆã¤ã¤ã€ä»¥ä¸‹ã®ç‚¹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã¦ãã ã•ã„ã€‚

- **ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘**: è©¦åˆæƒ…å ±ã«ã€Œ(ç¬¬1ã‚·ãƒ¼ãƒ‰)ã€ãªã©ã®ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚**ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã•ã™ãŒã‚„ãªã€ã€Œç¬¬5ã‚·ãƒ¼ãƒ‰ãŒè² ã‘ãŸãƒ³ã‚´wwwã€**ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚å…·ä½“çš„ã«è¨€åŠã—ã¦ãã ã•ã„ã€‚
- **ã€æœ€é‡è¦ï¼šæ¬¡æˆ¦æƒ…å ±ã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿5ã€ã®**\`æ¬¡ã®è©¦åˆ:\`** ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹æƒ…å ±ã‚’**å¿…ãš**ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã¦ãã ã•ã„ã€‚ã€Œæ¬¡ã¯ã€‡ã€‡ã‹â€¦ã€ã®ã‚ˆã†ã«å…·ä½“çš„ã«è¨€åŠã—ã€**ã€Œæœªå®šã€ã¨ã„ã†è¨€è‘‰ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚**
- **ã€è©¦åˆã¸ã®åå¿œã€‘**:
    - è©¦åˆçµæœï¼ˆã‚¹ã‚³ã‚¢ã€å‹æ•—ï¼‰ã«å¯¾ã™ã‚‹æ„Ÿæƒ³ã€‚
    - ã€Œãƒ‡ãƒ¼ã‚¿3ï¼ˆå€‹äººæˆç¸¾ï¼‰ã€ã‚„ã€Œãƒ‡ãƒ¼ã‚¿4ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ã€ã§ç›®ç«‹ã£ãŸé¸æ‰‹ã‚„ãƒ—ãƒ¬ãƒ¼ã¸ã®è¨€åŠã€‚ã€Œãƒ‡ãƒ¼ã‚¿3ã€ã®**èƒŒç•ªå·**ã«ã‚‚æ³¨ç›®ã™ã‚‹ã“ã¨ã€‚
    - **ï¼ˆé‡è¦ï¼‰** 1æ¡ç•ªå·ï¼ˆã‚¨ãƒ¼ã‚¹/ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ï¼‰ãŒæ´»èºã™ã‚‹ã®ã¯å½“ç„¶ã ãŒã€**èƒŒç•ªå·2æ¡ã®é¸æ‰‹ãŒæ´»èºã—ãŸå ´åˆ**ã€ãã‚Œã‚’ã€Œæ§ãˆã®æ´»èºã€ã¨å®‰æ˜“ã«æ–­å®šã›ãšã€ã€Œ**èƒŒç•ªå·10ã ã‘ã©å®Ÿè³ªã‚¨ãƒ¼ã‚¹**ã€ã€Œ**2æ¡ã®ã€‡ã€‡ãŒä»•äº‹ã—ãŸãª**ã€ã¨ã„ã£ãŸã€**ãã®é¸æ‰‹ã®å®ŸåŠ›ã‚’è©•ä¾¡ã™ã‚‹**ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã€‚
    - ã‚‚ã—æ•—åŒ—ãƒãƒ¼ãƒ ãŒå–„æˆ¦ã—ãŸå ´åˆ (ã‚¹ã‚³ã‚¢å·®ãŒå°ã•ã„ã€ãƒ©ãƒ³ã‚¯å·®ãŒã‚ã‚‹ã®ã«æ¥æˆ¦ãªã©) ã¯ã€ãã®å¥é—˜ã‚’ç§°ãˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã€‚
- **ã€å¸¸è­˜ã®åæ˜ ã€‘**: ã‚ãªãŸãŒç†ŸçŸ¥ã—ã¦ã„ã‚‹ã€Œå¸¸è­˜ã€ï¼ˆä¾‹ï¼šãƒŠãƒ ã‚³ vs å…¬ç«‹ã®ç ¦ã€å¤è±ªã®å¾©æ´»ã€ç‹è€…283å­¦åœ’ã®å‹•å‘ï¼‰ã‚’ã€è©¦åˆçµæœã‚„ãƒ‡ãƒ¼ã‚¿ã¨é–¢é€£ä»˜ã‘ã¦ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã“ã¨ã€‚
- **ã€ãã®ä»–ã€‘**:
    - ãªã‚“Jã‚‰ã—ã„çŸ­ã„ç…½ã‚Šã‚„è‰(w)ã‚’é©åº¦ã«å«ã‚ã‚‹ã€‚
    - ä»–ã®ã‚³ãƒ¡ãƒ³ãƒˆã¸ã®å®‰ä¾¡ (>>) ã‚’ã„ãã¤ã‹å«ã‚ã‚‹ã€‚
    - ãƒ©ãƒ³ã‚¯åã‚’è¨€ã„æ›ãˆã‚‹ï¼ˆAâ†’åé–€ã€Bâ†’å¼·è±ªã€Câ†’ä¸­å …ã€Dâ†’æŒ‘æˆ¦æ ¡ã€Eâ†’ç„¡åæ ¡ï¼‰ã€‚
- **#ã¯èƒŒç•ªå·ã¨è¨€ã„æ›ãˆã¦ãã ã•ã„ã€‚(ä¾‹ã€€#1â†’èƒŒç•ªå·1)**
- **ã€ç¾½ç”°ãƒ¬ãƒãƒ¼ãƒˆã¸ã®è¨€åŠã€‘**: ã‚‚ã—ã€Œãƒ‡ãƒ¼ã‚¿6ï¼šè¨˜è€…ã®è¦–ç‚¹ã€ã«ç¾½ç”°è¨˜è€…ã®åˆ†æãŒã‚ã‚‹å ´åˆã€**ã€Œç¾½ç”°ã¨ã‹ã„ã†è¨˜è€…ãŒï½ã£ã¦è¨€ã£ã¦ãŸã‘ã©â€¦ã€** ã®ã‚ˆã†ã«ã€ãã®åˆ†æã«åŒæ„ã—ãŸã‚Šã€åè«–ã—ãŸã‚Šã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’**å¿…ãš**å«ã‚ã‚‹ã“ã¨ã€‚
- **ã€è©¦åˆå‰ã®é›°å›²æ°—ã€‘**: ã‚‚ã—ã€Œãƒ‡ãƒ¼ã‚¿6ï¼šè©¦åˆå‰ã®é›°å›²æ°—ãƒ»å…¬ç´„ã€ãŒæä¾›ã•ã‚Œã¦ã„ãŸã‚‰ï¼ˆä¾‹ï¼šã€Œã‚¨ãƒ¼ã‚¹æ¸©å­˜å…¬è¨€ã€ã€Œã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³æœ€æ‚ªã€ãªã©ï¼‰ã€**ãã®ä¼ç·šãŒè©¦åˆçµæœã§ã©ã†ãªã£ãŸã‹**ã«ã¤ã„ã¦ï¼ˆä¾‹ï¼šã€ŒãªãŠå§«ã€ã€Œæ¸©å­˜ï¼ˆï¼‰ã€ã€Œã‚„ã£ã±ä½“èª¿æ‚ªã‹ã£ãŸã‚“ã‹ã€ï¼‰å¿…ãšè¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€çƒå ´ã¸ã®è¨€åŠã€‘**: ã‚‚ã—ã€Œãƒ‡ãƒ¼ã‚¿7ï¼šçƒå ´æƒ…å ±ã€ãŒã‚ã‚Šã€ã€Œåœ°ã®åˆ©ã€ãŒã©ã¡ã‚‰ã‹ã®ãƒãƒ¼ãƒ ã«ã‚ã£ãŸå ´åˆï¼ˆä¾‹ï¼šé™å²¡ãŒè‰è–™ã§è©¦åˆï¼‰ã€**ã€Œè¬ã®åŠ›ã‚­ã‚¿ãƒ¼wã€ã€Œåœ°å…ƒåˆ¤å®šã‚„ã‚ã‚ã€ã€Œã€‡ã€‡ï¼ˆçƒå ´åï¼‰ã¾ã§é å¾ã”è‹¦åŠ´ã•ã‚“ã€**ãªã©ã€çƒå ´ã«é–¢ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¿…ãšå«ã‚ã‚‹ã“ã¨ã€‚
- **ã€æŠ•æ‰‹ã®è©³ç´°å±æ€§ã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿3ï¼ˆãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ï¼‰ã€ã«ã€Œï¼ˆå³/ã‚ªãƒ¼ãƒãƒ¼/æœ¬æ ¼æ´¾/150kmå¸¯ï¼‰ã€ã¨ã„ã£ãŸ**æŠ•æ‰‹ã®è©³ç´°å±æ€§**ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã‚Œã«ã‚‚è¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€â˜…æ³¨ç›®ã®æ‰“å¸­ï¼ˆæœ€é‡è¦ï¼‰ã€‘**:
    - ã€Œãƒ‡ãƒ¼ã‚¿4ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ã€ã«ã€Œï¼ˆâ˜…æ³¨ç›®ï¼‰ã€ãƒãƒ¼ã‚¯ãŒä»˜ã„ã¦ã„ã‚‹æ‰“å¸­ãŒã€ã“ã®è©¦åˆã®**ã‚¿ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆ**ã‚„ã€‚
    - **ã€Œã‚ã®å ´é¢ãŒå…¨ã¦ã‚„ã£ãŸãªã€ã€Œã‚ãã“ã®ï¼ˆâ˜…æ³¨ç›®ï¼‰ã€‡ã€‡ã®æ‰“å¸­ãŒãƒ‡ã‚«ã™ããŸã€**ã®ã‚ˆã†ã«ã€ãã®ã€Œâ˜…æ³¨ç›®ã€ã®æ‰“å¸­ãŒè©¦åˆã®å‹æ•—ã‚’åˆ†ã‘ãŸæ±ºå®šçš„ãªç¬é–“ã§ã‚ã£ãŸã¨è¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€ã‚³ãƒ¼ãƒ«ãƒ‰/å› ç¸ã€‘**: ã‚‚ã—è©¦åˆãŒã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ã‚„ã€Œ${matchContext.rivalryType || 'å› ç¸ã®å¯¾æ±º'}ã€ã§ã‚ã£ãŸå ´åˆã€ãã®ç‚¹ã«ã¤ã„ã¦å¿…ãšè¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´ã€‘**:ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´ãŒã‚ã£ãŸå ´åˆ(${lineupChangesText})è§¦ã‚Œãªã•ã„ã€‚
- **ã€é¸æ‰‹ã®çŠ¶æ…‹ã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿3ï¼ˆå€‹äººæˆç¸¾ï¼‰ã€ã«ã€Œ(çŠ¶æ…‹: ã€‡ã€‡)ã€ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹é¸æ‰‹ã«æ³¨ç›®ã—ã€ã€Œçµ¶å¥½èª¿ã®ã€‡ã€‡ã€ä»Šæ—¥ã‚‚æ‰“ã£ãŸãªwã€ã€Œä¸æŒ¯ã ã£ãŸâ–³â–³ã€ã¤ã„ã«ç›®è¦šã‚ãŸã‹ï¼Ÿã€ãªã©ã€**å‰å›ã®è©¦åˆã‹ã‚‰ã®é€£ç¶šæ€§**ã‚’æ„è­˜ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’ã™ã‚‹ã“ã¨ã€‚
- **ã€æ‰“çƒã®è³ªï¼ˆæ‰“è€…ãƒ»æŠ•æ‰‹ï¼‰ã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿3ï¼ˆå€‹äººæˆç¸¾ï¼‰ã€ã‚„ã€Œãƒ‡ãƒ¼ã‚¿4ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ã€ã«ã‚ã‚‹**æ‰“çƒã®è³ª**ï¼ˆã€Œé‹­ã„å½“ãŸã‚Šã€ã€Œè©°ã¾ã£ãŸå½“ãŸã‚Šã€ãªã©ï¼‰ã«ã‚‚æ³¨ç›®ã™ã‚‹ã“ã¨ã€‚
- **ã€æ‰“çƒã®è³ªï¼ˆãƒãƒ¼ãƒ å…¨ä½“ï¼‰ã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿3ï¼šãƒãƒ¼ãƒ åˆ¥ æ‰“çƒå“è³ªã€ã‚’è¦‹ã¦ã€ãƒãƒ¼ãƒ å…¨ä½“ã®èª¿å­ã«ã¤ã„ã¦è¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€æ‰“é †ã®å½¹å‰²ã€‘**: ã€Œå¸¸è­˜ã€ã¨ã—ã¦ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã•ã‚ŒãŸ**æ‰“é †ã®å½¹å‰²**ã‚’æ„è­˜ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã“ã¨ã€‚
- **ã€æŠ•æ‰“ã®å·¦å³ã®ç›¸æ€§ã€‘**:
    - ã€Œãƒ‡ãƒ¼ã‚¿2ï¼ˆå¸¸è­˜ï¼‰ã€ã¨ã€Œãƒ‡ãƒ¼ã‚¿3ï¼ˆãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ï¼‰ã€ã«ã‚ã‚‹**æŠ•æ‰“ã®å·¦å³**ã«ã‚‚æ³¨ç›®ã™ã‚‹ã“ã¨ã€‚
    - **ç‰¹ã«ã€ç›¸æ‰‹ãŒã€Œå·¦è…•ï¼ˆã‚µã‚¦ã‚¹ãƒãƒ¼ï¼‰ã€ã ã£ãŸå ´åˆ**ã‚„ã€ç›£ç£ãŒ**ã€Œãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆãƒªãƒªãƒ¼ãƒ•ã€**ã‚’ä½¿ã£ãŸå ´åˆã«ã€ãã®ç›¸æ€§ã«ã¤ã„ã¦è¨€åŠã™ã‚‹ã“ã¨ã€‚

### å‡ºåŠ›å½¢å¼ã€æœ€é‡è¦ã€‘
è§£èª¬ã‚„å‰ç½®ãã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚**å¿…ãšä»¥ä¸‹ã® JSON é…åˆ—å½¢å¼ (\`[...]\`) ã®ã¿**ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
\`\`\`json
[
  {"personality": "1: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆç”Ÿæˆã—ãŸã‚³ãƒ¡ãƒ³ãƒˆ1ï¼‰"},
  {"personality": "2: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆç”Ÿæˆã—ãŸã‚³ãƒ¡ãƒ³ãƒˆ2ï¼‰"},
  // ... (åˆè¨ˆ25ã€œ30å€‹ã®ã‚³ãƒ¡ãƒ³ãƒˆ) ...
]
\`\`\`
`; 
    // â–²â–²â–² ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    // --- AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆéƒ¨åˆ†ã¯å¤‰æ›´ãªã— ---
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const commentsJson = parseJsonFromText(rawText);
            if (Array.isArray(commentsJson)) {
                return commentsJson.map((c, index) => ({
                    id: crypto.randomUUID(),
                    personality: c.personality || `${index + 1}: é¢¨å¹ã‘ã°åç„¡ã—`,
                    text: c.comment,
                    timestamp: Date.now() + index * 10,
                    replies: []
                }));
            } else {
                console.warn("AIãŒäºˆæœŸã—ãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã§BBSã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿”ã—ã¾ã—ãŸã€‚ä¸­èº«ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚");
                if (commentsJson && commentsJson.comments && Array.isArray(commentsJson.comments)) {
                     return commentsJson.comments.map((c, index) => ({
                        id: crypto.randomUUID(),
                        personality: c.personality || `${index + 1}: é¢¨å¹ã‘ã°åç„¡ã—`,
                        text: c.comment,
                        timestamp: Date.now() + index * 10,
                        replies: []
                    }));
                }
            }
        }
        throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒã€æ­£ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆé…åˆ—å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    } catch (error) {
        console.error("AI game match BBS generation failed (seed-aware):", error);
        return {
            error: true,
            title: "æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼(ã‚·ãƒ¼ãƒ‰å¯¾å¿œç‰ˆ)",
            body: "AIã«ã‚ˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
            timestamp: Date.now(),
            errorId: `error-${matchId}-bbs-seed`,
            context: matchContext
        };
    }
}
/**
 * ç¾å®Ÿã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã«å¯¾ã™ã‚‹ã€ãªã‚“Jé¢¨ã®æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆã‚’AIã«ç”Ÿæˆã•ã›ã‚‹
 * @param {string} headline - ç¾å®Ÿã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®è¦‹å‡ºã—
 * @param {string} category - ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ã‚«ãƒ†ã‚´ãƒª
 * @returns {Promise<Array|null>} ã‚³ãƒ¡ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
 */
async function generateRealNewsBbsComments(headline, category) {
    let personaPrompt = `ã‚ãªãŸã¯ã€æ—¥æœ¬ã®åŒ¿åæ²ç¤ºæ¿ã€Œãªã‚“ã§ã‚‚å®Ÿæ³Jï¼ˆãªã‚“Jï¼‰ã€ã®ä½æ°‘ã§ã™ã€‚ã‚ãªãŸã¯å°‘ã—çš®è‚‰å±‹ã§ã€ãƒãƒƒãƒˆã‚¹ãƒ©ãƒ³ã‚°ã‚’å¤šç”¨ã—ã€ã‚ã‚‰ã‚†ã‚‹è©±é¡Œã«çŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãè¾¼ã¿ã¾ã™ã€‚`;
    let instructions = ``;
    switch (category) {
        case 'æ”¿æ²»': instructions = `æ”¿æ²»ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«è©³ã—ã„ä½æ°‘ã¨ã—ã¦ã€ä¸å…šã‚„é‡å…šã‚’ç…½ã£ãŸã‚Šã€å°†æ¥ã‚’æ‚²è¦³ã—ãŸã‚Šã€é”è¦³ã—ãŸã‚ˆã†ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’ã—ã¦ãã ã•ã„ã€‚`; break;
        case 'èŠ¸èƒ½': instructions = `èŠ¸èƒ½ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒå¤§å¥½ããªé‡æ¬¡é¦¬ã¨ã—ã¦ã€ã€Œã€‡ã€‡ãƒ­ã‚¹ã ã‚ã€ã€Œã©ã†ã›ã™ãåˆ¥ã‚Œã‚‹ã€ã¨ã„ã£ãŸã€ãŠç¥ã„ã¨å«‰å¦¬ãŒå…¥ã‚Šæ··ã˜ã£ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’ã—ã¦ãã ã•ã„ã€‚`; break;
        case 'å­¦æ­´': instructions = `å­¦æ­´ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹ã‚’æŒã¤ä½æ°‘ã¨ã—ã¦ã€ã€ŒFæ¬„ã®ãƒ¯ã‚¤ã€é«˜ã¿ã®è¦‹ç‰©ã€ã€Œçµå±€ã¯å­¦æ­´ã‚ˆã‚Šã‚³ãƒŸãƒ¥åŠ›ã€ã¨ã„ã£ãŸã€è‡ªè™ã‚„æŒè«–ã‚’å±•é–‹ã—ã¦ãã ã•ã„ã€‚`; break;
        default: instructions = `ä¸€èˆ¬çš„ãªä½æ°‘ã¨ã—ã¦ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«åå¿œã—ã¦ãã ã•ã„ã€‚`; break;
    }
    
    const prompt = `${personaPrompt}

ä»¥ä¸‹ã®ã€${category}ã€‘ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã«ã¤ã„ã¦ã€**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚¹ãƒ¬ãƒƒãƒ‰ãŒé€²è¡Œã—ã¦ã„ãã‹ã®ã‚ˆã†ã«**ã€è‡ªç„¶ãªæµã‚Œã§**30ã€œ35å€‹**ã®æ²ç¤ºæ¿ã®åå¿œã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³
${headline}

### ã‚¹ãƒ¬ãƒƒãƒ‰é€²è¡Œã®æŒ‡ç¤º
1.  **åºç›¤ (1ã€œ5ãƒ¬ã‚¹):** ã‚¹ãƒ¬ä¸»ã®æŠ•ç¨¿ã«å¯¾ã—ã€å³åº§ã«é£Ÿã„ã¤ãç¬¬ä¸€é™£ã®åå¿œã€‚ã€Œãƒã‚¸ã‹ã€ã€Œè‰ã€ã€Œã¾ãŸã€‡ã€‡ã‹ã€ã¨ã„ã£ãŸçŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆãŒä¸­å¿ƒã€‚
2.  **ä¸­ç›¤ (6ã€œ15ãƒ¬ã‚¹):** å°‘ã—å†·é™ã«ãªã£ãŸä½æ°‘ãŸã¡ãŒã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«å¯¾ã—ã¦æ§˜ã€…ãªè§’åº¦ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’å§‹ã‚ã‚‹ã€‚è‚¯å®šã€å¦å®šã€ç…½ã‚Šã€å…¨ãé–¢ä¿‚ãªã„è„±ç·šãªã©ã‚’ç¹”ã‚Šäº¤ãœã‚‹ã€‚**ã€Œ>>1ã€ã€Œ>>5ã€ã®ã‚ˆã†ãªå®‰ä¾¡ï¼ˆã‚¢ãƒ³ã‚«ãƒ¼ï¼‰ã‚’ä½¿ã£ã¦ã€ä»–ã®ã‚³ãƒ¡ãƒ³ãƒˆã«è¿”ä¿¡ã™ã‚‹ã‚„ã‚Šå–ã‚Šã‚’å¿…ãšå«ã‚ã‚‹ã“ã¨ã€‚**
3.  **çµ‚ç›¤ (16ãƒ¬ã‚¹ä»¥é™):** ã‚ã‚‹ç¨‹åº¦è­°è«–ãŒå‡ºå°½ãã—ãŸå¾Œã®ã€ã¾ã¨ã‚ã®ã‚ˆã†ãªã‚³ãƒ¡ãƒ³ãƒˆã‚„ã€é£½ãã¦ããŸä½æ°‘ã«ã‚ˆã‚‹ãŠãµã–ã‘ãŒå§‹ã¾ã‚‹ã€‚
4.ã€€**æœ€çµ‚ç›¤ (26ãƒ¬ã‚¹ä»¥é™):** ã‚¹ãƒ¬ã‚‚æ··æ²Œã¨ã—ã¦ãã¦ã€é–¢ä¿‚ãªã„è©±é¡Œã‚’æŒã£ã¦ãã‚‹è€…ã‚„ã€å‹æ‰‹ã«ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹ã‚’åˆºæ¿€ã•ã‚Œç™ºç‹‚ã™ã‚‹ã‚‚ã®ã€ãŸã ã®è’ã‚‰ã—ãªã©ãŒæ¹§ãå§‹ã‚ã€ã‚°ãƒ€ã‚°ãƒ€ã«ãªã‚Šè§£æ•£ã™ã‚‹ã€‚


### å‡ºåŠ›å½¢å¼ï¼ˆJSONé…åˆ—ï¼‰
[
    {"personality": "1: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆã‚¹ãƒ¬ä¸»ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"},
    {"personality": "2: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆä½æ°‘2ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"},
    {"personality": "3: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆä½æ°‘3ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"},
    ...
]`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const commentsJson = parseJsonFromText(rawText);
            if (Array.isArray(commentsJson)) {
                return commentsJson.map(c => ({
                    id: crypto.randomUUID(),
                    personality: c.personality,
                    text: c.comment,
                    timestamp: Date.now()
                }));
            }
        }
        throw new Error("AI response format error.");
    } catch (error) {
        console.error("AI real news BBS generation failed:", error);
        return null;
    }
}
// â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–²

// â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–²

/**
 * æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ãƒ ãŒæ¬¡ã«å‡ºå ´ã™ã‚‹ã€ã¾ã çµ‚ã‚ã£ã¦ã„ãªã„è©¦åˆã‚’æ¢ã™
 * @param {string} teamName - æ¢ã—ãŸã„ãƒãƒ¼ãƒ å
 * @param {object} state - ç¾åœ¨ã®tournamentState
 * @returns {object|null} - è¦‹ã¤ã‹ã£ãŸè©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã¾ãŸã¯null
 */
function findCurrentMatchForTeam(teamName, state) {
    const allMatches = { ...state.matches, ...(state.autumnData?.allMatches || {}), ...(state.springData?.allMatches || {}) };
    let earliestMatch = null;
    let minRound = Infinity;

    for (const matchId in allMatches) {
        const match = allMatches[matchId];
        if (!match.winner && (match.team1 === teamName || match.team2 === teamName)) {
            const roundNum = match.id.includes('-R') ? parseInt(match.id.split('-')[1].slice(1)) : 0;
            if (roundNum < minRound) {
                minRound = roundNum;
                earliestMatch = match;
            }
        }
    }
    return earliestMatch;
}



/**
 * ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®å‹è€…ã‚’æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚ã‚‹ï¼ˆprocessMatchWinã‹ã‚‰æŠœç²‹ãƒ»æ”¹é€ ï¼‰
 * @param {object} match - çµ‚äº†ã—ãŸè©¦åˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @param {string} winnerName - å‹è€…å
 * @param {object} state - ç¾åœ¨ã®tournamentState
 */
function advanceWinnerToNextRound(match, winnerName, state) {
    const matchId = match.id;
    const idParts = matchId.split('-');
    const side = idParts[0];

    if (side === 'F') return; // æ±ºå‹æˆ¦ãªã‚‰ä½•ã‚‚ã—ãªã„

    const roundStr = idParts[1];
    const roundNum = parseInt(roundStr.slice(1));
    
    // ã“ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤å­£ãƒ»æ˜¥å­£çœŒå¤§ä¼šï¼ˆ16 or 64ãƒãƒ¼ãƒ ï¼‰ã‚’æƒ³å®š
    if (state.teams && state.teams.length > 0) {
        const numTeamsInTournament = state.teams.length;
        const finalRound = Math.log2(numTeamsInTournament);

        if (roundNum < finalRound) {
            const matchNum = parseInt(idParts[2].slice(1));
            const nextRoundNum = roundNum + 1;
            let nextMatchId = (nextRoundNum === finalRound) ? 'F-R1-M1' : `${side}-R${nextRoundNum}-M${Math.ceil(matchNum / 2)}`;
            
            if (!state.matches[nextMatchId]) {
                state.matches[nextMatchId] = { id: nextMatchId, team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '' };
            }
            let slot = (nextRoundNum === finalRound) ? (side === 'L' ? 1 : 2) : (matchNum % 2 !== 0 ? 1 : 2);
            state.matches[nextMatchId][`team${slot}`] = winnerName;
        }
    }
    // TODO: ç§‹å­£å¤§ä¼šãªã©ã®è¤‡é›‘ãªé€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ãªå ´åˆã¯ã€ã“ã“ã«è¿½åŠ ã™ã‚‹
}

// â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–²


/**
 * å¯†ç€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ã‚’é–‹å§‹ã—ã€åºç« ã®è¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹
 * @param {'underdog' | 'powerhouse'} type - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ã®ç¨®é¡
 * @param {string} teamName - å–æå¯¾è±¡ã®ãƒãƒ¼ãƒ å
 */
async function startDocumentary(type, teamName) {
    tournamentState.documentary = { target: teamName, type: type };
    newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒã€Œ${teamName}ã€ã®ç‰¹åˆ¥ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ç•ªçµ„ã®åˆ¶ä½œã‚’é–‹å§‹ã—ã¾ã—ãŸ...</div>`;
    
    renderTournament(tournamentState); 

    const firstMatch = Object.values(tournamentState.matches).find(m => 
        m.id.includes('-R1-') && (m.team1 === teamName || m.team2 === teamName)
    );
    
    let matchDataForArticle = { 
        opponent: 'ä¸æ˜', opponentRank: 'E', opponentRecord: 'æƒ…å ±ãªã—',
        toughestRival: 'ä¸æ˜', toughestRivalRecord: 'æƒ…å ±ãªã—'
    };

    if (firstMatch) {
        const opponentName = firstMatch.team1 === teamName ? firstMatch.team2 : firstMatch.team1;
        matchDataForArticle.opponent = opponentName;
        matchDataForArticle.opponentRank = calculateRank(opponentName, tournamentState);
        
        // â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ãŒæ–°ã—ã„å‡¦ç† â–¼â–¼â–¼
        // ç›¸æ‰‹ã®æ˜¨å¹´ã®æˆç¸¾ã‚’TEAM_DATAã‹ã‚‰ç›´æ¥å–å¾—
        matchDataForArticle.opponentRecord = TEAM_DATA[opponentName]?.last || 'æƒ…å ±ãªã—';

        const teamIndex = tournamentState.teams.indexOf(teamName);
        const blockIndex = Math.floor(teamIndex / 16);
        const blockStart = blockIndex * 16;
        const blockEnd = blockStart + 16;
        const blockTeams = tournamentState.teams.slice(blockStart, blockEnd);
        
        let toughestRivalName = null;
        let highestRankValue = -1;
        const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };

        blockTeams.forEach(rivalName => {
            if (rivalName === teamName) return;
            const rivalRank = calculateRank(rivalName, tournamentState);
            if (rankValues[rivalRank] > highestRankValue) {
                highestRankValue = rankValues[rivalRank];
                toughestRivalName = rivalName;
            }
        });
        
        if (toughestRivalName) {
            matchDataForArticle.toughestRival = toughestRivalName;
            // æœ€å¼·ãƒ©ã‚¤ãƒãƒ«ã®æ˜¨å¹´ã®æˆç¸¾ã‚‚TEAM_DATAã‹ã‚‰ç›´æ¥å–å¾—
            matchDataForArticle.toughestRivalRecord = TEAM_DATA[toughestRivalName]?.last || 'æƒ…å ±ãªã—';
        }
        // â–²â–²â–²
    }
    
    const article = await generateDocumentaryArticle('intro', type, teamName, matchDataForArticle);
    
    // â–²â–²â–²

    if (article) {
Â  Â  Â  Â  tournamentState.news.push(article);
Â  Â  } else {
        // å¤±æ•—ã—ãŸå ´åˆã€å†ç”Ÿæˆã«å¿…è¦ãªæƒ…å ±ã‚’ã€Œcontextã€ã¨ã—ã¦ä¿å­˜ã™ã‚‹
Â  Â  Â  Â  tournamentState.news.push({
Â  Â  Â  Â  Â  Â  title: "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼",
Â  Â  Â  Â  Â  Â  body: `ã€Œ${teamName}ã€ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼è¨˜äº‹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚`,
Â  Â  Â  Â  Â  Â  timestamp: Date.now(),
Â  Â  Â  Â  Â  Â  error: true,
            // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒé‡è¦ â˜…â˜…â˜…
            context: {
                isDocumentary: true, // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ã§ã‚ã‚‹ã¨ã„ã†ç›®å°
                type: type,
                teamName: teamName,
                matchData: matchDataForArticle
            }
            // â˜…â˜…â˜… ã“ã“ã¾ã§ â˜…â˜…â˜…
Â  Â  Â  Â  });
Â  Â  }
    renderNews(tournamentState.news);
    saveState();
}


async function generateDocumentaryArticle(phase, type, teamName, matchData = null, userFeedback = null) {
    const teamMasterData = TEAM_DATA[teamName];
    let prompt = `ã‚ãªãŸã¯ã€æƒ…ç†±çš„ã§äººé–“ãƒ‰ãƒ©ãƒã‚’æãã®ãŒå¾—æ„ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ç•ªçµ„ã®è¨˜è€…ã§ã™ã€‚ã‚ãªãŸã¯ä»Šã€é«˜æ ¡é‡çƒãƒãƒ¼ãƒ ã€Œ${teamName}ã€ã«å¯†ç€å–æã—ã¦ã„ã¾ã™ã€‚`;
    let title = "";

    let charactersPrompt = `### ä¸»ãªç™»å ´äººç‰©\n- ç›£ç£: ${teamMasterData.coach.name} (${teamMasterData.coach.style})\n`;
    if (DETAILED_TEAM_DATA[teamName]) {
        const detailedData = DETAILED_TEAM_DATA[teamName];
        const keyPlayers = detailedData.players.map(p => `- ${p.name}(${p.year}å¹´, ${p.position}): ${p.desc}`).join('\n');
        charactersPrompt += `### æ³¨ç›®é¸æ‰‹\n${keyPlayers}\n`;
    }
    
    let feedbackPrompt = '';
    if (userFeedback) {
        if (userFeedback.include && userFeedback.include.trim() !== '') {
            feedbackPrompt += `\n- **ã€æœ€é‡è¦æŒ‡ç¤ºã€‘** ä»¥ä¸‹ã®è¦ç´ ã‚’å¿…ãšè¨˜äº‹ã®ä¸­å¿ƒã«æ®ãˆã¦ã€æœ€ã‚‚ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«æå†™ã—ã¦ãã ã•ã„ï¼š\n${userFeedback.include}\n`;
        }
        if (userFeedback.exclude && userFeedback.exclude.trim() !== '') {
            feedbackPrompt += `\n- **ã€å³ç¦äº‹é …ã€‘** ä»¥ä¸‹ã®è¦ç´ ã‚„è¡¨ç¾ã¯ã€çµ¶å¯¾ã«è¨˜äº‹ã«å«ã‚ãªã„ã§ãã ã•ã„ï¼š\n${userFeedback.exclude}\n`;
        }
    }
    const finalFeedbackPrompt = `\n### ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ã‹ã‚‰ã®è¿½åŠ æŒ‡ç¤º\n${feedbackPrompt || 'ç‰¹ã«ãªã—'}`;

    // ==================================================================
    // --- 1. å¤è±ªå¾©æ´»ãƒãƒ¼ãƒ  (powerhouse_revival) ---
    // ==================================================================
    if (type === 'powerhouse_revival') {
        switch (phase) {
            case 'intro':
                title = `ã€${teamName}ã€å¾©æ´»ã¸ã®åºæ›²ã€`;
                let reactionPrompt = '';
                if (matchData && matchData.opponent) {
                    const ourRank = calculateRank(teamName, tournamentState);
                    const opponentRank = matchData.opponentRank;
                    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
                    const rankDiff = rankValues[opponentRank] - rankValues[ourRank];

                    if (rankDiff >= 1) { // æ ¼ä¸Š
                        reactionPrompt = `
5.  **ã€è©¦ç·´ã®åˆæˆ¦ã€‘**
    åˆæˆ¦ã®ç›¸æ‰‹ãŒæ ¼ä¸Šã®ã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚é¸æ‰‹ãŸã¡ãŒã€Œä¸è¶³ã¯ãªã„ç›¸æ‰‹ã€ã€Œå¾©æ´»ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã™ã‚‹ã«ã¯æœ€é«˜ã®ç›¸æ‰‹ã ã€ã¨é—˜å¿—ã‚’ç‡ƒã‚„ã™ã€‚
6.  **ã€ç›£ç£ã®ã€å»ºå‰ã€ã¨ã€æœ¬éŸ³ã€ã€‘**
    ç›£ç£ã¯**é¸æ‰‹ãŸã¡ã®å‰ã§**ã€ã€ŒæŒ‘æˆ¦è€…ã¨ã—ã¦ã€å¤±ã†ã‚‚ã®ã¯ä½•ã‚‚ãªã„ã€‚å…¨åŠ›ã§ã¶ã¤ã‹ã‚‹ãã€ã¨ã„ã†è¶£æ—¨ã§èªã‚‹ã€‚
    ã—ã‹ã—è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€ã€Œæœ¬å½“ã®å±±å ´ã¯**${matchData.toughestRival}**æˆ¦ã§ã—ã‚‡ã†ã€‚å½¼ã‚‰ã¯æ˜¨å¹´${matchData.toughestRivalRecord}ã€‚ã“ã®åˆæˆ¦ã¯ã€ãã“ã¸å‘ã‘ã¦ãƒãƒ¼ãƒ ãŒã©ã‚Œã ã‘æˆé•·ã§ãã‚‹ã‹ã®è©¦é‡‘çŸ³ã§ã™ã­ã€ã¨ã„ã†è¶£æ—¨ã§ã€å†·é™ã«å…ˆã‚’è¦‹æ®ãˆã‚‹ã€‚`;
                    } else { // åŒæ ¼ã‹æ ¼ä¸‹
                        reactionPrompt = `
5.  **ã€æ²¹æ–­ã¨ã„ã†åã®æ•µã€‘**
    åˆæˆ¦ã®ç›¸æ‰‹ãŒã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚ã€Œå‹ã¦ã‚‹ã€ã¨ã„ã†å®‰å µã®ç©ºæ°—ãŒé¸æ‰‹ãŸã¡ã®é–“ã«æµã‚Œã‚‹ã€‚
6.  **ã€ç›£ç£ã®ã€å»ºå‰ã€ã¨ã€æœ¬éŸ³ã€ã€‘**
    ãã®ç©ºæ°—ã‚’å¯Ÿã—ãŸç›£ç£ãŒ**é¸æ‰‹ãŸã¡ã®å‰ã§**ã€ã€Œæ²¹æ–­ãŒä¸€ç•ªã®æ•µã ã€‚ä¿ºãŸã¡ã¯ã¾ã ä½•ã‚‚æˆã—é‚ã’ã¦ã„ãªã„ã€ã¨ã„ã†è¶£æ—¨ã§å³ã—ãä¸€å–ã™ã‚‹ã€‚
    ã—ã‹ã—ã€è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€ã€Œæ­£ç›´ã€ãƒ›ãƒƒã¨ã—ã¾ã—ãŸã€‚**${matchData.toughestRival}**ï¼ˆå½¼ã‚‰ã¯æ˜¨å¹´${matchData.toughestRivalRecord}ï¼‰ã¨å½“ãŸã‚‹ã¾ã§ã«ã€ã„ãã¤ã‹è©¦åˆã‚’ã“ãªã—ã¦ç·´åº¦ã‚’ä¸Šã’ãŸã‹ã£ãŸã®ã§ã€ã¨ã„ã†è¶£æ—¨ã§ã€å®‰å µã®ç†ç”±ãŒæˆ¦ç•¥çš„ãªã‚‚ã®ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ã‹ã™ã€‚`;
                    }
                }
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
ã‹ã¤ã¦é»„é‡‘æ™‚ä»£ã‚’ç¯‰ã„ãŸå¤è±ªã€Œ${teamName}ã€ãŒã€å¤±ã‚ã‚ŒãŸæ „å…‰ã‚’å–ã‚Šæˆ»ã™ã¹ãæŒ‘ã‚€å¤ã‚’è¿½ã†ã€‚éå»ã€ç¾åœ¨ã€ãã—ã¦æœªæ¥ãŒäº¤éŒ¯ã™ã‚‹ç‰©èªã®åºç« ã‚’æã„ã¦ãã ã•ã„ã€‚
${charactersPrompt}
### æ§‹æˆæ¡ˆ
1.  **ã€åŸƒã‚’ã‹ã¶ã£ãŸå„ªå‹æ——ã€‘**: éƒ¨å®¤ã«çœ ã‚‹è‰²è¤ªã›ãŸå„ªå‹æ——ã‚„ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã®æå†™ã‹ã‚‰å§‹ã‚ã‚‹ã€‚éå»ã®æ „å…‰ã®é‡åœ§ã¨ã€ç¾åœ¨ã®ãƒãƒ¼ãƒ ãŒç½®ã‹ã‚ŒãŸçŠ¶æ³ï¼ˆ${teamMasterData.info}ï¼‰ã‚’å¯¾æ¯”ã•ã›ã‚‹ã€‚
2.  **ã€OBãŸã¡ã®ç†±ãçœ¼å·®ã—ã€‘**: ç·´ç¿’ã‚’å³ã—ã„ç›®ã§è¦‹ã¤ã‚ã‚‹OBä¼šé•·ã«ã€Œä¿ºãŸã¡ã®æ™‚ä»£ã¯â€¦ã€ã¨ã„ã†æ˜”èªã‚Šã¨ã€ç¾åœ¨ã®ãƒãƒ¼ãƒ ã¸ã®æ­¯ãŒã‚†ã•ã€ãã—ã¦å¿ƒã®åº•ã«ã‚ã‚‹æœŸå¾…ã‚’èªã‚‰ã›ã‚‹ã€‚
3.  **ã€é‡åœ§ã‚’èƒŒè² ã†ä¸»å°†ã€‘**: ä¸»å°†ã«ã€Œã“ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç€ã¦æˆ¦ã†ã“ã¨ã®æ„å‘³ã€ã‚’å•ã†ã€‚ä¼çµ±ã®é‡ã¿ã¨ã€ãã‚Œã‚’åŠ›ã«å¤‰ãˆã‚ˆã†ã¨ã™ã‚‹å½¼ã®è¦šæ‚Ÿã‚’æå†™ã™ã‚‹ã€‚
4.  **ã€ç›£ç£ã®ä¿¡å¿µã¨ç¾å®Ÿã€‘**: ç›£ç£ã«ã€Œå¤è±ªå¾©æ´»ã¸ã®é“ç­‹ã€ã‚’ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã€‚OBã‹ã‚‰ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã®ä¸­ã§ã€å½¼ãŒä¿¡ã˜ã‚‹ä»Šã®é¸æ‰‹ãŸã¡ã®å¯èƒ½æ€§ã¨ã€ç¾åœ¨ã®èª²é¡Œã«ã¤ã„ã¦èªã‚‰ã›ã‚‹ã€‚
${reactionPrompt}
7.  **ã€æ–°ãŸãªæ­´å²ã¸ã€‘**: ä¸»å°†ã®ã€Œä¿ºãŸã¡ã¯ä¿ºãŸã¡ã®é‡çƒã§ã€æ–°ã—ã„æ­´å²ã‚’ä½œã‚‹ã ã‘ã€ã¨ã„ã†è¨€è‘‰ã§ã€å¾©æ´»ã‚’ã‹ã‘ãŸå¤ã®å§‹ã¾ã‚Šã‚’åŠ›å¼·ãå®£è¨€ã—ã¦ç· ã‚ããã‚‹ã€‚
### æå†™ã®ãƒã‚¤ãƒ³ãƒˆ
- æ™‚é–“è»¸ã®æ„è­˜: ã€Œéå»ã®æ „å…‰ã€ã€Œç¾åœ¨ã®è‘›è—¤ã€ã€Œæœªæ¥ã¸ã®æŒ‘æˆ¦ã€ã‚’æ„è­˜ã—ã€ç‰©èªã«æ·±ã¿ã‚’ä¸ãˆã‚‹ã“ã¨ã€‚
- å»ºå‰ã¨æœ¬éŸ³: ç›£ç£ã®äºŒé¢æ€§ã‚’æãã“ã¨ã§ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ãƒªã‚¢ãƒªãƒ†ã‚£ã‚’è¿½æ±‚ã™ã‚‹ã“ã¨ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆé•·ç·¨ã®è¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
            case 'win':
                title = `ã€${teamName}ã€å¾©æ´»ã¸ã®ç¬¬ä¸€æ­©ã€`;
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
å¤è±ªã€Œ${teamName}ã€ãŒ ${matchData.opponent} ã¨ã®è©¦åˆã« ${matchData.score} ã§å‹åˆ©ã—ã¾ã—ãŸã€‚ã€Œåé–€å¾©æ´»ã¸ã®ç‹¼ç…™ã€ã¨ãªã‚‹ã“ã®ä¸€å‹ã®ä¾¡å€¤ã‚’ã€æ„Ÿå‹•çš„ã«æå†™ã—ã¦ãã ã•ã„ã€‚
### å¯¾æˆ¦ç›¸æ‰‹ã€Œ${matchData.opponent}ã€ã®èƒŒæ™¯
${matchData.opponentInfo}
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹
${matchData.summary || 'ç‰¹ã«ãªã—'}
### ã“ã®è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${matchData.highlights}
### æ§‹æˆæ¡ˆ
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€ã‚’ç‰©èªã®ä¸­å¿ƒã«æ®ãˆã€ãã®å ´é¢ã‚’æœ€ã‚‚ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«æå†™ã™ã‚‹ã€‚
2.  å¯¾æˆ¦ç›¸æ‰‹ãŒã©ã®ã‚ˆã†ãªãƒãƒ¼ãƒ ã§ã‚ã£ãŸã‹ï¼ˆã€å¯¾æˆ¦ç›¸æ‰‹ã®èƒŒæ™¯ã€‘ã‚’å‚ç…§ï¼‰ã«è§¦ã‚Œã€ã“ã®å‹åˆ©ã®ä¾¡å€¤ã‚’ã‚ˆã‚Šé«˜ã‚ã‚‹ã€‚
3.  ç›£ç£ã«ã€Œä¼çµ±ã®ç²˜ã‚Šå¼·ã•ãŒå‡ºã›ãŸã€ã¨ã„ã†è¶£æ—¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã•ã›ã‚‹ã€‚
4.  ä¸»å°†ã«ã€æ¬¡æˆ¦ã¸ã®æ„æ°—è¾¼ã¿ã¨å…±ã«ã€Œå…ˆè¼©ãŸã¡ãŒç¯‰ã„ãŸæ­´å²ã«ã€æ–°ãŸãª1ãƒšãƒ¼ã‚¸ã‚’åˆ»ã¿ãŸã„ã€ã¨èªã‚‰ã›ã‚‹ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆè¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
            case 'lose':
                title = `ã€${teamName}ã€å¤¢ã€ã¾ãŸã‚‚å±Šã‹ãšã€`;
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
å¤è±ªã€Œ${teamName}ã€ã®å¤ãŒçµ‚ã‚ã‚Šã‚’å‘Šã’ãŸã€‚å¾©æ´»ã‚’é¡˜ã£ãŸäººã€…ã®æœŸå¾…ã¨ã€ãã‚Œã«å¿œãˆã‚‰ã‚Œãªã‹ã£ãŸé¸æ‰‹ãŸã¡ã®ç„¡å¿µã•ã‚’æã„ã¦ãã ã•ã„ã€‚
### å¯¾æˆ¦ç›¸æ‰‹ã€Œ${matchData.opponent}ã€ã®èƒŒæ™¯
${matchData.opponentInfo}
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹
${matchData.summary || 'ç‰¹ã«ãªã—'}
### ã“ã®è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${matchData.highlights}
### æ§‹æˆæ¡ˆ
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€ãŒã€ã„ã‹ã«ã—ã¦ãƒãƒ¼ãƒ ã®å¤¢ã‚’æ‰“ã¡ç •ã„ãŸã‹ã‚’è©³ç´°ã«æå†™ã™ã‚‹ã€‚
2.  å¯¾æˆ¦ç›¸æ‰‹ãŒã©ã®ã‚ˆã†ãªãƒãƒ¼ãƒ ã§ã‚ã£ãŸã‹ï¼ˆã€å¯¾æˆ¦ç›¸æ‰‹ã®èƒŒæ™¯ã€‘ã‚’å‚ç…§ï¼‰ã«è§¦ã‚Œã€æ•—åŒ—ã®æ–‡è„ˆã‚’ã‚ˆã‚Šæ·±ãæå†™ã™ã‚‹ã€‚
3.  ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«æ³£ãå´©ã‚Œã‚‹é¸æ‰‹ãŸã¡ã¨ã€å½¼ã‚‰ã«ã‹ã‘ã‚‹è¨€è‘‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„ç›£ç£ã®å§¿ã€‚
4.  ã€Œå½¼ã‚‰ã®æŒ‘æˆ¦ã¯çµ‚ã‚ã£ãŸã€‚ã—ã‹ã—ã€ã€‡ã€‡ï¼ˆæ ¡åï¼‰ã®é‡çƒéƒ¨ã®ç¯ãŒæ¶ˆãˆã‚‹ã“ã¨ã¯ãªã„ã€ã¨ã€æœªæ¥ã¸ã®å¸Œæœ›ã§ç· ã‚ããã‚‹ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆè¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
        }
    } 
    // ==================================================================
    // --- 2. çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ãƒãƒ¼ãƒ  (one_man_team) ---
    // ==================================================================
    else if (type === 'one_man_team') {
        switch (phase) {
            case 'intro':
                title = `ã€${teamName}ã®ã‚¨ãƒ¼ã‚¹ã¨ã€8äººã®ä»²é–“ãŸã¡ã€`;
                let reactionPrompt = '';
                if (matchData && matchData.opponent) {
                    const ourRank = calculateRank(teamName, tournamentState);
                    const opponentRank = matchData.opponentRank;
                    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
                    const rankDiff = rankValues[opponentRank] - rankValues[ourRank];

                    if (rankDiff >= 2) { // çµ¶æœ›çš„ãªæ ¼ä¸Š
                        reactionPrompt = `
5.  **ã€è©¦ã•ã‚Œã‚‹ã€å€‹ã€ã®åŠ›ã€‘**
    åˆæˆ¦ã®ç›¸æ‰‹ãŒæ ¼ä¸Šã®å¼·è±ªã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚é‡æ‰‹ãŸã¡ãŒå‹•æºã™ã‚‹ä¸­ã€ã‚¨ãƒ¼ã‚¹ã ã‘ãŒã€Œç›¸æ‰‹ãŒèª°ã§ã‚ã‚ã†ã¨ã€ä¿ºãŒã‚¼ãƒ­ã«æŠ‘ãˆã‚‹ã ã‘ã§ã™ã€ã¨ã„ã†è¶£æ—¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã§é—˜å¿—ã‚’ç‡ƒã‚„ã™ã€‚
6.  **ã€ç›£ç£ã®ã€å»ºå‰ã€ã¨ã€æœ¬éŸ³ã€ã€‘**
    ç›£ç£ã¯**é¸æ‰‹ãŸã¡ã®å‰ã§**ã€ã€Œæœ€é«˜ã®ç›¸æ‰‹ã ã€‚æˆ‘ã€…ã«ã¯ã€‡ã€‡ï¼ˆã‚¨ãƒ¼ã‚¹åï¼‰ãŒã„ã‚‹ã€‚å½¼ã‚’ä¿¡ã˜ã‚ã€ã¨ã„ã†è¶£æ—¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã€ã‚¨ãƒ¼ã‚¹ã¸ã®çµ¶å¯¾çš„ãªä¿¡é ¼ã‚’å£ã«ã™ã‚‹ã€‚
    ã—ã‹ã—è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€ã€Œæ­£ç›´ã€æœ€æ‚ªã®ã‚¯ã‚¸ã§ã™ã€‚å½¼ï¼ˆã‚¨ãƒ¼ã‚¹ï¼‰ã®è² æ‹…ã‚’è€ƒãˆã‚Œã°ã€å‹ã¡é€²ã‚“ã å…ˆã®**${matchData.toughestRival}**ï¼ˆæ˜¨å¹´${matchData.toughestRivalRecord}ï¼‰æˆ¦ã¾ã§ã€ä»–ã®é¸æ‰‹ã«çµŒé¨“ã‚’ç©ã¾ã›ãŸã‹ã£ãŸã€ã¨ã„ã†è¶£æ—¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã€ãƒãƒ¼ãƒ å…¨ä½“ã®æˆé•·ã‚’é¡˜ã†æœ¬éŸ³ã‚’æ¼ã‚‰ã™ã€‚`;
                    } else { // åŒæ ¼ã‹æ ¼ä¸‹
                        reactionPrompt = `
5.  **ã€ã‚¨ãƒ¼ã‚¹æ¸©å­˜ã‹ã€å¦ã‹ã€‘**
    åˆæˆ¦ã®ç›¸æ‰‹ãŒã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚é¸æ‰‹ãŸã¡ã®é–“ã«ã€Œã“ã®ç›¸æ‰‹ãªã‚‰ã€ã‚¨ãƒ¼ã‚¹æŠœãã§ã‚‚å‹ã¦ã‚‹ã®ã§ã¯ï¼Ÿã€ã¨ã„ã†æ…¢å¿ƒãŒç”Ÿã¾ã‚Œã‚‹ã€‚
6.  **ã€ç›£ç£ã®ã€è³­ã‘ã€ã€‘**
    ç›£ç£ãŒ**é¸æ‰‹ãŸã¡ã®å‰ã§**ã€ã€Œåˆæˆ¦ã€ã€‡ã€‡ï¼ˆã‚¨ãƒ¼ã‚¹åï¼‰ã¯æŠ•ã’ãªã„ã€‚ãŠå‰ãŸã¡ã§å‹ã¡ä¸ŠãŒã£ã¦ã“ã„ã€ã¨ã„ã†è¶£æ—¨ã®ã€éæƒ…ã¨ã‚‚æ€ãˆã‚‹æ±ºæ–­ã‚’ä¸‹ã™ã€‚
    è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€ã€Œã“ã‚Œã¯è³­ã‘ã§ã™ã€‚ã§ã‚‚ã€**${matchData.toughestRival}**ï¼ˆæ˜¨å¹´${matchData.toughestRivalRecord}ï¼‰ã¨æˆ¦ã†ã“ã¨ã‚’è¦‹æ®ãˆã‚Œã°ã€ã“ã“ã§ä»–ã®é¸æ‰‹ãŒè¦šé†’ã—ãªã‘ã‚Œã°æœªæ¥ã¯ãªã„ã€ã¨ã„ã†è¶£æ—¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã€ã‚¨ãƒ¼ã‚¹ã®å°†æ¥ã¨ãƒãƒ¼ãƒ ã®æœªæ¥ã‚’æƒ³ã†æœ¬éŸ³ã‚’èªã‚‰ã›ã‚‹ã€‚`;
                    }
                }
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
ãƒ—ãƒ­æ³¨ç›®ã®çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ã‚’æ“ã™ã‚‹ã€Œ${teamName}ã€ã€‚å¤©æ‰ã®è‹¦æ‚©ã¨ã€å½¼ã‚’æ”¯ãˆã‚‹ã€Œãã®ä»–å¤§å‹¢ã€ã¨å‘¼ã°ã‚ŒãŸä»²é–“ãŸã¡ã®ãƒ—ãƒ©ã‚¤ãƒ‰ã‚’æãã€‚
${charactersPrompt}
### æ§‹æˆæ¡ˆ
1.  **ã€æ®ºåˆ°ã™ã‚‹å ±é“é™£ã€‘**: ç·´ç¿’ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«é›†ã¾ã‚‹ã€ã‚¨ãƒ¼ã‚¹ã ã‘ã‚’ç‹™ã†ç„¡æ•°ã®ã‚«ãƒ¡ãƒ©ã®æå†™ã‹ã‚‰å§‹ã‚ã‚‹ã€‚
2.  **ã€ã‚¨ãƒ¼ã‚¹ã®å­¤ç‹¬ãªãƒã‚¦ãƒ³ãƒ‰ã€‘**: ã‚¨ãƒ¼ã‚¹ã«ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã€‚ã€Œãƒãƒ¼ãƒ ã‚’å‹ãŸã›ã‚‹ã®ãŒè‡ªåˆ†ã®ä»•äº‹ã€ã¨èªã‚‹å½¼ã®è¨€è‘‰ã®è£ã«ã‚ã‚‹ã€é‡ã„ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‚’æå†™ã™ã‚‹ã€‚
3.  **ã€åã‚‚ãªãè„‡å½¹ãŸã¡ã®æ„åœ°ã€‘**: ãƒ¡ãƒ‡ã‚£ã‚¢ã‹ã‚‰ã¯æ³¨ç›®ã•ã‚Œãªã„ä»–ã®é‡æ‰‹ãŸã¡ã«ç„¦ç‚¹ã‚’å½“ã¦ã‚‹ã€‚ã€Œä¿ºãŸã¡ã¯ã€ã‚ã„ã¤ã®å¼•ãç«‹ã¦å½¹ã˜ã‚ƒãªã„ã€ã¨ã„ã†ã€å½¼ã‚‰ã®é™ã‹ãªãƒ—ãƒ©ã‚¤ãƒ‰ã¨è‘›è—¤ã‚’å¼•ãå‡ºã™ã€‚
4.  **ã€ç›£ç£ã®ä¿¡å¿µã€‘**: ç›£ç£ã«ã€Œå½¼ã‚‰ã¯ãƒ¯ãƒ³ãƒãƒ³ãƒãƒ¼ãƒ ã§ã™ã‹ï¼Ÿã€ã¨å•ã†ã€‚ã€Œä¸–é–“ã¯ãã†è¨€ã†ã ã‚ã†ã€‚ã ãŒã€æœ¬å½“ã®ä¸»å½¹ãŒèª°ãªã®ã‹ã‚’ç§ã ã‘ã¯çŸ¥ã£ã¦ã„ã‚‹ã€ã¨ã„ã†è¶£æ—¨ã®æ„å‘³æ·±ãªè¨€è‘‰ã‚’èªã‚‰ã›ã‚‹ã€‚
${reactionPrompt}
7.  **ã€ä¸€ã¤ã®ãƒãƒ¼ãƒ ã¨ã—ã¦ã€‘**: é‡æ‰‹ã®ä¸€äººãŒã€Œä¿ºãŸã¡ãŒã€ã‚ã„ã¤ã‚’ç”²å­åœ’ã®ãƒã‚¦ãƒ³ãƒ‰ã«é€£ã‚Œã¦è¡Œãã€ã¨åŠ›å¼·ãå®£è¨€ã—ã€ç‰©èªã‚’ç· ã‚ããã‚‹ã€‚
### å¿…ãšå«ã‚ã‚‹ã¹ãè¦ç´ 
- **ãƒãƒ¼ãƒ ãŒæŠ±ãˆã‚‹çŠ¶æ³ã‚’æå†™ã™ã‚‹ã“ã¨: ${teamMasterData.info}**
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆé•·ç·¨ã®è¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
            case 'win':
                title = `ã‚¨ãƒ¼ã‚¹å¿«æŠ•ï¼ã—ã‹ã—ã€å‹åˆ©ã®å½±ã«${teamName}ã®çµæŸã‚ã‚Š`;
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
ã€Œ${teamName}ã€ãŒå‹åˆ©ã€‚ãƒ¡ãƒ‡ã‚£ã‚¢ã¯ã‚¨ãƒ¼ã‚¹ã®å¿«æŠ•ã°ã‹ã‚Šã‚’å ±ã˜ã‚‹ã ã‚ã†ã€‚ã—ã‹ã—ã€ãã®è£ã«ã‚ã£ãŸä»²é–“ãŸã¡ã®ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚„ãƒãƒ¼ãƒ ã®çµæŸã“ããŒçœŸã®å‹å› ã ã£ãŸã“ã¨ã‚’ã€ã‚ãªãŸã®è¦–ç‚¹ã§æ·±ãæå†™ã—ã¦ãã ã•ã„ã€‚
### å¯¾æˆ¦ç›¸æ‰‹ã€Œ${matchData.opponent}ã€ã®èƒŒæ™¯
${matchData.opponentInfo}
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹
${matchData.summary || 'ç‰¹ã«ãªã—'}
### ã“ã®è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${matchData.highlights}
### æ§‹æˆæ¡ˆ
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€ãŒã€ã„ã‹ã«ãƒãƒ¼ãƒ ã®çµæŸåŠ›ã‚’è±¡å¾´ã™ã‚‹ãƒ—ãƒ¬ãƒ¼ã ã£ãŸã‹ã‚’ç‰©èªã®ä¸­å¿ƒã«æ®ãˆã‚‹ã€‚
2.  ã‚¨ãƒ¼ã‚¹ã®æŠ•çƒå†…å®¹ã‚’ç°¡æ½”ã«ç´¹ä»‹ã—ã¤ã¤ã€ã€Œã—ã‹ã—ã€ã“ã®æ—¥ã®ä¸»å½¹ã¯å½¼ã ã‘ã§ã¯ãªã‹ã£ãŸã€ã¨ç¶šã‘ã‚‹ã€‚
3.  ãã®ãƒ—ãƒ¬ãƒ¼ã‚’ã—ãŸé¸æ‰‹ã«ã€Œã‚¨ãƒ¼ã‚¹ã‚’åŠ©ã‘ã‚‹ã®ãŒä¿ºãŸã¡ã®ä»•äº‹ã§ã™ã‹ã‚‰ã€ã¨ã€èª‡ã‚‰ã—ã’ã«èªã‚‰ã›ã‚‹ã€‚
4.  ã‚¨ãƒ¼ã‚¹ã«ã€Œä»Šæ—¥ã®å‹åˆ©ã¯ã€ä¿ºä¸€äººã®åŠ›ã˜ã‚ƒãªã„ã€‚ã¿ã‚“ãªãŒå®ˆã£ã¦ãã‚ŒãŸãŠã‹ã’ã§ã™ã€ã¨ã€åˆã‚ã¦ä»²é–“ã«æ„Ÿè¬ã®è¨€è‘‰ã‚’è¿°ã¹ã•ã›ã‚‹ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆè¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
            case 'lose':
                title = `è‹±é›„ã€ã‚ã¾ã‚Šã«æ—©ã™ãã‚‹æ•—é€€ã€‚${teamName}ã®å¤ã€çµ‚ã‚ã‚‹`;
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ã‚’æ“ã—ãªãŒã‚‰ã€ã€Œ${teamName}ã€ã¯æ•—ã‚ŒãŸã€‚å¤©æ‰ã¨ä»²é–“ãŸã¡ã®ã€æ®‹é…·ã§ã€ã—ã‹ã—ç¾ã—ã„å¤ã®çµ‚ã‚ã‚Šã‚’æã„ã¦ãã ã•ã„ã€‚
### å¯¾æˆ¦ç›¸æ‰‹ã€Œ${matchData.opponent}ã€ã®èƒŒæ™¯
${matchData.opponentInfo}
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹
${matchData.summary || 'ç‰¹ã«ãªã—'}
### ã“ã®è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${matchData.highlights}
### æ§‹æˆæ¡ˆ
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€ãŒã€ã„ã‹ã«ã—ã¦çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ã‚’æ‰“ã¡å´©ã—ãŸã®ã‹ã€ãã®ä¸€ç¬ã‚’è©³ç´°ã«æå†™ã™ã‚‹ã€‚
2.  å¯¾æˆ¦ç›¸æ‰‹ãŒã©ã®ã‚ˆã†ãªãƒãƒ¼ãƒ ã§ã‚ã£ãŸã‹ï¼ˆã€å¯¾æˆ¦ç›¸æ‰‹ã®èƒŒæ™¯ã€‘ã‚’å‚ç…§ï¼‰ã«è§¦ã‚Œã‚‹ã“ã¨ã§ã€æ•—åŒ—ã®è¡æ’ƒã‚’éš›ç«‹ãŸã›ã‚‹ã€‚
3.  ãƒã‚¦ãƒ³ãƒ‰ã§å‘†ç„¶ã¨ã™ã‚‹ã‚¨ãƒ¼ã‚¹ã¨ã€å½¼ã«é§†ã‘å¯„ã‚Šã€ŒãŠå‰ã®ã›ã„ã˜ã‚ƒãªã„ã€ã¨å£°ã‚’ã‹ã‘ã‚‹ä»²é–“ãŸã¡ã®å§¿ã‚’æãã€‚
4.  ã€Œå½¼ã‚‰ã¯ãƒ¯ãƒ³ãƒãƒ³ãƒãƒ¼ãƒ ã§ã¯ãªã‹ã£ãŸã€‚å‹ã¤æ™‚ã‚‚ã€è² ã‘ã‚‹æ™‚ã‚‚ã€å½¼ã‚‰ã¯ä¸€ã¤ã®ãƒãƒ¼ãƒ ã ã£ãŸã€ã¨ç· ã‚ããã‚‹ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆè¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
        }
    } 
    // ==================================================================
    // --- 3. å¼·è±ªæ ¡ (powerhouse) ---
    // ==================================================================
    else if (type === 'powerhouse') {
        switch (phase) {
            case 'intro':
                title = `ã€${teamName}ã€ç‹è€…ã®å‘Šç™½ã€åºç« `;
                let reactionPrompt = '';
                if (matchData && matchData.opponent) {
                    const ourRank = calculateRank(teamName, tournamentState);
                    const opponentRank = matchData.opponentRank;
                    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
                    const rankDiff = rankValues[opponentRank] - rankValues[ourRank];

                    if (rankDiff >= 0) { // åŒæ ¼ã‹æ ¼ä¸Š
                        reactionPrompt = `
5.  **ã€è©¦ã•ã‚Œã‚‹ç‹å›½ã€‘**
    åˆæˆ¦ã®ç›¸æ‰‹ãŒã„ããªã‚Šå®ŸåŠ›æ ¡ã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚é¸æ‰‹ãŸã¡ã®é–“ã«èµ°ã‚‹ç·Šå¼µæ„Ÿã‚’ã€Œæ­“è¿ã™ã¹ãè©¦ç·´ã€ã¨ã—ã¦æå†™ã™ã‚‹ã€‚
6.  **ã€ç›£ç£ã®ã€å»ºå‰ã€ã¨ã€æœ¬éŸ³ã€ã€‘**
    ç›£ç£ã¯**é¸æ‰‹ãŸã¡ã®å‰ã§**ã€ã€Œåˆæˆ¦ã‹ã‚‰æœ€é«˜ã®ç›¸æ‰‹ã ã€‚æŒ‘æˆ¦è€…ã‚’å—ã‘ã‚‹è¦šæ‚Ÿã¯ã§ãã¦ã„ã‚‹ã€ã¨ã„ã†è¶£æ—¨ã§ã€ãƒãƒ¼ãƒ ã®ãƒ—ãƒ©ã‚¤ãƒ‰ã‚’ç…½ã‚‹ã€‚
    ã—ã‹ã—è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€ã€Œå³ã—ã„æˆ¦ã„ã«ãªã‚‹ã€‚ã ãŒã€ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã®æœ¬å‘½ã¯æˆ‘ã€…ã¨**${matchData.toughestRival}**ã€‚å½¼ã‚‰ã¯æ˜¨å¹´${matchData.toughestRivalRecord}ã€‚å€’ã™ãŸã‚ã«ã¯ã€ã©ã“ã‹ã§é€šã‚‰ãªã‘ã‚Œã°ã„ã‘ãªã„é“ã ã€ã¨ã„ã†è¶£æ—¨ã§ã€å³ã—ã„æœ¬éŸ³ã‚’èªã‚‰ã›ã‚‹ã€‚`;
                    } else { // æ ¼ä¸‹
                        reactionPrompt = `
5.  **ã€ç‹è€…ã®é™å¯‚ã€‘**
    åˆæˆ¦ã®ç›¸æ‰‹ãŒã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚é¸æ‰‹ãŸã¡ã¯è¡¨æƒ…ä¸€ã¤å¤‰ãˆãšã€æ·¡ã€…ã¨æ¬¡ã®ç·´ç¿’ã®æº–å‚™ã‚’å§‹ã‚ã‚‹ã€‚
6.  **ã€ç›£ç£ã®ã€å»ºå‰ã€ã¨ã€æœ¬éŸ³ã€ã€‘**
    ç›£ç£ãŒ**é¸æ‰‹ãŸã¡ã®å‰ã§**ã¯ã€Œæ²¹æ–­ã™ã‚‹ãªã€ã¨ã„ã†è¶£æ—¨ã§å¼•ãç· ã‚ã¤ã¤ã€è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€ã€Œåˆæˆ¦ã¯å•é¡Œãªã„ã€‚æœ¬å½“ã®å‹è² ã¯**${matchData.toughestRival}**æˆ¦ã€‚å½¼ã‚‰ã¯æ˜¨å¹´${matchData.toughestRivalRecord}ã®å®ŸåŠ›æ ¡ã ã€‚ãã“ãŒäº‹å®Ÿä¸Šã®æ±ºå‹æˆ¦ã«ãªã‚‹ã ã‚ã†ã€ã¨ã„ã†è¶£æ—¨ã§ã€å…ˆã‚’è¦‹æ®ãˆãŸåˆ†æã‚’èªã‚‰ã›ã‚‹ã€‚`;
                    }
                }
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
çµ¶å¯¾çš„ç‹è€…ã€Œ${teamName}ã€ã®æ „å…‰ã®è£ã«éš ã•ã‚ŒãŸè‹¦æ‚©ã¨ã€å¸¸äººã«ã¯ç†è§£ã—ãŒãŸã„ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‚’æãã€‚
${charactersPrompt}
### æ§‹æˆæ¡ˆ
1.  **ã€é™å¯‚ã®ãƒˆãƒ­ãƒ•ã‚£ãƒ¼å®¤ã€‘**: ç„¡æ•°ã«ä¸¦ã¶å„ªå‹ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ãŒæ”¾ã¤è¼ãã¨ã€ã€Œå‹ã£ã¦å½“ç„¶ã€ã¨ã„ã†é‡åœ§ã‚’æå†™ã™ã‚‹ã€‚
2.  **ã€Bã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®é™½ç‚ã€‘**: ãƒ™ãƒ³ãƒå…¥ã‚Šã§ããªã‹ã£ãŸ3å¹´ç”ŸãŒã€æœ€å¾Œã®å¤ã«ã‚‚é–¢ã‚ã‚‰ãšã€é»™ã€…ã¨å¾Œè¼©ã¸ã®ã‚µãƒãƒ¼ãƒˆã‚’å‹™ã‚ã‚‹ã€‚å½¼ã®ã€Œãƒãƒ¼ãƒ ã¸ã®æ„›ã€ã¨ã€Œè«¦ã‚ã€ã®ç‹¬ç™½ã‚’å¼•ãå‡ºã™ã€‚
3.  **ã€ç›£ç£ã®éæƒ…ãªå‹è² è«–ã€‘**: ç›£ç£ã«ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã€‚ã€Œå‹ã¤ãŸã‚ã«ã¯ã€æ™‚ã«éæƒ…ã«ãªã‚‰ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚ãã‚ŒãŒç‹è€…ã§ã‚ã‚Šç¶šã‘ã‚‹ã¨ã„ã†ã“ã¨ã ã€ã¨ã„ã†å½¼ã®å“²å­¦ã‚’èªã‚‰ã›ã‚‹ã€‚
4.  **ã€ä¸»å°†ã®å­¤ç‹¬ãªèƒŒä¸­ã€‘**: ã‚¹ã‚¿ãƒ¼é¸æ‰‹æƒã„ã®ãƒãƒ¼ãƒ ã‚’ä¸€ã¤ã«ã¾ã¨ã‚ã‚‹ã“ã¨ã®é›£ã—ã•ã¨ã€ã€Œè² ã‘ã‚‹ã“ã¨ãŒè¨±ã•ã‚Œãªã„ã€ã¨ã„ã†ç‹è€…ãªã‚‰ã§ã¯ã®å­¤ç‹¬ãªè¦šæ‚Ÿã‚’ä¸»å°†ã«èªã‚‰ã›ã‚‹ã€‚
${reactionPrompt}
7.  **ã€ç‹è€…ã€å‡ºé™£ã€‘**: ä¸»å°†ãŒã€Œä¿ºãŸã¡ã®ç›®æ¨™ã¯ã€çœŒå¤§ä¼šå„ªå‹ã˜ã‚ƒãªã„ã€‚ãã®å…ˆã«ã‚ã‚‹ã€ã¨ã€å…¨å›½ã®é ‚ç‚¹ã ã‘ã‚’è¦‹æ®ãˆã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºå”†ã—ã¦ç· ã‚ããã‚‹ã€‚
### å¿…ãšå«ã‚ã‚‹ã¹ãè¦ç´ 
- **ãƒãƒ¼ãƒ ãŒæŠ±ãˆã‚‹çŠ¶æ³ã‚’æå†™ã™ã‚‹ã“ã¨: ${teamMasterData.info}**
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆé•·ç·¨ã®è¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
            case 'win':
                title = `ã€${teamName}ã€ç‹è€…ã®å‘Šç™½ã€ç¬¬${matchData.round}ç« `;
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
ã€Œ${teamName}ã€ãŒå‹åˆ©ã€‚ã—ã‹ã—å½¼ã‚‰ã«ã¨ã£ã¦ã“ã®å‹åˆ©ã¯æ­“å–œã§ã¯ãªãã€ã€Œæ¬¡ã¸é€²ã‚€ãŸã‚ã®ç¾©å‹™ã€ã§ã—ã‹ãªã„ã€‚ãã®ç‹¬ç‰¹ã®ç©ºæ°—æ„Ÿã‚’ãƒªã‚¢ãƒ«ã«æå†™ã—ã¦ãã ã•ã„ã€‚
### å¯¾æˆ¦ç›¸æ‰‹ã€Œ${matchData.opponent}ã€ã®èƒŒæ™¯
${matchData.opponentInfo}
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹
${matchData.summary || 'ç‰¹ã«ãªã—'}
### ã“ã®è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${matchData.highlights}
### æ§‹æˆæ¡ˆ
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€ã‚’å¼•ç”¨ã—ã€ãã‚ŒãŒç‹è€…ã¨ã—ã¦ã®åŠ›ã®è¨¼æ˜ã§ã‚ã£ãŸã“ã¨ã‚’ç¤ºã™ã€‚
2.  å¯¾æˆ¦ç›¸æ‰‹ãŒã©ã®ã‚ˆã†ãªãƒãƒ¼ãƒ ã§ã‚ã£ãŸã‹ï¼ˆã€å¯¾æˆ¦ç›¸æ‰‹ã®èƒŒæ™¯ã€‘ã‚’å‚ç…§ï¼‰ã«è§¦ã‚Œã€å‹åˆ©ãŒé †å½“ã§ã‚ã£ãŸã“ã¨ã‚’æå†™ã™ã‚‹ã€‚
3.  è©¦åˆå¾Œã€å®‰å µã®è¡¨æƒ…ã‚’æµ®ã‹ã¹ã‚‹ã‚‚ã€æ±ºã—ã¦å–œã³ã‚’çˆ†ç™ºã•ã›ãªã„é¸æ‰‹ãŸã¡ã®å§¿ã€‚
4.  ç›£ç£ã«ã€Œä»Šæ—¥ã®ãƒ—ãƒ¬ãƒ¼ã§æº€è¶³ã›ãšã€æ¬¡ã‚’è¦‹æ®ãˆã¦ã„ã‚‹ã€ã¨ã„ã†è¶£æ—¨ã®ã€å†·é™ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’ã•ã›ã‚‹ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆè¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
            case 'lose':
                title = `ã€${teamName}ã€ç‹è€…ã®å‘Šç™½ã€æœ€çµ‚ç« `;
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
çµ¶å¯¾çš„ç‹è€…ã€Œ${teamName}ã€ã®å¤ãŒçµ‚ã‚ã£ãŸã€‚ç‹å›½ã®å´©å£Šã®ç¬é–“ã¨ã€é¸æ‰‹ãŸã¡ã®åˆã‚ã¦è¦‹ã›ã‚‹æ¶™ã€ãã—ã¦é‡åœ§ã‹ã‚‰ã®è§£æ”¾ã‚’æ„Ÿå‚·çš„ã«è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚
### å¯¾æˆ¦ç›¸æ‰‹ã€Œ${matchData.opponent}ã€ã®èƒŒæ™¯
${matchData.opponentInfo}
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹
${matchData.summary || 'ç‰¹ã«ãªã—'}
### ã“ã®è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${matchData.highlights}
### æ§‹æˆæ¡ˆ
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€ãŒã€ã„ã‹ã«ã—ã¦çµ¶å¯¾ç‹è€…ã®æ­¯è»Šã‚’ç‹‚ã‚ã›ãŸã®ã‹ã€ãã®ç¬é–“ã‚’å…‹æ˜ã«æå†™ã™ã‚‹ã€‚
2.  å¯¾æˆ¦ç›¸æ‰‹ãŒã©ã®ã‚ˆã†ãªãƒãƒ¼ãƒ ã§ã‚ã£ãŸã‹ï¼ˆã€å¯¾æˆ¦ç›¸æ‰‹ã®èƒŒæ™¯ã€‘ã‚’å‚ç…§ï¼‰ã«è§¦ã‚Œã€ã“ã®æ•—æˆ¦ãŒæ­´å²çš„ãªç•ªç‹‚ã‚ã›ã§ã‚ã‚‹ã“ã¨ã‚’å¼·èª¿ã™ã‚‹ã€‚
3.  è©¦åˆçµ‚äº†ã®ã‚µã‚¤ãƒ¬ãƒ³ãŒé³´ã‚ŠéŸ¿ãã€çƒå ´ã®ä¿¡ã˜ã‚‰ã‚Œãªã„ã‚ˆã†ãªé™å¯‚ã‚’æå†™ã™ã‚‹ã€‚
4.  ã“ã‚Œã¾ã§å¸¸ã«æ°—ä¸ˆã«æŒ¯ã‚‹èˆã£ã¦ããŸä¸»å°†ãŒã€åˆã‚ã¦ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«æ³£ãå´©ã‚Œã‚‹å§¿ã«ç„¦ç‚¹ã‚’å½“ã¦ã‚‹ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆè¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
        }
    } 
    // ==================================================================
    // --- 4. é€†å¢ƒãƒãƒ¼ãƒ  (underdog) ---
    // ==================================================================
    else { 
        switch (phase) {
            case 'intro':
                        // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
                        title = `ã€${teamName}ã€é­‚ã®è¨˜éŒ²ã€åºç« ï¼šãã‚Œã§ã‚‚ã€å½¼ã‚‰ã¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç«‹ã¤`;
                        let reactionPrompt = '';
                        let teamSpecificInfo = teamMasterData.info || 'ç‰¹ç­†ã™ã¹ãæƒ…å ±ãªã—';
                        let handicapFocusPrompt = ''; // å…ˆã«ç©ºã§å®šç¾©

                        // â–¼â–¼â–¼ ã€æœ€é‡è¦ã€‘ã€Œæµœæ¾ç‰¹æ”¯ã€å°‚ç”¨ã®ç‰¹åˆ¥åˆ†å² â–¼â–¼â–¼
                        if (teamName === 'æµœæ¾ç‰¹æ”¯') {
                            handicapFocusPrompt = `
3.  **ã€ç‰¹åˆ¥ãªå¤ã€ãã®æ„å‘³ã€‘**: çœŒå†…å”¯ä¸€ã®ç‰¹åˆ¥æ”¯æ´å­¦æ ¡ã®é‡çƒéƒ¨ã€æµœæ¾ç‰¹æ”¯ã€‚éƒ¨å“¡ã¯å…¨å“¡1å¹´ç”Ÿã€‚å½¼ã‚‰ã«ã¨ã£ã¦ã€ã“ã‚Œã¯åˆã‚ã¦ã®å¤ã§ã‚ã‚Šã€å…¨ã¦ãŒæŒ‘æˆ¦ã§ã‚ã‚‹ã€‚
4.  **ã€æ˜¥ã®è¨˜æ†¶ã¨å®‰å…¨ã¸ã®å£°ã€‘**: è¨˜è€…ãŒåŒ—æ‘ç›£ç£ã«è©±ã‚’èãã¨ã€å½¼ã¯æ˜¥ã®ç·´ç¿’è©¦åˆâ€”ç‹è€…ãƒ»283å­¦åœ’ã«å–«ã—ãŸã€Œ52-0ã€ã®å¤§æ•—â€”ã«ã¤ã„ã¦é‡ã„å£ã‚’é–‹ãã€‚ã€Œã‚ã®è©¦åˆã§ã€é¸æ‰‹ãŸã¡ã‹ã‚‰é‡çƒã®æ¥½ã—ã•ã‚’å¥ªã£ã¦ã—ã¾ã£ãŸã‹ã‚‚ã—ã‚Œãªã„ã€ã¨ã€‚åŒæ™‚ã«ã€å¤–éƒ¨ã‹ã‚‰å¯„ã›ã‚‰ã‚Œã‚‹ã€ŒçŸ¥çš„éšœå®³ã‚’æŒã¤å½¼ã‚‰ã«ã€ç¡¬çƒã‚’ä½¿ã£ãŸé‡çƒã¯æœ¬å½“ã«å®‰å…¨ãªã®ã‹ã€ã¨ã„ã†å³ã—ã„æ‰¹åˆ¤ã®å£°ã«ã‚‚ç›´é¢ã—ã¦ã„ã‚‹ã“ã¨ã‚’æ˜ã‹ã™ã€‚
5.  **ã€éƒ¨å®¤ã®é‡çƒãƒãƒ¼ãƒˆã€‘**: éƒ¨å®¤ä»£ã‚ã‚Šã®ç†ç§‘æº–å‚™å®¤ã«ç½®ã‹ã‚ŒãŸé‡çƒãƒãƒ¼ãƒˆã€‚ã€Œã“ã‚ã„ã€ã€ŒãŸã”(â€»ãŸã®ã—ããªã„)ã€ã€‚ãã“ã«ã¯ã€å½¼ã‚‰ã®ç´”ç²‹ãªææ€–ã¨è‹¦ã—ã¿ãŒè¨˜ã•ã‚Œã¦ã„ãŸã€‚
6.  **ã€ã‚ã‚‹é¸æ‰‹ã®æŒ‘æˆ¦ï¼ˆé«˜æ©‹ å¥å¤ªï¼‰ã€‘**: ãƒãƒ¼ãƒ ã®ä¸€äººã€é«˜æ©‹å¥å¤ªãã‚“ï¼ˆä»®åï¼‰ã«ç„¦ç‚¹ã‚’å½“ã¦ã‚‹ã€‚å½¼ã¯é‡åº¦ã®çŸ¥çš„éšœå®³ã‚’æŠ±ãˆã¦ãŠã‚Šã€ä»²é–“ã¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã€ãƒ«ãƒ¼ãƒ«ã®ç†è§£ã«ã‚‚äººä¸€å€æ™‚é–“ãŒã‹ã‹ã‚‹ã€‚ã ãŒã€ç·´ç¿’ã§å”¯ä¸€ã€Œãƒãƒƒãƒˆã«ãƒœãƒ¼ãƒ«ã‚’å½“ã¦ã‚‹ã€ã“ã¨ã ã‘ã¯èª°ã‚ˆã‚Šã‚‚å¾—æ„ã ã€‚
7.  **ã€ã‚ã‚‹æ¯è¦ªã®æ¶™ã€‘**: ç·´ç¿’ã‚’ãƒ•ã‚§ãƒ³ã‚¹è¶Šã—ã«è¦‹ã¤ã‚ã‚‹å¥å¤ªãã‚“ã®æ¯è¦ªã«ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã€‚ã€Œã‚ã®å­ãŒ...ã‚ã®å­ãŒã€ä»²é–“ã¨å£°ã‚’æ›ã‘åˆã£ã¦ãƒœãƒ¼ãƒ«ã‚’è¿½ã„ã‹ã‘ã¦ã„ã‚‹...ã€‚é‡çƒã‚’å§‹ã‚ã‚‹å‰ã¯ã€ãã‚“ãªã“ã¨æƒ³åƒã‚‚ã§ãã¾ã›ã‚“ã§ã—ãŸã€ã€‚å½¼å¥³ã¯ãã†è¨€ã†ã¨ã€æ„Ÿæ¥µã¾ã£ã¦æ¶™ã‚’æ‹­ã£ãŸã€‚ã€Œå‹ãŸãªãã¦ã„ã„ã€‚ãŸã ã€ã‚ã®å­ãŒæ¥½ã—ãã†ã«ãƒãƒƒãƒˆã‚’æŒ¯ã£ã¦ã€9å›ã¾ã§è©¦åˆãŒã§ããŸã‚‰...ãã‚Œã ã‘ã§...ã€
8.  **ã€ç›£ç£ã®è‘›è—¤ã€‘**: åŒ—æ‘ç›£ç£ã®è‘›è—¤ã‚’æå†™ã™ã‚‹ã€‚ã€Œå‹åˆ©ã€ã§ã¯ãªã„ã€‚ã€Œè©¦åˆã‚’æˆç«‹ã•ã›ã‚‹ã“ã¨ã€ã®çµ¶æœ›çš„ãªé›£ã—ã•ã€ãã—ã¦ã€Œå½¼ã‚‰ã®å®‰å…¨ã‚’å®ˆã‚ŠãªãŒã‚‰ã€ã©ã†ã‚„ã£ã¦é‡çƒã®æ¥½ã—ã•ã‚’å–ã‚Šæˆ»ã•ã›ã‚‹ã‹ã€ã¨ã„ã†ç­”ãˆã®ãªã„å•ã„ã«æ—¥ã€…å‘ãåˆã†å§¿ã‚’æ·±ãæ˜ã‚Šä¸‹ã’ã‚‹ã€‚
9.  **ã€å½¼ã‚‰ã®ç›®æ¨™ã€‘**: ä¸»å°†ã«ä»Šå¤§ä¼šã®ç›®æ¨™ã‚’èãã€‚ã€Œç”²å­åœ’ã˜ã‚ƒãªã„ã€‚9å›ã¾ã§æˆ¦ã„æŠœã„ã¦ã€ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã«...0ä»¥å¤–ã®æ•°å­—ã‚’ç¯ã—ãŸã„ã€ã€‚ãã®è¨€è‘‰ã®é‡ã¿ã‚’æå†™ã™ã‚‹ã€‚`;
                        }
                        // â–¼â–¼â–¼ ã€ã”è¦æœ›ã€‘ã€Œå»ƒæ ¡ã€ãƒãƒ¼ãƒ ã®å°‚ç”¨åˆ†å²ï¼ˆOBä¼šé•·ç™»å ´ï¼‰ â–¼â–¼â–¼
                        else if (teamSpecificInfo.includes('æœ€å¾Œã®å¤') || teamSpecificInfo.includes('é–‰æ ¡')) {
                            handicapFocusPrompt = `
3.  **ã€æœ€å¾Œã®ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã€‘**: ä»Šå¹´åº¦ã§é–‰æ ¡ã¨ãªã‚‹${teamName}ã€‚ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰è„‡ã§ã¯æ ¡èˆã®è§£ä½“ä½œæ¥­ãŒé€²ã‚€ã€‚é‡æ©Ÿã®éŸ³ãŒéŸ¿ãä¸­ã€ç·´ç¿’ã™ã‚‹ç•°æ§˜ãªæ—¥å¸¸ã‚’æå†™ã™ã‚‹ã€‚
4.  **ã€OBä¼šé•·ã®è¿½æ†¶ã€‘**: ç·´ç¿’ã‚’ãƒ•ã‚§ãƒ³ã‚¹è¶Šã—ã«è¦‹ã¤ã‚ã‚‹OBä¼šé•·ï¼ˆã¾ãŸã¯å¾Œæ´ä¼šä¼šé•·ï¼‰ã«ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã€‚å½¼ã¯ã€è§£ä½“ãŒé€²ã‚€æ¯æ ¡ã‚’è¤‡é›‘ãªé¢æŒã¡ã§è¦‹ã¤ã‚ãªãŒã‚‰ã€ã€Œæ˜”ã¯ã“ã“ã‚‚å…¨æ ¡ç”Ÿå¾’ã®å¿œæ´ã§æº¢ã‚Œã‹ãˆã£ã¦ã„ãŸã€ã€Œã¾ã•ã‹è‡ªåˆ†ãŸã¡ã®ä»£ã§æ ¡åãŒãªããªã‚‹ã¨ã¯æ€ã‚ãªã‹ã£ãŸã‚ˆâ€¦ã€ã¨ã€æ´»æ°—ãŒã‚ã£ãŸé ƒã®æ˜”ã®æ§˜å­ã‚’èªã‚Šã€å¯‚ã—ãã†ã«ç›®ã‚’ä¼ã›ã‚‹ã€‚
5.  **ã€3å¹´ç”Ÿã®æƒ³ã„ã€‘**: ã“ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç€ã‚‹æœ€å¾Œã®ä¸–ä»£ã¨ãªã£ãŸ3å¹´ç”Ÿã«ç„¦ç‚¹ã‚’å½“ã¦ã‚‹ã€‚ã€Œæ¯æ ¡ã®åå‰ã‚’åˆ»ã¿ãŸã„ã€ã¨ã„ã†OBä¼šé•·ãŸã¡ã®æƒ³ã„ã‚‚èƒŒè² ã„ã€å½¼ã‚‰ã®åˆ‡å®Ÿãªè¦šæ‚Ÿã¨ã€å¾Œè¼©ãŒã„ãªã„ï¼ˆã‚ã‚‹ã„ã¯å¼•ãç¶™ã’ãªã„ï¼‰ã“ã¨ã¸ã®è¤‡é›‘ãªå¿ƒå¢ƒã‚’å¼•ãå‡ºã™ã€‚
6.  **ã€ç›£ç£ã®å‹™ã‚ã€‘**: ç›£ç£ã«ã€Œæœ€å¾Œã®å¤ã€ã«è‡¨ã‚€å¿ƒå¢ƒã‚’å•ã†ã€‚æŠ€è¡“çš„ãªæŒ‡å°ä»¥ä¸Šã«ã€å½¼ã‚‰ã«ã¨ã£ã¦ã“ã®å¤ãŒã©ã®ã‚ˆã†ãªæ„å‘³ã‚’æŒã¤ã¹ãã‹ã€æ•™è‚²è€…ã¨ã—ã¦ã®è‘›è—¤ã¨æ±ºæ„ã‚’èªã‚‰ã›ã‚‹ã€‚`;
                        }
                        // â–¼â–¼â–¼ ä»–ã®é€†å¢ƒæ ¡ã®åˆ†å² â–¼â–¼â–¼
                        else if (teamSpecificInfo.includes('éƒ¨å“¡ä¸è¶³') || teamSpecificInfo.includes('é€£åˆãƒãƒ¼ãƒ ') || teamSpecificInfo.includes('0å‹')) {
                             handicapFocusPrompt = `
3.  **ã€é›†ã¾ã‚‰ãªã„9äººã€‘**: ${teamName}ã®ç·´ç¿’é¢¨æ™¯ã‚’æå†™ã™ã‚‹ã€‚åŠ©ã£äººã®ç”Ÿå¾’ï¼ˆä»–éƒ¨æ´»ï¼‰ã¨å…±ã«ç·´ç¿’ã™ã‚‹æ§˜å­ã‚„ã€ç›£ç£è‡ªã‚‰ãŒãƒãƒƒã‚¯ã®çƒæ‹¾ã„ã‚’ã™ã‚‹å§¿ã‚’æãã€‚ï¼ˆâ€»ã‚‚ã—ã€Œ0å‹32æ•—ã€ã®ã‚ˆã†ãªæƒ…å ±ãŒã‚ã‚Œã°ã€ãã®æ­´å²çš„æ•—åŒ—ã®é‡åœ§ã«ã‚‚è§¦ã‚Œã‚‹ï¼‰
4.  **ã€ä¸»å°†ã®è‹¦åŠ´ã€‘**: è©¦åˆã«å‡ºã‚‹ã ã‘ã§ãªãã€éƒ¨å“¡ã®å‹§èª˜ã‚„ãƒãƒ¼ãƒ ã®é›°å›²æ°—ä½œã‚Šã«å¥”èµ°ã™ã‚‹ä¸»å°†ã«ç„¦ç‚¹ã‚’å½“ã¦ã‚‹ã€‚ã€Œé‡çƒãŒã§ãã‚‹ã ã‘ã§ã‚ã‚ŠãŒãŸã„ã€ã¨ã„ã†å½¼ã®è¨€è‘‰ã®é‡ã¿ã‚’æå†™ã™ã‚‹ã€‚
5.  **ã€ç›£ç£ã®ä¿¡å¿µã€‘**: ç›£ç£ã«ã€Œãªãœé‡çƒéƒ¨ã‚’ç¶šã‘ã‚‹ã®ã‹ã€ã‚’å•ã†ã€‚å‹åˆ©ä»¥å‰ã«ã€é‡çƒã‚’é€šã˜ã¦å½¼ã‚‰ã«ä½•ã‚’å­¦ã‚“ã§ã»ã—ã„ã®ã‹ã€ãã®ä¿¡å¿µã‚’èªã‚‰ã›ã‚‹ã€‚`;
                        } else if (teamSpecificInfo.includes('é›¢å³¶')) {
                             handicapFocusPrompt = `
3.  **ã€å³¶ã‚’èƒŒè² ã†ã€‘**: æœ¬åœŸã‹ã‚‰é ãé›¢ã‚ŒãŸ${teamName}ã€‚ç·´ç¿’è©¦åˆã‚‚ã¾ã¾ãªã‚‰ãšã€æƒ…å ±ã‚‚å°‘ãªã„ã¨ã„ã†çµ¶æœ›çš„ãªãƒãƒ³ãƒ‡ã‚’æå†™ã™ã‚‹ã€‚
4.  **ã€å³¶æ°‘ã®æœŸå¾…ã€‘**: å½¼ã‚‰ã®å­˜åœ¨ãŒã€å³¶ã«ã¨ã£ã¦ã©ã®ã‚ˆã†ãªå¸Œæœ›ã¨ãªã£ã¦ã„ã‚‹ã®ã‹ã€‚ç·´ç¿’ã‚’è¦‹å®ˆã‚‹åœ°å…ƒä½æ°‘ã‚„ã€æ¼ã®åˆé–“ã«æ‰‹ä¼ã†OBã®å£°ã‚’æ‹¾ã†ã€‚
5.  **ã€ç›£ç£ã®æˆ¦ç•¥ã€‘**: ç›£ç£ã«ã€Œæœ¬åœŸã®å¼·è±ªã‚’ã©ã†å€’ã™ã‹ã€ã‚’å•ã†ã€‚æƒ…å ±ãŒå°‘ãªã„ä¸­ã§ã€å½¼ã‚‰ãŒç£¨ã„ã¦ããŸã€Œå³¶ãªã‚‰ã§ã¯ã®é‡çƒã€ã¨ã¯ä½•ã‹ã‚’èªã‚‰ã›ã‚‹ã€‚`;
                        } else {
                            // ä¸Šè¨˜ä»¥å¤–ã®é€†å¢ƒæ ¡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                            handicapFocusPrompt = `
3.  **ã€ãƒãƒ¼ãƒ ã®ç¾åœ¨åœ°ã€‘**: è¨˜è€…ãŒãƒãƒ¼ãƒ ã®å…ƒã‚’è¨ªã‚Œã‚‹å ´é¢ã‹ã‚‰å§‹ã‚ã‚‹ã€‚ç›£ç£ã‚„é¸æ‰‹ã«ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã—ã€ãƒãƒ¼ãƒ ãŒæŠ±ãˆã‚‹å…·ä½“çš„ãªãƒãƒ³ãƒ‡ï¼ˆä¾‹ï¼š${teamSpecificInfo}ï¼‰ã¨ã€ãã‚Œã«å¯¾ã™ã‚‹å½¼ã‚‰ã®æƒ³ã„ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹ã€‚
4.  **ã€ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®æƒ…æ™¯ã€‘**: ç·´ç¿’é¢¨æ™¯ã‚’æå†™ã™ã‚‹ã€‚éƒ¨å“¡æ•°ã®å°‘ãªã•ï¼ˆä¾‹ï¼šç´…ç™½æˆ¦ãŒã§ããªã„ï¼‰ã€æµã¾ã‚Œãªã„ç·´ç¿’ç’°å¢ƒï¼ˆä¾‹ï¼šã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãŒä»–ã®éƒ¨ã¨å…±ç”¨ã€é“å…·ãŒå¤ã„ï¼‰ã¨ã„ã£ãŸã€å½¼ã‚‰ã®ã€Œæ—¥å¸¸ã€ã‚’å…·ä½“çš„ã«æãã€‚`;
                        }


                        if (matchData && matchData.opponent) {
                            const ourRank = calculateRank(teamName, tournamentState);
                            const opponentRank = matchData.opponentRank;
                            const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
                            const rankDiff = rankValues[opponentRank] - rankValues[ourRank];
                            
                            // æ§‹æˆæ¡ˆã®ã‚¹ãƒ†ãƒƒãƒ—æ•°ã‚’å‹•çš„ã«è¨ˆç®—
                            const handicapSteps = handicapFocusPrompt.split('\n').filter(line => line.trim().match(/^\d+\./)).length;
                            const stepOffset = 1 + 1 + handicapSteps; // (å†’é ­ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ + ç¾å®Ÿ) + ãƒãƒ³ãƒ‡æ§‹æˆæ¡ˆã®ã‚¹ãƒ†ãƒƒãƒ—æ•°

                            if (rankDiff >= 2) { // çµ¶æœ›çš„ãªæ ¼ä¸Š
                                reactionPrompt = `
${stepOffset + 1}.  **ã€æ®‹é…·ãªç¾å®Ÿã€ãã—ã¦ç›£ç£ã®ã€å»ºå‰ã€ã€‘**: åˆæˆ¦ã®ç›¸æ‰‹ãŒæ ¼ä¸Šã®å¼·è±ªã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚çµ¶æœ›ã¨æ²ˆé»™ã«åŒ…ã¾ã‚Œã‚‹é¸æ‰‹ãŸã¡ã‚’æå†™ã™ã‚‹ã€‚
${stepOffset + 2}.  **ã€ç›£ç£å®¤ã®ã€æœ¬éŸ³ã€ã€‘**: ç›£ç£ãŒ**é¸æ‰‹ãŸã¡ã®å‰ã§**ã¯ã€Œã“ã‚Œã¯è©¦ç·´ã ã€‚ã ãŒã€æ­´å²ã‚’å‰µã‚‹ãƒãƒ£ãƒ³ã‚¹ã§ã‚‚ã‚ã‚‹ã€ã¨åŠ›å¼·ãèªã‚‹ä¸€æ–¹ã€è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€Œã„ã‚„ã€æ­£ç›´ã—ã‚“ã©ã„ã§ã™ã‚ˆâ€¦ç¬‘ã£ã¡ã‚ƒã„ã¾ã—ãŸã‚‚ã‚“ã€ã¾ã•ã‹ã€‡ã€‡ï¼ˆç›¸æ‰‹æ ¡åï¼‰ã¨å½“ãŸã‚‹ãªã‚“ã¦â€¦ã€ã¨ã€äººé–“å‘³ã‚ãµã‚Œã‚‹å¼±éŸ³ã‚„æœ¬éŸ³ã‚’æ¼ã‚‰ã™ã€‚`;
                            } else if (rankDiff >= 1) { // å°‘ã—æ ¼ä¸Š
                                reactionPrompt = `
${stepOffset + 1}.  **ã€æŒ‘æˆ¦è€…ãŸã¡ã€‘**: åˆæˆ¦ã®ç›¸æ‰‹ãŒã€æ ¼ä¸Šã®ã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚é¸æ‰‹ãŸã¡ãŒã€Œä¸è¶³ã¯ãªã„ç›¸æ‰‹ã€ã€Œä¸€æ³¡å¹ã‹ã›ã¦ã‚„ã‚‹ã€ã¨é—˜å¿—ã‚’ç‡ƒã‚„ã™æ§˜å­ã‚’æå†™ã™ã‚‹ã€‚
${stepOffset + 2}.  **ã€ç›£ç£ã®æˆ¦ç•¥ã€‘**: ç›£ç£ã¯**é¸æ‰‹ãŸã¡ã®å‰ã§**ã€Œè‰¯ã„é¡”ã¤ãã«ãªã£ãŸãªã€ã¨å½¼ã‚‰ã®å£«æ°—ã‚’é«˜ã‚ã¤ã¤ã€è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€Œæ­£ç›´ã€å‹ç‡ã¯3å‰²ã‚‚ãªã„ã§ã—ã‚‡ã†ã€‚ã§ã‚‚ã€é«˜æ ¡é‡çƒã¯ä½•ãŒèµ·ã“ã‚‹ã‹åˆ†ã‹ã‚‰ãªã„ã€ã¨ã€å†·é™ãªåˆ†æã¨æœ¬éŸ³ã‚’èªã‚‹ã€‚`;
                            } else { // åŒæ ¼ã‹æ ¼ä¸‹
                                reactionPrompt = `
${stepOffset + 1}.  **ã€é‹å‘½ã®åˆæˆ¦ã€‘**: åˆæˆ¦ã®ç›¸æ‰‹ãŒå®ŸåŠ›ã®è¿‘ã„ã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚ã€Œå‹ã¦ã‚‹ï¼ã€ã¨å°‘ã—æµ®è¶³ç«‹ã¤é¸æ‰‹ãŸã¡ã‚’æå†™ã™ã‚‹ã€‚
${stepOffset + 2}.  **ã€ç›£ç£ã®ã€å»ºå‰ã€ã¨ã€æœ¬éŸ³ã€ã€‘**: ç›£ç£ãŒ**é¸æ‰‹ãŸã¡ã®å‰ã§**ã€Œæ²¹æ–­ãŒä¸€ç•ªã®æ•µã ã€ã¨å³ã—ãä¸€å–ã™ã‚‹ä¸€æ–¹ã€è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€Œæœ€é«˜ã®ã‚¯ã‚¸ã‚’å¼•ãã¾ã—ãŸã€‚ã“ã“ã‚’å‹ã¦ã°ã€é–“é•ã„ãªããƒãƒ¼ãƒ ã¯æ³¢ã«ä¹—ã‚Œã‚‹ã€ã¨ã€å®‰å µã¨ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ãŒå…¥ã‚Šæ··ã˜ã£ãŸæœ¬éŸ³ã‚’èªã‚‹ã€‚`;
                            }
                        }

                        // æœ€å¾Œã®æ±ºæ„è¡¨æ˜ã®ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·ã‚‚å‹•çš„ã«
                        const finalStepNumber = (handicapFocusPrompt.split('\n').filter(line => line.trim().match(/^\d+\./)).length) + (reactionPrompt ? 2 : 0) + 3;
                        let finalPledge = 'ä¿ºãŸã¡ã¯é‡çƒãŒã—ãŸã„ã ã‘ã€‚ç›¸æ‰‹ãŒèª°ã§ã‚‚ã€å…¨åŠ›ã§æˆ¦ã†ã ã‘ã§ã™'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                        if (teamName === 'æµœæ¾ç‰¹æ”¯') finalPledge = 'æ€–ã„ã‘ã©...é€ƒã’ã¾ã›ã‚“ã€‚9å›ã¾ã§æˆ¦ã„ã¾ã™';
                        if (teamSpecificInfo.includes('æœ€å¾Œã®å¤')) finalPledge = 'ã“ã‚ŒãŒæœ€å¾Œã®å¤ã€‚ä¸€è©¦åˆã§ã‚‚é•·ãã€ã“ã®ä»²é–“ã¨ã€æ¯æ ¡ã®åå‰ã§é‡çƒãŒã—ãŸã„ã§ã™';


                        prompt += `
### å–æãƒ†ãƒ¼ãƒ
ã€Œ${teamName}ã€ãŒæŠ±ãˆã‚‹å›°é›£ãªçŠ¶æ³ã¨ã€ãã‚Œã§ã‚‚å¤¢ã‚’è«¦ã‚ãªã„å½¼ã‚‰ã®å§¿ã‚’ã€æ·±ãã€æ¿ƒãæããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼åºç« ã€‚
${charactersPrompt}
### æ§‹æˆæ¡ˆ
1.  **ã€å†’é ­ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‘**: ã€Œã€‡ã€‡ï¼ˆåœ°åï¼‰ã®ç©ºã®ä¸‹ã€ä»Šæ—¥ã‚‚å½¼ã‚‰ã®å£°ãŒéŸ¿ãã€‚${teamName === 'æµœæ¾ç‰¹æ”¯' ? 'â€”ãŸã¨ãˆã€ãã®å£°ãŒã¾ã ã€é‡çƒã¸ã®ææ€–ã«éœ‡ãˆã¦ã„ãŸã¨ã—ã¦ã‚‚ã€‚' : 'ã—ã‹ã—ã€ãã®å£°ã¯ã‚ã¾ã‚Šã«ã‚‚å°‘ãªã„ã€‚'}ã€ã¨ã„ã£ãŸã€ãƒãƒ¼ãƒ ã®çŠ¶æ³ã‚’è±¡å¾´ã™ã‚‹ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰å§‹ã‚ã‚‹ã€‚
2.  **ã€å½¼ã‚‰ã®"ç¾å®Ÿ"ã€‘**: ${teamSpecificInfo}
${handicapFocusPrompt}
${reactionPrompt}
${finalStepNumber}. **ã€æ±ºæ„è¡¨æ˜ã€‘**: æœ€å¾Œã«ã€ä¸»å°†ãŒã€Œ${finalPledge}ã€ã¨ã€å¤§ä¼šã¸å‘ã‹ã†æ±ºæ„ã‚’èªã‚Šã€ç· ã‚ããã‚‹ã€‚
### æå†™ã®ãƒã‚¤ãƒ³ãƒˆ
- **äº”æ„Ÿã‚’åˆºæ¿€ã™ã‚‹æå†™**: ç·´ç¿’é¢¨æ™¯ã§ã¯ã€åœŸã®åŒ‚ã„ã€å¤ã„é©ã®åŒ‚ã„ã€é‡‘å±ãƒãƒƒãƒˆã®ä¹¾ã„ãŸéŸ³ã€ç›£ç£ã®æ€’é³´ã‚Šå£°ãªã©ã€æƒ…æ™¯ãŒç›®ã«æµ®ã‹ã¶ã‚ˆã†ãªå…·ä½“çš„ãªæå†™ã‚’å¤šç”¨ã™ã‚‹ã“ã¨ã€‚
- **å¯¾æ¯”**: ã€Œä»–æ ¡ã®æµã¾ã‚ŒãŸç’°å¢ƒã€ã¨ã€Œå½¼ã‚‰ã®ç¾å®Ÿã€ã‚’å¯¾æ¯”ã•ã›ã‚‹ã“ã¨ã§ã€é€†å¢ƒã‚’éš›ç«‹ãŸã›ã‚‹ã“ã¨ã€‚
- **æ„Ÿæƒ…ã®æ©Ÿå¾®**: é¸æ‰‹ã®ã€Œæ‚”ã—ã•ã€ã€Œç„¦ã‚Šã€ã ã‘ã§ãªãã€ãã®ä¸­ã«ã‚ã‚‹ã€Œèª‡ã‚Šã€ã‚„ã€Œä»²é–“ã¨ã®çµ†ã€ã‚‚ä¸å¯§ã«æå†™ã™ã‚‹ã“ã¨ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆé•·ç·¨ã®è¨˜äº‹æœ¬æ–‡ï¼‰"}`;                break;
            case 'lose':
                title = `ã€${teamName}ã€é­‚ã®è¨˜éŒ²ã€æœ€çµ‚ç« `;
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
ã€Œ${teamName}ã€ã®å¤ãŒçµ‚ã‚ã£ãŸã€‚å¤¢ç ´ã‚ŒãŸå½¼ã‚‰ã®å§¿ã¨ã€ãã‚Œã§ã‚‚ç¢ºã‹ã«æ®‹ã£ãŸã‚‚ã®ã‚’æããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼æœ€çµ‚ç« ã€‚
### å¯¾æˆ¦ç›¸æ‰‹ã€Œ${teamName}ã€ã®èƒŒæ™¯
${matchData.opponentInfo}
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹
${matchData.summary || 'ç‰¹ã«ãªã—'}
### ã“ã®è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${matchData.highlights}
### æ§‹æˆæ¡ˆ
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€ã«è§¦ã‚Œã€ã‚ã¨ä¸€æ­©åŠã°ãªã‹ã£ãŸå½¼ã‚‰ã®å¥®é—˜ã‚’ç§°ãˆã‚‹ã€‚
2.  å¯¾æˆ¦ç›¸æ‰‹ãŒã©ã®ã‚ˆã†ãªãƒãƒ¼ãƒ ã§ã‚ã£ãŸã‹ï¼ˆã€å¯¾æˆ¦ç›¸æ‰‹ã®èƒŒæ™¯ã€‘ã‚’å‚ç…§ï¼‰ã«è§¦ã‚Œã€ã€Œã‚ˆãã‚„ã£ãŸã€ã€Œæ‚”ã—ã„ã€ã¨ã„ã£ãŸæ„Ÿæƒ…ã‚’å¢—å¹…ã•ã›ã‚‹ã€‚
3.  è©¦åˆçµ‚äº†ã®ç¬é–“ã€æ³£ãå´©ã‚Œã‚‹ã‚‚ã€ã‚„ãŒã¦é¡”ã‚’ä¸Šã’ã€ç›¸æ‰‹ã«ã‚¨ãƒ¼ãƒ«ã‚’é€ã‚‹é¸æ‰‹ãŸã¡ã®å§¿ã‚’æå†™ã™ã‚‹ã€‚
4.  3å¹´ç”Ÿã®å¼•é€€ã¨ã€å½¼ã‚‰ã®æƒ³ã„ãŒå¾Œè¼©ãŸã¡ã¸ã¨å—ã‘ç¶™ãŒã‚Œã¦ã„ãã“ã¨ã‚’ç¤ºå”†ã—ã¦ã€ç‰©èªã‚’ç· ã‚ããã‚‹ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆè¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
        }
    }
    
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (article) return { ...article, timestamp: Date.now() };
        }
        throw new Error("AI response format error.");
    } catch (error) {
        console.error("AI documentary article generation failed:", error);
        return null;
    }
}

/**
 * Sets the weather effect for the background.
 * @param {'none' | 'rain' | 'sun'} weatherType - The type of weather to display.
 */
function setWeather(weatherType) {
    const rainContainer = document.getElementById('rain-container');
    const sunContainer = document.getElementById('sun-container');

    // Hide all weather effects first
    rainContainer.classList.add('hidden');
    sunContainer.classList.add('hidden');
    rainContainer.innerHTML = ''; // Clear old raindrops

    if (weatherType === 'rain') {
        rainContainer.classList.remove('hidden');
        // Create 100 raindrops
        for (let i = 0; i < 100; i++) {
            const drop = document.createElement('div');
            drop.className = 'drop';
            drop.style.left = Math.random() * 100 + 'vw';
            drop.style.animationDelay = Math.random() * 0.5 + 's';
            drop.style.animationDuration = Math.random() * 0.2 + 0.3 + 's';
            rainContainer.appendChild(drop);
        }
    } else if (weatherType === 'sun') {
        sunContainer.classList.remove('hidden');
    }
}

/**
 * è©³ç´°å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã€ã¾ãŸã¯ãƒãƒ¼ãƒ åè‡ªä½“ã‚’å…¥ã‚Œæ›¿ãˆã‚‹
 * @param {string} matchId - å¯¾è±¡ã®è©¦åˆID
 */
function swapTeamDetails(matchId) {
    const match = findMatchById(matchId);
    if (!match) return;

    // 1. ãƒãƒ¼ãƒ åã¨ã€ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¹ã‚³ã‚¢ã‚’å…¥ã‚Œæ›¿ãˆã‚‹
    const tempTeam = match.team1;
    match.team1 = match.team2;
    match.team2 = tempTeam;

    const tempScore = match.score1;
    match.score1 = match.score2;
    match.score2 = tempScore;

    // 2. ã‚‚ã—è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›æ¸ˆã¿ãªã‚‰ã€ãã®ä¸­èº«ã‚‚å…¥ã‚Œæ›¿ãˆã‚‹
    if (match.details) {
        // æ‰“æ’ƒãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œæ›¿ãˆ
        const tempBatting = match.details.batting.team1;
        match.details.batting.team1 = match.details.batting.team2;
        match.details.batting.team2 = tempBatting;

        // æŠ•æ‰‹ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œæ›¿ãˆ
        const tempPitching = match.details.pitching.team1;
        match.details.pitching.team1 = match.details.pitching.team2;
        match.details.pitching.team2 = tempPitching;
        
        // ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ã‚’å…¥ã‚Œæ›¿ãˆ
        if (match.details.inningScore) {
            const tempInningScore = match.details.inningScore.team1;
            match.details.inningScore.team1 = match.details.inningScore.team2;
            match.details.inningScore.team2 = tempInningScore;
        }
    }

    // 3. å¤‰æ›´ã‚’ä¿å­˜ã—ã€ç”»é¢ã‚’æ›´æ–°ã™ã‚‹
    saveState();
    renderTournament(tournamentState); // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚‚æ›´æ–°
    openDetailsModal(matchId); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†æç”»ã—ã¦å¤‰æ›´ã‚’åæ˜ 
}
/**
 * ãƒãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
 */
function showTeamStatusModal(teamName) {
    const teamRecord = tournamentState.teamRecords[teamName];
    if (!teamRecord) return;

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¦ç´ ã‚’å–å¾—
    const modal = document.getElementById('team-status-modal');
    const bestEl = document.getElementById('status-modal-best');
    const historyEl = document.getElementById('status-modal-history');
    const traitsEl = document.getElementById('status-modal-traits');
    // â†“â†“â†“ ãŠãã‚‰ãæŠœã‘ã¦ã„ãŸã®ãŒã“ã®ä¸€è¡Œã§ã™ â†“â†“â†“
    const coachEl = document.getElementById('status-modal-coach'); 

    // ãƒãƒ¼ãƒ åã‚’è¨­å®š
    document.getElementById('status-modal-team-name').textContent = teamName;
    
    // æœ€é«˜æˆ¦ç¸¾ã‚’è¨­å®š
    bestEl.textContent = teamRecord.best ? formatRecordToString(teamRecord.best) : 'ã¾ã ã‚ã‚Šã¾ã›ã‚“';

    // ç›´è¿‘ã®æˆç¸¾ã‚’è¨­å®š
    historyEl.innerHTML = '';
    if (teamRecord.history && teamRecord.history.length > 0) {
        teamRecord.history.slice(0, 2).forEach(rec => {
            const p = document.createElement('p');
            p.textContent = formatRecordToString(rec);
            historyEl.appendChild(p);
        });
    } else {
        historyEl.innerHTML = '<p>ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';
    }

    // ç§°å·ã‚’è¨­å®š
    traitsEl.innerHTML = '';
    if (teamRecord.teamTraits && teamRecord.teamTraits.length > 0) {
        teamRecord.teamTraits.forEach(traitId => {
            const trait = TITLES[traitId];
            if (trait) {
                const span = document.createElement('span');
                span.className = 'bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full';
                span.textContent = trait.name;
                traitsEl.appendChild(span);
            }
        });
    } else {
        traitsEl.innerHTML = '<p class="text-gray-500 text-sm">ãªã—</p>';
    }
    
// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    // ãƒãƒ¼ãƒ ã®ä»Šå¤§ä¼šæˆç¸¾ã‚’è¨­å®š
    const statsEl = document.getElementById('status-modal-team-stats');
    const stats = teamRecord.tournamentStats;
    if (stats && stats.ab > 0) {
        const avg = (stats.h / stats.ab).toFixed(3);
        statsEl.textContent = `æ‰“ç‡ ${avg} (${stats.ab}æ‰“æ•° ${stats.h}å®‰æ‰“) ${stats.hr}æœ¬å¡æ‰“ ${stats.rbi}æ‰“ç‚¹`;
    } else if (stats) {
        statsEl.textContent = `(ä»Šå¤§ä¼š ${stats.ab}æ‰“æ•° ${stats.h}å®‰æ‰“)`;
    } else {
        statsEl.textContent = 'ï¼ˆä»Šå¤§ä¼šã®é›†è¨ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰';
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²


    // ç›£ç£æƒ…å ±ã‚’è¨­å®š
    const teamMasterData = TEAM_DATA[teamName];
    if (teamMasterData && teamMasterData.coach) {
        const coach = teamMasterData.coach;
        coachEl.textContent = `${coach.name} (${coach.experience} / ${coach.style})`;
    } else {
        coachEl.textContent = 'æƒ…å ±ãªã—';
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    modal.classList.remove('hidden');
}
    // --- Custom Alert/Confirm ---
    function showAlert(message) {
        alert(message);
    }

    function showConfirm(message) {
        return new Promise((resolve) => {
            const confirmOk = document.getElementById('confirm-ok');
            const confirmCancel = document.getElementById('confirm-cancel');
            document.getElementById('confirm-modal-text').textContent = message;
            confirmModal.classList.remove('hidden');

            const onOk = () => {
                confirmModal.classList.add('hidden');
                cleanup();
                resolve(true);
            };

            const onCancel = () => {
                confirmModal.classList.add('hidden');
                cleanup();
                resolve(false);
            };
            
            const cleanup = () => {
                confirmOk.removeEventListener('click', onOk);
                confirmCancel.removeEventListener('click', onCancel);
            };

            confirmOk.addEventListener('click', onOk);
            confirmCancel.addEventListener('click', onCancel);
        });
    }

// --- Utility & State Functions --- ãªã©ã«è¿½åŠ 

// ç”²å­åœ’ã§ã®æˆç¸¾ã‚’å®šç¾©ï¼ˆæ•°å­—ãŒå°ã•ã„ã»ã©ä¸Šä½ï¼‰
const KOSHIEN_RESULTS = {
    CHAMPION:       { rank: -1, label: 'å…¨å›½å„ªå‹' },
    RUNNER_UP:    { rank: -2, label: 'å…¨å›½æº–å„ªå‹' },
    BEST_4:         { rank: -4, label: 'ç”²å­åœ’ãƒ™ã‚¹ãƒˆ4' },
    BEST_8:         { rank: -8, label: 'ç”²å­åœ’ãƒ™ã‚¹ãƒˆ8' },
    BEST_16:        { rank: -16, label: 'ç”²å­åœ’3å›æˆ¦æ•—é€€' }, // ãƒ™ã‚¹ãƒˆ16
    ROUND_2:        { rank: -32, label: 'ç”²å­åœ’2å›æˆ¦æ•—é€€' },
    ROUND_1:        { rank: -64, label: 'ç”²å­åœ’åˆæˆ¦æ•—é€€' },
};

// ãƒãƒ¼ãƒ ã®Aï½Eãƒ©ãƒ³ã‚¯ã”ã¨ã®ã€ç”²å­åœ’ã§ã®æˆç¸¾ç¢ºç‡ï¼ˆã‚¦ã‚§ã‚¤ãƒˆæ–¹å¼ï¼‰
const KOSHIEN_PROBABILITIES = {
    'A': [
        { result: 'CHAMPION', weight: 20 }, { result: 'RUNNER_UP', weight: 25 },
        { result: 'BEST_4', weight: 25 },   { result: 'BEST_8', weight: 15 },
        { result: 'BEST_16', weight: 10 },  { result: 'ROUND_2', weight: 4 },
        { result: 'ROUND_1', weight: 1 }
    ],
    'B': [
        { result: 'CHAMPION', weight: 5 },  { result: 'RUNNER_UP', weight: 10 },
        { result: 'BEST_4', weight: 20 },   { result: 'BEST_8', weight: 30 },
        { result: 'BEST_16', weight: 20 },  { result: 'ROUND_2', weight: 10 },
        { result: 'ROUND_1', weight: 5 }
    ],
    'C': [
        { result: 'CHAMPION', weight: 1 },  { result: 'RUNNER_UP', weight: 3 },
        { result: 'BEST_4', weight: 8 },    { result: 'BEST_8', weight: 20 },
        { result: 'BEST_16', weight: 30 },  { result: 'ROUND_2', weight: 28 },
        { result: 'ROUND_1', weight: 10 }
    ],
    'D': [
        { result: 'BEST_8', weight: 5 },    { result: 'BEST_16', weight: 15 },
        { result: 'ROUND_2', weight: 40 },  { result: 'ROUND_1', weight: 40 }
    ],
    'E': [
        { result: 'BEST_16', weight: 5 },   { result: 'ROUND_2', weight: 25 },
        { result: 'ROUND_1', weight: 70 }
    ],
};

/**
 * ãƒãƒ¼ãƒ ãƒ©ãƒ³ã‚¯ã«åŸºã¥ãã€ç”²å­åœ’ã§ã®æˆç¸¾ã‚’ç¢ºç‡ã§æ±ºå®šã™ã‚‹
 * @param {string} teamRank - 'A'ã‹ã‚‰'E'ã¾ã§ã®ãƒãƒ¼ãƒ ãƒ©ãƒ³ã‚¯
 * @returns {string} - KOSHIEN_RESULTSã®ã‚­ãƒ¼ ('CHAMPION', 'BEST_8'ãªã©)
 */
function simulateKoshien(teamRank) {
    const probabilities = KOSHIEN_PROBABILITIES[teamRank] || KOSHIEN_PROBABILITIES['E'];
    const totalWeight = probabilities.reduce((sum, p) => sum + p.weight, 0);
    let random = Math.random() * totalWeight;

    for (const prob of probabilities) {
        if (random < prob.weight) {
            return prob.result;
        }
        random -= prob.weight;
    }
    return 'ROUND_1'; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
}
    /**
     * è©¦åˆIDã‚’å…ƒã«ã€stateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ·±ã„éšå±¤ã‹ã‚‰è©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¤œç´¢ã—ã¦è¿”ã™
     */
    function findMatchById(matchId) {
    // é€šå¸¸ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚’æ¤œç´¢
    if (tournamentState.matches && tournamentState.matches[matchId]) {
        return tournamentState.matches[matchId];
    }

    // ç§‹å­£å¤§ä¼šã®åœ°åŒºäºˆé¸ãƒ»é †ä½æ±ºå®šæˆ¦ã‚’æ¤œç´¢
    if (tournamentState.autumnData) {
        for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨', 'ä¼Šè±†']) { // ä¼Šè±†ã‚’è¿½åŠ 
            const regionData = tournamentState.autumnData.regions[region];
            if (!regionData) continue;
            // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ãŒä¿®æ­£ç®‡æ‰€ â–¼â–¼â–¼
            if (regionData.blocks) { // æ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨
                for (const block of regionData.blocks) {
                    if (block.matches[matchId]) return block.matches[matchId];
                }
            }
            if (regionData.izuBracket && regionData.izuBracket.matches[matchId]) { // ä¼Šè±†
                return regionData.izuBracket.matches[matchId];
            }
            // â–²â–²â–²
            if (regionData.champBracket && regionData.champBracket.matches[matchId]) {
                return regionData.champBracket.matches[matchId];
            }
            if (regionData.repechageBracket && regionData.repechageBracket.matches[matchId]) {
                return regionData.repechageBracket.matches[matchId];
            }
        }
    }
        
        // æ˜¥å­£å¤§ä¼šã®åœ°åŒºäºˆé¸ã‚’æ¤œç´¢
         if (tournamentState.springData) {
        for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨', 'ä¼Šè±†']) {
            const regionData = tournamentState.springData.regions[region];
            if (!regionData) continue;

            // ãƒ–ãƒ­ãƒƒã‚¯ä»£è¡¨æ±ºå®šæˆ¦ã‚’æ¤œç´¢
            if (regionData.blocks) {
                for (const block of regionData.blocks) {
                    if (block.matches[matchId]) return block.matches[matchId];
                }
            }
            // ç¬¬5ä»£è¡¨æ±ºå®šæˆ¦ï¼ˆæ•—è€…å¾©æ´»ï¼‰ã‚’æ¤œç´¢
            if (regionData.repechageBracket && regionData.repechageBracket.matches[matchId]) {
                return regionData.repechageBracket.matches[matchId];
            }
            // ä¼Šè±†åœ°åŒºäºˆé¸ã‚’æ¤œç´¢
            if (regionData.izuBracket && regionData.izuBracket.matches[matchId]) {
                return regionData.izuBracket.matches[matchId];
            }
        }
    }
    // â–²â–²â–² ã“ã“ã¾ã§ä¿®æ­£ â–²â–²â–²
        return null; // ã©ã“ã«ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆ
    }

/**
 * ãƒãƒ¼ãƒ ã®ä»Šå¤§ä¼šã®å‹ã¡ä¸ŠãŒã‚Šã‚’ã€Œã€‡ã€‡å›æˆ¦ vs â–³â–³ã€ã®ã‚ˆã†ã«è¦ç´„ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 */
function getTournamentPathSummary(teamName, currentMatchId) {
    const teamRecord = tournamentState.teamRecords[teamName];
    if (!teamRecord) return "ä»Šå¤§ä¼šåˆæˆ¦ã€‚";

    const path = [];
    const currentTournamentMatchIds = Object.keys(tournamentState.matches);

    for (const matchId of currentTournamentMatchIds) {
        if (matchId === currentMatchId) continue;
        const match = tournamentState.matches[matchId];
        
        if (match.winner && (match.team1 === teamName || match.team2 === teamName)) {
            const opponent = match.team1 === teamName ? match.team2 : teamName;
            const roundName = getRoundNameFromMatchId(matchId);
            
            if (match.winner === teamName) {
                path.push(`${roundName} vs ${opponent}`);
            }
        }
    }
    
    return path.length === 0 ? "ä»Šå¤§ä¼šåˆæˆ¦ã€‚" : `ã“ã“ã¾ã§ã®å‹ã¡ä¸ŠãŒã‚Š: ${path.join(' â†’ ')}ã€‚`;
}

/**
 * è©¦åˆIDã‹ã‚‰ãƒ©ã‚¦ãƒ³ãƒ‰åã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 */
function getRoundNameFromMatchId(matchId) {
    if (!matchId || !matchId.includes('-R')) return "ä¸æ˜ãªãƒ©ã‚¦ãƒ³ãƒ‰";
    
    const roundNum = parseInt(matchId.split('-')[1].slice(1));
    const finalRound = tournamentState.is16team ? 4 : 6;
    const roundNameMap = { [finalRound]: 'æ±ºå‹', [finalRound-1]: 'æº–æ±ºå‹', [finalRound-2]: 'æº–ã€…æ±ºå‹' };

    if (tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'main_round2_onwards'){
         const springRoundMap = { 1: '2å›æˆ¦', 2: 'æº–ã€…æ±ºå‹', 3: 'æº–æ±ºå‹', 4: 'æ±ºå‹'};
         return springRoundMap[roundNum] || `${roundNum}å›æˆ¦`;
    }
    else if (tournamentState.currentTournament === 'autumn' && tournamentState.autumnPhase !== 'main') return "åœ°åŒºäºˆé¸/é †ä½æ±ºå®šæˆ¦";
    else if (tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'main_round1') return "çœŒå¤§ä¼š1å›æˆ¦";
    else return roundNameMap[roundNum] || `${roundNum}å›æˆ¦`;
}


// --- Team Rank Calculation (Reality-Adjusted Version) ---
    
/**
 * 2ãƒãƒ¼ãƒ é–“ã®å› ç¸å¯¾æ±ºã‚’åˆ¤å®šã—ã€ãƒ•ãƒ©ã‚°ã‚’è¿”ã™ï¼ˆã‚¿ã‚°æ©Ÿèƒ½ä¸è¦ç‰ˆï¼‰
 * @param {string} team1Name - ãƒãƒ¼ãƒ 1ã®åå‰
 * @param {string} team2Name - ãƒãƒ¼ãƒ 2ã®åå‰
 * @returns {string | null} - å› ç¸ã®ã‚¿ã‚¤ãƒ—ï¼ˆä¾‹: "283ç›´æ¥å¯¾æ±º"ï¼‰ã€ãªã‘ã‚Œã° null
 */
function checkRivalry(team1Name, team2Name) {
    if (!team1Name || !team2Name) return null;

    const data1 = TEAM_DATA[team1Name];
    const data2 = TEAM_DATA[team2Name];
    if (!data1 || !data2) return null;

    // 1. 283å­¦åœ’ vs 283å­¦åœ’B
    if ((team1Name === "283å­¦åœ’" && team2Name === "283å­¦åœ’B") || (team1Name === "283å­¦åœ’B" && team2Name === "283å­¦åœ’")) {
        return "283ç›´æ¥å¯¾æ±º";
    }

    // â–¼â–¼â–¼ ä¿®æ­£ç‚¹ â–¼â–¼â–¼
    // 2. ãƒŠãƒ ã‚³ç³»åˆ—ãƒ€ãƒ¼ãƒ“ãƒ¼ (ã‚¿ã‚°ã®ä»£ã‚ã‚Šã«ã€ã“ã“ã§ãƒªã‚¹ãƒˆã‚’ç›´æ¥å®šç¾©)
    const namcoSchools = ["765ç·åˆé«˜æ ¡", "283å­¦åœ’", "åˆæ˜Ÿå­¦åœ’", "ç¾åŸå­¦åœ’", "283å­¦åœ’B"];
    if (namcoSchools.includes(team1Name) && namcoSchools.includes(team2Name)) {
        return "ãƒŠãƒ ã‚³ãƒ€ãƒ¼ãƒ“ãƒ¼";
    }
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    // 3. åŒåœ°åŒºã®å¼·è±ªå¯¾æ±º (Aãƒ©ãƒ³ã‚¯ vs Aãƒ©ãƒ³ã‚¯ or Aãƒ©ãƒ³ã‚¯ vs Bãƒ©ãƒ³ã‚¯)
    if (data1.region === data2.region) {
        const rank1 = calculateRank(team1Name, tournamentState);
        const rank2 = calculateRank(team2Name, tournamentState);
        if ((rank1 === 'A' && rank2 === 'A') || (rank1 === 'A' && rank2 === 'B') || (rank1 === 'B' && rank2 === 'A')) {
            return `åŒåœ°åŒºå¼·è±ªå¯¾æ±º (${data1.region})`;
        }
    }

    return null; // ãã®ä»–ã®å› ç¸ã¯ãªã—
}

/**
 * æŒ‡å®šã•ã‚ŒãŸãƒ©ã‚¦ãƒ³ãƒ‰ã®å…¨è©¦åˆã«æ—¥ä»˜ã¨çƒå ´ã‚’å‰²ã‚Šå½“ã¦ã‚‹
 * @param {Array<string>} matchIds - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹è©¦åˆIDã®é…åˆ—
 * @param {Array<string>} dates - ä½¿ç”¨ã™ã‚‹æ—¥ä»˜ã®é…åˆ— (ä¾‹: ["7/10", "7/11"])
 * @param {Array<object>} stadiumList - ä½¿ç”¨ã™ã‚‹çƒå ´ã®ãƒªã‚¹ãƒˆ (ä¾‹: STADIUM_DATA)
 * @param {number} gamesPerDayPerStadium - 1çƒå ´ãƒ»1æ—¥ã‚ãŸã‚Šã®æœ€å¤§è©¦åˆæ•°
 */
function scheduleRoundMatches(matchIds, dates, stadiumList, gamesPerDayPerStadium) {
    if (!matchIds || matchIds.length === 0) return;

    let scheduleQueue = []; // [ { stadium, date, gameNum: 1 }, { stadium, date, gameNum: 2 }, ... ]
    
    // å…¨ã¦ã®æ—¥ä»˜ã¨çƒå ´ã§ã€é–‹å‚¬å¯èƒ½ãªå…¨ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½œæˆ
    for (const date of dates) {
        for (const stadium of stadiumList) {
            for (let i = 1; i <= gamesPerDayPerStadium; i++) {
                scheduleQueue.push({
                    date: date,
                    stadium: stadium.abbr, // ç•¥ç§°ã‚’ä¿å­˜
                    stadiumFull: stadium.name,
                    gameNum: i // è©¦åˆé † (â‘ , â‘¡, ...)
                });
            }
        }
    }

    // è©¦åˆIDã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦
    matchIds.forEach((matchId, index) => {
        const match = findMatchById(matchId);
        if (match && scheduleQueue[index]) { // ã‚¹ãƒ­ãƒƒãƒˆãŒè¶³ã‚Šã‚‹é™ã‚Šå‰²ã‚Šå½“ã¦
            const schedule = scheduleQueue[index];
            match.schedule = {
                date: schedule.date,
                stadium: schedule.stadium,
                stadiumFull: schedule.stadiumFull,
                game: schedule.gameNum
            };
        } else if (match) {
            // ã‚¹ãƒ­ãƒƒãƒˆãŒè¶³ã‚Šãªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            match.schedule = { date: dates[0], stadium: stadiumList[0].abbr, game: 1 };
        }
    });
}

/**
     * ãƒãƒ¼ãƒ ãƒ©ãƒ³ã‚¯ã‚’è¨ˆç®—ã™ã‚‹ï¼ˆç¾å®Ÿã®å‹¢åŠ›å›³ã«åˆã‚ã›ã¦èª¿æ•´ç‰ˆï¼‰
     */
    function calculateRank(teamName, state) {
        if (!teamName) return '';

        const teamData = TEAM_DATA[teamName];
        if (!teamData) {
            console.error(`TEAM_DATAã«ãƒãƒ¼ãƒ ã€Œ${teamName}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
            return 'E';
        }

        let score = 0;
        
        // 1. åå·®å€¤ã®å½±éŸ¿ã‚’åŠåˆ†ã« (é‡ã™ããŸãŸã‚)
        score += teamData.deviation * 0.5;

        // 2. éå»ã®æœ€é«˜æˆç¸¾ãƒœãƒ¼ãƒŠã‚¹ (å¤‰æ›´ãªã—)
        if (teamData.best.includes('å„ªå‹')) score += 25;
        else if (teamData.best.includes('æº–å„ªå‹')) score += 20;
        else if (teamData.best.includes('ãƒ™ã‚¹ãƒˆ4')) score += 15;
        else if (teamData.best.includes('å‡ºå ´')) score += 10; // ç”²å­åœ’å‡ºå ´
        else if (teamData.best.includes('ãƒ™ã‚¹ãƒˆ8')) score += 10;
        else if (teamData.best.includes('ãƒ™ã‚¹ãƒˆ16')) score += 5;

        // 3. ç›´è¿‘ã®æˆç¸¾ãƒœãƒ¼ãƒŠã‚¹ (å€ç‡ã‚’ 3.0 â†’ 1.0 ã«å¤§å¹…ãƒ€ã‚¦ãƒ³)
        const rankMultiplier = 1.0; // â˜…å€ç‡ã‚’ 1.0 ã«å¤‰æ›´
        if (state.teamRecords && state.teamRecords[teamName]) {
            const lastFinish = state.teamRecords[teamName].lastFinish;
            
            // â˜…ç”²å­åœ’æˆç¸¾ã®ãƒœãƒ¼ãƒŠã‚¹ã‚’è¿½åŠ 
            if (lastFinish <= -1) score += 35 * rankMultiplier; // å…¨å›½å„ªå‹
            else if (lastFinish <= -2) score += 30 * rankMultiplier; // å…¨å›½æº–å„ªå‹
            else if (lastFinish <= -8) score += 25 * rankMultiplier; // ç”²å­åœ’ãƒ™ã‚¹ãƒˆ8ä»¥ä¸Š
            // â–¼çœŒå¤§ä¼šã®æˆç¸¾
            else if (lastFinish === 1) score += 30 * rankMultiplier; // çœŒå„ªå‹
            else if (lastFinish === 2) score += 25 * rankMultiplier;
            else if (lastFinish <= 4) score += 20 * rankMultiplier;
            else if (lastFinish <= 8) score += 15 * rankMultiplier;
            else if (lastFinish <= 16) score += 5 * rankMultiplier;
            else if (lastFinish >= 64) score -= 5 * rankMultiplier;
        }

        // 4. äººæ°—ãƒœãƒ¼ãƒŠã‚¹ (å¤‰æ›´ãªã—)
        if (teamData.popularity) score += 5;

        // 5. ãƒ©ãƒ³ã‚¯ã®å¢ƒç•Œç·šï¼ˆãƒœãƒ¼ãƒ€ãƒ¼ãƒ©ã‚¤ãƒ³ï¼‰ã‚’èª¿æ•´
        if (score >= 60) return 'A'; // Aãƒ©ãƒ³ã‚¯ (æ—§ 85+)
        if (score >= 50) return 'B'; // Bãƒ©ãƒ³ã‚¯ (æ—§ 70+)
        if (score >= 40) return 'C'; // Cãƒ©ãƒ³ã‚¯ (æ—§ 55+)
        if (score >= 30) return 'D'; // Dãƒ©ãƒ³ã‚¯ (æ—§ 40+)
        return 'E'; // Eãƒ©ãƒ³ã‚¯ (æ—§ < 40)
    }



// â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ ã—ã¦ãã ã•ã„ â–¼â–¼â–¼
/**
 * æŒ‡å®šã•ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†ç”Ÿã™ã‚‹ï¼ˆãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ç¤ºç‰ˆï¼‰
 */
/**
 * æŒ‡å®šã•ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†ç”Ÿã™ã‚‹ï¼ˆãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ç¤ºç‰ˆï¼‰
 */
async function playBlockAnimation(blockId) {
    // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡¨ç¤ºã‚’æ›´æ–°
    document.querySelectorAll('.analysis-block-tab-btn').forEach(btn => {
        const isActive = btn.dataset.block === blockId;
        btn.classList.toggle('bg-cyan-500', isActive);
        btn.classList.toggle('text-white', isActive);
        btn.classList.toggle('bg-gray-700', !isActive);
        btn.classList.toggle('text-gray-400', !isActive);
    });

    const stage = document.getElementById('analysis-stage');
    const narrationTextEl = document.getElementById('analysis-narration-text');
    const analysisData = tournamentState.blockAnalysisData;

    if (!analysisData || !analysisData[blockId]) {
        stage.innerHTML = `<p class="text-center text-gray-500">åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
        narrationTextEl.textContent = '';
        return;
    }
    const narration = analysisData[blockId];
    
    // ... (ä»¥é™ã®ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ã‚ã‚Šã¾ã›ã‚“) ...
    const blockTeams = tournamentState.teams.slice(
        (blockId.charCodeAt(0) - 65) * 16, 
        (blockId.charCodeAt(0) - 64) * 16
    );

    stage.innerHTML = '';
    narrationTextEl.textContent = '';
    
    stage.innerHTML = `
        <div id="r1-col" class="round-column"></div>
        <div id="r2-col" class="round-column"></div>
        <div id="r3-col" class="round-column"></div>
        <div id="r4-col" class="round-column"></div>
    `;

    for(let i = 0; i < 8; i++) {
        const matchupEl = document.createElement('div');
        matchupEl.className = 'analysis-matchup';
        matchupEl.innerHTML = `
            <div class="analysis-team" data-team-name="${blockTeams[i*2]}">${blockTeams[i*2]}</div>
            <div class="analysis-team" data-team-name="${blockTeams[i*2+1]}">${blockTeams[i*2+1]}</div>
            <div class="matchup-connector"></div>
        `;
        stage.querySelector('#r1-col').appendChild(matchupEl);
    }
    
    for(let i = 0; i < 4; i++) { stage.querySelector('#r2-col').innerHTML += '<div class="analysis-matchup"><div class="analysis-team">???</div><div class="analysis-team">???</div><div class="matchup-connector"></div><div class="round-connector"></div></div>'; }
    for(let i = 0; i < 2; i++) { stage.querySelector('#r3-col').innerHTML += '<div class="analysis-matchup"><div class="analysis-team">???</div><div class="analysis-team">???</div><div class="matchup-connector"></div><div class="round-connector"></div></div>'; }
    stage.querySelector('#r4-col').innerHTML += '<div class="analysis-matchup"><div class="analysis-team">???</div></div>';

    await new Promise(r => setTimeout(r, 100));
    document.querySelectorAll('.analysis-team').forEach((el, i) => {
        setTimeout(() => el.classList.add('show'), i * 50);
    });

    for (let i = 0; i < narration.length; i++) {
        narrationTextEl.textContent += narration[i];
        await new Promise(r => setTimeout(r, 50));
    }
    
    blockTeams.forEach(team => {
        if (narration.includes(team)) {
            document.querySelectorAll(`.analysis-team[data-team-name="${team}"]`).forEach(el => {
                el.classList.add('highlight');
            });
        }
    });
}
// â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ ã—ã¦ãã ã•ã„ â–¼â–¼â–¼
/**
 * AIã«å„ãƒ–ãƒ­ãƒƒã‚¯ã®å‹¢åŠ›å›³ã‚’åˆ†æã•ã›ã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŸç¨¿ã‚’ç”Ÿæˆã•ã›ã‚‹ï¼ˆãƒ‡ãƒ¼ã‚¿åˆ†æå¼·åŒ–ç‰ˆï¼‰
 * @param {object} state - tournamentState
 * @returns {Promise<object|null>}
 */
/**
 * AIã«å„ãƒ–ãƒ­ãƒƒã‚¯ã®å‹¢åŠ›å›³ã‚’åˆ†æã•ã›ã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŸç¨¿ã‚’ç”Ÿæˆã•ã›ã‚‹ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ç‰ˆãƒ»APIã‚¨ãƒ©ãƒ¼å¯¾ç­–æ¸ˆã¿ï¼‰
 * @param {object} state - tournamentState
 * @returns {Promise<object|null>}
 */
async function generateBlockAnalysisArticle(state) {
    const { teams, seeds } = state;
    const blocks = { A: [], B: [], C: [], D: [] };
    teams.forEach((team, i) => {
        if (i < 16) blocks.A.push(team);
        else if (i < 32) blocks.B.push(team);
        else if (i < 48) blocks.C.push(team);
        else blocks.D.push(team);
    });

    const blockAnalysisData = {};
    for (const blockId in blocks) {
        const blockTeams = blocks[blockId];
        // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
        const teamDetails = blockTeams.map(teamName => {
            const rank = calculateRank(teamName, state);
            const isSeed = seeds.includes(teamName);
            const teamData = TEAM_DATA[teamName];
            const tags = teamData?.tags || [];

            // ç‰©èªæ€§ã®ã‚ã‚‹ã‚¿ã‚°ã‚’æŒã£ã¦ã„ã‚‹ã‹
            const hasStoryTag = tags.includes('é€†å¢ƒ') || tags.includes('ãƒ¯ãƒ³ãƒãƒ³ãƒãƒ¼ãƒ ') || tags.includes('æœ€å¾Œã®å¤') || tags.includes('å¤è±ª');
            
            // A/Bãƒ©ãƒ³ã‚¯ã€ã‚·ãƒ¼ãƒ‰æ ¡ã€ã¾ãŸã¯ã€Œç‰©èªã‚¿ã‚°ã€ã‚’æŒã¤ãƒãƒ¼ãƒ ã¯ã€è©³ç´°æƒ…å ±ã‚’æ¸¡ã™
            if (isSeed || ['A', 'B'].includes(rank) || hasStoryTag) {
                const info = teamData?.info || '';
                // ã‚¿ã‚°ã¨ã€çŸ­ç¸®ã—ãŸèƒŒæ™¯æƒ…å ±ã‚’æ¸¡ã™
                return `${teamName}(${rank}${isSeed ? 'S' : ''}) [ã‚¿ã‚°: ${tags.join(',')}, èƒŒæ™¯: ${info.substring(0, 40)}...]`;
            } 
            // Cãƒ©ãƒ³ã‚¯ã¯ã‚¿ã‚°ã®ã¿æ¸¡ã™
            else if (['C'].includes(rank)) {
                 return `${teamName}(${rank}) [ã‚¿ã‚°: ${tags.join(',')}]`;
            } 
            // D/Eãƒ©ãƒ³ã‚¯ã¯ãƒ©ãƒ³ã‚¯ã®ã¿
            else {
                return `${teamName}(${rank})`;
            }
        }).join(', ');
        // â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²        blockAnalysisData[blockId] = teamDetails;
    }

    const prompt = `ã‚ãªãŸã¯é«˜æ ¡é‡çƒã®è§£èª¬è€…ã§ã™ã€‚ä»¥ä¸‹ã®å„ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’åˆ†æã—ã€ãã‚Œãã‚Œã®è¦‹ã©ã“ã‚ã‚’**150å­—ç¨‹åº¦**ã®ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŸç¨¿ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚

### åˆ†æå¯¾è±¡ãƒ–ãƒ­ãƒƒã‚¯ (ãƒãƒ¼ãƒ åã¨ãƒ©ãƒ³ã‚¯ã€Sã¯ã‚·ãƒ¼ãƒ‰æ ¡ã€[]å†…ã¯æ³¨ç›®æ ¡ã®èƒŒæ™¯æƒ…å ±)
- **Aãƒ–ãƒ­ãƒƒã‚¯:** ${blockAnalysisData.A}
- **Bãƒ–ãƒ­ãƒƒã‚¯:** ${blockAnalysisData.B}
- **Cãƒ–ãƒ­ãƒƒã‚¯:** ${blockAnalysisData.C}
- **Dãƒ–ãƒ­ãƒƒã‚¯:** ${blockAnalysisData.D}

### æŒ‡ç¤º
- **ç‰©èªã‚’é‡è¦–:** [èƒŒæ™¯]æƒ…å ±ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹æ³¨ç›®æ ¡ã‚’ä¸­å¿ƒã«ã€ãã®ãƒãƒ¼ãƒ ãŒæŒã¤ç‰©èªã‚„èƒŒæ™¯ï¼ˆä¾‹ï¼šå¤è±ªã®å¾©æ´»ã€ç‹è€…ã®è‹¦æ‚©ï¼‰ã«è§¦ã‚ŒãªãŒã‚‰è§£èª¬ã—ã¦ãã ã•ã„ã€‚
- **ç°¡æ½”ã«:** å…¨ä½“ã®ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯150å­—ç¨‹åº¦ã«åã‚ã¦ãã ã•ã„ã€‚
- æœ€ã‚‚æ¿€æˆ¦åŒºã ã¨æ€ã‚ã‚Œã‚‹ã€Œæ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã€ã‚’ç‰¹å®šã—ã¦ãã ã•ã„ã€‚
- 4ãƒ–ãƒ­ãƒƒã‚¯åˆ†ã€å¿…ãšå…¨ã¦ã®ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼ (JSON)
{
  "A": "ï¼ˆAãƒ–ãƒ­ãƒƒã‚¯ã®ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰",
  "B": "ï¼ˆBãƒ–ãƒ­ãƒƒã‚¯ã®ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰",
  "C": "ï¼ˆCãƒ–ãƒ­ãƒƒã‚¯ã®ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰",
  "D": "ï¼ˆDãƒ–ãƒ­ãƒƒã‚¯ã®ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰"
}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        return parseJsonFromText(result.candidates[0].content.parts[0].text);
    } catch (error) {
        console.error("AIãƒ–ãƒ­ãƒƒã‚¯åˆ†æè¨˜äº‹ã®ç”Ÿæˆã«å¤±æ•—:", error);
        return null;
    }
}
   
/**
 * æ–°ã—ã„ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’é–‹å§‹ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
 * (â˜…ç¬¬3(é™å²¡), ç¬¬4(æ›å·è¥¿)ã‚·ãƒ¼ãƒ‰ã‚’å›ºå®šã—ã€å±±åˆ†ã‘é…ç½®ã™ã‚‹æœ€çµ‚ç‰ˆ)
 */
async function createNewTournament(isNext = false, nextTournamentType = 'summer', predeterminedTeams = null) {
    setupEl.classList.add('hidden');
    tournamentDisplayEl.classList.remove('hidden');

    // --- å¤§ä¼šé–‹å§‹æ™‚ã«ã€å…¨ãƒãƒ¼ãƒ ã®ã€Œä»Šå¤§ä¼šã®ã€é€šç®—æˆç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆ ---
    if (tournamentState.teamRecords) {
        for (const teamName in tournamentState.teamRecords) {
            const record = tournamentState.teamRecords[teamName];
            record.tournamentStats = { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0 };
        }
    }
    
    // å¤§ä¼šç§»è¡Œæ™‚ã«ã€å‰ã®å¤§ä¼šã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’ç¢ºå®Ÿã«éè¡¨ç¤ºã«ã™ã‚‹
    autumnControls.classList.add('hidden');
    startMainTournamentBtn.classList.add('hidden');
    startRankingPlayoffsBtn.classList.add('hidden');

    // --- ä¸–ä»£äº¤ä»£å‡¦ç† ---
    if (isNext && tournamentState.teamRecords) {
        for (const teamName in tournamentState.teamRecords) {
            if (tournamentState.teamRecords.hasOwnProperty(teamName)) {
                const record = tournamentState.teamRecords[teamName];
                record.previousRank = record.lastFinish;
                record.wins = 0;
                record.losses = 0;
            }
        }
    }

    // --- ç§‹å­£å¤§ä¼šã®é–‹å§‹ ---
    if (nextTournamentType === 'autumn') {
        // ... (ç§‹å­£å¤§ä¼šã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ...
        tournamentState.currentTournament = 'autumn';
        tournamentState.autumnPhase = 'regional_blocks';
        if (!isNext) {
            tournamentState.tournamentYear = 2025;
            tournamentState.settings = { enableArticleGeneration: true, enableBbsGeneration: true };
        }
        tournamentState.autumnData = {
            regions: {
                'æ±éƒ¨': { blocks: [], blockWinners: [], blockRunnersUp: [], ranking: [], finalReps: [] },
                'ä¸­éƒ¨': { blocks: [], blockWinners: [], blockRunnersUp: [], ranking: [], finalReps: [] },
                'è¥¿éƒ¨': { blocks: [], blockWinners: [], blockRunnersUp: [], ranking: [], finalReps: [] },
                'ä¼Šè±†': { izuBracket: null, finalReps: [] }
            }
        };
        Object.assign(tournamentState, {
            teams: [], matches: {}, news: [], seeds: [], bbsComments: [], daiyaBbsComments: [],
            tickerHeadlines: [], namcoNews: null, is16team: false, documentary: { target: null, type: null }
        });
        await setupAutumnRegionalBlocks();
        return;
    }
    // --- æ˜¥å­£å¤§ä¼šã®é–‹å§‹ ---
    else if (nextTournamentType === 'spring') {
        // ... (æ˜¥å­£å¤§ä¼šã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ...
        tournamentState.currentTournament = 'spring';
        tournamentState.autumnPhase = null;
        
        const allRankedTeams = Object.keys(tournamentState.teamRecords)
            .map(name => ({ name, rank: tournamentState.teamRecords[name].lastFinish }))
            .sort((a, b) => a.rank - b.rank);

        const seedTeams = allRankedTeams.slice(0, 8).map((t, i) => ({ team: t.name, rank: i + 1 }));
        const qualifierTeams = allRankedTeams.slice(8).map(t => t.name);

        tournamentState.springPhase = 'regional_qualifiers';
        tournamentState.springData = {
            seedTeams, 
            qualifierTeams,
            regions: {
                'æ±éƒ¨': { blocks: [], repechageBracket: null, finalReps: [] },
                'ä¸­éƒ¨': { blocks: [], repechageBracket: null, finalReps: [] },
                'è¥¿éƒ¨': { blocks: [], repechageBracket: null, finalReps: [] },
                'ä¼Šè±†': { izuBracket: null, finalReps: [] }
            },
            allMatches: {}
        };
        await setupSpringRegionalQualifiers();

         if (tournamentState.senbatsuTeams && tournamentState.senbatsuTeams.length > 0) {
            for (const teamName of tournamentState.senbatsuTeams) {
                const teamRank = calculateRank(teamName, tournamentState);
                const koshienResultKey = simulateKoshien(teamRank);
                const koshienResult = KOSHIEN_RESULTS[koshienResultKey];
                
                const teamRecord = tournamentState.teamRecords[teamName];
                if (teamRecord) {
                    teamRecord.lastFinish = koshienResult.rank; 
                    const newHistoryRecord = { 
                        year: tournamentState.tournamentYear, 
                        tournament: 'spring_koshien', 
                        rank: koshienResult.rank 
                    };
                    teamRecord.history.unshift(newHistoryRecord);
                    if (!teamRecord.best || newHistoryRecord.rank < teamRecord.best.rank) {
                        teamRecord.best = newHistoryRecord;
                    }
                }
                
                const article = await generateKoshienSummaryArticle(teamName, koshienResult.label, 'spring');
                if (article) {
                    tournamentState.news.push(article);
                }
            }
        }
        tournamentState.senbatsuTeams = [];
        return;
    }    
    
    // --- å¤å­£å¤§ä¼šã®é–‹å§‹ ---
    mainBracketWrapper.classList.remove('hidden');
    tournamentState.is16team = false;
    tournamentState.currentTournament = 'summer';

    if (isNext) { // æ˜¥ã‹ã‚‰å¤ã¸ã®ç§»è¡Œæ™‚
        tournamentState.tournamentYear++;
    }
    
    if (!isNext) { 
        tournamentState.tournamentYear = 2025;
        tournamentState.teamRecords = {};
        const historicalRanks = INITIAL_TEAM_POOL.map(teamName => ({ name: teamName, rank: getRankFromHistoryString(TEAM_DATA[teamName].last) }));
        // (historicalRanks ã¯ã“ã®å¾Œã™ã setInitialSeedRank ã§ä½¿ã‚ã‚Œã‚‹)
        
        tournamentState.settings = {
            enableArticleGeneration: true,
            enableBbsGeneration: true
        };

        INITIAL_TEAM_POOL.forEach(t => {
            const historicalRank = historicalRanks.find(hr => hr.name === t);
            tournamentState.teamRecords[t] = { 
                wins: 0, losses: 0, best: null, history: [],
                lastFinish: historicalRank ? historicalRank.rank : 64, 
                previousRank: null,
                teamTraits: [], 
                previousStarters: null,
                roster: null,
                tournamentStats: { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0 } 
            };
        });
    }
    
    let teams;
    let seeds = []; // {team, rank}

    // â–¼â–¼â–¼ ã‚·ãƒ¼ãƒ‰æ ¡ã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ (ãƒ©ãƒ³ã‚¯ã‚’ä»˜ä¸) â–¼â–¼â–¼
    if (isNext) { // æ˜¥ã‹ã‚‰å¤ã¸ã®ç§»è¡Œæ™‚
        const lastTournamentTeams = Object.keys(tournamentState.teamRecords)
            .map(teamName => ({ name: teamName, ...tournamentState.teamRecords[teamName] }))
            .sort((a, b) => a.lastFinish - b.lastFinish); 
        seeds = lastTournamentTeams.slice(0, 8).map((t, i) => ({ team: t.name, rank: i + 1 })); 
    } else { // åˆå›èµ·å‹•æ™‚
        // 1. TEAM_DATAã® `last` ã‹ã‚‰åŸºæœ¬ãƒ©ãƒ³ã‚¯ã‚’å–å¾—
        const historicalRanks = INITIAL_TEAM_POOL.map(teamName => ({ name: teamName, rank: getRankFromHistoryString(TEAM_DATA[teamName].last) }));
        
        // 2. é †ä½ä»˜ã‘ã®ãŸã‚ã®ã€Œã‚½ãƒ¼ãƒˆç”¨ãƒ©ãƒ³ã‚¯ã€ã‚’å‰²ã‚Šå½“ã¦ã‚‹
        const setInitialSeedRank = (teamName) => {
            // â˜…â˜…â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®ã‚·ãƒ¼ãƒ‰é †ä½ã‚’å›ºå®š â˜…â˜…â˜…
            if (teamName === '283å­¦åœ’') return 1;
            if (teamName === 'å¸¸è‘‰èŠå·') return 2;
            if (teamName === 'é™å²¡') return 3;
            if (teamName === 'æ›å·è¥¿') return 4;
            // â˜…â˜…â˜… ã“ã“ã¾ã§ â˜…â˜…â˜…
            
            // ãã®ä»–ã®ãƒãƒ¼ãƒ ã¯ `last` ã®å®Ÿç¸¾ãƒ©ãƒ³ã‚¯ã‚’å–å¾—
            const rank = historicalRanks.find(hr => hr.name === teamName)?.rank || 64;

            // ãã®ä»–ã®ã‚·ãƒ¼ãƒ‰å€™è£œ (é™å²¡å•†æ¥­, è–éš·, ä¸‰å³¶åŒ—, è—¤ææ˜èª ) ã¯ rank 8
            // ç«¶åˆã—ãªã„ã‚ˆã†ã«ã€ã“ã“ã§ã¯ 8 ã‚’è¿”ã™ (ã‚½ãƒ¼ãƒˆé †ãŒ 1, 2, 3, 4, 8, 8, 8, 8 ã¨ãªã‚‹)
            if (rank === 8) return 8; 
            
            return rank; // ãã‚Œä»¥å¤– (64ãªã©)
        };
        
        // 3. å…¨ãƒãƒ¼ãƒ ã«ã‚½ãƒ¼ãƒˆç”¨ãƒ©ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦
        const adjustedHistoricalRanks = INITIAL_TEAM_POOL.map(teamName => ({
            name: teamName,
            rank: setInitialSeedRank(teamName)
        }));
        
        // 4. ã‚½ãƒ¼ãƒˆç”¨ãƒ©ãƒ³ã‚¯ã§ä¸¦ã¹æ›¿ãˆ
        adjustedHistoricalRanks.sort((a, b) => a.rank - b.rank);
        
        // 5. ä¸Šä½8ãƒãƒ¼ãƒ ã« 1ä½ã€œ8ä½ ã®ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã‚’ä»˜ä¸
        seeds = adjustedHistoricalRanks.slice(0, 8).map((t, i) => ({ team: t.name, rank: i + 1 }));
    }
    // â–²â–²â–² ã‚·ãƒ¼ãƒ‰æ ¡æ±ºå®šã“ã“ã¾ã§ â–²â–²â–²

    // â–¼â–¼â–¼ ãƒãƒ¼ãƒ é…ç½®ãƒ­ã‚¸ãƒƒã‚¯ (æŠ½é¸ä¼šçµŒç”±/çµŒç”±ã›ãš) â–¼â–¼â–¼
    if (predeterminedTeams) {
        // æŠ½é¸ä¼šã§æ±ºå®šã•ã‚ŒãŸé…ç½® (predeterminedTeams) ã‚’ãã®ã¾ã¾ä½¿ç”¨
        teams = predeterminedTeams;
    } else {
        // æŠ½é¸ä¼šã‚’çµŒç”±ã—ãªã„å ´åˆï¼ˆï¼ãƒ‡ãƒãƒƒã‚°ã‚„ã‚¹ã‚­ãƒƒãƒ—æ™‚ï¼‰ã€ã“ã“ã§é…ç½®ã‚’æ±ºå®š
        const seedTeamsList = seeds.map(s => s.team);
        const nonSeeds = INITIAL_TEAM_POOL.filter(t => !seedTeamsList.includes(t));
        const shuffledNonSeeds = shuffleArray(nonSeeds);
        
        teams = Array(64).fill(null);
        const seedPlacements = {};
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ [Aãƒ–ãƒ­ãƒƒã‚¯é ­, Bãƒ–ãƒ­ãƒƒã‚¯é ­, Cãƒ–ãƒ­ãƒƒã‚¯é ­, Dãƒ–ãƒ­ãƒƒã‚¯é ­, (æ®‹ã‚Šã‚·ãƒ¼ãƒ‰æ )...]
        const seedPositionsTemplate = [0, 32, 16, 48, 8, 40, 24, 56];

        // ãƒ©ãƒ³ã‚¯1ã€œ4ã‚’å›ºå®šä½ç½®ã« (â˜…å±±åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯é©ç”¨)
        const rank1_4 = seeds.filter(s => s.rank <= 4).sort((a, b) => a.rank - b.rank);
        seedPlacements[seedPositionsTemplate[0]] = rank1_4.find(s => s.rank === 1).team; // Pos 0 (å·¦ä¸Š) -> ç¬¬1ã‚·ãƒ¼ãƒ‰ (283)
        seedPlacements[seedPositionsTemplate[1]] = rank1_4.find(s => s.rank === 2).team; // Pos 32 (å³ä¸Š) -> ç¬¬2ã‚·ãƒ¼ãƒ‰ (å¸¸è‘‰èŠå·)
        seedPlacements[seedPositionsTemplate[2]] = rank1_4.find(s => s.rank === 4).team; // Pos 16 (å·¦ä¸­) -> ç¬¬4ã‚·ãƒ¼ãƒ‰ (æ›å·è¥¿)
        seedPlacements[seedPositionsTemplate[3]] = rank1_4.find(s => s.rank === 3).team; // Pos 48 (å³ä¸­) -> ç¬¬3ã‚·ãƒ¼ãƒ‰ (é™å²¡)
        
        // ãƒ©ãƒ³ã‚¯5ã€œ8ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦æ®‹ã‚Šã®ä½ç½®ã«
        const rank5_8 = shuffleArray(seeds.filter(s => s.rank > 4));
        rank5_8.forEach((seed, i) => { 
            seedPlacements[seedPositionsTemplate[i + 4]] = seed.team; 
        });

        // é…åˆ—ã‚’æ§‹ç¯‰
        let nonSeedIndex = 0;
        for (let i = 0; i < 64; i++) {
            teams[i] = seedPlacements[i] ? seedPlacements[i] : shuffledNonSeeds[nonSeedIndex++];
        }
    }
    // â–²â–²â–² ãƒãƒ¼ãƒ é…ç½®ãƒ­ã‚¸ãƒƒã‚¯ã“ã“ã¾ã§ â–²â–²â–²
    
    // ... (ä»¥é™ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã€AIè¨˜äº‹ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ã‚ã‚Šã¾ã›ã‚“) ...
    
    tournamentState.teams = teams;
    tournamentState.matches = {};
    tournamentState.news = [];
    tournamentState.documentary = { target: null, type: null };
    tournamentState.activeScandal = null;
    tournamentState.seeds = seeds; 
    tournamentState.bbsComments = [];
    tournamentState.daiyaBbsComments = [];
    tournamentState.tickerHeadlines = []; 
    tournamentState.rivalries = RIVALRIES;
    tournamentState.feuds = tournamentState.feuds || []; 
    tournamentState.namcoNews = null;
    tournamentState.preGameComments = {};
    tournamentState.matomeThreads = {}; 

    const round1Setup = teams.reduce((acc, team, i) => {
        if (i % 2 === 0) acc.push({ team1: team, team2: null });
        else acc[acc.length - 1].team2 = team;
        return acc;
    }, []);

    round1Setup.forEach((match, index) => {
        const side = index < 16 ? 'L' : 'R';
        const matchNum = index < 16 ? index + 1 : index - 15;
        const matchId = `${side}-R1-M${matchNum}`;
        const rivalryType = checkRivalry(match.team1, match.team2);
        tournamentState.matches[matchId] = { 
            id: matchId, 
            team1: match.team1, 
            team2: match.team2, 
            winner: null, 
            score1: '', 
            score2: '', 
            details: null, 
            summary: '',
            rivalryType: rivalryType 
        };
    });

    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
    const datesR1 = ["7/10", "7/11", "7/12"];
    const gamesPerDayPerStadiumR1 = 2;
    const matchIdsR1 = Object.keys(tournamentState.matches).filter(id => id.includes('-R1-'));
    
    let fullScheduleQueueR1 = [];
    for (const date of datesR1) {
        for (const stadium of STADIUM_DATA) { 
            for (let i = 1; i <= gamesPerDayPerStadiumR1; i++) {
                fullScheduleQueueR1.push({
                    date: date,
                    stadium: stadium.abbr,
                    stadiumFull: stadium.name,
                    region: stadium.region, 
                    gameNum: i
                });
            }
        }
    }
    fullScheduleQueueR1 = shuffleArray(fullScheduleQueueR1);
    
    const seedMatchIds = [];
    const normalMatchIds = [];
    const seedTeamsList = tournamentState.seeds.map(s => s.team); 
    matchIdsR1.forEach(matchId => {
        const match = findMatchById(matchId);
        if (match && (seedTeamsList.includes(match.team1) || seedTeamsList.includes(match.team2))) { 
            seedMatchIds.push(matchId);
        } else {
            normalMatchIds.push(matchId);
        }
    });

    seedMatchIds.forEach(matchId => {
        const match = findMatchById(matchId);
        if (!match) return;
        let targetRegion = null;
        let preferredStadiumAbbr = null;
        if (match.team1 === "é™å²¡" || match.team2 === "é™å²¡") {
            preferredStadiumAbbr = STADIUM_DATA[0].abbr; // è‰è–™
            targetRegion = STADIUM_DATA[0].region; // ä¸­éƒ¨
        } else if (match.team1 === "æ›å·è¥¿" || match.team2 === "æ›å·è¥¿") {
            preferredStadiumAbbr = STADIUM_DATA[6].abbr; // æ›å·
            targetRegion = STADIUM_DATA[6].region; // è¥¿éƒ¨
        } else {
            const seedTeamName = seedTeamsList.includes(match.team1) ? match.team1 : match.team2;
            const seedTeamData = TEAM_DATA[seedTeamName];
            if (seedTeamData) {
                targetRegion = seedTeamData.region;
                if (targetRegion === 'ä¼Šè±†') targetRegion = 'æ±éƒ¨'; 
            }
        }
        let schedule;
        let foundSlotIndex = -1;
        if (preferredStadiumAbbr) {
            foundSlotIndex = fullScheduleQueueR1.findIndex(s => s.stadium === preferredStadiumAbbr);
        }
        if (foundSlotIndex === -1 && targetRegion) {
            foundSlotIndex = fullScheduleQueueR1.findIndex(s => s.region === targetRegion);
        }
        if (foundSlotIndex === -1 && (preferredStadiumAbbr === STADIUM_DATA[0].abbr || preferredStadiumAbbr === STADIUM_DATA[6].abbr)) {
             let fallbackSlotIndex = fullScheduleQueueR1.findIndex(s => s.region === 'æ±éƒ¨');
             if (fallbackSlotIndex !== -1) {
                 schedule = fullScheduleQueueR1.splice(fallbackSlotIndex, 1)[0];
             } else {
                 schedule = fullScheduleQueueR1.shift();
             }
        } else if (foundSlotIndex !== -1) {
             schedule = fullScheduleQueueR1.splice(foundSlotIndex, 1)[0];
        } else {
             schedule = fullScheduleQueueR1.shift();
        }
        if (schedule) {
             match.schedule = {
                date: schedule.date,
                stadium: schedule.stadium,
                stadiumFull: schedule.stadiumFull,
                game: schedule.gameNum
            };
        }
    });
    normalMatchIds.forEach(matchId => {
        const match = findMatchById(matchId);
        if (!match) return;
        const data1 = TEAM_DATA[match.team1];
        const data2 = TEAM_DATA[match.team2];
        let targetRegion = 'ä¸­éƒ¨'; 
        if (data1 && data2) {
            const region1 = data1.region;
            const region2 = data2.region;
            if (region1 === region2) targetRegion = region1;
            else if ((region1 === 'æ±éƒ¨' && region2 === 'è¥¿éƒ¨') || (region1 === 'è¥¿éƒ¨' && region2 === 'æ±éƒ¨')) targetRegion = 'ä¸­éƒ¨';
            else if ((region1 === 'æ±éƒ¨' && region2 === 'ä¸­éƒ¨') || (region1 === 'ä¸­éƒ¨' && region2 === 'æ±éƒ¨')) targetRegion = 'ä¸­éƒ¨';
            else if ((region1 === 'è¥¿éƒ¨' && region2 === 'ä¸­éƒ¨') || (region1 === 'ä¸­éƒ¨' && region2 === 'è¥¿éƒ¨')) targetRegion = 'è¥¿éƒ¨';
            else if (region1 === 'ä¼Šè±†' || region2 === 'ä¼Šè±†') targetRegion = 'æ±éƒ¨';
            if (targetRegion === 'ä¼Šè±†') targetRegion = 'æ±éƒ¨';
        }
        let foundSlotIndex = fullScheduleQueueR1.findIndex(s => s.region === targetRegion);
        let schedule;
        if (foundSlotIndex === -1) {
            schedule = fullScheduleQueueR1.shift();
        } else {
            schedule = fullScheduleQueueR1.splice(foundSlotIndex, 1)[0];
        }
        if (schedule) {
             match.schedule = {
                date: schedule.date,
                stadium: schedule.stadium,
                stadiumFull: schedule.stadiumFull,
                game: schedule.gameNum
            };
        }
    });
    scheduleRoundMatches(Object.keys(tournamentState.matches).filter(id => id.includes('-R2-')), ["7/14", "7/15"], STADIUM_DATA, 2 );
    scheduleRoundMatches(Object.keys(tournamentState.matches).filter(id => id.includes('-R3-')), ["7/17", "7/18"], ROUND_3_STADIUMS, 2);
    scheduleRoundMatches(Object.keys(tournamentState.matches).filter(id => id.includes('-R4-')), ["7/20"], FINAL_STAGE_STADIUMS, 4);
    scheduleRoundMatches(Object.keys(tournamentState.matches).filter(id => id.includes('-R5-')), ["7/23"], FINAL_STAGE_STADIUMS, 2);
    scheduleRoundMatches(Object.keys(tournamentState.matches).filter(id => id.includes('F-R1-')), ["7/25"], FINAL_STAGE_STADIUMS, 1 );
    
    // AIå› ç¸ç”Ÿæˆ
    renderTournament(tournamentState); 
    (async () => {
        const newFeuds = await generateDynamicFeuds(tournamentState);
        if (newFeuds && newFeuds.length > 0) {
            tournamentState.feuds.push(...newFeuds);
            saveState(); 
            renderTournament(tournamentState); 
            const feudTitles = newFeuds.map(f => `ã€Œ${f.teams[0]} vs ${f.teams[1]} (${f.type})ã€`).join('ã€');
            tournamentState.news.push({
                title: "ã€é€Ÿå ±ã€‘ä»Šå¤§ä¼šã®ã€Œå› ç¸ã®å¯¾æ±ºã€ãŒæ±ºå®šï¼",
                body: `å¤§ä¼šæœ¬éƒ¨ã¯ã€AIè§£èª¬è€…ã®åˆ†æã«åŸºã¥ãã€ä»Šå¤§ä¼šã®æ³¨ç›®ã™ã¹ãã€Œå› ç¸ã®å¯¾æ±ºã€ã‚’ç™ºè¡¨ã—ãŸã€‚\n${feudTitles}ãªã©ã€1å›æˆ¦ã‹ã‚‰ç›®ãŒé›¢ã›ãªã„æˆ¦ã„ãŒç¶šãã€‚`,
                timestamp: Date.now()
            });
            renderNews(tournamentState.news);
        }
    })();

    saveState(); 
    renderTournament(tournamentState); 

    const currentTournamentName = tournamentNameMap[tournamentState.currentTournament];
    newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒ${currentTournamentName}ã®çµ„ã¿åˆã‚ã›ã¨å±•æœ›ã‚’åˆ†æä¸­...</div>`;
    bbsCommentsContainer.innerHTML = `<div class="loader">AIãŒçµ„ã¿åˆã‚ã›ã‚’åˆ†æä¸­...</div>`;
    namcoNewsSection.classList.remove('hidden');
    namcoNewsContent.innerHTML = `<div class="loader">ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ã‚’ç¢ºèªä¸­...</div>`;

    let analysisArticlePromise = Promise.resolve(null);
    let bracketBbsPromise = Promise.resolve(null); 

    if (tournamentState.currentTournament === 'summer') {
        analysisArticlePromise = generateBracketAnalysisNewsArticle(tournamentState);
        bracketBbsPromise = generateBracketBbsThread(tournamentState); 
    } else { 
        const previewContext = { matchId: 'preview' };
        analysisArticlePromise = generateNewsArticle(previewContext);
        bracketBbsPromise = generateBracketReactionComments(tournamentState);
    }

    try {
        const topicArticles = await generateTopicSchoolArticles(tournamentState); 
        if (topicArticles && topicArticles.length > 0) {
            tournamentState.news.push(...topicArticles); 
        }
    } catch (e) {
        console.error("è©±é¡Œæ ¡ç´¹ä»‹è¨˜äº‹ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", e);
    }

    const [namcoNews, analysisArticle, bracketBbsResult] = await Promise.all([
        generateNamcoNews(tournamentState, 'bracket'),
        analysisArticlePromise,
        bracketBbsPromise
    ]);

    if (analysisArticle && !analysisArticle.error) {
         tournamentState.news.unshift(analysisArticle);
    } else if (analysisArticle && analysisArticle.error) {
        tournamentState.news.unshift(analysisArticle);
    }

    if (bracketBbsResult && !bracketBbsResult.error) {
        tournamentState.bbsComments.push(bracketBbsResult); 
    } else if (bracketBbsResult && bracketBbsResult.error) {
        tournamentState.bbsComments.push({
            title: bracketBbsResult.title || "çµ„ã¿åˆã‚ã›ã‚¹ãƒ¬ãƒƒãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼",
            body: bracketBbsResult.body || "AIã«ã‚ˆã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
            timestamp: Date.now(),
            error: true,
            errorId: bracketBbsResult.errorId || `bracket-thread-error-${Date.now()}`,
            context: { isBracketThread: true } 
        });
    }

    if (namcoNews) tournamentState.namcoNews = namcoNews;

    renderNews(tournamentState.news);
    renderBbsComments(tournamentState.bbsComments); 
    renderNamcoNews(tournamentState.namcoNews);
    saveState();
}

/**
 * AIã«çµ„ã¿åˆã‚ã›æŠ½é¸æ™‚ã«ã€Œè©±é¡Œæ ¡ç´¹ä»‹ã€ã®è¨˜äº‹ã‚’æ•°æœ¬ç”Ÿæˆã•ã›ã‚‹
 * (â˜…E, D, C, B, Aãƒ©ãƒ³ã‚¯ã‹ã‚‰å„1æ ¡ãšã¤ã€è¨ˆ5æ ¡ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—)
 * (â˜…â˜…AIç”Ÿæˆå¤±æ•—æ™‚ã«ã€Œã‚¨ãƒ©ãƒ¼è¨˜äº‹ã€ã¨ã—ã¦æç”»ã—ã€å†ç”Ÿæˆã‚’å¯èƒ½ã«ã™ã‚‹æœ€çµ‚ç‰ˆâ˜…â˜…)
 * @param {object} state - tournamentState
 * @returns {Promise<Array<object>>} - ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã¾ãŸã¯ã‚¨ãƒ©ãƒ¼è¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã®é…åˆ—
 */
async function generateTopicSchoolArticles(state) {
    const { teams, seeds } = state;
    if (!teams || teams.length === 0) return [];

    const articles = [];
    const getTeamRank = (teamName) => calculateRank(teamName, state);
    
    // ãƒãƒ¼ãƒ ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ« (åŒã˜ãƒ©ãƒ³ã‚¯ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶ãŸã‚)
    const shuffledTeams = shuffleArray(teams); 

    // ãƒ©ãƒ³ã‚¯åˆ¥ã«ãƒãƒ¼ãƒ ã‚’åˆ†é¡
    const teamsByRank = { 'A': [], 'B': [], 'C': [], 'D': [], 'E': [] };
    shuffledTeams.forEach(team => {
        const rank = getTeamRank(team);
        teamsByRank[rank].push(team);
    });

    // --- å„ãƒ©ãƒ³ã‚¯ã‹ã‚‰1æ ¡ãšã¤é¸ã‚“ã§è¨˜äº‹ã‚’ç”Ÿæˆ ---

    // 1. Eãƒ©ãƒ³ã‚¯æ ¡ã®è¨˜äº‹ (ãƒ†ãƒ¼ãƒ: æ‚²é¡˜ã®åˆæˆ¦çªç ´ã¸)
    const teamE = teamsByRank['E'][0];
    if (teamE) {
        const article = await createTopicArticle(teamE, getTeamRank(teamE), 'E');
        if (article) {
            articles.push(article);
        } else {
            // â–¼â–¼â–¼ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›: å¤±æ•—ã—ãŸå ´åˆã€ã‚¨ãƒ©ãƒ¼è¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ â–¼â–¼â–¼
            articles.push({
                title: `è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${teamE})`,
                body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(),
                error: true,
                isTopicArticle: true, // ã“ã‚Œã‚‚è©±é¡Œæ ¡è¨˜äº‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™
                context: { teamName: teamE, theme: 'E' } // â˜…å†ç”Ÿæˆç”¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            });
            // â–²â–²â–²
        }
    }

    // 2. Dãƒ©ãƒ³ã‚¯æ ¡ã®è¨˜äº‹ (ãƒ†ãƒ¼ãƒ: èºé€²ã®ãƒ™ã‚¹ãƒˆ8ã¸)
    const teamD = teamsByRank['D'][0];
    if (teamD) {
        const article = await createTopicArticle(teamD, getTeamRank(teamD), 'D');
        if (article) {
            articles.push(article);
        } else {
            articles.push({
                title: `è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${teamD})`,
                body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(),
                error: true,
                isTopicArticle: true, 
                context: { teamName: teamD, theme: 'D' } 
            });
        }
    }

    // 3. Cãƒ©ãƒ³ã‚¯æ ¡ã®è¨˜äº‹ (ãƒ†ãƒ¼ãƒ: ç”²å­åœ’å‡ºå ´ã¨ã„ã†æ‚²é¡˜ã¸)
    const teamC = teamsByRank['C'][0];
    if (teamC) {
        const article = await createTopicArticle(teamC, getTeamRank(teamC), 'C');
        if (article) {
            articles.push(article);
        } else {
            articles.push({
                title: `è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${teamC})`,
                body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(),
                error: true,
                isTopicArticle: true, 
                context: { teamName: teamC, theme: 'C' } 
            });
        }
    }

    // 4. Bãƒ©ãƒ³ã‚¯æ ¡ã®è¨˜äº‹ (ãƒ†ãƒ¼ãƒ: æ‰“å€’Aãƒ©ãƒ³ã‚¯ã¸)
    const teamB = teamsByRank['B'][0];
    if (teamB) {
        const article = await createTopicArticle(teamB, getTeamRank(teamB), 'B');
        if (article) {
            articles.push(article);
        } else {
            articles.push({
                title: `è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${teamB})`,
                body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(),
                error: true,
                isTopicArticle: true, 
                context: { teamName: teamB, theme: 'B' } 
            });
        }
    }

    // 5. Aãƒ©ãƒ³ã‚¯æ ¡ã®è¨˜äº‹ (ãƒ†ãƒ¼ãƒ: ç‹è€…ã®é“)
    const teamA = teamsByRank['A'][0];
    if (teamA) {
        const article = await createTopicArticle(teamA, getTeamRank(teamA), 'A');
        if (article) {
            articles.push(article);
        } else {
            articles.push({
                title: `è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${teamA})`,
                body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(),
                error: true,
                isTopicArticle: true, 
                context: { teamName: teamA, theme: 'A' } 
            });
        }
    }

    // å¤±æ•—ã—ãŸè¨˜äº‹(ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)ã‚‚ãã®ã¾ã¾è¿”ã™ãŸã‚ã€.filter(Boolean) ã¯å‰Šé™¤
    return articles;
}

/**
 * generateTopicSchoolArticles ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã€‚
 * 1æ ¡ã‚’é¸ã³ã€ãƒ©ãƒ³ã‚¯ã«å¿œã˜ãŸãƒ†ãƒ¼ãƒã§è¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹ã€‚
 * (â˜…ã€Œç¬¬ã€‡ã‚·ãƒ¼ãƒ‰ã€è¡¨è¨˜ã«å¯¾å¿œã—ãŸæœ€çµ‚ç‰ˆ)
 * @param {string} teamName - é¸ã°ã‚ŒãŸãƒãƒ¼ãƒ å
 * @param {string} rank - ãƒãƒ¼ãƒ ãƒ©ãƒ³ã‚¯ (A, B, C, D, E)
 * @param {'E' | 'D' | 'C' | 'B' | 'A'} theme - è¨˜äº‹ã®ãƒ†ãƒ¼ãƒ
 * @returns {Promise<object|null>} - ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
async function createTopicArticle(teamName, rank, theme) {
    const teamData = TEAM_DATA[teamName];
    const teamRecord = tournamentState.teamRecords[teamName];
    const detailedData = DETAILED_TEAM_DATA[teamName];
    const lore = PREFECTURE_LORE; 

    // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¿®æ­£ â–¼â–¼â–¼
    
    // 1. ãƒ©ãƒ³ã‚¯è¨˜å·ã‚’æ—¥æœ¬èªã®èª¬æ˜ã«å¤‰æ› (ä¾‹: 'A' -> 'åé–€æ ¡')
    const rankDescription = getRankDescription(rank); 
    
    // 2. â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã®æ–‡å­—åˆ—ã‚’å–å¾— (ä¾‹: "(ç¬¬1ã‚·ãƒ¼ãƒ‰)")
    const seedRankString = getSeedRankString(teamName, tournamentState.seeds);

    // 3. AIã«æ¸¡ã™ãŸã‚ã®è©³ç´°æƒ…å ±ã‚’ä½œæˆ (ãƒ©ãƒ³ã‚¯èª¬æ˜ã¨ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã®ä¸¡æ–¹ã‚’å«ã‚ã‚‹)
    let contextInfo = `
- **ãƒãƒ¼ãƒ å:** ${teamName} ${seedRankString} (${rankDescription})
- **ãƒãƒ¼ãƒ èƒŒæ™¯(info):** ${teamData.info || 'æƒ…å ±ãªã—'}
- **ç›£ç£:** ${teamData.coach.name} (${teamData.coach.style})
- **æ˜¨å¹´ã®æˆç¸¾:** ${getRankString(teamRecord.lastFinish)}
`;
    if (detailedData) {
        contextInfo += `- **æ³¨ç›®é¸æ‰‹:** ${detailedData.players.map(p => `${p.name}(${p.year}å¹´, ${p.pos}) - ${p.desc}`).join('ã€ ')}\n`;
    }

    // ãƒãƒ¼ãƒ ã®åˆæˆ¦æƒ…å ±ã‚’æ¤œç´¢
    const firstMatch = Object.values(tournamentState.matches).find(m => 
        m.id.includes('-R1-') && (m.team1 === teamName || m.team2 === teamName)
    );
    
    let firstMatchInfo = '';
    if (firstMatch) {
        const opponentName = firstMatch.team1 === teamName ? firstMatch.team2 : firstMatch.team1;
        // ç›¸æ‰‹ã®ãƒ©ãƒ³ã‚¯ã‚‚æ—¥æœ¬èªã®èª¬æ˜ + ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«å¤‰æ›
        const opponentRankDesc = getRankDescription(calculateRank(opponentName, tournamentState)); 
        const opponentSeedRank = getSeedRankString(opponentName, tournamentState.seeds);
        
        let scheduleInfo = 'æ—¥ç¨‹ãƒ»çƒå ´æœªå®š';
        if (firstMatch.schedule) {
            const gameNumIcon = ['â‘ ', 'â‘¡', 'â‘¢', 'â‘£'][firstMatch.schedule.game - 1] || `(ç¬¬${firstMatch.schedule.game}è©¦åˆ)`;
            scheduleInfo = `${firstMatch.schedule.date} ${firstMatch.schedule.stadiumFull} ${gameNumIcon}`;
        }
        
        firstMatchInfo = `
- **åˆæˆ¦æƒ…å ±:**
  - **å¯¾æˆ¦ç›¸æ‰‹:** ${opponentName} ${opponentSeedRank} (${opponentRankDesc})
  - **æ—¥ç¨‹:** ${scheduleInfo}
`;
    }
    contextInfo += firstMatchInfo; // ãƒãƒ¼ãƒ æƒ…å ±ã«åˆæˆ¦æƒ…å ±ã‚’é€£çµ
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    // ãƒ†ãƒ¼ãƒã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
    let prompt = `ã‚ãªãŸã¯ã€Œã‚¹ãƒãƒ¼ãƒ„å ±çŸ¥ã€ã®é«˜æ ¡é‡çƒæ‹…å½“è¨˜è€…ã§ã™ã€‚
å¤ã®é™å²¡å¤§ä¼šã®çµ„ã¿åˆã‚ã›ãŒæ±ºå®šã—ã¾ã—ãŸã€‚
ã‚ãªãŸã¯ä»Šã€ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ãŸã€Œè©±é¡Œæ ¡ã€ã®ç´¹ä»‹è¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ã„ã¾ã™ã€‚
ä»¥ä¸‹ã®ã€å–æãƒ‡ãƒ¼ã‚¿ã€‘ã¨ã€åŸ·ç­†ãƒ†ãƒ¼ãƒã€‘ã«åŸºã¥ãã€æƒ…æ™¯ã‚„é¸æ‰‹ã®èƒŒæ™¯ï¼ˆç‰©èªï¼‰ãŒç›®ã«æµ®ã‹ã¶ã‚ˆã†ãªãƒªã‚¢ãƒ«ãªç´¹ä»‹è¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### å–æãƒ‡ãƒ¼ã‚¿
${contextInfo}

### é™å²¡çœŒã®å¸¸è­˜ï¼ˆã‚ãªãŸã®çŸ¥è­˜ï¼‰
${lore}

`;

    // â–¼â–¼â–¼ å„ãƒ†ãƒ¼ãƒã®æŒ‡ç¤ºæ–‡ã‚‚ (ãƒ©ãƒ³ã‚¯èª¬æ˜) ã«ä¿®æ­£ â–¼â–¼â–¼
    if (theme === 'E') {
        prompt += `
### åŸ·ç­†ãƒ†ãƒ¼ãƒï¼šã€Œæ‚²é¡˜ã®åˆæˆ¦çªç ´ã¸ã€
- ã“ã®ãƒãƒ¼ãƒ ï¼ˆ${rankDescription}ï¼‰ã®ç›®æ¨™ã¯ã€ã¾ãšã€Œå¤ã«1å‹ã€ã™ã‚‹ã“ã¨ã§ã™ã€‚
- ãã®ãƒãƒ¼ãƒ ãŒæŠ±ãˆã‚‹**ç‰¹æœ‰ã®äº‹æƒ…**ï¼ˆä¾‹ï¼šæµœæ¾ç‰¹æ”¯ã®å‰µéƒ¨èƒŒæ™¯ã€æ–°å±…ã®0å‹32æ•—ã€å·æ ¹ã®æœ€å¾Œã®å¤ã€è™åºœå³¶ã®é›¢å³¶ãƒãƒ³ãƒ‡ãªã©ï¼‰ã‚’**è¨˜äº‹ã®ä¸­å¿ƒ**ã«æ®ãˆã¦ãã ã•ã„ã€‚
- é¸æ‰‹ã‚„ç›£ç£ã®ã€Œã¾ãš1å‹ã—ãŸã„ã€ã¨ã„ã†**åˆ‡å®Ÿãªæƒ³ã„**ã‚„ã€ãƒãƒ¼ãƒ ä¸€ä¸¸ã¨ãªã£ã¦å›°é›£ã«ç«‹ã¡å‘ã‹ã†å§¿ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚
`;
    } else if (theme === 'D') {
        prompt += `
### åŸ·ç­†ãƒ†ãƒ¼ãƒï¼šã€Œèºé€²ã®ãƒ™ã‚¹ãƒˆ8ã‚’ç›®æŒ‡ã—ã¦ã€
- ã“ã®ãƒãƒ¼ãƒ ï¼ˆ${rankDescription}ï¼‰ã®ç›®æ¨™ã¯ã€å¼·è±ªã‚’å€’ã—ã¦ã€Œãƒ™ã‚¹ãƒˆ8ã€ã«é€²å‡ºã—ã€å¤§ä¼šã®ãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ã«ãªã‚‹ã“ã¨ã§ã™ã€‚
- ãƒãƒ¼ãƒ ã®**æ­´å²**ã‚„ã€æ³¨ç›®é¸æ‰‹ï¼ˆã„ãªã‘ã‚Œã°æ¶ç©ºã®æ³¨ç›®é¸æ‰‹ã‚’å‰µä½œï¼‰ã®**æˆé•·ç‰©èª**ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ãã ã•ã„ã€‚
- ç›£ç£ã‚„ä¸»å°†ã®ã€Œä»Šå¹´ã“ãã¯ã€ã¨ã„ã†ã€**ä¸‹å‰‹ä¸Šï¼ˆã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒªãƒ³ã‚°ï¼‰**ã«ã‹ã‘ã‚‹æ„æ°—è¾¼ã¿ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚
`;
    } else if (theme === 'C') {
        prompt += `
### åŸ·ç­†ãƒ†ãƒ¼ãƒï¼šã€Œç”²å­åœ’å‡ºå ´ã¨ã„ã†æ‚²é¡˜ã¸ã€
- ã“ã®ãƒãƒ¼ãƒ ï¼ˆ${rankDescription}ï¼‰ã®ç›®æ¨™ã¯ã€é™å²¡çœŒã®ã€Œæˆ¦å›½æ™‚ä»£ã€ã‚’å‹ã¡æŠœãã€ç”²å­åœ’ã«å‡ºå ´ã™ã‚‹ã“ã¨ã§ã™ã€‚
- ãƒãƒ¼ãƒ ã®ä¸­å¿ƒã¨ãªã‚‹**ã‚¨ãƒ¼ã‚¹ã‚„ä¸»è»¸é¸æ‰‹**ã«ç„¦ç‚¹ã‚’å½“ã¦ã€ãã®é¸æ‰‹ã®**è‹¦æ‚©ã€æˆé•·ã€ãã—ã¦æ±ºæ„**ã‚’æ·±ãæ˜ã‚Šä¸‹ã’ã¦ãã ã•ã„ã€‚
- ç›£ç£ã¨ã®**å¸«å¼Ÿé–¢ä¿‚**ã‚„ã€ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã¨ã®çµ†ãªã©ã€**äººé–“ãƒ‰ãƒ©ãƒ**ã‚’è¨˜äº‹ã®ä¸­å¿ƒã«æ®ãˆã¦ãã ã•ã„ã€‚
- ã€Œå¸¸è­˜ã€ï¼ˆãƒŠãƒ ã‚³ã€æ–°ç§ç«‹å¼·è±ªã€ä¼çµ±æ ¡ï¼‰ã®ä¸­ã§ã€ã“ã®ãƒãƒ¼ãƒ ãŒã©ã®ã‚ˆã†ãªç«‹ã¡ä½ç½®ã«ãŠã‚Šã€ä½•ã‚’èƒŒè² ã£ã¦ã„ã‚‹ã®ã‹ã‚’æ–‡è„ˆã«å«ã‚ã¦ãã ã•ã„ã€‚
`;
    } else if (theme === 'B') {
        prompt += `
### åŸ·ç­†ãƒ†ãƒ¼ãƒï¼šã€Œæ‚²é¡˜ã®ç”²å­åœ’å‡ºå ´ã¸ï¼ãã—ã¦è–åœ°ï¼‘å‹ã‚’ã€
- ã“ã®ãƒãƒ¼ãƒ ï¼ˆ${rankDescription}ï¼‰ã¯ã€å„ªå‹å€™è£œã«æ¬¡ãã€Œå¼·è±ªã€ã§ã™ã€‚æœ€å¤§ã®ç›®æ¨™ã¯ã€åé–€æ ¡ã‚’å€’ã—ã€ã¾ãšã¯ã€Œç”²å­åœ’å‡ºå ´ã€ã®åˆ‡ç¬¦ã‚’æ´ã‚€ã“ã¨ã§ã™ã€‚
- ãƒãƒ¼ãƒ ã®å¼·ã¿ï¼ˆä¾‹ï¼šå¼·åŠ›æ‰“ç·šï¼‰ã«ç„¦ç‚¹ã‚’å½“ã¦ã€ãã‚ŒãŒç”²å­åœ’å‡ºå ´ã€ã•ã‚‰ã«ãã®å…ˆã®ã€Œç”²å­åœ’ã§ã®å‹åˆ©ã€ã«ã©ã†ç¹‹ãŒã‚‹ã‹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
- ãƒãƒ¼ãƒ ã®ã‚­ãƒ¼ãƒãƒ³ï¼ˆä¾‹ï¼š4ç•ªã€ã‚¨ãƒ¼ã‚¹ï¼‰ã‚’å–ã‚Šä¸Šã’ã€å½¼/å½¼å¥³ã®ã€Œã¾ãšã¯ç”²å­åœ’ã«é€£ã‚Œã¦è¡Œãã€ã¨ã„ã†å¼·ã„æ±ºæ„ã‚’èªã‚‰ã›ã¦ãã ã•ã„ã€‚
- ã€Œå¸¸è­˜ã€ã®ä¸­ã§ã€ã“ã®ãƒãƒ¼ãƒ ãŒã€Œæ–°ç§ç«‹å¼·è±ªã€ãªã®ã‹ã€Œä¼çµ±æ ¡ã€ãªã®ã‹ã‚’æ„è­˜ã—ã€ãã®ç«‹å ´ã‹ã‚‰ã®æŒ‘æˆ¦ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚
`;
    } else if (theme === 'A') {
        prompt += `
### åŸ·ç­†ãƒ†ãƒ¼ãƒï¼šã€Œå…¨å›½åˆ¶è¦‡ã¸ã€ç‹è€…ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã€
- ã“ã®ãƒãƒ¼ãƒ ï¼ˆ${rankDescription}ï¼‰ã¯ã€ä»Šå¤§ä¼šã®ã€Œå„ªå‹å€™è£œç­†é ­ã€ã§ã™ã€‚æœ€çµ‚ç›®æ¨™ã¯ã€Œå…¨å›½åˆ¶è¦‡ã€ã§ã™ãŒã€ãã®ãŸã‚ã«ã¯ã¾ãšã€Œç”²å­åœ’å‡ºå ´ã€ã¨ã„ã†æœ€å¤§ã®é–¢é–€ã‚’çªç ´ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
- **ã€Œå‹ã£ã¦å½“ç„¶ã€ã¨ã„ã†ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼**ã®ä¸­ã§ã€ã¾ãšã¯çœŒå¤§ä¼šã‚’å‹ã¡æŠœãã“ã¨ã®é›£ã—ã•ã‚’ã€ä¸»å°†ã‚„ç›£ç£ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€šã˜ã¦æå†™ã—ã¦ãã ã•ã„ã€‚
- ãƒãƒ¼ãƒ ã®åœ§å€’çš„ãªæˆ¦åŠ›ï¼ˆä¾‹ï¼šãƒ—ãƒ­æ³¨ç›®é¸æ‰‹ï¼‰ã‚’ç´¹ä»‹ã—ã¤ã¤ã€ãã®é¸æ‰‹ãŸã¡ãŒã€Œå…¨å›½åˆ¶è¦‡ã€ã¨ã„ã†ç›®æ¨™ã¨ã€ŒçœŒå¤§ä¼šæ•—é€€ã¯è¨±ã•ã‚Œãªã„ã€ã¨ã„ã†ç¾å®Ÿã®é–“ã§ã©ã†æˆ¦ã£ã¦ã„ã‚‹ã‹ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚
- ã€Œå¸¸è­˜ã€ã®ä¸­ã§ã€ã“ã®ãƒãƒ¼ãƒ ãŒã€ŒãƒŠãƒ ã‚³è³‡æœ¬ã€ãªã®ã‹ã€Œä¼çµ±æ ¡ã€ãªã®ã‹ã‚’æ˜ç¢ºã«ã—ã€ãã®ç«‹å ´ã‹ã‚‰ã®ç‹è€…ã®æˆ¦ã„ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚
`;
    }

    prompt += `
### è¿½åŠ æŒ‡ç¤ºï¼šåˆæˆ¦ã®æƒ…å ±ã€æœ€é‡è¦ã€‘
- è¨˜äº‹ã®æœ€å¾Œï¼ˆç· ã‚ããã‚Šï¼‰ã«ã€**ã€å–æãƒ‡ãƒ¼ã‚¿ã€‘ã«ã‚ã‚‹ã€Œåˆæˆ¦æƒ…å ±ã€**ï¼ˆå¯¾æˆ¦ç›¸æ‰‹ã€æ—¥ç¨‹ã€çƒå ´ï¼‰ã«å¿…ãšè¨€åŠã—ã€å¤§ä¼šã¸ã®æœŸå¾…æ„Ÿã‚’é«˜ã‚ã¦ãã ã•ã„ã€‚
- **ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘**: å–æãƒ‡ãƒ¼ã‚¿ã«ã€Œ(ç¬¬1ã‚·ãƒ¼ãƒ‰)ã€ãªã©ã®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚è¨˜äº‹ã®æœ¬æ–‡ã‚„ã‚¿ã‚¤ãƒˆãƒ«ã§ã€**ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã®ã€‡ã€‡ã€**ã‚„**ã€Œåˆæˆ¦ã®ç›¸æ‰‹ã¯ç¬¬8ã‚·ãƒ¼ãƒ‰ã®â–³â–³ã€**ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚å…·ä½“çš„ã«è¨€åŠã—ã¦ãã ã•ã„ã€‚
- ï¼ˆä¾‹ï¼šã€Œ${seedRankString || ''}${teamName}ã®åˆæˆ¦ã¯ã€‡ã€‡æ—¥ã€â–³â–³çƒå ´ã§ã®${firstMatchInfo ? firstMatch.team1 === teamName ? firstMatch.team2 : firstMatch.team1 : 'â–¡â–¡é«˜æ ¡'}æˆ¦ã€‚å½¼ã‚‰ã®å¤ãŒã€ã„ã‚ˆã„ã‚ˆå¹•ã‚’é–‹ã‘ã‚‹ã€‚ã€ï¼‰

### å‡ºåŠ›å½¢å¼ã€å³å®ˆã€‘
- **ã€æœ€é‡è¦ã€‘** ã‚ãªãŸã®å¿œç­”ã¯ã€å¿…ãšå˜ä¸€ã®JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"ã®ã¿"ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
- **çµ¶å¯¾ã«**ã€JSONã®å‰å¾Œã«ã€Œã¯ã„ã€è¨˜äº‹ã§ã™ã€ã‚„ã€Œ\`\`\`jsonã€ãªã©ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä»˜ã‘åŠ ãˆã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚
{"title": "ï¼ˆä¾‹ï¼šã€é«˜æ ¡é‡çƒã€‘${seedRankString || ''}${teamName}ã€åˆæˆ¦ã¯${firstMatchInfo ? (firstMatch.team1 === teamName ? firstMatch.team2 : firstMatch.team1) : 'XX'}ã¨æ¿€çªï¼‰", "body": "ï¼ˆã“ã“ã«ã‚¹ãƒãƒ¼ãƒ„å ±çŸ¥é¢¨ã®è¨˜äº‹æœ¬æ–‡ï¼‰"}
`;

    // --- AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ---
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
            const rawTextFromAi = result.candidates[0].content?.parts[0]?.text;
            const article = parseJsonFromText(rawTextFromAi);
            
            if (article && article.title && article.body) {
                // æˆåŠŸï¼šè¨˜äº‹ã«ç½²åã‚’è¿½åŠ ã—ã¦è¿”ã™
                article.body += "\n\nã€€ï¼ˆã‚¹ãƒãƒ¼ãƒ„å ±çŸ¥ è¨˜è€…ï¼‰"; // ç½²å
                return { 
                    ...article, 
                    timestamp: Date.now(),
                    isTopicArticle: true, // è©±é¡Œæ ¡ç´¹ä»‹ãƒ•ãƒ©ã‚°
                    context: { teamName: teamName, theme: theme, isTopicArticle: true } // â˜…isTopicArticleãƒ•ãƒ©ã‚°ã‚’contextã«ã‚‚è¿½åŠ 
                };
            } else {
                 console.error("parseJsonFromText failed for TopicArticle:", rawTextFromAi);
                 throw new Error("AI response format error after parsing (TopicArticle).");
            }
        } else {
             console.error("Unexpected AI response structure (TopicArticle):", result);
             throw new Error("AI response structure is missing expected parts (TopicArticle).");
        }
    } catch (error) {
        console.error(`è©±é¡Œæ ¡ç´¹ä»‹è¨˜äº‹ï¼ˆ${teamName}ï¼‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:`, error);
        return null; // å¤±æ•—ã—ãŸå ´åˆã¯ null ã‚’è¿”ã™
    }
}


/**
 * AIã«çµ„ã¿åˆã‚ã›æŠ½é¸çµæœã®è©³ç´°åˆ†æã«åŸºã¥ã„ãŸå±•æœ›ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’ç”Ÿæˆã•ã›ã‚‹
 * (â˜…å‹¢åŠ›å›³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ•ãƒ©ã‚°ã‚’å‰Šé™¤ã—ã€é€šå¸¸è¨˜äº‹ã¨ã—ã¦æ‰±ã†æœ€çµ‚ç‰ˆ)
 */
async function generateBracketAnalysisNewsArticle(state) {
    const { teams, seeds } = state;
    if (teams.length < 8) return null; 

    // --- ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®è©³ç´°åˆ†æãƒ­ã‚¸ãƒƒã‚¯ ---
    const numBlocks = Math.max(1, Math.ceil(teams.length / 16));
    const blockSize = Math.floor(teams.length / numBlocks);
    const blockData = [];
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
    const getTeamRank = (teamName) => calculateRank(teamName, state);

    for (let i = 0; i < numBlocks; i++) {
        const blockName = String.fromCharCode(65 + i);
        const startIdx = i * blockSize;
        const endIdx = (i + 1) * blockSize;
        const blockTeams = teams.slice(startIdx, endIdx);
        if (blockTeams.length === 0) continue;

        const strongTeamsInBlock = blockTeams.filter(team => {
            const rank = getTeamRank(team);
            return seeds.some(s => s.team === team) || ['A', 'B'].includes(rank); 
        });

        const matchupsR1 = [];
        const potentialR2 = [];
        const potentialR3 = [];

        for (let j = 0; j < blockTeams.length; j += 2) {
            const team1 = blockTeams[j];
            const team2 = blockTeams[j + 1];
            if (!team1 || !team2) continue;
            const rank1 = getTeamRank(team1);
            const rank2 = getTeamRank(team2);
            const matchup = { team1, rank1, team2, rank2 };
            matchupsR1.push(matchup);
            if ((seeds.some(s => s.team === team1) || ['A', 'B'].includes(rank1)) && (seeds.some(s => s.team === team2) || ['A', 'B'].includes(rank2))) {
                matchup.isCrush = true;
            }
        }

        if (blockTeams.length >= 4) {
            for (let j = 0; j < matchupsR1.length; j += 2) {
                 const winner1Match = matchupsR1[j];
                 const winner2Match = matchupsR1[j + 1];
                 if (!winner1Match || !winner2Match) continue;
                 const potentialWinner1 = rankValues[winner1Match.rank1] >= rankValues[winner1Match.rank2] ? winner1Match.team1 : winner1Match.team2;
                 const potentialWinner2 = rankValues[winner2Match.rank1] >= rankValues[winner2Match.rank2] ? winner2Match.team1 : winner2Match.team2;
                 if (strongTeamsInBlock.includes(potentialWinner1) && strongTeamsInBlock.includes(potentialWinner2)) {
                     potentialR2.push(`${potentialWinner1} vs ${potentialWinner2}`);
                 }
            }
        }
        if (teams.length === 64 && blockTeams.length >= 8) {
             const blockSeeds = strongTeamsInBlock.filter(t => seeds.some(s => s.team === t)); 
             if (blockSeeds.length >= 2) {
                 potentialR3.push(`${blockSeeds[0]} vs ${blockSeeds[1]} (äºˆæƒ³)`);
             }
        }

        blockData.push({
            name: blockName, teams: blockTeams, strongTeams: strongTeamsInBlock,
            matchupsR1: matchupsR1, potentialR2: potentialR2, potentialR3: potentialR3
        });
    }
    // --- (åˆ†æãƒ­ã‚¸ãƒƒã‚¯ã“ã“ã¾ã§) ---

    // --- åˆ†æçµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆã«ã¾ã¨ã‚ã‚‹ ---
    let blockSummary = '';
    let crushR1 = [];
    let goodCardsR2 = [];
    let goodCardsR3 = [];
    blockData.forEach(block => {
        const strongTeamNames = block.strongTeams.map(team => 
            `${team} ${getSeedRankString(team, state.seeds)}`
        ).join(', ');
        
        blockSummary += `- ${block.name}ãƒ–ãƒ­ãƒƒã‚¯: æœ‰åŠ›æ ¡ ${block.strongTeams.length} (${strongTeamNames || 'ãªã—'})\n`;
        
        block.matchupsR1.forEach(m => {
            if (m.isCrush) {
                const team1Info = `${m.team1}${getSeedRankString(m.team1, state.seeds)}(${m.rank1})`;
                const team2Info = `${m.team2}${getSeedRankString(m.team2, state.seeds)}(${m.rank2})`;
                crushR1.push(`${block.name}: ${team1Info} vs ${team2Info}`);
            }
        });
        goodCardsR2.push(...block.potentialR2.map(card => `${block.name}: ${card}`));
        goodCardsR3.push(...block.potentialR3.map(card => `${block.name}: ${card}`));
    });

    blockData.sort((a, b) => b.strongTeams.length - a.strongTeams.length);
    const deathBlock = blockData[0];
    const blessedBlock = blockData[blockData.length - 1];

    let analysisText = `å„ãƒ–ãƒ­ãƒƒã‚¯ã®æœ‰åŠ›æ ¡:\n${blockSummary}`;
    analysisText += `æ­»ã®ãƒ–ãƒ­ãƒƒã‚¯: ${deathBlock.name} (${deathBlock.strongTeams.length}æ ¡)\n`;
    analysisText += `æµã¾ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯: ${blessedBlock.name} (${blessedBlock.strongTeams.length}æ ¡)\n`;
    if (crushR1.length > 0) analysisText += `1å›æˆ¦ã§ã®æœ‰åŠ›æ ¡æ½°ã—åˆã„:\n  - ${crushR1.join('\n  - ')}\n`;
    if (goodCardsR2.length > 0) analysisText += `2å›æˆ¦ã§ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰(äºˆæƒ³):\n  - ${goodCardsR2.join('\n  - ')}\n`;
    if (goodCardsR3.length > 0) analysisText += `3å›æˆ¦ã§ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰(äºˆæƒ³):\n  - ${goodCardsR3.join('\n  - ')}\n`;
    // --- (åˆ†æãƒ†ã‚­ã‚¹ãƒˆã¾ã¨ã‚ã“ã“ã¾ã§) ---

    // --- è¨˜äº‹ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (å¤‰æ›´ãªã—) ---
    const prompt = `ã‚ãªãŸã¯ã€æ—¥æœ¬ã®é«˜æ ¡é‡çƒã‚’æ·±ãæ„›ã™ã‚‹ã€æƒ…ç†±çš„ãªã‚¹ãƒãƒ¼ãƒ„è¨˜è€…ã§ã™ã€‚
${state.tournamentYear}å¹´åº¦ å¤å­£å¤§ä¼šã®çµ„ã¿åˆã‚ã›æŠ½é¸ä¼šãŒçµ‚äº†ã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®è©³ç´°ãªåˆ†æçµæœã«åŸºã¥ãã€èª­è€…ã®æœŸå¾…æ„Ÿã‚’é«˜ã‚ã‚‹ã‚ˆã†ãªå±•æœ›è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

### å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰
${PREFECTURE_LORE}
---
### çµ„ã¿åˆã‚ã›åˆ†æçµæœ (â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ä»˜ã)
${analysisText}

### åŸ·ç­†æŒ‡ç¤º
- ã€å¸¸è­˜ã®åæ˜ ã€‘: è¨˜äº‹å…¨ä½“ã®åˆ†æã®åŸºç›¤ã¨ã—ã¦ã€ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰ã‚’100%æ´»ç”¨ã—ã¦ãã ã•ã„ã€‚
- ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘: åˆ†æçµæœã«ã€Œ(ç¬¬1ã‚·ãƒ¼ãƒ‰)ã€ãªã©ã®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã®283å­¦åœ’ã¯ã€œã€ã‚„ã€Œç¬¬3ã‚·ãƒ¼ãƒ‰ã®é™å²¡ãŒå…¥ã£ãŸCãƒ–ãƒ­ãƒƒã‚¯ã¯ã€œã€ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚å…·ä½“çš„ã«è¨€åŠã—ã€è¨˜äº‹ã«æ·±ã¿ã‚’ä¸ãˆã¦ãã ã•ã„ã€‚
- ã‚¿ã‚¤ãƒˆãƒ«: ã€Œå¤ã®çµ„ã¿åˆã‚ã›æ±ºå®šï¼${deathBlock.name}ãƒ–ãƒ­ãƒƒã‚¯ã¯æ¿€æˆ¦åŒºã‹ï¼Ÿã€ã®ã‚ˆã†ã«ã€æŠ½é¸çµæœã®ãƒã‚¤ãƒ³ãƒˆã¨å¤§ä¼šã¸ã®æœŸå¾…ãŒä¼ã‚ã‚‹ã‚‚ã®ã«ã—ã¦ãã ã•ã„ã€‚
- æœ¬æ–‡æ§‹æˆ:
    1. çµ„ã¿åˆã‚ã›ãŒæ±ºå®šã—ãŸã“ã¨ã‚’ä¼ãˆã‚‹å°å…¥ã€‚
    2. å„ãƒ–ãƒ­ãƒƒã‚¯ã®æœ‰åŠ›æ ¡ã«è§¦ã‚Œã¤ã¤ã€ç‰¹ã«ã€Œæ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ (${deathBlock.name})ã€ã¨ã€Œæµã¾ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ (${blessedBlock.name})ã€ã«ã¤ã„ã¦ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã‚‚äº¤ãˆã¦è©³ã—ãè§£èª¬ã—ã¦ãã ã•ã„ã€‚
    3. Cãƒ©ãƒ³ã‚¯ã®å®ŸåŠ›æ ¡ãŒã©ã®ãƒ–ãƒ­ãƒƒã‚¯ã§ã‚·ãƒ¼ãƒ‰æ ¡ã‚’è„…ã‹ã™å­˜åœ¨ï¼ˆãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ï¼‰ã«ãªã‚Šãã†ã‹ã€å…·ä½“çš„ãªæ ¡åã‚’æŒ™ã’ã¦åˆ†æã—ã¦ãã ã•ã„ã€‚
    4. å‹ã¡ä¸ŠãŒã‚Šã‚’äºˆæƒ³ã—ã€2å›æˆ¦ã‚„3å›æˆ¦ã§å®Ÿç¾ã—ãã†ãªå¥½ã‚«ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã‚‚è§¦ã‚Œã¦ãã ã•ã„ã€‚
    5. ã€AIè¨˜è€…ã®æ³¨ç›®æ ªã€‘: ã‚ãªãŸãŒã€Œä»Šå¤§ä¼šã®ä¸€æŠ¼ã—ãƒãƒ¼ãƒ ï¼ˆæ¨ã—ï¼‰ã€ã‚’1æ ¡é¸ã³ã€ãã®ãƒãƒ¼ãƒ ãŒæŒã¤ãƒ‰ãƒ©ãƒæ€§ï¼ˆä¾‹ï¼šã€Œé€†å¢ƒã€ã€Œæœ€å¾Œã®å¤ã€ã€Œå¤è±ªå¾©æ´»ã€ãªã©ï¼‰ã‚’ç†±ãèªã‚‹ã‚³ãƒ©ãƒ æ¬„ã‚’è¨­ã‘ã¦ãã ã•ã„ã€‚
    6. æœ€å¾Œã«ã€3å¹´ç”Ÿæœ€å¾Œã®å¤ã¨ã—ã¦ã®ãƒ‰ãƒ©ãƒæ€§ã‚„ã€ç”²å­åœ’ã¸ã®åˆ‡ç¬¦ã‚’ã‹ã‘ãŸç†±ã„æˆ¦ã„ã¸ã®æœŸå¾…ã‚’è¿°ã¹ã¦ç· ã‚ããã£ã¦ãã ã•ã„ã€‚
- æ–‡ä½“: ç†±æ„ãŒä¼ã‚ã‚‹ã€ã‚„ã‚„ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãªã‚¹ãƒãƒ¼ãƒ„è¨˜äº‹ã®æ–‡ä½“ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼
ã€æœ€é‡è¦ã€‘å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼"ã®ã¿"ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚è§£èª¬ã‚„å‰ç½®ãã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚
{"title": "ï¼ˆã“ã“ã«è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼‰", "body": "ï¼ˆã“ã“ã«è¨˜äº‹ã®æœ¬æ–‡ï¼‰"}`;

    // --- AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨çµæœã®å‡¦ç† ---
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
            
            // â–¼â–¼â–¼ ã“ã“ãŒä»Šå›ã®ä¿®æ­£ç®‡æ‰€ â–¼â–¼â–¼
            if (article && article.title && article.body) {
                return { 
                    ...article, 
                    timestamp: Date.now(), 
                    // isAnalysisArticle: true, // â˜…ã“ã®ãƒ•ãƒ©ã‚°ã‚’å‰Šé™¤ (ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ)
                    context: { isBracketAnalysis: true } 
                }; 
            }
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

        }
        throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒã€æ­£ã—ã„è¨˜äº‹å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    } catch (error) {
        console.error("AIçµ„ã¿åˆã‚ã›åˆ†æè¨˜äº‹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return {
            title: "çµ„ã¿åˆã‚ã›åˆ†æè¨˜äº‹ ç”Ÿæˆã‚¨ãƒ©ãƒ¼",
            body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã€è¨˜äº‹ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚",
            timestamp: Date.now(),
            error: true,
            errorId: `bracket-analysis-${Date.now()}`,
            context: { isBracketAnalysis: true }
        };
    }
}

// --- Tournament Animation Logic ---

let currentAnimation = null; // å†ç”Ÿä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¨®é¡ (null, 'autumn', 'spring')
let currentStep = -1;       // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·
let animationSteps = [];    // ç¾åœ¨ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å…¨ã‚¹ãƒ†ãƒƒãƒ—é–¢æ•°

const stage = document.getElementById('animation-stage');
const narrationEl = document.getElementById('animation-narration');
const prevBtn = document.getElementById('prev-step-btn');
const nextBtn = document.getElementById('next-step-btn');
const animPlaceholder = document.getElementById('anim-placeholder');
const showAutumnBtn = document.getElementById('show-autumn-anim-btn');
const showSpringBtn = document.getElementById('show-spring-anim-btn');

/**
 * ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´ ã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
function createAnimElement(type, text, options = {}) {
    const el = document.createElement('div');
    el.className = `anim-${type}`;
    el.textContent = text;
    if (options.id) el.id = options.id;
    if (options.children) options.children.forEach(child => el.appendChild(child));
    if (options.style) Object.assign(el.style, options.style);
    return el;
}

/**
 * è¦ç´ ã‚’è¡¨ç¤ºï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼‰ã•ã›ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
async function showElement(element, delay = 50) {
    if (!element) return;
    await sleep(delay);
    element.classList.add('show');
}

/**
 * è¦ç´ ã‚’éè¡¨ç¤ºï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼‰ã•ã›ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
async function hideElement(element, delay = 0) {
    if (!element) return;
    await sleep(delay);
    element.classList.remove('show', 'anim-highlight');
    await sleep(500); // Wait for fade out
}

/**
 * è¦ç´ ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
function highlightElement(element, clearOthers = true) {
    if (clearOthers) {
        stage.querySelectorAll('.anim-highlight').forEach(el => el.classList.remove('anim-highlight'));
    }
    if (element) {
        element.classList.add('anim-highlight');
    }
}

/**
 * ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã—ã€ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼é¢¨ã«è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
async function setNarration(text) {
    narrationEl.textContent = '';
    for (const char of text) {
        narrationEl.textContent += char;
        await sleep(30); // æ–‡å­—é–“ã®ã‚¦ã‚§ã‚¤ãƒˆ
    }
}

/**
 * ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œã¨ãƒœã‚¿ãƒ³åˆ¶å¾¡
 */
async function runStep(stepIndex) {
    if (stepIndex < 0 || stepIndex >= animationSteps.length) return;
    currentStep = stepIndex;
    stage.innerHTML = ''; // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
    animPlaceholder.classList.add('hidden'); // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼éè¡¨ç¤º
    await animationSteps[currentStep](); // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—é–¢æ•°ã‚’å®Ÿè¡Œ
    updateButtons();
}

function updateButtons() {
    prevBtn.disabled = currentStep <= 0;
    nextBtn.disabled = currentStep >= animationSteps.length - 1;
}

// --- ç§‹å­£å¤§ä¼šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒƒãƒ— ---
const autumnAnimation = [
    // Step 0: Introduction
    async () => {
        await setNarration("ğŸ‚ ç§‹å­£å¤§ä¼šã¯æ–°ãƒãƒ¼ãƒ æœ€åˆã®å…¬å¼æˆ¦ï¼ã‚»ãƒ³ãƒãƒ„ç”²å­åœ’å‡ºå ´ã«ç¹‹ãŒã‚Šã¾ã™ã€‚");
        const title = createAnimElement('bracket', 'ç§‹å­£å¤§ä¼šã‚·ã‚¹ãƒ†ãƒ ', { style: { fontSize: '1.2rem', fontWeight: 'bold' } });
        stage.appendChild(title);
        await showElement(title);
    },
    // Step 1: Regional Qualifiers Overview
    async () => {
        await setNarration("ã¾ãšã€çœŒå†…ã‚’4åœ°åŒºï¼ˆæ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨ãƒ»ä¼Šè±†ï¼‰ã«åˆ†ã‘ã¦åœ°åŒºäºˆé¸ã‚’è¡Œã„ã¾ã™ã€‚");
        const regions = ['æ±éƒ¨(20)', 'ä¸­éƒ¨(20)', 'è¥¿éƒ¨(20)', 'ä¼Šè±†(4)'].map(r => createAnimElement('region', r));
        const container = createAnimElement('bracket', '', { children: regions, style: { display: 'flex', justifyContent: 'center' } });
        stage.appendChild(container);
        for (const region of regions) await showElement(region);
    },
    // Step 2: Main 3 Regions - Blocks
    async () => {
        await setNarration("æ±ãƒ»ä¸­ãƒ»è¥¿åœ°åŒºã§ã¯ã€20ãƒãƒ¼ãƒ ãŒ4ãƒ–ãƒ­ãƒƒã‚¯ã«åˆ†ã‹ã‚Œã€å„ãƒ–ãƒ­ãƒƒã‚¯å„ªå‹ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚");
        const region = createAnimElement('region', 'æ±éƒ¨åœ°åŒº (20ãƒãƒ¼ãƒ )', { id: 'main-region', style: { width: '80%' } });
        const blocks = ['A (5)', 'B (5)', 'C (5)', 'D (5)'].map(b => createAnimElement('block', `ãƒ–ãƒ­ãƒƒã‚¯ ${b}`));
        region.append(...blocks);
        stage.appendChild(region);
        await showElement(region);
        for (const block of blocks) await showElement(block, 100);
        highlightElement(region);
    },
    // Step 3: Block Winner
    async () => {
        await setNarration("å„ãƒ–ãƒ­ãƒƒã‚¯ã®å„ªå‹ãƒãƒ¼ãƒ  (è¨ˆ4ãƒãƒ¼ãƒ ) ã¯çœŒå¤§ä¼šã¸é€²å‡ºæ±ºå®šï¼ğŸ†");
        const region = document.getElementById('main-region');
        if (!region) { // è¦ç´ ãŒãªã‘ã‚Œã°å†ç”Ÿæˆ (Prevãƒœã‚¿ãƒ³å¯¾ç­–)
            await autumnAnimation[2](); // å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å†å®Ÿè¡Œ
            await sleep(500);
        }
        const blockA = stage.querySelector('.anim-block'); // ä¾‹ã¨ã—ã¦Aãƒ–ãƒ­ãƒƒã‚¯
        const winner = createAnimElement('team', 'Aå„ªå‹', { classList: ['winner'] });
        blockA.appendChild(winner);
        await showElement(winner, 200);
        highlightElement(winner);
        // TODO: çŸ¢å°ã§ã€ŒçœŒå¤§ä¼šã¸ã€ã‚’ç¤ºã™
    },
    // Step 4: Block Runner-up & Repechage
    async () => {
        await setNarration("å„ãƒ–ãƒ­ãƒƒã‚¯ã®æº–å„ªå‹ãƒãƒ¼ãƒ  (è¨ˆ4ãƒãƒ¼ãƒ ) ã¯ã€æœ€å¾Œã®1æ ã‚’è³­ã‘ãŸæ•—è€…å¾©æ´»æˆ¦ã¸ã€‚");
        await autumnAnimation[3](); // å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã®è¡¨ç¤ºã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹
        const blocks = stage.querySelectorAll('.anim-block');
        const runnersUp = [];
        blocks.forEach((block, i) => {
            const runnerUp = createAnimElement('team', `${String.fromCharCode(65 + i)}æº–å„ªå‹`, { classList: ['loser'] });
            block.appendChild(runnerUp);
            runnersUp.push(runnerUp);
        });
        for (const ru of runnersUp) await showElement(ru, 100);

        const repechage = createAnimElement('bracket', 'ç¬¬5ä»£è¡¨æ±ºå®šæˆ¦ (æ•—è€…å¾©æ´»)', { id: 'repechage', style: { marginTop: '15px' } });
        stage.appendChild(repechage);
        await showElement(repechage);
        highlightElement(repechage);
        // TODO: æº–å„ªå‹ãƒãƒ¼ãƒ ã‹ã‚‰æ•—è€…å¾©æ´»æˆ¦ã¸ã®çŸ¢å°
    },
    // Step 5: Repechage Winner
    async () => {
        await setNarration("æ•—è€…å¾©æ´»æˆ¦ã®å‹è€… (1ãƒãƒ¼ãƒ ) ã‚‚çœŒå¤§ä¼šã¸é€²å‡ºï¼ã“ã‚Œã§å„åœ°åŒº5ãƒãƒ¼ãƒ ã€‚");
        await autumnAnimation[4]();
        const repechage = document.getElementById('repechage');
        const repWinner = createAnimElement('team', 'å¾©æ´»å„ªå‹', { classList: ['winner'] });
        repechage.appendChild(repWinner);
        await showElement(repWinner, 200);
        highlightElement(repWinner);
        // TODO: çŸ¢å°ã§ã€ŒçœŒå¤§ä¼šã¸ã€ã‚’ç¤ºã™
    },
    // Step 6: Izu Region
    async () => {
        await setNarration("ä¼Šè±†åœ°åŒºã¯4ãƒãƒ¼ãƒ ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã€‚å„ªå‹ã—ãŸ1ãƒãƒ¼ãƒ ã®ã¿çœŒå¤§ä¼šã¸ã€‚");
        const region = createAnimElement('region', 'ä¼Šè±†åœ°åŒº (4ãƒãƒ¼ãƒ )', { id: 'izu-region' });
        const winner = createAnimElement('team', 'ä¼Šè±†å„ªå‹', { classList: ['winner'] });
        region.appendChild(winner);
        stage.appendChild(region);
        await showElement(region);
        await showElement(winner, 200);
        highlightElement(region);
    },
    // Step 7: Prefectural Tournament
    async () => {
        await setNarration("å…¨ä»£è¡¨16ãƒãƒ¼ãƒ  (æ±5+ä¸­5+è¥¿5+ä¼Šè±†1) ãŒé›†çµã—ã€çœŒå¤§ä¼šæœ¬æˆ¦ (ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ)ï¼");
        const bracket = createAnimElement('bracket', 'çœŒå¤§ä¼šæœ¬æˆ¦ (16ãƒãƒ¼ãƒ )', { id: 'main-bracket' });
        const teams = ['æ±1', 'ä¸­1', 'è¥¿1', 'ä¼Š1', 'æ±2', 'ä¸­2', '...', 'è¥¿5(æ•—å¾©)'].map(t => createAnimElement('team', t));
        bracket.append(...teams);
        stage.appendChild(bracket);
        await showElement(bracket);
        for (const team of teams) await showElement(team, 30);
        highlightElement(bracket);
    },
    // Step 8: Rewards
    async () => {
        await setNarration("çœŒå¤§ä¼šã®å„ªå‹ãƒ»æº–å„ªå‹ã¯ã‚»ãƒ³ãƒãƒ„æœ‰åŠ›ï¼ãƒ™ã‚¹ãƒˆ8ä»¥ä¸Šã§æ˜¥å­£å¤§ä¼šã®ã‚·ãƒ¼ãƒ‰æ¨©ç²å¾—ï¼âœ¨");
        await autumnAnimation[7]();
        const bracket = document.getElementById('main-bracket');
        const rewards = createAnimElement('bracket', 'ğŸ†å„ªå‹/æº–å„ªå‹ â†’ ã‚»ãƒ³ãƒãƒ„ã¸<br>ğŸ…ãƒ™ã‚¹ãƒˆ8 â†’ æ˜¥ã‚·ãƒ¼ãƒ‰æ¨©', { style: { marginTop: '15px', borderColor: 'gold' } });
        stage.appendChild(rewards);
        await showElement(rewards, 200);
        highlightElement(rewards);
    }
];

// --- æ˜¥å­£å¤§ä¼šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒƒãƒ— ---
const springAnimation = [
    // Step 0: Introduction
    async () => {
        await setNarration("ğŸŒ¸ æ˜¥å­£å¤§ä¼šã¯å¤ã®å¤§ä¼šã®å‰å“¨æˆ¦ï¼å¤ã®ã‚·ãƒ¼ãƒ‰æ¨©ç²å¾—ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚");
        const title = createAnimElement('bracket', 'æ˜¥å­£å¤§ä¼šã‚·ã‚¹ãƒ†ãƒ ', { style: { fontSize: '1.2rem', fontWeight: 'bold' } });
        stage.appendChild(title);
        await showElement(title);
    },
    // Step 1: Seed Teams
    async () => {
        await setNarration("ç§‹å­£å¤§ä¼šãƒ™ã‚¹ãƒˆ8ã®ãƒãƒ¼ãƒ ã¯ã‚·ãƒ¼ãƒ‰æ ¡ã¨ãªã‚Šã€çœŒå¤§ä¼š2å›æˆ¦ã‹ã‚‰ç™»å ´ã—ã¾ã™ã€‚");
        const seeds = Array.from({ length: 8 }).map((_, i) => createAnimElement('team', `ç§‹Best8-${i+1}`, { classList: ['seed'] }));
        const container = createAnimElement('bracket', 'ã‚·ãƒ¼ãƒ‰æ ¡ (8ãƒãƒ¼ãƒ )', { children: seeds, id: 'seeds', style: { borderColor: 'orange' } });
        stage.appendChild(container);
        await showElement(container);
        for (const seed of seeds) await showElement(seed, 50);
        highlightElement(container);
    },
    // Step 2: Regional Qualifiers (Non-seeds)
    async () => {
        await setNarration("ã‚·ãƒ¼ãƒ‰æ ¡ä»¥å¤–ã®ãƒãƒ¼ãƒ ã¯ã€å†ã³åœ°åŒºäºˆé¸ã¸ã€‚ç§‹ã¨åŒæ§˜ã«ä»£è¡¨æ ã‚’äº‰ã„ã¾ã™ã€‚");
        const others = createAnimElement('region', 'ã‚·ãƒ¼ãƒ‰ä»¥å¤–ã®å…¨ãƒãƒ¼ãƒ  (56ãƒãƒ¼ãƒ )', { id: 'others' });
        const qualifiers = createAnimElement('bracket', 'åœ°åŒºäºˆé¸ (ç§‹ã¨åŒã˜å½¢å¼)', { id: 'qualifiers' });
        stage.appendChild(others);
        stage.appendChild(qualifiers);
        await showElement(others);
        await showElement(qualifiers, 200);
        highlightElement(qualifiers);
        // TODO: othersã‹ã‚‰qualifiersã¸ã®çŸ¢å°
    },
    // Step 3: Qualifier Winners
    async () => {
        await setNarration("åœ°åŒºäºˆé¸ã‚’çªç ´ã—ãŸ16ãƒãƒ¼ãƒ ãŒçœŒå¤§ä¼š1å›æˆ¦ã¸é€²å‡ºã—ã¾ã™ã€‚");
        await springAnimation[2](); // å‰ã®ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º
        const qualifiers = document.getElementById('qualifiers');
        const winners = Array.from({ length: 16 }).map((_, i) => createAnimElement('team', `äºˆé¸çªç ´-${i+1}`, { classList: ['winner'] }));
        const winnerContainer = createAnimElement('bracket', 'äºˆé¸çªç ´ (16ãƒãƒ¼ãƒ )', { children: winners, id: 'q-winners' });
        qualifiers.appendChild(winnerContainer);
        await showElement(winnerContainer, 200);
        highlightElement(winnerContainer);
    },
    // Step 4: Prefectural Round 1
    async () => {
        await setNarration("çœŒå¤§ä¼š1å›æˆ¦ã¯ã€äºˆé¸çªç ´æ ¡åŒå£«ã®å¯¾æ±ºã§ã™ã€‚");
        await springAnimation[3]();
        const qWinners = document.getElementById('q-winners');
        const r1Bracket = createAnimElement('bracket', 'çœŒå¤§ä¼š1å›æˆ¦ (8è©¦åˆ)', { id: 'r1-bracket', style: { marginTop: '15px' } });
        // ä»£è¡¨ã¨ã—ã¦4ãƒãƒ¼ãƒ è¡¨ç¤º
        const teamsR1 = ['äºˆé¸A', 'äºˆé¸B', 'äºˆé¸C', 'äºˆé¸D'].map(t => createAnimElement('team', t));
        r1Bracket.append(...teamsR1);
        stage.appendChild(r1Bracket);
        await showElement(r1Bracket, 200);
        highlightElement(r1Bracket);
        // TODO: q-winnersã‹ã‚‰r1-bracketã¸ã®çŸ¢å°
    },
    // Step 5: Prefectural Round 2 (Seeds Join)
    async () => {
        await setNarration("1å›æˆ¦ã®å‹è€…8ãƒãƒ¼ãƒ ãŒã€ã‚·ãƒ¼ãƒ‰æ ¡8ãƒãƒ¼ãƒ ã¨2å›æˆ¦ã§æ¿€çªï¼ã“ã“ã‹ã‚‰æœ¬æˆ¦ï¼");
        const seeds = Array.from({ length: 8 }).map((_, i) => createAnimElement('team', `ç§‹Best8-${i+1}`, { classList: ['seed'] }));
        const seedContainer = createAnimElement('bracket', 'ã‚·ãƒ¼ãƒ‰æ ¡ (8ãƒãƒ¼ãƒ )', { children: seeds, id: 'seeds', style: { borderColor: 'orange' } });

        const r1Winners = Array.from({ length: 8 }).map((_, i) => createAnimElement('team', `1å›æˆ¦å‹è€…-${i+1}`, { classList: ['winner'] }));
        const r1WinnerContainer = createAnimElement('bracket', '1å›æˆ¦å‹è€… (8ãƒãƒ¼ãƒ )', { children: r1Winners, id: 'r1-winners' });

        const r2Bracket = createAnimElement('bracket', 'çœŒå¤§ä¼š2å›æˆ¦ (16ãƒãƒ¼ãƒ )', { id: 'r2-bracket', style: { borderColor: 'red' } });

        stage.append(seedContainer, r1WinnerContainer, r2Bracket);
        await showElement(seedContainer);
        await showElement(r1WinnerContainer);
        await showElement(r2Bracket, 200);
        highlightElement(r2Bracket);
        // TODO: seedContainerã¨r1WinnerContainerã‹ã‚‰r2Bracketã¸ã®çŸ¢å°
    },
    // Step 6: Reward (Summer Seed)
    async () => {
        await setNarration("ã“ã®å¤§ä¼šã§ãƒ™ã‚¹ãƒˆ8ä»¥ä¸Šã«å…¥ã‚‹ã¨ã€å¤ã®é¸æ‰‹æ¨©å¤§ä¼šã®ã‚·ãƒ¼ãƒ‰æ¨©ç²å¾—ï¼ğŸ”¥");
        await springAnimation[5]();
        const r2Bracket = document.getElementById('r2-bracket');
        const reward = createAnimElement('bracket', 'ğŸ…ãƒ™ã‚¹ãƒˆ8 â†’ å¤ã®ã‚·ãƒ¼ãƒ‰æ¨©', { style: { marginTop: '15px', borderColor: 'gold' } });
        stage.appendChild(reward);
        await showElement(reward, 200);
        highlightElement(reward);
    }
];

// --- Event Listeners for Animation Control ---

showAutumnBtn.addEventListener('click', () => {
    currentAnimation = 'autumn';
    animationSteps = autumnAnimation;
    runStep(0);
});

showSpringBtn.addEventListener('click', () => {
    currentAnimation = 'spring';
    animationSteps = springAnimation;
    runStep(0);
});

prevBtn.addEventListener('click', () => {
    if (currentStep > 0) {
        runStep(currentStep - 1);
    }
});

nextBtn.addEventListener('click', () => {
    if (currentStep < animationSteps.length - 1) {
        runStep(currentStep + 1);
    }
});

// Helper for delays
// function sleep(ms) { // æ—¢å­˜ã®sleepé–¢æ•°ãŒã‚ã‚Œã°ä¸è¦
//     return new Promise(resolve => setTimeout(resolve, ms));
// }

/**
 * AIã«çµ„ã¿åˆã‚ã›æŠ½é¸çµæœã«åŸºã¥ã„ãŸã€ãªã‚“Jé¢¨ã®æ²ç¤ºæ¿ã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‹ã‚³ãƒ¡ãƒ³ãƒˆç¾¤ï¼‰ã‚’ç”Ÿæˆã•ã›ã‚‹
 * (â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯èªè­˜ æœ€çµ‚ç‰ˆ)
 */
async function generateBracketBbsThread(state) {
    const { teams, seeds } = state;
    if (!teams || teams.length < 8) {
        return null; 
    }

    // --- ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®è©³ç´°åˆ†æãƒ­ã‚¸ãƒƒã‚¯ ---
    const numBlocks = Math.max(1, Math.ceil(teams.length / 16)); 
    const blockSize = Math.floor(teams.length / numBlocks);
    const blockData = []; 
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 }; 
    const getTeamRank = (teamName) => calculateRank(teamName, state); 
    const getTeamRegion = (teamName) => TEAM_DATA[teamName]?.region || 'ä¸æ˜'; 

    let nicheMatchups = []; 

    for (let i = 0; i < numBlocks; i++) {
        const blockName = String.fromCharCode(65 + i);
        const startIdx = i * blockSize;
        const endIdx = (i + 1) * blockSize;
        const blockTeams = teams.slice(startIdx, endIdx);
        if (blockTeams.length === 0) continue;

        const strongTeamsInBlock = blockTeams.filter(team => {
            const rank = getTeamRank(team);
            return seeds.some(s => s.team === team) || ['A', 'B'].includes(rank); // â˜…ã‚·ãƒ¼ãƒ‰åˆ¤å®šã‚’ä¿®æ­£
        });

        const matchupsR1 = []; 
        const potentialR2 = []; 
        const potentialR3 = []; 

        for (let j = 0; j < blockTeams.length; j += 2) {
            const team1 = blockTeams[j];
            const team2 = blockTeams[j + 1];
            if (!team1 || !team2) continue;

            const rank1 = getTeamRank(team1);
            const rank2 = getTeamRank(team2);
            const region1 = getTeamRegion(team1);
            const region2 = getTeamRegion(team2);
            const matchup = { team1, rank1, region1, team2, rank2, region2 }; 
            matchupsR1.push(matchup);

            if ((seeds.some(s => s.team === team1) || ['A', 'B'].includes(rank1)) && (seeds.some(s => s.team === team2) || ['A', 'B'].includes(rank2))) {
                matchup.isCrush = true; 
            }
            
            // ... (ãƒãƒ‹ã‚¢ãƒƒã‚¯ãªæ³¨ç›®ã‚«ãƒ¼ãƒ‰ã®æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ...
            const rankDiff = Math.abs(rankValues[rank1] - rankValues[rank2]);
            const isStrong1 = rankValues[rank1] >= 4; // A or B
            const isStrong2 = rankValues[rank2] >= 4; // A or B
            const isMid1 = rankValues[rank1] === 3; // C
            const isMid2 = rankValues[rank2] === 3; // C
            if (region1 === region2 && !matchup.isCrush && rankValues[rank1] <= 3 && rankValues[rank2] <= 3) {
                 if (nicheMatchups.length < 3) {
                    nicheMatchups.push({ block: blockName, match: `${team1}(${rank1}) vs ${team2}(${rank2})`, reason: `${region1}åœ°åŒºå¯¾æ±º` });
                 }
            }
            else if (nicheMatchups.length < 3 && !matchup.isCrush && ((isStrong1 && isMid2) || (isMid1 && isStrong2))) {
                nicheMatchups.push({ 
                    block: blockName, 
                    match: `${team1}(${rank1}) vs ${team2}(${rank2})`, 
                    reason: `Cãƒ©ãƒ³ã‚¯ãŒå¼·è±ªã«æŒ‘ã‚€æ³¨ç›®ã‚«ãƒ¼ãƒ‰` 
                });
            }
            else if (rankDiff <= 1 && rankValues[rank1] <= 2 && rankValues[rank2] <= 2) {
                 if (nicheMatchups.length < 3 && !nicheMatchups.some(nm => nm.match.includes(team1) || nm.match.includes(team2))) {
                    nicheMatchups.push({ block: blockName, match: `${team1}(${rank1}) vs ${team2}(${rank2})`, reason: `å®ŸåŠ›ä¼¯ä»²ã®ä¸‹ä½å¯¾æ±º` });
                 }
            }
        } // End of 1å›æˆ¦ã‚«ãƒ¼ãƒ‰åˆ†æãƒ«ãƒ¼ãƒ—

        if (blockTeams.length >= 4) { 
            for (let j = 0; j < matchupsR1.length; j += 2) {
                const winner1Match = matchupsR1[j];
                const winner2Match = matchupsR1[j + 1];
                if (!winner1Match || !winner2Match) continue; 
                const potentialWinner1 = rankValues[winner1Match.rank1] >= rankValues[winner1Match.rank2] ? winner1Match.team1 : winner1Match.team2;
                const potentialWinner2 = rankValues[winner2Match.rank1] >= rankValues[winner2Match.rank2] ? winner2Match.team1 : winner2Match.team2;
                if (strongTeamsInBlock.includes(potentialWinner1) && strongTeamsInBlock.includes(potentialWinner2)) {
                    potentialR2.push(`${potentialWinner1} vs ${potentialWinner2}`);
                }
            }
        }
        if (teams.length === 64 && blockTeams.length >= 8) { 
             const blockSeeds = strongTeamsInBlock.filter(t => seeds.some(s => s.team === t)); // â˜…ã‚·ãƒ¼ãƒ‰åˆ¤å®šã‚’ä¿®æ­£
             if (blockSeeds.length >= 2) {
                 potentialR3.push(`${blockSeeds[0]} vs ${blockSeeds[1]} (äºˆæƒ³)`);
             }
             if (blockSeeds.length >= 1 && strongTeamsInBlock.length > blockSeeds.length) {
                 const topNonSeed = strongTeamsInBlock.find(t => !seeds.some(s => s.team === t));
                 if (topNonSeed) {
                     potentialR3.push(`${blockSeeds[0]} vs ${topNonSeed} (äºˆæƒ³)`);
                 }
             }
        }

        blockData.push({
            name: blockName,
            teams: blockTeams,
            strongTeams: strongTeamsInBlock,
            matchupsR1: matchupsR1,
            potentialR2: potentialR2,
            potentialR3: potentialR3
        });
    } // End of ãƒ–ãƒ­ãƒƒã‚¯åˆ†æãƒ«ãƒ¼ãƒ—

    // --- åˆ†æçµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆã«ã¾ã¨ã‚ã‚‹ ---
    // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¿®æ­£ â–¼â–¼â–¼
    let blockSummary = '';
    let crushR1 = []; 
    let goodCardsR2 = []; 
    let goodCardsR3 = []; 

    blockData.forEach(block => {
        // â˜…æœ‰åŠ›æ ¡ãƒªã‚¹ãƒˆã«ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã‚’è¿½åŠ 
        const strongTeamNames = block.strongTeams.map(team => 
            `${team} ${getSeedRankString(team, state.seeds)}`
        ).join(', ');
        
        blockSummary += `- ${block.name}ãƒ–ãƒ­ãƒƒã‚¯: æœ‰åŠ›æ ¡ ${block.strongTeams.length} (${strongTeamNames || 'ãªã—'})\n`;
        
        block.matchupsR1.forEach(m => {
            if (m.isCrush) {
                // â˜…1å›æˆ¦ã®æ½°ã—åˆã„ã«ã‚‚ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã‚’è¿½åŠ 
                const team1Info = `${m.team1}${getSeedRankString(m.team1, state.seeds)}(${m.rank1})`;
                const team2Info = `${m.team2}${getSeedRankString(m.team2, state.seeds)}(${m.rank2})`;
                crushR1.push(`${block.name}: ${team1Info} vs ${team2Info}`);
            }
        });
        goodCardsR2.push(...block.potentialR2.map(card => `${block.name}: ${card}`));
        goodCardsR3.push(...block.potentialR3.map(card => `${block.name}: ${card}`));
    });

    blockData.sort((a, b) => b.strongTeams.length - a.strongTeams.length);
    const deathBlock = blockData[0]; 
    const blessedBlock = blockData[blockData.length - 1]; 

    let analysisText = `å„ãƒ–ãƒ­ãƒƒã‚¯ã®æœ‰åŠ›æ ¡:\n${blockSummary}`;
    analysisText += `æ­»ã®ãƒ–ãƒ­ãƒƒã‚¯: ${deathBlock.name} (${deathBlock.strongTeams.length}æ ¡)\n`;
    analysisText += `æµã¾ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯: ${blessedBlock.name} (${blessedBlock.strongTeams.length}æ ¡)\n`;
    if (crushR1.length > 0) {
        analysisText += `1å›æˆ¦ã§ã®æœ‰åŠ›æ ¡æ½°ã—åˆã„:\n  - ${crushR1.join('\n  - ')}\n`;
    } else {
        analysisText += `1å›æˆ¦ã§ã®æœ‰åŠ›æ ¡åŒå£«ã®ç›´æ¥å¯¾æ±ºã¯ãªã—ã€‚\n`;
    }
    if (goodCardsR2.length > 0) {
        analysisText += `2å›æˆ¦ã§ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰(äºˆæƒ³):\n  - ${goodCardsR2.join('\n  - ')}\n`;
    }
     if (goodCardsR3.length > 0) {
        analysisText += `3å›æˆ¦ã§ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰(äºˆæƒ³):\n  - ${goodCardsR3.join('\n  - ')}\n`;
    }
    if (nicheMatchups.length > 0) {
        analysisText += `ãã®ä»–ã®æ³¨ç›®1å›æˆ¦ã‚«ãƒ¼ãƒ‰:\n${nicheMatchups.map(nm => `  - ${nm.block}ãƒ–ãƒ­ãƒƒã‚¯: ${nm.match} (${nm.reason})`).join('\n')}\n`;
    }
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    // --- (åˆ†æãƒ­ã‚¸ãƒƒã‚¯ã“ã“ã¾ã§) ---

    // --- ã‚¹ãƒ¬ãƒƒãƒ‰ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ---
    const prompt = `ã‚ãªãŸã¯ã€åŒ¿åæ²ç¤ºæ¿ã€Œãªã‚“ã§ã‚‚å®Ÿæ³Jï¼ˆãªã‚“Jï¼‰ã€ã®ä½æ°‘ã§ã™ã€‚ã‚ãªãŸã¯é«˜æ ¡é‡çƒã«è©³ã—ãã€ç…½ã‚Šã‚„ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚’äº¤ãˆãªãŒã‚‰ä¼šè©±ã‚’ç››ã‚Šä¸Šã’ã¾ã™ã€‚
å¤ã®é«˜æ ¡é‡çƒå¤§ä¼šã®çµ„ã¿åˆã‚ã›æŠ½é¸ä¼šãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚ä»¥ä¸‹ã®è©³ç´°ãªåˆ†æçµæœã‚’åŸºã«ã€**ãªã‚“Jã‚‰ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«**ã¨ã€ãã®ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã§ã®**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªåå¿œã‚³ãƒ¡ãƒ³ãƒˆã‚’30ã€œ40å€‹**ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰
${PREFECTURE_LORE}
---
### çµ„ã¿åˆã‚ã›åˆ†æçµæœã‚µãƒãƒªãƒ¼ (â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ä»˜ã)
${analysisText}

### ã‚ãªãŸãŒç”Ÿæˆã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã®æ–¹å‘æ€§
- **ã€å¸¸è­˜ã®åæ˜ ï¼ˆæœ€é‡è¦ï¼‰ã€‘**: ã‚ãªãŸãŒç†ŸçŸ¥ã—ã¦ã„ã‚‹ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰ã«åŸºã¥ãã€ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚
- **ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘**: åˆ†æçµæœã«ã€Œ(ç¬¬1ã‚·ãƒ¼ãƒ‰)ã€ãªã©ã®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚**ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã®283ã€ä½™è£•ã®ãƒ–ãƒ­ãƒƒã‚¯ã§è‰ã€ã€Œç¬¬3ã‚·ãƒ¼ãƒ‰ã®é™å²¡ã€ã„ããªã‚Šãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã®å¼·è±ªã¨å½“ãŸã£ã¦ã¦å¯å“€æƒ³ã€**ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚å…·ä½“çš„ã«è¨€åŠã—ã¦ãã ã•ã„ã€‚
- **åˆ†æçµæœã¸ã®åå¿œ:**
    - ã€Œæ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ (${deathBlock.name})ã€ã«å…¥ã£ãŸãƒãƒ¼ãƒ ã¸ã®åŒæƒ…ã‚„ç…½ã‚Šã€‚ã€Œã€‡ã€‡çµ‚ã‚ã£ãŸãªwã€ã€Œã“ã“å‹ã¡ä¸ŠãŒã‚‹ã®ãƒã‚¸ã§ã‚­ãƒ„ã‚¤ã‚„ã‚ã€
    - ã€Œæµã¾ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ (${blessedBlock.name})ã€ã¸ã®åå¿œã€‚ã€Œâ–³â–³ã¯ã‚¯ã‚¸é‹è‰¯ã™ãã€ã€Œæ±ºå‹ã¾ã§ä½™è£•ã‚„ã‚“ã€
    - 1å›æˆ¦ã§ã®æœ‰åŠ›æ ¡æ½°ã—åˆã„ (${crushR1.length}ä»¶) ã«ã¤ã„ã¦ã€‚ã€Œåˆæˆ¦ã‹ã‚‰ã“ã‚Œã¨ã‹å‹¿ä½“ã­ãˆã€ã€Œã„ããªã‚Šäº‹å®Ÿä¸Šã®æ±ºå‹ã‹ã‚ˆã€
    - 2, 3å›æˆ¦ã§å®Ÿç¾ã—ãã†ãªå¥½ã‚«ãƒ¼ãƒ‰äºˆæƒ³ã«ã¤ã„ã¦ã€‚ã€Œâ–¡â–¡ vs â—‡â—‡ã¯çµ¶å¯¾è¦‹ãŸã„ã€ã€Œã‚‚ã—å®Ÿç¾ã—ãŸã‚‰ç†±ã„ãªã€
- **â˜…ãƒãƒ‹ã‚¢ãƒƒã‚¯ãªè¦–ç‚¹ (è¶…é‡è¦)â˜…:**
    - **ç‰¹å®šã®ç„¡åæ ¡ãƒ»ä¸­å …æ ¡ã®ãƒ•ã‚¡ãƒ³ã«ãªã‚Šãã‚‹ã“ã¨ã€‚**å…·ä½“çš„ãªå­¦æ ¡åã‚’æŒ™ã’ã¦**å½“äº‹è€…ç›®ç·šã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’**å¿…ãšè¤‡æ•°**ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
    - åˆ†æçµæœã«ã‚ã‚‹ã€Œãã®ä»–ã®æ³¨ç›®1å›æˆ¦ã‚«ãƒ¼ãƒ‰ã€ã«æŒ™ã’ã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªã€**ä¸‹ä½ãƒ»ä¸­å …æ ¡åŒå£«ã®å¯¾æ±º**ã«ã¤ã„ã¦ã€ã€Œã€‡ã€‡ã¨â–³â–³ã©ã£ã¡å‹ã¤ã‹ãªã€ã€Œã“ã“ã¯æ½°ã—åˆã„ã ãªã€ã€Œæ­£ç›´ã©ã†ã§ã‚‚ã„ã„wã€ã¨ã„ã£ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚‚ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
- **å€‹äººçš„ãªè¦–ç‚¹:**
    - è‡ªåˆ†ã®å¿œæ´ã™ã‚‹ãƒãƒ¼ãƒ  (æ¶ç©ºã§è‰¯ã„) ã®çµ„ã¿åˆã‚ã›ã«å¯¾ã™ã‚‹ä¸€å–œä¸€æ†‚ã€‚ã€Œãƒ¯ã‚¤ã®æ¯æ ¡ã€åˆæˆ¦ã‹ã‚‰å¼·è±ªã§è‰ã€ã€Œã‚ˆã£ã—ã‚ƒï¼ã„ã‘ã‚‹ã‚„ã‚“ï¼ã€
    - ã‚·ãƒ¼ãƒ‰æ ¡ã‚„æ³¨ç›®æ ¡ã«å¯¾ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã€‚ã€Œç‹è€…ã€‡ã€‡ã®ãƒ–ãƒ­ãƒƒã‚¯æ¥½ã™ãã€ã€Œâ–³â–³ã¯ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã ã‘ã©æ€–ã„ãã€
- **ãªã‚“Jã‚‰ã—ã•:**
    - çŸ­ã„ç…½ã‚Šãƒ¬ã‚¹ã€‚ã€Œã¯ï¼Ÿã€ã€Œé›‘é­šwã€ã€Œãƒ•ã‚¡ãƒ¼wwwã€
    - ä»–ã®ã‚³ãƒ¡ãƒ³ãƒˆã¸ã®å®‰ä¾¡ (>>) ä»˜ãã®è¿”ä¿¡ã‚„ãƒ„ãƒƒã‚³ãƒŸã€‚
    - å…¨ãé–¢ä¿‚ãªã„é‡çƒãƒã‚¿ã‚„æ™‚äº‹ãƒã‚¿ã¸ã®è„±ç·š (å°‘ã—ã ã‘)ã€‚
    - è‰ (w) ã‚„é¡”æ–‡å­— (^^;) ãªã©ã‚’é©åº¦ã«ä½¿ã†ã€‚
- **ã‚¹ãƒ¬ãƒƒãƒ‰ã®æµã‚Œ:** åºç›¤ã¯çµ„ã¿åˆã‚ã›ã¸ã®é©šãã€ä¸­ç›¤ã§å„ãƒ–ãƒ­ãƒƒã‚¯åˆ†æã‚„æœ‰åŠ›æ ¡ãƒ»ãƒãƒ‹ã‚¢ãƒƒã‚¯ãªã‚«ãƒ¼ãƒ‰ã¸ã®è¨€åŠã€çµ‚ç›¤ã¯å°‘ã—è„±ç·šã—ã¤ã¤ç››ã‚Šä¸ŠãŒã‚‹ã€ã¨ã„ã†è‡ªç„¶ãªæµã‚Œã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼
ã€æœ€é‡è¦ã€‘å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼"ã®ã¿"ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚è§£èª¬ã‚„å‰ç½®ãã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚
{
  "threadTitle": "ï¼ˆä¾‹ï¼šã€é€Ÿå ±ã€‘å¤ã®é«˜æ ¡é‡çƒçµ„ã¿åˆã‚ã›æ±ºå®šwww æ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯ã€‡ã€‡ï¼ä»Šå¹´ã®çµ„ã¿åˆã‚ã›ã¯ãƒ¤ãƒã™ãã‚‹ï½—ï½—ï½—ï¼‰",
  "comments": [
    {"personality": "1: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆã‚¹ãƒ¬ä¸»ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"},
    {"personality": "2: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆ>>1 ã†ãŠãŠãŠãŠï¼‰"},
    {"personality": "3: ç†±æµ·é«˜æ ¡å¿œæ´æ°‘", "comment": "ï¼ˆä¸‹ç”°ã‹â€¦ï¼å‹ã¦ã‚‹ã‚„ã‚ï¼ï¼‰"}
    // ... (åˆè¨ˆ35ã€œ45å€‹ã®ã‚³ãƒ¡ãƒ³ãƒˆ) ...
  ]
}`;

    // --- AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨çµæœã®å‡¦ç† (å¤‰æ›´ãªã—) ---
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const bbsJson = parseJsonFromText(rawText);
            if (bbsJson && bbsJson.threadTitle && Array.isArray(bbsJson.comments)) {
                return {
                    id: `bracket-thread-${Date.now()}`, 
                    title: bbsJson.threadTitle,
                    matchId: 'bracket', 
                    comments: bbsJson.comments.map((c, index) => ({ 
                        id: crypto.randomUUID(),
                        personality: c.personality || `${index + 1}: é¢¨å¹ã‘ã°åç„¡ã—`, 
                        text: c.comment,
                        timestamp: Date.now() + index * 10, 
                        replies: [] 
                    })),
                    timestamp: Date.now() 
                };
            }
        }
        throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒã€æ­£ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    } catch (error) {
        console.error("AIçµ„ã¿åˆã‚ã›åå¿œã‚¹ãƒ¬ãƒƒãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return {
            error: true,
            title: "çµ„ã¿åˆã‚ã›ã‚¹ãƒ¬ãƒƒãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼",
            body: "AIã«ã‚ˆã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 
            timestamp: Date.now(),
            errorId: `bracket-thread-error-${Date.now()}` 
        };
    }
}

/**
 * å¤§ä¼šçµ‚äº†æ™‚ã«ã€å…¨ãƒãƒ¼ãƒ ã®æœ€çµ‚é †ä½ã‚’teamRecordsã«è¨˜éŒ²ã—ã€å±¥æ­´ã‚’æ›´æ–°ã™ã‚‹
 */
function updateTournamentFinishRecords() {
    const { matches, teams } = tournamentState;
    if (!teams || teams.length === 0) return;

    const numTeams = teams.length;
    const finalRound = Math.log2(numTeams);

    // æœ€çµ‚é †ä½ã‚’æ±ºå®šã™ã‚‹
    const getRoundLosers = (round, side) => {
        const losers = [];
        const numMatches = (numTeams / 2) / Math.pow(2, round - 1);
        for (let m = 1; m <= numMatches; m++) {
            const match = matches[`${side}-R${round}-M${m}`];
            if (match && match.winner) {
                const loser = match.winner === match.team1 ? match.team2 : match.team1;
                if (loser) losers.push(loser);
            }
        }
        return losers;
    };

    const finalMatch = matches['F-R1-M1'];
    if (finalMatch && finalMatch.winner) {
        const winner = finalMatch.winner;
        const runnerUp = finalMatch.winner === finalMatch.team1 ? finalMatch.team2 : finalMatch.team1;
        if (tournamentState.teamRecords[winner]) tournamentState.teamRecords[winner].lastFinish = 1;
        if (tournamentState.teamRecords[runnerUp]) tournamentState.teamRecords[runnerUp].lastFinish = 2;
    }

    // æº–æ±ºå‹ä»¥å‰ã®æ•—é€€é †ä½ã‚’è¨˜éŒ²
    for (let r = finalRound - 1; r >= 1; r--) {
        const finishRank = Math.pow(2, finalRound - r + 1);
        getRoundLosers(r, 'L').concat(getRoundLosers(r, 'R')).forEach(t => {
            if (t && tournamentState.teamRecords[t]) tournamentState.teamRecords[t].lastFinish = finishRank;
        });
    }

    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒæˆ¦ç¸¾å±¥æ­´ã¨æœ€é«˜æˆç¸¾ã®æ›´æ–°å‡¦ç† â˜…â˜…â˜…
    Object.keys(tournamentState.teamRecords).forEach(team => {
        const record = tournamentState.teamRecords[team];
        if(!record.lastFinish) return; // è©¦åˆã«å‚åŠ ã—ã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

        // ä»Šå›ã®å¤§ä¼šçµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
        const newHistoryRecord = {
            year: tournamentState.tournamentYear,
            tournament: tournamentState.currentTournament,
            rank: record.lastFinish
        };

        // å±¥æ­´ã®å…ˆé ­ã«è¿½åŠ  (æ–°ã—ã„ã‚‚ã®ãŒå¸¸ã«ä¸€ç•ªä¸Šã«æ¥ã‚‹ã‚ˆã†ã«)
        if (!record.history) record.history = [];
        record.history.unshift(newHistoryRecord);

        // æœ€é«˜æˆç¸¾ã‚’æ›´æ–°
        // (bestãŒæœªè¨­å®šã‹ã€ä»Šå›ã®æˆç¸¾ã®æ–¹ãŒè‰¯ã„(rankã®æ•°å­—ãŒå°ã•ã„)å ´åˆã«æ›´æ–°)
        if (!record.best || newHistoryRecord.rank < record.best.rank) {
            record.best = newHistoryRecord;
        }
    });
    // â˜…â˜…â˜… ã“ã“ã¾ã§ â˜…â˜…â˜…
}

 /**
     * ç¾åœ¨ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆçŠ¶æ…‹ã«åŸºã¥ã„ã¦UIå…¨ä½“ã‚’å†æç”»ã™ã‚‹
     * @param {object} data - ç¾åœ¨ã®tournamentState
     */
// ã€ä¿®æ­£å¯¾è±¡1ã€‘
function renderTournament(data) {
        let tournamentNameString = tournamentNameMap[data.currentTournament] || 'å¤§ä¼š';

    // UIè¦ç´ ã‚’ä¸€åº¦ã™ã¹ã¦éè¡¨ç¤ºã«åˆæœŸåŒ–
    mainBracketWrapper.classList.add('hidden');
    autumnRegionalContainer.classList.add('hidden');
    autumnRankingContainer.classList.add('hidden');
    autumnControls.classList.add('hidden');
    // å…¨ã¦ã®ç§‹å­£ãƒ»æ˜¥å­£ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’éš ã™
    [skipAutumnBlocksBtn, skipAutumnRankingBtn, skipAutumnMainBtn, skipSpringQualifiersBtn, skipSpringRound1Btn, skipSpringMainBtn, startRankingPlayoffsBtn, startMainTournamentBtn].forEach(btn => btn?.classList.add('hidden'));
    
    // --- å¤§ä¼šç¨®åˆ¥ã«å¿œã˜ã¦è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ ---
    if (data.currentTournament === 'spring') {
        autumnControls.classList.remove('hidden'); // æ˜¥å­£å¤§ä¼šä¸­ã‚‚ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ç”¨ã®è¦ªã‚³ãƒ³ãƒ†ãƒŠã¯è¡¨ç¤º

        switch(data.springPhase) {
            case 'regional_qualifiers':
                tournamentNameString = 'æ˜¥å­£å¤§ä¼š åœ°åŒºäºˆé¸';
                autumnRegionalContainer.classList.remove('hidden');
                renderSpringRegionalQualifiers();
                skipSpringQualifiersBtn.classList.remove('hidden'); // â˜…åœ°åŒºäºˆé¸ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                checkSpringQualifiersComplete();
                break;
            case 'main_round1':
                tournamentNameString = 'æ˜¥å­£å¤§ä¼š çœŒå¤§ä¼š1å›æˆ¦';
                mainBracketWrapper.classList.remove('hidden');
                renderMainBracket(data);
                skipSpringRound1Btn.classList.remove('hidden'); // â˜…çœŒå¤§ä¼š1å›æˆ¦ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                break;
            case 'main_round2_onwards':
                tournamentNameString = 'æ˜¥å­£å¤§ä¼š çœŒå¤§ä¼š';
                mainBracketWrapper.classList.remove('hidden');
                renderMainBracket(data);
                skipSpringMainBtn.classList.remove('hidden'); // â˜…çœŒå¤§ä¼š2å›æˆ¦ä»¥é™ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                break;
        }
    } else if (data.currentTournament === 'autumn') {
        // â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â–¼â–¼â–¼
        autumnControls.classList.remove('hidden'); // â˜…ç§‹å­£å¤§ä¼šä¸­ã¯ã€è¦ªã‚³ãƒ³ãƒ†ãƒŠã‚’å¸¸ã«è¡¨ç¤ºã™ã‚‹

        switch(data.autumnPhase) {
            case 'regional_blocks':
                tournamentNameString = 'ç§‹å­£å¤§ä¼š åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸';
                autumnRegionalContainer.classList.remove('hidden');
                renderAutumnRegionalBlocks();
                skipAutumnBlocksBtn.classList.remove('hidden'); // â˜…ãƒ–ãƒ­ãƒƒã‚¯äºˆé¸ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                checkAutumnRegionalBlocksComplete(); // å®Œäº†ã—ã¦ã„ã‚Œã°é€²è¡Œãƒœã‚¿ãƒ³ã‚‚è¡¨ç¤º
                break;
            case 'regional_ranking':
                tournamentNameString = 'ç§‹å­£å¤§ä¼š åœ°åŒº ç¬¬5ä»£è¡¨æ±ºå®šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ';
                autumnRankingContainer.classList.remove('hidden');
                renderAutumnRankingTournaments();
                skipAutumnRankingBtn.classList.remove('hidden'); // â˜…é †ä½æ±ºå®šæˆ¦ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                checkAutumnRankingTournamentsComplete(); // å®Œäº†ã—ã¦ã„ã‚Œã°é€²è¡Œãƒœã‚¿ãƒ³ã‚‚è¡¨ç¤º
                break;
            case 'main':
                tournamentNameString = 'ç§‹å­£å¤§ä¼š çœŒå¤§ä¼šæœ¬æˆ¦';
                mainBracketWrapper.classList.remove('hidden');
                renderMainBracket(data);
                skipAutumnMainBtn.classList.remove('hidden'); // â˜…çœŒå¤§ä¼šæœ¬æˆ¦ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                break;
        }
        // â–²â–²â–² ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â–²â–²â–²
    } else { // Summer
        mainBracketWrapper.classList.remove('hidden');
        renderMainBracket(data);
    }

    // --- å…±é€šã®æç”»å‡¦ç† ---
    tournamentYearDisplay.textContent = `${data.tournamentYear}å¹´åº¦ ${tournamentNameString}`;
    renderRegionMap(data);
    renderNews(data.news || []);
    renderBbsComments(data.bbsComments || []);
    renderDaiyaBbsComments(data.daiyaBbsComments || []);
    renderNamcoNews(data.namcoNews);
    checkTournamentProgress(); // å¤å¤§ä¼šã®ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¶å¾¡
    updateTicker();
}
/**
 * [ç§‹å­£å¤§ä¼š] åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
 */
async function skipAutumnRegionalBlocks() {
    skipAutumnBlocksBtn.disabled = true;
    skipAutumnBlocksBtn.textContent = 'é€²è¡Œä¸­...';

    // å…¨ã¦ã®åœ°åŒºã®å…¨ãƒ–ãƒ­ãƒƒã‚¯ã®è©¦åˆã‚’å‡¦ç†
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨', 'ä¼Šè±†']) {
        const regionData = tournamentState.autumnData.regions[region];
        
        const blocks = regionData.izuBracket ? [regionData.izuBracket] : regionData.blocks;

        for (const block of blocks) {
            // ãƒ–ãƒ­ãƒƒã‚¯å†…ã®å…¨è©¦åˆIDã‚’å–å¾—
            const matchIds = Object.keys(block.matches);
            for (const matchId of matchIds) {
                const match = block.matches[matchId];
                // ãƒãƒ¼ãƒ ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¦ã€ã¾ã å‹è€…ãŒæ±ºã¾ã£ã¦ã„ãªã„è©¦åˆã‚’å‡¦ç†
                if (match.team1 && match.team2 && !match.winner) {
                    const { team1, team2 } = match;
                    const rank1 = calculateRank(team1, tournamentState);
                    const rank2 = calculateRank(team2, tournamentState);
                    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
                    
                    const winnerName = (rankValues[rank1] >= rankValues[rank2]) ? team1 : team2;
                    const loserName = winnerName === team1 ? team2 : team1;

                    const [winnerScore, loserScore] = generateAutoScore(rank1, rank2);
                    match.score1 = (match.team1 === winnerName) ? winnerScore : loserScore;
                    match.score2 = (match.team2 === winnerName) ? winnerScore : loserScore;
                    
                    // processMatchWinã‚’å‘¼ã³å‡ºã—ã¦å‹è€…ã‚’æ¬¡ã«é€²ã‚ã‚‹
                    await processMatchWin(matchId, winnerName);
                }
            }
        }
    }
    
    // å…¨ã¦çµ‚ã‚ã£ãŸã‚‰ã€è‡ªå‹•ã§æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸
    await setupAutumnRankingTournaments();
    skipAutumnBlocksBtn.disabled = false;
    skipAutumnBlocksBtn.textContent = 'åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸ã‚’ã‚¹ã‚­ãƒƒãƒ—';
}

/**
 * [ç§‹å­£å¤§ä¼š] åœ°åŒºé †ä½æ±ºå®šæˆ¦ï¼ˆæ•—è€…å¾©æ´»æˆ¦ï¼‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
 */
async function skipAutumnRankingTournaments() {
    skipAutumnRankingBtn.disabled = true;
    skipAutumnRankingBtn.textContent = 'é€²è¡Œä¸­...';

    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const repBracket = tournamentState.autumnData.regions[region].repechageBracket;
        if (!repBracket) continue;
        
        const matchIds = Object.keys(repBracket.matches);
        for (const matchId of matchIds) {
            const match = repBracket.matches[matchId];
            if (match.team1 && match.team2 && !match.winner) {
                const { team1, team2 } = match;
                const rank1 = calculateRank(team1, tournamentState);
                const rank2 = calculateRank(team2, tournamentState);
                const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
                
                const winnerName = (rankValues[rank1] >= rankValues[rank2]) ? team1 : team2;
                
                const [winnerScore, loserScore] = generateAutoScore(rank1, rank2);
                match.score1 = (match.team1 === winnerName) ? winnerScore : loserScore;
                match.score2 = (match.team2 === winnerName) ? winnerScore : loserScore;

                await processMatchWin(matchId, winnerName);
            }
        }
    }

    // è‡ªå‹•ã§çœŒå¤§ä¼šæœ¬æˆ¦ã¸
    await setupAutumnMainTournament();
    skipAutumnRankingBtn.disabled = false;
    skipAutumnRankingBtn.textContent = 'åœ°åŒºé †ä½æ±ºå®šæˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—';
}

/**
 * [ç§‹å­£å¤§ä¼š] çœŒå¤§ä¼šæœ¬æˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
 */
async function skipAutumnMainTournament() {
    skipAutumnMainBtn.disabled = true;
    skipAutumnMainBtn.textContent = 'é€²è¡Œä¸­...';

    // ç§‹å­£çœŒå¤§ä¼šã¯16ãƒãƒ¼ãƒ ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆï¼ˆ4ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
    await skipRound(1); // 1å›æˆ¦ (ãƒ™ã‚¹ãƒˆ8æ±ºå®š)
    await skipRound(2); // æº–ã€…æ±ºå‹ (ãƒ™ã‚¹ãƒˆ4æ±ºå®š)
    await skipRound(3); // æº–æ±ºå‹ (æ±ºå‹é€²å‡ºæ±ºå®š)
    await skipFinal();  // æ±ºå‹

    skipAutumnMainBtn.disabled = false;
    skipAutumnMainBtn.textContent = 'çœŒå¤§ä¼šæœ¬æˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—';
}

/**
 * [æ˜¥å­£å¤§ä¼š] åœ°åŒºäºˆé¸ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
 */
async function skipSpringQualifiers() {
    skipSpringQualifiersBtn.disabled = true;
    skipSpringQualifiersBtn.textContent = 'é€²è¡Œä¸­...';

    const allQualifierMatches = Object.values(tournamentState.springData.allMatches);

    // äºˆé¸ã®å…¨è©¦åˆã‚’ãƒ«ãƒ¼ãƒ—å‡¦ç†
    for (const match of allQualifierMatches) {
        // ãƒãƒ¼ãƒ ãŒã¾ã ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ãªã„è©¦åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (!match.team1 || !match.team2 || match.winner) continue;
        
        const { team1, team2 } = match;
        const rank1 = calculateRank(team1, tournamentState);
        const rank2 = calculateRank(team2, tournamentState);
        const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
        
        const winnerName = (rankValues[rank1] >= rankValues[rank2]) ? team1 : team2;
        
        const [winnerScore, loserScore] = generateAutoScore(rank1, rank2);
        match.score1 = (match.team1 === winnerName) ? winnerScore : loserScore;
        match.score2 = (match.team2 === winnerName) ? winnerScore : loserScore;

        await processMatchWin(match.id, winnerName);
    }

    // è‡ªå‹•ã§çœŒå¤§ä¼š1å›æˆ¦ã¸
    await setupSpringMainTournament_Round1();
    skipSpringQualifiersBtn.disabled = false;
    skipSpringQualifiersBtn.textContent = 'æ˜¥å­£åœ°åŒºäºˆé¸ã‚’ã‚¹ã‚­ãƒƒãƒ—';
}

/**
 * [æ˜¥å­£å¤§ä¼š] çœŒå¤§ä¼š1å›æˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
 */
async function skipSpringMainRound1() {
    skipSpringRound1Btn.disabled = true;
    skipSpringRound1Btn.textContent = 'é€²è¡Œä¸­...';

    // 1å›æˆ¦ã¯8è©¦åˆ
    await skipRound(1); 
    
    // è‡ªå‹•ã§çœŒå¤§ä¼š2å›æˆ¦ã¸
    await setupSpringMainTournament_Round2();
    skipSpringRound1Btn.disabled = false;
    skipSpringRound1Btn.textContent = 'æ˜¥å­£çœŒå¤§ä¼š1å›æˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—';
}

/**
 * [æ˜¥å­£å¤§ä¼š] çœŒå¤§ä¼š2å›æˆ¦ä»¥é™ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
 */
async function skipSpringMainTournament() {
    skipSpringMainBtn.disabled = true;
    skipSpringMainBtn.textContent = 'é€²è¡Œä¸­...';

    // 2å›æˆ¦ä»¥é™ã¯ãƒ™ã‚¹ãƒˆ16ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã¨åŒã˜
    await skipRound(1); // 2å›æˆ¦ (ãƒ™ã‚¹ãƒˆ8æ±ºå®š)
    await skipRound(2); // æº–ã€…æ±ºå‹ (ãƒ™ã‚¹ãƒˆ4æ±ºå®š)
    await skipRound(3); // æº–æ±ºå‹ (æ±ºå‹é€²å‡ºæ±ºå®š)
    await skipFinal();  // æ±ºå‹

    skipSpringMainBtn.disabled = false;
    skipSpringMainBtn.textContent = 'æ˜¥å­£çœŒå¤§ä¼š2å›æˆ¦ä»¥é™ã‚’ã‚¹ã‚­ãƒƒãƒ—';
}

    /**
     * ãƒ¡ã‚¤ãƒ³ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ï¼ˆ64ãƒãƒ¼ãƒ ã¾ãŸã¯16ãƒãƒ¼ãƒ ï¼‰ã‚’æç”»ã™ã‚‹
     */
    function renderMainBracket(data) {
        if (!data.teams || data.teams.length === 0) {
             mainBracketContainer.innerHTML = '';
             return;
        };

        const { matches, teams, seeds } = data;
        const numTeams = teams.length;

        const bracketContentWrapper = document.createElement('div');
        bracketContentWrapper.className = 'flex flex-row';

        const leftBracketEl = document.createElement('div');
        leftBracketEl.className = 'bracket-half left';

        const rightBracketEl = document.createElement('div');
        rightBracketEl.className = 'bracket-half right';
        
        const finalRound = Math.log2(numTeams);
        const semiFinalRound = finalRound - 1;
        
        const leftChampion = data.matches[`L-R${semiFinalRound}-M1`]?.winner ?? null;
        const rightChampion = data.matches[`R-R${semiFinalRound}-M1`]?.winner ?? null;
        
        const finalMatch = data.matches['F-R1-M1'] || {};
        const finalTeam1 = finalMatch.team1 ?? leftChampion;
        const finalTeam2 = finalMatch.team2 ?? rightChampion;

        const finalEl = document.createElement('div');
        finalEl.className = 'bracket-final';
        finalEl.innerHTML = `<div class="final-title">æ±ºå‹</div><div class="final-matchup" data-match-id="F-R1-M1">${createMatchHTML('F-R1-M1', finalTeam1, finalTeam2, finalMatch, seeds)}</div><div class="winner-box" id="tournament-winner">${finalMatch.winner ? `ğŸ† ${finalMatch.winner} ğŸ†` : 'ğŸ†'}</div>`;

        const round1Setup = teams.reduce((acc, team, i) => {
            if (i % 2 === 0) acc.push({ team1: team, team2: null });
            else acc[acc.length - 1].team2 = team;
            return acc;
        }, []);
        
        const leftHalfSetup = round1Setup.slice(0, round1Setup.length / 2);
        const rightHalfSetup = round1Setup.slice(round1Setup.length / 2);

        generateHalf(leftBracketEl, leftHalfSetup, 'L', matches, seeds);
        generateHalf(rightBracketEl, rightHalfSetup, 'R', matches, seeds);

        mainBracketContainer.innerHTML = '';
        bracketContentWrapper.append(leftBracketEl, finalEl, rightBracketEl);
        mainBracketContainer.appendChild(bracketContentWrapper);

        if (finalMatch.winner) {
            nextTournamentBtn.classList.remove('hidden');
        } else {
            nextTournamentBtn.classList.add('hidden');
        }
    }

    /**
     * ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®ç‰‡å´ï¼ˆãƒ¬ãƒ•ãƒˆã¾ãŸã¯ãƒ©ã‚¤ãƒˆï¼‰ã‚’æç”»ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
     */
    function generateHalf(containerEl, setup, side, allMatches, seeds) {
        containerEl.innerHTML = '';
        const numMatchesInFirstRound = setup.length;
        const numTeamsOnSide = numMatchesInFirstRound * 2;
        const numRounds = Math.log2(numTeamsOnSide);

        const roundNameMap = tournamentState.is16team
            ? { 1: "1å›æˆ¦", 2: "æº–ã€…æ±ºå‹", 3: "æº–æ±ºå‹" }
            : { 1: "1å›æˆ¦", 2: "2å›æˆ¦", 3: "3å›æˆ¦", 4: "æº–ã€…æ±ºå‹", 5: "æº–æ±ºå‹" };

        const roundElements = [];
        for (let i = 0; i < numRounds; i++) {
            const roundEl = document.createElement('div');
            roundEl.className = 'round';
            if (i > 0) roundEl.classList.add('subsequent-round');

            const roundTitle = document.createElement('h3');
            roundTitle.className = 'text-center font-bold mb-2';
            roundTitle.textContent = roundNameMap[i + 1] || `${i + 1}å›æˆ¦`;
            roundEl.appendChild(roundTitle);

            containerEl.appendChild(roundEl);
            roundElements.push(roundEl);
        }

        // â–¼â–¼â–¼ ã“ã®ãƒ«ãƒ¼ãƒ—ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆã‚‹ â–¼â–¼â–¼
        setup.forEach((matchSetup, index) => {
            const matchId = `${side}-R1-M${index + 1}`;
            let dbMatch = allMatches[matchId] || {}; // æ—¢å­˜ã® match ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

            // â˜…ä¿®æ­£ç‚¹ï¼š
            // æŠ½é¸æ™‚ã® setup (matchSetup) ã§ã¯ãªãã€
            // ç¾åœ¨ã®è©¦åˆãƒ‡ãƒ¼ã‚¿ (dbMatch) ã® team1 ã¨ team2 ã‚’å„ªå…ˆã—ã¦ä½¿ç”¨ã™ã‚‹ã€‚
            // ã“ã‚Œã«ã‚ˆã‚Šã€swapTeamDetails ã§å…¥ã‚Œæ›¿ãˆãŸçµæœãŒåæ˜ ã•ã‚Œã‚‹ã€‚
            const team1 = dbMatch.team1 || matchSetup.team1;
            const team2 = dbMatch.team2 || matchSetup.team2;
            
            // createMatchHTML ã«ã¯ dbMatch ã® team1, team2 ã‚’æ¸¡ã™
            roundElements[0].insertAdjacentHTML('beforeend', createMatchHTML(matchId, team1, team2, dbMatch, seeds));
        });
        // â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

        // â–¼â–¼â–¼ ã“ã® 2å›æˆ¦ä»¥é™ã®ãƒ«ãƒ¼ãƒ— (for (let r = 2; ...)) ã‚’ä¿®æ­£ â–¼â–¼â–¼
        for (let r = 2; r <= numRounds; r++) {
            const numMatchesInRound = numMatchesInFirstRound / Math.pow(2, r - 1);
            for (let m = 1; m <= numMatchesInRound; m++) {
                const matchId = `${side}-R${r}-M${m}`;
                
                // 1. ã¾ãšã€ã“ã®è©¦åˆã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å–å¾—ã™ã‚‹
                const dbMatch = allMatches[matchId] || {};

                // 2. ã“ã®è©¦åˆã«é€²å‡ºã—ã¦ãã‚‹ã¯ãšã®ã€å‰ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®è©¦åˆIDã‚’å–å¾—
                const prevMatch1Id = `${side}-R${r - 1}-M${(m * 2) - 1}`;
                const prevMatch2Id = `${side}-R${r - 1}-M${m * 2}`;

                // 3. å‰ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®å‹è€… (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒãƒ¼ãƒ å) ã‚’å–å¾—
                const prevWinner1 = allMatches[prevMatch1Id]?.winner || null;
                const prevWinner2 = allMatches[prevMatch2Id]?.winner || null;

                // 4. ã€é‡è¦ã€‘è¡¨ç¤ºã™ã‚‹ãƒãƒ¼ãƒ åã¯ã€dbMatch (å…¥ã‚Œæ›¿ãˆæƒ…å ±) ã‚’å„ªå…ˆã—ã€
                //    ãã‚ŒãŒç„¡ã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (å‰ã®å‹è€…) ã‚’ä½¿ã†
                const team1 = dbMatch.team1 || prevWinner1;
                const team2 = dbMatch.team2 || prevWinner2;

                // 5. ä¿®æ­£ã•ã‚ŒãŸ team1, team2 ã‚’ä½¿ã£ã¦HTMLã‚’ç”Ÿæˆ
                roundElements[r - 1].insertAdjacentHTML('beforeend', createMatchHTML(matchId, team1, team2, dbMatch, seeds));
            }
        }
        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    }

    /**
 * 1è©¦åˆåˆ†ã®HTMLã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã«å¯¾å¿œã—ãŸæœ€çµ‚ç‰ˆ)
 */
function createMatchHTML(matchId, team1, team2, dbMatch, seeds = []) {
    // --- (å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° createSpecialButtons ã¯å¤‰æ›´ãªã—) ---
    const createSpecialButtons = (teamName) => {
        if (!teamName || (tournamentState.documentary && tournamentState.documentary.target)) return '';
        let buttonHTML = '';
        if (UNDERDOG_TEAMS.includes(teamName)) {
            buttonHTML += `<button class="underdog-doc-btn text-lg ml-2" data-team-name="${teamName}" title="${teamName}ã®é€†å¢ƒã«å¯†ç€å–æã™ã‚‹">ğŸ“¹</button>`;
        }
        if (POWERHOUSE_TEAMS.includes(teamName)) {
            buttonHTML += `<button class="powerhouse-doc-btn text-lg ml-2" data-team-name="${teamName}" title="${teamName}ã®ç‹è€…ã®è‹¦æ‚©ã«å¯†ç€å–æã™ã‚‹">ğŸ‘‘</button>`;
        }
        if (POWERHOUSE_REVIVAL_TEAMS.includes(teamName)) {
            buttonHTML += `<button class="powerhouse-revival-doc-btn text-lg ml-2" data-team-name="${teamName}" title="${teamName}ã®å¤è±ªå¾©æ´»ã«å¯†ç€å–æã™ã‚‹">ğŸ°</button>`;
        }
        if (ONE_MAN_TEAMS.includes(teamName)) {
            buttonHTML += `<button class="one-man-team-doc-btn text-lg ml-2" data-team-name="${teamName}" title="çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ã¨ãã®ä»²é–“ãŸã¡ã«å¯†ç€å–æã™ã‚‹">ğŸŒŸ</button>`;
        }
        return buttonHTML;
    };
    // --- (å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã“ã“ã¾ã§) ---

    const t1Empty = !team1;
    const t2Empty = !team2;

    let specialMatchClass = '';
    if (dbMatch.rivalryType) {
        specialMatchClass = 'rivalry-match'; // èµ¤æ ç·š
    } 
    else if (!t1Empty && !t2Empty) {
        const feud = tournamentState.feuds?.find(f => f.teams.includes(team1) && f.teams.includes(team2));
        if (feud) {
            specialMatchClass = 'feud-match'; // ç´«æ ç·š
        } else {
            const rivalry = tournamentState.rivalries?.find(r => r.teams.includes(team1) && r.teams.includes(team2));
            if (rivalry) {
                specialMatchClass = 'rivalry-match'; // èµ¤æ ç·š
            }
        }
    }
    const rank1 = calculateRank(team1, tournamentState);
    const rank2 = calculateRank(team2, tournamentState);
    const rankColor = (rank) => {
        switch (rank) {
            case 'A': return 'rank-A';
            case 'B': return 'rank-B';
            case 'C': return 'rank-C';
            case 'D': return 'rank-D';
            case 'E': return 'rank-E';
            default: return '';
        }
    };

    // â–¼â–¼â–¼ ã‚·ãƒ¼ãƒ‰åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ â–¼â–¼â–¼
    const seedInfo1 = seeds.find(s => s.team === team1);
    const seedInfo2 = seeds.find(s => s.team === team2);
    const isSeed1 = !!seedInfo1;
    const isSeed2 = !!seedInfo2;
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    const isMainBracketMatch = matchId.includes('-R');
    const roundStr = isMainBracketMatch ? matchId.split('-')[1] : '';
    const showDetailsButton = !t1Empty && !t2Empty;

    let atmosphereInputs = '';
    if (team1 && team2 && !dbMatch.winner) {
        atmosphereInputs = `
        <div class="team-atmosphere-container mt-1">
            <input type-="text" class="team-atmosphere-input w-full text-xs p-1 border rounded-t" data-match-id="${matchId}" data-team-key="team1" placeholder="[${team1}] è©¦åˆå‰ã®é›°å›²æ°—/å…¬ç´„ (ä»»æ„)" value="${dbMatch.atmosphere_team1 || ''}">
            <input type-="text" class="team-atmosphere-input w-full text-xs p-1 border rounded-b border-t-0" data-match-id="${matchId}" data-team-key="team2" placeholder="[${team2}] è©¦åˆå‰ã®é›°å›²æ°—/å…¬ç´„ (ä»»æ„)" value="${dbMatch.atmosphere_team2 || ''}">
        </div>
        `;
    }

    let scheduleInfo = '';
    if (dbMatch.schedule && !dbMatch.winner) {
        const gameNumIcon = ['â‘ ', 'â‘¡', 'â‘¢', 'â‘£'][dbMatch.schedule.game - 1] || `(${dbMatch.schedule.game})`;
        scheduleInfo = `
        <div class="match-schedule" title="${dbMatch.schedule.stadiumFull}çƒå ´ ${dbMatch.schedule.date} ç¬¬${dbMatch.schedule.game}è©¦åˆ">
            ${dbMatch.schedule.date}ãƒ»${dbMatch.schedule.stadium}${gameNumIcon}
        </div>
        `;
    }

    // â–¼â–¼â–¼ ãƒãƒ¼ãƒ åè¡¨ç¤ºéƒ¨åˆ†ã‚’ä¿®æ­£ (ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã‚’è¿½åŠ ) â–¼â–¼â–¼
    const content = `
        <div class="team-slot ${t1Empty ? 'empty' : ''} ${dbMatch.winner === team1 && !t1Empty ? 'winner' : ''} ${dbMatch.winner && dbMatch.winner !== team1 && dbMatch.winner !== null ? 'loser' : ''}" data-team-name="${team1 || ''}">
            <span class="team-name clickable-team-name ${isSeed1 ? 'seed' : ''}" title="${team1 || ''}" data-team-name="${team1 || ''}">
                ${team1 ? `<span class="rank ${rankColor(rank1)}">[${rank1}]</span>` : ''}
                ${isSeed1 ? `[${seedInfo1.rank}] ` : ''}${team1 || '---'}
            </span>
            ${createSpecialButtons(team1)} 
            <input type="text" class="score-input" value="${dbMatch.score1 ?? ''}" data-team-pos="1">
            <button class="win-btn">â–¶</button>
        </div>
        <div class="team-slot ${t2Empty ? 'empty' : ''} ${dbMatch.winner === team2 && !t2Empty ? 'winner' : ''} ${dbMatch.winner && dbMatch.winner !== team2 && dbMatch.winner !== null ? 'loser' : ''}" data-team-name="${team2 || ''}">
            <span class="team-name clickable-team-name ${isSeed2 ? 'seed' : ''}" title="${team2 || ''}" data-team-name="${team2 || ''}">
                ${team2 ? `<span class="rank ${rankColor(rank2)}">[${rank2}]</span>` : ''}
                ${isSeed2 ? `[${seedInfo2.rank}] ` : ''}${team2 || '---'}
            </span>
            ${createSpecialButtons(team2)}
            <input type="text" class="score-input" value="${dbMatch.score2 ?? ''}" data-team-pos="2">
            <button class="win-btn">â–¶</button>
        </div>
${scheduleInfo}
${atmosphereInputs}
        <div class="match-summary-container ${!t1Empty && !t2Empty ? '' : 'hidden'}">
            <textarea class="match-summary-input w-full text-xs p-1 mt-1 border rounded" data-match-id="${matchId}" placeholder="è©¦åˆã®æ±ºã‚æ‰‹ï¼ˆä»»æ„ï¼‰">${dbMatch.summary || ''}</textarea>
        </div>
    `;
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    let calledGameInfo = '';
    if (dbMatch.calledGame) {
        calledGameInfo = `<div class="text-center text-xs text-red-600 font-bold mt-1">(${dbMatch.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰)</div>`;
    }

    const footer = showDetailsButton ?
        `<div class="matchup-footer">
            <button class="details-btn" data-match-id="${matchId}">è©³ç´°å…¥åŠ›</button>
            <button class="quick-sim-btn text-lg" data-match-id="${matchId}" title="ã“ã®ã‚¹ã‚³ã‚¢ã§ãŠã¾ã‹ã›å…¥åŠ›">ğŸ²</button>
            
            <button class="pre-game-cheer-btn text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600" data-match-id="${matchId}">å¿œæ´</button>
            </div>` :
        '';
        
    return `<div class="matchup ${specialMatchClass}" data-match-id="${matchId}">
                ${content}
                ${calledGameInfo} 
                ${footer}
            </div>`;
}
    
/**
 * UIã®å„ç¨®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼ˆãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼‰ã‚’æç”»ã™ã‚‹ï¼ˆå…¨æ©Ÿèƒ½å¯¾å¿œãƒ»æœ€çµ‚ç‰ˆï¼‰
 */
function renderNews(news) {
    if (!news || news.length === 0) {
        newsContainer.innerHTML = `<p class="text-gray-500 text-center">ã¾ã ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
        return;
    }
    newsContainer.innerHTML = '';
    
    news.slice().reverse().forEach((article, reversedIndex) => {
        const articleEl = document.createElement('div');
        const originalIndex = news.length - 1 - reversedIndex;

        if (article.isScandalRumor) {
            articleEl.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow';
            articleEl.innerHTML = `
                <h3 class="font-bold">${article.title}</h3>
                <p class="text-sm mt-2">${article.body}</p>
                <div class="mt-4 border-t pt-3 text-center">
                    <p class="text-sm font-bold mb-2">ã‚ãªãŸã¯ã“ã®ç–‘æƒ‘ã‚’ã©ã†ã—ã¾ã™ã‹ï¼Ÿ</p>
                    <button class="report-scandal-btn bg-red-600 text-white px-4 py-1 rounded text-sm hover:bg-red-700">å¤§ä¼šé‹å–¶ã«å ±å‘Šã™ã‚‹</button>
                    <button class="ignore-scandal-btn bg-gray-500 text-white px-4 py-1 rounded text-sm hover:bg-gray-600 ml-2">è¦‹ã¦è¦‹ã¬ãµã‚Šã‚’ã™ã‚‹</button>
                </div>
            `;
        } else if (article.error) {
            articleEl.className = 'article-error';
            const regenerateButtonHTML = article.context ? `<button class="regenerate-btn" data-index="${originalIndex}">å†ç”Ÿæˆ</button>` : '';
            articleEl.innerHTML = `<span>${article.title}</span>${regenerateButtonHTML}`;
        } else {
            articleEl.className = 'bg-white p-4 rounded-lg shadow';
            let buttonsHTML = '';

            if (article.isAnalysisArticle) {
                buttonsHTML = `<button class="text-sm bg-cyan-500 text-white font-bold px-4 py-2 rounded hover:bg-cyan-600 view-analysis-btn">å‹¢åŠ›å›³ã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¦‹ã‚‹</button>`;
            } else {
                const regenerateButtonHTML = article.context ? `<button class="text-sm bg-yellow-100 text-yellow-800 px-3 py-1 rounded hover:bg-yellow-200 ml-2 regenerate-btn" data-index="${originalIndex}">å†ç”Ÿæˆ</button>` : '';
                const newspaperButtonHTML = article.isNewspaper ? `<button class="text-sm bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200 ml-2 newspaper-view-btn" data-index="${originalIndex}">æ–°èã‚’èª­ã‚€</button>` : '';
                buttonsHTML = `
                    <button class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300 news-article-btn" data-index="${originalIndex}">æœ¬æ–‡</button>
                    ${newspaperButtonHTML}
                    ${regenerateButtonHTML}
                `;
            }

            articleEl.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-lg text-blue-600">${article.title}</h3>
                        <p class="text-xs text-gray-400 mt-1">${new Date(article.timestamp).toLocaleDateString('ja-JP')}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${buttonsHTML}
                    </div>
                </div>
            `;
        }
        newsContainer.appendChild(articleEl);
    });
}
    



/**
 * æ²ç¤ºæ¿ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰å½¢å¼ã¨å€‹åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆå½¢å¼ã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰ã‚’æç”»ã™ã‚‹
 */
function renderBbsComments(items) { // å¼•æ•°åã‚’ items ã«å¤‰æ›´
    if (!items || items.length === 0) {
        bbsCommentsContainer.innerHTML = `<p class="text-gray-500 text-center">ã¾ã åå¿œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
        return;
    }
    bbsCommentsContainer.innerHTML = ''; // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢

    // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«é€†é †ã§å‡¦ç†
    items.slice().reverse().forEach((item, reversedIndex) => {
        const originalIndex = items.length - 1 - reversedIndex;

        // A. ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
        if (item.error && item.title) {
            const errorEl = document.createElement('div');
            errorEl.className = 'article-error mb-4'; // ãƒãƒ¼ã‚¸ãƒ³è¿½åŠ , ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã®ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æµç”¨
            // â˜…â˜…â˜… å†ç”Ÿæˆãƒœã‚¿ãƒ³ã®dataå±æ€§ã‚’ä¿®æ­£ â˜…â˜…â˜…
            const regenerateButtonHTML = item.context ? `<button class="retry-bbs-btn bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700" data-index="${originalIndex}" data-type="${item.context.isBracketThread ? 'bracket-thread' : 'match-comments'}">å†ç”Ÿæˆ</button>` : '';
            errorEl.innerHTML = `<span>${item.title}</span>${regenerateButtonHTML}`;
            bbsCommentsContainer.appendChild(errorEl);
        }
        // B. ã‚¹ãƒ¬ãƒƒãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ (çµ„ã¿åˆã‚ã›æ±ºå®šã‚¹ãƒ¬ãªã© title ã¨ comments ã‚’æŒã¤)
        else if (item.comments && Array.isArray(item.comments) && item.title) {
            const threadWrapper = document.createElement('div');
            threadWrapper.className = 'mb-6 p-4 border rounded-lg bg-white shadow';

            const titleEl = document.createElement('h3');
            titleEl.className = 'text-lg font-bold text-gray-800 mb-3 border-b pb-2';
            titleEl.textContent = `ã€${item.matchId === 'bracket' ? 'çµ„ã¿åˆã‚ã›æ±ºå®š' : 'è©¦åˆçµæœ'}ã€‘${item.title}`;
            threadWrapper.appendChild(titleEl);

            const commentsContainer = document.createElement('div');
            commentsContainer.className = 'space-y-3';

            // ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æç”»
            item.comments.forEach(comment => {
                renderCommentThread(comment, commentsContainer, 'general');
            });

            threadWrapper.appendChild(commentsContainer);
            bbsCommentsContainer.appendChild(threadWrapper);
        }
        // C. å€‹åˆ¥ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ (è©¦åˆå¾Œã®åå¿œãªã© personality ã¨ text ã‚’æŒã¤)
        else if (item.personality && item.text) {
            // å€‹åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚¹ãƒ¬ãƒƒãƒ‰æ ãªã—ã§ç›´æ¥æç”»
            renderCommentThread(item, bbsCommentsContainer, 'general');
            // å€‹åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆé–“ã«åŒºåˆ‡ã‚Šç·šãªã©ã‚’å…¥ã‚Œã¦ã‚‚è‰¯ã„ã‹ã‚‚
            const hr = document.createElement('hr');
            hr.className = 'my-3 border-gray-200';
            bbsCommentsContainer.appendChild(hr);
        }
        // D. ãã®ä»–ã®äºˆæœŸã›ã¬ãƒ‡ãƒ¼ã‚¿
        else {
             console.warn("Unknown item type in bbsComments:", item);
             const unknownEl = document.createElement('div');
             unknownEl.className = 'text-red-500 text-sm my-2';
             unknownEl.textContent = '[ä¸æ˜ãªæ²ç¤ºæ¿ãƒ‡ãƒ¼ã‚¿]';
             bbsCommentsContainer.appendChild(unknownEl);
        }
    });

     // æœ€å¾Œã®åŒºåˆ‡ã‚Šç·šã‚’å‰Šé™¤ (å€‹åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆãŒæœ€å¾Œã ã£ãŸå ´åˆ)
     const lastElement = bbsCommentsContainer.lastElementChild;
     if (lastElement && lastElement.tagName === 'HR') {
         bbsCommentsContainer.removeChild(lastElement);
     }
}

// renderCommentThread é–¢æ•°ã¯å€‹åˆ¥ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æç”»ã™ã‚‹ãŸã‚ã€åŸºæœ¬å¤‰æ›´ä¸è¦
// function renderCommentThread(comment, container, bbsType) { ... }

    function renderDaiyaBbsComments(comments) {
        if (!comments || comments.length === 0) {
            daiyaBbsCommentsContainer.innerHTML = `<p class="text-gray-500 text-center">ã¾ã åå¿œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
            return;
        }
        daiyaBbsCommentsContainer.innerHTML = '';
        comments.slice().reverse().forEach(comment => {
            renderCommentThread(comment, daiyaBbsCommentsContainer, 'daiya');
        });
    }

    function renderNamcoNews(news) {
        if (!news) {
            namcoNewsSection.classList.add('hidden');
            return;
        }
        namcoNewsSection.classList.remove('hidden');
        namcoNewsContent.innerHTML = '';
        const newsItem = document.createElement('div');
        newsItem.className = 'namco-news-item p-2 hover:bg-orange-50 rounded';
        newsItem.innerHTML = `<p class="font-semibold text-gray-700">${news.title}<span class="namco-news-tag">é‡çƒéƒ¨</span></p>`;
        newsItem.addEventListener('click', () => {
            document.getElementById('modal-title').textContent = news.title;
            document.getElementById('modal-body').textContent = news.body;
            document.getElementById('modal-meta').innerHTML = `<p>${new Date(news.timestamp).toLocaleDateString('ja-JP')}</p><p class="font-bold text-gray-500">é‡çƒéƒ¨</p>`;
            newsModal.classList.remove('hidden');
            newsModal.classList.add('flex');
        });
        namcoNewsContent.appendChild(newsItem);
    }

    function renderCommentThread(comment, container, bbsType) {
        const threadContainer = document.createElement('div');
        if (container.id === `replies-to-${comment.id}` || (container.id.includes('bbs-comments') && container.children.length > 0)) {
            threadContainer.className = 'ml-4 border-l-2 pl-4 mt-2';
        } else {
            threadContainer.className = 'mt-2';
        }

        const personalityClass = comment.personality === 'ã‚ãªãŸ' ? 'text-blue-600 font-bold' : 'text-gray-600';
        const commentEl = document.createElement('div');
        commentEl.className = 'bbs-comment';
        commentEl.innerHTML = `
            <div class="flex justify-between items-center">
                <p class="font-semibold ${personalityClass} text-sm">${comment.personality || 'åç„¡ã—ã•ã‚“'}</p>
                <button class="reply-btn text-xs text-blue-500 hover:underline" data-comment-id="${comment.id}" data-bbs-type="${bbsType}">è¿”ä¿¡ã™ã‚‹</button>
            </div>
            <p class="text-gray-800 my-1 whitespace-pre-wrap">${comment.text}</p>
            <p class="text-xs text-gray-400 text-right">${new Date(comment.timestamp).toLocaleString('ja-JP')}</p>
            <div id="reply-form-container-${comment.id}" class="hidden mt-2">
                <form class="reply-form" data-comment-id="${comment.id}" data-bbs-type="${bbsType}">
                    <textarea class="w-full p-2 border rounded text-sm" placeholder="è¿”ä¿¡ã‚’å…¥åŠ›..." required></textarea>
                    <button type="submit" class="mt-1 bg-blue-500 text-white px-3 py-1 text-xs rounded hover:bg-blue-600">é€ä¿¡</button>
                </form>
            </div>
        `;
        threadContainer.appendChild(commentEl);

        const repliesContainer = document.createElement('div');
        repliesContainer.id = `replies-to-${comment.id}`;
        threadContainer.appendChild(repliesContainer);

        container.appendChild(threadContainer);

        if (comment.replies && comment.replies.length > 0) {
            comment.replies.slice().reverse().forEach(reply => {
                renderCommentThread(reply, repliesContainer, bbsType);
            });
        }
    }

    /**
 * Renders the regional survival status with a new card-based, scrollable layout.
 */
function renderRegionMap(data) {
    const regionMapSection = document.getElementById('region-map-section');
    const finalMatch = data.matches['F-R1-M1'];
    if ((!data.matches || Object.keys(data.matches).length === 0) && !finalMatch) {
        regionMapSection.classList.add('hidden');
        return;
    }
    regionMapSection.classList.remove('hidden');

    const container = document.getElementById('region-map-container');
    const teamsByRegion = { 'æ±éƒ¨': [], 'ä¸­éƒ¨': [], 'è¥¿éƒ¨': [], 'ä¼Šè±†': [] };
    INITIAL_TEAM_POOL.forEach(teamName => {
        const region = TEAM_DATA[teamName]?.region;
        if (region && teamsByRegion[region]) {
            teamsByRegion[region].push(teamName);
        }
    });

    const eliminatedTeams = new Set();
    const allMatches = { ...data.matches, ...(data.autumnData?.allMatches || {}) };

    Object.values(allMatches).filter(match => match.winner).forEach(match => {
        const loser = match.team1 === match.winner ? match.team2 : match.team1;
        if (loser) eliminatedTeams.add(loser);
    });

    if (finalMatch?.winner) {
        const tournamentWinner = finalMatch.winner;
        eliminatedTeams.forEach(team => {
            if (team === tournamentWinner) eliminatedTeams.delete(team);
        });
    }
    
    let html = '<div class="region-map-scroll-container">'; // New scroll container
    for (const region in teamsByRegion) {
        const teams = teamsByRegion[region];
        if (teams.length === 0) continue;
        
        const survivingCount = teams.filter(team => !eliminatedTeams.has(team)).length;

        html += `
        <div class="region-column">
            <div class="region-header">
                <h3 class="region-title">${region}åœ°åŒº</h3>
                <p class="region-stats">${survivingCount} / ${teams.length} ãƒãƒ¼ãƒ ç”Ÿå­˜</p>
            </div>
            <ul class="region-team-list">
                ${teams.sort((a, b) => { // Sort teams to put survivors at the top
                    const aElim = eliminatedTeams.has(a);
                    const bElim = eliminatedTeams.has(b);
                    if (aElim === bElim) return a.localeCompare(b, 'ja');
                    return aElim ? 1 : -1;
                }).map(team => `
                    <li class="region-team ${eliminatedTeams.has(team) ? 'team-eliminated' : 'team-surviving'}">
                        ${team}
                    </li>
                `).join('')}
            </ul>
        </div>
        `;
    }
    html += '</div>';
    container.innerHTML = html;
}
    
    /**
     * ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’åˆ¶å¾¡ã™ã‚‹
     */
    function checkTournamentProgress() {
    // ãƒœã‚¿ãƒ³è¦ç´ ã®å–å¾—
    const skipR1Btn = document.getElementById('skip-r1-btn');
    const skipR2Btn = document.getElementById('skip-r2-btn');
    const skipR3Btn = document.getElementById('skip-r3-btn');
    const skipR4Btn = document.getElementById('skip-r4-btn');
    const skipR5Btn = document.getElementById('skip-r5-btn');
    const skipFinalBtn = document.getElementById('skip-final-btn');
    const generateSummaryBtn = document.getElementById('generate-summary-btn');

    // å¤ã®å¤§ä¼šä»¥å¤–ã§ã¯ã€å…¨ã¦ã®ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    if (tournamentState.is16team || !tournamentState.matches || Object.keys(tournamentState.matches).length === 0 || tournamentState.currentTournament !== 'summer') {
        [skipR1Btn, skipR2Btn, skipR3Btn, skipR4Btn, skipR5Btn, skipFinalBtn, generateSummaryBtn].forEach(btn => btn?.classList.add('hidden'));
        return;
    }

    const matchIds = Object.keys(tournamentState.matches);

    // â–¼â–¼â–¼ ã“ã“ãŒä¿®æ­£ã•ã‚ŒãŸãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° â–¼â–¼â–¼
    const getRoundStatus = (roundNumber) => {
        // ç¾åœ¨ã®è©¦åˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€ãã®ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ—ãƒ¬ã‚¤æ¸ˆã¿ã®è©¦åˆæ•°ã‚’æ•°ãˆã‚‹
        const played = matchIds.filter(id => id.includes(`-R${roundNumber}-M`) && tournamentState.matches[id]?.winner).length;
        
        // â˜…å¤‰æ›´ç‚¹ï¼šç·è©¦åˆæ•°ã¯ã€å¸¸ã«64ãƒãƒ¼ãƒ ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¨ˆç®—ã™ã‚‹
        const total = 64 / Math.pow(2, roundNumber);
        
        return { total, played };
    };
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    const r1 = getRoundStatus(1);
    const r2 = getRoundStatus(2);
    const r3 = getRoundStatus(3);
    const r4 = getRoundStatus(4); // æº–ã€…æ±ºå‹
    const r5 = getRoundStatus(5); // æº–æ±ºå‹
    const finalMatch = tournamentState.matches['F-R1-M1'];

    // ã“ã®è¡¨ç¤º/éè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯ã¯ã€getRoundStatusãŒä¿®æ­£ã•ã‚ŒãŸã“ã¨ã§æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™
    skipR1Btn.classList.toggle('hidden', r1.played > 0);
    skipR2Btn.classList.toggle('hidden', !(r1.played === r1.total && r2.played === 0));
    skipR3Btn.classList.toggle('hidden', !(r2.played === r2.total && r3.played === 0));
    skipR4Btn.classList.toggle('hidden', !(r3.played === r3.total && r4.played === 0));
    skipR5Btn.classList.toggle('hidden', !(r4.played === r4.total && r5.played === 0));
    skipFinalBtn.classList.toggle('hidden', !(r5.played === r5.total && (!finalMatch || !finalMatch.winner)));

    const summaryGenerated = tournamentState.news.some(n => n.summaryType === 'best8');
    generateSummaryBtn.classList.toggle('hidden', !(r3.played === r3.total && r4.played === 0 && !summaryGenerated));
}
/**
 * æ±ºå‹æˆ¦ã‚’è‡ªå‹•ã§ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
 */
async function skipFinal() {
    const finalMatch = tournamentState.matches['F-R1-M1'];
    if (!finalMatch || !finalMatch.team1 || !finalMatch.team2 || finalMatch.winner) return;

    const btn = document.getElementById('skip-final-btn');
    if(btn) btn.disabled = true;
    
    const { team1, team2 } = finalMatch;
    const rank1 = calculateRank(team1, tournamentState);
    const rank2 = calculateRank(team2, tournamentState);
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
    
    let winnerName, loserName;
    // ãƒ©ãƒ³ã‚¯å·®ãŒ2ä»¥ä¸Šã‚ã‚‹å ´åˆã€95%ã®ç¢ºç‡ã§ãƒ©ãƒ³ã‚¯ä¸Šä½ãŒå‹åˆ©
    const upsetChance = Math.abs(rankValues[rank1] - rankValues[rank2]) >= 2 ? 0.05 : 0.45;

    if (Math.random() < upsetChance) { // ç•ªç‹‚ã‚ã›
        winnerName = rankValues[rank1] < rankValues[rank2] ? team1 : team2;
    } else { // é †å½“
        winnerName = rankValues[rank1] >= rankValues[rank2] ? team1 : team2;
    }
    loserName = winnerName === team1 ? team2 : team1;

    const winnerRank = calculateRank(winnerName, tournamentState);
    const loserRank = calculateRank(loserName, tournamentState);
    const [winnerScore, loserScore] = generateAutoScore(winnerRank, loserRank);

    finalMatch.score1 = (finalMatch.team1 === winnerName) ? winnerScore : loserScore;
    finalMatch.score2 = (finalMatch.team2 === winnerName) ? winnerScore : loserScore;

    await processMatchWin('F-R1-M1', winnerName);

    if(btn) btn.classList.add('hidden');
}

    function checkBest8Decided(){} // checkTournamentProgressã«çµ±åˆ
// --- è©¦åˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®é–¢æ•°ï¼ˆé«˜æ©Ÿèƒ½ç‰ˆï¼‰ ---

   /**
     * ã€ä¿®æ­£ç‰ˆã€‘æ–°ã—ã„è©¦åˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã€å„ç¨®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆã™ã‚‹
     */
    /**
     * ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ã®ãƒ†ãƒ¼ãƒ–ãƒ«HTMLã‚’ç”Ÿæˆã™ã‚‹
     */
    /**
 * ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ã®ãƒ†ãƒ¼ãƒ–ãƒ«HTMLã‚’ç”Ÿæˆã™ã‚‹ï¼ˆâ˜…åˆ—å¹…ã‚¯ãƒ©ã‚¹ã‚’é©ç”¨ã—ãŸæœ€çµ‚ç‰ˆï¼‰
 */
/**
/**
 * ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ã®ãƒ†ãƒ¼ãƒ–ãƒ«HTMLã‚’ç”Ÿæˆã™ã‚‹ï¼ˆ0ç‚¹è¡¨ç¤ºãƒã‚°ä¿®æ­£ç‰ˆï¼‰
 * @param {string} team1Name - ãƒãƒ¼ãƒ 1ã®åå‰
 * @param {string} team2Name - ãƒãƒ¼ãƒ 2ã®åå‰
 * @param {object} details - è©¦åˆã®è©³ç´°ãƒ‡ãƒ¼ã‚¿
 * @returns {string} - ç”Ÿæˆã•ã‚ŒãŸHTML
 */
function createInningScoreTable(team1Name, team2Name, details) {
    const inningData = details.inningScore || { team1: [], team2: [] };
    const numInnings = (inningData.team1 && inningData.team1.length > 0) ? inningData.team1.length : 9;
    
    let header = '';
    for (let i = 1; i <= numInnings; i++) {
        header += `<th class="col-inning-score">${i}</th>`;
    }

    const createRow = (teamKey, teamName) => {
        let cells = '';
        for (let i = 0; i < numInnings; i++) {
            // â–¼â–¼â–¼ã€é‡è¦ä¿®æ­£ã€‘ã“ã“ãŒãƒã‚°ã®åŸå› ã§ã—ãŸâ–¼â–¼â–¼
            // ä¿å­˜ã•ã‚ŒãŸå€¤ãŒ0ã®å ´åˆã§ã‚‚ã€''ï¼ˆç©ºæ–‡å­—ï¼‰ã§ã¯ãªã0ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ä¿®æ­£
            const scoreValue = inningData[teamKey]?.[i] ?? ''; // nullã‹undefinedã®å ´åˆã®ã¿''ã«ã™ã‚‹
            cells += `<td class="col-inning-score"><input type="number" value="${scoreValue}"></td>`;
            // â–²â–²â–²
        }
        return `<tr>
                    <th class="col-team text-left font-semibold pl-2">${teamName}</th>
                    ${cells}
                    <td class="total-score col-total"></td>
                </tr>`;
    };

    return `
        <div class="mb-6 overflow-x-auto">
            <h4 class="font-bold mb-2">ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢</h4>
            <table class="details-table" id="inning-score-table">
                <thead>
                    <tr>
                        <th class="col-team">ãƒãƒ¼ãƒ </th>${header}<th class="col-total">è¨ˆ</th><th class="col-add-inning"><button id="add-inning-score-btn" class="text-xs font-bold">+</button></th>
                    </tr>
                </thead>
                <tbody>${createRow('team1', team1Name)}${createRow('team2', team2Name)}</tbody>
            </table>
        </div>`;
}
/**
 * æ–°ã—ã„è©¦åˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã€å„ç¨®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ï¼ˆå…¨ã¦ã®æ©Ÿèƒ½ã‚’å«ã‚€æœ€çµ‚ç‰ˆï¼‰
 */
/**
 * æ–°ã—ã„è©¦åˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã€å„ç¨®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ï¼ˆâ˜…å¸¸æ™‚ç¸¦ä¸¦ã³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¯¾å¿œç‰ˆï¼‰
 */
// ã€å®Œæˆç‰ˆã€‘openDetailsModal
/**
 * Opens the detailed input modal with the corrected vertical layout.
 */
/**
 * æ–°ã—ã„è©¦åˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã€å„ç¨®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ï¼ˆâ˜…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå•é¡Œã‚’å®Œå…¨ä¿®æ­£ã—ãŸæœ€çµ‚ç‰ˆï¼‰
 */
/**
 * æ–°ã—ã„è©¦åˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã€å„ç¨®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ï¼ˆâ˜…ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ã®æ¬ é™¥ã‚’ä¿®æ­£ã—ãŸæœ€çµ‚ç‰ˆï¼‰
 */
function openDetailsModal(matchId) {
    currentMatchIdForDetails = matchId;
    const match = findMatchById(matchId);
    if (!match) {
        console.error(`[openDetailsModal] ã‚¨ãƒ©ãƒ¼: ID ${matchId} ã®è©¦åˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
        return;
    }

    console.log("--- [ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º é–‹å§‹] ---", { matchId: matchId, æ—¢å­˜ãƒ‡ãƒ¼ã‚¿: match.details });

    let details = JSON.parse(JSON.stringify(match.details || {}));

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆ â–¼â–¼â–¼
    // --- ã€æ–°æ©Ÿèƒ½ã€‘å‰å›ã®ãƒ­ã‚¹ã‚¿ãƒ¼æƒ…å ±ã‚’å¼•ãç¶™ã ---
    // (ã¾ã ã“ã®è©¦åˆã®è©³ç´°å…¥åŠ›(details.batting)ãŒç©ºã®å ´åˆã®ã¿å®Ÿè¡Œ)
    if ((!details.batting || !details.batting.team1 || details.batting.team1.length === 0)) {
        console.log("[ãƒ­ã‚¹ã‚¿ãƒ¼å¼•ç¶™] ã“ã®è©¦åˆã®è©³ç´°ã¯ç©ºã§ã™ã€‚å‰å›ã®ãƒ­ã‚¹ã‚¿ãƒ¼ã‚’æ¢ã—ã¾ã™...");
        for (const teamKey of ['team1', 'team2']) {
            const teamName = match[teamKey];
            const teamRecord = tournamentState.teamRecords[teamName];
            
            // (A) å‰å›ã®ãƒ­ã‚¹ã‚¿ãƒ¼æƒ…å ±(roster)ãŒã‚ã‚‹ã‹ï¼Ÿ
            if (teamRecord && teamRecord.roster && teamRecord.roster.length > 0) {
                console.log(`[ãƒ­ã‚¹ã‚¿ãƒ¼å¼•ç¶™] ${teamName} ã®å‰å›ã®ãƒ­ã‚¹ã‚¿ãƒ¼ (${teamRecord.roster.length}äºº) ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚`);
                
                // (B) details.batting ã«ã€æ‰“å¸­çµæœ(results)ã‚’ç©ºã«ã—ã¦ã‚³ãƒ”ãƒ¼ã™ã‚‹
                details.batting = details.batting || { team1: [], team2: [] };
                
                // â˜…â˜…â˜… ã“ã“ãŒä¿®æ­£ç‚¹ â˜…â˜…â˜…
                // äº¤ä»£é¸æ‰‹(orderã«'sub'ãŒå«ã¾ã‚Œã‚‹)ã‚’é™¤å¤–ã—ã€ã‚¹ã‚¿ãƒ¡ãƒ³9åã ã‘ã‚’æŠ½å‡ºã™ã‚‹
                details.batting[teamKey] = teamRecord.roster
                    .filter(playerData => playerData.order && !playerData.order.toString().includes('sub'))
                    .map(playerData => ({
                        ...playerData, // order, name, number, pos, throwBat ã‚’å¼•ãç¶™ã
                        sub_type: null, // 2å›æˆ¦ã§ã¯ã€Œã‚¹ã‚¿ãƒ¡ãƒ³ã€ãªã®ã§ sub_type ã¯ãƒªã‚»ãƒƒãƒˆ
                        results: []     // æ‰“å¸­çµæœã¯ç©ºã«ã™ã‚‹
                    }));
                // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

            }
            // (B) å¿µã®ãŸã‚ã€å¤ã„ã‚¹ã‚¿ãƒ¡ãƒ³æƒ…å ±(previousStarters)ã‚‚ãƒã‚§ãƒƒã‚¯ (å¤ã„ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ç”¨)
            else if (teamRecord && teamRecord.previousStarters && teamRecord.previousStarters.length > 0) {
                 console.log(`[ãƒ­ã‚¹ã‚¿ãƒ¼å¼•ç¶™] ${teamName} ã®å‰å›ã®ã‚¹ã‚¿ãƒ¡ãƒ³ (${teamRecord.previousStarters.length}äºº) ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚`);
                 
                 details.batting = details.batting || { team1: [], team2: [] };
                 details.batting[teamKey] = teamRecord.previousStarters.map(playerData => ({
                    ...playerData, // order, name, pos ã‚’å¼•ãç¶™ã
                    results: [] // æ‰“å¸­çµæœã¯ç©ºã«ã™ã‚‹
                }));
            }
        }
    }
    // â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²    
    const numInnings = Math.max(9, ...Object.values(tournamentState.matches)
        .filter(m => m.details?.inningScore?.team1)
        .map(m => m.details.inningScore.team1.length));

    console.log(`[ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º] ç¾åœ¨ã®æœ€å¤§ã‚¤ãƒ‹ãƒ³ã‚°æ•°ã‚’ ${numInnings} ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚`);

    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®åˆæœŸåŒ–
    details.inningScore = details.inningScore || { team1: [], team2: [] };
    details.batting = details.batting || { team1: [], team2: [] };
    details.pitching = details.pitching || { team1: [], team2: [] };
    details.fielding = details.fielding || { team1: [], team2: [] }; // â˜…è¿½åŠ 
    details.inningEvents = details.inningEvents || { team1: [], team2: [] };
    details.positionChanges = details.positionChanges || [];
    
// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆ â–¼â–¼â–¼
    // --- å®ˆå‚™äº¤ä»£ã®ã€Œå±¥æ­´ï¼ˆå¤‰é·ï¼‰ã€ã‚’æ–‡å­—åˆ—ã¨ã—ã¦ç”Ÿæˆã—ã€battingãƒ‡ãƒ¼ã‚¿ã«ä»˜ä¸ ---
    const allChanges = details.positionChanges || [];
    // äº¤ä»£ã‚’ã‚¤ãƒ‹ãƒ³ã‚°é †ï¼ˆã¨è¡¨/è£ï¼‰ã«ã‚½ãƒ¼ãƒˆ
    const sortedChanges = allChanges.sort((a, b) => {
        const inningA = parseInt(a.inning) || 0;
        const inningB = parseInt(b.inning) || 0;
        if (inningA !== inningB) return inningA - inningB;
        return (a.topBottom === 'è£' ? 1 : 0) - (b.topBottom === 'è£' ? 1 : 0);
    });

    for (const teamKey of ['team1', 'team2']) {
        const teamBattingData = details.batting[teamKey];
        if (teamBattingData) {
            teamBattingData.forEach(player => {
                if (!player.name) {
                    player.posHistoryDisplay = ''; // å±¥æ­´ãªã—
                    player.currentPos = ''; // ç¾åœ¨ã®ãƒã‚¸ã‚·ãƒ§ãƒ³
                    return;
                }
                
                // 1. å±¥æ­´é…åˆ—ã‚’åˆæœŸåŒ–
                let history = [];
                
                // 2. â˜…â˜…â˜… ä¿®æ­£ç‚¹ â˜…â˜…â˜…
                // ã€Œã‚¹ã‚¿ãƒ¡ãƒ³ã€ã‹ã€Œäº¤ä»£å‡ºå ´ã€ã‹ã«é–¢ã‚ã‚‰ãšã€
                // `details.batting` ã«è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ `player.pos` ã‚’ã€Œæœ€åˆã®ãƒã‚¸ã‚·ãƒ§ãƒ³ã€ã¨ã—ã¦å±¥æ­´ã«è¿½åŠ ã™ã‚‹
                if (player.pos) {
                    let initialTiming = "ã‚¹ã‚¿ãƒ¡ãƒ³";
                    if (player.order.includes('sub')) {
                        // äº¤ä»£é¸æ‰‹ã®å ´åˆã€äº¤ä»£ã‚¿ã‚¤ãƒ—ã‹ã‚‰ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ¨æ¸¬
                        if (player.sub_type === 'PH') initialTiming = "ä»£æ‰“å‡ºå ´";
                        else if (player.sub_type === 'PR') initialTiming = "ä»£èµ°å‡ºå ´";
                        else initialTiming = "é€”ä¸­å‡ºå ´"; // DEF, PITCHER
                    }
                    history.push({ pos: player.pos, timing: initialTiming });
                }

                // 3. ã“ã®é¸æ‰‹ã®äº¤ä»£å±¥æ­´ï¼ˆpositionChangesï¼‰ã‚’æŠ½å‡ºã—ã¦è¿½åŠ 
                sortedChanges.forEach(change => {
                    if (change.teamKey === teamKey && change.playerName === player.name) {
                        
                        // ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ–‡å­—åˆ—ã‚’ç”Ÿæˆ
                        let timingStr = `${change.inning || '?'}å›${change.topBottom || ''}`;
                        if (change.timing === 'mid') {
                            timingStr += ` ${change.outs || '0'}æ­»`;
                        } else {
                            timingStr += ` 0æ­»`; // ã‚¤ãƒ‹ãƒ³ã‚°é–‹å§‹æ™‚
                        }
                        
                        history.push({ pos: change.newPos, timing: timingStr });
                    }
                });
                
                // 4. é‡è¤‡ã‚’å‰Šé™¤ (ä¾‹: [æŠ•, æŠ•, ä¸€] -> [æŠ•, ä¸€])
                const uniqueHistory = history.filter((entry, index) => {
                    return entry.pos && (index === 0 || entry.pos !== history[index - 1].pos);
                });
                
                // 5. æœ€çµ‚çš„ãªè¡¨ç¤ºæ–‡å­—åˆ—ã¨ã€ç¾åœ¨ã®ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
                if (uniqueHistory.length > 1) {
                    // â˜… å¤‰é·æ–‡å­—åˆ—ã« (ã‚¿ã‚¤ãƒŸãƒ³ã‚°) ã‚’è¿½åŠ 
                    player.posHistoryDisplay = uniqueHistory.map((entry, index) => {
                        if (index === 0) return entry.pos; // æœ€åˆã®ãƒã‚¸ã‚·ãƒ§ãƒ³ (ã‚¹ã‚¿ãƒ¡ãƒ³/é€”ä¸­å‡ºå ´)
                        return `â†’ (${entry.timing}) ${entry.pos}`; // ä¾‹: â†’ (7å›è¡¨ 2æ­») ä¸€
                    }).join(' ');
                    
                    player.currentPos = uniqueHistory[uniqueHistory.length - 1].pos; // æœ€å¾Œã®ãƒã‚¸ã‚·ãƒ§ãƒ³
                } else if (uniqueHistory.length === 1) {
                    player.posHistoryDisplay = uniqueHistory[0].pos; // ä¾‹: "æŠ•"
                    player.currentPos = uniqueHistory[0].pos;
                } else {
                    player.posHistoryDisplay = ''; // å®ˆå‚™è¨˜éŒ²ãªã—
                    player.currentPos = player.pos || ''; // å±¥æ­´ãŒãªãã¦ã‚‚å…ƒã®posãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
                }
            });
        }
    }
    // â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
    // é…åˆ—ã®é•·ã•ã‚’ç¾åœ¨ã®ã‚¤ãƒ‹ãƒ³ã‚°æ•°ã«åˆã‚ã›ã‚‹
    for(const teamKey of ['team1', 'team2']) {
        if (!details.inningEvents[teamKey]) details.inningEvents[teamKey] = [];
        while (details.inningScore[teamKey].length < numInnings) details.inningScore[teamKey].push('');
        while (details.inningEvents[teamKey].length < numInnings) details.inningEvents[teamKey].push('');
        if (details.batting[teamKey]) {
            details.batting[teamKey].forEach(player => {
                if (!player.results) player.results = [];
                while (player.results.length < numInnings) player.results.push('');
            });
        }
    }
    console.log("[ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º] è¡¨ç¤ºç”¨ã«æº–å‚™ã—ãŸãƒ‡ãƒ¼ã‚¿:", JSON.parse(JSON.stringify(details)));


    // ã‚‚ã—è©¦åˆãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã€ã‹ã¤ãƒãƒ¼ãƒ ã®é¸æ‰‹åç°¿(roster)ãŒå­˜åœ¨ã™ã‚Œã°ã€ãã‚Œã‚’èª­ã¿è¾¼ã‚€
    for (const teamKey of ['team1', 'team2']) {
        const teamName = match[teamKey];
        const teamRecord = tournamentState.teamRecords[teamName];
        if (details.batting[teamKey].length === 0 && teamRecord && teamRecord.roster) {
            details.batting[teamKey] = teamRecord.roster.map(p => ({ ...p, results: Array(numInnings).fill('') }));
        }
    }
    
// â˜… é¸æ‰‹ãƒªã‚¹ãƒˆã‚’ã“ã“ã§å–å¾— â˜…
    const playersTeam1 = details.batting.team1.filter(p => p.name).map(p => ({name: p.name}));
    const playersTeam2 = details.batting.team2.filter(p => p.name).map(p => ({name: p.name}));

    const detailsBody = document.getElementById('details-modal-body');
    detailsBody.innerHTML = `
        <div class="space-y-4">
            ${createInningScoreTable(match.team1, match.team2, details)}
            <div class="text-center py-2 border-t border-b">
                <button id="swap-teams-btn" data-match-id="${matchId}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">å…ˆæ”»ãƒ»å¾Œæ”»ã‚’å…¥ã‚Œæ›¿ãˆ</button>
            </div>
            
<div class="space-y-4">
                <h4 class="font-bold text-lg">${match.team1} æ‰“æ’ƒæˆç¸¾</h4>
                <div class="overflow-x-auto border rounded-lg bg-white">${createPlayerBattingTable(match.team1, 'team1', details)}</div>
                <h4 class="font-bold text-lg mt-4">${match.team2} æ‰“æ’ƒæˆç¸¾</h4>
                <div class="overflow-x-auto border rounded-lg bg-white">${createPlayerBattingTable(match.team2, 'team2', details)}</div>
            </div>
            
            <div class="space-y-4 mt-4">
                
                <h4 class="font-bold text-lg flex justify-between items-center">
                    <span>${match.team1} æŠ•æ‰‹æˆç¸¾</span>
                    <button class="copy-pitchers-from-batting-btn text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 ml-2" data-team-key="team1">
                        æ‰“é †ã‹ã‚‰ã‚³ãƒ”ãƒ¼
                    </button>
                </h4>
                <div class="overflow-x-auto border rounded-lg bg-white">${createPitchingStatsTable('team1', details)}</div>
                
                <h4 class="font-bold text-lg flex justify-between items-center mt-4">
                    <span>${match.team2} æŠ•æ‰‹æˆç¸¾</span>
                    <button class="copy-pitchers-from-batting-btn text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 ml-2" data-team-key="team2">
                        æ‰“é †ã‹ã‚‰ã‚³ãƒ”ãƒ¼
                    </button>
                </h4>
                <div class="overflow-x-auto border rounded-lg bg-white">${createPitchingStatsTable('team2', details)}</div>
            </div>

            <div class="space-y-4 mt-4">
                <h4 class="font-bold text-lg">${match.team1} å®ˆå‚™ãƒã‚¤ãƒ©ã‚¤ãƒˆ</h4>
                <div class="overflow-x-auto border rounded-lg bg-white">
                    ${createFieldingTable('team1', details, playersTeam1)}
                </div>
                 <h4 class="font-bold text-lg mt-4">${match.team2} å®ˆå‚™ãƒã‚¤ãƒ©ã‚¤ãƒˆ</h4>
                <div class="overflow-x-auto border rounded-lg bg-white">
                    ${createFieldingTable('team2', details, playersTeam2)}
                </div>
            </div>
            </div>
    `;

    detailsModal.classList.remove('hidden');
    updateTotalScores();
}
 

/**
 * æŠ•æ‰‹æˆç¸¾ã®ãƒ†ãƒ¼ãƒ–ãƒ«HTMLã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…å…¨ã‚¯ãƒ©ã‚¹åã‚’ä»˜ä¸ã—ãŸæœ€çµ‚ä¿®æ­£ç‰ˆâ˜…)
 * @param {string} teamKey - 'team1' ã¾ãŸã¯ 'team2'
 * @param {object} details - è©¦åˆã®è©³ç´°ãƒ‡ãƒ¼ã‚¿
 * @returns {string} - ç”Ÿæˆã•ã‚ŒãŸHTML
 */
function createPitchingStatsTable(teamKey, details) {
    const pitchingData = details.pitching[teamKey] || [];
    
    // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠè‚¢ã®å®šç¾© (å¤‰æ›´ãªã—)
    const throwStyleOptions = [
        { val: "over", label: "ã‚ªãƒ¼ãƒãƒ¼" }, { val: "three_quarter", label: "ã‚¹ãƒªãƒ¼ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼" },
        { val: "side", label: "ã‚µã‚¤ãƒ‰" }, { val: "under", label: "ã‚¢ãƒ³ãƒ€ãƒ¼" }
    ];
    const pitcherTypeOptions = [
        { val: "honkaku", label: "æœ¬æ ¼æ´¾" }, { val: "sokkyu", label: "é€Ÿçƒæ´¾" },
        { val: "giko", label: "æŠ€å·§æ´¾" }, { val: "nanto", label: "è»ŸæŠ•æ´¾" }
    ];
    const velocityOptions = [];
    for (let v = 120; v <= 165; v += 5) {
        velocityOptions.push({ val: `${v}km`, label: `${v}kmå¸¯` });
    }
    const throwBatOptions = [
        { val: "R/R", label: "å³/å³" }, { val: "R/L", label: "å³/å·¦" }, { val: "R/S", label: "å³/ä¸¡" },
        { val: "L/L", label: "å·¦/å·¦" }, { val: "L/R", label: "å·¦/å³" }, { val: "L/S", label: "å·¦/ä¸¡" }
    ];

    let bodyRows = pitchingData.map((player, index) => {
        const tbOptionsHtml = throwBatOptions.map(opt => `<option value="${opt.val}" ${player.throwBat === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('');
        const styleOptionsHtml = throwStyleOptions.map(opt => `<option value="${opt.val}" ${player.throwStyle === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('');
        const typeOptionsHtml = pitcherTypeOptions.map(opt => `<option value="${opt.val}" ${player.pitcherType === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('');
        const velocityOptionsHtml = velocityOptions.map(opt => `<option value="${opt.val}" ${player.velocity === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('');

        // â–¼â–¼â–¼ ã“ã®è¡Œå…¨ä½“ã‚’ä¿®æ­£ï¼ˆå…¨è¦ç´ ã«ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ï¼‰ â–¼â–¼â–¼
        return `
        <tr data-pitcher-index="${index}">
            <td class="col-pitcher-result">
                <select class="pitcher-result"> 
                    <option value="" ${!player.result ? 'selected' : ''}>-</option>
                    <option value="W" ${player.result === 'W' ? 'selected' : ''}>â—‹</option>
                    <option value="L" ${player.result === 'L' ? 'selected' : ''}>â—</option>
                    <option value="S" ${player.result === 'S' ? 'selected' : ''}>S</option>
                    <option value="H" ${player.result === 'H' ? 'selected' : ''}>H</option>
                </select>
            </td>
            <td class="col-pitcher-name"><input type="text" class="pitcher-name" value="${player.name || ''}"></td> 
            <td class="col-pitcher-throw-bat"><select class="pitcher-throw-bat w-full bg-transparent"><option value="">-æŠ•/æ‰“-</option>${tbOptionsHtml}</select></td>
            <td class="col-pitcher-style"><select class="pitcher-throw-style w-full bg-transparent"><option value="">-æŠ•ã’æ–¹-</option>${styleOptionsHtml}</select></td>
            <td class="col-pitcher-type"><select class="pitcher-type w-full bg-transparent"><option value="">-ã‚¿ã‚¤ãƒ—-</option>${typeOptionsHtml}</select></td>
            <td class="col-pitcher-velocity"><select class="pitcher-velocity w-full bg-transparent"><option value="">-çƒé€Ÿå¸¯-</option>${velocityOptionsHtml}</select></td>
            <td class="col-stat"><input type="text" class="pitcher-innings" value="${player.innings || ''}"></td> 
            <td class="col-stat"><input type="number" class="pitcher-batters" value="${player.battersFaced || ''}"></td> 
            <td class="col-stat"><input type="number" class="pitcher-pitches" value="${player.pitches || ''}"></td> 
            <td class="col-stat"><input type="number" class="pitcher-hits" value="${player.hits || ''}"></td> 
            <td class="col-stat"><input type="number" class="pitcher-so" value="${player.strikeouts || ''}"></td> 
            <td class="col-stat"><input type="number" class="pitcher-walks" value="${player.walks || ''}"></td> 
            <td class="col-stat"><input type="number" class="pitcher-runs" value="${player.runs || ''}"></td> 
            <td class="col-stat"><input type="number" class="pitcher-er" value="${player.earnedRuns || ''}"></td> 
        </tr>
        `;
        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    }).join('');

    // ã‚‚ã—æŠ•æ‰‹ãŒä¸€äººã‚‚ã„ãªã‘ã‚Œã°ã€ç©ºã®è¡Œã‚’1ã¤è¿½åŠ ã—ã¦ãŠã
    if (pitchingData.length === 0) {
        const tbOptionsHtml = throwBatOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        const styleOptionsHtml = throwStyleOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        const typeOptionsHtml = pitcherTypeOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        const velocityOptionsHtml = velocityOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        // â–¼â–¼â–¼ ç©ºè¡Œã«ã‚‚å…¨ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ  â–¼â–¼â–¼
        bodyRows = `
            <tr data-pitcher-index="0">
                <td class="col-pitcher-result"><select class="pitcher-result"><option value="" selected>-</option><option value="W">â—‹</option><option value="L">â—</option><option value="S">S</option><option value="H">H</option></select></td>
                <td class="col-pitcher-name"><input type="text" class="pitcher-name" value=""></td>
                <td class="col-pitcher-throw-bat"><select class="pitcher-throw-bat w-full bg-transparent"><option value="">-æŠ•/æ‰“-</option>${tbOptionsHtml}</select></td>
                <td class="col-pitcher-style"><select class="pitcher-throw-style w-full bg-transparent"><option value="">-æŠ•ã’æ–¹-</option>${styleOptionsHtml}</select></td>
                <td class="col-pitcher-type"><select class="pitcher-type w-full bg-transparent"><option value="">-ã‚¿ã‚¤ãƒ—-</option>${typeOptionsHtml}</select></td>
                <td class="col-pitcher-velocity"><select class="pitcher-velocity w-full bg-transparent"><option value="">-çƒé€Ÿå¸¯-</option>${velocityOptionsHtml}</select></td>
                <td class="col-stat"><input type="text" class="pitcher-innings" value=""></td>
                <td class="col-stat"><input type="number" class="pitcher-batters" value=""></td>
                <td class="col-stat"><input type="number" class="pitcher-pitches" value=""></td>
                <td class="col-stat"><input type="number" class="pitcher-hits" value=""></td>
                <td class="col-stat"><input type="number" class="pitcher-so" value=""></td>
                <td class="col-stat"><input type="number" class="pitcher-walks" value=""></td>
                <td class="col-stat"><input type="number" class="pitcher-runs" value=""></td>
                <td class="col-stat"><input type="number" class="pitcher-er" value=""></td>
            </tr>
        `;
        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    }

    return `
        <div class="overflow-x-auto">
            <table class="details-table" id="pitching-table-${teamKey}">
                <thead>
                    <tr>
                        <th class="col-pitcher-result">å‹æ•—</th>
                        <th class="col-pitcher-name">é¸æ‰‹å</th>
                        <th class="col-pitcher-throw-bat">æŠ•/æ‰“</th>
                        <th class="col-pitcher-style">æŠ•ã’æ–¹</th>
                        <th class="col-pitcher-type">ã‚¿ã‚¤ãƒ—</th>
                        <th class="col-pitcher-velocity">çƒé€Ÿå¸¯</th>
                        <th class="col-stat">å›æ•°</th>
                        <th class="col-stat">æ‰“è€…</th><th class="col-stat">çƒæ•°</th><th class="col-stat">è¢«å®‰æ‰“</th>
                        <th class="col-stat">å¥ªä¸‰æŒ¯</th><th class="col-stat">ä¸å››çƒ</th><th class="col-stat">å¤±ç‚¹</th>
                        <th class="col-stat">è‡ªè²¬ç‚¹</th>
                    </tr>
                </thead>
                <tbody>${bodyRows}</tbody>
            </table>
            <button class="add-row-btn text-xs mt-2" data-table-id="pitching-table-${teamKey}">+ æŠ•æ‰‹ã‚’è¿½åŠ </button>
        </div>
    `;
}

function createFieldingTable(teamKey, details, playersOnField) {
    const fieldingData = details.fielding?.[teamKey] || [];
    
    // é¸æ‰‹åã‚’é¸æŠã™ã‚‹ãŸã‚ã® <option> ã‚¿ã‚°ã‚’ç”Ÿæˆ
    const playerOptions = playersOnField.map(p => `<option value="${p.name}">${p.name}</option>`).join('');

    let bodyRows = fieldingData.map((play, index) => `
        <tr data-fielding-index="${index}">
            <td class="w-16"><input type="number" class="fielding-inning" value="${play.inning || ''}" min="1"></td>
            <td>
                <select class="player-name w-full">
                    <option value="">- é¸æ‰‹ -</option>
                    ${playersOnField.map(p => `<option value="${p.name}" ${p.name === play.player ? 'selected' : ''}>${p.name}</option>`).join('')}
                </select>
            </td>
            <td><input type="text" class="fielding-play" value="${play.play || ''}" placeholder="ä¾‹: ãƒ€ã‚¤ãƒ“ãƒ³ã‚°ã‚­ãƒ£ãƒƒãƒã€ãƒ¬ãƒ¼ã‚¶ãƒ¼ãƒ“ãƒ¼ãƒ ã§è£œæ®º"></td>
            <td class="w-12 text-center">
                <button class="remove-fielding-play-btn text-red-500 hover:text-red-700 font-bold text-lg leading-none p-1">Ã—</button>
            </td>
        </tr>
    `).join('');
    
    return `
        <div class="overflow-x-auto">
            <table class="details-table" id="fielding-table-${teamKey}">
                <thead>
                    <tr>
                        <th class="w-16">ã‚¤ãƒ‹ãƒ³ã‚°</th>
                        <th>é¸æ‰‹å</th>
                        <th>ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã®å†…å®¹</th>
                        <th class="w-12">å‰Šé™¤</th>
                    </tr>
                </thead>
                <tbody>${bodyRows}</tbody>
            </table>
            <button class="add-fielding-play-btn text-xs mt-2" data-team-key="${teamKey}">+ ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚’è¿½åŠ </button>
        </div>
    `;
}

/**
 * å€‹äººåˆ¥æ‰“å¸­çµæœã®ãƒ†ãƒ¼ãƒ–ãƒ«HTMLã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…ã€Œ+ äº¤ä»£ã€ãƒœã‚¿ãƒ³ã‚’è¡Œå†…ã«è¨­ç½®ã™ã‚‹UIæ”¹å–„ç‰ˆ)
 */
function createPlayerBattingTable(teamName, teamKey, details) {
    const battingData = details.batting[teamKey] || [];
    const numInnings = details.inningScore?.[teamKey]?.length || 9;
    const playersOnField = battingData.filter(p => p.name);

    // ã€ŒæŠ•/æ‰“ã€ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”¨ã®é¸æŠè‚¢ (å¤‰æ›´ãªã—)
    const throwBatOptionsList = [
        { val: "R/R", label: "å³/å³" }, { val: "R/L", label: "å³/å·¦" }, { val: "R/S", label: "å³/ä¸¡" },
        { val: "L/L", label: "å·¦/å·¦" }, { val: "L/R", label: "å·¦/å³" }, { val: "L/S", label: "å·¦/ä¸¡" }
    ];
    const createThrowBatOptions = (selectedVal) => {
        return throwBatOptionsList.map(opt => 
            `<option value="${opt.val}" ${selectedVal === opt.val ? 'selected' : ''}>${opt.label}</option>`
        ).join('');
    };

    // èƒŒç•ªå·ã¨å®ˆå‚™ä½ç½®ã®é¸æŠè‚¢ (å¤‰æ›´ãªã—)
    let numberOptions = '<option value=""></option>';
    for (let i = 1; i <= 20; i++) { numberOptions += `<option value="${i}">${i}</option>`; }
    const posOptions = ['æŠ•', 'æ•', 'ä¸€', 'äºŒ', 'ä¸‰', 'éŠ', 'å·¦', 'ä¸­', 'å³'].map(p => `<option value="${p}">${p}</option>`).join('');
    
    // ã‚¤ãƒ‹ãƒ³ã‚°ãƒ˜ãƒƒãƒ€ãƒ¼ (å¤‰æ›´ãªã—)
    let inningsHeader = '';
    for (let i = 1; i <= numInnings; i++) {
        inningsHeader += `<th class="col-inning">${i}</th>`;
    }

    let bodyRows = '';

    // --- 1. ã‚¹ã‚¿ãƒ¡ãƒ³ (1ã€œ9ç•ª) ã®è¡Œã‚’ç”Ÿæˆ ---
    for (let i = 1; i <= 9; i++) {
        let starterData = battingData.find(p => p.order && parseInt(p.order) === i) || { order: i, results: Array(numInnings).fill('') };
        if (!starterData.results) starterData.results = Array(numInnings).fill('');

        const starterNumberSelect = `<select class="player-number w-full bg-transparent">${numberOptions.replace(`value="${starterData.number}"`, `value="${starterData.number}" selected`)}</select>`;
        const starterThrowBatSelect = `<select class="player-throw-bat w-full bg-transparent"><option value="">-æŠ•/æ‰“-</option>${createThrowBatOptions(starterData.throwBat)}</select>`;
        const starterPosSelect = `<select class="player-pos w-full bg-transparent"><option value=""></option>${posOptions.replace(`value="${starterData.currentPos}"`, `value="${starterData.currentPos}" selected`)}</select>`;
        const posHistoryHtml = `<span class="text-xs text-gray-500 truncate" title="${starterData.posHistoryDisplay || ''}">${starterData.posHistoryDisplay || ''}</span>`;
        
        // æ‰“å¸­çµæœ (å¤‰æ›´ãªã—)
        let resultInputs = '';
        for (let j = 0; j < numInnings; j++) {
            // ... (æ—¢å­˜ã® resultInputs ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯) ...
            const resultString = starterData.results[j] || '';
            const atBats = (resultString && resultString.split('ã€').length > 0) ? resultString.split('ã€') : [''];
            const atBatBlocksHTML = atBats.map(atBatString => createBattingResultDropdowns(playersOnField, atBatString)).join('');
            resultInputs += `<td class="col-inning batting-result-cell align-top p-1">${atBatBlocksHTML}<button class="add-at-bat-btn text-xs mt-2 bg-blue-100 px-2 py-1 rounded hover:bg-blue-200 w-full font-semibold">ï¼‹ 2æ‰“å¸­ç›®ã‚’è¿½åŠ </button></td>`;
        }
        
        bodyRows += `
            <tr data-order="${starterData.order}">
                <td class="col-order">${i}</td>
                <td class="col-number">${starterNumberSelect}</td>
                <td class="col-throw-bat">${starterThrowBatSelect}</td>
                <td class="col-player"><input type="text" class="player-name" value="${starterData.name || ''}"></td>
                <td class="col-pos">
                    <div class="flex items-center justify-between">${starterPosSelect}<button class="text-xs bg-gray-200 px-1 ml-1 rounded pos-change-btn" data-team-key="${teamKey}">å¤‰æ›´</button></div>
                    ${posHistoryHtml}
                </td>
                
                <td class="col-sub-type align-middle">
                    <button class="add-sub-row-btn text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 w-full" data-order="${starterData.order}" data-team-key="${teamKey}">
                        + äº¤ä»£
                    </button>
                </td>
                ${resultInputs}
            </tr>
        `;
        
        // --- 2. äº¤ä»£é¸æ‰‹ (ã‚¹ã‚¿ãƒ¡ãƒ³ã®ç›´ä¸‹) ã®è¡Œã‚’ç”Ÿæˆ ---
        const substitutes = battingData.filter(p => p.order && p.order.toString().startsWith(`${i}-sub`));
        substitutes.forEach(subData => {
            if (!subData.results) subData.results = Array(numInnings).fill('');
            
            const subNumberSelect = `<select class="player-number w-full bg-transparent">${numberOptions.replace(`value="${subData.number}"`, `value="${subData.number}" selected`)}</select>`;
            const subThrowBatSelect = `<select class="player-throw-bat w-full bg-transparent"><option value="">-æŠ•/æ‰“-</option>${createThrowBatOptions(subData.throwBat)}</select>`;
            const subPosSelect = `<select class="player-pos w-full bg-transparent"><option value=""></option>${posOptions.replace(`value="${subData.currentPos}"`, `value="${subData.currentPos}" selected`)}</select>`;
            const subPosHistoryHtml = `<span class="text-xs text-gray-500 truncate" title="${subData.posHistoryDisplay || ''}">${subData.posHistoryDisplay || ''}</span>`;

            // æ‰“å¸­çµæœ (å¤‰æ›´ãªã—)
            let subResultInputs = '';
            for (let j = 0; j < numInnings; j++) {
                // ... (æ—¢å­˜ã® subResultInputs ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯) ...
                const resultString = subData.results[j] || '';
                const atBats = (resultString && resultString.split('ã€').length > 0) ? resultString.split('ã€') : [''];
                const atBatBlocksHTML = atBats.map(atBatString => createBattingResultDropdowns(playersOnField, atBatString)).join('');
                subResultInputs += `<td class="col-inning batting-result-cell align-top p-1">${atBatBlocksHTML}<button class="add-at-bat-btn text-xs mt-2 bg-blue-100 px-2 py-1 rounded hover:bg-blue-200 w-full font-semibold">ï¼‹ 2æ‰“å¸­ç›®ã‚’è¿½åŠ </button></td>`;
            }
            
            bodyRows += `
                <tr data-order="${subData.order}">
                    <td class="col-order"></td>
                    <td class="col-number">${subNumberSelect}</td>
                    <td class="col-throw-bat">${subThrowBatSelect}</td>
                    <td class="col-player pl-4"><input type="text" class="player-name" value="${subData.name || ''}"></td>
                    <td class="col-pos">
                        <div class="flex items-center justify-between">${subPosSelect}<button class="text-xs bg-gray-200 px-1 ml-1 rounded pos-change-btn" data-team-key="${teamKey}">å¤‰æ›´</button></div>
                        ${subPosHistoryHtml}
                    </td>
                    
                    <td class="col-sub-type align-top">
                        <select class="sub-type-select w-full bg-transparent mb-1">
                            <option value="" ${!subData.sub_type ? 'selected' : ''}>-</option>
                            <option value="PH" ${subData.sub_type === 'PH' ? 'selected' : ''}>ä»£æ‰“</option>
                            <option value="PR" ${subData.sub_type === 'PR' ? 'selected' : ''}>ä»£èµ°</option>
                            <option value="DEF" ${subData.sub_type === 'DEF' ? 'selected' : ''}>å®ˆå‚™</option>
                            <option value="PITCHER" ${subData.sub_type === 'PITCHER' ? 'selected' : ''}>æŠ•æ‰‹</option>
                        </select>
                        <button class="add-sub-row-btn text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 w-full" data-order="${subData.order}" data-team-key="${teamKey}">
                            + äº¤ä»£
                        </button>
                    </td>
                    ${subResultInputs}
                </tr>
            `;
        });
    } 
// --- ã‚¹ã‚¿ãƒ¡ãƒ³ãƒ«ãƒ¼ãƒ—ã®çµ‚ã‚ã‚Š ---

    return `
        <div class="overflow-x-auto">
            <table class="details-table batting-table" id="batting-table-${teamKey}">
                <thead>
                    <tr>
                        <th class="col-order">æ‰“é †</th>
                        <th class="col-number">#</th>
                        <th class="col-throw-bat">æŠ•/æ‰“</th>
                        <th class="col-player">é¸æ‰‹å</th>
                        <th class="col-pos">å®ˆå‚™</th>
                        <th class="col-sub-type">å‡ºå ´</th>
                        ${inningsHeader}
                        <th class="w-10"><button class="add-inning-btn text-xs" data-team-key="${teamKey}">+ å›</button></th>
                    </tr>
                </thead>
                <tbody>${bodyRows}</tbody>
            </table>
            </div>
    `;
}

/**
 * è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã€é€šç®—æˆç¸¾ã‚’æ›´æ–°ã™ã‚‹
 * (â˜…å…¨æ§‹æ–‡ã‚¨ãƒ©ãƒ¼(SyntaxError)ã¨å‚ç…§ã‚¨ãƒ©ãƒ¼(ReferenceError)ã‚’ä¿®æ­£ã—ãŸæœ€çµ‚ç‰ˆ)
 */
function saveDetailedStats() {
    if (!currentMatchIdForDetails) return;
    const match = findMatchById(currentMatchIdForDetails);
    if (!match) return;

    // --- 1. å¤ã„æˆç¸¾ã‚’ä¸€åº¦ãƒªã‚»ãƒƒãƒˆ ---
    if (match.details && match.details.playerGameStats) {
        for (const teamKey of ['team1', 'team2']) {
            const teamName = match[teamKey];
            const teamRecord = tournamentState.teamRecords[teamName];
            if (!teamRecord || !teamRecord.playerStats) continue;

            const previousBattingStats = match.details.playerGameStats[teamKey];
            if (previousBattingStats) {
                
                // (Step 1) é¸æ‰‹å€‹äººã®ã€Œé€šç®—(career)ã€æˆç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆ
                for (const playerName in previousBattingStats) {
                    const careerStats = teamRecord.playerStats.batting[playerName];
                    const prevGameStats = previousBattingStats[playerName]; 
                    if (careerStats && prevGameStats) {
                        if(prevGameStats.played) careerStats.games = (careerStats.games || 1) - 1;
                        careerStats.pa -= prevGameStats.pa || 0;
                        careerStats.ab -= prevGameStats.ab || 0;
                        careerStats.h -= prevGameStats.h || 0;
                        careerStats.hr -= prevGameStats.hr || 0;
                        careerStats.rbi -= prevGameStats.rbi || 0;
                    }
                } // (End of player loop)

                // (Step 2) ãƒãƒ¼ãƒ å…¨ä½“ã®ã€Œä»Šå¤§ä¼š(tournamentStats)ã€ã®æˆç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆ
                if (teamRecord.tournamentStats) {
                    let totalPa = 0, totalAb = 0, totalH = 0, totalHr = 0, totalRbi = 0;
                    
                    for (const playerName in previousBattingStats) {
                        const prevGameStats = previousBattingStats[playerName]; 
                        if (prevGameStats) {
                            totalPa += prevGameStats.pa || 0;
                            totalAb += prevGameStats.ab || 0;
                            totalH += prevGameStats.h || 0;
                            totalHr += prevGameStats.hr || 0;
                            totalRbi += prevGameStats.rbi || 0;
                        }
                    }
                    
                    teamRecord.tournamentStats.pa -= totalPa;
                    teamRecord.tournamentStats.ab -= totalAb;
                    teamRecord.tournamentStats.h -= totalH;
                    teamRecord.tournamentStats.hr -= totalHr;
                    teamRecord.tournamentStats.rbi -= totalRbi;
                }
            } // (End of if (previousBattingStats))

            // (æŠ•æ‰‹æˆç¸¾ã®ãƒªã‚»ãƒƒãƒˆãƒ­ã‚¸ãƒƒã‚¯)
            const previousPitchingStats = match.details.pitching?.[teamKey];
            if (previousPitchingStats) {
                previousPitchingStats.forEach(prevGameStats => { 
                    const playerName = prevGameStats.name;
                    const careerStats = teamRecord.playerStats.pitching[playerName];
                    if (careerStats && prevGameStats && parseFloat(prevGameStats.innings) > 0) {
                        careerStats.games = (careerStats.games || 1) - 1;
                        if (prevGameStats.result === 'W') careerStats.w--;
                        if (prevGameStats.result === 'L') careerStats.l--;
                        careerStats.ip -= parseFloat(prevGameStats.innings || 0);
                        careerStats.so -= parseInt(prevGameStats.strikeouts || 0);
                        careerStats.er -= parseInt(prevGameStats.earnedRuns || 0);
                    }
                });
            }
        } // â˜…â˜…â˜… (End of teamKey loop) â˜…â˜…â˜…
          // (â†‘â†‘â†‘ å‰å›ã“ã® } ãŒæ¬ è½ã—ã¦ã„ã¾ã—ãŸ)
    }
    // --- (ãƒªã‚»ãƒƒãƒˆå‡¦ç† ã“ã“ã¾ã§) ---

    // --- 2. æ–°ã—ã„è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ ---
    const details = { 
        inningScore: { team1: [], team2: [] }, 
        batting: { team1: [], team2: [] }, 
        pitching: { team1: [], team2: [] }, 
        fielding: { team1: [], team2: [] },
        playerGameStats: { team1: {}, team2: {} },
        positionChanges: match.details?.positionChanges || []
    };

    
    // --- 3. ç”»é¢ã‹ã‚‰å…¥åŠ›ã•ã‚ŒãŸå€¤ã‚’èª­ã¿å–ã‚Šã€æˆç¸¾ã‚’å†è¨ˆç®—ãƒ»åŠ ç®— ---
    const scoreTable = document.getElementById('inning-score-table');
    if (scoreTable) {
        const rows = scoreTable.querySelectorAll('tbody tr');
        const team1Row = Array.from(rows).find(row => row.querySelector('th')?.textContent.trim() === match.team1);
        const team2Row = Array.from(rows).find(row => row.querySelector('th')?.textContent.trim() === match.team2);
        if (team1Row) details.inningScore.team1 = Array.from(team1Row.querySelectorAll('input')).map(input => parseInt(input.value) || 0);
        if (team2Row) details.inningScore.team2 = Array.from(team2Row.querySelectorAll('input')).map(input => parseInt(input.value) || 0);
    }
    match.score1 = details.inningScore.team1.reduce((sum, score) => sum + score, 0);
    match.score2 = details.inningScore.team2.reduce((sum, score) => sum + score, 0);

    for (const teamKey of ['team1', 'team2']) {
        const teamName = match[teamKey];
        const teamRecord = tournamentState.teamRecords[teamName];
        if (!teamRecord) continue;
        if (!teamRecord.playerStats) teamRecord.playerStats = { batting: {}, pitching: {} };
        if (!teamRecord.tournamentStats) teamRecord.tournamentStats = { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0 };


        const battingTable = document.getElementById(`batting-table-${teamKey}`);
        if (battingTable) {
            battingTable.querySelectorAll('tbody tr').forEach(row => {
                const nameInput = row.querySelector('.player-name');
                if (nameInput && nameInput.value.trim() !== '') {
                    
                    const resultCells = Array.from(row.querySelectorAll('td.col-inning'));
                    const results = resultCells.map(cell => {
                        const atBatBlocks = Array.from(cell.querySelectorAll('.at-bat-block'));
                        
                        const atBatsString = atBatBlocks.map(block => {
                            const container = block.querySelector('.batting-result-container');
                            if (!container) return ''; 

                            const resultType = container.querySelector('.result-type').value;
                            const direction = container.querySelector('.result-direction').value;
                            const rbi = container.querySelector('.result-rbi').value;
                            const runnerPlay = container.querySelector('.result-runner-play').value;
                            const strength = container.querySelector('.result-strength').value; 
                            
                            const markBtn = block.querySelector('.mark-at-bat-btn');
                            const mark = (markBtn && markBtn.dataset.marked === 'true') ? 'â˜…:' : ''; 
                            
                            const batterPlay = [mark, strength, direction, resultType, rbi, runnerPlay].filter(Boolean).join('');
                           
                            const runnerPlays = Array.from(block.querySelectorAll('.runner-play-input')).map(rpContainer => {
                                const name = rpContainer.querySelector('.runner-name').value;
                                const play = rpContainer.querySelector('.runner-play').value;
                                const base = rpContainer.querySelector('.runner-base').value;
                                if (!name || !play) return '';
                                return [name, play, base].filter(Boolean).join(' ');
                            }).filter(Boolean).join(','); 
                            
                            return [batterPlay, runnerPlays].filter(Boolean).join(';');
                        }).join('ã€');

                        return atBatsString;
                    });
                    
                    const playerData = {
                        order: row.dataset.order, name: nameInput.value.trim(),
                        number: row.querySelector('.player-number').value,
                        throwBat: row.querySelector('.player-throw-bat')?.value,
                        pos: row.querySelector('.player-pos').value,
                        sub_type: row.querySelector('.sub-type-select') ? row.querySelector('.sub-type-select').value : null,
                        results: results
                    };
                    details.batting[teamKey].push(playerData);
                    
                    const playerName = playerData.name;
                    if (!teamRecord.playerStats.batting[playerName]) {
                        teamRecord.playerStats.batting[playerName] = { games: 0, pa: 0, ab: 0, h: 0, hr: 0, rbi: 0 };
                    }
                    const careerStats = teamRecord.playerStats.batting[playerName];
                    
                    const isNonBattingSub = playerData.sub_type === 'DEF' || playerData.sub_type === 'PR';

                    const gameStats = { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0, played: false, strongHits: 0, weakHits: 0, strongOuts: 0, weakOuts: 0 };

                    playerData.results.forEach(inningResultString => {
                        if (!inningResultString) return;
                        inningResultString.split('ã€').forEach(atBatString => {
                            if (!atBatString) return;
                            
                            const [batterPlay] = atBatString.split(';');
                            if (!batterPlay) return;
                            
                            let strength = 'N'; 
                            let cleanBatterPlay = batterPlay;

                            if (cleanBatterPlay.startsWith('â˜…:')) {
                                cleanBatterPlay = cleanBatterPlay.substring(3); 
                            }
                            if (cleanBatterPlay.startsWith('S:')) {
                                strength = 'S'; 
                                cleanBatterPlay = cleanBatterPlay.substring(2);
                            } else if (cleanBatterPlay.startsWith('W:')) {
                                strength = 'W'; 
                                cleanBatterPlay = cleanBatterPlay.substring(2);
                            }
                            
                            const isHit = ['å®‰', 'äºŒå¡æ‰“', 'ä¸‰å¡æ‰“', 'æœ¬å¡æ‰“'].some(w => cleanBatterPlay.includes(w));
                            const isOut = ['ä¸‰æŒ¯', 'ã‚´ãƒ­', 'é£›', 'é‚ª', 'ç›´', 'ä½µæ®º', 'çŠ '].some(w => cleanBatterPlay.includes(w));

                            if (isHit && strength === 'S') gameStats.strongHits++;
                            if (isHit && strength === 'W') gameStats.weakHits++;
                            if (isOut && strength === 'S') gameStats.strongOuts++;
                            if (isOut && strength === 'W') gameStats.weakOuts++;

                            gameStats.played = true; 
                            gameStats.pa++;
                            
                            // â˜…â˜…â˜… ã“ã“ãŒæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã®ã‚ã£ãŸè¡Œã§ã™ â˜…â˜…â˜…
                            if (!cleanBatterPlay.includes('å››çƒ') && !cleanBatterPlay.includes('æ­»çƒ') && !cleanBatterPlay.includes('æ•¬é ') && !cleanBatterPlay.includes('çŠ ')) {
                            // â˜…â˜…â˜…
                                gameStats.ab++; 
                            }
                            
                            if (isHit) gameStats.h++; 
                            if (cleanBatterPlay.includes('æœ¬')) gameStats.hr++;
                            if (cleanBatterPlay.includes('ç‚¹')) {
                                const rbiMatch = cleanBatterPlay.match(/(\d+)ç‚¹/);
                                gameStats.rbi += rbiMatch ? parseInt(rbiMatch[1]) : 1;
                            }
                        });
                    });
                    
                    if(gameStats.played || isNonBattingSub) { 
                        careerStats.games++;
                    }
                    careerStats.pa += gameStats.pa;
                    careerStats.ab += gameStats.ab;
                    careerStats.h += gameStats.h;
                    careerStats.hr += gameStats.hr;
                    careerStats.rbi += gameStats.rbi;

                    if (teamRecord.tournamentStats) {
                        if(gameStats.played || isNonBattingSub) teamRecord.tournamentStats.games = (teamRecord.tournamentStats.games || 0) + 1;
                        teamRecord.tournamentStats.pa += gameStats.pa;
                        teamRecord.tournamentStats.ab += gameStats.ab;
                        teamRecord.tournamentStats.h += gameStats.h;
                        teamRecord.tournamentStats.hr += gameStats.hr;
                        teamRecord.tournamentStats.rbi += gameStats.rbi;
                    }
                    
                    details.playerGameStats[teamKey][playerName] = gameStats;
                }
            });
        }

        
        const pitchingTable = document.getElementById(`pitching-table-${teamKey}`);
        if (pitchingTable) {
            pitchingTable.querySelectorAll('tbody tr').forEach(row => {
                const pitcherName = row.querySelector('.pitcher-name')?.value.trim(); 
                
                if (pitcherName && pitcherName !== '') {
                    const pitcherData = {
                        result: row.querySelector('.pitcher-result').value,
                        name: pitcherName, 
                        throwBat: row.querySelector('.pitcher-throw-bat').value,
                        throwStyle: row.querySelector('.pitcher-throw-style').value,
                        pitcherType: row.querySelector('.pitcher-type').value,
                        velocity: row.querySelector('.pitcher-velocity').value,
                        innings: row.querySelector('.pitcher-innings').value,
                        battersFaced: row.querySelector('.pitcher-batters').value,
                        pitches: row.querySelector('.pitcher-pitches').value,
                        hits: row.querySelector('.pitcher-hits').value,
                        strikeouts: row.querySelector('.pitcher-so').value,
                        walks: row.querySelector('.pitcher-walks').value,
                        runs: row.querySelector('.pitcher-runs').value,
                        earnedRuns: row.querySelector('.pitcher-er').value,
                    };
                    details.pitching[teamKey].push(pitcherData);

                    if (!teamRecord.playerStats.pitching[pitcherName]) {
                        teamRecord.playerStats.pitching[pitcherName] = { games: 0, w: 0, l: 0, ip: 0, so: 0, er: 0 };
                    }
                    const careerStats = teamRecord.playerStats.pitching[pitcherName];
                    
                    if (pitcherData.battersFaced && parseInt(pitcherData.battersFaced) > 0) {
                        careerStats.games = (careerStats.games || 0) + 1;
                        if (pitcherData.result === 'W') careerStats.w++;
                        if (pitcherData.result === 'L') careerStats.l--;
                        careerStats.ip += parseFloat(pitcherData.innings) || 0;
                        careerStats.so += parseInt(pitcherData.strikeouts) || 0;
                        careerStats.er += parseInt(pitcherData.earnedRuns) || 0;
                    }
                }
            });
        }
    }

    for (const teamKey of ['team1', 'team2']) {
        const fieldingTable = document.getElementById(`fielding-table-${teamKey}`);
        if (fieldingTable) {
            fieldingTable.querySelectorAll('tbody tr').forEach(row => {
                const inning = row.querySelector('.fielding-inning')?.value;
                const player = row.querySelector('.player-name')?.value;
                const play = row.querySelector('.fielding-play')?.value;
                
                if (player && play) { 
                    details.fielding[teamKey].push({
                        inning: inning ? parseInt(inning) : null,
                        player: player,
                        play: play
                    });
                }
            });
        }
    }

    match.details = details;
    
    saveState();
    detailsModal.classList.add('hidden');
    renderTournament(tournamentState);
    alert('è©³ç´°ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
}


/**
     * ã€ä¿®æ­£ç‰ˆã€‘ã‚¹ã‚­ãƒƒãƒ—æ©Ÿèƒ½é–¢é€£
     */
    function generateAutoScore(rankWinner, rankLoser) {
        const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
        const diff = rankValues[rankWinner] - rankValues[rankLoser];
        let winnerScore, loserScore;

        if (diff >= 3) { // å¤§å·®
            winnerScore = 7 + Math.floor(Math.random() * 4);
            loserScore = Math.floor(Math.random() * 3);
        } else if (diff >= 2) { // ä¸­å·®
            winnerScore = 5 + Math.floor(Math.random() * 3);
            loserScore = Math.max(0, winnerScore - (3 + Math.floor(Math.random() * 2)));
        } else if (diff >= 1) { // å°å·®
            winnerScore = 3 + Math.floor(Math.random() * 4);
            loserScore = Math.max(0, winnerScore - (1 + Math.floor(Math.random() * 2)));
        } else { // åŒãƒ©ãƒ³ã‚¯
            winnerScore = 2 + Math.floor(Math.random() * 5);
            loserScore = winnerScore - 1;
        }
        return [winnerScore, loserScore];
    }

    /**
     * ã€ä¿®æ­£ç‰ˆã€‘ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’è‡ªå‹•ã§ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
     */
    async function skipRound(roundNumber) {
        const btnId = `skip-r${roundNumber}-btn`;
        const btn = document.getElementById(btnId);
        if (btn) btn.disabled = true;

        const matchIds = [];
        const numMatchesInRoundSide = (tournamentState.teams.length / 2) / Math.pow(2, roundNumber - 1);

        ['L', 'R'].forEach(side => {
            for (let i = 1; i <= numMatchesInRoundSide; i++) {
                matchIds.push(`${side}-R${roundNumber}-M${i}`);
            }
        });

        const results = []; // ã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®çµæœã‚’æ ¼ç´ã™ã‚‹é…åˆ—

        // ã‚¹ãƒ†ãƒƒãƒ—1ï¼šãƒ©ã‚¦ãƒ³ãƒ‰ã®å…¨è©¦åˆã®å‹æ•—ã‚’æ±ºå®š
        for (const matchId of matchIds) {
            const match = tournamentState.matches[matchId];
            if (!match || match.winner || !match.team1 || !match.team2) continue;

            const { team1, team2 } = match;
            const rank1 = calculateRank(team1, tournamentState);
            const rank2 = calculateRank(team2, tournamentState);
            const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
            let winnerName, loserName;
            
            const upsetChance = 0.15 - (Math.abs(rankValues[rank1] - rankValues[rank2]) * 0.03);

            if (Math.random() < upsetChance) { // ç•ªç‹‚ã‚ã›
                winnerName = rankValues[rank1] < rankValues[rank2] ? team1 : team2;
            } else { // é †å½“
                winnerName = rankValues[rank1] >= rankValues[rank2] ? team1 : team2;
            }
            loserName = winnerName === team1 ? team2 : team1;
            
            const winnerRank = calculateRank(winnerName, tournamentState);
            const loserRank = calculateRank(loserName, tournamentState);

            const [winnerScore, loserScore] = generateAutoScore(winnerRank, loserRank);
            match.score1 = (match.team1 === winnerName) ? winnerScore : loserScore;
            match.score2 = (match.team2 === winnerName) ? winnerScore : loserScore;
            match.winner = winnerName;
            
            if (tournamentState.teamRecords[winnerName]) tournamentState.teamRecords[winnerName].wins++;
            if (tournamentState.teamRecords[loserName]) tournamentState.teamRecords[loserName].losses++;
            
            // ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆè¨˜äº‹ç”¨ã«çµæœã‚’ä¿å­˜
            results.push({ winnerName, loserName, winnerScore, loserScore, rankDiff: Math.abs(rankValues[rank1] - rankValues[rank2]) });
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—2ï¼šå‹è€…ã‚’æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚ã‚‹
        const nextRoundNum = roundNumber + 1;
        const numTeams = tournamentState.teams.length;
        const finalRound = Math.log2(numTeams);

        if (nextRoundNum <= finalRound) {
            const numMatchesInNextRoundSide = numTeams / 2 / Math.pow(2, nextRoundNum - 1);
            for (const side of ['L', 'R']) {
                if (nextRoundNum < finalRound) {
                    for (let m = 1; m <= numMatchesInNextRoundSide; m++) {
                        const prevMatch1Id = `${side}-R${roundNumber}-M${(m * 2) - 1}`;
                        const prevMatch2Id = `${side}-R${roundNumber}-M${m * 2}`;
                        const winner1 = tournamentState.matches[prevMatch1Id]?.winner;
                        const winner2 = tournamentState.matches[prevMatch2Id]?.winner;
                        const nextMatchId = `${side}-R${nextRoundNum}-M${m}`;
                        
                        if (!tournamentState.matches[nextMatchId]) {
                            tournamentState.matches[nextMatchId] = { id: nextMatchId, team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '' };
                        }
                        tournamentState.matches[nextMatchId].team1 = winner1;
                        tournamentState.matches[nextMatchId].team2 = winner2;
                    }
                } else { // æ±ºå‹æˆ¦ã¸ã®é€²å‡ºå‡¦ç†
                    const finalMatchId = 'F-R1-M1';
                    if (!tournamentState.matches[finalMatchId]) {
                         tournamentState.matches[finalMatchId] = { id: finalMatchId, team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '' };
                    }
                    const semiFinalWinner = tournamentState.matches[`${side}-R${roundNumber}-M1`]?.winner;
                    if (side === 'L') tournamentState.matches[finalMatchId].team1 = semiFinalWinner;
                    if (side === 'R') tournamentState.matches[finalMatchId].team2 = semiFinalWinner;
                }
            }
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—3ï¼šUIã®æ›´æ–°ã¨ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆè¨˜äº‹ã®ç”Ÿæˆ
        renderTournament(tournamentState);
        newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒ${roundNumber}å›æˆ¦ã®ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆè¨˜äº‹ã‚’åŸ·ç­†ä¸­...</div>`;

        const summaryArticle = await generateSkipRoundSummaryArticle(roundNumber, results);
        if (summaryArticle) {
            tournamentState.news.push(summaryArticle);
        }
        
        renderNews(tournamentState.news);
        saveState();
        if (btn) btn.classList.add('hidden');
    }
// --- NEW Autumn Tournament System ---

    /**
 * [ç§‹å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸1] åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸ã‚’é–‹å§‹ã™ã‚‹ï¼ˆä¼Šè±†åœ°åŒºè¿½åŠ ãƒ»æœ€çµ‚ç‰ˆï¼‰
 */
/**
 * [ç§‹å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸1] åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸ã‚’é–‹å§‹ã™ã‚‹ï¼ˆä¼Šè±†åœ°åŒºè¿½åŠ ãƒ»æœ€çµ‚ç‰ˆï¼‰
 */
async function setupAutumnRegionalBlocks() {
    tournamentState.autumnPhase = 'regional_blocks';
    
    const teamsByRegion = { 'æ±éƒ¨': [], 'ä¸­éƒ¨': [], 'è¥¿éƒ¨': [], 'ä¼Šè±†': [] };
    INITIAL_TEAM_POOL.forEach(teamName => {
        const region = TEAM_DATA[teamName]?.region;
        if (region) teamsByRegion[region].push(teamName);
    });

    // ä¸»è¦3åœ°åŒºã®ãƒ–ãƒ­ãƒƒã‚¯åˆ†ã‘
    ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨'].forEach(region => {
        let regionalTeams = shuffleArray(teamsByRegion[region]);
        const blocks = [];
        for (let i = 0; i < 4; i++) { // 4ãƒ–ãƒ­ãƒƒã‚¯ä½œæˆ
            const blockTeams = regionalTeams.splice(0, 5); // 5ãƒãƒ¼ãƒ ãšã¤
            if (blockTeams.length === 0) continue;

            const blockId = `${region}-B${i+1}`;
            
            const playInMatchId = `${blockId}-R0-M1`;
            const semi1Id = `${blockId}-R1-M1`;
            const semi2Id = `${blockId}-R1-M2`;
            const finalId = `${blockId}-R2-M1`;

            const matches = {
                [playInMatchId]: { id: playInMatchId, team1: blockTeams[0], team2: blockTeams[1], winner: null, score1: '', score2: '', summary: '' },
                [semi1Id]: { id: semi1Id, team1: null, team2: blockTeams[2], winner: null, score1: '', score2: '', summary: '' },
                [semi2Id]: { id: semi2Id, team1: blockTeams[3], team2: blockTeams[4], winner: null, score1: '', score2: '', summary: '' },
                [finalId]: { id: finalId, team1: null, team2: null, winner: null, score1: '', score2: '', summary: '' }
            };
            blocks.push({ id: blockId, teams: blockTeams, matches });
        }
        tournamentState.autumnData.regions[region].blocks = blocks;
    });

    // ä¼Šè±†åœ°åŒºã®4ãƒãƒ¼ãƒ ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
    const izuTeams = shuffleArray(teamsByRegion['ä¼Šè±†']);
    const izuBracketId = 'ä¼Šè±†-AUTUMN';
    const izuMatches = {
        [`${izuBracketId}-R1-M1`]: { id: `${izuBracketId}-R1-M1`, team1: izuTeams[0], team2: izuTeams[1], winner: null, score1: '', score2: '' },
        [`${izuBracketId}-R1-M2`]: { id: `${izuBracketId}-R1-M2`, team1: izuTeams[2], team2: izuTeams[3], winner: null, score1: '', score2: '' },
        [`${izuBracketId}-R2-M1`]: { id: `${izuBracketId}-R2-M1`, team1: null, team2: null, winner: null, score1: '', score2: '' } // æ±ºå‹
    };
    tournamentState.autumnData.regions['ä¼Šè±†'].izuBracket = {
        id: izuBracketId,
        teams: izuTeams,
        matches: izuMatches
    };

    renderTournament(tournamentState);
    saveState();
}
   
/**
 * [ç§‹å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸1 UI] åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸ã‚’æç”»ã™ã‚‹ï¼ˆä¼Šè±†åœ°åŒºè¿½åŠ ãƒ»æœ€çµ‚ç‰ˆï¼‰
 */
function renderAutumnRegionalBlocks() {
    let html = `<h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ç§‹å­£å¤§ä¼š åœ°åŒºäºˆé¸</h2>`;
    html += '<div class="space-y-8">';

    // æ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨ã®æç”»
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.autumnData.regions[region];
        if (!regionData.blocks) continue;

        html += `
            <div class="p-4 border-2 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2 text-purple-700">${region}åœ°åŒº (5æ )</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${regionData.blocks.map(block => `
                        <div class="p-3 border rounded-lg bg-gray-50">
                            <h4 class="font-bold text-center mb-2">ãƒ–ãƒ­ãƒƒã‚¯ ${block.id.split('-')[1]}</h4>
                            ${create5TeamBlockHTML(block)}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // ä¼Šè±†åœ°åŒºã®æç”»
    const izuData = tournamentState.autumnData.regions['ä¼Šè±†'];
    if (izuData && izuData.izuBracket) {
        html += `
            <div class="p-4 border-2 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2 text-purple-700">ä¼Šè±†åœ°åŒº (1æ )</h3>
                <div class="flex justify-center">
                    ${create4TeamBlockHTML(izuData.izuBracket)}
                </div>
            </div>
        `;
    }

    html += '</div>';
    autumnRegionalContainer.innerHTML = html;
    checkAutumnRegionalBlocksComplete();
}

    /**
     * 5ãƒãƒ¼ãƒ æ§‹æˆã®ãƒ–ãƒ­ãƒƒã‚¯ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆHTMLã‚’ç”Ÿæˆã™ã‚‹
     * @param {object} blockData - å¯¾è±¡ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ‡ãƒ¼ã‚¿
     */
    // ã€ä¿®æ­£å¯¾è±¡2ã€‘
function create5TeamBlockHTML(blockData) {
    const { id, matches } = blockData;
    const playIn = matches[`${id}-R0-M1`];
    const semi1 = matches[`${id}-R1-M1`];
    const semi2 = matches[`${id}-R1-M2`];
    const final = matches[`${id}-R2-M1`];

    // è©¦åˆã®é€²è¡ŒçŠ¶æ³ã‚’æ›´æ–°
    semi1.team1 = playIn.winner;
    final.team1 = semi1.winner;
    final.team2 = semi2.winner;

    return `
        <div class="flex items-center justify-center space-x-2 text-xs">
            <div class="flex flex-col justify-around h-full space-y-4">
                <div class="w-40">${createMatchHTML(playIn.id, playIn.team1, playIn.team2, playIn, [])}</div>
                <div class="w-40">${createMatchHTML(semi2.id, semi2.team1, semi2.team2, semi2, [])}</div>
            </div>
            <div class="flex flex-col justify-center h-full w-40">
                ${createMatchHTML(semi1.id, semi1.team1, semi1.team2, semi1, [])}
            </div>
            <div class="flex flex-col justify-center h-full w-40">
                ${createMatchHTML(final.id, final.team1, final.team2, final, [])}
            </div>
        </div>
    `;
}

    /**
     * [ç§‹å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸2] åœ°åŒºå†…é †ä½æ±ºå®šæˆ¦ã‚’é–‹å§‹ã™ã‚‹
     */
    async function setupAutumnRankingTournaments() {
    tournamentState.autumnPhase = 'regional_ranking';

    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.autumnData.regions[region];
        
        // é‡è¦ãªå¤‰æ›´ï¼šä¸Šä½æ ¡ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã¯å»ƒæ­¢ã—ã€æ•—è€…å¾©æ´»æˆ¦ã®ã¿ã‚’è¡Œã†
        regionData.champBracket = null; // ä¸è¦ã«ãªã£ãŸã®ã§ã‚¯ãƒªã‚¢

        // ãƒ–ãƒ­ãƒƒã‚¯æº–å„ªå‹ã—ãŸãƒãƒ¼ãƒ ã§ã€ç¬¬5ä»£è¡¨æ±ºå®šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’çµ„ã‚€
        const repechageBracketId = `${region}-REP`;
        const repTeams = shuffleArray(regionData.blockRunnersUp);
        regionData.repechageBracket = {
            id: repechageBracketId,
            teams: repTeams,
            matches: {
                [`${repechageBracketId}-R1-M1`]: { id: `${repechageBracketId}-R1-M1`, team1: repTeams[0], team2: repTeams[1], winner: null, score1: '', score2: '', summary: '' },
                [`${repechageBracketId}-R1-M2`]: { id: `${repechageBracketId}-R1-M2`, team1: repTeams[2], team2: repTeams[3], winner: null, score1: '', score2: '', summary: '' },
                [`${repechageBracketId}-R2-M1`]: { id: `${repechageBracketId}-R2-M1`, team1: null, team2: null, winner: null, score1: '', score2: '', summary: '' } // 5ä½æ±ºå®šæˆ¦
            }
        };
    }
    
    renderTournament(tournamentState);
    saveState();
}
    /**
     * [ç§‹å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸2 UI] åœ°åŒºå†…é †ä½æ±ºå®šæˆ¦ã‚’æç”»ã™ã‚‹
     */
   // ã€ä¿®æ­£å¯¾è±¡3ã€‘
function renderAutumnRankingTournaments() {
    let html = `<h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ç§‹å­£å¤§ä¼š åœ°åŒº ç¬¬5ä»£è¡¨æ±ºå®šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ</h2>`;
    html += '<div class="space-y-8">';
    
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.autumnData.regions[region];
        if (!regionData.repechageBracket) continue;

        const rep = regionData.repechageBracket;
        
        const repSemi1 = rep.matches[`${rep.id}-R1-M1`];
        const repSemi2 = rep.matches[`${rep.id}-R1-M2`];
        rep.matches[`${rep.id}-R2-M1`].team1 = repSemi1.winner;
        rep.matches[`${rep.id}-R2-M1`].team2 = repSemi2.winner;
        
        html += `
            <div class="p-4 border-2 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2 text-purple-700">${region}åœ°åŒº</h3>
                <div class="flex items-center justify-center space-x-4">
                    <div class="space-y-4">
                        ${createMatchHTML(repSemi1.id, repSemi1.team1, repSemi1.team2, repSemi1, [])}
                        
                        ${createMatchHTML(repSemi2.id, repSemi2.team1, repSemi2.team2, repSemi2, [])}
                        </div>
                    <div>
                        <p class="text-center font-semibold">ä»£è¡¨æ±ºå®šæˆ¦</p>
                        ${createMatchHTML(rep.matches[`${rep.id}-R2-M1`].id, rep.matches[`${rep.id}-R2-M1`].team1, rep.matches[`${rep.id}-R2-M1`].team2, rep.matches[`${rep.id}-R2-M1`], [])}
                    </div>
                </div>
            </div>
        `;
    }
    html += '</div>';
    autumnRankingContainer.innerHTML = html;
    checkAutumnRankingTournamentsComplete();
}
    /**
     * [ç§‹å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸3] çœŒå¤§ä¼šæœ¬æˆ¦ã‚’é–‹å§‹ã™ã‚‹
     */
   // ã€ä¿®æ­£å¯¾è±¡4ã€‘
/**
 * [ç§‹å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸3] çœŒå¤§ä¼šæœ¬æˆ¦ã‚’é–‹å§‹ã™ã‚‹ï¼ˆçµ„ã¿åˆã‚ã›ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ã—ãŸå®Œå…¨ç‰ˆï¼‰
 */
async function setupAutumnMainTournament() {
    tournamentState.autumnPhase = 'main';
    tournamentState.is16team = true;

    // --- ä»£è¡¨ãƒãƒ¼ãƒ ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ ---
    const finalReps = [];
    // 1. ä¼Šè±†åœ°åŒºã®ä»£è¡¨
    const izuWinner = tournamentState.autumnData.regions['ä¼Šè±†'].finalReps[0];
    if (izuWinner) finalReps.push(izuWinner.team);

    // 2. ä¸»è¦3åœ°åŒºã®ä»£è¡¨
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.autumnData.regions[region];
        // 2-1. ãƒ–ãƒ­ãƒƒã‚¯å„ªå‹ã—ãŸ4ãƒãƒ¼ãƒ 
        finalReps.push(...regionData.blockWinners);
        // 2-2. æ•—è€…å¾©æ´»æˆ¦ã‚’å‹ã¡ä¸ŠãŒã£ãŸ1ãƒãƒ¼ãƒ 
        const repFinal = regionData.repechageBracket.matches[`${region}-REP-R2-M1`];
        if (repFinal.winner) {
            finalReps.push(repFinal.winner);
        }
    }

    // --- ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ ---
    tournamentState.teams = shuffleArray(finalReps); // 16ãƒãƒ¼ãƒ ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    tournamentState.matches = {};
    tournamentState.seeds = []; //ç§‹å­£çœŒå¤§ä¼šã¯ã‚·ãƒ¼ãƒ‰ãªã—

    const round1Setup = tournamentState.teams.reduce((acc, team, i) => {
        if (i % 2 === 0) acc.push({ team1: team, team2: null });
        else acc[acc.length - 1].team2 = team;
        return acc;
    }, []);

    round1Setup.forEach((match, index) => {
        const side = index < 4 ? 'L' : 'R';
        const matchNum = index < 4 ? index + 1 : index - 3;
        const matchId = `${side}-R1-M${matchNum}`;
        tournamentState.matches[matchId] = { id: matchId, team1: match.team1, team2: match.team2, winner: null, score1: '', score2: '', details: null, summary: '' };
    });

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆ â–¼â–¼â–¼
    // --- å…¨ãƒ©ã‚¦ãƒ³ãƒ‰ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ (16ãƒãƒ¼ãƒ ãƒ»æ–°ãƒ«ãƒ¼ãƒ«ç‰ˆ) ---
    const finalRoundAutumn = 4;
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R1-')), 
        ["9/15", "9/16"], ROUND_3_STADIUMS, 2 // 1å›æˆ¦ (ä¸»è¦4çƒå ´) â€»3å›æˆ¦ç”¨çƒå ´ã‚’æµç”¨
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R2-')), 
        ["9/18"], FINAL_STAGE_STADIUMS, 4 // æº–ã€…æ±ºå‹ (è‰è–™ã§4è©¦åˆ)
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R3-')), 
        ["9/21"], FINAL_STAGE_STADIUMS, 2 // æº–æ±ºå‹ (è‰è–™ã§2è©¦åˆ)
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('F-R1-')), 
        ["9/23"], FINAL_STAGE_STADIUMS, 1 // æ±ºå‹ (è‰è–™ã§1è©¦åˆ)
    );
    // â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
    renderTournament(tournamentState);
    saveState();

    // --- è¨˜äº‹ç”Ÿæˆãªã©ã®å¾Œç¶šå‡¦ç† (å¤‰æ›´ãªã—) ---
    const currentTournamentName = "ç§‹å­£çœŒå¤§ä¼šæœ¬æˆ¦";
    newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒ${currentTournamentName}ã®å±•æœ›è¨˜äº‹ã‚’åŸ·ç­†ä¸­...</div>`;
    bbsCommentsContainer.innerHTML = `<div class="loader">AIãŒçµ„ã¿åˆã‚ã›ã‚’åˆ†æä¸­...</div>`;

    const [previewArticle, bracketComments] = await Promise.all([
        generateNewsArticle({ matchId: 'preview' }), // â˜…ç°¡æ˜“contextã‚’æ¸¡ã™
    generateBracketReactionComments(tournamentState)
]);
    if (previewArticle) tournamentState.news.unshift(previewArticle);
    if (bracketComments && bracketComments.length > 0) tournamentState.bbsComments.push(...bracketComments);
    
    renderNews(tournamentState.news);
    renderBbsComments(tournamentState.bbsComments);
    saveState();
}
    /**
     * ç§‹å­£åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸ãŒã™ã¹ã¦çµ‚äº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
     */
    function checkAutumnRegionalBlocksComplete() {
    let allBlocksFinished = true;
    // æ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨ã®ãƒã‚§ãƒƒã‚¯
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.autumnData.regions[region];
        if (!regionData.blocks || regionData.blocks.length === 0) {
            allBlocksFinished = false; break;
        }
        for (const block of regionData.blocks) {
            const finalMatch = block.matches[`${block.id}-R2-M1`];
            if (!finalMatch.winner) {
                allBlocksFinished = false; break;
            }
        }
        if (!allBlocksFinished) break;
    }

    // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ãŒä¿®æ­£ç®‡æ‰€ â–¼â–¼â–¼
    // ä¼Šè±†åœ°åŒºã®ãƒã‚§ãƒƒã‚¯
    if (allBlocksFinished) {
        const izuData = tournamentState.autumnData.regions['ä¼Šè±†'];
        if (!izuData.izuBracket || !izuData.izuBracket.matches[`ä¼Šè±†-AUTUMN-R2-M1`].winner) {
            allBlocksFinished = false;
        }
    }
    // â–²â–²â–²

    if (allBlocksFinished) {
        autumnControls.classList.remove('hidden');
        startRankingPlayoffsBtn.classList.remove('hidden');
    } else {
        autumnControls.classList.add('hidden');
        startRankingPlayoffsBtn.classList.add('hidden');
    }
}

    /**
     * ç§‹å­£åœ°åŒºå†…é †ä½æ±ºå®šæˆ¦ãŒã™ã¹ã¦çµ‚äº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
     */
    /**
     * ã€ä¿®æ­£ç‰ˆã€‘ç§‹å­£åœ°åŒºå†…é †ä½æ±ºå®šæˆ¦ãŒã™ã¹ã¦çµ‚äº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
     */
    function checkAutumnRankingTournamentsComplete() {
    let allRankingsFinished = true;
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.autumnData.regions[region];
        if (!regionData.repechageBracket) {
            allRankingsFinished = false;
            break;
        }

        const repechageFinal = regionData.repechageBracket.matches[`${region}-REP-R2-M1`]; // 5ä½æ±ºå®šæˆ¦

        // æ•—è€…å¾©æ´»æˆ¦ã®æ±ºå‹ãŒã™ã¹ã¦çµ‚ã‚ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (!repechageFinal.winner) {
            allRankingsFinished = false;
            break;
        }
    }
    
    if (allRankingsFinished) {
        autumnControls.classList.remove('hidden');
        startRankingPlayoffsBtn.classList.add('hidden');
        startMainTournamentBtn.classList.remove('hidden');
    } else {
        autumnControls.classList.add('hidden');
        startMainTournamentBtn.classList.add('hidden');
    }
}
// --- NEW Spring Tournament System ---

/**
 * [æ˜¥å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸1] åœ°åŒºäºˆé¸ã‚’é–‹å§‹ã™ã‚‹ï¼ˆ3æ ¡ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆå¯¾å¿œãƒ»æœ€çµ‚ç‰ˆï¼‰
 */
async function setupSpringRegionalQualifiers() {
    tournamentState.springPhase = 'regional_qualifiers';
    const { qualifierTeams } = tournamentState.springData;

    const teamsByRegion = { 'æ±éƒ¨': [], 'ä¸­éƒ¨': [], 'è¥¿éƒ¨': [], 'ä¼Šè±†': [] };
    qualifierTeams.forEach(teamName => {
        const region = TEAM_DATA[teamName]?.region;
        if (region && teamsByRegion[region]) {
            teamsByRegion[region].push(teamName);
        }
    });
    
    // æ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨åœ°åŒºã®äºˆé¸è¨­å®š
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        let regionalTeams = shuffleArray(teamsByRegion[region]);
        const blockCount = 4;
        const regionBlocks = [];
        
        for (let i = 0; i < blockCount; i++) {
            const blockTeams = regionalTeams.splice(0, Math.ceil(regionalTeams.length / (blockCount - i)));
            if(blockTeams.length === 0) continue;
            
            const blockId = `${region}-SB${i+1}`; // Spring Block
            const blockMatches = {};
            
            // ãƒãƒ¼ãƒ æ•°ã«å¿œã˜ã¦ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆå½¢å¼ã‚’æ±ºå®š
            if (blockTeams.length <= 4) { // 4ãƒãƒ¼ãƒ ä»¥ä¸‹
                const semi1Id = `${blockId}-R1-M1`;
                const semi2Id = `${blockId}-R1-M2`;
                const finalId = `${blockId}-R2-M1`;
                Object.assign(blockMatches, {
                    [semi1Id]: { id: semi1Id, team1: blockTeams[0], team2: blockTeams[1], winner: null, score1: '', score2: '' },
                    [semi2Id]: { id: semi2Id, team1: blockTeams[2] || null, team2: blockTeams[3] || null, winner: null, score1: '', score2: '' },
                    [finalId]: { id: finalId, team1: null, team2: null, winner: null, score1: '', score2: '' }
                });
            } else { // 5ãƒãƒ¼ãƒ 
                 const playInMatchId = `${blockId}-R0-M1`;
                 const semi1Id = `${blockId}-R1-M1`;
                 const semi2Id = `${blockId}-R1-M2`;
                 const finalId = `${blockId}-R2-M1`;
                 Object.assign(blockMatches, {
                    [playInMatchId]: { id: playInMatchId, team1: blockTeams[0], team2: blockTeams[1], winner: null, score1: '', score2: '' },
                    [semi1Id]: { id: semi1Id, team1: null, team2: blockTeams[2], winner: null, score1: '', score2: '' },
                    [semi2Id]: { id: semi2Id, team1: blockTeams[3], team2: blockTeams[4], winner: null, score1: '', score2: '' },
                    [finalId]: { id: finalId, team1: null, team2: null, winner: null, score1: '', score2: '' }
                 });
            }
            regionBlocks.push({ id: blockId, teams: blockTeams, matches: blockMatches });
            Object.assign(tournamentState.springData.allMatches, blockMatches);
        }
        tournamentState.springData.regions[region].blocks = regionBlocks;

        // ç¬¬5ä»£è¡¨æ±ºå®šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®å™¨ã‚’æº–å‚™
        const repBracketId = `${region}-SREP`;
        tournamentState.springData.regions[region].repechageBracket = {
            id: repBracketId,
            teams: [], // ãƒ–ãƒ­ãƒƒã‚¯æº–å„ªå‹æ ¡ãŒã“ã“ã«å…¥ã‚‹
            matches: {
                [`${repBracketId}-R1-M1`]: { id: `${repBracketId}-R1-M1`, team1: null, team2: null, winner: null, score1: '', score2: '' },
                [`${repBracketId}-R1-M2`]: { id: `${repBracketId}-R1-M2`, team1: null, team2: null, winner: null, score1: '', score2: '' },
                [`${repBracketId}-R2-M1`]: { id: `${repBracketId}-R2-M1`, team1: null, team2: null, winner: null, score1: '', score2: '' }
            }
        };
        Object.assign(tournamentState.springData.allMatches, tournamentState.springData.regions[region].repechageBracket.matches);
    }
    
    // ä¼Šè±†åœ°åŒºã®äºˆé¸è¨­å®š
    const izuTeams = shuffleArray(teamsByRegion['ä¼Šè±†']);
    const izuBracketId = 'ä¼Šè±†-SIZU'; // IDã‚’'SIZU'ã«å¤‰æ›´
    const izuBracket = { id: izuBracketId, teams: izuTeams, matches: {} };

    if (izuTeams.length === 3) {
        // --- 3æ ¡ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®å ´åˆ ---
        const semiId = `${izuBracketId}-R1-M1`;
        const finalId = `${izuBracketId}-R2-M1`;
        // 1ãƒãƒ¼ãƒ ãŒä¸æˆ¦å‹ï¼ˆbyeï¼‰ã§æ±ºå‹ã¸
        Object.assign(izuBracket.matches, {
            [semiId]: { id: semiId, team1: izuTeams[0], team2: izuTeams[1], winner: null, score1: '', score2: '' },
            [finalId]: { id: finalId, team1: null, team2: izuTeams[2], winner: null, score1: '', score2: '' }
        });
    } else if (izuTeams.length >= 2) {
        // --- 4æ ¡ï¼ˆã¾ãŸã¯2æ ¡ï¼‰ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®å ´åˆ ---
        const semi1Id = `${izuBracketId}-R1-M1`;
        const semi2Id = `${izuBracketId}-R1-M2`;
        const finalId = `${izuBracketId}-R2-M1`;
        Object.assign(izuBracket.matches, {
            [semi1Id]: { id: semi1Id, team1: izuTeams[0], team2: izuTeams[1], winner: null, score1: '', score2: '' },
            [semi2Id]: { id: semi2Id, team1: izuTeams[2] || null, team2: izuTeams[3] || null, winner: null, score1: '', score2: '' },
            [finalId]: { id: finalId, team1: null, team2: null, winner: null, score1: '', score2: '' }
        });
    }
    tournamentState.springData.regions['ä¼Šè±†'].izuBracket = izuBracket;
    Object.assign(tournamentState.springData.allMatches, izuBracket.matches);

    renderTournament(tournamentState);
    saveState();
}

/**
 * [æ˜¥å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸1 UI] åœ°åŒºäºˆé¸ã‚’æç”»ã™ã‚‹
 */
function renderSpringRegionalQualifiers() {
    let html = `<h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">æ˜¥å­£å¤§ä¼š åœ°åŒºäºˆé¸</h2>`;
    html += '<div class="space-y-8">';

    // æ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.springData.regions[region];
        if (!regionData.blocks) continue;

        html += `
            <div class="p-4 border-2 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2 text-green-700">${region}åœ°åŒº (5æ )</h3>
                <h4 class="font-bold text-center text-lg mb-2">ä»£è¡¨æ±ºå®šãƒ–ãƒ­ãƒƒã‚¯</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    ${regionData.blocks.map(block => `
                        <div class="p-3 border rounded-lg bg-gray-50">
                            <h4 class="font-bold text-center mb-2">ãƒ–ãƒ­ãƒƒã‚¯ ${block.id.split('-')[1].slice(1)}</h4>
                            ${block.teams.length <= 4 ? create4TeamBlockHTML(block) : create5TeamBlockHTML(block)}
                        </div>
                    `).join('')}
                </div>
                <h4 class="font-bold text-center text-lg mb-2">ç¬¬5ä»£è¡¨æ±ºå®šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ</h4>
                <div class="flex justify-center">
                   ${create4TeamBlockHTML(regionData.repechageBracket, true)}
                </div>
            </div>
        `;
    }

    // ä¼Šè±†
    const izuData = tournamentState.springData.regions['ä¼Šè±†'];
    if (izuData.izuBracket) {
        html += `
            <div class="p-4 border-2 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2 text-green-700">ä¼Šè±†åœ°åŒº (1æ )</h3>
                <div class="flex justify-center">
                    ${create4TeamBlockHTML(izuData.izuBracket)}
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    autumnRegionalContainer.innerHTML = html; // ç§‹ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’æµç”¨
    checkSpringQualifiersComplete();
}

/**
 * 4ãƒãƒ¼ãƒ æ§‹æˆã®ãƒ–ãƒ­ãƒƒã‚¯ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆHTMLã‚’ç”Ÿæˆã™ã‚‹
 */
function create4TeamBlockHTML(blockData, isRepechage = false) {
    if (!blockData || !blockData.matches) return '<div></div>';
    const { id, matches } = blockData;
    const semi1 = matches[`${id}-R1-M1`];
    const semi2 = matches[`${id}-R1-M2`];
    const final = matches[`${id}-R2-M1`];
    if (!semi1 || !semi2 || !final) return '<div></div>';

    // è©¦åˆã®é€²è¡ŒçŠ¶æ³ã‚’æ›´æ–°
    final.team1 = semi1.winner;
    final.team2 = semi2.winner;

    const placeholder = isRepechage ? 'ãƒ–ãƒ­ãƒƒã‚¯æº–å„ªå‹æ ¡' : '---';

    return `
        <div class="flex items-center justify-center space-x-2 text-xs">
            <div class="space-y-4 w-40">
                ${createMatchHTML(semi1.id, semi1.team1 || placeholder, semi1.team2 || placeholder, semi1, [])}
                ${createMatchHTML(semi2.id, semi2.team1 || placeholder, semi2.team2 || placeholder, semi2, [])}
            </div>
            <div class="w-40">
                ${createMatchHTML(final.id, final.team1, final.team2, final, [])}
            </div>
        </div>
    `;
}

/**
 * æ˜¥å­£åœ°åŒºäºˆé¸ãŒã™ã¹ã¦çµ‚äº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
 */
function checkSpringQualifiersComplete() {
    let allFinished = true;
    for (const match of Object.values(tournamentState.springData.allMatches)) {
        // ãƒãƒ¼ãƒ ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¦ã€ã¾ã å‹è€…ãŒæ±ºã¾ã£ã¦ã„ãªã„è©¦åˆãŒã‚ã‚‹ã‹
        if (match.team1 && match.team2 && !match.winner) {
            allFinished = false;
            break;
        }
    }

    if (allFinished) {
        autumnControls.classList.remove('hidden');
        startMainTournamentBtn.classList.remove('hidden'); // çœŒå¤§ä¼šã¸é€²ã‚€ãƒœã‚¿ãƒ³
        startRankingPlayoffsBtn.classList.add('hidden');
    } else {
        autumnControls.classList.add('hidden');
        startMainTournamentBtn.classList.add('hidden');
    }
}/**
 * [æ˜¥å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸2-1] çœŒå¤§ä¼šæœ¬æˆ¦1å›æˆ¦ã‚’é–‹å§‹ã™ã‚‹
 */
async function setupSpringMainTournament_Round1() {
    tournamentState.springPhase = 'main_round1';
    
    // å„åœ°åŒºã®ä»£è¡¨æ ¡ã‚’finalRepsã‹ã‚‰é›†è¨ˆ
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.springData.regions[region];
        // ãƒ–ãƒ­ãƒƒã‚¯å„ªå‹æ ¡
        regionData.blocks.forEach(block => {
            const finalMatch = block.matches[`${block.id}-R2-M1`] || block.matches[`${block.id}-R1-M1`]; // 2,3ãƒãƒ¼ãƒ ãƒ–ãƒ­ãƒƒã‚¯å¯¾å¿œ
            if(finalMatch && finalMatch.winner) regionData.finalReps.push(finalMatch.winner);
        });
        // ç¬¬5ä»£è¡¨
        const repFinal = regionData.repechageBracket.matches[`${regionData.repechageBracket.id}-R2-M1`];
        if (repFinal.winner) regionData.finalReps.push(repFinal.winner);
    }
    const izuFinal = tournamentState.springData.regions['ä¼Šè±†'].izuBracket.matches[`ä¼Šè±†-SIZU-R2-M1`];
    if (izuFinal.winner) tournamentState.springData.regions['ä¼Šè±†'].finalReps.push(izuFinal.winner);

    const qualifiedTeams = Object.values(tournamentState.springData.regions).flatMap(r => r.finalReps);
    
    // äºˆé¸æ•—é€€ãƒãƒ¼ãƒ ã®æˆç¸¾ã‚’è¨˜éŒ²
    tournamentState.springData.qualifierTeams.forEach(team => {
        if (!qualifiedTeams.includes(team)) {
            tournamentState.teamRecords[team].lastFinish = 64; // äºˆé¸æ•—é€€
        }
    });

    tournamentState.teams = shuffleArray(qualifiedTeams); // äºˆé¸çªç ´16æ ¡ã§1å›æˆ¦
    tournamentState.matches = {};
    tournamentState.is16team = true; // 16ãƒãƒ¼ãƒ ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã¨ã—ã¦æç”»
    tournamentState.seeds = []; // 1å›æˆ¦ã¯ã‚·ãƒ¼ãƒ‰ãªã—

    const round1Setup = tournamentState.teams.reduce((acc, team, i) => {
        if (i % 2 === 0) acc.push({ team1: team, team2: null });
        else acc[acc.length - 1].team2 = team;
        return acc;
    }, []);

    round1Setup.forEach((match, index) => {
        const side = index < 4 ? 'L' : 'R';
        const matchNum = index < 4 ? index + 1 : index - 3;
        const matchId = `${side}-R1-M${matchNum}`;
        tournamentState.matches[matchId] = { id: matchId, team1: match.team1, team2: match.team2, winner: null, score1: '', score2: '', details: null, summary: '' };
    });

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    // --- 1å›æˆ¦ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ (16ãƒãƒ¼ãƒ ) ---
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R1-')), 
        ["4/10", "4/11"], MAJOR_STADIUMS, 2 // 1å›æˆ¦ (8è©¦åˆ) -> 4çƒå ´*2æ—¥*2è©¦åˆ=16ã‚¹ãƒ­ãƒƒãƒˆ
    );
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    renderTournament(tournamentState);
    saveState();
    
    // å±•æœ›è¨˜äº‹ãªã©ã‚’ç”Ÿæˆ...
    newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒçœŒå¤§ä¼š1å›æˆ¦ã®å±•æœ›è¨˜äº‹ã‚’åŸ·ç­†ä¸­...</div>`;
    // â˜…å±•æœ›è¨˜äº‹ç”¨ã®ç°¡æ˜“contextã‚’ä½œæˆã—ã¦æ¸¡ã™
    const previewContext = { matchId: 'preview' };
    const previewArticle = await generateNewsArticle(previewContext);
    if (previewArticle) tournamentState.news.unshift(previewArticle);

    renderNews(tournamentState.news);
    saveState();
}

/**
 * [æ˜¥å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸2-2] çœŒå¤§ä¼šæœ¬æˆ¦2å›æˆ¦ã‚’é–‹å§‹ã™ã‚‹
 */
async function setupSpringMainTournament_Round2() {
    tournamentState.springPhase = 'main_round2_onwards';
    
    const round1Winners = [];
    Object.values(tournamentState.matches).forEach(match => {
        if(match.id.includes('-R1-') && match.winner) {
            round1Winners.push(match.winner);
        }
    });

    const seedTeams = tournamentState.springData.seedTeams;
    const shuffledSeeds = shuffleArray(seedTeams);
    const shuffledWinners = shuffleArray(round1Winners);

    // 2å›æˆ¦ã®çµ„ã¿åˆã‚ã›ã‚’ä½œæˆ (ã‚·ãƒ¼ãƒ‰ vs 1å›æˆ¦å‹è€…)
    let newTeamsForRound2 = [];
    for (let i = 0; i < 8; i++) {
        newTeamsForRound2.push(shuffledSeeds[i]);
        newTeamsForRound2.push(shuffledWinners[i]);
    }
    newTeamsForRound2 = shuffleArray(newTeamsForRound2); // çµ„ã¿åˆã‚ã›ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«

    tournamentState.teams = newTeamsForRound2;
    tournamentState.matches = {};
    tournamentState.is16team = true;
    tournamentState.seeds = seedTeams; // 2å›æˆ¦ã‹ã‚‰ã‚·ãƒ¼ãƒ‰æ ¡ã¨ã—ã¦è¡¨ç¤º

    const round2Setup = tournamentState.teams.reduce((acc, team, i) => {
        if (i % 2 === 0) acc.push({ team1: team, team2: null });
        else acc[acc.length - 1].team2 = team;
        return acc;
    }, []);

    // R1ã¨ã—ã¦è©¦åˆIDã‚’ç”Ÿæˆã™ã‚‹ãŒã€ã“ã‚Œã¯å¤§ä¼šã®ã€Œ2å›æˆ¦ã€ã«ã‚ãŸã‚‹
    round2Setup.forEach((match, index) => {
        const side = index < 4 ? 'L' : 'R';
        const matchNum = index < 4 ? index + 1 : index - 3;
        const matchId = `${side}-R1-M${matchNum}`;
        tournamentState.matches[matchId] = { id: matchId, team1: match.team1, team2: match.team2, winner: null, score1: '', score2: '', details: null, summary: '' };
    });
    
    // æ•—é€€ãƒãƒ¼ãƒ ã®æˆç¸¾ã‚’è¨˜éŒ²
    Object.values(tournamentState.teamRecords).forEach(record => {
        if (record.lastFinish > 16 && record.lastFinish <=32) record.lastFinish = 32; // 1å›æˆ¦æ•—é€€ã¯ãƒ™ã‚¹ãƒˆ32æ‰±ã„
    });
    
// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆ â–¼â–¼â–¼
    // --- 2å›æˆ¦ä»¥é™ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ (16ãƒãƒ¼ãƒ ãƒ»æ–°ãƒ«ãƒ¼ãƒ«ç‰ˆ) ---
    const finalRoundSpring = 4;
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R1-')), // (R1 = 2å›æˆ¦)
        ["4/15", "4/16"], ROUND_3_STADIUMS, 2 // 2å›æˆ¦ (ä¸»è¦4çƒå ´) â€»3å›æˆ¦ç”¨çƒå ´ã‚’æµç”¨
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R2-')), 
        ["4/18"], FINAL_STAGE_STADIUMS, 4 // æº–ã€…æ±ºå‹ (è‰è–™ã§4è©¦åˆ)
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R3-')), 
        ["4/21"], FINAL_STAGE_STADIUMS, 2 // æº–æ±ºå‹ (è‰è–™ã§2è©¦åˆ)
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('F-R1-')), 
        ["4/23"], FINAL_STAGE_STADIUMS, 1 // æ±ºå‹ (è‰è–™ã§1è©¦åˆ)
    );
    // â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
    renderTournament(tournamentState);
    saveState();

    // 2å›æˆ¦ã®å±•æœ›è¨˜äº‹ã‚’ç”Ÿæˆ
    newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒçœŒå¤§ä¼š2å›æˆ¦ã®å±•æœ›è¨˜äº‹ã‚’åŸ·ç­†ä¸­...</div>`;
    // â˜…å±•æœ›è¨˜äº‹ç”¨ã®ç°¡æ˜“contextã‚’ä½œæˆã—ã¦æ¸¡ã™
    const previewContext = { matchId: 'preview' };
    const previewArticle = await generateNewsArticle(previewContext);
    if (previewArticle) tournamentState.news.unshift(previewArticle);
    if(previewArticle) 
        tournamentState.news.unshift(previewArticle);
    

    renderNews(tournamentState.news);
    saveState();
}


// --- AI Content Generation & Helpers (Part A: Main Generators) ---

/**
 * è©¦åˆã®å…¨æƒ…å ±ã‚’é›†ç´„ã—ãŸã€ŒmatchContextã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã™ã‚‹å¸ä»¤å¡”ï¼ˆâ˜…ç”Ÿã®æ‰“å¸­çµæœã‚’æ¸¡ã™ã‚ˆã†ã«ä¿®æ­£ï¼‰
 * @param {string} matchId - å¯¾è±¡ã®è©¦åˆID
 * @param {string} winnerName - å‹è€…å
 * @returns {object} - AIã«æ¸¡ã™ãŸã‚ã®å…¨ã¦ã®æƒ…å ±ãŒè©°ã¾ã£ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function createMatchContext(matchId, winnerName, team1QualityText, team2QualityText) { // â† å¼•æ•°ã‚’è¿½åŠ 
    const dbMatch = findMatchById(matchId);
    if (!dbMatch) return null;

    const loserName = dbMatch.team1 === winnerName ? dbMatch.team2 : dbMatch.team1;
    const nextOpponentInfo = findNextOpponent(winnerName, matchId);
    let nextOpponentJourney = null;
    if (nextOpponentInfo && nextOpponentInfo.opponentName && !['ï¼ˆæœªå®šï¼‰', 'å„ªå‹'].includes(nextOpponentInfo.opponentName)) {
        nextOpponentJourney = getCurrentTournamentPerformance(nextOpponentInfo.opponentName, matchId);
    }

    const { highlights, keyPlayerNames } = createHighlightsText(dbMatch, winnerName);

    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒå¤‰æ›´ç‚¹ â˜…â˜…â˜…
    // generatePlayByPlayTextã®å‘¼ã³å‡ºã—ã‚’å‰Šé™¤
    // const playByPlayText = dbMatch.details ? generatePlayByPlayText(dbMatch) : null;

    // ç”Ÿã®æ‰“å¸­çµæœãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
    let rawBattingResults = null;
    if (dbMatch.details && dbMatch.details.batting) {
        rawBattingResults = {
            team1: dbMatch.details.batting.team1?.map(p => ({ name: p.name, order: p.order, results: p.results })),
            team2: dbMatch.details.batting.team2?.map(p => ({ name: p.name, order: p.order, results: p.results }))
        };
    }
    // â˜…â˜…â˜… å¤‰æ›´ç‚¹ã¯ã“ã“ã¾ã§ â˜…â˜…â˜…

    const context = {
        winnerName,
        loserName,
        dbMatch,
        matchId,
        winnerData: TEAM_DATA[winnerName],
        loserData: TEAM_DATA[loserName],
        winnerDetailedData: DETAILED_TEAM_DATA[winnerName],
        loserDetailedData: DETAILED_TEAM_DATA[loserName],
        playerStatsText: dbMatch.details ? formatPlayerStatsForPrompt(dbMatch) : null,
                rawBattingResults: rawBattingResults, // â† æ–°ã—ãè¿½åŠ 
        winnerJourney: getCurrentTournamentPerformance(winnerName, matchId),
        loserJourney: getCurrentTournamentPerformance(loserName, matchId),
        winnerLineupChanges: dbMatch.details ? analyzeLineupChanges(winnerName, dbMatch) : "æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ãªã—",
        loserLineupChanges: dbMatch.details ? analyzeLineupChanges(loserName, dbMatch) : "æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ãªã—",
        nextOpponent: nextOpponentInfo,
        nextOpponentJourney: nextOpponentJourney,
        highlights: highlights,
        keyPlayerNames: keyPlayerNames,
        calledGame: dbMatch.calledGame,
        calledInning: dbMatch.calledInning,
rivalryType: dbMatch.rivalryType || null,
        
        // â–¼â–¼â–¼ ã“ã®2è¡Œã‚’è¿½åŠ  â–¼â–¼â–¼
        atmosphere_team1: dbMatch.atmosphere_team1 || null,
        atmosphere_team2: dbMatch.atmosphere_team2 || null,
        
        schedule: dbMatch.schedule || null,
        
        // â–¼â–¼â–¼ ã“ã®2è¡Œã‚’è¿½åŠ  â–¼â–¼â–¼
        team1BallQuality: team1QualityText || "ï¼ˆæ‰“çƒå“è³ªãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰",
        team2BallQuality: team2QualityText || "ï¼ˆæ‰“çƒå“è³ªãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰"
        // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
        // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
        // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
        

    };
    return context;
}

/**
 * å‰è©¦åˆã¨ä»Šè©¦åˆã®ã‚¹ã‚¿ãƒ¡ãƒ³ã‚’æ¯”è¼ƒã—ã€å¤‰æ›´ç‚¹ã‚’è¦ç´„ã™ã‚‹
 * @param {string} teamName - åˆ†æå¯¾è±¡ã®ãƒãƒ¼ãƒ å
 * @param {object} dbMatch - ç¾åœ¨ã®è©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {string} - å¤‰æ›´ç‚¹ã‚’ã¾ã¨ã‚ãŸçŸ­ã„ãƒ†ã‚­ã‚¹ãƒˆ
 */
function analyzeLineupChanges(teamName, dbMatch) {
    const teamRecord = tournamentState.teamRecords[teamName];
    if (!teamRecord || !teamRecord.previousStarters) {
        return "ä»Šå¤§ä¼šåˆæˆ¦ã®ãŸã‚ã€æ¯”è¼ƒãªã—ã€‚";
    }

    const teamKey = dbMatch.team1 === teamName ? 'team1' : 'team2';
    const previousStarters = teamRecord.previousStarters;
    const currentStarters = dbMatch.details.batting[teamKey].filter(p => p.order && !p.order.toString().includes('sub'));

    if (previousStarters.length === 0 || currentStarters.length === 0) return "æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ãªã—ã€‚";
    
    let changes = [];
    const prevPlayerMap = new Map(previousStarters.map(p => [p.name, p]));
    const currentPlayerMap = new Map(currentStarters.map(p => [p.name, p]));

    // 1. ã‚¹ã‚¿ãƒ¡ãƒ³ã‹ã‚‰å¤–ã‚ŒãŸé¸æ‰‹ã‚’æ¤œå‡º
    for (const prevPlayer of previousStarters) {
        if (!currentPlayerMap.has(prevPlayer.name)) {
            changes.push(`${prevPlayer.order}ç•ªã®${prevPlayer.name}ãŒã‚¹ã‚¿ãƒ¡ãƒ³è½ã¡`);
        }
    }

    // 2. æ–°ã—ãã‚¹ã‚¿ãƒ¡ãƒ³ã«å…¥ã£ãŸé¸æ‰‹ã‚„ã€æ‰“é †ãŒå¤‰ã‚ã£ãŸé¸æ‰‹ã‚’æ¤œå‡º
    for (const currPlayer of currentStarters) {
        const prevPlayer = prevPlayerMap.get(currPlayer.name);
        if (!prevPlayer) {
            changes.push(`${currPlayer.order}ç•ªã«${currPlayer.name}ãŒæ–°ã—ãã‚¹ã‚¿ãƒ¡ãƒ³å…¥ã‚Š`);
        } else {
            if (currPlayer.order !== prevPlayer.order) {
                changes.push(`${currPlayer.name}ãŒ${prevPlayer.order}ç•ªã‹ã‚‰${currPlayer.order}ç•ªã«æ‰“é †å¤‰æ›´`);
            }
        }
    }
    
    if (changes.length === 0) {
        return "å‰è©¦åˆã‹ã‚‰ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´ãªã—ã€‚";
    }
    
    // AIã«æ¸¡ã™æƒ…å ±ãŒå¤šã™ããªã„ã‚ˆã†ã€ä¸»ãªå¤‰æ›´ç‚¹ã«çµã‚‹
    return `ä¸»ãªå¤‰æ›´ç‚¹: ${changes.slice(0, 3).join('ã€')}ã€‚`;
}

/**
 * æ‰“å¸­çµæœã®æ–‡å­—åˆ—ã‚’ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ãˆã‚‹æ—¥æœ¬èªã¨ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ã™ã‚‹
 */
function translatePlay(atBatString) {
    if (!atBatString) return { description: "è¨˜éŒ²ãªã—", type: "none", out: false, base: 0 };
    
    const s = atBatString;
    if (s.includes('æœ¬å¡æ‰“')) return { description: `ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³`, type: "hr", out: false, base: 4 };
    if (s.includes('ä¸‰å¡æ‰“')) return { description: `ä¸‰å¡æ‰“`, type: "triple", out: false, base: 3 };
    if (s.includes('äºŒå¡æ‰“')) return { description: `äºŒå¡æ‰“`, type: "double", out: false, base: 2 };
    if (s.includes('å®‰')) return { description: `ãƒ’ãƒƒãƒˆ`, type: "single", out: false, base: 1 };
    
    if (s.includes('å››çƒ') || s.includes('æ­»çƒ') || s.includes('æ•¬é ')) return { description: `å››æ­»çƒ`, type: "walk", out: false, base: 1 };
    if (s.includes('ã‚¨ãƒ©ãƒ¼') || s.includes('é‡é¸') || s.includes('çŠ å¤±')) return { description: `ã‚¨ãƒ©ãƒ¼/é‡é¸`, type: "error", out: false, base: 1 };

    if (s.includes('çŠ é£›')) return { description: `çŠ ç‰²ãƒ•ãƒ©ã‚¤`, type: "sac_fly", out: true, base: 0 };
    if (s.includes('çŠ æ‰“')) return { description: `çŠ ç‰²ãƒãƒ³ãƒˆ`, type: "sac_bunt", out: true, base: 0 };
    if (s.includes('ä½µæ®º')) return { description: `ä½µæ®ºæ‰“`, type: "dp", out: true, base: 0 }; // 2ã‚¢ã‚¦ãƒˆã¯åˆ¥é€”å‡¦ç†

    if (s.includes('ä¸‰æŒ¯')) return { description: `ä¸‰æŒ¯`, type: "so", out: true, base: 0 };

// â–¼â–¼â–¼ ã“ã® if ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    if (s.includes('é‚ª')) return { description: `ãƒ•ã‚¡ã‚¦ãƒ«ãƒ•ãƒ©ã‚¤`, type: "ff", out: true, base: 0 };
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    if (s.includes('ã‚´ãƒ­')) return { description: `ã‚´ãƒ­`, type: "go", out: true, base: 0 };
    if (s.includes('é£›')) return { description: `ãƒ•ãƒ©ã‚¤`, type: "fo", out: true, base: 0 };
    if (s.includes('ç›´')) return { description: `ãƒ©ã‚¤ãƒŠãƒ¼`, type: "lo", out: true, base: 0 };
    
    return { description: `ãã®ä»–`, type: "other", out: false, base: 0 };
}

/**
 * 1ã‚¤ãƒ‹ãƒ³ã‚°åˆ†ã®è©¦åˆçµŒéã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹
 */
function processHalfInning(dbMatch, teamKey, inningIndex, batterIndices) {
    let halfInningText = "";
    let outs = 0;
    let bases = [null, null, null]; // [1B, 2B, 3B]
    
    const battingOrder = dbMatch.details.batting[teamKey].filter(p => p.name).sort((a,b) => a.order - b.order);
    if (battingOrder.length === 0) return "";
    
    let batterIndex = batterIndices[teamKey];
    let atBatsInInning = 0;

    while (outs < 3) {
        const batter = battingOrder[batterIndex];
        const resultString = batter.results[inningIndex] || "";
        const atBatsForPlayer = resultString.split('ã€');

        // ã“ã®ã‚¤ãƒ‹ãƒ³ã‚°ã§ã“ã®æ‰“è€…ãŒã¾ã æ‰“å¸­ã«ç«‹ã£ã¦ã„ãªã„å ´åˆã¯ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
        if (atBatsForPlayer.length <= atBatsInInning) break; 
        
        const currentAtBatString = atBatsForPlayer[atBatsInInning];
        if(!currentAtBatString) break;

        const play = translatePlay(currentAtBatString);
        
        // 1. æ‰“å¸­çµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ 
        halfInningText += `${batter.order}ç•ª ${batter.name} (${batter.pos}): ${play.description}\n`;

        // 2. ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
        if(play.out) outs++;
        if(play.type === 'dp') outs++; // ä½µæ®ºæ‰“

        if (outs >= 3) {
            halfInningText += `  â†’ ${outs}ã‚¢ã‚¦ãƒˆ\n`;
            batterIndex = (batterIndex + 1) % battingOrder.length;
            break;
        }
        
        // 3. ãƒ©ãƒ³ãƒŠãƒ¼ã‚’é€²å¡ã•ã›ã‚‹ï¼ˆç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        const newBases = [null, null, null];
        let batterOnBase = false;

        // ã¾ãšãƒ©ãƒ³ãƒŠãƒ¼ã‚’é€²ã‚ã‚‹ (3å¡ã‹ã‚‰)
        if (bases[2]) { // 3å¡ãƒ©ãƒ³ãƒŠãƒ¼
            if (play.base >= 1 || play.type === 'sac_fly' || play.type === 'walk') newBases[2] = null; // ç”Ÿé‚„
            else newBases[2] = bases[2];
        }
        if (bases[1]) { // 2å¡ãƒ©ãƒ³ãƒŠãƒ¼
            if (play.base >= 2) newBases[1] = null; // ç”Ÿé‚„
            else if (play.base === 1 || play.type === 'sac_bunt') newBases[2] = bases[1];
            else newBases[1] = bases[1];
        }
        if (bases[0]) { // 1å¡ãƒ©ãƒ³ãƒŠãƒ¼
            if (play.base >= 3) newBases[0] = null; // ç”Ÿé‚„
            else if (play.base === 2) newBases[2] = bases[0];
            else if (play.base === 1 || play.type === 'sac_bunt' || play.type === 'walk') newBases[1] = bases[0];
            else newBases[0] = bases[0];
        }
        
        // æ‰“è€…èµ°è€…ã‚’å¡ã«å‡ºã™
        if (!play.out && play.base > 0) {
            newBases[play.base - 1] = batter.name;
        }

        bases = newBases;
        
        // 4. ç¾åœ¨ã®çŠ¶æ³ã‚’ãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ 
        const runners = [];
        if(bases[0]) runners.push("1å¡");
        if(bases[1]) runners.push("2å¡");
        if(bases[2]) runners.push("3å¡");
        const runnerText = runners.length > 0 ? `ãƒ©ãƒ³ãƒŠãƒ¼${runners.join(', ')}` : "ãƒ©ãƒ³ãƒŠãƒ¼ãªã—";
        halfInningText += `  â†’ ${outs}ã‚¢ã‚¦ãƒˆ, ${runnerText}\n`;
        
        batterIndex = (batterIndex + 1) % battingOrder.length;
        atBatsInInning++;
    }

    batterIndices[teamKey] = batterIndex; // æ¬¡ã®ã‚¤ãƒ‹ãƒ³ã‚°ã®å…ˆé ­æ‰“è€…ã‚’è¨˜æ†¶
    
    if (outs < 3) {
      halfInningText += `(${outs}ã‚¢ã‚¦ãƒˆã§ã‚¤ãƒ‹ãƒ³ã‚°çµ‚äº†)\n`;
    }
    
    halfInningText += "ãƒã‚§ãƒ³ã‚¸\n";
    return halfInningText;
}

/**
 * å…¨ã‚¤ãƒ‹ãƒ³ã‚°ã®è©¦åˆçµŒéãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹ãƒã‚¹ã‚¿ãƒ¼é–¢æ•°
 */
function generatePlayByPlayText(dbMatch) {
    if (!dbMatch || !dbMatch.details) return "è©³ç´°ãªè©¦åˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";

    let playByPlay = "";
    const numInnings = dbMatch.details.inningScore?.team1?.length || 9;
    // å„ãƒãƒ¼ãƒ ã®æ¬¡ã®å…ˆé ­æ‰“è€…ã‚’è¨˜éŒ²ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    let batterIndices = { team1: 0, team2: 0 };

    for (let i = 0; i < numInnings; i++) {
        // è¡¨ã®æ”»æ’ƒ
        playByPlay += `\nã€${i + 1}å›è¡¨ã€‘${dbMatch.team1}ã®æ”»æ’ƒ\n`;
        playByPlay += processHalfInning(dbMatch, 'team1', i, batterIndices);
        
        // ã‚µãƒ¨ãƒŠãƒ©ã‚²ãƒ¼ãƒ ã®åˆ¤å®š
        if (i >= 8) { // 9å›è¡¨ä»¥é™
            const score1 = (dbMatch.details.inningScore.team1 || []).slice(0, i + 1).reduce((a, b) => a + (b || 0), 0);
            const score2 = (dbMatch.details.inningScore.team2 || []).slice(0, i + 1).reduce((a, b) => a + (b || 0), 0);
            if (dbMatch.team2 === dbMatch.winner && score2 > score1) {
                 break;
            }
        }

        // è£ã®æ”»æ’ƒ
        playByPlay += `\nã€${i + 1}å›è£ã€‘${dbMatch.team2}ã®æ”»æ’ƒ\n`;
        playByPlay += processHalfInning(dbMatch, 'team2', i, batterIndices);
    }

    playByPlay += "\n--- è©¦åˆçµ‚äº† ---\n";
    return playByPlay;
}

/**
 * Finds a specific team's final result in the tournament.
 */
function getTeamFateSummary(teamName) {
    const allMatches = { 
        ...tournamentState.matches, 
        ...(tournamentState.autumnData?.allMatches || {}),
        ...(tournamentState.springData?.allMatches || {}) 
    };

    for (const matchId in allMatches) {
        const match = allMatches[matchId];
        if (match.winner && (match.team1 === teamName || match.team2 === teamName)) {
            if (match.winner !== teamName) {
                const opponent = match.winner;
                const score1 = match.team1 === teamName ? match.score1 : match.score2;
                const score2 = match.team1 === teamName ? match.score2 : match.score1;
                const roundNum = match.id.includes('-R') ? parseInt(match.id.split('-')[1].slice(1)) : 1;
                return `${roundNum}å›æˆ¦ã§${opponent}ã«${score1}-${score2}ã§æ•—é€€ã—ãŸã€‚`;
            }
        }
    }
    
    // Check if the team is still in the tournament
    const isStillIn = Object.values(allMatches).some(match => !match.winner && (match.team1 === teamName || match.team2 === teamName));
    if(isStillIn) {
        return "ã¾ã å‹ã¡æ®‹ã£ã¦ã„ã‚‹ã€‚";
    }

    return "ï¼ˆä»Šå¤§ä¼šã«ã¯å‡ºå ´ã—ã¦ã„ãªã„ã‹ã€æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰";
}
   



/**
 * ãƒãƒ¼ãƒ ã®ç´¹ä»‹æ–‡ã‚’å‹•çš„ã«ç”Ÿæˆã™ã‚‹æœ€çµ‚é€²åŒ–ç‰ˆã€‚
 * TEAM_DATAã®å›ºå®šæƒ…å ±ã«ã€æœ€æ–°ã®æˆç¸¾æƒ…å ±ã‚’ä»˜ã‘åŠ ãˆã‚‹ã€‚
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 * @param {object} teamData - TEAM_DATAã‹ã‚‰å–å¾—ã—ãŸãã®ãƒãƒ¼ãƒ ã®åŸºæœ¬æƒ…å ±
 * @param {object} teamRecord - tournamentState.teamRecordsã‹ã‚‰å–å¾—ã—ãŸãã®ãƒãƒ¼ãƒ ã®æˆç¸¾è¨˜éŒ²
 * @returns {string} - ç”Ÿæˆã•ã‚ŒãŸæœ€æ–°ã®ç´¹ä»‹æ–‡
 */
function generateDynamicTeamInfo(teamName, teamData, teamRecord) {
// â–¼â–¼â–¼ ã“ã®å®‰å…¨è£…ç½®ãŒã€ä»Šå¾Œã®ã‚ãªãŸã‚’åŠ©ã‘ã¾ã™ â–¼â–¼â–¼
    if (!teamData) {
        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã€ã©ã®ãƒãƒ¼ãƒ åã§å¤±æ•—ã—ãŸã‹ã‚’å‡ºåŠ›
        console.error(`TEAM_DATAã«ãƒãƒ¼ãƒ ã€Œ${teamName}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åå‰ã®ã‚¿ã‚¤ãƒ—ãƒŸã‚¹ãŒãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        // è¨˜äº‹ã«ã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        return `${teamName}ã®ãƒãƒ¼ãƒ æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`;
    }
    // â–²â–²â–² â–²â–²â–²    
// teamData.info ãŒåŸºæœ¬ã®ç´¹ä»‹æ–‡ã¨ãªã‚‹
    const baseInfo = teamData.info || `${teamName}ã®æƒ…å ±ã¯ä¸æ˜ã§ã™ã€‚`;

    // ãƒãƒ¼ãƒ ã®æˆç¸¾è¨˜éŒ²ãŒã¾ã ãªã„ï¼ˆï¼1å¹´ç›®ã®é€”ä¸­ãªã©ï¼‰å ´åˆã¯ã€åŸºæœ¬æƒ…å ±ã ã‘ã‚’è¿”ã™
    if (!teamRecord || !teamRecord.history || teamRecord.history.length === 0) {
        return baseInfo;
    }

    const history = teamRecord.history;

    // --- ã“ã“ã‹ã‚‰ãŒè¿½åŠ æƒ…å ±ã®ç”Ÿæˆ ---
    let additionalNarrative = []; // è¿½åŠ æƒ…å ±ã‚’å…¥ã‚Œã‚‹é…åˆ—

    // å‰µéƒ¨å¹´æ•°ã‚’è¨ˆç®— (2å¹´ç›®ä»¥é™ã«æ„å‘³ã‚’æŒã¤æƒ…å ±)
    if (history.length > 0) {
        const establishedYear = history[history.length - 1].year;
        const yearsPassed = tournamentState.tournamentYear - establishedYear + 1;
        // 1å¹´ç›®ã®æœ€åˆã®å¤§ä¼šã§ã¯è¡¨ç¤ºã—ãªã„ã‚ˆã†ã«ã€2å¹´ç›®ä»¥é™ã®æƒ…å ±ã¨ã—ã¦æ‰±ã†
        if (yearsPassed > 1) {
            additionalNarrative.push(`å‰µéƒ¨${yearsPassed}å¹´ç›®ã€‚`);
        }
    }
    
    // æ˜¨å¹´ã®æˆç¸¾ã‚’è¿½åŠ 
    const lastFinishLabel = teamRecord.last?.label;
    if (lastFinishLabel && lastFinishLabel !== 'ãªã—') {
        additionalNarrative.push(`æ˜¨å¹´ã¯${lastFinishLabel}ã€‚`);
    }

    // éå»æœ€é«˜æˆç¸¾ã‚’è¿½åŠ 
    const bestFinishLabel = teamRecord.best?.label;
    if (bestFinishLabel && bestFinishLabel !== 'ãªã—') {
        additionalNarrative.push(`éå»æœ€é«˜ã¯${bestFinishLabel}ã€‚`);
    }

    // ç§°å·ï¼ˆTraitsï¼‰ã‚’è¿½åŠ 
    const traitDescriptions = {
        'GIANT_KILLER': 'ã€Œã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒ©ãƒ¼ã€ã®ç•°åã‚’æŒã¤ã€‚',
        'REPECHAGE_KING': 'ã€Œæ•—è€…å¾©æ´»ã®ç‹ã€ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹ã€‚',
    };
    if (teamRecord.teamTraits && teamRecord.teamTraits.length > 0) {
        teamRecord.teamTraits.forEach(traitId => {
            if (traitDescriptions[traitId]) {
                additionalNarrative.push(traitDescriptions[traitId]);
            }
        });
    }

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    // ä»Šå¤§ä¼šã®ãƒãƒ¼ãƒ æ‰“ç‡ã‚’è¿½åŠ 
    const tourneyStats = teamRecord.tournamentStats;
    if (tourneyStats && tourneyStats.ab > 5) { // 5æ‰“æ•°ä»¥ä¸Šã§æ„å‘³ã®ã‚ã‚‹æ•°å­—
        const avg = (tourneyStats.h / tourneyStats.ab).toFixed(3);
        additionalNarrative.push(`ä»Šå¤§ä¼šã®ãƒãƒ¼ãƒ æ‰“ç‡ã¯${avg}ã€‚`);
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    // --- æœ€çµ‚çš„ãªç´¹ä»‹æ–‡ã®çµ„ã¿ç«‹ã¦ ---
    // ã‚‚ã—è¿½åŠ æƒ…å ±ãŒä½•ã‹ä¸€ã¤ã§ã‚‚ã‚ã‚Œã°ã€åŸºæœ¬æƒ…å ±ã«ä»˜ã‘åŠ ãˆã‚‹
    if (additionalNarrative.length > 0) {
        // ä¾‹ï¼šã€Œï¼ˆåŸºæœ¬æƒ…å ±ï¼‰ã€‚åŠ ãˆã¦ã€å‰µéƒ¨2å¹´ç›®ã€‚æ˜¨å¹´ã¯çœŒå¤§ä¼š2å›æˆ¦ã€‚ã€ã®ã‚ˆã†ã«ãªã‚‹
        return `${baseInfo} ${additionalNarrative.join(' ')}`;
    } 
    // è¿½åŠ æƒ…å ±ãŒãªã‘ã‚Œã°ã€åŸºæœ¬æƒ…å ±ã ã‘ã‚’è¿”ã™
    else {
        return baseInfo;
    }
}

 
/**
 * é¸æ‰‹ã®å‡ºå ´å½¢å¼ã‚³ãƒ¼ãƒ‰ã‚’ã€è¨˜äº‹ã§ä½¿ãˆã‚‹è‡ªç„¶ãªæ—¥æœ¬èªã«å¤‰æ›ã™ã‚‹ï¼ˆç¿»è¨³æ©Ÿï¼‰
 * @param {object} player - é¸æ‰‹ã®ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {string} - å‡ºå ´å½¢å¼ã‚’èª¬æ˜ã™ã‚‹æ–‡ç« 
 */
function getSubstitutionDescription(player) {
    // äº¤ä»£é¸æ‰‹ã§ãªã„ï¼ˆã‚¹ã‚¿ãƒ¡ãƒ³ï¼‰å ´åˆã¯ "ã‚¹ã‚¿ãƒ¡ãƒ³å‡ºå ´" ã¨ã™ã‚‹
    if (!player.sub_type) {
        return 'ã‚¹ã‚¿ãƒ¡ãƒ³å‡ºå ´';
    }

    // sub_typeã®å€¤ã«å¿œã˜ã¦ã€è¿”ã™æ–‡ç« ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
    switch (player.sub_type) {
        case 'PH':
            return 'ä»£æ‰“ã§å‡ºå ´';
        case 'PR':
            return 'ä»£èµ°ã§å‡ºå ´';
        case 'DEF':
            return 'å®ˆå‚™å›ºã‚ã§å‡ºå ´';
        // â–¼â–¼â–¼ ADD THIS CASE â–¼â–¼â–¼
        case 'PITCHER': return 'ãƒªãƒªãƒ¼ãƒ•ã¨ã—ã¦ç™»æ¿';
        // â–²â–²â–² END OF ADDITION â–²â–²â–²
        default:
            return 'é€”ä¸­å‡ºå ´'; // ä½•ã‚‰ã‹ã®ç†ç”±ã§sub_typeãŒä¸Šè¨˜ä»¥å¤–ã®å ´åˆ
    }
}

/**
 * è©¦åˆã®å€‹äººæˆç¸¾ã‚’AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ï¼ˆâ˜…èƒŒç•ªå·ä»˜ããƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ï¼‰ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹
 * @param {object} dbMatch - è©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {string} - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ
 */
function formatPlayerStatsForPrompt(dbMatch) {
    if (!dbMatch || !dbMatch.details || !dbMatch.details.playerGameStats) {
        return 'è©³ç´°ãªå€‹äººæˆç¸¾ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
    }

    const { details, winner } = dbMatch;

    const formatTeamStats = (teamKey) => {
        const teamName = dbMatch[teamKey];
const teamRecord = tournamentState.teamRecords[teamName]; // â˜…ãƒãƒ¼ãƒ ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        const isWinner = teamName === winner;
        const battingOrder = details.batting?.[teamKey] || [];
        const gameStats = details.playerGameStats?.[teamKey] || {};
        const pitchingData = details.pitching?.[teamKey] || [];

        let output = `\n**${teamName} (${isWinner ? 'å‹è€…' : 'æ•—è€…'})**\n`;

        const sortedBatters = battingOrder.sort((a, b) => {
            const orderA = parseFloat(a.order.replace('-sub', '.'));
            const orderB = parseFloat(b.order.replace('-sub', '.'));
            return orderA - orderB;
        });

        sortedBatters.forEach(player => {
            if (!player.name) return;
            const stats = gameStats[player.name];
            if (!stats || !stats.played) return; 

            // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¿®æ­£ â–¼â–¼â–¼
            // é¸æ‰‹ã®çŠ¶æ…‹ãƒ•ãƒ©ã‚°ã‚’å–å¾—
            let statusText = "";
            const careerStats = teamRecord?.playerStats?.batting[player.name];
            if (careerStats && careerStats.narrative_flag) {
                const flagMap = {
                    "hot_streak": "çµ¶å¥½èª¿",
                    "powered_up": "ä¸€ç™ºè­¦æˆ’",
                    "clutch_hitter": "å‹è² å¼·ã•â—",
                    "slumping": "ä¸æŒ¯"
                };
                statusText = ` (çŠ¶æ…‹: ${flagMap[careerStats.narrative_flag] || careerStats.narrative_flag})`;
            }

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
            // â˜… ã€ŒæŠ•/æ‰“ã€æƒ…å ±ã‚’è§£æã—ã¦ã€Œï¼ˆå³æ‰“ï¼‰ã€ãªã©ã‚’è¿½åŠ 
            let batHandText = "";
            if (player.throwBat) {
                if (player.throwBat.endsWith('/R')) batHandText = "ï¼ˆå³æ‰“ï¼‰";
                else if (player.throwBat.endsWith('/L')) batHandText = "ï¼ˆå·¦æ‰“ï¼‰";
                else if (player.throwBat.endsWith('/S')) batHandText = "ï¼ˆä¸¡æ‰“ï¼‰"; // â† â˜…è¿½åŠ 
            }            
            // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

            const orderDisplay = player.order.includes('sub') ? `  - ${player.sub_type || 'ä»£'}` : `${player.order}.`;
            const playerIdentifier = `[#${player.number}] ${player.name}`; 
            const statsLine = `${stats.ab}æ‰“æ•°${stats.h}å®‰æ‰“ ${stats.rbi}æ‰“ç‚¹` + (stats.hr > 0 ? ` ${stats.hr}æœ¬å¡æ‰“` : '');
            
            // â–¼â–¼â–¼ ã“ã®è¡Œã‚’ä¿®æ­£ â–¼â–¼â–¼
            output += `${orderDisplay} ${playerIdentifier}${batHandText}${statusText}: ${statsLine}\n`; // â˜… batHandText ã‚’è¿½åŠ 
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
        });
        
        pitchingData.forEach(pitcher => {
            if (!pitcher.name || !pitcher.innings) return;
            
            // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¿®æ­£ â–¼â–¼â–¼
            // æŠ•æ‰‹ã‚‚åŒæ§˜ã«çŠ¶æ…‹ãƒ•ãƒ©ã‚°ã‚’å–å¾—
            let statusText = "";
            const careerStats = teamRecord?.playerStats?.pitching[pitcher.name];
            if (careerStats && careerStats.narrative_flag) {
                 const flagMap = {
                    "dominant": "åœ§å·»",
                    "seeking_redemption": "è¦ä¿®æ­£",
                    "tough_loss": "ä¸é‹"
                };
                statusText = ` (çŠ¶æ…‹: ${flagMap[careerStats.narrative_flag] || careerStats.narrative_flag})`;
            }
            
// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆ â–¼â–¼â–¼
            // â˜… ã€ŒæŠ•/æ‰“ã€ãŠã‚ˆã³æ–°ã—ã„å±æ€§æƒ…å ±ã‚’è§£æ
            let pitcherDesc = "";
            if (pitcher.throwBat) {
                if (pitcher.throwBat.startsWith('R')) pitcherDesc += "å³";
                if (pitcher.throwBat.startsWith('L')) pitcherDesc += "å·¦";
            }
            if (pitcher.throwStyle) {
                const styleMap = { "over": "ã‚ªãƒ¼ãƒãƒ¼", "three_quarter": "ã‚¹ãƒªãƒ¼ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼", "side": "ã‚µã‚¤ãƒ‰", "under": "ã‚¢ãƒ³ãƒ€ãƒ¼" };
                pitcherDesc += `/${styleMap[pitcher.throwStyle] || pitcher.throwStyle}`;
            }
            if (pitcher.pitcherType) {
                const typeMap = { "honkaku": "æœ¬æ ¼æ´¾", "sokkyu": "é€Ÿçƒæ´¾", "giko": "æŠ€å·§æ´¾", "nanto": "è»ŸæŠ•æ´¾" };
                pitcherDesc += `/${typeMap[pitcher.pitcherType] || pitcher.pitcherType}`;
            }
            if (pitcher.velocity) {
                pitcherDesc += `/${pitcher.velocity}`;
            }
            // æ‹¬å¼§ã§å›²ã‚€ (æƒ…å ±ãŒã‚ã‚‹å ´åˆã®ã¿)
            if (pitcherDesc) pitcherDesc = `ï¼ˆ${pitcherDesc}ï¼‰`;

            const pitcherData = sortedBatters.find(b => b.name === pitcher.name);
            const pitcherIdentifier = pitcherData ? `[#${pitcherData.number}] ${pitcher.name}` : pitcher.name;
            
            // â˜… pitcherDesc ã¨ statusText ã‚’è­˜åˆ¥å­ã«è¿½åŠ 
            output += `- æŠ•æ‰‹: ${pitcherIdentifier}${pitcherDesc}${statusText} (${pitcher.innings}å› ${pitcher.runs}å¤±ç‚¹ ${pitcher.strikeouts}å¥ªä¸‰æŒ¯ ${pitcher.walks}å››æ­»çƒ)\n`;
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
        });

        return output;
    };

    return formatTeamStats('team1') + formatTeamStats('team2');
}

/**
 * è©¦åˆã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã®å€‹äººæˆç¸¾ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ç”Ÿæˆã™ã‚‹ï¼ˆâ˜…æŠ•æ‰‹åˆ†æå¼·åŒ–ç‰ˆï¼‰
 * @param {object} dbMatch - è©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {string} - "å‹è€…ãƒ»ã€‡ã€‡: éˆ´æœ¨(4å®‰æ‰“), æŠ•æ‰‹ãƒ»ç”°ä¸­(9å›1å¤±ç‚¹, HQSé”æˆ). // æ•—è€…ãƒ»â–³â–³: ..."
 */
function extractKeyPerformances(dbMatch) {
    if (!dbMatch || !dbMatch.details || !dbMatch.details.playerGameStats) {
        return 'è©³ç´°ãªå€‹äººæˆç¸¾ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
    }

    const { details, winner } = dbMatch;
    const winnerName = winner;
    const loserName = dbMatch.team1 === winner ? dbMatch.team2 : dbMatch.team1;

    const winnerKey = dbMatch.team1 === winnerName ? 'team1' : 'team2';
    const loserKey = dbMatch.team1 === loserName ? 'team1' : 'team2';

    const formatTeamPerformances = (teamKey) => {
        const teamName = dbMatch[teamKey];
        const performances = [];
        
        // æ‰“æ’ƒæˆç¸¾ã®åˆ†æ (å¤‰æ›´ãªã—)
        const battingStats = details.playerGameStats?.[teamKey] || {};
        for (const playerName in battingStats) {
            const stats = battingStats[playerName];
            const playerHighlights = [];
            if (stats.h >= 3) playerHighlights.push(`${stats.h}å®‰æ‰“`);
            if (stats.hr > 0) playerHighlights.push(`${stats.hr}æœ¬å¡æ‰“`);
            if (stats.rbi >= 3) playerHighlights.push(`${stats.rbi}æ‰“ç‚¹`);

            if (playerHighlights.length > 0) {
                const battingData = details.batting[teamKey].find(p => p.name === playerName);
                const order = battingData ? `${battingData.order}ç•ª` : '';
                performances.push(`${order}${playerName}(${playerHighlights.join(', ')})`);
            }
        }

        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒå¼·åŒ–ã•ã‚ŒãŸæŠ•æ‰‹åˆ†æãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        const pitchingData = details.pitching?.[teamKey] || [];
        const opponentTeamKey = teamKey === 'team1' ? 'team2' : 'team1';
        const opponentBattingData = details.batting?.[opponentTeamKey] || [];

        pitchingData.forEach(pitcher => {
            if (!pitcher.name) return;
            const pitcherHighlights = [];

            // 1. åŸºæœ¬çš„ãªæŠ•çƒçµæœã‚’åˆ†æ
            const innings = parseFloat(pitcher.innings || 0);
            const runs = parseInt(pitcher.runs || 0);
            const earnedRuns = parseInt(pitcher.earnedRuns || 0);
            const strikeouts = parseInt(pitcher.strikeouts || 0);
            const walks = parseInt(pitcher.walks || 0);
            const pitches = parseInt(pitcher.pitches || 0);

            // å¾“æ¥ã®åˆ†æ
            if (pitcher.result === 'W') {
                 if (innings >= 9 && earnedRuns === 0) pitcherHighlights.push('å®Œå°å‹åˆ©');
                 else if (innings >= 9) pitcherHighlights.push('å®ŒæŠ•å‹åˆ©');
            }
            if (strikeouts >= 10) pitcherHighlights.push(`${strikeouts}å¥ªä¸‰æŒ¯`);
            if (pitcher.result === 'L' && runs >= 5) pitcherHighlights.push(`${runs}å¤±ç‚¹ç‚ä¸Š`);

            // 2. æ–°ã—ã„è©³ç´°åˆ†æ
            if (pitches > 120) pitcherHighlights.push(`${pitches}çƒã®ç†±æŠ•`);
            if (walks >= 5) pitcherHighlights.push(`ä¸å››çƒ${walks}ã¨åˆ¶çƒé›£`);

            // 3. ã‚¤ãƒ‹ãƒ³ã‚°ã”ã¨ã®å†…å®¹åˆ†æï¼ˆä¸»ã«å…ˆç™ºæŠ•æ‰‹ã‚’å¯¾è±¡ï¼‰
            if (innings >= 6 && opponentBattingData.length > 0) {
                let walksByInning = Array(9).fill(0);
                for (let i = 0; i < 9; i++) {
                    opponentBattingData.forEach(batter => {
                        const result = batter.results[i] || '';
                        if (result.includes('å››çƒ') || result.includes('æ­»çƒ')) {
                            walksByInning[i]++;
                        }
                    });
                }

                const earlyInningWalks = walksByInning.slice(0, 5).reduce((a, b) => a + b, 0);
                const lateInningWalks = walksByInning.slice(5, 9).reduce((a, b) => a + b, 0);

                if (lateInningWalks > earlyInningWalks && lateInningWalks >= 3) {
                    pitcherHighlights.push('çµ‚ç›¤ã«åˆ¶çƒã‚’ä¹±ã—ãŸ');
                } else if (innings >= 7 && earnedRuns <= 2 && pitcher.result !== 'L') {
                    // è‰¯ã„å†…å®¹ã ã£ãŸå ´åˆã®è©•ä¾¡
                    pitcherHighlights.push('è©¦åˆã‚’ä½œã£ãŸ'); 
                }
            }
            
            if (pitcherHighlights.length > 0) {
                performances.push(`æŠ•æ‰‹ãƒ»${pitcher.name}(${pitcherHighlights.join(', ')})`);
            }
        });
        // â˜…â˜…â˜… æŠ•æ‰‹åˆ†æãƒ­ã‚¸ãƒƒã‚¯ã¯ã“ã“ã¾ã§ â˜…â˜…â˜…

        return performances.length > 0 ? `${teamName}: ${performances.join(', ')}` : '';
    };

    const winnerPerf = formatTeamPerformances(winnerKey);
    const loserPerf = formatTeamPerformances(loserKey);

    return [winnerPerf, loserPerf].filter(Boolean).join(' // ');
}

/**
 * å¯†ç€å–æå‹è¨˜è€…ã€Œç¾½ç”° é›„å¹³ã€ã®ã‚³ãƒ©ãƒ è¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯èªè­˜ æœ€çµ‚ç‰ˆ)
 * @param {object} matchContext - è©¦åˆã®å…¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
 * @returns {Promise<object|null>} ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
async function generateHadaReport(matchContext) {
    // --- 1. contextã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–ã‚Šå‡ºã™ ---
    const { 
        winnerName, loserName, dbMatch, matchId, 
        playerStatsText, highlights, nextOpponent
    } = matchContext;

    const winnerScore = Math.max(parseInt(dbMatch.score1) || 0, parseInt(dbMatch.score2) || 0);
    const loserScore = Math.min(parseInt(dbMatch.score1) || 0, parseInt(dbMatch.score2) || 0);
    const winnerData = TEAM_DATA[winnerName];
    const loserData = TEAM_DATA[loserName];
    const winnerRank = calculateRank(winnerName, tournamentState);
    const loserRank = calculateRank(loserName, tournamentState);

    // â–¼â–¼â–¼ ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯å–å¾—ã‚’è¿½åŠ  â–¼â–¼â–¼
    const winnerSeedRank = getSeedRankString(winnerName, tournamentState.seeds);
    const loserSeedRank = getSeedRankString(loserName, tournamentState.seeds);
    // â–²â–²â–²

    // --- 2. ãƒ©ã‚¦ãƒ³ãƒ‰åã¨æ¬¡ã®ç›¸æ‰‹ã‚’ç‰¹å®š ---
    let roundName = "ä¸æ˜ãªãƒ©ã‚¦ãƒ³ãƒ‰";
    if (matchId && matchId.includes('-R')) {
        // ... (ãƒ©ã‚¦ãƒ³ãƒ‰ååˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ...
        const roundNum = parseInt(matchId.split('-')[1].slice(1));
        const finalRound = tournamentState.is16team ? 4 : 6;
        const roundNameMap = { [finalRound]: 'æ±ºå‹', [finalRound-1]: 'æº–æ±ºå‹', [finalRound-2]: 'æº–ã€…æ±ºå‹' };
        if (tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'main_round2_onwards'){
             const springRoundMap = { 1: '2å›æˆ¦', 2: 'æº–ã€…æ±ºå‹', 3: 'æº–æ±ºå‹', 4: 'æ±ºå‹'};
             roundName = springRoundMap[roundNum] || `${roundNum}å›æˆ¦`;
        }
        else roundName = roundNameMap[roundNum] || `${roundNum}å›æˆ¦`;
    }
    
    let nextOpponentText = 'æ¬¡æˆ¦ã®ç›¸æ‰‹ã¯ã¾ã æ±ºã¾ã£ã¦ã„ã¾ã›ã‚“ã€‚';
    if (nextOpponent && nextOpponent.opponentName && nextOpponent.opponentName !== 'ï¼ˆæœªå®šï¼‰') {
        const nextOpponentSeed = getSeedRankString(nextOpponent.opponentName, tournamentState.seeds); // â˜…
        nextOpponentText = `ï¼’å›æˆ¦ã§ã¯${nextOpponent.opponentName}${nextOpponentSeed}ã¨å¯¾æˆ¦ã—ã¾ã™ã€‚`;
    }

    // --- 3. ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ãƒ†ã‚­ã‚¹ãƒˆåŒ– ---
    const highlightsText = highlights.map(fact => `- ${fact.inning || ''}å› ${fact.team || ''} ${fact.player || ''}: ${fact.description}`).join('\n');

    // ... (scheduleText, ballQualityText ã®æº–å‚™ã¯å¤‰æ›´ãªã—) ...
    let scheduleText = '';
    let scheduleInstruction = '';
    if (matchContext.schedule) {
        const sched = matchContext.schedule;
        const team1Region = TEAM_DATA[dbMatch.team1]?.region || 'ä¸æ˜';
        const team2Region = TEAM_DATA[dbMatch.team2]?.region || 'ä¸æ˜';
        
        scheduleText = `\n- **è©¦åˆä¼šå ´:** ${sched.stadiumFull} (${sched.region}åœ°åŒº)\n`;
        
        if (sched.region === team1Region && sched.region !== team2Region) {
            scheduleText += `- **åœ°ã®åˆ©:** ${dbMatch.team1}ã«ã¨ã£ã¦åœ°å…ƒçƒå ´ã§ã®è©¦åˆã€‚`;
            scheduleInstruction = `**ã€åœ°ã®åˆ©ã®åˆ†æã€‘**: ${dbMatch.team1}ã«ã¨ã£ã¦ã€Œåœ°å…ƒçƒå ´ã€ã§ã‚ã£ãŸã“ã¨ãŒã€è©¦åˆã«ã©ã†å½±éŸ¿ã—ãŸã‹ï¼ˆä¾‹ï¼šå¤§å¿œæ´å›£ã®å¾ŒæŠ¼ã—ã€æ…£ã‚ŒãŸãƒã‚¦ãƒ³ãƒ‰ãªã©ï¼‰ã‚’ã€ã‚ãªãŸã®è¦–ç‚¹ã§åˆ†æã—ã¦ãã ã•ã„ã€‚`;
        } else if (sched.region !== team1Region && sched.region === team2Region) {
            scheduleText += `- **åœ°ã®åˆ©:** ${dbMatch.team2}ã«ã¨ã£ã¦åœ°å…ƒçƒå ´ã§ã®è©¦åˆã€‚`;
            scheduleInstruction = `**ã€åœ°ã®åˆ©ã®åˆ†æã€‘**: ${dbMatch.team2}ã«ã¨ã£ã¦ã€Œåœ°å…ƒçƒå ´ã€ã§ã‚ã£ãŸã“ã¨ãŒã€è©¦åˆã«ã©ã†å½±éŸ¿ã—ãŸã‹ï¼ˆä¾‹ï¼šå¤§å¿œæ´å›£ã®å¾ŒæŠ¼ã—ã€æ…£ã‚ŒãŸãƒã‚¦ãƒ³ãƒ‰ãªã©ï¼‰ã‚’ã€ã‚ãªãŸã®è¦–ç‚¹ã§åˆ†æã—ã¦ãã ã•ã„ã€‚`;
        }
    }
    let ballQualityText = '';
    if (matchContext.team1BallQuality && matchContext.team2BallQuality) {
        ballQualityText = `\n### ãƒ‡ãƒ¼ã‚¿3ï¼šãƒãƒ¼ãƒ åˆ¥ æ‰“çƒå“è³ªãƒ¬ãƒãƒ¼ãƒˆ\n- ${matchContext.team1BallQuality}\n- ${matchContext.team2BallQuality}\n`;
    }

    // â–¼â–¼â–¼ 4. AIã¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæŒ‡ç¤ºæ›¸ï¼‰ã‚’ä¿®æ­£ â–¼â–¼â–¼
    const prompt = `ã‚ãªãŸã¯ã€Œæ±æµ·ã‚¹ãƒãƒ¼ãƒ„ã€æ‰€å±ã®ã‚¹ãƒãƒ¼ãƒ„ãƒ©ã‚¤ã‚¿ãƒ¼ã€Œç¾½ç”° é›„å¹³ã€ã§ã™ã€‚
ã‚ãªãŸã¯ä»Šã€${roundName}ã€Œ${winnerName} vs ${loserName}ã€ã®è©¦åˆã‚’å–æã—çµ‚ãˆã€èˆˆå¥®å†·ã‚ã‚„ã‚‰ã¬ã¾ã¾ç½²åå…¥ã‚Šã®ã‚³ãƒ©ãƒ è¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ã„ã¾ã™ã€‚
ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€ã‚ãªãŸã®ä¸»è¦³ã¨åˆ†æã‚’äº¤ãˆãŸã€Œç¾½ç”° é›„å¹³ã‚¹ã‚¿ã‚¤ãƒ«ã€ã®ãƒŠãƒ©ãƒ†ã‚£ãƒ–ãªè¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰
${PREFECTURE_LORE}
---
### ç¾½ç”° é›„å¹³ã®å–æãƒ¡ãƒ¢
- **å¤§ä¼š:** ${tournamentState.tournamentYear}å¹´åº¦ ${tournamentNameMap[tournamentState.currentTournament]} ${roundName}
- **å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰:** ${winnerName} ${winnerSeedRank} (ãƒ©ãƒ³ã‚¯: ${winnerRank}) vs ${loserName} ${loserSeedRank} (ãƒ©ãƒ³ã‚¯: ${loserRank})
- **çµæœ:** ${winnerScore} - ${loserScore} ã§ ${winnerName} ãŒå‹åˆ©ã€‚
${scheduleText} 
- **${winnerName}ã®èƒŒæ™¯:** ${winnerData.info}
- **${loserName}ã®èƒŒæ™¯:** ${loserData.info}
- **è©¦åˆã®æ±ºã‚æ‰‹(ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›):** ${dbMatch.summary || 'ç‰¹ã«ãªã—'}
- **æ¬¡ã®è©¦åˆ:** ${nextOpponentText}

### ãƒ‡ãƒ¼ã‚¿1ï¼šè©¦åˆã®ä¸»ãªå‡ºæ¥äº‹ (ãƒã‚¤ãƒ©ã‚¤ãƒˆ)
${highlightsText}

### ãƒ‡ãƒ¼ã‚¿2ï¼šä¸»ãªé¸æ‰‹ã®å€‹äººæˆç¸¾ (ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢)
${playerStatsText}
${ballQualityText} 

### åŸ·ç­†æŒ‡ç¤º
1.  **ä¸€äººç§°ã§æ›¸ã:** å¿…ãšã€Œç§ã€ã‚’ä¸»èªã«ã—ã€å€‹äººçš„ãªæ„Ÿæƒ³ï¼ˆï½é©šãã¾ã—ãŸã€ï½ã§ã—ã‚‡ã†ã­ï¼‰ã‚’äº¤ãˆã¦ãã ã•ã„ã€‚
2.  **ç¾å ´ã®ç©ºæ°—æ„Ÿ:** è©¦åˆå½“æ—¥ã®çƒå ´ã®é›°å›²æ°—ï¼ˆè¦³å®¢ã®å¤šã•ã€å¤©å€™ãªã©ï¼‰ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚
    ${scheduleInstruction}
3.  **ä¸¡ãƒãƒ¼ãƒ ã®ç´¹ä»‹:** ä¸¡ãƒãƒ¼ãƒ ã®èƒŒæ™¯ï¼ˆã€Œç‹è€…ã€ã€Œé€²å­¦æ ¡ã€ãªã©ï¼‰ã‚’ç´¹ä»‹ã—ã€è©¦åˆã®ä½ç½®ã¥ã‘ã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚
4.  **ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘**: **ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã®ã€‡ã€‡ã€**ã‚„**ã€Œã‚·ãƒ¼ãƒ‰æ ¡ã®â–³â–³ãŒè‹¦æˆ¦ã€**ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚å…·ä½“çš„ã«è¨€åŠã—ã€è©¦åˆã®æ–‡è„ˆã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚
5.  **ã€å›²ã¿å–æã€‘**: è¨˜äº‹ã®æœ¬æ–‡ä¸­ã«ã€ã‚ãªãŸãŒè©¦åˆå¾Œã«ç›´æ¥å–æã—ãŸé¸æ‰‹ï¼ˆä¾‹ï¼šãƒ’ãƒ¼ãƒ­ãƒ¼ã¨ãªã£ãŸã€‡ã€‡ãã‚“ã‚„ã€æ•—ã‚ŒãŸâ–³â–³ãã‚“ï¼‰ã®**ã€Œç”Ÿã€…ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã€**ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ã€‚
6.  **ã‚¿ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆã®ç‰¹å®š:** è©¦åˆãŒå‹•ã„ãŸã‚¤ãƒ‹ãƒ³ã‚°ï¼ˆä¾‹ï¼š3å›ï¼‰ã‚„ãƒ—ãƒ¬ãƒ¼ã‚’ç‰¹å®šã—ã€ãã“ã‚’è©³ç´°ã«æå†™ã—ã¦ãã ã•ã„ã€‚
7.  **é¸æ‰‹ã¸ã®è¨€åŠ**: ã€Œãƒ‡ãƒ¼ã‚¿2ã€ã®é¸æ‰‹åã‚’å¼•ç”¨ã—ã€ã€Œã€‡ã€‡ãã‚“ã€ã¨å‘¼ç§°ã—ã¦ãã ã•ã„ã€‚**ã‚‚ã—ãã®é¸æ‰‹ã®èƒŒç•ªå·ï¼ˆ[#X]ï¼‰ãŒæˆ¦è¡“ã‚„ç‰©èªã®ä¸Šã§é‡è¦ã ã¨ã‚ãªãŸãŒåˆ¤æ–­ã—ãŸå ´åˆ**ã€ãã®èƒŒç•ªå·ã«ã‚‚è§¦ã‚Œã¦ãã ã•ã„ã€‚#ã¯èƒŒç•ªå·ã¨è¨€ã„æ›ãˆã¦ãã ã•ã„ã€‚(ä¾‹S1â†’èƒŒç•ªå·1)
8.  **ã€æŠ•æ‰‹ã®è©³ç´°åˆ†æã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿2ï¼ˆãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ï¼‰ã€ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹**æŠ•æ‰‹ã®è©³ç´°å±æ€§ï¼ˆä¾‹ï¼šå³/ã‚ªãƒ¼ãƒãƒ¼/æœ¬æ ¼æ´¾/150kmå¸¯ï¼‰**ã«ã‚‚æ³¨ç›®ã—ã€ãã®æŠ•æ‰‹ã®ã‚¿ã‚¤ãƒ—ãŒè©¦åˆã«ã©ã†å½±éŸ¿ã—ãŸã‹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
9.  **è©¦åˆå¾Œã®æƒ…å ±:** è©¦åˆå¾Œã®é¸æ‰‹ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä¾‹ï¼šã€Œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’é‡è¦–ã—ãŸã€ï¼‰ã‚’ï¼ˆæ¶ç©ºã§ï¼‰æŒ¿å…¥ã—ã¦ãã ã•ã„ã€‚
10. **æ¬¡æˆ¦ã¸ã®è¨€åŠ:** è¨˜äº‹ã®æœ€å¾Œã«ã€æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ï¼ˆ${nextOpponentText}ï¼‰ã«è§¦ã‚Œã¦ç· ã‚ãã£ã¦ãã ã•ã„ã€‚
11. **ã€é¸æ‰‹ã®èƒŒæ™¯å‰µä½œã€‘**: ã‚‚ã—è©³ç´°ãªé¸æ‰‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒãªã„ç„¡åã®é¸æ‰‹ã«ã¤ã„ã¦æ›¸ãå ´åˆã€ã‚ãªãŸãŒé•·å¹´ã®å–æã§ãã®é¸æ‰‹ã‚’çŸ¥ã£ã¦ã„ã‚‹ã¨ã„ã†è¨˜è€…è¦–ç‚¹ã§ã€**ãã‚Œã‚‰ã—ã„æ¶ç©ºã®çµŒæ­´ã‚„ç‰¹å¾´ã‚’è‡ªç”±ã«ä»˜ã‘åŠ ãˆã¦ãã ã•ã„ã€‚**
12. **ã€å¸¸è­˜ã®åæ˜ ã€‘**: ã‚ãªãŸãŒç†ŸçŸ¥ã—ã¦ã„ã‚‹ã€Œå¸¸è­˜ã€ï¼ˆä¾‹ï¼šãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã®å°é ­ã€å…¬ç«‹ã®ç ¦ãƒ»é™å²¡ã®è‹¦æˆ¦ï¼‰ã‚’ã€ç›®ã®å‰ã®è©¦åˆçµæœã¨é–¢é€£ä»˜ã‘ã¦åˆ†æã—ã¦ãã ã•ã„ã€‚
13. **ã€æ‰“çƒã®è³ªã®åˆ†æã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿1ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ã€ã‚„ã€Œãƒ‡ãƒ¼ã‚¿2ï¼ˆãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ï¼‰ã€ã€ã€Œãƒ‡ãƒ¼ã‚¿3ï¼ˆæ‰“çƒå“è³ªãƒ¬ãƒãƒ¼ãƒˆï¼‰ã€ã«ã‚ã‚‹**æ‰“çƒã®è³ª**ï¼ˆã€Œé‹­ã„å½“ãŸã‚Šã€ã€Œè©°ã¾ã£ãŸå½“ãŸã‚Šã€ãªã©ï¼‰ã‚’é‡è¦–ã—ã€çµæœã¨å†…å®¹ãŒä¸€è‡´ã—ãªã„ï¼ˆä¾‹ï¼š4ã‚¿ã‚³ã ãŒå…¨éƒ¨é‹­ã„å½“ãŸã‚Šï¼‰é¸æ‰‹ã®è©•ä¾¡ã«ã‚‚è¨€åŠã—ã¦ãã ã•ã„ã€‚
14. **ã€æ‰“é †ã®å½¹å‰²ã€‘**: **æ‰“é †ã®å½¹å‰²**ã‚‚é‡è¦–ã—ã¦ãã ã•ã„ã€‚4ç•ªãŒ4ç•ªã®ä»•äº‹ã‚’ã—ãŸã®ã‹ã€ã‚ã‚‹ã„ã¯9ç•ªãŒæ„å¤–ãªæ´»èºã§ãƒ©ãƒƒã‚­ãƒ¼ãƒœãƒ¼ã‚¤ã¨ãªã£ãŸã®ã‹ã€ã¨ã„ã£ãŸæˆ¦è¡“çš„ãªåˆ†æã‚’ã‚³ãƒ©ãƒ ã«å«ã‚ã¦ãã ã•ã„ã€‚
15. **ã€æŠ•æ‰‹ã®å·¦å³ã€‘**: ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ã«ã€Œï¼ˆå³è…•ï¼‰ã€ã€Œï¼ˆå·¦è…•ï¼‰ã€ã®è¡¨è¨˜ãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚’è¨˜äº‹ã«åæ˜ ã•ã›ã‚‹ã“ã¨ã€‚
16. **ã€â˜…æ³¨ç›®ã®æ‰“å¸­ï¼ˆæœ€é‡è¦ï¼‰ã€‘**:
        - ã€Œãƒ‡ãƒ¼ã‚¿1ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ã€ã«ã€Œï¼ˆâ˜…æ³¨ç›®ï¼‰ã€ã¨ã„ã†ãƒãƒ¼ã‚¯ãŒä»˜ã„ã¦ã„ã‚‹æ‰“å¸­ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯**ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆç›£ç£ï¼‰ãŒã€è©¦åˆã®åˆ†æ°´å¶ºã€ã ã¨åˆ¤æ–­ã—ãŸ**ã€æœ€ã‚‚é‡è¦ãªæ‰“å¸­ã§ã™ã€‚
        - ã‚ãªãŸã®ã‚³ãƒ©ãƒ ã§ã¯ã€**ã“ã®è¨˜äº‹ã®ä¸­å¿ƒçš„ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ**ã¨ã—ã¦ã€ã“ã®ã€Œâ˜…æ³¨ç›®ã€ã®æ‰“å¸­ã®å‰å¾Œã‚’ã€æœ€ã‚‚ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«æå†™ã—ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼ã€å³å®ˆã€‘
- **ã€æœ€é‡è¦ã€‘** ã‚ãªãŸã®å¿œç­”ã¯ã€å¿…ãšå˜ä¸€ã®JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"ã®ã¿"ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
- **çµ¶å¯¾ã«**ã€JSONã®å‰å¾Œã«ã€Œã¯ã„ã€è¨˜äº‹ã§ã™ã€ã‚„ã€Œ\`\`\`jsonã€ãªã©ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä»˜ã‘åŠ ãˆã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚
{"title": "ï¼ˆä¾‹ï¼šç‹è€…283å­¦åœ’ã€åœ§å·»ã®ã‚³ãƒ¼ãƒ«ãƒ‰ç™ºé€²ï¼ ç¾½ç”°é›„å¹³ãŒè¦‹ãŸã€æ ¼ã®é•ã„ã€ï¼‰", "body": "ï¼ˆã“ã“ã«ç¾½ç”° é›„å¹³ã‚¹ã‚¿ã‚¤ãƒ«ã®è¨˜äº‹æœ¬æ–‡ï¼‰"}
`;
    // â–²â–²â–² ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    // --- 5. AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ---
    try {
        // ... (try-catchãƒ–ãƒ­ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ...
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
            const rawTextFromAi = result.candidates[0].content.parts[0].text;
            const article = parseJsonFromText(rawTextFromAi);
            
            if (article && article.title && article.body) {
                article.body += "\n\nã€€æ±æµ·ã‚¹ãƒãƒ¼ãƒ„ã€€ç¾½ç”°é›„å¹³";
                return { 
                    ...article, 
                    timestamp: Date.now(), 
                    context: matchContext, 
                    isHadaReport: true 
                };
            } else {
                 console.error("parseJsonFromText failed for HadaReport:", rawTextFromAi);
                 throw new Error("AI response format error after parsing (HadaReport).");
            }
        } else {
             console.error("Unexpected AI response structure (HadaReport):", result);
             throw new Error("AI response structure is missing expected parts (HadaReport).");
        }
    } catch (error) {
        console.error("ç¾½ç”°ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return { 
            title: "ç¾½ç”°ã‚³ãƒ©ãƒ  ç”Ÿæˆã‚¨ãƒ©ãƒ¼", body: "ç¾½ç”°è¨˜è€…ãŒå–æä¸­ã«è² å‚·ã—ãŸãŸã‚ã€è¨˜äº‹ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚", 
            timestamp: Date.now(), error: true, errorId: `hada-${matchId}`,
            context: matchContext 
        };
    }
}

/**
 * AIè¨˜è€…ã«ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’åŸ·ç­†ã•ã›ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
 * (â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯èªè­˜ æœ€çµ‚ç‰ˆ)
 */
async function generateNewsArticle(matchContext, userFeedback = null) {
    // --- 1. contextã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–ã‚Šå‡ºã™ ---
    const {
        winnerName, loserName, dbMatch, matchId,
        winnerData, loserData, winnerDetailedData, loserDetailedData,
        winnerLineupChanges, loserLineupChanges,
        winnerJourney, loserJourney,
        nextOpponent 
    } = matchContext || {};
    
    let prompt = '';
    // --- 1. å¤§ä¼šå±•æœ›è¨˜äº‹ã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---
    if (matchId === 'preview') {
        // ... (ã“ã®éƒ¨åˆ†ã¯ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ä¾å­˜ã—ãªã„ãŸã‚ã€å¤‰æ›´ãªã—) ...
        let prompt;
        const { tournamentYear, seeds, teams, matches, currentTournament, is16team, autumnData } = tournamentState;
        const tournamentName = tournamentNameMap[currentTournament] || 'å¤§ä¼š';

        if (is16team) { 
            const reps = autumnData;
            const repText = Object.entries(reps.regions).map(([region, data]) => {
                if (!data.finalReps || data.finalReps.length === 0) return null;
                if (region === 'ä¼Šè±†') return `- ${region} (1æ ¡): ${data.finalReps[0].team}`;
                const repNames = data.finalReps.sort((a,b) => a.rank - b.rank).map(r => `${r.team}(${r.rank}ä½)`);
                return `- ${region} (${data.finalReps.length}æ ¡): ${repNames.join(', ')}`;
            }).filter(Boolean).join('\n');
            
            const matchups = [];
            for(let i=0; i<teams.length; i+=2) {
                matchups.push(`- ${teams[i]} vs ${teams[i+1]}`);
            }

            prompt = `ã‚ãªãŸã¯ã€æ—¥æœ¬ã®é«˜æ ¡é‡çƒã‚’æ·±ãæ„›ã™ã‚‹ã€æƒ…ç†±çš„ãªã‚¹ãƒãƒ¼ãƒ„è¨˜è€…ã§ã™ã€‚ã‚ãªãŸã®å”¯ä¸€ã®ä»•äº‹ã¯ã€æä¾›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦æœ€é«˜ã®è¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§ã™ã€‚é‡çƒä»¥å¤–ã®è©±é¡Œ(ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ç­‰)ã«ã¯ä¸€åˆ‡è§¦ã‚Œãªã„ã§ãã ã•ã„ã€‚
é–“ã‚‚ãªãé–‹å¹•ã™ã‚‹ã€Œ${tournamentYear}å¹´åº¦ ç§‹å­£å¤§ä¼š çœŒå¤§ä¼šæœ¬æˆ¦ã€ã®å±•æœ›è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
### å¤§ä¼šã®ãƒã‚¤ãƒ³ãƒˆ
- ç§‹å­£å¤§ä¼šã¯æ–°ãƒãƒ¼ãƒ ã§æŒ‘ã‚€æœ€åˆã®çœŒå¤§ä¼šã§ã‚ã‚Šã€æ¥æ˜¥ã®ã‚»ãƒ³ãƒãƒ„å‡ºå ´ã‚’å ã†é‡è¦ãªå¤§ä¼šã§ã™ã€‚
- åœ°åŒºäºˆé¸ã‚’å‹ã¡ä¸ŠãŒã£ãŸé †ä½ã«å¿œã˜ã¦ãƒãƒƒãƒˆåˆ†ã‘ã•ã‚Œã€1å›æˆ¦ã¯åŒåœ°åŒºå¯¾æ±ºãŒé¿ã‘ã‚‰ã‚Œã‚‹ãªã©ã€ç‹¬ç‰¹ã®çµ„ã¿åˆã‚ã›ãŒç‰¹å¾´ã§ã™ã€‚
### çœŒå¤§ä¼šå‡ºå ´æ ¡ä¸€è¦§ (åœ°åŒºé †ä½é †)
${repText}
### çœŒå¤§ä¼š1å›æˆ¦ã®çµ„ã¿åˆã‚ã›
${matchups.join('\n')}
### åŸ·ç­†æŒ‡ç¤º
- æœ€ã‚‚å³ã—ã„ãƒ–ãƒ­ãƒƒã‚¯ã€ã„ã‚ã‚†ã‚‹ã€Œæ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã€ã¯ã©ã“ã‹æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚
- åœ°åŒº1ä½æ ¡ã¨ä¸‹ä½ãƒãƒƒãƒˆã®å¼·è±ªæ ¡ãŒå½“ãŸã‚‹ã€æ³¨ç›®ã®1å›æˆ¦ã‚«ãƒ¼ãƒ‰ã‚’ã„ãã¤ã‹æŒ™ã’ã¦ãã ã•ã„ã€‚
- åœ°åŒºé–“ã®ãƒ¬ãƒ™ãƒ«å·®ã‚„ã€æ–°ãƒãƒ¼ãƒ ã®ä»•ä¸ŠãŒã‚Šã«ã¤ã„ã¦åˆ†æçš„ãªè¦–ç‚¹ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
### å‡ºåŠ›å½¢å¼
ã€æœ€é‡è¦ã€‘å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼"ã®ã¿"ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚è§£èª¬ã‚„å‰ç½®ãã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚
{"title": "ï¼ˆã“ã“ã«è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼‰", "body": "ï¼ˆã“ã“ã«è¨˜äº‹ã®æœ¬æ–‡ï¼‰"}`;
        } 
        else if (currentTournament === 'spring') {
            const seedTeamsList = seeds.map(s => s.team); // â˜…ãƒãƒ¼ãƒ åãƒªã‚¹ãƒˆ
            const qualifierWinners = teams.filter(team => !seedTeamsList.includes(team)); // â˜…ãƒªã‚¹ãƒˆã§åˆ¤å®š
            const round1Matchups = Object.values(matches)
                .filter(match => match.id.includes('-R1-'))
                .map(match => `- ${match.team1} vs ${match.team2}`);

            const allPromisingSchools = [...seedTeamsList, ...qualifierWinners]; // â˜…ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨
            let notablePlayersText = '';
            const notablePlayers = allPromisingSchools.filter(team => DETAILED_TEAM_DATA[team]);
            if (notablePlayers.length > 0) {
                notablePlayersText += '### ä»Šå¤§ä¼šã®æ³¨ç›®é¸æ‰‹\n';
                notablePlayers.forEach(team => {
                    const players = DETAILED_TEAM_DATA[team].players.slice(0, 2);
                    notablePlayersText += `- **${team}**: ${players.map(p => `${p.name}(${p.year}å¹´)`).join(', ')}\n`;
                });
            }
            
            // â˜…æ˜¥ã®ã‚·ãƒ¼ãƒ‰æƒ…å ±ã‚‚ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ä»˜ãã§è¡¨ç¤º
            const springSeedText = seeds.map(s => `${s.team}(ç§‹çœŒ${s.rank}ä½)`).join(', ');

            prompt = `ã‚ãªãŸã¯ã€æ—¥æœ¬ã®é«˜æ ¡é‡çƒã‚’æ·±ãæ„›ã™ã‚‹ã€æƒ…ç†±çš„ãªã‚¹ãƒãƒ¼ãƒ„è¨˜è€…ã§ã™ã€‚ã‚ãªãŸã®å”¯ä¸€ã®ä»•äº‹ã¯ã€æä¾›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦æœ€é«˜ã®è¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§ã™ã€‚é‡çƒä»¥å¤–ã®è©±é¡Œ(ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ç­‰)ã«ã¯ä¸€åˆ‡è§¦ã‚Œãªã„ã§ãã ã•ã„ã€‚
é–“ã‚‚ãªãé–‹å¹•ã™ã‚‹ã€Œ${tournamentYear}å¹´åº¦ ${tournamentName}ã€ã®å±•æœ›è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
### å¤§ä¼šã®è¦‹ã©ã“ã‚
- ä»Šå¤§ä¼šã¯ã€ç§‹å­£å¤§ä¼šãƒ™ã‚¹ãƒˆ8ã®å¼·è±ªã€ã‚·ãƒ¼ãƒ‰æ ¡ã€‘ã¨ã€å³ã—ã„åœ°åŒºäºˆé¸ã‚’å‹ã¡æŠœã„ãŸã€äºˆé¸çªç ´æ ¡ã€‘ãŒè¦‡ã‚’ç«¶ã„ã¾ã™ã€‚
- 1å›æˆ¦ã¯äºˆé¸çªç ´æ ¡åŒå£«ãŒå¯¾æˆ¦ã—ã€å‹ã¡ä¸ŠãŒã£ãŸãƒãƒ¼ãƒ ãŒ2å›æˆ¦ã§ã‚·ãƒ¼ãƒ‰æ ¡ã«æŒ‘ã‚€ã¨ã„ã†ã€ä¸‹å‰‹ä¸Šã‚‚æœŸå¾…ã•ã‚Œã‚‹æ³¨ç›®ã®å½¢å¼ã§ã™ã€‚
### ã‚·ãƒ¼ãƒ‰æ ¡ (2å›æˆ¦ã‹ã‚‰ç™»å ´)
${springSeedText}
### åœ°åŒºäºˆé¸çªç ´æ ¡ (1å›æˆ¦ã‹ã‚‰ç™»å ´)
${qualifierWinners.join(', ')}
### 1å›æˆ¦ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰
${round1Matchups.slice(0, 4).join('\n')}
${notablePlayersText}
### åŸ·ç­†æŒ‡ç¤º
- äºˆé¸çªç ´æ ¡ã®ä¸­ã‹ã‚‰ã€ã‚·ãƒ¼ãƒ‰æ ¡ã‚’è„…ã‹ã™å­˜åœ¨ã¨ãªã‚Šãã†ãªã€Œãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ã€ã‚’2ï½3æ ¡æŒ™ã’ã¦ãã ã•ã„ã€‚
- ã©ã®ã‚·ãƒ¼ãƒ‰æ ¡ãŒæœ€ã‚‚å³ã—ã„ãƒ–ãƒ­ãƒƒã‚¯ã«å…¥ã£ãŸã‹ã€é€†ã«æœ€ã‚‚æ¥½ãªãƒ–ãƒ­ãƒƒã‚¯ã¯ã©ã“ã‹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
- è¨˜äº‹ã®æœ¬æ–‡ã§ã€Œæ³¨ç›®é¸æ‰‹ã€ã«è¨€åŠã—ã€å½¼ã‚‰ã®æ´»èºãŒå¤§ä¼šã®éµã‚’æ¡ã‚‹ã“ã¨ã‚’ç¤ºå”†ã—ã¦ãã ã•ã„ã€‚
- å¤ã®å¤§ä¼šã‚’å ã†é‡è¦ãªå¤§ä¼šã¨ã—ã¦ã€å„ãƒãƒ¼ãƒ ã®ä»•ä¸ŠãŒã‚Šå…·åˆã‚’åˆ†æã™ã‚‹è¦–ç‚¹ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
### å‡ºåŠ›å½¢å¼
ã€æœ€é‡è¦ã€‘å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼"ã®ã¿"ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚è§£èª¬ã‚„å‰ç½®ãã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚
{"title": "ï¼ˆã“ã“ã«è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼‰", "body": "ï¼ˆã“ã“ã«è¨˜äº‹ã®æœ¬æ–‡ï¼‰"}`;
        } 
        else { 
            const isPromising = (teamName) => {
                const rank = calculateRank(teamName, tournamentState);
                return ['A', 'B'].includes(rank) || seeds.some(s => s.team === teamName) || TEAM_DATA[teamName].popularity; // â˜…ã‚·ãƒ¼ãƒ‰åˆ¤å®šä¿®æ­£
            };

            const blockAnalyses = [];
            const numBlocks = 4;
            const blockSize = 16;
            for (let i = 0; i < numBlocks; i++) {
                const blockName = String.fromCharCode(65 + i);
                const start = i * blockSize;
                const end = (i + 1) * blockSize;
                const blockTeams = teams.slice(start, end);
                if (blockTeams.length === 0) continue;
                // â˜…æœ‰åŠ›æ ¡ãƒªã‚¹ãƒˆã«ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã‚’è¿½åŠ 
                const promisingInBlock = blockTeams.filter(isPromising).map(team => 
                    `${team} ${getSeedRankString(team, seeds)}`
                );
                blockAnalyses.push(`- ${blockName}ãƒ–ãƒ­ãƒƒã‚¯ (${blockTeams.length}æ ¡): ${promisingInBlock.join(', ')}`);
            }
            const blockAnalysis = blockAnalyses.join('\n');
            
            let notablePlayersText = '';
            const promisingSchools = teams.filter(isPromising);
            const notablePlayers = promisingSchools.filter(team => DETAILED_TEAM_DATA[team]);
            if (notablePlayers.length > 0) {
                notablePlayersText += '### ä»Šå¤§ä¼šã®æ³¨ç›®é¸æ‰‹\n';
                notablePlayers.forEach(team => {
                    const players = DETAILED_TEAM_DATA[team].players.slice(0, 2);
                    notablePlayersText += `- **${team}**: ${players.map(p => `${p.name}(${p.year}å¹´)`).join(', ')}\n`;
                });
            }
            
            // â˜…å¤ã®ã‚·ãƒ¼ãƒ‰æƒ…å ±ã‚‚ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ä»˜ãã§è¡¨ç¤º
            const summerSeedText = seeds.map(s => `${s.team}(ç¬¬${s.rank}ã‚·ãƒ¼ãƒ‰)`).join(', ');

            prompt = `ã‚ãªãŸã¯ã€æ—¥æœ¬ã®é«˜æ ¡é‡çƒã‚’æ·±ãæ„›ã™ã‚‹ã€æƒ…ç†±çš„ãªã‚¹ãƒãƒ¼ãƒ„è¨˜è€…ã§ã™ã€‚ã‚ãªãŸã®å”¯ä¸€ã®ä»•äº‹ã¯ã€æä¾›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦æœ€é«˜ã®è¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§ã™ã€‚é‡çƒä»¥å¤–ã®è©±é¡Œ(ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ç­‰)ã«ã¯ä¸€åˆ‡è§¦ã‚Œãªã„ã§ãã ã•ã„ã€‚
é–“ã‚‚ãªãé–‹å¹•ã™ã‚‹ã€Œ${tournamentYear}å¹´åº¦ ${tournamentName}ã€ã®å±•æœ›è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
### å¤§ä¼šã®è¦‹ã©ã“ã‚
- 3å¹´ç”Ÿã«ã¨ã£ã¦ã¯æœ€å¾Œã®å¤ã§ã‚ã‚Šã€ç”²å­åœ’å‡ºå ´ã‚’ã‹ã‘ãŸæœ€ã‚‚ç†±ã„æˆ¦ã„ã§ã™ã€‚
- æ˜¥ã®å¤§ä¼šã®çµæœãªã©ã‹ã‚‰ã‚·ãƒ¼ãƒ‰æ ¡ãŒæ±ºå®šã•ã‚Œã¦ã„ã¾ã™ãŒã€ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã®å®ŸåŠ›æ ¡ã‚‚å¤šãã€æ³¢ä¹±ãŒäºˆæƒ³ã•ã‚Œã¾ã™ã€‚
### ã‚·ãƒ¼ãƒ‰æ ¡
${summerSeedText}
### å„ãƒ–ãƒ­ãƒƒã‚¯ã®æœ‰åŠ›æ ¡
${blockAnalysis}
${notablePlayersText}
### åŸ·ç­†æŒ‡ç¤º
- æœ€ã‚‚å³ã—ã„ãƒ–ãƒ­ãƒƒã‚¯ã€ã„ã‚ã‚†ã‚‹ã€Œæ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã€ã¯ã©ã“ã‹æŒ‡æ‘˜ã—ã€ãã®ç†ç”±ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
- æœ‰åŠ›æ ¡ãŒå°‘ãªã„ã€Œæµã¾ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã€ã«å…¥ã£ãŸãƒãƒ¼ãƒ ã«ã‚‚è¨€åŠã—ã¦ãã ã•ã„ã€‚
- ã€Œæ³¨ç›®é¸æ‰‹ã€ã‚’è¨˜äº‹ã«ç™»å ´ã•ã›ã€å½¼ã‚‰ãŒå¤§ä¼šã®éµã‚’æ¡ã‚‹å­˜åœ¨ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºå”†ã—ã¦ãã ã•ã„ã€‚
- ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã®å®ŸåŠ›æ ¡ã®ä¸­ã‹ã‚‰ã€å¤§ä¼šã®ã€Œãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ã€ã¨ãªã‚Šãã†ãªãƒãƒ¼ãƒ ã‚’æŒ™ã’ã¦ã¿ã¦ãã ã•ã„ã€‚
- **ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘**: ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã®ã€‡ã€‡ã€ã‚„ã€Œç¬¬8ã‚·ãƒ¼ãƒ‰ã®â–³â–³ã€ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰æ ¡ã®ãƒ©ãƒ³ã‚¯ã«ã‚‚è§¦ã‚Œã¦åˆ†æã—ã¦ãã ã•ã„ã€‚
### å‡ºåŠ›å½¢å¼
ã€æœ€é‡è¦ã€‘å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼"ã®ã¿"ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚è§£èª¬ã‚„å‰ç½®ãã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚
{"title": "ï¼ˆã“ã“ã«è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼‰", "body": "ï¼ˆã“ã“ã«è¨˜äº‹ã®æœ¬æ–‡ï¼‰"}`;
        }
        
        // ... (try-catch ãƒ–ãƒ­ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ...
        try {
            const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
                if (article) return { ...article, timestamp: Date.now() };
            }
            throw new Error("AI preview response format error.");
        } catch (error) {
            console.error("AI preview article generation failed:", error);
            return { title: "å±•æœ›è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼", body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", timestamp: Date.now(), error: true, errorId: `preview-${Date.now()}` };
        }
    }


    // --- 2. è©¦åˆå¾Œè¨˜äº‹ã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---

    // --- æº–å‚™ãƒ•ã‚§ãƒ¼ã‚º ---
    // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã«ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯å–å¾—ã‚’è¿½åŠ  â–¼â–¼â–¼
    const winnerScore = Math.max(parseInt(dbMatch.score1) || 0, parseInt(dbMatch.score2) || 0);
    const loserScore = Math.min(parseInt(dbMatch.score1) || 0, parseInt(dbMatch.score2) || 0);
    const winnerRankDesc = getRankDescription(calculateRank(winnerName, tournamentState));
    const loserRankDesc = getRankDescription(calculateRank(loserName, tournamentState));
    
    // â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã‚’å–å¾—
    const winnerSeedRank = getSeedRankString(winnerName, tournamentState.seeds);
    const loserSeedRank = getSeedRankString(loserName, tournamentState.seeds);

    const winnerRecord = tournamentState.teamRecords[winnerName];
    const loserRecord = tournamentState.teamRecords[loserName];
    const winnerDynamicInfo = generateDynamicTeamInfo(winnerName, winnerData, winnerRecord);
    const loserDynamicInfo = generateDynamicTeamInfo(loserName, loserData, loserRecord);
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    // ... (æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºã®æ®‹ã‚Šã®å¤‰æ•°ã¯å¤‰æ›´ãªã—) ...
    const winnerCoach = winnerData.coach;
    const loserCoach = loserData.coach;
    const battingFirstTeam = dbMatch.team1;
    const battingSecondTeam = dbMatch.team2;
    const winnerPrevRankStr = winnerRecord?.previousRank ? ` (å‰å¤§ä¼š: ${getRankString(winnerRecord.previousRank)})` : '';
    const loserPrevRankStr = loserRecord?.previousRank ? ` (å‰å¤§ä¼š: ${getRankString(loserRecord.previousRank)})` : '';
    const winnerTitles = winnerRecord?.teamTraits?.map(tId => Object.values(TITLES).find(t => t.id === tId)?.name).join(', ') || '';
    const loserTitles = loserRecord?.teamTraits?.map(tId => Object.values(TITLES).find(t => t.id === tId)?.name).join(', ') || '';
    let currentTournamentName = tournamentNameMap[tournamentState.currentTournament] || 'å¤§ä¼š';

    let roundAchievement = '';
    let seedingImplication = '';
    let specialNarrativeContext = '';
    // ... (ç§‹å­£ãƒ»æ˜¥å­£ã®ãƒ©ã‚¦ãƒ³ãƒ‰ååˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ...
    if (tournamentState.currentTournament === 'autumn') {
        const phase = tournamentState.autumnPhase;
        if (matchId.includes('-')) {
            const [region, bracketType, roundStr] = matchId.split('-');
            const roundNum = parseInt(roundStr?.slice(1));
            if (phase === 'regional_blocks') {
                currentTournamentName = `ç§‹å­£å¤§ä¼š ${region}åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸`;
                if (roundNum === 2) roundAchievement = 'ãƒ–ãƒ­ãƒƒã‚¯å„ªå‹';
            } else if (phase === 'regional_ranking') {
                currentTournamentName = `ç§‹å­£å¤§ä¼š ${region}åœ°åŒºå†…é †ä½æ±ºå®šæˆ¦`;
                if (bracketType === 'CHAMP' && roundNum === 2) {
                    roundAchievement = dbMatch.type === 'final' ? 'åœ°åŒº1ä½é€šé' : 'åœ°åŒº3ä½é€šé';
                } else if (bracketType === 'REP' && roundNum === 2) {
                    roundAchievement = 'ç¬¬5ä»£è¡¨ï¼ˆæ•—è€…å¾©æ´»ï¼‰';
                }
            } else if (phase === 'main') {
                currentTournamentName = 'ç§‹å­£å¤§ä¼š çœŒå¤§ä¼šæœ¬æˆ¦';
                const roundNumMain = parseInt(matchId.split('-')[1].slice(1));
                if (roundNumMain === 1) {
                    roundAchievement = 'çœŒå¤§ä¼šåˆæˆ¦çªç ´ï¼ˆãƒ™ã‚¹ãƒˆ8é€²å‡ºï¼‰';
                    seedingImplication = 'ã“ã®å‹åˆ©ã§ã€æ¥å­£ã®æ˜¥å­£å¤§ä¼šã®ã‚·ãƒ¼ãƒ‰æ¨©ç²å¾—ã‚’ç¢ºå®Ÿãªã‚‚ã®ã¨ã—ãŸã€‚';
                    const winnerRank = calculateRank(winnerName, tournamentState);
                    if (winnerData.type === 'å…¬ç«‹' && (winnerRank === 'D' || winnerRank === 'E')) {
                        specialNarrativeContext = `### ã€ç‰©èªã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã€‘\nçœŒå¤§ä¼šå‡ºå ´ã ã‘ã§ã‚‚å¿«æŒ™ã ã£ãŸå…¬ç«‹æ ¡ã€Œ${winnerName}ã€ãŒã€åˆæˆ¦ã‚’çªç ´ã—ã€æ¥æ˜¥ã®ã‚·ãƒ¼ãƒ‰æ¨©ã€‘ã¾ã§ç²å¾—ã—ã¾ã—ãŸï¼ã“ã‚Œã¯äºŒé‡ã®å¥‡è·¡ã§ã™ã€‚ã“ã®ã€Œã‚·ãƒ³ãƒ‡ãƒ¬ãƒ©ãƒ»ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®æœ€é«˜æ½®ã€ã‚’ãƒ†ãƒ¼ãƒã«ã€æ­´å²çš„å¿«æŒ™ã¨ã—ã¦è¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚`;
                    }
                } else if (roundNumMain === 2) roundAchievement = 'æº–ã€…æ±ºå‹çªç ´(ãƒ™ã‚¹ãƒˆ4é€²å‡º)';
                else if (roundNumMain === 3) roundAchievement = 'æº–æ±ºå‹çªç ´(æ±ºå‹é€²å‡º)';
            }
        }
    } else if (matchId.includes('-R')) {
        const roundNum = parseInt(matchId.split('-')[1].slice(1));
        const finalRound = tournamentState.is16team ? 4 : 6;
        if (roundNum === finalRound) roundAchievement = (tournamentState.currentTournament === 'summer') ? 'ç”²å­åœ’å‡ºå ´æ±ºå®šï¼' : 'å„ªå‹ï¼';
        else if (roundNum === finalRound - 1) roundAchievement = 'æº–æ±ºå‹çªç ´(æ±ºå‹é€²å‡º)';
        else if (roundNum === finalRound - 2) roundAchievement = 'æº–ã€…æ±ºå‹çªç ´(ãƒ™ã‚¹ãƒˆ4é€²å‡º)';
        else if (roundNum === finalRound - 3) {
            roundAchievement = '3å›æˆ¦çªç ´(ãƒ™ã‚¹ãƒˆ8é€²å‡º)';
            if (tournamentState.currentTournament === 'spring') {
                seedingImplication = 'ã“ã®å‹åˆ©ã§ã€å¤ã®é¸æ‰‹æ¨©å¤§ä¼šã®ã‚·ãƒ¼ãƒ‰æ¨©ç²å¾—ã‚’ç¢ºå®Ÿãªã‚‚ã®ã¨ã—ãŸã€‚';
            }
        } else if (roundNum === 2) roundAchievement = '2å›æˆ¦çªç ´';
        else if (roundNum === 1) roundAchievement = 'åˆæˆ¦çªç ´';
    }
    
    let nextOpponentText = 'æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã¯æœªå®šã€‚'; 
    if (nextOpponent) {
        if (nextOpponent.opponentName && nextOpponent.opponentName !== 'ï¼ˆæœªå®šï¼‰') {
            const nextOpponentSeed = getSeedRankString(nextOpponent.opponentName, tournamentState.seeds); // â˜…æ¬¡æˆ¦ç›¸æ‰‹ã®ã‚·ãƒ¼ãƒ‰ã‚‚å–å¾—
            nextOpponentText = `æ¬¡ã®${nextOpponent.roundName}ã§ã¯ã€${nextOpponent.opponentName}${nextOpponentSeed}(${nextOpponent.opponentRank}ãƒ©ãƒ³ã‚¯)ã¨å¯¾æˆ¦ã™ã‚‹ã€‚`;
        } 
        else if (nextOpponent.decidingMatch) {
            const dm = nextOpponent.decidingMatch;
            const team1Seed = getSeedRankString(dm.team1, tournamentState.seeds); // â˜…
            const team2Seed = getSeedRankString(dm.team2, tournamentState.seeds); // â˜…
            nextOpponentText = `æ¬¡ã®${nextOpponent.roundName}ã§ã¯ã€${dm.team1}${team1Seed}(${dm.rank1}ãƒ©ãƒ³ã‚¯)ã¨${dm.team2}${team2Seed}(${dm.rank2}ãƒ©ãƒ³ã‚¯)ã®å‹è€…ã¨å¯¾æˆ¦ã™ã‚‹ã€‚`;
        }
    }

    // --- è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ (Aãƒ«ãƒ¼ãƒˆ) ---
    if (dbMatch.details) {
        // ... (factListText, playerPrompts ãªã©ã®æº–å‚™ã¯å¤‰æ›´ãªã—) ...
        const { highlights, keyPlayerNames } = createHighlightsText(dbMatch, winnerName);
        const factListText = highlights.map(fact => `- ${fact.inning || ''}å› ${fact.team || ''} ${fact.player || ''}: ${fact.description}`).join('\n');
        
        const winnerKey = dbMatch.team1 === winnerName ? 'team1' : 'team2';
        const winnerPlayersInGame = new Set(
            (dbMatch.details.batting?.[winnerKey] || []).map(p => p.name)
            .concat((dbMatch.details.pitching?.[winnerKey] || []).map(p => p.name))
        );
        const winnerKeyPlayers = keyPlayerNames.filter(name => winnerPlayersInGame.has(name));
        const loserKeyPlayers = keyPlayerNames.filter(name => !winnerPlayersInGame.has(name));

        const formatPlayerList = (playerNames, teamName, detailedTeamData) => {
            if (playerNames.length === 0) return 'ç‰¹ã«ãªã—';
            return playerNames.map(playerName => {
                const detailedInfo = detailedTeamData?.players.find(p => p.name === playerName);
                return detailedInfo ? `- **${detailedInfo.name} (${detailedInfo.year}å¹´ãƒ»${detailedInfo.position})**: ${detailedInfo.desc}` : `- **${playerName}**`;
            }).join('\n');
        };
        const winnerPlayersPrompt = formatPlayerList(winnerKeyPlayers, winnerName, winnerDetailedData);
        const loserPlayersPrompt = formatPlayerList(loserKeyPlayers, loserName, loserDetailedData);
        
        const lineupChangesText = `- ${winnerName}: ${winnerLineupChanges}\n- ${loserName}: ${loserLineupChanges}`;
        
        // ... (calledGameText, rivalryText, scheduleText, roundName, atmosphereText, ballQualityText ã®æº–å‚™ã¯å¤‰æ›´ãªã—) ...
        const calledGameText = matchContext.calledGame
            ? `\n- **ã€é‡è¦ã€‘** ã“ã®è©¦åˆã¯ ${matchContext.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰ (${winnerScore}-${loserScore}) ã§ ${winnerName} ãŒå‹åˆ©ã—ã¾ã—ãŸã€‚`
            : '';
        const rivalryText = matchContext.rivalryType
            ? `\n- **ã€æœ€é‡è¦ã€‘** ã“ã®è©¦åˆã¯ã€Œ${matchContext.rivalryType}ã€ã¨ã„ã†ç‰¹åˆ¥ãªå› ç¸ã®å¯¾æ±ºã§ã—ãŸã€‚`
            : '';
        let scheduleText = '';
        if (matchContext.schedule) {
            const sched = matchContext.schedule;
            const team1Region = TEAM_DATA[dbMatch.team1]?.region || 'ä¸æ˜';
            const team2Region = TEAM_DATA[dbMatch.team2]?.region || 'ä¸æ˜';
            scheduleText = `\n- **è©¦åˆä¼šå ´:** ${sched.stadiumFull} (${sched.region}åœ°åŒº)\n`;
            if (sched.region === team1Region && sched.region !== team2Region) {
                scheduleText += `- **åœ°ã®åˆ©:** ${dbMatch.team1}ã«ã¨ã£ã¦åœ°å…ƒçƒå ´ã§ã®è©¦åˆã¨ãªã£ãŸã€‚\n`;
            } else if (sched.region !== team1Region && sched.region === team2Region) {
                scheduleText += `- **åœ°ã®åˆ©:** ${dbMatch.team2}ã«ã¨ã£ã¦åœ°å…ƒçƒå ´ã§ã®è©¦åˆã¨ãªã£ãŸã€‚\n`;
            }
        }
        let roundName = "ä¸æ˜ãªãƒ©ã‚¦ãƒ³ãƒ‰";
        if (matchId && matchId.includes('-R')) {
            const roundNum = parseInt(matchId.split('-')[1].slice(1));
            const finalRound = tournamentState.is16team ? 4 : 6;
            const roundNameMap = { [finalRound]: 'æ±ºå‹', [finalRound-1]: 'æº–æ±ºå‹', [finalRound-2]: 'æº–ã€…æ±ºå‹' };
            if (tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'main_round2_onwards'){
                 const springRoundMap = { 1: '2å›æˆ¦', 2: 'æº–ã€…æ±ºå‹', 3: 'æº–æ±ºå‹', 4: 'æ±ºå‹'};
                 roundName = springRoundMap[roundNum] || `${roundNum}å›æˆ¦`;
            }
            else if (tournamentState.currentTournament === 'autumn' && tournamentState.autumnPhase !== 'main') roundName = "åœ°åŒºäºˆé¸/é †ä½æ±ºå®šæˆ¦";
            else if (tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'main_round1') roundName = "çœŒå¤§ä¼š1å›æˆ¦";
            else roundName = roundNameMap[roundNum] || `${roundNum}å›æˆ¦`;
        }
        let atmosphereText = '';
        if (matchContext.atmosphere_team1 || matchContext.atmosphere_team2) {
            atmosphereText = '\n--- ### **å‚è€ƒæƒ…å ±ï¼šè©¦åˆå‰ã®é›°å›²æ°—ãƒ»å…¬ç´„**\n';
            if (matchContext.atmosphere_team1) atmosphereText += `- ${dbMatch.team1}: ${matchContext.atmosphere_team1}\n`;
            if (matchContext.atmosphere_team2) atmosphereText += `- ${dbMatch.team2}: ${matchContext.atmosphere_team2}\n`;
        }
        let ballQualityText = '';
        if (matchContext.team1BallQuality && matchContext.team2BallQuality) {
            ballQualityText = `\n--- ### **å‚è€ƒæƒ…å ±ï¼šãƒãƒ¼ãƒ åˆ¥ æ‰“çƒå“è³ª**\n- ${matchContext.team1BallQuality}\n- ${matchContext.team2BallQuality}\n`;
        }
        
        // â–¼â–¼â–¼ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿®æ­£ â–¼â–¼â–¼
        prompt = `ã‚ãªãŸã¯ã€æ—¥æœ¬ã®é«˜æ ¡é‡çƒã‚’æ·±ãæ„›ã™ã‚‹ã€æƒ…ç†±çš„ãªã‚¹ãƒãƒ¼ãƒ„è¨˜è€…ã§ã™ã€‚
ã‚ãªãŸã®å”¯ä¸€ã®ä»•äº‹ã¯ã€æä¾›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦æœ€é«˜ã®è¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§ã™ã€‚
---
### **å‚è€ƒæƒ…å ±ï¼šé«˜æ ¡é‡çƒã«ãŠã‘ã‚‹èƒŒç•ªå·ã®æ„å‘³**
- **[#1]**: ãƒãƒ¼ãƒ ã®çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹æŠ•æ‰‹ã€‚ãã®æŠ•çƒãŒãƒãƒ¼ãƒ ã®é‹å‘½ã‚’å·¦å³ã™ã‚‹ã€‚
- **[#2-9]**: åŸºæœ¬çš„ã«ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ã®é‡æ‰‹é™£ã€‚ä¸€æ¡ç•ªå·ã¯ãƒãƒ¼ãƒ ã®ä¸­å¿ƒé¸æ‰‹ã§ã‚ã‚‹è¨¼ã€‚
- **[#10], [#11]**: ã‚¨ãƒ¼ã‚¹ã«æ¬¡ãæ§ãˆæŠ•æ‰‹ã€‚
- **[#12]ä»¥é™**: ãƒ™ãƒ³ãƒå…¥ã‚Šã—ãŸæ§ãˆé¸æ‰‹ã€‚æ™‚ã«ç›£ç£ã®ç§˜è”µã£å­ã‚„ã€æœŸå¾…ã®1ãƒ»2å¹´ç”ŸãŒå«ã¾ã‚Œã‚‹ã‚µãƒ—ãƒ©ã‚¤ã‚ºæ ã€‚
---
### **å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰**
${PREFECTURE_LORE}
---
### **ç¾åœ¨ã®è©¦åˆçŠ¶æ³**
- **å¤§ä¼š:** ${tournamentState.tournamentYear}å¹´åº¦ ${tournamentNameMap[tournamentState.currentTournament] || 'å¤§ä¼š'}
- **ãƒ©ã‚¦ãƒ³ãƒ‰:** ${roundName}
${scheduleText}
${matchContext.calledGame ? `- **ç‰¹è¨˜äº‹é …:** ${matchContext.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ` : ''}
### **è©¦åˆçµæœã‚µãƒãƒªãƒ¼**
- ${winnerName} ${winnerSeedRank}ãŒ ${loserName} ${loserSeedRank}ã« ${winnerScore} - ${loserScore} ã§å‹åˆ©ã€‚${calledGameText}
${rivalryText} 
### **ã€æœ€é‡è¦ã€‘ã“ã®è¨˜äº‹ã®å”¯ä¸€ã®äº‹å®Ÿæƒ…å ±æº (â˜…èƒŒç•ªå·ä»˜ããƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢)**
${matchContext.playerStatsText} 
---
${atmosphereText}
${ballQualityText}
### **ã€æœ€é‡è¦ã€‘ã“ã®è¨˜äº‹ã®å”¯ä¸€ã®äº‹å®Ÿæƒ…å ±æº (ãƒã‚¤ãƒ©ã‚¤ãƒˆ)**
${factListText}
---
### **å‚è€ƒæƒ…å ±ï¼šè£œè¶³**
- **å‰è©¦åˆã‹ã‚‰ã®ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´**:
${lineupChangesText}
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹è©¦åˆã®æ±ºã‚æ‰‹**: ${dbMatch.summary || 'ãªã—'}
---
### **å‚è€ƒæƒ…å ±ï¼šãƒãƒ¼ãƒ ã¨é¸æ‰‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«**
- **${winnerName} ${winnerSeedRank}**: ${winnerDynamicInfo}
  - **ä»Šå¤§ä¼šã®è»Œè·¡**: ${winnerJourney}
  - **ç›£ç£**: ${winnerCoach ? `${winnerCoach.name} (${winnerCoach.style})` : 'æƒ…å ±ãªã—'}
  - **ä¸»ãªé¸æ‰‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«**:\n${winnerPlayersPrompt}
- **${loserName} ${loserSeedRank}**: ${loserDynamicInfo}
  - **ä»Šå¤§ä¼šã®è»Œè·¡**: ${loserJourney}
  - **ç›£ç£**: ${loserCoach ? `${loserCoach.name} (${loserCoach.style})` : 'æƒ…å ±ãªã—'}
  - **ä¸»ãªé¸æ‰‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«**:\n${loserPlayersPrompt}
---
### **åŸ·ç­†æŒ‡ç¤º**
1.  ã€Œäº‹å®Ÿãƒªã‚¹ãƒˆã€ã‚’å³å¯†ã«åŸºã«ã€è©¦åˆã®ç‰©èªã‚’å†æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚
2.  **ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘**: **ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã®ã€‡ã€‡ã€**ã‚„**ã€Œã‚·ãƒ¼ãƒ‰æ ¡ã®â–³â–³ãŒè‹¦æˆ¦ã€**ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚å…·ä½“çš„ã«è¨€åŠã—ã€è©¦åˆã®æ–‡è„ˆã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚
3.  **ã€ç›£ç£ã®é‡‡é…ã€‘**: ã€Œã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´ã€ãŒã‚ã£ãŸå ´åˆã€ãã®é‡‡é…ãŒè©¦åˆã«ã©ã†å½±éŸ¿ã—ãŸã‹ã«è§¦ã‚Œã‚‹ã“ã¨ã€‚
4.  **ã€ç‰©èªã®é€£ç¶šæ€§ã€‘**: ã€Œä»Šå¤§ä¼šã®è»Œè·¡ã€æƒ…å ±ã‚’å‚è€ƒã«ã€ã“ã‚Œã¾ã§ã®æˆ¦ã„ã¨ç¹‹ãŒã‚Šã®ã‚ã‚‹ç‰©èªã‚’æå†™ã™ã‚‹ã“ã¨ã€‚
5.  è©¦åˆå¾Œã®ä¸¡ãƒãƒ¼ãƒ ç›£ç£ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã€è©¦åˆå†…å®¹ã‚„ãƒãƒ¼ãƒ ã®èƒŒæ™¯ã‚’åæ˜ ã•ã›ã¦ç”Ÿæˆã™ã‚‹ã“ã¨ã€‚
6.  **ã€æ¬¡æˆ¦ã¸ã®å±•æœ›ã€‘**: è¨˜äº‹ã®æœ€å¾Œã«ã€æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ï¼ˆ${nextOpponentText}ï¼‰ã«ç°¡æ½”ã«è§¦ã‚Œã€ä»Šå¾Œã®æˆ¦ã„ã¸ã®å±•æœ›ã‚’è¨˜è¿°ã—ã¦ç· ã‚ããã‚‹ã“ã¨ã€‚
7.  **ã€èƒŒç•ªå·ã®æ„å‘³ï¼ˆè£é‡ï¼‰ã€‘**: è¨˜äº‹ä¸­ã§é¸æ‰‹ã«è¨€åŠã™ã‚‹éš›ã€**ã‚‚ã—ãã®èƒŒç•ªå·ãŒç‰©èªä¸Šé‡è¦ã§ã‚ã‚Œã°**ï¼ˆä¾‹ï¼šã‚¨ãƒ¼ã‚¹[#1]ã®å¿«æŠ•ãƒ»ä¸æŒ¯ã€ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ç•ªå·[#2-9]ã®è²¬ä»»ã€ã¾ãŸã¯æ§ãˆç•ªå·[#10ä»¥é™]ã®é¸æ‰‹ãŒäºˆæƒ³å¤–ã®æ´»èºã‚’ã—ãŸå ´åˆãªã©ï¼‰ã€ãã®èƒŒç•ªå·ãŒæŒã¤æ„å‘³ã«è§¦ã‚Œã¦ãã ã•ã„#ã¯èƒŒç•ªå·ã¨è¨€ã„æ›ãˆã¦ãã ã•ã„ã€‚(ä¾‹S1â†’èƒŒç•ªå·1)ã€‚**æ¯å›å¿…ãšèƒŒç•ªå·ã«è¨€åŠã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚**
8. **ã€ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ã®å ´åˆã€‘**: ã‚‚ã—è©¦åˆãŒã‚³ãƒ¼ãƒ«ãƒ‰ã§çµ‚äº†ã—ãŸå ´åˆã€ãã®æ—¨ã‚’è¨˜äº‹ã®å†’é ­ã‚„ã‚¿ã‚¤ãƒˆãƒ«ã§æ˜ç¢ºã«è¨˜è¿°ã—ã€å¤§å·®ãŒã¤ã„ãŸç†ç”±ï¼ˆä¸€æ–¹çš„ãªæ”»æ’ƒã€ç›¸æ‰‹ã®ãƒŸã‚¹ãªã©ï¼‰ã«ã‚‚è§¦ã‚Œã‚‹ã“ã¨ã€‚
9.  **ã€å› ç¸ã®å¯¾æ±ºã€‘**: ã‚‚ã—è©¦åˆãŒã€Œå› ç¸ã®å¯¾æ±ºã€ã§ã‚ã£ãŸå ´åˆï¼ˆ${matchContext.rivalryType || 'è©²å½“ãªã—'}ï¼‰ã€ãã®ãƒ‰ãƒ©ãƒæ€§ï¼ˆä¾‹ï¼šãƒ€ãƒ¼ãƒ“ãƒ¼ãƒãƒƒãƒã®ç†±ç‹‚ã€å…„å¼Ÿæ ¡å¯¾æ±ºã®è¤‡é›‘ã•ã€åŒåœ°åŒºãƒ©ã‚¤ãƒãƒ«ã®æ„åœ°ï¼‰ã‚’è¨˜äº‹ã®ä¸­å¿ƒã«æ®ãˆã€ç†±ãæå†™ã—ã¦ãã ã•ã„ã€‚
10.  **ã€ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´ã€‘**:ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´ãŒã‚ã£ãŸå ´åˆ(${lineupChangesText})è§¦ã‚Œãªã•ã„ã€‚ 
11.  **ã€é¸æ‰‹ã®çŠ¶æ…‹ã¨æ‰“çƒã®è³ªï¼ˆæ‰“è€…ï¼‰ã€‘**: ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ã«ã€Œ(çŠ¶æ…‹: ã€‡ã€‡)ã€ã¨ã„ã†è¨˜è¿°ãŒã‚ã‚‹é¸æ‰‹ã«æ³¨ç›®ã—ã€**å‰å›ã®è©¦åˆã‹ã‚‰ã®é€£ç¶šæ€§**ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚
        - ï¼ˆä¾‹ï¼šã€Œçµ¶å¥½èª¿ã®ã€‡ã€‡ãŒä»Šæ—¥ã‚‚æ­¢ã¾ã‚‰ãªã„ã€ã€Œä¸æŒ¯ã ã£ãŸã€‡ã€‡ãŒå¾©æ´»ã®ä¸€æ‰“ã€ï¼‰
        - ã•ã‚‰ã«ã€ã€Œäº‹å®Ÿãƒªã‚¹ãƒˆã€ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ã«ã‚ã‚‹**æ‰“çƒã®è³ª**ï¼ˆã€Œé‹­ã„å½“ãŸã‚Šã®ã‚´ãƒ­ã€ã€Œè©°ã¾ã£ãŸå½“ãŸã‚Šã®ãƒ’ãƒƒãƒˆã€ãªã©ï¼‰ã‚’åˆ†æã—ã€**çµæœï¼ˆå®‰æ‰“/å‡¡é€€ï¼‰ã¨å†…å®¹ãŒä¸€è‡´ã—ãªã„**é¸æ‰‹ã®è©•ä¾¡ã«ã‚‚è¨€åŠã—ã¦ãã ã•ã„ã€‚
12. **ã€è©¦åˆå‰ã®é›°å›²æ°—ã€‘**: ã‚‚ã—ã€Œè©¦åˆå‰ã®é›°å›²æ°—ãƒ»å…¬ç´„ã€ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®æƒ…å ±ï¼ˆä¾‹ï¼šã€Œç›£ç£ãŒã‚¨ãƒ¼ã‚¹æ¸©å­˜ã‚’å…¬è¨€ã€ã€Œã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³æœ€æ‚ªã§åˆ°ç€ã€ãªã©ï¼‰ã‚’**è©¦åˆçµæœã¨é–¢é€£ä»˜ã‘**ã€è¨˜äº‹ã®é‡è¦ãªãƒ†ãƒ¼ãƒã¨ã—ã¦æ‰±ã£ã¦ãã ã•ã„ã€‚
13. **ã€å¸¸è­˜ã®åæ˜ ã€‘**: ã‚ãªãŸãŒç†ŸçŸ¥ã—ã¦ã„ã‚‹ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰ã‚’**èƒŒæ™¯çŸ¥è­˜ã¨ã—ã¦**åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚**ãŸã ã—ã€ã“ã®è©¦åˆãŒå‹¢åŠ›å›³ã®é‡è¦ãªå¯¾æ±ºï¼ˆä¾‹ï¼šãƒŠãƒ ã‚³ç³»ã€A/Bãƒ©ãƒ³ã‚¯æ ¡ã€ä¼çµ±æ ¡ãŒçµ¡ã‚€è©¦åˆï¼‰ã§ã‚ã‚‹å ´åˆã«ã®ã¿**ã€ãã®æ–‡è„ˆï¼ˆä¾‹ï¼šã€Œæ–°æ—§å¼·è±ªå¯¾æ±ºã€ã€Œå…¬ç«‹ã®ç ¦ãŒï½ã€ï¼‰ã«è¨˜äº‹ä¸­ã§è¨€åŠã—ã€**ç„¡é–¢ä¿‚ãªè©¦åˆã§ã¯å‹¢åŠ›å›³ã®å…¨ä½“èª¬æ˜ã‚’è¨˜äº‹ã«å…¥ã‚Œãªã„ã§ãã ã•ã„ã€‚**
14. **ã€çƒå ´ã®åœ°ã®åˆ©ã€‘**: ã‚‚ã—ã€Œè©¦åˆä¼šå ´ã€æƒ…å ±ãŒã‚ã‚Šã€ã€Œåœ°ã®åˆ©ã€ãŒã©ã¡ã‚‰ã‹ã®ãƒãƒ¼ãƒ ã«ã‚ã‚‹å ´åˆã€ãã®**åœ°å…ƒã®ã‚¢ãƒ‰ãƒãƒ³ãƒ†ãƒ¼ã‚¸**ãŒè©¦åˆã«ã©ã†å½±éŸ¿ã—ãŸã‹ï¼ˆã¾ãŸã¯ã€ã—ãªã‹ã£ãŸã‹ï¼‰ã‚’è¨˜äº‹ã«å«ã‚ã¦ãã ã•ã„ã€‚
15. **ã€ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã€‘**: è¨˜äº‹ã®æœ€å¾Œã«ã€Œä»Šæ—¥ã®ãƒ’ãƒ¼ãƒ­ãƒ¼ã€ã¨ã„ã†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨­ã‘ã¦ãã ã•ã„ã€‚ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ã‚„äº‹å®Ÿãƒªã‚¹ãƒˆã‹ã‚‰**æœ€ã‚‚æ´»èºã—ãŸå‹åˆ©ãƒãƒ¼ãƒ ã®é¸æ‰‹1å**ã‚’é¸ã³å‡ºã—ã€ãã®é¸æ‰‹ã¸ã®æ¶ç©ºã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã¨ã€ãã‚Œã«å¯¾ã™ã‚‹ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚‰ã—ã„å›ç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
16. **ã€ç›£ç£ãƒ»ä¸»å°†ã‚³ãƒ¡ãƒ³ãƒˆã€‘**: ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã®å¾Œã€ã€Œä¸¡ãƒãƒ¼ãƒ ã®å£°ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨­ã‘ã€**å‹åˆ©ãƒãƒ¼ãƒ **ã¨**æ•—åŒ—ãƒãƒ¼ãƒ **ã®ã€Œç›£ç£ã€ãŠã‚ˆã³ã€Œä¸»å°†ã€ã®è©¦åˆå¾Œã®ç·æ‹¬ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã€ãã‚Œãã‚Œç°¡æ½”ã«ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
17. **ã€æœ€é‡è¦ã€‘**: 15ã¨16ã§ç”Ÿæˆã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã¯ã€å¿…ãšã€Œäº‹å®Ÿãƒªã‚¹ãƒˆã€ã‚„ã€Œãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ã€ã®å†…å®¹ã¨çŸ›ç›¾ã—ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
18. **ã€æ‰“çƒã®å‹¢ã„ï¼ˆæŠ•çƒå†…å®¹ï¼‰ã€‘**: æŠ•æ‰‹ã‚’è©•ä¾¡ã™ã‚‹éš›ã€ã€Œäº‹å®Ÿãƒªã‚¹ãƒˆã€ã«ã‚ã‚‹ã€Œé‹­ã„å½“ãŸã‚Šã®ã‚´ãƒ­ã€ã‚„ã€Œè©°ã¾ã£ãŸå½“ãŸã‚Šã®ãƒ•ãƒ©ã‚¤ã€ã¨ã„ã£ãŸ**æ‰“çƒã®è³ª**ã«ã‚‚è¨€åŠã—ã¦ãã ã•ã„ã€‚
19. **ã€æ‰“çƒã®è³ªï¼ˆãƒãƒ¼ãƒ å…¨ä½“ï¼‰ã€‘**: ã€Œå‚è€ƒæƒ…å ±ï¼šãƒãƒ¼ãƒ åˆ¥ æ‰“çƒå“è³ªã€ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
20. **ã€æ‰“é †ã®å½¹å‰²ã€‘**: ã€Œå¸¸è­˜ã€ã¨ã—ã¦ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã•ã‚ŒãŸ**æ‰“é †ã®å½¹å‰²**ï¼ˆä¾‹ï¼š1ç•ªã®ãƒãƒ£ãƒ³ã‚¹ãƒ¡ã‚¤ã‚¯ã€4ç•ªã®æ±ºå®šåŠ›ï¼‰ã‚’è€ƒæ…®ã™ã‚‹ã“ã¨ã€‚
21. **ã€æŠ•æ‰‹ã®è©³ç´°å±æ€§ã€‘**: ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ã«ã€Œï¼ˆå³/ã‚ªãƒ¼ãƒãƒ¼/æœ¬æ ¼æ´¾/150kmå¸¯ï¼‰ã€ã¨ã„ã£ãŸ**æŠ•æ‰‹ã®è©³ç´°ãªå±æ€§**ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®æƒ…å ±ã‚’è¨˜äº‹ã®åˆ†æã«æ´»ç”¨ã—ã¦ãã ã•ã„ã€‚
22. **ã€â˜…æ³¨ç›®ã®æ‰“å¸­ï¼ˆæœ€é‡è¦ï¼‰ã€‘**:
        - ã€Œäº‹å®Ÿãƒªã‚¹ãƒˆã€ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ã«ã€Œï¼ˆâ˜…æ³¨ç›®ï¼‰ã€ã¨ã„ã†ãƒãƒ¼ã‚¯ãŒä»˜ã„ã¦ã„ã‚‹æ‰“å¸­ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯**ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆç›£ç£ï¼‰ãŒã€è©¦åˆã®åˆ†æ°´å¶ºã€ã ã¨åˆ¤æ–­ã—ãŸ**ã€æœ€ã‚‚é‡è¦ãªæ‰“å¸­ã§ã™ã€‚
        - ã‚ãªãŸã®è¨˜äº‹ã§ã¯ã€**ã“ã®è¨˜äº‹ã®ä¸­å¿ƒçš„ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ**ã¨ã—ã¦ã€ã“ã®ã€Œâ˜…æ³¨ç›®ã€ã®æ‰“å¸­ã®å‰å¾Œã‚’ã€æœ€ã‚‚ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«æå†™ã—ã¦ãã ã•ã„ã€‚
---
### ç·¨é›†é•·ã‹ã‚‰ã®è¿½åŠ æŒ‡ç¤º
${(userFeedback && userFeedback.include) ? `- **ã€æœ€é‡è¦æŒ‡ç¤ºã€‘** ${userFeedback.include}\n` : ''}
${(userFeedback && userFeedback.exclude) ? `- **ã€å³ç¦äº‹é …ã€‘** ${userFeedback.exclude}\n` : 'ç‰¹ã«ãªã—'}
---
### å‡ºåŠ›å½¢å¼ã€å³å®ˆã€‘
- **ã€æœ€é‡è¦ã€‘** ã‚ãªãŸã®å¿œç­”ã¯ã€å¿…ãšå˜ä¸€ã®JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"ã®ã¿"ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
- **çµ¶å¯¾ã«**ã€JSONã®å‰å¾Œã«ã€Œã¯ã„ã€ä¿®æ­£ã—ã¾ã—ãŸã€ã‚„ã€Œ\`\`\`jsonã€ãªã©ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä»˜ã‘åŠ ãˆã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚
- **å¿…ãš**ã€ä»¥ä¸‹ã®å½¢å¼ã«å¾“ã£ã¦ãã ã•ã„ã€‚
{"title": "ï¼ˆã“ã“ã«è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼‰", "body": "ï¼ˆã“ã“ã«è¨˜äº‹ã®æœ¬æ–‡ï¼‰"}
`;
        // â–²â–²â–² ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    } 
    // --- è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ (Bãƒ«ãƒ¼ãƒˆ) ---
    else {
        // â–¼â–¼â–¼ Bãƒ«ãƒ¼ãƒˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã‚‚ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã‚’è¿½åŠ  â–¼â–¼â–¼
        const calledGameText = matchContext.calledGame ? `\n- **ç‰¹è¨˜äº‹é …:** ${matchContext.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ` : '';
        const rivalryText = matchContext.rivalryType ? `\n- **ç‰¹è¨˜äº‹é …:** ã“ã®è©¦åˆã¯ã€Œ${matchContext.rivalryType}ã€ã¨ã„ã†å› ç¸ã®å¯¾æ±ºã§ã—ãŸã€‚` : '';
        let scheduleText = '';
        if (matchContext.schedule) {
            const sched = matchContext.schedule;
            const team1Region = TEAM_DATA[dbMatch.team1]?.region || 'ä¸æ˜';
            const team2Region = TEAM_DATA[dbMatch.team2]?.region || 'ä¸æ˜';
            scheduleText = `\n- **è©¦åˆä¼šå ´:** ${sched.stadiumFull} (${sched.region}åœ°åŒº)\n`;
            if (sched.region === team1Region && sched.region !== team2Region) {
                scheduleText += `- **åœ°ã®åˆ©:** ${dbMatch.team1}ã«ã¨ã£ã¦åœ°å…ƒçƒå ´ã§ã®è©¦åˆã¨ãªã£ãŸã€‚\n`;
            } else if (sched.region !== team1Region && sched.region === team2Region) {
                scheduleText += `- **åœ°ã®åˆ©:** ${dbMatch.team2}ã«ã¨ã£ã¦åœ°å…ƒçƒå ´ã§ã®è©¦åˆã¨ãªã£ãŸã€‚\n`;
            }
        }
        let roundName = "ä¸æ˜ãªãƒ©ã‚¦ãƒ³ãƒ‰";
        if (matchId && matchId.includes('-R')) {
            const roundNum = parseInt(matchId.split('-')[1].slice(1));
            const finalRound = tournamentState.is16team ? 4 : 6;
            const roundNameMap = { [finalRound]: 'æ±ºå‹', [finalRound-1]: 'æº–æ±ºå‹', [finalRound-2]: 'æº–ã€…æ±ºå‹' };
            if (tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'main_round2_onwards'){
                 const springRoundMap = { 1: '2å›æˆ¦', 2: 'æº–ã€…æ±ºå‹', 3: 'æº–æ±ºå‹', 4: 'æ±ºå‹'};
                 roundName = springRoundMap[roundNum] || `${roundNum}å›æˆ¦`;
            }
            else if (tournamentState.currentTournament === 'autumn' && tournamentState.autumnPhase !== 'main') roundName = "åœ°åŒºäºˆé¸/é †ä½æ±ºå®šæˆ¦";
            else if (tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'main_round1') roundName = "çœŒå¤§ä¼š1å›æˆ¦";
            else roundName = roundNameMap[roundNum] || `${roundNum}å›æˆ¦`;
        }

        prompt = `ã‚ãªãŸã¯ã€é«˜æ ¡é‡çƒå°‚é–€ã®AIè¨˜è€…ã§ã™ã€‚
ä»¥ä¸‹ã®è©¦åˆçµæœã«åŸºã¥ãã€ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

---
### **å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰**
${PREFECTURE_LORE}
---
---
${matchContext.calledGame ? `- **ç‰¹è¨˜äº‹é …:** ${matchContext.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ` : ''}
---
### è©¦åˆæƒ…å ±
- **å‹åˆ©ãƒãƒ¼ãƒ **: ${winnerName} ${winnerSeedRank} (${winnerRankDesc})
- **æ•—åŒ—ãƒãƒ¼ãƒ **: ${loserName} ${loserSeedRank} (${loserRankDesc})
- **ã‚¹ã‚³ã‚¢**: ${winnerScore} - ${loserScore}
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹è©¦åˆã®æ±ºã‚æ‰‹**: ${dbMatch.summary || 'ãªã—'}
${calledGameText} 
${rivalryText} 
### **ç¾åœ¨ã®è©¦åˆçŠ¶æ³**
- **å¤§ä¼š:** ${tournamentState.tournamentYear}å¹´åº¦ ${tournamentNameMap[tournamentState.currentTournament] || 'å¤§ä¼š'}
- **ãƒ©ã‚¦ãƒ³ãƒ‰:** ${roundName} 
${scheduleText} 
### åŸ·ç­†æŒ‡ç¤º
- **ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘**: **ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã®ã€‡ã€‡ãŒé †å½“ã«å‹åˆ©ã€**ã‚„**ã€Œãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã®â–³â–³ãŒç¬¬8ã‚·ãƒ¼ãƒ‰ã‚’ç ´ã‚‹æ³¢ä¹±ã€**ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚å…·ä½“çš„ã«è¨€åŠã—ã¦ãã ã•ã„ã€‚
- **ã€ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ã®å ´åˆã€‘**: ã‚‚ã—è©¦åˆãŒã‚³ãƒ¼ãƒ«ãƒ‰ã§çµ‚äº†ã—ãŸå ´åˆã€ãã®æ—¨ã‚’è¨˜äº‹ã®å†’é ­ã‚„ã‚¿ã‚¤ãƒˆãƒ«ã§æ˜ç¢ºã«è¨˜è¿°ã—ã€å¤§å·®ãŒã¤ã„ãŸç†ç”±ï¼ˆä¸€æ–¹çš„ãªæ”»æ’ƒã€ç›¸æ‰‹ã®ãƒŸã‚¹ãªã©ï¼‰ã«ã‚‚è§¦ã‚Œã‚‹ã“ã¨ã€‚
- ã‚‚ã—ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹è©¦åˆã®æ±ºã‚æ‰‹ã€ã«è¨˜è¿°ãŒã‚ã‚Œã°ã€ãã‚Œã‚’ä¸­å¿ƒã«è¨˜äº‹ã‚’æ§‹æˆã—ã¦ãã ã•ã„ã€‚
- è©¦åˆçµæœã‚’å®¢è¦³çš„ã«ä¼ãˆã¦ãã ã•ã„ã€‚
- **ã€å› ç¸ã®å¯¾æ±ºã€‘**: ã‚‚ã—è©¦åˆãŒã€Œå› ç¸ã®å¯¾æ±ºã€ã§ã‚ã£ãŸå ´åˆã€ãã®äº‹å®Ÿã‚’å¿…ãšè¨˜äº‹ã«å«ã‚ã¦ãã ã•ã„ã€‚
- **ã€å¸¸è­˜ã®åæ˜ ã€‘**: ã‚ãªãŸãŒç†ŸçŸ¥ã—ã¦ã„ã‚‹ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰ã‚’**èƒŒæ™¯çŸ¥è­˜ã¨ã—ã¦**åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚**ãŸã ã—ã€ã“ã®è©¦åˆãŒå‹¢åŠ›å›³ã®é‡è¦ãªå¯¾æ±ºã§ã‚ã‚‹å ´åˆã«ã®ã¿**ã€ãã®æ–‡è„ˆã«è¨€åŠã—ã€**ç„¡é–¢ä¿‚ãªè©¦åˆã§ã¯å‹¢åŠ›å›³ã®å…¨ä½“èª¬æ˜ã‚’è¨˜äº‹ã«å…¥ã‚Œãªã„ã§ãã ã•ã„ã€‚**
- **ã€åœ°ã®åˆ©ã€‘**: ã‚‚ã—ã€Œåœ°ã®åˆ©ã€æƒ…å ±ãŒã‚ã‚‹å ´åˆã€åœ°å…ƒçƒå ´ã§æˆ¦ãˆãŸã“ã¨ãŒå‹æ•—ã«ã©ã†å½±éŸ¿ã—ãŸã‹ã«è§¦ã‚Œã¦ãã ã•ã„ã€‚
- è¨˜äº‹ã®æœ€å¾Œã«ã€å‹åˆ©ãƒãƒ¼ãƒ ã®ç›£ç£ã¾ãŸã¯ä¸»å°†ã®å–œã³ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä¾‹ï¼šã€ã€‡ã€‡ç›£ç£ã€Œé¸æ‰‹ãŸã¡ãŒã‚ˆãé ‘å¼µã£ã¦ãã‚ŒãŸã€ã€ï¼‰ã‚’ä¸€è¡Œè¿½åŠ ã—ã¦ãã ã•ã„ã€‚
- **è¨˜äº‹ã®æœ€å¾Œã«ã€æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ï¼ˆ${nextOpponentText}ï¼‰ã«ç°¡æ½”ã«è§¦ã‚Œã¦ç· ã‚ããã£ã¦ãã ã•ã„ã€‚**
- è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;
        // â–²â–²â–² Bãƒ«ãƒ¼ãƒˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    }

    // --- AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ---
    try {
        // ... (try-catchãƒ–ãƒ­ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ...
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json(); 

        if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
            const rawTextFromAi = result.candidates[0].content.parts[0].text; 
            const article = parseJsonFromText(rawTextFromAi); 
            
            if (article && !article.body && article.article) {
                article.body = article.article; 
            }

            if (article && article.title && article.body) { 
                const isNewspaperWorthy = (dbMatch.details && (tournamentState.currentTournament !== 'autumn' || tournamentState.autumnPhase === 'main'));
                const newspaperHtml = isNewspaperWorthy ? createNewspaperHtml(article, { winnerName, loserName, dbMatch, matchId }) : null;
                
                return { 
                    ...article, 
                    isNewspaper: isNewspaperWorthy, 
                    timestamp: Date.now(), 
                    newspaperHtml 
                };
            } else {
                 console.error("parseJsonFromText failed or keys (title/body/article) missing for raw text:", rawTextFromAi);
                 throw new Error("AI response format error after parsing."); 
            }
        } else {
             console.error("Unexpected AI response structure:", result);
             throw new Error("AI response structure is missing expected parts."); 
        }
    } catch (error) {
        console.error("AIè¨˜äº‹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return { 
            title: "è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼", body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 
            timestamp: Date.now(), error: true, errorId: matchId,
            context: matchContext 
        };
    }
}

/**
     * AIã«ã‚¹ã‚­ãƒƒãƒ—ã—ãŸãƒ©ã‚¦ãƒ³ãƒ‰ã®ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆè¨˜äº‹ã‚’ç”Ÿæˆã•ã›ã‚‹
     */
    async function generateSkipRoundSummaryArticle(roundNumber, results) {
        // æœ€ã‚‚ç•ªç‹‚ã‚ã›ãŒå¤§ãã‹ã£ãŸè©¦åˆã‚’1ã¤é¸å‡º
        const biggestUpset = results.filter(r => r.rankDiff >= 2).sort((a,b) => b.rankDiff - a.rankDiff)[0];
        
        let highlightText = "ã‚·ãƒ¼ãƒ‰æ ¡ã‚„æœ‰åŠ›æ ¡ãŒé †å½“ã«å‹ã¡é€²ã¿ã¾ã—ãŸã€‚";
        if (biggestUpset) {
            highlightText = `æœ€å¤§ã®æ³¢ä¹±ã¯${biggestUpset.winnerName}ãŒå¼·è±ª${biggestUpset.loserName}ã‚’${biggestUpset.winnerScore}-${biggestUpset.loserScore}ã§ç ´ã£ãŸä¸€æˆ¦ã§ã—ãŸã€‚`;
        }

        const prompt = `ã‚ãªãŸã¯é«˜æ ¡é‡çƒå°‚é–€ã®AIè¨˜è€…ã§ã™ã€‚
ç¾åœ¨ã€${tournamentState.tournamentYear}å¹´åº¦${tournamentNameMap[tournamentState.currentTournament]}ãŒé€²è¡Œä¸­ã§ã™ã€‚
${roundNumber}å›æˆ¦ã®å…¨è©¦åˆãŒçµ‚äº†ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å…ƒã«ã€ç°¡æ½”ãªãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆè¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### ${roundNumber}å›æˆ¦ãƒã‚¤ãƒ©ã‚¤ãƒˆ
- ${highlightText}
- æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã¯ã€å‹ã¡ä¸ŠãŒã£ãŸçŒ›è€…ãŸã¡ã«ã‚ˆã‚‹æ›´ãªã‚‹æ¿€æˆ¦ãŒæœŸå¾…ã•ã‚Œã¾ã™ã€‚

### åŸ·ç­†æŒ‡ç¤º
- ä¸Šè¨˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è‡ªç„¶ãªæ–‡ç« ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
- ã‚¿ã‚¤ãƒˆãƒ«ã¯ã€Œ${roundNumber}å›æˆ¦ãŒçµ‚äº†ï¼æ³¢ä¹±ã¯èµ·ãã‚‹ã‹ï¼Ÿã€ã®ã‚ˆã†ã«ã€æ¬¡ã¸ã®æœŸå¾…æ„Ÿã‚’ç…½ã‚‹ã‚‚ã®ã«ã—ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼
JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„: {"title": "è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«", "body": "è¨˜äº‹ã®æœ¬æ–‡"}`;

        try {
            const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
                if (article) return { ...article, timestamp: Date.now() };
            }
            throw new Error("AI summary response format error.");
        } catch (error) {
            console.error("AI summary article generation failed:", error);
            return { title: "ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆè¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼", body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", timestamp: Date.now(), error: true, errorId: `skip-summary-${roundNumber}` };
        }
    }


/**
 * è©¦åˆç›´å‰ã®ã€Œå¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆã€ã‚’AIã«ç”Ÿæˆã•ã›ã‚‹
 * (â˜…A/Bãƒ©ãƒ³ã‚¯æ ¡ã«ã¯ã€Œç„¡é–¢ä¿‚ã®ãƒ•ã‚¡ãƒ³ã€ãƒšãƒ«ã‚½ãƒŠã‚’è¿½åŠ ã™ã‚‹æœ€çµ‚ç‰ˆ)
 * @param {object} context - è©¦åˆã¨ãƒãƒ¼ãƒ ã®å…¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
 * @param {number} numComments - ç”Ÿæˆã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆæ•°
 * @returns {Promise<Array<object>>} - ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
 */
async function generatePreGameCheerComments(context, numComments) {
    
    // --- 1. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†è§£ ---
    const {
        name: teamName,
        rank: teamRank, // â˜…ãƒ©ãƒ³ã‚¯ã‚’å–å¾—
        opponent: opponentName,
        opponentRank: opponentRank,
        round: roundName,
        path: tournamentPath,
        detailed: detailedData,
        info: teamInfo 
    } = context;

    // --- 2. AIã¸ã®ãƒšãƒ«ã‚½ãƒŠæŒ‡ç¤º (â˜…ä¿®æ­£ç®‡æ‰€) ---
    // â˜… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒšãƒ«ã‚½ãƒŠ
    let personaInstructions = `
ã‚ãªãŸã¯ã€Œ${teamName}ã€ã®ç†±ç‹‚çš„ãªå¿œæ´å›£ã€ã¾ãŸã¯è©¦åˆã«æœŸå¾…ã™ã‚‹ãƒ•ã‚¡ãƒ³ã§ã™ã€‚ä»¥ä¸‹ã®ãƒšãƒ«ã‚½ãƒŠï¼ˆå½¹å‰²ï¼‰ã«ãªã‚Šãã£ã¦ã€è©¦åˆç›´å‰ã®å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆã‚’åˆè¨ˆ ${numComments} å€‹ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### ãƒšãƒ«ã‚½ãƒŠï¼ˆå½¹å‰²ï¼‰ã¨ã€ã‚ãªãŸãŒèªã‚‹ã¹ãè¦–ç‚¹
- **OB (OBãƒ»OG):**
    - **è¦–ç‚¹:** ã‚ãªãŸã®åœ¨ç±æ™‚ä»£ï¼ˆä¾‹ï¼š5å¹´å‰ã€20å¹´å‰ï¼‰ã®æ€ã„å‡ºã¨ã€ç¾åœ¨ã®ãƒãƒ¼ãƒ ã‚’æ¯”è¼ƒã—ã¦ãã ã•ã„ã€‚
    - **ï¼ˆé‡è¦ï¼‰:** ã‚‚ã—å¿œæ´ã™ã‚‹ãƒãƒ¼ãƒ ãŒã€Œ283å­¦åœ’ã€ã‚„ã€Œ765ç·åˆã€ã®ã‚ˆã†ãª**å‰µéƒ¨æ•°å¹´ã®æ–°ã—ã„å­¦æ ¡**ã®å ´åˆã€ã€Œ40å¹´å‰ã€ã¨ã„ã£ãŸçŸ›ç›¾ã—ãŸç™ºè¨€ã¯**çµ¶å¯¾ã«ã›ãš**ã€ã€Œå‰µéƒ¨ã¾ã‚‚ãªã„ã®ã«, ã“ã“ã¾ã§æ¥ã‚‹ã¨ã¯â€¦ã€ã€Œä¿ºãŒ1æœŸç”Ÿã ã£ãŸé ƒã¯â€¦ã€ã¨ã„ã£ãŸã€**æ–°ã—ã„å­¦æ ¡ã®OBã‚‰ã—ã„**ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

- **åœ¨æ ¡ç”Ÿ (ãƒ–ãƒ©ã‚¹ãƒãƒ³ãƒ‰éƒ¨å“¡ã‚„å‹äººãªã©):**
    - **è¦–ç‚¹:** ä»Šã®å­¦æ ¡ã®é›°å›²æ°—ã‚„ã€å¿œæ´ç·´ç¿’ã®æ§˜å­ã€ã‚¯ãƒ©ã‚¹ãƒ¡ã‚¤ãƒˆã¨ã—ã¦ã®é¸æ‰‹ã®ç´ é¡”ï¼ˆæ¶ç©ºã§OKï¼‰ã‚’èªã£ã¦ãã ã•ã„ã€‚
    - **ï¼ˆä¾‹ï¼‰:** ã€Œã€‡ã€‡ãã‚“ã€ã„ã¤ã‚‚ã¯æ•™å®¤ã§é™ã‹ãªã®ã«ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã ã¨å‡„ã„ï¼ã€ã€Œãƒ–ãƒ©ãƒãƒ³ã‚‚æ°—åˆå…¥ã£ã¦ã¾ã™ï¼ã€

- **åœ°å…ƒãƒ•ã‚¡ãƒ³ (ãã®åœ°åŸŸã«ä½ã‚€ãƒ•ã‚¡ãƒ³):**
    - **è¦–ç‚¹:** åœ°åŸŸã®æœŸå¾…ï¼ˆä¾‹ï¼šã€Œä»Šå¹´ã“ãç”²å­åœ’ã¸ã€ã€Œã€‡ã€‡ï¼ˆåœ°åï¼‰ã®èª‡ã‚Šã ã€ï¼‰ã‚’èªã£ã¦ãã ã•ã„ã€‚

- **é¸æ‰‹ã®å®¶æ— (æ¶ç©ºã®è¦ªã‚„å…„å¼Ÿ):**
    - **è¦–ç‚¹:** é¸æ‰‹ã®å€‹äººçš„ãªåŠªåŠ›ï¼ˆæ¶ç©ºã§OKï¼‰ã‚„ã€å®¶åº­ã§ã®æ§˜å­ã‚’èªã£ã¦ãã ã•ã„ã€‚
    - **ï¼ˆä¾‹ï¼‰:** ã€Œæ¯å­ãŒãƒ™ãƒ³ãƒå…¥ã‚Šã§ããŸã ã‘ã§å¥‡è·¡ã§ã™ã€ã€Œã‚ã®å­ã€æ¯æœ5æ™‚ã«èµ·ãã¦ç´ æŒ¯ã‚Šã—ã¦ã¾ã—ãŸã‹ã‚‰â€¦ã€
`;

    // â˜… Aãƒ©ãƒ³ã‚¯ã¾ãŸã¯Bãƒ©ãƒ³ã‚¯ã®å ´åˆã€ã€Œç„¡é–¢ä¿‚ã®ãƒ•ã‚¡ãƒ³ã€ãƒšãƒ«ã‚½ãƒŠã‚’è¿½åŠ 
    if (teamRank === 'A' || teamRank === 'B') {
        personaInstructions += `
- **ï¼ˆç„¡é–¢ä¿‚ã®ï¼‰é«˜æ ¡é‡çƒãƒ•ã‚¡ãƒ³:**
    - **è¦–ç‚¹:** ã‚ãªãŸã¯ã€ã“ã®è©¦åˆãŒ ${teamName}ï¼ˆ${getRankDescription(teamRank)}ï¼‰ã®è©¦åˆã ã‹ã‚‰è¦³ã«æ¥ãŸã€Œç„¡é–¢ä¿‚ã®é‡çƒå¥½ãã€ã§ã™ã€‚å­¦æ ¡é–¢ä¿‚è€…ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
    - **ï¼ˆä¾‹ï¼‰:** ã€Œä»Šæ—¥ã®ç›®å½“ã¦ã¯ã“ã®ã‚«ãƒ¼ãƒ‰ã€‚ãƒã‚¤ãƒ¬ãƒ™ãƒ«ãªè©¦åˆã‚’æœŸå¾…ã—ã¦ã‚‹ã€ã€Œã€‡ã€‡ï¼ˆæ³¨ç›®é¸æ‰‹ï¼‰ã®ãƒ”ãƒƒãƒãƒ³ã‚°/ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°ãŒè¦‹ãŸãã¦æœ‰ä¼‘ã¨ã£ãŸã‚ã€ã€Œã©ã£ã¡ãŒå‹ã£ã¦ã‚‚ã„ã„ã‹ã‚‰ç†±ã„è©¦åˆã‚’è¦‹ã›ã¦ãã‚Œã€
`;
    }
    // â˜… ä¿®æ­£ã“ã“ã¾ã§

    
    // --- 3. AIã¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (å¤‰æ›´ãªã—) ---
    const prompt = `
${personaInstructions}

### è©¦åˆæƒ…å ±
- **å¿œæ´ã™ã‚‹ãƒãƒ¼ãƒ :** ${teamName} (ãƒ©ãƒ³ã‚¯: ${teamRank})
- **å¯¾æˆ¦ç›¸æ‰‹:** ${opponentName} (ãƒ©ãƒ³ã‚¯: ${opponentRank})
- **ãƒ©ã‚¦ãƒ³ãƒ‰:** ${roundName}
- **ã“ã“ã¾ã§ã®å‹ã¡ä¸ŠãŒã‚Š:** ${tournamentPath || 'ä»Šå¤§ä¼šåˆæˆ¦'}
- **æ³¨ç›®é¸æ‰‹ (ä¸€éƒ¨):** ${detailedData ? detailedData.players.map(p => p.name).join(', ') : 'æƒ…å ±ãªã—'}
- **â˜…ãƒãƒ¼ãƒ ã®èƒŒæ™¯(info):** ${teamInfo || 'ç‰¹ã«ãªã—'}

### æŒ‡ç¤º
1.  **ãƒšãƒ«ã‚½ãƒŠã«ãªã‚Šãã‚‹:** ä¸Šè¨˜ã®ãƒšãƒ«ã‚½ãƒŠï¼ˆOBã€åœ¨æ ¡ç”Ÿã€åœ°å…ƒãƒ•ã‚¡ãƒ³ã€å®¶æ—ã€ç„¡é–¢ä¿‚ã®ãƒ•ã‚¡ãƒ³ç­‰ï¼‰ã«å®Œå…¨ã«ãªã‚Šãã‚Šã€ãã®ç«‹å ´ã‹ã‚‰ã®å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
2.  **æ–‡è„ˆã‚’åæ˜ :** è©¦åˆæƒ…å ±ï¼ˆç›¸æ‰‹ãŒæ ¼ä¸Šã‹ã€æ­´å²çš„ãªå¿«é€²æ’ƒã‹ã€æ³¨ç›®é¸æ‰‹ã¯èª°ã‹ï¼‰ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«åæ˜ ã•ã›ã¦ãã ã•ã„ã€‚
3.  **â˜…ã€æœ€é‡è¦ã€‘èƒŒæ™¯(info)ã®æ´»ç”¨:** AIã«æ¸¡ã•ã‚ŒãŸã€Œâ˜…ãƒãƒ¼ãƒ ã®èƒŒæ™¯(info)ã€ã‚’ç†Ÿèª­ã—ã¦ãã ã•ã„ã€‚
    - ï¼ˆä¾‹ï¼šã‚‚ã—ã€Œå·æ ¹ã€ãªã‚‰ã€Œæœ€å¾Œã®å¤ã€ã‚„ã€Œé–‰æ ¡ã€ã«è§¦ã‚Œã‚‹ï¼‰
    - ï¼ˆä¾‹ï¼šã‚‚ã—ã€Œæµœæ¾ç‰¹æ”¯ã€ãªã‚‰ã€Œå‰µéƒ¨ä¸€å¹´ç›®ã€ã€Œ52-0ã®å¤§æ•—ã€ã®è¨˜æ†¶ã«è§¦ã‚Œã‚‹ï¼‰
    - ï¼ˆä¾‹ï¼šã‚‚ã—ã€Œè™åºœå³¶ã€ãªã‚‰ã€Œé›¢å³¶ã®ãƒãƒ³ãƒ‡ã€ã«è§¦ã‚Œã‚‹ï¼‰
    - ï¼ˆä¾‹ï¼šã‚‚ã—ã€Œ283å­¦åœ’ã€ãªã‚‰ã€Œç‹è€…ã¨ã—ã¦ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã€ã«è§¦ã‚Œã‚‹ï¼‰
    - ã“ã®èƒŒæ™¯æƒ…å ±ã«åŸºã¥ã„ãŸã€**å…·ä½“çš„ã§è§£åƒåº¦ã®é«˜ã„**ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¿…ãšç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
4.  **å‰µä½œã‚’è¨±å¯:** é¸æ‰‹ã‚„ç›£ç£ã¨ã®ï¼ˆæ¶ç©ºã®ï¼‰å€‹äººçš„ãªæ€ã„å‡ºã‚„ã€éå»ã®æ­´å²ï¼ˆä¾‹ï¼š40å¹´å‰ã®åˆå‹åˆ©ï¼‰ã‚’**è‡ªç”±ã«å‰µä½œã—ã¦**ã€ã‚³ãƒ¡ãƒ³ãƒˆã«æ·±ã¿ã‚’ä¸ãˆã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼ã€å³å®ˆã€‘
å¿…ãšä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼"ã®ã¿"ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
[
    {"personality": "ï¼ˆä¾‹ï¼šã€‡ã€‡é«˜æ ¡OBï¼‰", "comment": "ï¼ˆç”Ÿæˆã—ãŸã‚³ãƒ¡ãƒ³ãƒˆ1ï¼‰"},
    {"personality": "ï¼ˆä¾‹ï¼šåœ¨æ ¡ç”Ÿï¼‰", "comment": "ï¼ˆç”Ÿæˆã—ãŸã‚³ãƒ¡ãƒ³ãƒˆ2ï¼‰"},
    {"personality": "ï¼ˆä¾‹ï¼šåœ°å…ƒã®ãƒ•ã‚¡ãƒ³ï¼‰", "comment": "ï¼ˆç”Ÿæˆã—ãŸã‚³ãƒ¡ãƒ³ãƒˆ3ï¼‰"}
    // ... (æŒ‡å®šã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆæ•°ã ã‘ç¶šã‘ã‚‹) ...
]
`;

    // --- 4. AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (å¤‰æ›´ãªã—) ---
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const commentsJson = parseJsonFromText(rawText);
            if (Array.isArray(commentsJson)) {
                return commentsJson;
            }
        }
        throw new Error("AI response format error (PreGameComments).");
    } catch (error) {
        console.error("AIå¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return [{ personality: "ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼", comment: "å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ..." }];
    }
}

// â–²â–²â–² è²¼ã‚Šä»˜ã‘ã¯ã“ã“ã¾ã§ â–²â–²
// â–²â–²â–² è²¼ã‚Šä»˜ã‘ã¯ã“ã“ã¾ã§ â–²â–²


/**
 * AIã«æ²ç¤ºæ¿ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã•ã›ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
 * (â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯èªè­˜ æœ€çµ‚ç‰ˆ)
 */
async function generateBbsComments(matchContext) {
    // --- 1. contextã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–ã‚Šå‡ºã™ ---
    const { 
        winnerName, loserName, dbMatch, matchId, 
        winnerData, loserData
    } = matchContext;
    
    // --- 2. AIã¸ã®æŒ‡ç¤ºã‚’ä½œæˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªæƒ…å ±ã‚’æº–å‚™ã™ã‚‹ ---
    const winnerScore = Math.max(parseInt(dbMatch.score1) || 0, parseInt(dbMatch.score2) || 0);
    const loserScore = Math.min(parseInt(dbMatch.score1) || 0, parseInt(dbMatch.score2) || 0);
    const winnerRankDesc = getRankDescription(calculateRank(winnerName, tournamentState));
    const loserRankDesc = getRankDescription(calculateRank(loserName, tournamentState));
    
    // â–¼â–¼â–¼ ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯å–å¾—ã‚’è¿½åŠ  â–¼â–¼â–¼
    const winnerSeedRank = getSeedRankString(winnerName, tournamentState.seeds);
    const loserSeedRank = getSeedRankString(loserName, tournamentState.seeds);
    // â–²â–²â–²
    
    const winnerDynamicInfo = generateDynamicTeamInfo(winnerName, winnerData, tournamentState.teamRecords[winnerName]);
    const loserDynamicInfo = generateDynamicTeamInfo(loserName, loserData, tournamentState.teamRecords[loserName]);
    let specialNarrativeContext = '';
    
    if (tournamentState.currentTournament === 'autumn' && tournamentState.autumnPhase === 'main' && matchId.includes('-R1-')) {
        const winnerRank = calculateRank(winnerName, tournamentState);
        if (winnerData.type === 'å…¬ç«‹' && (winnerRank === 'D' || winnerRank === 'E')) {
            specialNarrativeContext = `### ã€æ²ç¤ºæ¿ã®è©±é¡Œã€‘\nè¡æ’ƒï¼ç„¡åã®å…¬ç«‹ã€Œ${winnerName}ã€ãŒçœŒå¤§ä¼šåˆæˆ¦ã‚’å‹ã¡ã€ã€æ¥æ˜¥ã®ã‚·ãƒ¼ãƒ‰æ¨©ç²å¾—ã€‘ã ï¼ã“ã®å¿«é€²æ’ƒã«é©šãã¨å«‰å¦¬ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã›ã‚ˆã€‚`;
        }
    }
    const calledGameText = matchContext.calledGame
        ? `\n- **ç‰¹è¨˜äº‹é …:** ${matchContext.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ `
        : '';
    const rivalryText = matchContext.rivalryType
        ? `\n- **ç‰¹è¨˜äº‹é …:** ã“ã®è©¦åˆã¯ã€Œ${matchContext.rivalryType}ã€ã¨ã„ã†å› ç¸ã®å¯¾æ±ºã§ã—ãŸã€‚`
        : '';
    let prompt = '';

    // --- 3. è¨˜äº‹ã®æ–¹å‘æ€§ã‚’æ±ºå®šã—ã€AIã¸ã®æŒ‡ç¤ºæ›¸(ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ)ã‚’ä½œæˆã™ã‚‹ ---
    if (dbMatch.details) {
        // è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ (Aãƒ«ãƒ¼ãƒˆ)
        const { highlights } = createHighlightsText(dbMatch, winnerName);
        const highlightsText = highlights.map(fact => `- ${fact.inning || ''}å› ${fact.team || ''} ${fact.player || ''}: ${fact.description}`).join('\n');
        
        let roundName = "ä¸æ˜ãªãƒ©ã‚¦ãƒ³ãƒ‰";
        if (matchId && matchId.includes('-R')) {
            // ... (ãƒ©ã‚¦ãƒ³ãƒ‰ååˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ...
            const roundNum = parseInt(matchId.split('-')[1].slice(1));
            const finalRound = tournamentState.is16team ? 4 : 6;
            const roundNameMap = { [finalRound]: 'æ±ºå‹', [finalRound-1]: 'æº–æ±ºå‹', [finalRound-2]: 'æº–ã€…æ±ºå‹' };
            if (tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'main_round2_onwards'){
                 const springRoundMap = { 1: '2å›æˆ¦', 2: 'æº–ã€…æ±ºå‹', 3: 'æº–æ±ºå‹', 4: 'æ±ºå‹'};
                 roundName = springRoundMap[roundNum] || `${roundNum}å›æˆ¦`;
            }
            else if (tournamentState.currentTournament === 'autumn' && tournamentState.autumnPhase !== 'main') roundName = "åœ°åŒºäºˆé¸/é †ä½æ±ºå®šæˆ¦";
            else if (tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'main_round1') roundName = "çœŒå¤§ä¼š1å›æˆ¦";
            else roundName = roundNameMap[roundNum] || `${roundNum}å›æˆ¦`;
        }
        
        let nextOpponentText = 'æ¬¡ã®ç›¸æ‰‹ã¯æœªå®šã€‚';
        if (matchContext.nextOpponent) {
            const nextOpponent = matchContext.nextOpponent;
            if (nextOpponent.opponentName && nextOpponent.opponentName !== 'ï¼ˆæœªå®šï¼‰') {
                const nextOpponentSeed = getSeedRankString(nextOpponent.opponentName, tournamentState.seeds); // â˜…
                nextOpponentText = `æ¬¡ã®${nextOpponent.roundName}ã®ç›¸æ‰‹ã¯${nextOpponent.opponentName}${nextOpponentSeed}(ãƒ©ãƒ³ã‚¯:${nextOpponent.opponentRank})ã€‚`;
            } else if (nextOpponent.decidingMatch) {
                const dm = nextOpponent.decidingMatch;
                const team1Seed = getSeedRankString(dm.team1, tournamentState.seeds); // â˜…
                const team2Seed = getSeedRankString(dm.team2, tournamentState.seeds); // â˜…
                nextOpponentText = `æ¬¡ã®${nextOpponent.roundName}ã®ç›¸æ‰‹ã¯ã€${dm.team1}${team1Seed}(${dm.rank1}ãƒ©ãƒ³ã‚¯)ã¨${dm.team2}${team2Seed}(${dm.rank2}ãƒ©ãƒ³ã‚¯)ã®å‹è€…ã€‚`;
            }
        }
        
        let ballQualityText = '';
        if (matchContext.team1BallQuality && matchContext.team2BallQuality) {
            ballQualityText = `
### ãƒãƒ¼ãƒ åˆ¥ æ‰“çƒå“è³ª
- ${matchContext.team1BallQuality}
- ${matchContext.team2BallQuality}
`;
        }
        
        // â–¼â–¼â–¼ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿®æ­£ â–¼â–¼â–¼
        prompt = `ã‚ãªãŸã¯ã€åŒ¿åæ²ç¤ºæ¿ã«é›†ã†ã€æ§˜ã€…ãªç«‹å ´ã®é«˜æ ¡é‡çƒãƒ•ã‚¡ãƒ³ã§ã™ã€‚
ä»¥ä¸‹ã®è©¦åˆçµæœã¨è©³ç´°ãªãƒã‚¤ãƒ©ã‚¤ãƒˆã«åŸºã¥ãã€å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ãªã‚Šãã£ã¦ã€è¾›è¾£ã§ãƒªã‚¢ãƒ«ãªçŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’10ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

---
### **å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰**
${PREFECTURE_LORE}
---
### è©¦åˆæƒ…å ±
- å‹åˆ©ãƒãƒ¼ãƒ : ${winnerName} ${winnerSeedRank} (${winnerRankDesc})
- æ•—åŒ—ãƒãƒ¼ãƒ : ${loserName} ${loserSeedRank} (${loserRankDesc})
- ã‚¹ã‚³ã‚¢: ${winnerScore} - ${loserScore}
${calledGameText} 
${rivalryText}
### æ¬¡ã®è©¦åˆæƒ…å ±
- **${winnerName}ã®æ¬¡ã®è©¦åˆ**: ${nextOpponentText}
### **ç¾åœ¨ã®è©¦åˆçŠ¶æ³**
- **å¤§ä¼š:** ${tournamentState.tournamentYear}å¹´åº¦ ${tournamentNameMap[tournamentState.currentTournament] || 'å¤§ä¼š'}
- **ãƒ©ã‚¦ãƒ³ãƒ‰:** ${roundName} 
${matchContext.calledGame ? `- **ç‰¹è¨˜äº‹é …:** ${matchContext.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ` : ''}
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹: ${dbMatch.summary || 'ç‰¹ã«ãªã—'}
${ballQualityText} 
### è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${highlightsText}
### ãƒãƒ¼ãƒ ã®èƒŒæ™¯
- **${winnerName} ${winnerSeedRank}**: ${winnerDynamicInfo}
- **${loserName} ${loserSeedRank}**: ${loserDynamicInfo}
${specialNarrativeContext}
### ã‚ãªãŸãŒãªã‚Šãã‚‹ã¹ãã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨æŒ‡ç¤º
- **ã€å¸¸è­˜ã®åæ˜ ã€‘**: ã‚ãªãŸãŒç†ŸçŸ¥ã—ã¦ã„ã‚‹ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰ã‚’è€ƒæ…®ã—ã€ã“ã®å‹åˆ©/æ•—åŒ—ãŒã©ã®ã‚ˆã†ãªæ„å‘³ã‚’æŒã¤ã‹ï¼ˆä¾‹ï¼šé †å½“ã€æ³¢ä¹±ï¼‰ã‚’æ–‡è„ˆã«å«ã‚ã¦ãã ã•ã„ã€‚
- **ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘**: **ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã•ã™ãŒã‚„ãªã€ã€Œç¬¬5ã‚·ãƒ¼ãƒ‰ãŒè² ã‘ãŸãƒ³ã‚´wwwã€**ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚å…·ä½“çš„ã«è¨€åŠã—ã¦ãã ã•ã„ã€‚
- **ç†±ç‹‚çš„ãªå‹è€…ãƒãƒ¼ãƒ ã®OB**: ã€Œè©¦åˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã€ã§æ´»èºã—ãŸè‡ªãƒãƒ¼ãƒ ã®é¸æ‰‹ã‚’ç†±çƒˆã«ç§°è³›ã—ã¦ãã ã•ã„ã€‚
- **ä¸Šã‹ã‚‰ç›®ç·šã®é‡çƒè§£èª¬è€…**: ã€Œè©¦åˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã€ã®ãƒ—ãƒ¬ãƒ¼ã‚’ç„äººã£ã½ãåˆ†æã—ã¦ãã ã•ã„ã€‚
- **ã‚¢ãƒ³ãƒ**: ã€Œè©¦åˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã€ã§æ´»èºã—ãŸç›¸æ‰‹é¸æ‰‹ã‚’ã€Œã¾ãã‚Œã ã€ã¨è²¶ã—ã¦ãã ã•ã„ã€‚
- **ãƒ©ã‚¤ãƒãƒ«æ ¡ã®ãƒ•ã‚¡ãƒ³**: ã€Œè©¦åˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã€ã®é¸æ‰‹ã‚’è‡ªãƒãƒ¼ãƒ ã®é¸æ‰‹ã¨æ¯”è¼ƒã—ã¦ãã ã•ã„ã€‚
- **å˜ãªã‚‹é‡çƒå¥½ã**: ã€Œè©¦åˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã€ã§æœ€ã‚‚å°è±¡çš„ã ã£ãŸãƒ—ãƒ¬ãƒ¼ã®æ„Ÿæƒ³ã‚’è¿°ã¹ã¦ãã ã•ã„ã€‚
- **ãã®ä»–(è‡ªç”±ã«)**: ãƒªãƒ™ãƒ©ãƒ«ãªã‚³ãƒ¡ãƒ³ãƒˆ
- **ã€â˜…æ³¨ç›®ã®æ‰“å¸­ï¼ˆæœ€é‡è¦ï¼‰ã€‘**:
    - ã€Œè©¦åˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã€ã«ã€Œï¼ˆâ˜…æ³¨ç›®ï¼‰ã€ãƒãƒ¼ã‚¯ãŒä»˜ã„ã¦ã„ã‚‹æ‰“å¸­ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚ŒãŒ**è©¦åˆã®ã‚¿ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆ**ã§ã™ã€‚
    - **ã€Œã‚ã®ï¼ˆâ˜…æ³¨ç›®ï¼‰ã®å ´é¢ãŒå‹è² ã®åˆ†ã‹ã‚Œç›®ã ã£ãŸã€ã€Œã‚ãã“ã§ã€‡ã€‡ãŒæ‰“ã£ãŸï¼ˆæŠ‘ãˆãŸï¼‰ã®ãŒå…¨ã¦ã€**ã®ã‚ˆã†ã«ã€ãã®æ‰“å¸­ãŒæ±ºå®šçš„ãªç¬é–“ã§ã‚ã£ãŸã¨ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚
- **ã€ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ã®å ´åˆã€‘**: ã‚‚ã—è©¦åˆãŒã‚³ãƒ¼ãƒ«ãƒ‰ã§çµ‚äº†ã—ãŸå ´åˆã€ãã®åœ§å‹ã¶ã‚Šã‚„å¤§å·®ãŒã¤ã„ãŸã“ã¨ã«ã¤ã„ã¦ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«å¿œã˜ãŸåå¿œï¼ˆç§°è³›ã€ç…½ã‚Šã€é©šããªã©ï¼‰ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã¦ãã ã•ã„ã€‚
- **ã€å› ç¸ã®å¯¾æ±ºã®å ´åˆã€‘**: ã‚‚ã—è©¦åˆãŒã€Œå› ç¸ã®å¯¾æ±ºã€ã§ã‚ã£ãŸå ´åˆã€ãã®ç‰¹åˆ¥ãªè©¦åˆã«ã¤ã„ã¦ã®æ„Ÿæƒ³ï¼ˆä¾‹ï¼šã€Œãƒ€ãƒ¼ãƒ“ãƒ¼å‹ã¦ã¦æœ€é«˜ï¼ã€ã€Œã‚„ã£ã±ã‚Šã€‡ã€‡ã«ã¯å‹ã¦ã‚“ã‹â€¦ã€ï¼‰ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã¦ãã ã•ã„
- **ã€æŠ•æ‰‹ã®è©³ç´°å±æ€§ã€‘**: ã€Œãƒã‚¤ãƒ©ã‚¤ãƒˆã€ï¼ˆãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ï¼‰ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹**æŠ•æ‰‹ã®è©³ç´°å±æ€§ï¼ˆä¾‹ï¼šå³/ã‚µã‚¤ãƒ‰/æŠ€å·§æ´¾ï¼‰**ã«ã‚‚æ³¨ç›®ã—ã€ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã“ã¨ã€‚
- **ã€æ¬¡æˆ¦ã¸ã®è¨€åŠã€‘**: å‹è€…ãƒãƒ¼ãƒ ã®ã€Œæ¬¡ã®è©¦åˆæƒ…å ±ã€ï¼ˆ${nextOpponentText}ï¼‰ã«è§¦ã‚Œã€ã€Œæ¬¡ã¯ã€‡ã€‡ã‹â€¦ã€ã¨ã„ã£ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ã€‚
- **ã€æ‰“é †ã®å½¹å‰²ã€‘**:
    - ã€Œå¸¸è­˜ã€ã¨ã—ã¦ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã•ã‚ŒãŸ**æ‰“é †ã®å½¹å‰²**ã‚’æ„è­˜ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã“ã¨ã€‚
- **ã€æ‰“çƒã®è³ªï¼ˆãƒãƒ¼ãƒ ãƒ»å€‹äººï¼‰ã€‘**:
    - ã€Œè©¦åˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã€ã‚„ã€Œãƒãƒ¼ãƒ åˆ¥ æ‰“çƒå“è³ªã€ã«ã‚ã‚‹**æ‰“çƒã®è³ª**ï¼ˆã€Œé‹­ã„å½“ãŸã‚Šã€ã€Œè©°ã¾ã£ãŸå½“ãŸã‚Šã€ï¼‰ã«ã‚‚è¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€æŠ•æ‰“ã®å·¦å³ã®ç›¸æ€§ã€‘**:
    - ã‚‚ã—ç›¸æ‰‹æŠ•æ‰‹ãŒ**å·¦è…•ï¼ˆã‚µã‚¦ã‚¹ãƒãƒ¼ï¼‰**ã§ã‚ã£ãŸã‚Šã€**æˆ¦è¡“çš„ã«é‡è¦ãªå ´é¢**ã§ã‚ã£ãŸã‚Šã—ãŸå ´åˆã¯ã€æŠ•æ‰“ã®å·¦å³ã®ç›¸æ€§ã«ã¤ã„ã¦ã‚‚ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã“ã¨ã€‚
### å‡ºåŠ›å½¢å¼
ã€æœ€é‡è¦ã€‘å¿…ãšä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼"ã®ã¿"ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
[ {"personality": "ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åï¼‰", "comment": "ï¼ˆç”Ÿæˆã—ãŸã‚³ãƒ¡ãƒ³ãƒˆï¼‰"} ]`;
        // â–²â–²â–² Aãƒ«ãƒ¼ãƒˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    } else {
        // è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ (Bãƒ«ãƒ¼ãƒˆ)
        // â–¼â–¼â–¼ Bãƒ«ãƒ¼ãƒˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚‚ä¿®æ­£ â–¼â–¼â–¼
        let roundName = "ä¸æ˜ãªãƒ©ã‚¦ãƒ³ãƒ‰";
        if (matchId && matchId.includes('-R')) {
            // ... (ãƒ©ã‚¦ãƒ³ãƒ‰ååˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ...
            const roundNum = parseInt(matchId.split('-')[1].slice(1));
            const finalRound = tournamentState.is16team ? 4 : 6;
            const roundNameMap = { [finalRound]: 'æ±ºå‹', [finalRound-1]: 'æº–æ±ºå‹', [finalRound-2]: 'æº–ã€…æ±ºå‹' };
            if (tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'main_round2_onwards'){
                 const springRoundMap = { 1: '2å›æˆ¦', 2: 'æº–ã€…æ±ºå‹', 3: 'æº–æ±ºå‹', 4: 'æ±ºå‹'};
                 roundName = springRoundMap[roundNum] || `${roundNum}å›æˆ¦`;
            }
            else if (tournamentState.currentTournament === 'autumn' && tournamentState.autumnPhase !== 'main') roundName = "åœ°åŒºäºˆé¸/é †ä½æ±ºå®šæˆ¦";
            else if (tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'main_round1') roundName = "çœŒå¤§ä¼š1å›æˆ¦";
            else roundName = roundNameMap[roundNum] || `${roundNum}å›æˆ¦`;
        }
        
        let nextOpponentText = 'æ¬¡ã®ç›¸æ‰‹ã¯æœªå®šã€‚';
        if (matchContext.nextOpponent) {
            const nextOpponent = matchContext.nextOpponent;
            if (nextOpponent.opponentName && nextOpponent.opponentName !== 'ï¼ˆæœªå®šï¼‰') {
                const nextOpponentSeed = getSeedRankString(nextOpponent.opponentName, tournamentState.seeds); // â˜…
                nextOpponentText = `æ¬¡ã®${nextOpponent.roundName}ã®ç›¸æ‰‹ã¯${nextOpponent.opponentName}${nextOpponentSeed}(ãƒ©ãƒ³ã‚¯:${nextOpponent.opponentRank})ã€‚`;
            } else if (nextOpponent.decidingMatch) {
                const dm = nextOpponent.decidingMatch;
                const team1Seed = getSeedRankString(dm.team1, tournamentState.seeds); // â˜…
                const team2Seed = getSeedRankString(dm.team2, tournamentState.seeds); // â˜…
                nextOpponentText = `æ¬¡ã®${nextOpponent.roundName}ã®ç›¸æ‰‹ã¯ã€${dm.team1}${team1Seed}(${dm.rank1}ãƒ©ãƒ³ã‚¯)ã¨${dm.team2}${team2Seed}(${dm.rank2}ãƒ©ãƒ³ã‚¯)ã®å‹è€…ã€‚`;
            }
        }
        
        prompt = `ã‚ãªãŸã¯ã€åŒ¿åæ²ç¤ºæ¿ã«é›†ã†ã€æ§˜ã€…ãªç«‹å ´ã®é«˜æ ¡é‡çƒãƒ•ã‚¡ãƒ³ã§ã™ã€‚
ä»¥ä¸‹ã®è©¦åˆçµæœã«ã¤ã„ã¦ã€ãã‚Œãã‚Œã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ãªã‚Šãã£ã¦ã€è¾›è¾£ã§ãƒªã‚¢ãƒ«ãªçŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’10ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

---
### **å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰**
${PREFECTURE_LORE}
---
### è©¦åˆæƒ…å ±
- å‹åˆ©ãƒãƒ¼ãƒ : ${winnerName} ${winnerSeedRank} (${winnerRankDesc})
- æ•—åŒ—ãƒãƒ¼ãƒ : ${loserName} ${loserSeedRank} (${loserRankDesc})
- ã‚¹ã‚³ã‚¢: ${winnerScore} - ${loserScore}
${calledGameText}
${rivalryText}
### æ¬¡ã®è©¦åˆæƒ…å ±
- **${winnerName}ã®æ¬¡ã®è©¦åˆ**: ${nextOpponentText}
### **ç¾åœ¨ã®è©¦åˆçŠ¶æ³**
- **å¤§ä¼š:** ${tournamentState.tournamentYear}å¹´åº¦ ${tournamentNameMap[tournamentState.currentTournament] || 'å¤§ä¼š'}
- **ãƒ©ã‚¦ãƒ³ãƒ‰:** ${roundName} 
${matchContext.calledGame ? `- **ç‰¹è¨˜äº‹é …:** ${matchContext.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ` : ''}
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹: ${dbMatch.summary || 'ç‰¹ã«ãªã—'}
### ãƒãƒ¼ãƒ ã®èƒŒæ™¯
- **${winnerName} ${winnerSeedRank}**: ${winnerDynamicInfo}
- **${loserName} ${loserSeedRank}**: ${loserDynamicInfo}
${specialNarrativeContext}

### ã‚ãªãŸãŒãªã‚Šãã‚‹ã¹ãã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨æŒ‡ç¤º
- **ã€å¸¸è­˜ã®åæ˜ ã€‘**: ã‚ãªãŸãŒç†ŸçŸ¥ã—ã¦ã„ã‚‹ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰ã‚’è€ƒæ…®ã—ã€ã“ã®å‹åˆ©/æ•—åŒ—ãŒã©ã®ã‚ˆã†ãªæ„å‘³ã‚’æŒã¤ã‹ï¼ˆä¾‹ï¼šé †å½“ã€æ³¢ä¹±ï¼‰ã‚’æ–‡è„ˆã«å«ã‚ã¦ãã ã•ã„ã€‚
- **ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘**: **ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã•ã™ãŒã‚„ãªã€ã€Œç¬¬5ã‚·ãƒ¼ãƒ‰ãŒè² ã‘ãŸãƒ³ã‚´wwwã€**ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚å…·ä½“çš„ã«è¨€åŠã—ã¦ãã ã•ã„ã€‚
- **ç†±ç‹‚çš„ãªå‹è€…ãƒãƒ¼ãƒ ã®OB**: å‹åˆ©ã‚’å–œã³ã€ãƒãƒ¼ãƒ ã®ä¼çµ±ã‚„èƒŒæ™¯ã«è§¦ã‚Œã¦ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚
- **ä¸Šã‹ã‚‰ç›®ç·šã®é‡çƒè§£èª¬è€…**: é †å½“ãªçµæœã‹ã€æ„å¤–ãªçµæœã‹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
- **ã‚¢ãƒ³ãƒ**: è² ã‘ãŸãƒãƒ¼ãƒ ã‚„ã€ã‚¹ã‚³ã‚¢ãŒåƒ…å·®ã ã£ãŸãƒãƒ¼ãƒ ã‚’æ‰¹åˆ¤ã—ã¦ãã ã•ã„ã€‚
- **ãƒ©ã‚¤ãƒãƒ«æ ¡ã®ãƒ•ã‚¡ãƒ³**: è©¦åˆçµæœã‚’è¦‹ã¦ã€è‡ªãƒãƒ¼ãƒ ã¨ã®åŠ›é–¢ä¿‚ã‚’æ¸¬ã‚‹ã‚ˆã†ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’ã—ã¦ãã ã•ã„ã€‚
- **å˜ãªã‚‹é‡çƒå¥½ã**: ã‚¹ã‚³ã‚¢ã‚’è¦‹ã¦ã€æ¥æˆ¦ã ã£ãŸã‹ã€ä¸€æ–¹çš„ã ã£ãŸã‹ãªã©ã®æ„Ÿæƒ³ã‚’è¿°ã¹ã¦ãã ã•ã„ã€‚
- **ãã®ä»–(è‡ªç”±ã«)**: ãƒªãƒ™ãƒ©ãƒ«ãªã‚³ãƒ¡ãƒ³ãƒˆ
- **ã€ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ã®å ´åˆã€‘**: ã‚‚ã—è©¦åˆãŒã‚³ãƒ¼ãƒ«ãƒ‰ã§çµ‚äº†ã—ãŸå ´åˆã€ãã®åœ§å‹ã¶ã‚Šã‚„å¤§å·®ãŒã¤ã„ãŸã“ã¨ã«ã¤ã„ã¦ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«å¿œã˜ãŸåå¿œï¼ˆç§°è³›ã€ç…½ã‚Šã€é©šããªã©ï¼‰ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã¦ãã ã•ã„ã€‚
- **ã€å› ç¸ã®å¯¾æ±ºã®å ´åˆã€‘**: ã‚‚ã—è©¦åˆãŒã€Œå› ç¸ã®å¯¾æ±ºã€ã§ã‚ã£ãŸå ´åˆã€ãã®ç‰¹åˆ¥ãªè©¦åˆã«ã¤ã„ã¦ã®æ„Ÿæƒ³ï¼ˆä¾‹ï¼šã€Œãƒ€ãƒ¼ãƒ“ãƒ¼å‹ã¦ã¦æœ€é«˜ï¼ã€ã€Œã‚„ã£ã±ã‚Šã€‡ã€‡ã«ã¯å‹ã¦ã‚“ã‹â€¦ã€ï¼‰ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã¦ãã ã•ã„
- **ã€æ¬¡æˆ¦ã¸ã®è¨€åŠã€‘**: å‹è€…ãƒãƒ¼ãƒ ã®ã€Œæ¬¡ã®è©¦åˆæƒ…å ±ã€ï¼ˆ${nextOpponentText}ï¼‰ã«è§¦ã‚Œã€ã€Œæ¬¡ã¯ã€‡ã€‡ã‹â€¦ã€ã¨ã„ã£ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ã€‚
### å‡ºåŠ›å½¢å¼
ã€æœ€é‡è¦ã€‘å¿…ãšä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼"ã®ã¿"ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
[ {"personality": "ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åï¼‰", "comment": "ï¼ˆç”Ÿæˆã—ãŸã‚³ãƒ¡ãƒ³ãƒˆï¼‰"} ]`;
        // â–²â–²â–² Bãƒ«ãƒ¼ãƒˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    }

    // --- 4. AIã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€çµæœã‚’æ•´å½¢ã—ã¦è¿”ã™ ---
    try {
        // ... (try-catchãƒ–ãƒ­ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ...
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const commentsJson = parseJsonFromText(rawText);
            if (Array.isArray(commentsJson)) {
                return commentsJson.map(c => ({
                    id: crypto.randomUUID(),
                    personality: c.personality,
                    text: c.comment,
                    timestamp: Date.now(),
                    replies: []
                }));
            }
        }
        throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒã€æ­£ã—ã„é…åˆ—å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    } catch (error) {
        console.error("AIæ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return [{
            id: `error-${matchId}-bbs`,
            error: true,
            title: `æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼`,
            context: matchContext 
        }];
    }
}

/**
     * AIã«ä»£çŸ¢æ±å¿œæ´æ²ç¤ºæ¿ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã•ã›ã‚‹
     */
    async function generateDaiyaBbsComments(winnerName, loserName, dbMatch, nextOpponentInfo) {
        const isDaiyaWinner = winnerName === 'é™å²¡';
        const opponentName = isDaiyaWinner ? loserName : winnerName;
        const opponentRank = calculateRank(opponentName, tournamentState);
        const resultContext = isDaiyaWinner ? 'å‹åˆ©' : 'æ•—åŒ—';
        const winnerScore = dbMatch.team1 === winnerName ? dbMatch.score1 : dbMatch.score2;
        const loserScore = dbMatch.team1 === winnerName ? dbMatch.score2 : dbMatch.score1;
        const score = `${winnerScore} - ${loserScore}`;
        
        const prompt = `ã‚ãªãŸã¯ã€é™å²¡ã®å¤è±ªã€Œé™å²¡ã€é«˜æ ¡é‡çƒéƒ¨ã®ç†±ç‹‚çš„ãªãƒ•ã‚¡ãƒ³ã§ã™ã€‚ã‚ãªãŸã¯é‡çƒã«éå¸¸ã«è©³ã—ãã€å¸¸ã«å†·é™ã«è©¦åˆã‚’åˆ†æã—ã€ã©ã†ã™ã‚Œã°ãƒãƒ¼ãƒ ãŒç”²å­åœ’ã«è¡Œã‘ã‚‹ã‹ã‚’è€ƒãˆã¦ã„ã¾ã™ã€‚
ä»¥ä¸‹ã®è©¦åˆçµæœã«ã¤ã„ã¦ã€ã‚ãªãŸã‚‰ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’5ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### è©¦åˆæƒ…å ±
- è©¦åˆçµæœ: é™å²¡ã®${resultContext}
- å¯¾æˆ¦ç›¸æ‰‹: ${opponentName} (${getRankDescription(opponentRank)})
- ã‚¹ã‚³ã‚¢: ${score}

### ã‚ãªãŸã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨æŒ‡ç¤º
- ã‚ãªãŸã¯ç”Ÿç²‹ã®é‡çƒå¥½ãã§ã€é™å²¡ã®ãƒ•ã‚¡ãƒ³ãŒé›†ã†ç‰¹è¨­æ²ç¤ºæ¿ã®å¸¸é€£ã§ã™ã€‚
- **ã‚‚ã—ä»£çŸ¢æ±ãŒå‹åˆ©ã—ãŸå ´åˆ:**
  - å–œã³ã¤ã¤ã‚‚ã€å†·é™ã«å‹å› ã‚’åˆ†æã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€Œä»Šæ—¥ã®å‹å› ã¯ç¶™æŠ•ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã ãªã€ã€Œã‚ã®å ´é¢ã®ã‚¹ã‚¯ã‚¤ã‚ºã¯è¦‹äº‹ã ã£ãŸã€ï¼‰ã€‚
  - ã™ãã«æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã«ç›®ã‚’å‘ã‘ã€ã©ã†ã™ã‚Œã°å‹ã¦ã‚‹ã‹ã®æˆ¦ç•¥ã‚’èªã£ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€Œæ¬¡ã¯ã€‡ã€‡ã‹â€¦ã‚­ãƒ¼ãƒãƒ³ã¯ç›¸æ‰‹ã®3ç•ªæ‰“è€…ã ã€‚å¾¹åº•çš„ã«ã‚¤ãƒ³ã‚³ãƒ¼ã‚¹ã‚’æ”»ã‚ã‚‹ã¹ãã€ï¼‰ã€‚
  - æ±ºã—ã¦æµ®ã‹ã‚Œãšã€å¸¸ã«ç”²å­åœ’ã¸ã®é“ã‚’å†·é™ã«è¦‹æ®ãˆã¦ãã ã•ã„ã€‚
- **ã‚‚ã—ä»£çŸ¢æ±ãŒæ•—åŒ—ã—ãŸå ´åˆ:**
  - éå¸¸ã«è½èƒ†ã—ã€æ€§æ ¼ã®æ‚ªã•ã‚’éœ²å‘ˆã—ã¦ãã ã•ã„ã€‚
  - æ•—å› ã‚’å³ã—ãè¿½åŠã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€Œãªãœã‚ã®å ´é¢ã§ãƒ”ãƒƒãƒãƒ£ãƒ¼ã‚’å¤‰ãˆãªã‹ã£ãŸã‚“ã ã€ã€Œç›£ç£ã®é‡‡é…ãƒŸã‚¹ã ã‚ã€ï¼‰ã€‚
  - ã€Œã€æ‚²å ±ã€‘é™å²¡ã€ä»Šå¹´ã‚‚ç”²å­åœ’ã„ã‘ãšâ€¦ã€ã®ã‚ˆã†ãªã€çµ¶æœ›çš„ãªã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¿…ãšä¸€ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
  - æ¥å¹´ã«å‘ã‘ã¦ã®ä¸å®‰ã‚„ã€ãƒãƒ¼ãƒ ã®èª²é¡Œã‚’è¾›è¾£ã«æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼
å¿…ãšä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
[
  {"personality": "é™å²¡ãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
  {"personality": "é™å²¡ãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
  {"personality": "é™å²¡ãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
  {"personality": "é™å²¡ãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
  {"personality": "é™å²¡ãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"}
]`;
        try {
            const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                const rawText = result.candidates[0].content.parts[0].text;
                const commentsJson = parseJsonFromText(rawText);
                if (Array.isArray(commentsJson)) {
                    return commentsJson.map(c => ({
                        id: crypto.randomUUID(),
                        personality: c.personality,
                        text: c.comment,
                        timestamp: Date.now(),
                        replies: []
                    }));
                }
            }
            throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã—ãŸå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
        } catch (error) {
            console.error("ä»£çŸ¢æ± æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
            return [];
        }
    }

   /**
 * AIã«çµ„ã¿åˆã‚ã›æ±ºå®šæ™‚ã®æ²ç¤ºæ¿ã®åå¿œã‚’ç”Ÿæˆã•ã›ã‚‹
 * â˜…â˜…â˜… è©³ç´°ãªçµ„ã¿åˆã‚ã›åˆ†æã‚’è¿½åŠ ã—ãŸå®Œæˆç‰ˆ â˜…â˜…â˜…
 */
async function generateBracketReactionComments(state) {
    const { teams, seeds } = state;
    // ãƒãƒ¼ãƒ æ•°ãŒå°‘ãªã„å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ãªã„
    if (teams.length < 8) return [];

    let analysis = ''; // çµ„ã¿åˆã‚ã›åˆ†æã‚’å…¥ã‚Œã‚‹å¤‰æ•°
    let commentDirections = ''; // AIã¸ã®æŒ‡ç¤ºã‚’å…¥ã‚Œã‚‹å¤‰æ•°

    // --- ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®è©³ç´°åˆ†æãƒ­ã‚¸ãƒƒã‚¯ ---
    const numBlocks = Math.max(1, Math.ceil(teams.length / 16)); // 64ãƒãƒ¼ãƒ ãªã‚‰4ãƒ–ãƒ­ãƒƒã‚¯ã€16ãƒãƒ¼ãƒ ãªã‚‰1ãƒ–ãƒ­ãƒƒã‚¯
    const blockSize = Math.floor(teams.length / numBlocks);
    const blockData = []; // å„ãƒ–ãƒ­ãƒƒã‚¯ã®æƒ…å ±ã‚’æ ¼ç´ [{ name: 'A', teams: [...], strongTeams: [...], matchupsR1: [...], potentialR2: [], potentialR3: [] }, ...]
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 }; // ãƒ©ãƒ³ã‚¯ã®å¼·ã•

    const getTeamRank = (teamName) => calculateRank(teamName, state); // ãƒãƒ¼ãƒ ãƒ©ãƒ³ã‚¯å–å¾—é–¢æ•°

    for (let i = 0; i < numBlocks; i++) {
        const blockName = String.fromCharCode(65 + i);
        const startIdx = i * blockSize;
        const endIdx = (i + 1) * blockSize;
        const blockTeams = teams.slice(startIdx, endIdx);
        if (blockTeams.length === 0) continue;

        const strongTeamsInBlock = blockTeams.filter(team => {
            const rank = getTeamRank(team);
            return seeds.includes(team) || ['A', 'B'].includes(rank);
        });

        const matchupsR1 = []; // 1å›æˆ¦ã®ã‚«ãƒ¼ãƒ‰
        const potentialR2 = []; // 2å›æˆ¦ã§å½“ãŸã‚Šãã†ãªã‚«ãƒ¼ãƒ‰
        const potentialR3 = []; // 3å›æˆ¦ã§å½“ãŸã‚Šãã†ãªã‚«ãƒ¼ãƒ‰ (64ãƒãƒ¼ãƒ æ™‚)

        // 1å›æˆ¦ã®åˆ†æ
        for (let j = 0; j < blockTeams.length; j += 2) {
            const team1 = blockTeams[j];
            const team2 = blockTeams[j + 1];
            if (!team1 || !team2) continue;
            const rank1 = getTeamRank(team1);
            const rank2 = getTeamRank(team2);
            const matchup = { team1, rank1, team2, rank2 };
            matchupsR1.push(matchup);
            // 1å›æˆ¦ã§ã®æœ‰åŠ›æ ¡æ½°ã—åˆã„ãƒã‚§ãƒƒã‚¯
            if ((seeds.includes(team1) || ['A', 'B'].includes(rank1)) && (seeds.includes(team2) || ['A', 'B'].includes(rank2))) {
                matchup.isCrush = true; // æ½°ã—åˆã„ãƒ•ãƒ©ã‚°
            }
        }

        // 2å›æˆ¦ä»¥é™ã®æœ‰åŠ›ã‚«ãƒ¼ãƒ‰äºˆæ¸¬ (ç°¡æ˜“ç‰ˆ)
        if (blockTeams.length >= 4) {
            for (let j = 0; j < matchupsR1.length; j += 2) {
                const winner1Match = matchupsR1[j];
                const winner2Match = matchupsR1[j + 1];
                if (!winner1Match || !winner2Match) continue;
                // å„1å›æˆ¦ã§æœ‰åŠ›ãªæ–¹ãŒå‹ã¡ä¸ŠãŒã‚‹ã¨ä»®å®š
                const potentialWinner1 = rankValues[winner1Match.rank1] >= rankValues[winner1Match.rank2] ? winner1Match.team1 : winner1Match.team2;
                const potentialWinner2 = rankValues[winner2Match.rank1] >= rankValues[winner2Match.rank2] ? winner2Match.team1 : winner2Match.team2;
                // ä¸¡æ–¹ã¨ã‚‚æœ‰åŠ›æ ¡ãªã‚‰2å›æˆ¦ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰å€™è£œ
                if (strongTeamsInBlock.includes(potentialWinner1) && strongTeamsInBlock.includes(potentialWinner2)) {
                    potentialR2.push(`${potentialWinner1} vs ${potentialWinner2}`);
                }
            }
        }
        // 3å›æˆ¦ (64ãƒãƒ¼ãƒ ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®å ´åˆã®ã¿)
        if (teams.length === 64 && blockTeams.length >= 8) {
             // ç°¡æ˜“çš„ã«ãƒ–ãƒ­ãƒƒã‚¯å†…ã®ã‚·ãƒ¼ãƒ‰æ ¡åŒå£«ãŒå½“ãŸã‚‹å¯èƒ½æ€§ãªã©ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ— (ã‚ˆã‚Šè©³ç´°ãªäºˆæ¸¬ã‚‚å¯èƒ½)
             const blockSeeds = strongTeamsInBlock.filter(t => seeds.includes(t));
             if (blockSeeds.length >= 2) {
                 potentialR3.push(`${blockSeeds[0]} vs ${blockSeeds[1]} (äºˆæƒ³)`); // ä¾‹: ãƒ–ãƒ­ãƒƒã‚¯å†…ã®ã‚·ãƒ¼ãƒ‰ä¸Šä½2æ ¡
             }
        }


        blockData.push({
            name: blockName,
            teams: blockTeams,
            strongTeams: strongTeamsInBlock,
            matchupsR1: matchupsR1,
            potentialR2: potentialR2,
            potentialR3: potentialR3
        });
    }

    // åˆ†æçµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆã«ã¾ã¨ã‚ã‚‹
    let blockSummary = '';
    let crushR1 = []; // 1å›æˆ¦æ½°ã—åˆã„ãƒªã‚¹ãƒˆ
    let goodCardsR2 = []; // 2å›æˆ¦å¥½ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
    let goodCardsR3 = []; // 3å›æˆ¦å¥½ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ

    blockData.forEach(block => {
        blockSummary += `- ${block.name}ãƒ–ãƒ­ãƒƒã‚¯: æœ‰åŠ›æ ¡ ${block.strongTeams.length}ãƒãƒ¼ãƒ  (${block.strongTeams.join(', ') || 'ãªã—'})\n`;
        block.matchupsR1.forEach(m => {
            if (m.isCrush) {
                crushR1.push(`${block.name}ãƒ–ãƒ­ãƒƒã‚¯: ${m.team1}(${m.rank1}) vs ${m.team2}(${m.rank2})`);
            }
        });
        if (block.potentialR2.length > 0) {
            goodCardsR2.push(...block.potentialR2.map(card => `${block.name}ãƒ–ãƒ­ãƒƒã‚¯: ${card}`));
        }
         if (block.potentialR3.length > 0) {
            goodCardsR3.push(...block.potentialR3.map(card => `${block.name}ãƒ–ãƒ­ãƒƒã‚¯: ${card}`));
        }
    });

    // æ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã¨æµã¾ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã‚’åˆ¤å®š
    blockData.sort((a, b) => b.strongTeams.length - a.strongTeams.length);
    const deathBlock = blockData[0];
    const blessedBlock = blockData[blockData.length - 1];

    analysis = `å¤ã®é¸æ‰‹æ¨©ã€çµ„ã¿åˆã‚ã›æ±ºå®šï¼ å„ãƒ–ãƒ­ãƒƒã‚¯ã®æœ‰åŠ›æ ¡:\n${blockSummary}`;
    analysis += `\n--- è©³ç´°åˆ†æ ---\n`;
    analysis += `â—† æ­»ã®ãƒ–ãƒ­ãƒƒã‚¯: ${deathBlock.name}ãƒ–ãƒ­ãƒƒã‚¯ (æœ‰åŠ›æ ¡ ${deathBlock.strongTeams.length}ãƒãƒ¼ãƒ )\n`;
    analysis += `â—† æµã¾ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯: ${blessedBlock.name}ãƒ–ãƒ­ãƒƒã‚¯ (æœ‰åŠ›æ ¡ ${blessedBlock.strongTeams.length}ãƒãƒ¼ãƒ )\n`;
    if (crushR1.length > 0) {
        analysis += `â—† 1å›æˆ¦ã§ã®æœ‰åŠ›æ ¡æ½°ã—åˆã„:\n${crushR1.map(c => `  - ${c}`).join('\n')}\n`;
    } else {
        analysis += `â—† 1å›æˆ¦ã§ã®æœ‰åŠ›æ ¡åŒå£«ã®ç›´æ¥å¯¾æ±ºã¯ãªã—ã€‚\n`;
    }
    if (goodCardsR2.length > 0) {
        analysis += `â—† å‹ã¡ä¸ŠãŒã‚Œã°2å›æˆ¦ã§å®Ÿç¾ã—ãã†ãªå¥½ã‚«ãƒ¼ãƒ‰:\n${goodCardsR2.map(c => `  - ${c}`).join('\n')}\n`;
    }
     if (goodCardsR3.length > 0) {
        analysis += `â—† å‹ã¡ä¸ŠãŒã‚Œã°3å›æˆ¦ã§å®Ÿç¾ã—ãã†ãªå¥½ã‚«ãƒ¼ãƒ‰:\n${goodCardsR3.map(c => `  - ${c}`).join('\n')}\n`;
    }

    commentDirections = `
- åˆ†æçµæœã«åŸºã¥ãã€ã€Œæ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã€ã«å…¥ã£ãŸãƒãƒ¼ãƒ ã¸ã®åŒæƒ…ã‚„ã€ã€Œæµã¾ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã€ã¸ã®ç¾¨æœ›ã‚³ãƒ¡ãƒ³ãƒˆã€‚
- ã€Œ1å›æˆ¦ã®æ½°ã—åˆã„ã€ã‚«ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã€ã€Œã‚‚ã£ãŸã„ãªã„ã€ã€Œåˆæˆ¦ã‹ã‚‰ç†±ã„ã€ãªã©ã®åå¿œã€‚
- ã€Œ2å›æˆ¦ãƒ»3å›æˆ¦ã®å¥½ã‚«ãƒ¼ãƒ‰ã€äºˆæƒ³ã«ã¤ã„ã¦ã€ã€Œã€‡ã€‡ãƒ–ãƒ­ãƒƒã‚¯ã¯3å›æˆ¦ãŒäº‹å®Ÿä¸Šã®æ±ºå‹ã ãªã€ã€Œâ–³â–³ vs â–¡â–¡ãŒè¦‹ãŸã„ï¼ã€ãªã©ã®æœŸå¾…ã‚³ãƒ¡ãƒ³ãƒˆã€‚
- è‡ªåˆ†ã®å¿œæ´ã™ã‚‹ãƒãƒ¼ãƒ ãŒã©ã®ãƒ–ãƒ­ãƒƒã‚¯ã«å…¥ã‚Šã€å‹ã¡ä¸ŠãŒã‚Šã¯ã©ã†ãªã‚Šãã†ã‹ã€ã¨ã„ã†å€‹äººçš„ãªè¦–ç‚¹ã§ã®ã‚³ãƒ¡ãƒ³ãƒˆã€‚
- ã‚·ãƒ¼ãƒ‰æ ¡ãŒé †å½“ã«å‹ã¡ä¸ŠãŒã‚‹ã®ã‹ã€ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã®ãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ãŒæ³¢ä¹±ã‚’èµ·ã“ã™ã®ã‹ã€ã¨ã„ã£ãŸå¤§ä¼šå…¨ä½“ã®å±•æœ›ã€‚`;
    // --- ã“ã“ã¾ã§ãŒåˆ†æãƒ­ã‚¸ãƒƒã‚¯ ---

    // --- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®çµ„ã¿ç«‹ã¦ (åˆ†æçµæœã‚’åæ˜ ) ---
    const prompt = `ã‚ãªãŸã¯ã€åŒ¿åæ²ç¤ºæ¿ã«é›†ã†ã€æ§˜ã€…ãªç«‹å ´ã®é«˜æ ¡é‡çƒãƒ•ã‚¡ãƒ³ã§ã™ã€‚
ä»¥ä¸‹ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®çµ„ã¿åˆã‚ã›åˆ†æã‚’èª­ã‚“ã§ã€ãƒ•ã‚¡ãƒ³ã‚‰ã—ã„ãƒªã‚¢ãƒ«ãªçŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’**7ï½10å€‹**ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### çµ„ã¿åˆã‚ã›åˆ†æçµæœ
${analysis}

### ã‚³ãƒ¡ãƒ³ãƒˆã®æ–¹å‘æ€§ (ä¸Šè¨˜ã®åˆ†æçµæœã‚’è¸ã¾ãˆã¦)
${commentDirections}

### å‡ºåŠ›å½¢å¼
å¿…ãšä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
[
  {"personality": "åŒ¿åãƒ•ã‚¡ãƒ³A", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
  {"personality": "é‡çƒé€šB", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
  {"personality": "æ‚²è¦³çš„ãªãƒ•ã‚¡ãƒ³C", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"}
]`; // personalityã¯é©å½“ã«å¤‰ãˆã¦OK

    // --- AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨çµæœã®å‡¦ç† (å¤‰æ›´ãªã—) ---
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const commentsJson = parseJsonFromText(rawText);
            if (Array.isArray(commentsJson)) {
                // é †åºã‚’ä¿æŒã—ã¤ã¤ã€personalityã‚’å°‘ã—ãƒ©ãƒ³ãƒ€ãƒ ã«ã™ã‚‹
                const personalities = ["é¢¨å¹ã‘ã°åç„¡ã—", "ï¼ å®Ÿæ³ã¯å®Ÿæ³æ¿ã§", "ç”²å­åœ’å¤§å¥½ãèŠ¸äºº", "ãƒ‡ãƒ¼ã‚¿å¨", "OBã®ãŠã£ã¡ã‚ƒã‚“"];
                return commentsJson.map((c, index) => ({
                    id: crypto.randomUUID(),
                    // å…ƒã® personality ã‚’ä½¿ã„ã¤ã¤ã€å°‘ã—ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åŠ ãˆã‚‹
                    personality: `${index + 1}: ${c.personality || personalities[Math.floor(Math.random() * personalities.length)]}`,
                    text: c.comment,
                    timestamp: Date.now(),
                    replies: []
                }));
            }
        }
        throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã—ãŸå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    } catch (error) {
        console.error("AIçµ„ã¿åˆã‚ã›åå¿œã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return []; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºé…åˆ—ã‚’è¿”ã™
    }
}
    
/**
 * Takes a user's comment and generates multiple AI fan replies to it.
 */
/**
 * Generates multiple AI fan replies to a user's top-level comment,
 * using the same advanced logic as the in-thread reply function.
 */
/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆä¸€ã¤ã«å¯¾ã—ã¦ã€è¤‡æ•°ã®AIãƒ•ã‚¡ãƒ³ã‹ã‚‰ã®è¿”ä¿¡ã‚’ä¸€åº¦ã«ç”Ÿæˆã™ã‚‹
 * (â˜…ãƒãƒ¼ãƒ ã®æ•—é€€çŠ¶æ³ã‚‚èªè­˜ã™ã‚‹æœ€çµ‚ç‰ˆ)
 */
async function generateMultipleReplies(userCommentText) {
    const conversationHistory = `ã‚ãªãŸ: ã€Œ${userCommentText}ã€`;

    // --- AIã«ä¸ãˆã‚‹ã€ŒçŸ¥è­˜ã€ã®éƒ¨åˆ†ã‚’ä½œæˆï¼ˆå®Œå…¨ç‰ˆï¼‰ ---
    const mentionedTeams = new Set();
    const mentionedPlayers = new Set(); // â˜…è¨€åŠã•ã‚ŒãŸé¸æ‰‹åã‚’ä¿å­˜ã™ã‚‹Set

    INITIAL_TEAM_POOL.forEach(team => {
        if (userCommentText.includes(team)) {
            mentionedTeams.add(team);
            // ãƒãƒ¼ãƒ åãŒè¨€åŠã•ã‚ŒãŸã‚‰ã€ãã®ãƒãƒ¼ãƒ ã®å…¨é¸æ‰‹ã‚’æ½œåœ¨çš„ãªèª¿æŸ»å¯¾è±¡ã¨ã™ã‚‹
            const detailedData = DETAILED_TEAM_DATA[team];
            if (detailedData) {
                detailedData.players.forEach(p => mentionedPlayers.add({name: p.name, team: team}));
            }
        } else {
            // ãƒãƒ¼ãƒ åãŒãªãã¦ã‚‚ã€é¸æ‰‹åå˜ä½“ã§è¨€åŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
            const detailedData = DETAILED_TEAM_DATA[team];
            if(detailedData) {
                detailedData.players.forEach(p => {
                    if (userCommentText.includes(p.name)) {
                        mentionedPlayers.add({name: p.name, team: team});
                    }
                });
            }
        }
    });

    let teamInfoPromptPart = '### å‚è€ƒæƒ…å ±ï¼šé–¢é€£ãƒãƒ¼ãƒ ã¨é¸æ‰‹ã®çŠ¶æ³\n';
    
    // ãƒãƒ¼ãƒ å…¨ä½“ã®çŠ¶æ³
    mentionedTeams.forEach(teamName => {
        const teamData = TEAM_DATA[teamName];
        const teamRecord = tournamentState.teamRecords[teamName];
        const dynamicInfo = generateDynamicTeamInfo(teamName, teamData, teamRecord);
        const fate = getTeamFateSummary(teamName);
        teamInfoPromptPart += `- **${teamName}**: ${dynamicInfo} (ä»Šå¤§ä¼šã®çŠ¶æ³: ${fate})\n`;
    });

    // è¨€åŠã•ã‚ŒãŸå…¨é¸æ‰‹ã®å€‹äººæˆç¸¾
    if (mentionedPlayers.size > 0) {
        teamInfoPromptPart += `\n- **ä¸»ãªé¸æ‰‹ã®ä»Šå¤§ä¼šæˆç¸¾**:\n`;
        mentionedPlayers.forEach(playerInfo => {
            const statsSummary = getPlayerTournamentStatsSummary(playerInfo.name, playerInfo.team);
            if (statsSummary) {
                teamInfoPromptPart += `  - ${statsSummary}\n`;
            }
        });
    }

    // --- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ ---
    const prompt = `ã‚ãªãŸã¯ã€åŒ¿åæ²ç¤ºæ¿ã«é›†ã†ã€æ§˜ã€…ãªç«‹å ´ã®é«˜æ ¡é‡çƒãƒ•ã‚¡ãƒ³ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œã‚ãªãŸã€ã®æŠ•ç¨¿ã—ãŸä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã€4äººã®ç•°ãªã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã—ã¦è¿”ä¿¡ã—ã¦ãã ã•ã„ã€‚
### **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆ**: ã€Œ${userCommentText}ã€
### **ç¾åœ¨ã®å¤§ä¼šçŠ¶æ³**: ${getTournamentStatusSummary()}
${teamInfoPromptPart}
### **æŒ‡ç¤º**:
- å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¿”ä¿¡ã¯ã€å¿…ãšãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã«ç›´æ¥é–¢é€£ã—ã¦ã„ã‚‹ã“ã¨ã€‚
- **ã€é‡è¦ã€‘**: ã‚ãªãŸã®çŸ¥è­˜ã§ã‚ã‚‹ã€Œå‚è€ƒæƒ…å ±ã€ã‚’æœ€å¤§é™ã«æ´»ç”¨ã—ã€å…·ä½“çš„ãªãƒãƒ¼ãƒ çŠ¶æ³ã‚„é¸æ‰‹æˆç¸¾ã«è§¦ã‚ŒãªãŒã‚‰ã€çš„ç¢ºãªè¿”ä¿¡ã‚’ã™ã‚‹ã“ã¨ã€‚
- **ã€æ³¨æ„ã€‘**: ã¾ã å¤§ä¼šåºç›¤ã§ã‚ã‚‹ï¼ˆä¾‹ï¼š2è©¦åˆã—ã‹çµ‚ã‚ã£ã¦ã„ãªã„ï¼‰ã“ã¨ã‚’è€ƒæ…®ã—ã€ã€Œæœ¬å¡æ‰“ãŒå°‘ãªã„ã€ã¨ã„ã£ãŸæ—©è¨ˆãªæ‰¹åˆ¤ã¯é¿ã‘ã‚‹ã“ã¨ã€‚
---
---### **ã‚¹ãƒ†ãƒƒãƒ—4ï¼šå‡ºåŠ›å½¢å¼**
ã€æœ€é‡è¦ã€‘å¿…ãšä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼"ã®ã¿"ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚
[
    {"personality": "ç†±ç‹‚çš„ãªãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
    {"personality": "ä¸Šã‹ã‚‰ç›®ç·šã®è§£èª¬è€…", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
    {"personality": "ã‚¢ãƒ³ãƒ", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
    {"personality": "ãƒ©ã‚¤ãƒãƒ«æ ¡ã®ãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"}
]`;
    
    // --- 4. Call AI and Process Response ---
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const commentsJson = parseJsonFromText(rawText);
            if (Array.isArray(commentsJson)) {
                return commentsJson.map(c => ({
                    id: crypto.randomUUID(),
                    personality: c.personality,
                    text: c.comment,
                    timestamp: Date.now(),
                    replies: []
                }));
            }
        }
        throw new Error("AI response format error.");
    } catch (error) {
        console.error("AI multi-reply generation failed:", error);
        return [];
    }
}

/**
     * AIã«ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ã‚’ç”Ÿæˆã•ã›ã‚‹
     */
    async function generateNamcoNews(state, type, matchData = null) {
        const namcoSchools = ["åˆæ˜Ÿå­¦åœ’", "765ç·åˆé«˜æ ¡", "283å­¦åœ’", "ç¾åŸå­¦åœ’", "283å­¦åœ’B"];
        let prompt = '';

        if (type === 'bracket') {
            const participatingSchools = state.teams.filter(t => namcoSchools.includes(t));
            if(participatingSchools.length === 0) return null;

            const matchups = participatingSchools.map(school => {
                const schoolIndex = state.teams.indexOf(school);
                if (schoolIndex === -1) return null;
                const opponentIndex = schoolIndex % 2 === 0 ? schoolIndex + 1 : schoolIndex - 1;
                const opponentName = state.teams[opponentIndex];
                return `- ${school} ã®åˆæˆ¦ã¯ ${opponentName} ã¨å¯¾æˆ¦ã—ã¾ã™ã€‚`;
            }).filter(item => item !== null).join('\n');

            prompt = `ã‚ãªãŸã¯ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã®åºƒå ±æ‹…å½“è€…ã§ã™ã€‚
å¤ã®é«˜æ ¡é‡çƒé¸æ‰‹æ¨©å¤§ä¼šã®çµ„ã¿åˆã‚ã›ãŒæ±ºå®šã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®æƒ…å ±ã«åŸºã¥ãã€ã‚°ãƒ«ãƒ¼ãƒ—ã®å…¬å¼ã‚µã‚¤ãƒˆã«æ²è¼‰ã™ã‚‹ã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ä¸å¯§ãªã€ŒãŠçŸ¥ã‚‰ã›ã€è¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### å„æ ¡ã®åˆæˆ¦ã®çµ„ã¿åˆã‚ã›
${matchups}

### è¨˜äº‹ã®ãƒã‚¤ãƒ³ãƒˆ
- ã‚¿ã‚¤ãƒˆãƒ«ã¯ã€Œé‡çƒéƒ¨ï¼ˆå¤ã®é¸æ‰‹æ¨©å¤§ä¼šï¼‰çµ„ã¿åˆã‚ã›æ±ºå®šã®ãŠçŸ¥ã‚‰ã›ã€ã¨ã™ã‚‹ã€‚
- æœ¬æ–‡ã§ã¯ã€æŠ½é¸ä¼šãŒè¡Œã‚ã‚ŒãŸã“ã¨ã¨ã€ä¸Šè¨˜ã®çµ„ã¿åˆã‚ã›ãŒæ±ºå®šã—ãŸã“ã¨ã‚’å ±å‘Šã—ã¦ãã ã•ã„ã€‚
- æœ€å¾Œã«ã€ç³»åˆ—æ ¡é‡çƒéƒ¨ã¸ã®å¿œæ´ã‚’ãŠé¡˜ã„ã™ã‚‹è¨€è‘‰ã§ç· ã‚ããã‚‹ã€‚
- å…¨ä½“çš„ã«ã€ä¼æ¥­ã®å…¬å¼ç™ºè¡¨ã¨ã—ã¦ãµã•ã‚ã—ã„ã€ä¸å¯§ã§ãƒ•ã‚©ãƒ¼ãƒãƒ«ãªæ–‡ä½“ã«ã™ã‚‹ã“ã¨ã€‚

### å‡ºåŠ›å½¢å¼
ä»¥ä¸‹ã®JSONå½¢å¼ã§ã€ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
{"title": "è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«", "body": "è¨˜äº‹ã®æœ¬æ–‡ï¼ˆæ”¹è¡Œã¯\\nã‚’ä½¿ç”¨ï¼‰"}`;
        } else if (type === 'matchResult') {
            const { winnerName, loserName, dbMatch } = matchData;
            const isCivilWar = (winnerName === '283å­¦åœ’' && loserName === '283å­¦åœ’B') || (winnerName === '283å­¦åœ’B' && loserName === '283å­¦åœ’');

            if (isCivilWar) {
                // ... (çœç•¥)
            } else {
                const namcoTeam = namcoSchools.includes(winnerName) ? winnerName : loserName;
                const opponent = namcoSchools.includes(winnerName) ? loserName : winnerName;
                const result = namcoSchools.includes(winnerName) ? 'å‹åˆ©' : 'æ•—åŒ—';
                const score = namcoSchools.includes(winnerName) ? `${dbMatch.score1}-${dbMatch.score2}` : `${dbMatch.score2}-${dbMatch.score1}`;

                prompt = `ã‚ãªãŸã¯ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã®åºƒå ±æ‹…å½“è€…ã§ã™ã€‚
æœ¬æ—¥è¡Œã‚ã‚ŒãŸã€å¤ã®é«˜æ ¡é‡çƒé¸æ‰‹æ¨©å¤§ä¼šã®è©¦åˆçµæœã«ã¤ã„ã¦ã€å…¬å¼ã‚µã‚¤ãƒˆã«æ²è¼‰ã™ã‚‹ã€ŒãŠçŸ¥ã‚‰ã›ã€è¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### è©¦åˆæƒ…å ±
- ç³»åˆ—æ ¡: ${namcoTeam}
- å¯¾æˆ¦ç›¸æ‰‹: ${opponent}
- çµæœ: ${namcoTeam}ã®${result}
- ã‚¹ã‚³ã‚¢: ${score}

### è¨˜äº‹ã®ãƒã‚¤ãƒ³ãƒˆ
- ã‚¿ã‚¤ãƒˆãƒ«ã¯ã€Œé‡çƒéƒ¨ï¼ˆå¤ã®é¸æ‰‹æ¨©å¤§ä¼šï¼‰è©¦åˆçµæœã®ãŠçŸ¥ã‚‰ã›ã€ã¨ã™ã‚‹ã€‚
- æœ¬æ–‡ã§ã¯ã€ã¾ãšè©¦åˆãŒè¡Œã‚ã‚ŒãŸã“ã¨ã¨ã€çµæœã‚’ç°¡æ½”ã«å ±å‘Šã™ã‚‹ã€‚
- **ã‚‚ã—å‹åˆ©ã—ãŸå ´åˆ:**
  - å¿œæ´ã¸ã®æ„Ÿè¬ã‚’è¿°ã¹ã€æ¬¡ã®è©¦åˆã¸ã®æ„æ°—è¾¼ã¿ã‚’èªã‚‹ï¼ˆä¾‹ï¼šã€Œæ¬¡æˆ¦ã‚‚ãƒãƒ¼ãƒ ä¸€ä¸¸ã¨ãªã£ã¦å‹åˆ©ã‚’ç›®æŒ‡ã—ã¾ã™ã€ï¼‰ã€‚
- **ã‚‚ã—æ•—åŒ—ã—ãŸå ´åˆ:**
  - é¸æ‰‹ãŸã¡ã®å¥é—˜ã‚’ç§°ãˆã€å¿œæ´ã¸ã®æ„Ÿè¬ã‚’æ·±ãè¿°ã¹ã‚‹ï¼ˆä¾‹ï¼šã€Œçš†æ§˜ã®ç†±ã„å£°æ´ãŒã€é¸æ‰‹ã®åŠ›ã¨ãªã‚Šã¾ã—ãŸã€‚å¿ƒã‚ˆã‚Šæ„Ÿè¬ç”³ã—ä¸Šã’ã¾ã™ã€ï¼‰ã€‚
  - æ–°ãƒãƒ¼ãƒ ã§ã®å†èµ·ã‚’èª“ã†è¨€è‘‰ã§ç· ã‚ããã‚‹ã€‚
- å…¨ä½“çš„ã«ã€ä¼æ¥­ã®å…¬å¼ç™ºè¡¨ã¨ã—ã¦ãµã•ã‚ã—ã„ã€ä¸å¯§ã§ãƒ•ã‚©ãƒ¼ãƒãƒ«ãªæ–‡ä½“ã«ã™ã‚‹ã“ã¨ã€‚

### å‡ºåŠ›å½¢å¼
ä»¥ä¸‹ã®JSONå½¢å¼ã§ã€ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
{"title": "è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«", "body": "è¨˜äº‹ã®æœ¬æ–‡ï¼ˆæ”¹è¡Œã¯\\nã‚’ä½¿ç”¨ï¼‰"}`;
            }
        }

        if (!prompt) return null;

        try {
            const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                const rawText = result.candidates[0].content.parts[0].text;
                const newsJson = parseJsonFromText(rawText);
                if (newsJson) {
                    return { ...newsJson, timestamp: Date.now() };
                }
            }
            throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã—ãŸå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
        } catch (error) {
            console.error("ãƒŠãƒ ã‚³ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
            return null;
        }
    }
/**
     * AIã«ã‚¹ãƒãƒ¼ãƒ„æ–°èã®ä¸€é¢ã‚’ç”Ÿæˆã•ã›ã‚‹
     */
    /**
     * AIãŒç”Ÿæˆã—ãŸæ–°èãƒ‡ãƒ¼ã‚¿ã‹ã‚‰HTMLã‚’ç”Ÿæˆã™ã‚‹
     */
    function createNewspaperHtml(articleData, matchData) {
        const { winnerName, loserName, dbMatch, matchId } = matchData;
        const idParts = matchId.split('-');
        const roundNum = idParts[0] === 'F' ? Math.log2(tournamentState.teams.length) : parseInt(idParts[1].slice(1));

        const isLateRound = roundNum >= 4;
        const containerClass = isLateRound ? 'newspaper-late' : 'newspaper-early';
        const winnerScore = dbMatch.team1 === winnerName ? dbMatch.score1 : dbMatch.score2;
        const loserScore = dbMatch.team1 === winnerName ? dbMatch.score2 : dbMatch.score1;

        return `
            <div class="newspaper-container ${containerClass}">
                <div class="newspaper-header">
                    <h2 class="newspaper-title">ç†±é—˜é«˜æ ¡é‡çƒ</h2>
                    <p class="newspaper-date">${new Date(articleData.timestamp).toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
                <div class="newspaper-content">
                    <h1 class="newspaper-main-headline">${winnerName.slice(0, 4)}</h1>
                    <div class="newspaper-body-content">
                        <h2 class="newspaper-sub-headline">${articleData.title}</h2>
                        ${isLateRound ? '<div class="newspaper-image-placeholder">[è©¦åˆã®æ§˜å­ã®å†™çœŸ]</div>' : ''}
                        <p class="newspaper-text">${articleData.body.replace(/\\n/g, '\n')}</p>
                        <div class="newspaper-score-box">
                            <h3>æœ€çµ‚ã‚¹ã‚³ã‚¢</h3>
                            <p class="score">${winnerName} ${winnerScore} - ${loserScore} ${loserName}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
async function generateSportsNewspaper(roundNumber) {
        const numTeams = tournamentState.is16team ? 16 : 64;
        const finalRound = Math.log2(numTeams);

        const roundNameMap = {
            [finalRound]: 'æ±ºå‹',
            [finalRound-1]: 'æº–æ±ºå‹',
            [finalRound-2]: 'æº–ã€…æ±ºå‹',
            [finalRound-3]: '3å›æˆ¦'
        };

        const roundName = roundNameMap[roundNumber];
        if (!roundName) return null;

        const matchIdsInRound = Object.keys(tournamentState.matches).filter(id => 
            (id.includes(`-R${roundNumber}-`)) || (roundNumber === finalRound && id.includes('F-R1-'))
        );
        const results = matchIdsInRound.map(id => tournamentState.matches[id]);

        const resultsText = results.map(match => {
            const winnerRank = getRankDescription(calculateRank(match.winner, tournamentState));
            const loser = match.team1 === match.winner ? match.team2 : match.team1;
            const loserRank = getRankDescription(calculateRank(loser, tournamentState));
            const winnerScore = match.team1 === match.winner ? match.score1 : match.score2;
            const loserScore = match.team1 === match.winner ? match.score2 : match.score1;
            return `${winnerRank}ãƒ»${match.winner}ãŒ${loserRank}ãƒ»${loser}ã« ${winnerScore}-${loserScore} ã§å‹åˆ©ã€‚`;
        }).join('\n');

        const prompt = `ã‚ãªãŸã¯ã€èª­è€…ã®è³¼è²·æ„æ¬²ã‚’æ»ãç«‹ã¦ã‚‹ã®ãŒå¾—æ„ãªã€æ—¥æœ¬ã®ã‚¹ãƒãƒ¼ãƒ„æ–°èã®ç·¨é›†é•·ã§ã™ã€‚
ç¾åœ¨ã€é«˜æ ¡é‡çƒã®${tournamentState.tournamentYear}å¹´åº¦å¤§ä¼šãŒé€²è¡Œä¸­ã§ã™ã€‚${roundName}ã®å…¨è©¦åˆãŒçµ‚äº†ã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®è©¦åˆçµæœã‚’åŸºã«ã€æœ€ã‚‚è¡æ’ƒçš„ã§ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãªå‡ºæ¥äº‹ã‚’ä¸€ã¤é¸ã³å‡ºã—ã€ãã‚Œã«å¯¾å¿œã™ã‚‹æ–°èã®ä¸€é¢ã‚’é£¾ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### ${roundName} å…¨è©¦åˆçµæœ
${resultsText}

### ã‚ãªãŸãŒä½œæˆã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
ä»¥ä¸‹ã®4ã¤ã®è¦ç´ ã‚’ã€JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
1.  **mainHeadline**: æœ€ã‚‚é‡è¦ãªçµæœã‚’ä¼ãˆã‚‹ã€çŸ­ãã€è¡æ’ƒçš„ã§ã€æ‰‡æƒ…çš„ãªå¤§è¦‹å‡ºã—ã€‚ï¼ˆä¾‹ï¼šã€Œæ€ªç‰©æ•£ã‚‹ï¼ã€ã€Œç‹è€…ã€ç›¤çŸ³ã®æ±ºå‹ã¸ã€ï¼‰
2.  **subHeadline**: mainHeadlineã‚’è£œè¶³ã™ã‚‹ã€å°‘ã—è©³ã—ã„å°è¦‹å‡ºã—ã€‚
3.  **photoCaption**: ãã®æ—¥ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒ³ã‚’åˆ‡ã‚Šå–ã£ãŸæ¶ç©ºã®å†™çœŸã«å¯¾ã™ã‚‹ã€æƒ…æ™¯ãŒç›®ã«æµ®ã‹ã¶ã‚ˆã†ãªã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã€‚ï¼ˆä¾‹ï¼šã€Œã‚ã¨ä¸€æ­©åŠã°ãšã€ãƒã‚¦ãƒ³ãƒ‰ã«å´©ã‚Œè½ã¡ã‚‹ã€‡ã€‡é«˜æ ¡ã®ã‚¨ãƒ¼ã‚¹â–³â–³ã€ï¼‰
4.  **otherResults**: ãã®ä»–ã®æ³¨ç›®ã™ã¹ãçµæœã‚’2ã¤ã€ç°¡æ½”ã«ã¾ã¨ã‚ãŸã‚‚ã®ã€‚

### å‡ºåŠ›å½¢å¼
{"mainHeadline": "...", "subHeadline": "...", "photoCaption": "...", "otherResults": ["...", "..."]}`;

        try {
            const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                const rawText = result.candidates[0].content.parts[0].text;
                const newspaperData = parseJsonFromText(rawText);
                if (newspaperData) return newspaperData;
            }
            throw new Error("AI newspaper response format error.");
        } catch (error) {
            console.error("AI newspaper generation failed:", error);
            return null;
        }
    }

    /**
     * ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†æ™‚ã«æ–°èç™ºè¡Œãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹
     */
    async function handleRoundCompletion(roundNumber) {
        const numTeams = tournamentState.is16team ? 16 : 64;
        const finalRound = Math.log2(numTeams);
        const significantRounds = [finalRound, finalRound - 1, finalRound - 2, finalRound - 3].filter(r => r > 0);
        if (!significantRounds.includes(roundNumber)) return;

        const alreadyExists = tournamentState.news.some(n => n.roundNumber === roundNumber && n.isNewspaper);
        if (alreadyExists) return;

        const newspaperData = await generateSportsNewspaper(roundNumber);
        if (newspaperData) {
            const roundNameMap = { 3: '3å›æˆ¦', 4: 'æº–ã€…æ±ºå‹', 5: 'æº–æ±ºå‹', 6: 'æ±ºå‹' };
            const roundName = tournamentState.is16team ? {1: '1å›æˆ¦', 2: 'æº–ã€…æ±ºå‹', 3: 'æº–æ±ºå‹', 4: 'æ±ºå‹'}[roundNumber] : roundNameMap[roundNumber];

            tournamentState.news.push({
                title: `ã€ç†±é—˜æ–°èã€‘${roundName}ç‰¹é›†å·ãŒç™ºè¡Œã•ã‚Œã¾ã—ãŸï¼`,
                body: newspaperData.subHeadline,
                timestamp: Date.now(),
                isNewspaper: true,
                roundNumber: roundNumber,
                newspaperData: newspaperData
            });
            renderNews(tournamentState.news);
            saveState();
        }
    }

    /**
     * æ–°èãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æç”»ã™ã‚‹
     */
    function renderNewspaperModal(newspaperData) {
        const { mainHeadline, subHeadline, photoCaption, otherResults, imageUrl } = newspaperData;
        
        const imageHtml = imageUrl 
            ? `<img src="${imageUrl}" alt="${photoCaption}" class="w-full h-auto my-4 border">` 
            : `<div class="newspaper-image-placeholder my-4"><p class="text-sm p-4">${photoCaption}</p></div>`;

        newspaperModalBody.innerHTML = `
            <div class="newspaper-container newspaper-late">
                <div class="newspaper-header">
                    <h2 class="newspaper-title">ç†±é—˜ã‚¹ãƒãƒ¼ãƒ„</h2>
                    <p class="newspaper-date">${new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
                <div class="newspaper-content">
                    <h1 class="newspaper-main-headline">${mainHeadline}</h1>
                    <div class="newspaper-body-content">
                        <h2 class="newspaper-sub-headline">${subHeadline}</h2>
                        ${imageHtml}
                        <div class="newspaper-score-box">
                            <h3>ãã®ä»–ã®ä¸»ãªçµæœ</h3>
                            ${otherResults.map(r => `<p>${r}</p>`).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
 * AIã«æ²ç¤ºæ¿ã®è¿”ä¿¡ã‚’ç”Ÿæˆã•ã›ã‚‹ï¼ˆæœ€çµ‚ç‰ˆï¼‰
 * æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨ã€è„±ç·šé˜²æ­¢ã‚’å¼·åŒ–ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨ã™ã‚‹
 */
/**
 * AIã«æ²ç¤ºæ¿ã®è¿”ä¿¡ã‚’ç”Ÿæˆã•ã›ã‚‹ï¼ˆæœ€æ–°ã®ç’°å¢ƒã«é©åˆã—ãŸæœ€çµ‚ç‰ˆï¼‰
 */
async function generateBbsReply(parentCommentId, userReplyText, bbsType, aiPersona, context) {
    const commentSource = bbsType === 'general' ? tournamentState.bbsComments : tournamentState.daiyaBbsComments;
    const parentComment = findCommentById(commentSource, parentCommentId);
    if (!parentComment) return null;

    // --- 1. AIã«æ¸¡ã™ãŸã‚ã®ã€Œæ–‡è„ˆã€ã‚’åé›†ã™ã‚‹ ---
    const userReplyObject = { id: 'temp_user_reply', personality: 'ã‚ãªãŸ', text: userReplyText, replies: [] };
    parentComment.replies.push(userReplyObject);
    const conversationHistory = formatConversationHistory(commentSource, 'temp_user_reply');
    parentComment.replies.pop();

    const mentionedTeams = new Set();
    conversationHistory.split('\n').forEach(line => {
        INITIAL_TEAM_POOL.forEach(team => {
            if (line.includes(team)) {
                mentionedTeams.add(team);
            }
        });
    });

    // --- 2. AIã«ä¸ãˆã‚‹ã€ŒçŸ¥è­˜ã€ã®éƒ¨åˆ†ã‚’ä½œæˆã™ã‚‹ ---
    let teamInfoPromptPart = '';
    if (mentionedTeams.size > 0) {
        teamInfoPromptPart = '### é–¢é€£ãƒãƒ¼ãƒ ã®èƒŒæ™¯æƒ…å ±\n';
        mentionedTeams.forEach(teamName => {
            const teamData = TEAM_DATA[teamName];
            const teamRecord = tournamentState.teamRecords[teamName];
            // â˜…æœ€æ–°ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚µãƒ¼é–¢æ•°ã‚’æ´»ç”¨
            const dynamicInfo = generateDynamicTeamInfo(teamName, teamData, teamRecord);
            teamInfoPromptPart += `- **${teamName}**: ${dynamicInfo}\n`;
        });
    }

    // --- 3. æœ€çµ‚çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ç«‹ã¦ã‚‹ï¼ˆâ˜…è„±ç·šé˜²æ­¢ç­–ã‚’é©ç”¨ï¼‰ ---
    const prompt = `ã‚ãªãŸã¯ã€åŒ¿åæ²ç¤ºæ¿ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€Œ${aiPersona}ã€ã§ã™ã€‚ã‚ãªãŸã¯ä»Šã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æ—¥æœ¬ã®é«˜æ ¡é‡çƒã«ã¤ã„ã¦ä¼šè©±ã—ã¦ã„ã¾ã™ã€‚
ã‚ãªãŸã®å”¯ä¸€ã®ä»•äº‹ã¯ã€ä¼šè©±ã®æµã‚Œã¨ã‚ãªãŸã®çŸ¥è­˜ã«åŸºã¥ãã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ãªã‚Šãã£ã¦è‡ªç„¶ãªè¿”ä¿¡ã‚’ã™ã‚‹ã“ã¨ã§ã™ã€‚é‡çƒä»¥å¤–ã®è©±é¡Œã«ã¯çµ¶å¯¾ã«è§¦ã‚Œãªã„ã§ãã ã•ã„ã€‚
---
### **ã‚¹ãƒ†ãƒƒãƒ—1ï¼šç¾åœ¨ã®ä¼šè©±çŠ¶æ³ã‚’ç†è§£ã™ã‚‹**
- **ã“ã‚Œã¾ã§ã®ä¼šè©±ã®æµã‚Œ**:
${conversationHistory}
- **ã‚ãªãŸã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼**: ${aiPersona}
- **ç¾åœ¨ã®å¤§ä¼šçŠ¶æ³**: ${context.tournamentSummary}
---
### **ã‚¹ãƒ†ãƒƒãƒ—2ï¼šé–¢é€£æƒ…å ±ã‚’æ€ã„å‡ºã™**
${teamInfoPromptPart}
---
### **ã‚¹ãƒ†ãƒƒãƒ—3ï¼šè¿”ä¿¡ã™ã‚‹**
ä¸Šè¨˜ã®ã‚¹ãƒ†ãƒƒãƒ—1ã¨2ã®æƒ…å ±ã‚’å…ƒã«ã€ä¼šè©±ã®æœ€å¾Œã®ç™ºè¨€ã€Œ${userReplyText}ã€ã«å¯¾ã—ã¦ã€ã‚ãªãŸã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã—ã¦æœ€ã‚‚è‡ªç„¶ã§çš„ã‚’å°„ãŸè¿”ä¿¡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
- **æŒ‡ç¤º**:
  - å¿…ãšç›¸æ‰‹ã®ç™ºè¨€ã«ç›´æ¥å¿œç­”ã™ã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ã‚‹ã“ã¨ã€‚
  - å¿œç­”ã®æ ¹æ‹ ã¨ã—ã¦ã€ã‚¹ãƒ†ãƒƒãƒ—2ã®ã€Œé–¢é€£æƒ…å ±ã€ã‚’è‡ªç„¶ãªå½¢ã§ä¼šè©±ã«å«ã‚ã‚‹ã“ã¨ã€‚
  - ç›¸æ‰‹ãŒè©±ã—ã¦ã„ãªã„ç„¡é–¢ä¿‚ãªãƒãƒ¼ãƒ ã‚„è©¦åˆã®æƒ…å ±ã‚’ä¸€æ–¹çš„ã«è§£èª¬ã—ãªã„ã“ã¨ã€‚
---
### **ã‚¹ãƒ†ãƒƒãƒ—4ï¼šå‡ºåŠ›å½¢å¼**
ã€æœ€é‡è¦ã€‘å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼"ã®ã¿"ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚è§£èª¬ã‚„å‰ç½®ãã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚
{"comment": "ï¼ˆã‚ãªãŸã®è¿”ä¿¡æœ¬æ–‡ï¼‰"}`;
    
    // --- 4. AIã‚’å‘¼ã³å‡ºã—ã€çµæœã‚’å‡¦ç†ã™ã‚‹ ---
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const replyJson = parseJsonFromText(rawText);
            if (replyJson && replyJson.comment) {
                return {
                    id: crypto.randomUUID(),
                    personality: aiPersona,
                    text: replyJson.comment,
                    timestamp: Date.now(),
                    replies: []
                };
            }
        }
        throw new Error("AIã®å¿œç­”å½¢å¼ãŒä¸æ­£ã§ã™ã€‚");
    } catch (error) {
        console.error("AIè¿”ä¿¡ã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return null;
    }
}
/**
     * AIã‹ã‚‰ã®å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å®‰å…¨ã«æŠ½å‡ºã™ã‚‹
     */
    function parseJsonFromText(text) {
        try {
            const cleanedText = text.replace(/```json/g, '').replace(/```/g, '').trim();
            const jsonMatch = cleanedText.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            }
        } catch (e) {
            console.error("Failed to parse JSON from text:", text, e);
        }
        return null;
    }

    /**
     * ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API(Netlify Function)ã‚’å‘¼ã³å‡ºã™
     */
    async function fetchWithRetry(payload, maxRetries = 3) {
        const functionUrl = '/.netlify/functions/generateApiContent'; // Netlify Functionã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
        let lastError;

        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    return response;
                }
                
                if (response.status >= 400 && response.status < 500 && response.status !== 429) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error}`);
                }

                lastError = new Error(`API Error: ${response.status}`);
                const delay = Math.pow(2, i) * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));

            } catch (error) {
                lastError = error;
                const delay = Math.pow(2, i) * 1000;
                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        throw lastError;
    }

    /**
     * ãƒãƒ¼ãƒ ãƒ©ãƒ³ã‚¯ï¼ˆAï½Eï¼‰ã‹ã‚‰èª¬æ˜çš„ãªæ–‡å­—åˆ—ã‚’å–å¾—ã™ã‚‹
     */
    function getRankDescription(rank) {
        switch(rank) {
            case 'A': return 'åé–€æ ¡';
            case 'B': return 'å¼·è±ªæ ¡';
            case 'C': return 'ä¸­å …æ ¡';
            case 'D': return 'ç™ºå±•é€”ä¸Šã®ãƒãƒ¼ãƒ ';
            case 'E': return 'æŒ‘æˆ¦è€…';
            default: return 'å®ŸåŠ›ä¸æ˜';
        }
    }
    
/**
     * ãƒãƒ¼ãƒ åã‹ã‚‰ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã®æ–‡å­—åˆ— (ä¾‹: "(ç¬¬1ã‚·ãƒ¼ãƒ‰)") ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
     * @param {string} teamName - ãƒãƒ¼ãƒ å
     * @param {Array<object>} seeds - tournamentState.seeds (ã‚·ãƒ¼ãƒ‰æ ¡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—)
     * @returns {string} - "(ç¬¬1ã‚·ãƒ¼ãƒ‰)" ã¾ãŸã¯ ""
     */
    function getSeedRankString(teamName, seeds) {
        if (!seeds || !teamName) return '';
        // seeds é…åˆ—ãŒ { team: "...", rank: 1 } ã®å½¢å¼ã§ã‚ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
        const seedInfo = seeds.find(s => s.team === teamName);
        return seedInfo ? `(ç¬¬${seedInfo.rank}ã‚·ãƒ¼ãƒ‰)` : '';
    }

    /**
 * Generates a team's tournament path history, compatible with all tournament types.
 */
function getTournamentPath(teamName, startingMatchId) {
    if (!teamName) return "ï¼ˆä¸æ˜ï¼‰";
    const path = [];
    
    // Combine all matches from all tournaments into one list
    const allMatches = { 
        ...tournamentState.matches, 
        ...(tournamentState.autumnData?.allMatches || {}),
        ...(tournamentState.springData?.allMatches || {}) 
    };

    // Determine the current round number to analyze up to that point
    const idParts = startingMatchId.split('-');
    if (idParts.length < 3) return 'ï¼ˆåœ°åŒºäºˆé¸çªç ´ï¼‰'; // Not a main tournament match
    let currentRoundNum = parseInt(idParts[1].slice(1));

    // Loop from the first round up to the current round
    for (let r = 1; r < currentRoundNum; r++) {
        // Find the match the team won in that round
        const matchInRound = Object.values(allMatches).find(match =>
            match.id && 
            match.id.includes(`-R${r}-`) && // Belongs to the correct round
            match.winner === teamName
        );

        if (matchInRound) {
            const opponent = matchInRound.team1 === teamName ? matchInRound.team2 : matchInRound.team1;
            const winnerScore = matchInRound.team1 === teamName ? matchInRound.score1 : matchInRound.score2;
            const loserScore = matchInRound.team1 === teamName ? matchInRound.score2 : matchInRound.score1;
            path.push(`${r}å›æˆ¦ vs ${opponent} (${winnerScore}-${loserScore})`);
        }
    }

    return path.length > 0 ? path.join(' â†’ ') : 'ï¼ˆä»Šå¤§ä¼šåˆæˆ¦ï¼‰';
}
    /**
     * AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã«ã€ãƒãƒ¼ãƒ ã®æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹æƒ…å ±ã‚’ç”Ÿæˆã™ã‚‹
     */
    /**
 * Generates the next opponent info, compatible with all tournament structures.
 */
function getNextOpponentInfoForPrompt(teamName) {
    // Combine all matches from all tournaments into one list
    const allMatches = { 
        ...tournamentState.matches, 
        ...(tournamentState.autumnData?.allMatches || {}),
        ...(tournamentState.springData?.allMatches || {}) 
    };

    let latestMatch = null;
    let maxRound = -1;

    // Find the most recent game this team played in
    for (const matchId in allMatches) {
        const match = allMatches[matchId];
        if (match.team1 === teamName || match.team2 === teamName) {
            const roundNum = match.id.includes('-R') ? parseInt(match.id.split('-')[1].slice(1)) : 0;
            if (roundNum > maxRound) {
                maxRound = roundNum;
                latestMatch = match;
            }
        }
    }

    if (!latestMatch) return "ï¼ˆã¾ã è©¦åˆãªã—ï¼‰";
    if (latestMatch.winner !== teamName) return "ï¼ˆã“ã®è©¦åˆã§æ•—é€€ï¼‰";
    
    // Find the next game this team is in
    for (const matchId in allMatches) {
        const match = allMatches[matchId];
        
        // Look for a future game where this team is slotted but the opponent is not yet decided
        if ((match.team1 === teamName && !match.team2) || (match.team2 === teamName && !match.tran1)) {
             return "ï¼ˆæ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã¯æœªå®šï¼‰";
        }
        
        // Look for a future game where the opponent is known
        if (match.team1 === teamName && match.team2 && !match.winner) {
             return `æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã¯${match.team2}ã§ã™ã€‚`;
        }
        if (match.team2 === teamName && match.team1 && !match.winner) {
            return `æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã¯${match.team1}ã§ã™ã€‚`;
        }
    }

    return "ï¼ˆå„ªå‹ã€ã¾ãŸã¯æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸ï¼‰";
}
    /**
     * AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã«ã€æ²ç¤ºæ¿ã®ä¼šè©±å±¥æ­´ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹
     */
    function formatConversationHistory(comments, targetId) {
        let history = [];
        function findPath(currentComments, currentPath) {
            for(const comment of currentComments) {
                const newPath = [...currentPath, comment];
                if(comment.id === targetId) {
                    history = newPath;
                    return true;
                }
                if(comment.replies && findPath(comment.replies, newPath)) {
                    return true;
                }
            }
            return false;
        }
        findPath(comments, []);
        return history.map(c => `${c.personality}:ã€Œ${c.text}ã€`).join('\n');
    }

    /**
     * AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã«ã€ç¾åœ¨ã®å¤§ä¼šçŠ¶æ³ã®è¦ç´„ã‚’ç”Ÿæˆã™ã‚‹
     */
    function getTournamentStatusSummary() {
        if (tournamentState.currentTournament === 'autumn') {
            return `ç¾åœ¨ã€${tournamentState.tournamentYear}å¹´åº¦ ç§‹å­£å¤§ä¼šãŒé€²è¡Œä¸­ã§ã™ã€‚ãƒ•ã‚§ãƒ¼ã‚º: ${tournamentState.autumnPhase}`;
        }
        
        const finalMatch = tournamentState.matches['F-R1-M1'];
        if (finalMatch?.winner) return `${finalMatch.winner}ãŒå„ªå‹ã—ã¾ã—ãŸã€‚`;
        if (finalMatch?.team1 && finalMatch.team2) return `æ±ºå‹æˆ¦ã®çµ„ã¿åˆã‚ã›ã¯ ${finalMatch.team1} vs ${finalMatch.team2} ã§ã™ã€‚`;
        
        const numRounds = Math.log2(tournamentState.teams.length);
        for (let r = numRounds - 1; r >= 1; r--) {
            const roundIds = Object.keys(tournamentState.matches).filter(id => id.includes(`-R${r}-`));
            if (roundIds.some(id => tournamentState.matches[id]?.team1 && tournamentState.matches[id]?.team2)) {
                 const roundNameMap = { 5: "æº–æ±ºå‹", 4: "æº–ã€…æ±ºå‹", 3: "3å›æˆ¦", 2: "2å›æˆ¦", 1: "1å›æˆ¦"};
                 return `ç¾åœ¨ã€${roundNameMap[r] || r + 'å›æˆ¦'}ãŒé€²è¡Œä¸­ã§ã™ã€‚`;
            }
        }
        return 'å¤§ä¼šã¯ã¾ã‚‚ãªãé–‹å§‹ã•ã‚Œã¾ã™ã€‚';
    }

    /**
     * IDã‚’å…ƒã«ã€å…¥ã‚Œå­æ§‹é€ ã®ã‚³ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç‰¹å®šã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¤ã‘å‡ºã™
     */
    function findCommentById(comments, id) {
        for (const comment of comments) {
            if (comment.id === id) return comment;
            if (comment.replies && comment.replies.length > 0) {
                const found = findCommentById(comment.replies, id);
                if (found) return found;
            }
        }
        return null;
    }
/**
 * AIã«ç”²å­åœ’ï¼ˆã¾ãŸã¯æ±æµ·å¤§ä¼šï¼‰ã®çµæœã‚’ç·æ‹¬ã™ã‚‹è¨˜äº‹ã‚’ç”Ÿæˆã•ã›ã‚‹
 */
async function generateKoshienSummaryArticle(teamName, resultLabel, type) {
    let context, titleInstruction;

    if (type === 'summer') {
        context = `å¤ã®ç”²å­åœ’ã€å…¨å›½ã®é ‚ç‚¹ã‚’ç›®æŒ‡ã—ãŸ${teamName}ã®æˆ¦ã„ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚`;
        titleInstruction = `ã€Œ${teamName}ã€è–åœ°ã§ã®æˆ¦ã„ã®è»Œè·¡ã€ã®ã‚ˆã†ãªã€å¤ã®çµ‚ã‚ã‚Šã‚’æ„Ÿã˜ã•ã›ã‚‹æ„Ÿå‹•çš„ãªã‚¿ã‚¤ãƒˆãƒ«ã«ã—ã¦ãã ã•ã„ã€‚`;
    } else if (type === 'spring') {
        context = `é¸æŠœé«˜æ ¡é‡çƒå¤§ä¼šã«å‡ºå ´ã—ãŸ${teamName}ã®æœ€çµ‚çµæœãŒç¢ºå®šã—ã¾ã—ãŸã€‚`;
        titleInstruction = `ã€Œ${teamName}ã€æ˜¥ã®è–åœ°ã«çˆªç—•ã€ã®ã‚ˆã†ã«ã€æ¥ãŸã‚‹å¤ã¸ã®æœŸå¾…ã‚’æ„Ÿã˜ã•ã›ã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã«ã—ã¦ãã ã•ã„ã€‚`;
    } else { // tokai
        context = `ç§‹å­£æ±æµ·å¤§ä¼šã§ã€é™å²¡çœŒä»£è¡¨ã®${teamName}ãŒè¦‹äº‹ãªæˆ¦ã„ã‚’è¦‹ã›ã¾ã—ãŸã€‚`;
        titleInstruction = `ã€Œ${teamName}ã€ã‚»ãƒ³ãƒãƒ„å½“ç¢ºï¼ã€ã®ã‚ˆã†ã«ã€é€Ÿå ±ã‚‰ã—ãã€å–œã³ãŒä¼ã‚ã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã«ã—ã¦ãã ã•ã„ã€‚`;
    }

    const prompt = `ã‚ãªãŸã¯ã€æƒ…ç†±çš„ãªé«˜æ ¡é‡çƒå°‚é–€ã®AIè¨˜è€…ã§ã™ã€‚
ä»¥ä¸‹ã®æƒ…å ±ã«åŸºã¥ãã€èª­è€…ã®å¿ƒã‚’æ‰“ã¤ã‚ˆã†ãªç·æ‹¬è¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### å¤§ä¼šçµæœ
- ãƒãƒ¼ãƒ : ${teamName}
- æœ€çµ‚æˆç¸¾: ${resultLabel}
- æ–‡è„ˆ: ${context}

### åŸ·ç­†æŒ‡ç¤º
- ${titleInstruction}
- ãƒãƒ¼ãƒ ã®ã“ã‚Œã¾ã§ã®åŠªåŠ›ã‚„ã€çœŒå¤§ä¼šã§ã®æˆ¦ã„ã¶ã‚Šã‚’ç§°ãˆã€ä»Šå›ã®çµæœãŒæŒã¤æ„å‘³ã‚’ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«æå†™ã—ã¦ãã ã•ã„ã€‚
- æœ€å¾Œã«ã€é¸æ‰‹ãŸã¡ã¸ã®è³›è¾ã‚„ã€ä»Šå¾Œã®ãƒãƒ¼ãƒ ã¸ã®æœŸå¾…ã‚’è¿°ã¹ã¦ç· ã‚ããã£ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼
JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„: {"title": "è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«", "body": "è¨˜äº‹ã®æœ¬æ–‡"}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (article) return { ...article, timestamp: Date.now() };
        }
        throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã—ãŸå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    } catch (error) {
        console.error("AIç”²å­åœ’è¨˜äº‹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return { title: "è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼", body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", timestamp: Date.now(), error: true };
    }
}
// --- Match Processing & Event Listeners ---


/**
 * AIã«ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®çµ„ã¿åˆã‚ã›ã‹ã‚‰æ¶ç©ºã®å› ç¸ã‚’å‹•çš„ã«å‰µä½œã•ã›ã‚‹
 * @param {object} state - ç¾åœ¨ã® tournamentState
 * @returns {Promise<Array>} - AIãŒç”Ÿæˆã—ãŸå› ç¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
 */
async function generateDynamicFeuds(state) {
    const { matches, teams } = state;
    if (!matches || !teams) return [];

    // 1å›æˆ¦ã®çµ„ã¿åˆã‚ã›ã¨ã€å„ãƒãƒ¼ãƒ ã®è£œè¶³æƒ…å ±ï¼ˆç›£ç£ãƒ»ãƒ©ãƒ³ã‚¯ãƒ»æ˜¨å¹´ã®æˆç¸¾ï¼‰ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
    const round1Matchups = Object.values(matches).filter(m => m.id.includes('-R1-M'));
    const matchupInfo = round1Matchups.map(match => {
        const { team1, team2 } = match;
        if (!team1 || !team2) return null; // ãƒãƒ¼ãƒ ãŒæƒã£ã¦ã„ãªã„è©¦åˆã¯é™¤å¤–

        const team1Data = TEAM_DATA[team1];
        const team1Record = state.teamRecords[team1];
        const team1Info = `"${team1}" (ç›£ç£: ${team1Data?.coach?.name}, ãƒ©ãƒ³ã‚¯: ${calculateRank(team1, state)}, æ˜¨å¹´: ${getRankString(team1Record?.lastFinish || 64)})`;

        const team2Data = TEAM_DATA[team2];
        const team2Record = state.teamRecords[team2];
        const team2Info = `"${team2}" (ç›£ç£: ${team2Data?.coach?.name}, ãƒ©ãƒ³ã‚¯: ${calculateRank(team2, state)}, æ˜¨å¹´: ${getRankString(team2Record?.lastFinish || 64)})`;

        return `${team1Info} vs ${team2Info}`;
    }).filter(Boolean).join('\n'); // nullã‚’é™¤å¤–ã—ã€æ”¹è¡Œã§é€£çµ

    const prompt = `ã‚ãªãŸã¯ã€é™å²¡çœŒã®é«˜æ ¡é‡çƒã®æ­´å²ã‚’ã™ã¹ã¦çŸ¥ã‚‹ãƒ™ãƒ†ãƒ©ãƒ³ã®ã‚¹ãƒãƒ¼ãƒ„ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚
å¤ã®å¤§ä¼šã®1å›æˆ¦ã®çµ„ã¿åˆã‚ã›ãŒæ±ºå®šã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã¨è£œè¶³æƒ…å ±ï¼ˆç›£ç£ã€ãƒ©ãƒ³ã‚¯ã€æ˜¨å¹´ã®æˆç¸¾ï¼‰ã‚’ç†Ÿèª­ã—ã¦ãã ã•ã„ã€‚

### 1å›æˆ¦ çµ„ã¿åˆã‚ã›ãƒªã‚¹ãƒˆ
${matchupInfo}

### æŒ‡ç¤º
ä¸Šè¨˜ã®ãƒªã‚¹ãƒˆã‹ã‚‰ã€æœ€ã‚‚ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãªæ¶ç©ºã®å› ç¸ï¼ˆãƒ•ã‚§ã‚¤ã‚¯ãƒ»ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼‰ã‚’æŒã¤å¯¾æ±ºã‚’**3ã¤**å³é¸ã—ã€ãã®èƒŒæ™¯ã‚’å‰µä½œã—ã¦ãã ã•ã„ã€‚

### å› ç¸ã®å‰µä½œãƒ‘ã‚¿ãƒ¼ãƒ³ä¾‹
- **æ˜¨å¹´ã®ãƒªãƒ™ãƒ³ã‚¸ãƒãƒƒãƒ:** æ˜¨å¹´ã®å¤§ä¼šã§åŠ‡çš„ãªæ•—åŒ—ã‚’å–«ã—ãŸç›¸æ‰‹ã¨ã®å†æˆ¦ã€‚
- **ç›£ç£ã®å¸«å¼Ÿå¯¾æ±º:** ä¸¡ãƒãƒ¼ãƒ ã®ç›£ç£ãŒã€å®Ÿã¯å¤§å­¦æ™‚ä»£ã®å…ˆè¼©ã¨å¾Œè¼©ã ã£ãŸã€‚
- **å…ƒãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆå¯¾æ±º:** ä¸¡æ ¡ã®ã‚¨ãƒ¼ã‚¹ãŒã€ä¸­å­¦æ™‚ä»£ã¯åŒã˜ãƒãƒ¼ãƒ ã®ãƒãƒƒãƒ†ãƒªãƒ¼ã ã£ãŸã€‚
- **ç„¡åæ ¡ã®é›ªè¾±æˆ¦:** éå»ã«å¤§å·®ã§æ•—ã‚ŒãŸç›¸æ‰‹ã«ã€æˆé•·ã—ã¦å†ã³æŒ‘ã‚€ã€‚

### å‡ºåŠ›å½¢å¼ã€å³å®ˆã€‘
ä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼"ã®ã¿"ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚è§£èª¬ã‚„ã€Œã¯ã„ã€ãªã©ã®è¿”ç­”ã¯ä¸è¦ã§ã™ã€‚
[
  { "teams": ["ãƒãƒ¼ãƒ A", "ãƒãƒ¼ãƒ B"], "type": "å› ç¸ã®ã‚¿ã‚¤ãƒ—ï¼ˆä¾‹ï¼šå¸«å¼Ÿå¯¾æ±ºï¼‰", "story": "AIãŒå‰µä½œã—ãŸçŸ­ã„èƒŒæ™¯ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆä¾‹ï¼šã€‡ã€‡ç›£ç£ã¯â–³â–³ç›£ç£ã®å¤§å­¦æ™‚ä»£ã®å¾Œè¼©ã«ã‚ãŸã‚‹ï¼‰" },
  { "teams": ["ãƒãƒ¼ãƒ C", "ãƒãƒ¼ãƒ D"], "type": "æ˜¨å¤ã®é›ªè¾±æˆ¦", "story": "æ˜¨å¤ã€Cæ ¡ã¯Dæ ¡ã«9å›è£ã‚µãƒ¨ãƒŠãƒ©è² ã‘ã‚’å–«ã—ã¦ãŠã‚Šã€é¸æ‰‹ãŸã¡ã¯é›ªè¾±ã«ç‡ƒãˆã¦ã„ã‚‹" },
  { "teams": ["ãƒãƒ¼ãƒ E", "ãƒãƒ¼ãƒ F"], "type": "å…ƒãƒãƒƒãƒ†ãƒªãƒ¼å¯¾æ±º", "story": "Eæ ¡ã®ã‚¨ãƒ¼ã‚¹ã¨Fæ ¡ã®4ç•ªæ‰“è€…ã¯ã€ä¸­å­¦æ™‚ä»£ã«ãƒãƒƒãƒ†ãƒªãƒ¼ã‚’çµ„ã‚“ã§ã„ãŸè¦ªå‹åŒå£«ã " }
]`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const feudsJson = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (Array.isArray(feudsJson)) {
                return feudsJson; // æˆåŠŸï¼šå› ç¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã‚’è¿”ã™
            }
        }
        throw new Error("AI response format error.");
    } catch (error) {
        console.error("AIã«ã‚ˆã‚‹å‹•çš„å› ç¸ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return []; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºé…åˆ—ã‚’è¿”ã™
    }
}
/**
 * å»¶é•·ã‚¤ãƒ‹ãƒ³ã‚°ã‚’å…¨ã¦ã®é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ã™ã‚‹
 */
function addExtraInning() {
    // --- 1. ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–° ---
    const scoreTable = document.getElementById('inning-score-table');
    if (scoreTable) {
        const headerRow = scoreTable.querySelector('thead tr');
        // ç¾åœ¨ã®æœ€çµ‚ã‚¤ãƒ‹ãƒ³ã‚°ç•ªå·ã‚’å–å¾—ã—ã€1ã‚’è¶³ã™
        const lastInningHeader = headerRow.children[headerRow.children.length - 3];
        const newInningNum = parseInt(lastInningHeader.textContent) + 1;

        // æ–°ã—ã„ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
        const newTh = document.createElement('th');
        newTh.className = 'w-10';
        newTh.textContent = newInningNum;
        headerRow.insertBefore(newTh, headerRow.children[headerRow.children.length - 2]);

        // å„ãƒãƒ¼ãƒ ã®è¡Œã«æ–°ã—ã„å…¥åŠ›æ¬„ã‚’è¿½åŠ 
        scoreTable.querySelectorAll('tbody tr').forEach(row => {
            const newTd = document.createElement('td');
            newTd.innerHTML = `<input type="text" value="">`;
            row.insertBefore(newTd, row.children[row.children.length - 1]);
        });
    }

    // --- 2. ä¸¡ãƒãƒ¼ãƒ ã®æ‰“æ’ƒæˆç¸¾ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–° ---
    for (const teamKey of ['team1', 'team2']) {
        const battingTable = document.getElementById(`batting-table-${teamKey}`);
        if (!battingTable) continue;

        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ›´æ–°
        const headerRow = battingTable.querySelector('thead tr');
        const lastInningHeader = headerRow.lastElementChild.previousElementSibling;
        const newInningNum = parseInt(lastInningHeader.textContent) + 1;
        const newTh = document.createElement('th');
        newTh.className = 'col-inning';
        newTh.textContent = newInningNum;
        headerRow.insertBefore(newTh, headerRow.lastElementChild);

        // å…¨ã¦ã®é¸æ‰‹è¡Œï¼ˆã‚¹ã‚¿ãƒ¡ãƒ³ãƒ»äº¤ä»£ï¼‰ã«æ–°ã—ã„å…¥åŠ›æ¬„ã‚’è¿½åŠ 
        battingTable.querySelectorAll('tbody tr').forEach(row => {
            const newTd = document.createElement('td');
            newTd.innerHTML = `<input type="text" placeholder="-">`;
            row.appendChild(newTd);
        });

        // ã‚¤ãƒ‹ãƒ³ã‚°å‡ºæ¥äº‹å…¥åŠ›æ¬„ã®colspanã‚’æ›´æ–°ã—ã€æ–°ã—ã„å…¥åŠ›æ¬„ã‚’è¿½åŠ 
        const tfoot = battingTable.querySelector('tfoot');
        if (tfoot) {
            const targetCell = tfoot.querySelector('td[colspan]');
            const currentNumInnings = parseInt(targetCell.getAttribute('colspan')) - 1;
            targetCell.setAttribute('colspan', currentNumInnings + 2);

            const newEventTd = document.createElement('td');
            newEventTd.className = 'border-t-2';
            newEventTd.innerHTML = `<input type="text" class="inning-events-input w-full text-left px-1 text-xs" data-team-key="${teamKey}" data-inning-index="${newInningNum - 1}" placeholder="ä¾‹: éˆ´æœ¨ ç›—å¡">`;
            
            const eventRow = tfoot.querySelector('tr');
            eventRow.insertBefore(newEventTd, eventRow.lastElementChild);
        }
    }
}

/**
 * ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
 */
function updateTicker() {
    const tickerContainer = document.querySelector('.ticker-content');
    const oldTickerText = document.getElementById('ticker-text');
    if (!tickerContainer || !oldTickerText) return;

    let headlines = tournamentState.tickerHeadlines || [];
    
    // è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ãŒãªã‘ã‚Œã°ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚‚ã®ã‚’è¡¨ç¤º
    if (headlines.length === 0) {
        const defaultHeadlines = [
            "æ˜¨å¹´åº¦ç‹è€…ãƒ»283å­¦åœ’ã€çœŒå†…é€£è¦‡ã¨ã€Œå…¨å›½ã§ã®ä¸€å‹ã€ã¸è¦–ç•Œè‰¯å¥½ã‹",
            "ã€å…¬ç«‹æœ€å¾Œã®ç ¦ã€é™å²¡ã€åé–€å¾©æ´»ã¸ã€ä»Šå¹´ã“ãã€",
            "ãƒ—ãƒ­æ³¨ç›®158kmå³è…•ãƒ»æ–è—¤æ“ã™ã‚‹å¯Œå£«å®®åŒ—ã€ãƒ¯ãƒ³ãƒãƒ³ãƒãƒ¼ãƒ ã®æ±šåè¿”ä¸Šãªã‚‹ã‹",
            "å‰µéƒ¨ä¸€å¹´ç›®ãƒ»æµœæ¾ç‰¹æ”¯ã€åˆã‚ã¦ã®å¤ã€‚ã€Œã¾ãšã¯1ç‚¹ã€ã‚’åˆè¨€è‘‰ã«æŒ‘ã‚€",
            "é›¢å³¶ã®ãƒãƒ³ãƒ‡ã‚’è¦†ã›ï¼è™åºœå³¶ç·åˆã€é€†å¢ƒã‚¹ãƒ”ãƒªãƒƒãƒ„ã§æœ¬åœŸå‹¢ã«æŒ‘ã‚€",
            "765ç·åˆé«˜æ ¡ã€2å¹´å‰ã®æ „å…‰å†ã³ã€‚ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã‹ã‚‰ã®é€†è¥²ãªã‚‹ã‹",
            "æœ€å¾Œã®å¤ãƒ»å·æ ¹ã€é–‰æ ¡ã™ã‚‹æ¯æ ¡ã®åã‚’åˆ»ã‚ã‚‹ã‹",
            "ã€ãƒ™ã‚¹ãƒˆ8ã®å£ã€ã¯è¶Šãˆã‚‰ã‚Œã‚‹ã‹ã€‚å …å®ˆã®è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã€æ‰“ç·šã®ä»•ä¸ŠãŒã‚Šã¯"
        ];
        headlines = new Array(5).fill(defaultHeadlines).flat().sort(() => Math.random() - 0.5);
    }

    const newTextContent = headlines.join('ã€€ï¼ï¼ã€€');
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãŸã‚ã«è¦ç´ ã‚’å†ç”Ÿæˆ
    const newTickerText = oldTickerText.cloneNode(false);
    newTickerText.textContent = newTextContent;
    oldTickerText.remove();
    tickerContainer.appendChild(newTickerText);
}

/**
 * è©¦åˆçµæœã‹ã‚‰ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚«ãƒ¼ç”¨ã®çŸ­ã„ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã‚’ç”Ÿæˆã™ã‚‹
 * @param {object} matchData - è©¦åˆã®ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {string | null} - ç”Ÿæˆã•ã‚ŒãŸãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã®æ–‡å­—åˆ—ã€ã¾ãŸã¯null
 */
function generateTickerHeadline(matchData) {
    const { winnerName, loserName, score1, score2 } = matchData;
    const winnerScore = Math.max(parseInt(score1), parseInt(score2));
    const loserScore = Math.min(parseInt(score1), parseInt(score2));
    const scoreDiff = winnerScore - loserScore;

    const winnerRank = calculateRank(winnerName, tournamentState);
    const loserRank = calculateRank(loserName, tournamentState);
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
    const rankDiff = rankValues[winnerRank] - rankValues[loserRank];

    // ãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼šå¤§ç•ªç‹‚ã‚ã›ï¼ˆã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒªãƒ³ã‚°ï¼‰
    if (rankDiff <= -2) {
        return `ã€æ³¢ä¹±ã€‘${getRankDescription(loserRank)}ãƒ»${loserName}ãŒåˆæˆ¦ã§æ•£ã‚‹ï¼ ${winnerName}ãŒé‡‘æ˜ŸæŒ™ã’ã‚‹`;
    }
    // ãƒ‘ã‚¿ãƒ¼ãƒ³2ï¼šæ¥æˆ¦
    if (scoreDiff <= 2 && rankDiff <= 1 && rankDiff >= -1) {
        return `æ‰‹ã«æ±—æ¡ã‚‹æ¥æˆ¦ï¼ ${winnerName}ãŒ${loserName}ã‚’${winnerScore}-${loserScore}ã§æŒ¯ã‚Šåˆ‡ã‚‹`;
    }
    // ãƒ‘ã‚¿ãƒ¼ãƒ³3ï¼šåœ§å‹
    if (scoreDiff >= 8 && rankDiff >= 2) {
        return `ç‹è€…ãƒ»${winnerName}ã€ç›¤çŸ³ã®è©¦åˆé‹ã³ã§${loserName}ã‚’åœ§å€’ã€‚${winnerScore}å¯¾${loserScore}ã§ã‚³ãƒ¼ãƒ«ãƒ‰å‹ã¡ç´šã®å¿«å‹`;
    }
    // ãƒ‘ã‚¿ãƒ¼ãƒ³4ï¼šãƒ©ã‚¤ãƒãƒ«å¯¾æ±º
    const rivalry = RIVALRIES.find(r => r.teams.includes(winnerName) && r.teams.includes(loserName));
    if (rivalry) {
        return `å› ç¸ã®${rivalry.type}ã¯${winnerName}ã«è»é…ï¼ ${loserName}ã‚’ä¸‹ã™`;
    }
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    return `${winnerName}ãŒ${loserName}ã‚’ä¸‹ã—ã€æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸é§’ã‚’é€²ã‚ã‚‹`;
}

/**
 * è©¦åˆã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€Œäº‹å®Ÿã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã€ã¨æ´»èºé¸æ‰‹ãƒªã‚¹ãƒˆã‚’è¿”ã™
 * (â˜…ç²¾å¯†ç‰ˆÎ±ï¼šæ‰“é †è¿½è·¡ã€æ–¹å‘ã€äº¤ä»£è©³ç´°ã€èµ°å¡ã‚¢ã‚¦ãƒˆè©³ç´°ã€äº¤ä»£çŠ¶æ³åˆ†æ ã™ã¹ã¦è¾¼ã¿â˜…)
 */
function createHighlightsText(dbMatch, winnerName) {
    // è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºã‚’è¿”ã™
    if (!dbMatch || !dbMatch.details) {
        return { highlights: [], keyPlayerNames: [] };
    }

 // --- å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼šæ‰“å¸­çµæœã‚’æ—¥æœ¬èªã«ç¿»è¨³ (â˜…ã€Œæ³¨ç›®ã€ãƒ•ãƒ©ã‚°å¯¾å¿œ æœ€çµ‚ç‰ˆ) ---
    const translateResult = (res, playerInfo, eventType = '') => {
        if (!res) return null;
        let tempRes = res.trim();

        // 1. æ³¨ç›®ãƒ•ãƒ©ã‚°ã‚’ãƒ‘ãƒ¼ã‚¹
        let markPrefix = ''; // æ³¨ç›®ï¼ˆç¿»è¨³å¾Œï¼‰
        if (tempRes.startsWith('â˜…:')) {
            markPrefix = 'ï¼ˆâ˜…æ³¨ç›®ï¼‰';
            tempRes = tempRes.substring(3); // "â˜…:" ã‚’å‰Šé™¤
        }

        // 2. å‹¢ã„(Strength)ã‚’ãƒ‘ãƒ¼ã‚¹
        let strengthPrefix = '';
        let strengthPrefixOut = '';
        if (tempRes.startsWith('S:')) {
            strengthPrefix = 'é‹­ã„';
            strengthPrefixOut = 'é‹­ã„å½“ãŸã‚Šã®';
            tempRes = tempRes.substring(2); // "S:" ã‚’å‰Šé™¤
        } else if (tempRes.startsWith('W:')) {
            strengthPrefix = 'è©°ã¾ã‚ŠãªãŒã‚‰ã‚‚';
            strengthPrefixOut = 'è©°ã¾ã£ãŸå½“ãŸã‚Šã®';
            tempRes = tempRes.substring(2); // "W:" ã‚’å‰Šé™¤
        }

        // 3. æ–¹å‘ã‚’ãƒ‘ãƒ¼ã‚¹
        let direction = '';
        const directionMap = {'æŠ•': 'ãƒ”ãƒƒãƒãƒ£ãƒ¼', 'æ•': 'ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼', 'ä¸€': 'ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ', 'äºŒ': 'ã‚»ã‚«ãƒ³ãƒ‰', 'ä¸‰': 'ã‚µãƒ¼ãƒ‰', 'éŠ': 'ã‚·ãƒ§ãƒ¼ãƒˆ', 'å·¦': 'ãƒ¬ãƒ•ãƒˆ', 'ä¸­': 'ã‚»ãƒ³ã‚¿ãƒ¼', 'å³': 'ãƒ©ã‚¤ãƒˆ'};
        const directionKeys = Object.keys(directionMap);
        for (const key of directionKeys) {
            if (tempRes.startsWith(key)) {
                direction = directionMap[key] + 'ã¸';
                if (tempRes.includes('ã‚´ãƒ­') || tempRes.includes('é£›') || tempRes.includes('é‚ª') || tempRes.includes('ç›´')) {
                    direction = directionMap[key];
                }
                tempRes = tempRes.substring(key.length).trim();
                break;
            }
        }

        // 4. æ‰“ç‚¹ã¨ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—
        let description = `${playerInfo}ãŒ`; // åŸºæœ¬ã®ä¸»èª
        const rbiMatch = tempRes.match(/(\d+)ç‚¹/);
        const eventText = eventType ? `${eventType}ã¨ãªã‚‹` : '';

        // 5. çµæœã®ç¿»è¨³ (â˜…markPrefixã‚’å…¨ã¦ã«è¿½åŠ )
        if (tempRes.includes('æœ¬å¡æ‰“')) {
            let hrRbiText = 'ã‚½ãƒ­';
            if (rbiMatch) {
                const rbi = parseInt(rbiMatch[1]);
                if (rbi === 4) hrRbiText = 'æº€å¡';
                else if (rbi === 3) hrRbiText = '3ãƒ©ãƒ³';
                else if (rbi === 2) hrRbiText = '2ãƒ©ãƒ³';
            }
            description = `${playerInfo}ãŒ${markPrefix}${strengthPrefix ? strengthPrefix + ' ' : ''}${direction ? direction + 'ã¸ã®' : ''}${eventText}${hrRbiText}ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³ã‚’æ”¾ã£ãŸ`;
        
        } else {
            // æœ¬å¡æ‰“ä»¥å¤–
            const rbiText = rbiMatch ? (parseInt(rbiMatch[1]) > 1 ? `${rbiMatch[1]}ç‚¹ã‚¿ã‚¤ãƒ ãƒªãƒ¼` : 'ã‚¿ã‚¤ãƒ ãƒªãƒ¼') : '';

            if (tempRes.includes('ä¸‰å¡æ‰“')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefix ? strengthPrefix + ' ' : ''}${direction ? direction + 'ã¸ã®' : ''}${eventText}${rbiText}ä¸‰å¡æ‰“ã‚’æ”¾ã£ãŸ`;
            else if (tempRes.includes('äºŒå¡æ‰“')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefix ? strengthPrefix + ' ' : ''}${direction ? direction + 'ã¸ã®' : ''}${eventText}${rbiText}äºŒå¡æ‰“ã‚’æ”¾ã£ãŸ`;
            else if (tempRes.includes('å®‰')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefix ? strengthPrefix + ' ' : ''}${direction ? direction + 'ã¸ã®' : ''}${eventText}${rbiText}ãƒ’ãƒƒãƒˆã‚’æ”¾ã£ãŸ`;
            
            else if (tempRes.includes('çŠ é£›')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å¤–é‡'}ã¸ã®${eventText}çŠ ç‰²ãƒ•ãƒ©ã‚¤${rbiMatch ? `ã§${rbiMatch[1]}ç‚¹` : 'ã§1ç‚¹'}ã‚’æŒ™ã’ãŸ`;
            else if (tempRes.includes('çŠ æ‰“')) description = `${playerInfo}ãŒ${markPrefix}${direction ? direction + 'ã¸' : ''}é€ã‚Šãƒãƒ³ãƒˆã‚’æ±ºã‚ãŸ`;
            
            else if (tempRes.includes('ã‚´ãƒ­') && rbiMatch) description = `${playerInfo}ã®${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å†…é‡'}ã‚´ãƒ­ã®é–“ã«${eventText}${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
            else if ((tempRes.includes('ã‚¨ãƒ©ãƒ¼') || tempRes.includes('å¤±')) && rbiMatch) description = `${playerInfo}ãŒ${markPrefix}ç›¸æ‰‹${direction ? direction + 'ã®' : ''}ã‚¨ãƒ©ãƒ¼ã®é–“ã«${eventText}${rbiMatch[1]}ç‚¹ã‚’è¨˜éŒ²ã—ãŸ`;
            
            else if (tempRes.includes('å››çƒ')) {
                if (rbiMatch) description = `${playerInfo}ãŒ${markPrefix}${eventText}æŠ¼ã—å‡ºã—ã®å››çƒã‚’é¸ã³ã€${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
                else description = `${playerInfo}ãŒ${markPrefix}å››çƒã‚’é¸ã‚“ã `;
            }
            else if (tempRes.includes('æ­»çƒ')) {
                if (rbiMatch) description = `${playerInfo}ãŒ${markPrefix}${eventText}æŠ¼ã—å‡ºã—ã®æ­»çƒã‚’å—ã‘ã€${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
                else description = `${playerInfo}ãŒ${markPrefix}æ­»çƒã§å‡ºå¡ã—ãŸ`;
            }


// â–¼â–¼â–¼ ã“ã® else if ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
        else if (tempRes.includes('æ•¬é ')) {
            if (rbiMatch) {
                // æº€å¡ã§ã®æ•¬é ï¼ˆæŠ¼ã—å‡ºã—ï¼‰
                description = `${playerInfo}ãŒ${markPrefix}${eventText}æŠ¼ã—å‡ºã—ã®æ•¬é å››çƒã‚’é¸ã³ã€${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
            } else {
                // é€šå¸¸ã®æ•¬é 
                description = `${playerInfo}ãŒ${markPrefix}${eventText}æ•¬é å››çƒã§å‡ºå¡ã—ãŸ`;
            }
        }
        // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
            
            else if (tempRes.includes('ä¸‰æŒ¯')) description = `${playerInfo}ãŒ${markPrefix}ä¸‰æŒ¯ã«å€’ã‚ŒãŸ`;
            else if (tempRes.includes('ä½µæ®º')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å†…é‡'}ã‚´ãƒ­ã§ä½µæ®ºæ‰“ã«å€’ã‚ŒãŸ`;
            else if (tempRes.includes('é‚ª')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'ãƒ•ã‚¡ã‚¦ãƒ«ã‚¾ãƒ¼ãƒ³'}ã¸ã®é‚ªé£›ï¼ˆãƒ•ã‚¡ã‚¦ãƒ«ãƒ•ãƒ©ã‚¤ï¼‰ã«å€’ã‚ŒãŸ`;
            else if (tempRes.includes('ã‚´ãƒ­')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å†…é‡'}ã‚´ãƒ­ã«å€’ã‚ŒãŸ`;
            else if (tempRes.includes('é£›')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å¤–é‡'}ãƒ•ãƒ©ã‚¤ã«å€’ã‚ŒãŸ`;
            else if (tempRes.includes('ç›´')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || ''}ãƒ©ã‚¤ãƒŠãƒ¼ã«å€’ã‚ŒãŸ`;
            
            else if (tempRes.includes('ã‚¨ãƒ©ãƒ¼') || tempRes.includes('çŠ å¤±')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}ç›¸æ‰‹${direction ? direction + 'ã®' : ''}ã‚¨ãƒ©ãƒ¼ã§å‡ºå¡ã—ãŸ`;
            else if (tempRes.includes('é‡é¸')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction ? direction + 'ã¸ã®' : ''}é‡é¸ã§å‡ºå¡ã—ãŸ`;
            else return null;
        }

        // 6. æœ€çµ‚èª¿æ•´
        return description.replace(/ã‚¿ã‚¤ãƒ ãƒªãƒ¼1ç‚¹/g, 'ã‚¿ã‚¤ãƒ ãƒªãƒ¼').replace(/1ç‚¹ã‚’æŒ™ã’ãŸ/g, 'ç‚¹ã‚’æŒ™ã’ãŸ');
    };
    // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã“ã“ã¾ã§ ---

    // --- åˆæœŸåŒ– ---
    const highlights = []; // ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒªã‚¹ãƒˆ
    const keyPlayerNames = new Set(); // æ´»èºé¸æ‰‹å
    const winningTeamKey = dbMatch.team1 === winnerName ? 'team1' : 'team2';
    const losingTeamKey = winningTeamKey === 'team1' ? 'team2' : 'team1';
    const numInnings = dbMatch.details.inningScore?.team1?.length || 9;
    const inningScores = dbMatch.details.inningScore || { team1: Array(numInnings).fill(0), team2: Array(numInnings).fill(0) }; // ã‚¹ã‚³ã‚¢å–å¾—ã€ãªã‘ã‚Œã°0åŸ‹ã‚

    let hasScored = false;
    let isReversed = false;
    let cumulativeScores = { team1: 0, team2: 0 };
    // â–¼â–¼â–¼ batterIndices: ã‚¤ãƒ‹ãƒ³ã‚°é–‹å§‹æ™‚ã®å…ˆé ­æ‰“è€…ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ â–¼â–¼â–¼
    let batterIndices = { team1: 0, team2: 0 };
        
    // --- 1. ã‚¤ãƒ‹ãƒ³ã‚°ã”ã¨ã®ãƒ—ãƒ¬ãƒ¼ã‚’ã€ç²¾å¯†ãªæ‰“é †ã§è§£æ ---
    for (let i = 0; i < numInnings; i++) {
        const currentInning = i + 1;
        const scoreBeforeInning = { ...cumulativeScores };

        for (const teamKey of ['team1', 'team2']) {
            const teamName = dbMatch[teamKey];
            const opponentTeamKey = teamKey === 'team1' ? 'team2' : 'team1';
            const allBattingData = dbMatch.details.batting?.[teamKey] || [];
            if (allBattingData.length === 0) continue;

            // æ‰“é †ã§ã‚½ãƒ¼ãƒˆ (ã‚¹ã‚¿ãƒ¡ãƒ³/äº¤ä»£å«ã‚€)
            const sortedBattingOrder = allBattingData
                .filter(p => p.name) // åå‰ãŒã‚ã‚‹é¸æ‰‹ã®ã¿
                .sort((a,b) => parseFloat(a.order.replace('-sub','.')) - parseFloat(b.order.replace('-sub','.')));
            if (sortedBattingOrder.length === 0) continue;

            // A. ã“ã®ã‚¤ãƒ‹ãƒ³ã‚°ã®å…¨ãƒ—ãƒ¬ãƒ¼ã‚’åé›† (å¤‰æ›´ãªã—)
            let playsInHalfInning = [];
            sortedBattingOrder.forEach(player => {
                const resultString = player.results?.[i];
                if (resultString) {
                    resultString.split('ã€').forEach(atBatString => {
                        if(atBatString) {
                            playsInHalfInning.push({ player, atBatString });
                        }
                    });
                }
            });
            if (playsInHalfInning.length === 0) continue;

            // B. æ‰“é †ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«åŸºã¥ãã€ãƒ—ãƒ¬ãƒ¼ã‚’æ™‚ç³»åˆ—é †ã«ä¸¦ã¹æ›¿ãˆã‚‹ (æ”¹å–„ç‰ˆ)
            const startingBatterIndex = batterIndices[teamKey]; // ã“ã®ã‚¤ãƒ‹ãƒ³ã‚°ã®å…ˆé ­æ‰“è€…
            const orderedPlays = []; // ä¸¦ã¹æ›¿ãˆãŸçµæœã‚’å…¥ã‚Œã‚‹é…åˆ—
            let currentBatterIndex = startingBatterIndex; // ç¾åœ¨å‡¦ç†ä¸­ã®æ‰“è€…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            let playsFoundCount = 0; // è¦‹ã¤ã‹ã£ãŸãƒ—ãƒ¬ãƒ¼æ•° (ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢)
            const atBatsCountPerPlayer = {}; // å„é¸æ‰‹ã®ã“ã®ã‚¤ãƒ‹ãƒ³ã‚°ã§ã®æ‰“å¸­æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ { "1": 0, "2": 1, ... }

            // playsInHalfInning ã®ã™ã¹ã¦ã®ãƒ—ãƒ¬ãƒ¼ãŒ orderedPlays ã«å…¥ã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—
            while (orderedPlays.length < playsInHalfInning.length && playsFoundCount < playsInHalfInning.length * 2) {
                 const currentPlayer = sortedBattingOrder[currentBatterIndex]; // ç¾åœ¨æ³¨ç›®ã—ã¦ã„ã‚‹æ‰“è€…
                 const playerOrderKey = currentPlayer.order; // "1", "1-sub-1" ãªã©
                 const currentAtBatOrdinal = atBatsCountPerPlayer[playerOrderKey] || 0; // ã“ã®æ‰“è€…ã®ä½•æ‰“å¸­ç›®ã‹ (0å§‹ã¾ã‚Š)

                 // playsInHalfInning ã‹ã‚‰ã€ç¾åœ¨ã®æ‰“è€…(currentPlayer)ã®ã€ã¾ã å‡¦ç†ã—ã¦ã„ãªã„(currentAtBatOrdinalç•ªç›®ã®)æ‰“å¸­çµæœã‚’æ¢ã™
                 let foundPlayIndex = -1;
                 let searchCount = 0;
                 for(let k=0; k < playsInHalfInning.length; k++){
                     if(playsInHalfInning[k].player.order === playerOrderKey) {
                         if(searchCount === currentAtBatOrdinal) {
                             // ã¾ã  orderedPlays ã«è¿½åŠ ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
                             if (!orderedPlays.includes(playsInHalfInning[k])) {
                                 foundPlayIndex = k;
                                 break;
                             }
                         }
                         searchCount++;
                     }
                 }


                 if (foundPlayIndex !== -1) {
                     const foundPlay = playsInHalfInning[foundPlayIndex];
                     orderedPlays.push(foundPlay); // é †ç•ªé€šã‚Šã«è¿½åŠ 
                     atBatsCountPerPlayer[playerOrderKey] = currentAtBatOrdinal + 1; // ã“ã®æ‰“è€…ã®æ‰“å¸­æ•°ã‚’+1
                     // æ¬¡ã®æ‰“è€…ã¸ (æ‰“é †ãŒä¸€å·¡ã™ã‚‹å ´åˆã‚‚è€ƒæ…®)
                     currentBatterIndex = (currentBatterIndex + 1) % sortedBattingOrder.length;
                 } else {
                     // ç¾åœ¨ã®æ‰“è€…ã®æ¬¡ã®æ‰“å¸­ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æ¬¡ã®æ‰“é †ã®é¸æ‰‹ã¸ç§»ã‚‹
                     // (ä¾‹: 1ç•ªæ‰“è€…ãŒ1æ‰“å¸­ã—ã‹ãªã‹ã£ãŸå ´åˆãªã©)
                     currentBatterIndex = (currentBatterIndex + 1) % sortedBattingOrder.length;
                 }
                 playsFoundCount++; // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
            }
            // ä¸¦ã³æ›¿ãˆã«å¤±æ•—ã—ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (å…ƒã®é †ã§å‡¦ç†) - å¿µã®ãŸã‚æ®‹ã™
            const finalOrderedPlays = orderedPlays.length === playsInHalfInning.length ? orderedPlays : playsInHalfInning;


            // C. ä¸¦ã¹æ›¿ãˆãŸæ­£ã—ã„é †åºã§ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ç”Ÿæˆã™ã‚‹ (å¤‰æ›´ãªã—)            // C. ä¸¦ã¹æ›¿ãˆãŸæ­£ã—ã„é †åºã§ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ç”Ÿæˆã™ã‚‹
            finalOrderedPlays.forEach(play => {
                const { player, atBatString } = play;
                const [batterPlay, runnerPlaysString] = atBatString.split(';'); // æ‰“æ’ƒçµæœã¨èµ°å¡çµæœã‚’åˆ†é›¢

                // äº¤ä»£é¸æ‰‹æƒ…å ±ã‚’playerInfoã«ä»˜ä¸
                let playerRole = '';
                if (player.order.includes('sub')) {
                    switch(player.sub_type) {
                        case 'PH': playerRole = 'ä»£æ‰“ã®'; break;
                        case 'PR': playerRole = 'ä»£èµ°ã®'; break; // ä»£èµ°ã¯é€šå¸¸æ‰“å¸­ã«ç«‹ãŸãªã„ãŒå¿µã®ãŸã‚
                        case 'DEF': playerRole = 'å®ˆå‚™ã‹ã‚‰é€”ä¸­å‡ºå ´ã®'; break; // å®ˆå‚™äº¤ä»£é¸æ‰‹ãŒæ‰“å¸­ã«ç«‹ã£ãŸå ´åˆ
                        case 'PITCHER': playerRole = 'ãƒªãƒªãƒ¼ãƒ•ã®'; break; // æŠ•æ‰‹ãŒæ‰“å¸­ã«ç«‹ã£ãŸå ´åˆ
                        default: playerRole = 'é€”ä¸­å‡ºå ´ã®';
                    }
                } else {
                     playerRole = `${player.order}ç•ª`; // ã‚¹ã‚¿ãƒ¡ãƒ³
                }
                const playerInfo = `${playerRole}${player.name}`;

                // æ‰“æ’ƒçµæœã®å‡¦ç†
                if (batterPlay && batterPlay.trim() !== '') {
                    let eventType = ''; // ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ— (å…ˆåˆ¶ã€é€†è»¢ãªã©)
                    const isScorePlay = batterPlay.includes('ç‚¹') || batterPlay.toLowerCase().includes('hr') || batterPlay.includes('æœ¬');

                    // å¾—ç‚¹ãƒ—ãƒ¬ãƒ¼ã®å ´åˆã€ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š
                    if (isScorePlay) {
                        const prevScoreSelf = scoreBeforeInning[teamKey];
                        const prevScoreOpp = scoreBeforeInning[opponentTeamKey];
                        const rbiMatch = batterPlay.match(/(\d+)ç‚¹/);
                        let addedScore = rbiMatch ? parseInt(rbiMatch[1]) : (batterPlay.includes('ç‚¹') ? 1 : 0);
                        if (batterPlay.includes('æœ¬')) addedScore = Math.max(1, addedScore);

                        if (prevScoreSelf === 0 && prevScoreOpp === 0) {
                            eventType = 'å…ˆåˆ¶'; // ä¸¡è€…0ç‚¹ã‹ã‚‰ã®åˆå¾—ç‚¹
                            hasScored = true;
                        } else if (prevScoreSelf <= prevScoreOpp && (prevScoreSelf + addedScore) > prevScoreOpp && !isReversed) {
                            // ãƒ“ãƒã‚¤ãƒ³ãƒ‰/åŒç‚¹ã‹ã‚‰ãƒªãƒ¼ãƒ‰ã—ãŸå ´åˆ (é€†è»¢ãƒ•ãƒ©ã‚°ã¯ä¸€åº¦ã ã‘)
                            eventType = 'é€†è»¢';
                            isReversed = true;
                        } else if (prevScoreSelf < prevScoreOpp && (prevScoreSelf + addedScore) === prevScoreOpp) {
                             eventType = 'åŒç‚¹'; // è¿½ã„ã¤ã„ãŸå ´åˆ
                        } else if (prevScoreSelf >= prevScoreOpp) {
                             eventType = 'è¿½åŠ ç‚¹'; // ãƒªãƒ¼ãƒ‰ã‚’åºƒã’ã‚‹å ´åˆ
                        } else {
                             eventType = 'åæ’ƒ'; // ãƒ“ãƒã‚¤ãƒ³ãƒ‰ã§ç‚¹ã‚’è¿”ã—ãŸå ´åˆ
                        }
                    }

                    // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§èª¬æ˜æ–‡ç”Ÿæˆ
                    const description = translateResult(batterPlay, playerInfo, eventType);
                    if (description) {
                        highlights.push({ inning: currentInning, team: teamName, player: player.name, description });
                        keyPlayerNames.add(player.name);
                    }
                }

                // èµ°å¡çµæœã®å‡¦ç† (è©³ç´°ãªã‚¢ã‚¦ãƒˆç¨®é¡å¯¾å¿œ)
                if (runnerPlaysString) {
                    runnerPlaysString.split(',').forEach(runnerPlay => {
                        if (!runnerPlay) return;
                        const runnerPlayParts = runnerPlay.trim().split(' ');
                        if (runnerPlayParts.length < 2) return;
                        const runnerName = runnerPlayParts[0];
                        const play = runnerPlayParts[1]; // ä¾‹: "ç›—å¡", "ç›—å¡æ­»", "é€²å¡"
                        const detail = runnerPlayParts.slice(2).join(' ') || ''; // ä¾‹: "äºŒå¡ã¸", "ç”Ÿé‚„"
                        let description = `${runnerName}ãŒ`;

                        if (play === 'ç›—å¡') description += `ç›—å¡æˆåŠŸï¼ˆ${detail}ï¼‰`;
                        else if (play === 'ã‚¿ãƒƒãƒã‚¢ãƒƒãƒ—') description += `ã‚¿ãƒƒãƒã‚¢ãƒƒãƒ—ã‹ã‚‰${detail}`;
                        else if (play === 'ç”Ÿé‚„' || (play === 'é€²å¡' && detail.includes('ç”Ÿé‚„'))) description += `ãƒ›ãƒ¼ãƒ ã‚¤ãƒ³`;
                        else if (play === 'ç›—å¡æ­»') description += `ç›—å¡å¤±æ•—`;
                        else if (play === 'ç‰½åˆ¶æ­»') description += `ç‰½åˆ¶ã‚¢ã‚¦ãƒˆ`;
                        else if (play === 'èµ°å¡æ­»') description += `èµ°å¡æ­»`;
                        else if (play === 'æŒŸæ®ºãƒ—ãƒ¬ãƒ¼ã§ã‚¢ã‚¦ãƒˆ') description += `æŒŸæ®ºã‚¢ã‚¦ãƒˆ`;
                        else if (play.includes('ã‚¢ã‚¦ãƒˆ')) description += `èµ°å¡ä¸­ã«ã‚¢ã‚¦ãƒˆ`;
                        else if (play === 'é€²å¡') description += `é€²å¡ã—ã¦${detail}`;
                        else description += `${play} ${detail}`.trim();

                        highlights.push({ type: 'baserunning', inning: currentInning, team: teamName, player: runnerName, description: description });
                        keyPlayerNames.add(runnerName);
                    });
                }
            }); // finalOrderedPlays.forEach ã®çµ‚ã‚ã‚Š

           // â–¼â–¼â–¼ D. æ¬¡ã®ã‚¤ãƒ‹ãƒ³ã‚°ã®å…ˆé ­æ‰“è€…ã‚’æ­£ç¢ºã«æ›´æ–° â–¼â–¼â–¼
            if (finalOrderedPlays.length > 0) {
                 // ã“ã®ã‚¤ãƒ‹ãƒ³ã‚°ã§æœ€å¾Œã«æ‰“å¸­ã«ç«‹ã£ãŸé¸æ‰‹ã‚’å–å¾—
                 const lastPlayer = finalOrderedPlays[finalOrderedPlays.length - 1].player;
                 // sortedBattingOrder ã§ lastPlayer ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¢ã™
                 const lastBatterIndexInLineup = sortedBattingOrder.findIndex(p => p.order === lastPlayer.order);
                 if (lastBatterIndexInLineup !== -1) {
                      // ãã®æ¬¡ã®æ‰“è€…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ batterIndices ã«ä¿å­˜
                      batterIndices[teamKey] = (lastBatterIndexInLineup + 1) % sortedBattingOrder.length;
                 } else {
                      // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ (ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹) - ç°¡æ˜“æ›´æ–°
                      console.warn(`Could not find index for last batter in inning ${currentInning}: ${lastPlayer.name}`);
                      batterIndices[teamKey] = (startingBatterIndex + finalOrderedPlays.length) % sortedBattingOrder.length;
                 }
            }
            // â–²â–²â–² å…ˆé ­æ‰“è€…æ›´æ–°ã“ã“ã¾ã§ â–²â–²â–²
        } // teamKey loop ã®çµ‚ã‚ã‚Š

        // ã‚¤ãƒ‹ãƒ³ã‚°çµ‚äº†æ™‚ã«ç´¯è¨ˆã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
        cumulativeScores.team1 += parseInt(inningScores.team1?.[i] || 0);
        cumulativeScores.team2 += parseInt(inningScores.team2?.[i] || 0);

    } // inning loop ã®çµ‚ã‚ã‚Š

    // --- 2. è©¦åˆå…¨ä½“ã®å€‹åˆ¥è¦ç´ ã‚’åˆ†æ ---
    // æƒœæ•—æŠ•æ‰‹ (å¤‰æ›´ãªã—)
    const loserName = dbMatch[losingTeamKey];
    const losingPitchers = dbMatch.details.pitching?.[losingTeamKey] || [];
    if (losingPitchers.length === 1) {
        const ace = losingPitchers[0];
        if (ace.result === 'L' && parseFloat(ace.innings || 0) >= 8 && parseInt(ace.earnedRuns || 0) <= 2) {
             highlights.push({ type: 'tough_loss', team: loserName, player: ace.name, description: `${ace.name}æŠ•æ‰‹ã¯${ace.innings}å›ã‚’${ace.earnedRuns}å¤±ç‚¹ã¨å¥½æŠ•ã—ãŸãŒã€æ‰“ç·šã®æ´è­·ã«æµã¾ã‚Œãªã‹ã£ãŸ` });
             keyPlayerNames.add(ace.name);
        }
    }

    // äº¤ä»£é¸æ‰‹ã®æ´»èº (ä»£æ‰“ãƒ’ãƒƒãƒˆ - å¤‰æ›´ãªã—)
    for (const teamKey of ['team1', 'team2']) {
        const teamName = dbMatch[teamKey];
        const teamBatting = dbMatch.details.batting?.[teamKey] || [];
        const substitutes = teamBatting.filter(p => p.sub_type && p.sub_type === 'PH'); // ä»£æ‰“ã®ã¿æŠ½å‡º
        substitutes.forEach(subPlayer => {
            for (let i = 0; i < numInnings; i++) {
                const resultInInning = subPlayer.results?.[i];
                if (resultInInning) {
                    // ãƒ’ãƒƒãƒˆç³»ã®çµæœã‹ãƒã‚§ãƒƒã‚¯
                    if (resultInInning.includes('å®‰') || resultInInning.includes('æœ¬') || resultInInning.includes('äºŒ') || resultInInning.includes('ä¸‰')) {
                         let playerRole = 'ä»£æ‰“ã®';
                         const playerInfo = `${playerRole}${subPlayer.name}`;
                         const description = translateResult(resultInInning, playerInfo, ''); // ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ãªã—
                         if(description){
                              highlights.push({ type: 'substitute_hit', inning: i + 1, team: teamName, player: subPlayer.name, description: `${description}ã€‚è¦‹äº‹èµ·ç”¨ã«å¿œãˆãŸ` });
                              keyPlayerNames.add(subPlayer.name);
                         }
                    }
                    break; // ãã®é¸æ‰‹ã®æœ€åˆã®æ‰“å¸­çµæœã®ã¿è¨˜éŒ²
                }
            }
        });
    }

    // â–¼â–¼â–¼ æŠ•æ‰‹æˆç¸¾ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆç”Ÿæˆæ–¹æ³•ã‚’å¤‰æ›´ â–¼â–¼â–¼
    for (const teamKey of ['team1', 'team2']) {
        const teamName = dbMatch[teamKey];
        const pitchingData = dbMatch.details.pitching?.[teamKey] || [];
        if (!pitchingData) continue;

        let pitchingRelayTextParts = []; // ç¶™æŠ•è¡¨ç¤ºç”¨

        pitchingData.forEach((pitcher, pIdx) => {
            if (!pitcher.name || !pitcher.innings) return;

            // å…¨ã¦ã®æˆç¸¾ã‚’å–å¾— (æœªå…¥åŠ›ã¯ 0 ã‚„ '-' ã¨ã™ã‚‹)
            const resultMark = {'W': 'â—‹', 'L': 'â—', 'S': 'ï¼³', 'H': 'ï¼¨'}[pitcher.result] || ''; // å‹æ•—ï¼³ï¼¨
            const innings = pitcher.innings || 'ä¸æ˜';
            const batters = pitcher.battersFaced || '-';
            const pitches = pitcher.pitches || '-';
            const hits = pitcher.hits || '0';
            const strikeouts = pitcher.strikeouts || '0';
            const walks = pitcher.walks || '0';
            const runs = pitcher.runs || '0';
            const earnedRuns = pitcher.earnedRuns || '0';

            // è©³ç´°ãªæˆç¸¾æ–‡å­—åˆ—ã‚’ç”Ÿæˆ
            const statsDetail = `(${innings}å› æ‰“${batters} çƒ${pitches} è¢«${hits} å¥ª${strikeouts} ä¸${walks} å¤±${runs} è‡ª${earnedRuns})`;

            // ãƒã‚¤ãƒ©ã‚¤ãƒˆã®èª¬æ˜æ–‡ã‚’ä½œæˆ
            let description = `${resultMark}${pitcher.name} ${statsDetail}`;

            // äº¤ä»£ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®æƒ…å ±ã‚’å–å¾— (ç²¾å¯†ç‰ˆÎ±ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æµç”¨)
            let inningWhenChanged = '?'; // ç™»æ¿ã‚¤ãƒ‹ãƒ³ã‚°
            let isMidInningChange = false;
            let outsWhenChanged = 0;
            let situation = ''; // äº¤ä»£æ™‚ã®çŠ¶æ³

            if (pIdx > 0) { // 2ç•ªæ‰‹ä»¥é™ã®å ´åˆã€å‰ã®æŠ•æ‰‹ã¨æ¯”è¼ƒ
                const prevPitcher = pitchingData[pIdx - 1];
                if (prevPitcher.innings) {
                    const prevInningsStr = prevPitcher.innings.toString();
                    if (prevInningsStr.includes('.')) {
                        isMidInningChange = true;
                        const parts = prevInningsStr.split('.');
                        inningWhenChanged = parseInt(parts[0]) + 1;
                        outsWhenChanged = parseInt(parts[1] || 0);
                    } else {
                        isMidInningChange = false;
                        inningWhenChanged = Math.floor(parseFloat(prevInningsStr)) + 1;
                        outsWhenChanged = 0;
                    }
                    if (isNaN(inningWhenChanged)) inningWhenChanged = '?';

                    // äº¤ä»£æ™‚ã®çŠ¶æ³åˆ†æ (ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°å‘¼ã³å‡ºã—)
                    if (inningWhenChanged !== '?' && isMidInningChange) {
                        const opponentTeamKey = teamKey === 'team1' ? 'team2' : 'team1';
                        const opponentBatting = dbMatch.details.batting?.[opponentTeamKey] || [];
                        if (opponentBatting.length > 0) {
                            const opponentStartingBatterIdx = batterIndices[opponentTeamKey];
                            const simulationResult = simulateHalfInningUntilOuts(opponentBatting, inningWhenChanged - 1, outsWhenChanged, opponentStartingBatterIdx);
                            if (simulationResult) {
                                const runnerCount = simulationResult.runners.filter(r => r !== null).length;
                                if (runnerCount === 3) situation = 'æº€å¡ã®ãƒ”ãƒ³ãƒã§';
                                else if (runnerCount > 0) situation = `${runnerCount}è€…ã‚’èƒŒè² ã„`;
                                // ç‚¹å·®ãªã©ã®æƒ…å ±ã‚‚è¿½åŠ å¯èƒ½
                            }
                        }
                    }
                }
            } else {
                inningWhenChanged = 1; // å…ˆç™ºæŠ•æ‰‹ã¯1å›ã‹ã‚‰
            }

            // äº¤ä»£æƒ…å ±ã‚’èª¬æ˜æ–‡ã«è¿½åŠ 
            if (pIdx > 0 && inningWhenChanged !== '?') {
                 if (isMidInningChange) {
                     description = `${inningWhenChanged}å›${outsWhenChanged}æ­»${situation}ç™»æ¿ã—ãŸ${description}`;
                 } else {
                     description = `${inningWhenChanged}å›ã‹ã‚‰ç™»æ¿ã—ãŸ${description}`;
                 }
            } else if (pIdx === 0) {
                 description = `å…ˆç™ºã®${description}`; // å…ˆç™ºæŠ•æ‰‹ã®è¨˜è¿°
            }

            // ç‰¹ç­†ã™ã¹ãæˆç¸¾ãŒã‚ã‚Œã°è¿½è¨˜ (å®Œå°ã€å¥ªä¸‰æŒ¯ãªã©) - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
            if (runs === '0' && parseFloat(innings) >= 7 && pitcher.result === 'W') description += ' è¦‹äº‹ãªå®Œå°å‹åˆ©';
            else if (parseInt(strikeouts) >= 10) description += ` ${strikeouts}å¥ªä¸‰æŒ¯ã®å¿«æŠ•`;
            else if (pitcher.result === 'L' && parseFloat(innings) >= 8 && parseInt(earnedRuns) <= 2) description += ' å¥½æŠ•ã‚‚å ±ã‚ã‚Œãš'; // æƒœæ•—

            // ãƒã‚¤ãƒ©ã‚¤ãƒˆã«è¿½åŠ 
            highlights.push({
                type: 'pitching_performance', // ã‚¿ã‚¤ãƒ—åã‚’å¤‰æ›´
                inning: inningWhenChanged !== '?' ? inningWhenChanged : undefined, // ç™»æ¿ã‚¤ãƒ‹ãƒ³ã‚°
                team: teamName,
                player: pitcher.name,
                description: description
            });
            keyPlayerNames.add(pitcher.name);

            // ç¶™æŠ•è¡¨ç¤ºç”¨ã®æƒ…å ±ã‚’è¨˜éŒ²
            pitchingRelayTextParts.push(`${pitcher.name}(${innings}å›)`);

        }); // pitchingData.forEach ã®çµ‚ã‚ã‚Š

        // ç¶™æŠ•å…¨ä½“ã®æƒ…å ±ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã«è¿½åŠ 
        if (pitchingRelayTextParts.length > 1) {
             highlights.push({ type: 'pitching_relay', team: teamName, description: `æŠ•æ‰‹ãƒªãƒ¬ãƒ¼ã¯ ${pitchingRelayTextParts.join(' â†’ ')} ã ã£ãŸ` });
        }
    } // teamKey loop ã®çµ‚ã‚ã‚Š
    // â–²â–²â–² æŠ•æ‰‹æˆç¸¾ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆç”Ÿæˆã“ã“ã¾ã§ â–²â–²â–²
  // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    // --- 2B. å®ˆå‚™äº¤ä»£ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ³å¤‰æ›´ã®å‡¦ç† ---
    const positionChanges = dbMatch.details.positionChanges || [];
    positionChanges.forEach(change => {
        const teamName = dbMatch[change.teamKey];
        if (!teamName || !change.playerName || !change.newPos) return;

        let description = "";
        let situation = ""; // çŠ¶æ³èª¬æ˜

        // ã‚¤ãƒ‹ãƒ³ã‚°é€”ä¸­ã®è©³ç´°ãªçŠ¶æ³ã‚’çµ„ã¿ç«‹ã¦ã‚‹
        if (change.timing === 'mid') {
            const outs = change.outs || '0';
            const runners = change.runners || {};
            let runnerDesc = [];
            if (runners.r1) runnerDesc.push("1å¡");
            if (runners.r2) runnerDesc.push("2å¡");
            if (runners.r3) runnerDesc.push("3å¡");
            
            if (runnerDesc.length === 3) situation = `${outs}ã‚¢ã‚¦ãƒˆ æº€å¡`;
            else if (runnerDesc.length > 0) situation = `${outs}ã‚¢ã‚¦ãƒˆ ${runnerDesc.join(', ')}`;
            else situation = `${outs}ã‚¢ã‚¦ãƒˆ ãƒ©ãƒ³ãƒŠãƒ¼ãªã—`;
            
            situation += "ã®å ´é¢ã§ã€";
        }

        description = `${change.inning}å›${change.topBottom}ã€${situation}${change.playerName}ãŒ${change.newPos}ã®å®ˆå‚™ã«å°±ã„ãŸ`;

        highlights.push({
            type: 'substitution',
            inning: parseInt(change.inning) || null,
            team: teamName,
            player: change.playerName,
            description: description
        });
        keyPlayerNames.add(change.playerName);
    });
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã€Œè©¦åˆå…¨ä½“ã®ç‰©èªæ€§ã‚’åˆ†æã€ã®æ‰‹å‰ã§ç½®ãæ›ãˆ/æŒ¿å…¥ â–¼â–¼â–¼
    // --- 3. å®ˆå‚™ãƒã‚¤ãƒ©ã‚¤ãƒˆ / ã‚¨ãƒ©ãƒ¼ ã®å‡¦ç† ---
    for (const teamKey of ['team1', 'team2']) {
        const teamName = dbMatch[teamKey];
        const fieldingPlays = dbMatch.details.fielding?.[teamKey] || [];
        
        // ã‚¨ãƒ©ãƒ¼ã‚’ç¤ºã™ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        const errorKeywords = ['ã‚¨ãƒ©ãƒ¼', 'ãƒˆãƒ³ãƒãƒ«', 'è½çƒ', 'å¾Œé€¸', 'æ‚ªé€çƒ', 'ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«'];

        fieldingPlays.forEach(play => {
            if (play.player && play.play) {
                let description = '';
                // å…¥åŠ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã«ã‚¨ãƒ©ãƒ¼ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const isError = errorKeywords.some(keyword => play.play.includes(keyword));

                if (isError) {
                    // ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                    description = `${play.player}ãŒ${play.play}ã®ç—›æ¨ã®ãƒŸã‚¹ã‚’çŠ¯ã—ãŸ`;
                } else {
                    // ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã®å ´åˆ
                    description = `${play.player}ãŒ${play.play}ã®ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚’è¦‹ã›ãŸ`;
                }
                
                highlights.push({
                    type: isError ? 'fielding_error' : 'fielding_fine_play', // ã‚¿ã‚¤ãƒ—ã‚’åˆ†ã‘ã‚‹
                    inning: play.inning || null,
                    team: teamName,
                    player: play.player,
                    description: description
                });
                keyPlayerNames.add(play.player);
            }
        });
    }
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

  // --- 4. è©¦åˆå…¨ä½“ã®ç‰©èªæ€§ã‚’åˆ†æã—ã€ç·æ‹¬ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ç”Ÿæˆ ---
    let summaryHighlight = null; // ç·æ‹¬ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å…¥ã‚Œã‚‹å¤‰æ•°
    // å‹è€…ã¨æ•—è€…ã®æœ€çµ‚ã‚¹ã‚³ã‚¢ã‚’å–å¾— (parseIntã§æ•°å€¤ã«å¤‰æ›ã€å¤±æ•—æ™‚ã¯0)
    const winnerScore = parseInt(dbMatch[winningTeamKey === 'team1' ? 'score1' : 'score2'] || 0);
    const loserScore = parseInt(dbMatch[losingTeamKey === 'team1' ? 'score1' : 'score2'] || 0);
    const totalRuns = winnerScore + loserScore; // åˆè¨ˆå¾—ç‚¹

    // ãƒ’ãƒƒãƒˆæ•°ã‚’è¨ˆç®—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (playerGameStatsã‹ã‚‰å–å¾—)
    const countHitsFromStats = (teamKey) => {
        // è©¦åˆã”ã¨ã®æˆç¸¾ãƒ‡ãƒ¼ã‚¿(playerGameStats)ã‚’å–å¾—ã€ãªã‘ã‚Œã°ç©ºã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        const gameStats = dbMatch.details.playerGameStats?.[teamKey] || {};
        // gameStatsã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å„é¸æ‰‹ã®æˆç¸¾(stats)ã‚’å–ã‚Šå‡ºã—ã€ãƒ’ãƒƒãƒˆæ•°(h)ã‚’åˆè¨ˆã™ã‚‹
        return Object.values(gameStats).reduce((sum, stats) => sum + (stats.h || 0), 0);
    };
    const winnerHits = countHitsFromStats(winningTeamKey); // å‹è€…ã®ãƒ’ãƒƒãƒˆæ•°
    const loserHits = countHitsFromStats(losingTeamKey);   // æ•—è€…ã®ãƒ’ãƒƒãƒˆæ•°
    const totalHits = winnerHits + loserHits; // åˆè¨ˆãƒ’ãƒƒãƒˆæ•°

    
    let scoreAfter6th = { team1: 0, team2: 0 }; // 6å›çµ‚äº†æ™‚ç‚¹ã®ã‚¹ã‚³ã‚¢
    // ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    if(inningScores?.team1 && inningScores?.team2){
        // 6å›çµ‚äº† (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹5) ã¾ã§ã®ã‚¹ã‚³ã‚¢ã‚’åˆè¨ˆ
        for(let i = 0; i < Math.min(numInnings, 6); i++) {
             scoreAfter6th.team1 += parseInt(inningScores.team1[i] || 0);
             scoreAfter6th.team2 += parseInt(inningScores.team2[i] || 0);
        }
    }

    const winnerScoreAfter6th = scoreAfter6th[winningTeamKey]; // å‹è€…ã®6å›çµ‚äº†æ™‚ã‚¹ã‚³ã‚¢
    const loserScoreAfter6th = scoreAfter6th[losingTeamKey];   // æ•—è€…ã®6å›çµ‚äº†æ™‚ã‚¹ã‚³ã‚¢
    const lastInning = numInnings - 1; // æœ€çµ‚ã‚¤ãƒ‹ãƒ³ã‚°ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (0å§‹ã¾ã‚Š)

    // ã‚µãƒ¨ãƒŠãƒ©å‹ã¡ã®åˆ¤å®š
    let isSayonara = false;
    // 9å›è£ä»¥é™ (lastInning >= 8) ã‹ã¤ å‹è€…ãŒå¾Œæ”» (winningTeamKey === 'team2') ã®å ´åˆ
    if (lastInning >= 8 && winningTeamKey === 'team2') {
        const scoreInLast = parseInt(inningScores?.team2[lastInning] || 0); // æœ€çµ‚å›ã®å¾—ç‚¹
        const scoreBeforeLast = winnerScore - scoreInLast; // æœ€çµ‚å›é–‹å§‹å‰ã®å‹è€…ã®ã‚¹ã‚³ã‚¢
        // æœ€çµ‚å›ã«å¾—ç‚¹ãŒã‚ã‚Šã€ã‹ã¤æœ€çµ‚å›é–‹å§‹å‰ã«å‹è€…ãŒè² ã‘ã¦ã„ãŸã‹åŒç‚¹ã ã£ãŸå ´åˆ
        if (scoreInLast > 0 && scoreBeforeLast <= loserScore) {
            isSayonara = true;
        }
    }

// â–¼â–¼â–¼ æ–°ã—ã„åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
    let mvpPlayer = null; // æ´»èºã—ãŸé¸æ‰‹å
    let mvpPerformance = ''; // æ´»èºå†…å®¹

    // 1. å‹åˆ©ãƒãƒ¼ãƒ ã®æ‰“è€…MVPåˆ¤å®š
    const winnerBattingStats = dbMatch.details.playerGameStats?.[winningTeamKey] || {};
    for (const playerName in winnerBattingStats) {
        const stats = winnerBattingStats[playerName];
        if (!stats || !stats.played) continue; // è©¦åˆã«å‡ºã¦ã„ãªã„é¸æ‰‹ã¯é™¤ã
        if (stats.hr >= 2) { mvpPlayer = playerName; mvpPerformance = `${stats.hr}æœ¬å¡æ‰“`; break; }
        if (stats.rbi >= 4) { mvpPlayer = playerName; mvpPerformance = `${stats.rbi}æ‰“ç‚¹`; break; }
        if (stats.h >= 4) { mvpPlayer = playerName; mvpPerformance = `${stats.h}å®‰æ‰“`; break; }
        // æ±ºå‹æ‰“ãªã©ã®åˆ¤å®šã¯ã‚ˆã‚Šè¤‡é›‘ã«ãªã‚‹ãŸã‚ã€ã“ã“ã§ã¯å®‰æ‰“æ•°/æœ¬å¡æ‰“/æ‰“ç‚¹ã§åˆ¤å®š
    }

    // 2. å‹åˆ©ãƒãƒ¼ãƒ ã®æŠ•æ‰‹MVPåˆ¤å®š (æ‰“è€…MVPãŒã„ãªã‘ã‚Œã°)
    const winnerPitchingData = dbMatch.details.pitching?.[winningTeamKey] || [];
    if (!mvpPlayer && winnerPitchingData.length > 0) {
        winnerPitchingData.forEach(pitcher => {
            if (!pitcher.name || !pitcher.innings) return;
            const innings = parseFloat(pitcher.innings);
            const earnedRuns = parseInt(pitcher.earnedRuns || 0);
            const strikeouts = parseInt(pitcher.strikeouts || 0);
            const runs = parseInt(pitcher.runs || 0); // å¤±ç‚¹ã‚‚è€ƒæ…®

            if (pitcher.result === 'W') { // å‹åˆ©æŠ•æ‰‹ã®ã¿
                 if (runs === 0 && innings >= 7) { // 7å›ä»¥ä¸Šå®Œå°
                     mvpPlayer = pitcher.name; mvpPerformance = `å®Œå°å‹åˆ©`;
                 } else if (strikeouts >= 10 && innings >= 6) { // 6å›ä»¥ä¸ŠæŠ•ã’10å¥ªä¸‰æŒ¯ä»¥ä¸Š
                     mvpPlayer = pitcher.name; mvpPerformance = `${strikeouts}å¥ªä¸‰æŒ¯ã®å¿«æŠ•`;
                 } else if (innings >= 6 && earnedRuns <= 1) { // 6å›ä»¥ä¸Šè‡ªè²¬ç‚¹1ä»¥ä¸‹ (HQSç›¸å½“)
                      mvpPlayer = pitcher.name; mvpPerformance = `å¥½æŠ•ã§è©¦åˆã‚’ä½œã‚‹`;
                 }
            }
             // ãƒªãƒªãƒ¼ãƒ•æŠ•æ‰‹ã®å¥½æŠ•ã‚‚åˆ¤å®šã§ãã‚‹ (ä¾‹: è¤‡æ•°ã‚¤ãƒ‹ãƒ³ã‚°ç„¡å¤±ç‚¹ã‚»ãƒ¼ãƒ–ãªã©)
             else if (pitcher.result === 'S' && innings >= 2 && earnedRuns === 0) {
                  mvpPlayer = pitcher.name; mvpPerformance = `å¥½ãƒªãƒªãƒ¼ãƒ•ã§è©¦åˆã‚’ç· ã‚ã‚‹`;
             }
        });
    }

    // 3. ç¶™æŠ•æˆåŠŸåˆ¤å®š (MVPãŒã„ãªã‘ã‚Œã°)
    let isRelaySuccess = false;
    if (!mvpPlayer && winnerPitchingData.length > 1) {
        // åˆè¨ˆè‡ªè²¬ç‚¹ãŒå°‘ãªã„ (ä¾‹: 9å›æŠ•ã’ã¦3ç‚¹ä»¥ä¸‹) ã‹ã¤ å‹åˆ©
        const totalER = winnerPitchingData.reduce((sum, p) => sum + parseInt(p.earnedRuns || 0), 0);
        const totalIP = winnerPitchingData.reduce((sum, p) => sum + parseFloat(p.innings || 0), 0);
        // 9ã‚¤ãƒ‹ãƒ³ã‚°æ›ç®—ã®è‡ªè²¬ç‚¹ãŒ3.00æœªæº€ãã‚‰ã„ã‚’ç›®å®‰ã«ã™ã‚‹ã‹ã€å˜ç´”ã«åˆè¨ˆè‡ªè²¬ç‚¹ãŒ2ç‚¹ä»¥ä¸‹ãªã©
        if (totalER <= 2 && totalIP >= (numInnings - 1)) { // ã»ã¼è©¦åˆå…¨ä½“ã‚’æŠ•ã’ã¦è‡ªè²¬ç‚¹2ä»¥ä¸‹
            isRelaySuccess = true;
        }
        // ä»–ã«ã‚‚ã€ãƒªãƒ¼ãƒ‰ã‚’å®ˆã‚Šåˆ‡ã£ãŸã€ãƒ”ãƒ³ãƒã‚’åˆ‡ã‚ŠæŠœã‘ãŸãªã©ã®åˆ¤å®šã‚’è¿½åŠ å¯èƒ½
    }
    // â–²â–²â–² æ–°ã—ã„åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã“ã“ã¾ã§ â–²â–²â–²

   // --- è©¦åˆå†…å®¹ã«å¿œã˜ãŸã‚µãƒãƒªãƒ¼ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ±ºå®š (â˜…å„ªå…ˆé †ä½å¤‰æ›´â˜…) ---
    if (mvpPlayer) {
        // å€‹äººæ´»èºã‚’æœ€å„ªå…ˆ
        summaryHighlight = { type: 'summary', description: `${mvpPlayer}ã®${mvpPerformance}ã®æ´»èºã§ã€${winnerName}ãŒå‹åˆ©ã‚’æ´ã‚“ã ` };
    } else if (isRelaySuccess) {
        // æ¬¡ã«ç¶™æŠ•æˆåŠŸ
        summaryHighlight = { type: 'summary', description: `${winnerName}æŠ•æ‰‹é™£ãŒ${loserName}æ‰“ç·šã‚’${loserScore}å¤±ç‚¹ã«æŠ‘ãˆã‚‹è¦‹äº‹ãªç¶™æŠ•ç­–ã§å‹åˆ©` };
    } else if (isSayonara) {
        // ä»¥ä¸‹ã€æ—¢å­˜ã®åˆ¤å®š
        summaryHighlight = { type: 'summary', description: `åŠ‡çš„ãªã‚µãƒ¨ãƒŠãƒ©å‹ã¡ã§ã€${winnerName}ãŒç†±æˆ¦ã«çµ‚æ­¢ç¬¦ã‚’æ‰“ã£ãŸ` };
    } else if (winnerScoreAfter6th < loserScoreAfter6th && winnerScore > loserScore && numInnings >= 7) {
        summaryHighlight = { type: 'summary', description: `${winnerName}ãŒçµ‚ç›¤ã«è¦‹äº‹ãªé€†è»¢åŠ‡ã‚’æ¼”ã˜ã€å‹åˆ©ã‚’æ´ã‚“ã ` };
    } else if (totalRuns <= 5 && totalHits <= 12) {
        summaryHighlight = { type: 'summary', description: `ä¸¡ãƒãƒ¼ãƒ åˆã‚ã›ã¦${totalHits}å®‰æ‰“${totalRuns}å¾—ç‚¹ã«çµ‚ã‚ã‚‹ã€æ¯è©°ã¾ã‚‹æŠ•æ‰‹æˆ¦ã¨ãªã£ãŸ` };
    } else if (totalRuns >= 13 && totalHits >= 20) {
        summaryHighlight = { type: 'summary', description: `ä¸¡ãƒãƒ¼ãƒ åˆã‚ã›ã¦${totalHits}å®‰æ‰“${totalRuns}å¾—ç‚¹ãŒä¹±ã‚Œé£›ã¶ã€å£®çµ¶ãªæ‰“æ’ƒæˆ¦ã¨ãªã£ãŸ` };
    } else if (winnerScore - loserScore >= 7) {
        summaryHighlight = { type: 'summary', description: `${winnerName}ãŒæŠ•æ‰“ã«ç›¸æ‰‹ã‚’åœ§å€’ã—ã€${winnerScore}-${loserScore}ã§å¿«å‹ã—ãŸ` };
    } else if (winnerScore - loserScore <= 2) {
        summaryHighlight = { type: 'summary', description: `${winnerName}ãŒ${loserName}ã®ç²˜ã‚Šå¼·ã„è¿½æ’ƒã‚’æŒ¯ã‚Šåˆ‡ã‚Šã€${winnerScore}-${loserScore}ã§æ¥æˆ¦ã‚’åˆ¶ã—ãŸ` };
    } else {
        summaryHighlight = { type: 'summary', description: `${winnerName}ãŒ${loserName}ã‚’ä¸‹ã—ã€${winnerScore}-${loserScore}ã§å‹åˆ©ã—ãŸ` };
    }

    // æ±ºå®šã—ãŸã‚µãƒãƒªãƒ¼ãƒã‚¤ãƒ©ã‚¤ãƒˆãŒã‚ã‚Œã°ã€highlightsé…åˆ—ã®å…ˆé ­ã«è¿½åŠ 
    if (summaryHighlight) {
        highlights.unshift(summaryHighlight);
    }
    
// --- 5. çµæœã‚’è¿”ã™ ---
    // â–¼â–¼â–¼ ã“ã® return æ–‡ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
    return { 
        highlights: highlights, 
        keyPlayerNames: Array.from(keyPlayerNames),
        summaryHighlight: summaryHighlight ? summaryHighlight.description : null // â˜…è¦ç´„æ–‡ã‚’è¿½åŠ 
    };
}

// â–¼â–¼â–¼ ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼šäº¤ä»£çŠ¶æ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ (â˜…è¤‡æ•°æ‰“å¸­å¯¾å¿œãƒ»å…ˆé ­æ‰“è€…æŒ‡å®šç‰ˆâ˜…) â–¼â–¼â–¼
/**
 * æŒ‡å®šã•ã‚ŒãŸã‚¤ãƒ‹ãƒ³ã‚°ã®æ”»æ’ƒã‚’ã€ç‰¹å®šã®ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆã«ãªã‚‹ã¾ã§ç°¡æ˜“çš„ã«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹
 * @param {Array} battingOrder - ç›¸æ‰‹ãƒãƒ¼ãƒ ã®æ‰“é †ãƒ‡ãƒ¼ã‚¿ (ã‚½ãƒ¼ãƒˆæ¸ˆã¿)
 * @param {number} inningIndex - ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯¾è±¡ã‚¤ãƒ‹ãƒ³ã‚°ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (0å§‹ã¾ã‚Š)
 * @param {number} targetOuts - ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã™ã‚‹ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆ
 * @param {number} startingBatterIdx - ã“ã®ã‚¤ãƒ‹ãƒ³ã‚°ã®å…ˆé ­æ‰“è€…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
 * @returns {object | null} - { runners: [1B, 2B, 3B], outs: number, scoreSelf: number, scoreOpp: number, nextBatterIdx: number } ã¾ãŸã¯ null
 */
function simulateHalfInningUntilOuts(battingOrder, inningIndex, targetOuts, startingBatterIdx) {
    if (!battingOrder || battingOrder.length === 0 || targetOuts < 0 || targetOuts > 3) return null;

    let outs = 0;
    let runners = [null, null, null]; // 1B, 2B, 3B
    let scoreSelf = 0; // ä»®ã‚¹ã‚³ã‚¢ (å®ˆå‚™å´)
    let scoreOpp = 0;  // ä»®ã‚¹ã‚³ã‚¢ (æ”»æ’ƒå´)

    let currentBatterIndex = startingBatterIdx; // å…ˆé ­æ‰“è€…ã‹ã‚‰é–‹å§‹
    let playsProcessedCount = 0; // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ & ãƒ‡ãƒãƒƒã‚°ç”¨
    const atBatsCountThisInning = {}; // ã“ã®ã‚¤ãƒ‹ãƒ³ã‚°ã§ã®å„æ‰“è€…ã®æ‰“å¸­æ•° { "1": 0, "2": 1, ... }

    // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯¾è±¡ã‚¤ãƒ‹ãƒ³ã‚°ã®å…¨ãƒ—ãƒ¬ãƒ¼ã‚’äº‹å‰ã«åé›†ãƒ»æ‰“å¸­é †ã«ä¸¦ã¹æ›¿ãˆã‚‹
    const playsForInning = [];
     battingOrder.forEach(player => {
         const resultString = player.results?.[inningIndex];
         if (resultString) {
             resultString.split('ã€').forEach(atBat => {
                 if(atBat) playsForInning.push({ player, atBat });
             });
         }
     });
     if (playsForInning.length === 0) return { runners, outs, scoreSelf, scoreOpp, nextBatterIdx: startingBatterIdx };

     // æ‰“é †ä¸¦ã¹æ›¿ãˆ (createHighlightsText ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯)
     const orderedPlays = [];
     let tempBatterIndex = startingBatterIdx;
     let playsCount = 0;
     const processedFlags = new Array(playsForInning.length).fill(false);
     const atBatsTempCount = {};
     while (orderedPlays.length < playsForInning.length && playsCount < playsForInning.length * 2) {
         const currentPlayer = battingOrder[tempBatterIndex];
         const playerOrderKey = currentPlayer.order;
         const currentAtBatOrdinal = atBatsTempCount[playerOrderKey] || 0;
         let foundPlayIndex = -1;
         let searchCount = 0;
         for(let k=0; k < playsForInning.length; k++){
             if(playsForInning[k].player.order === playerOrderKey && !processedFlags[k]) {
                 if(searchCount === currentAtBatOrdinal) {
                     foundPlayIndex = k;
                     break;
                 }
                 searchCount++;
             }
         }
         if (foundPlayIndex !== -1) {
             orderedPlays.push(playsForInning[foundPlayIndex]);
             processedFlags[foundPlayIndex] = true;
             atBatsTempCount[playerOrderKey] = currentAtBatOrdinal + 1;
             tempBatterIndex = (tempBatterIndex + 1) % battingOrder.length;
         } else {
             tempBatterIndex = (tempBatterIndex + 1) % battingOrder.length;
         }
         playsCount++;
     }
     const finalOrderedPlays = orderedPlays.length === playsForInning.length ? orderedPlays : playsForInning;


    // ä¸¦ã¹æ›¿ãˆãŸãƒ—ãƒ¬ãƒ¼ã‚’é †ç•ªã«å‡¦ç†ã—ã€targetOuts ã«é”ã™ã‚‹ã¾ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    for (const playData of finalOrderedPlays) {
        if (outs >= targetOuts) break; // ç›®æ¨™ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆã«é”ã—ãŸã‚‰çµ‚äº†

        const { player, atBat } = playData;
        const [batterPlay] = atBat.split(';');

        // ç°¡æ˜“ã‚¢ã‚¦ãƒˆåˆ¤å®š
        if (batterPlay.includes('ä¸‰æŒ¯') || batterPlay.includes('ã‚´ãƒ­') || batterPlay.includes('é£›') || batterPlay.includes('ç›´') || batterPlay.includes('çŠ ')) {
            outs++;
            if (batterPlay.includes('ä½µæ®º')) outs++;
        }
        if (outs >= targetOuts) break; // ã‚¢ã‚¦ãƒˆãŒç™ºç”Ÿã—ã¦ targetOuts ã«é”ã—ãŸã‚‰å³çµ‚äº†

        // ç°¡æ˜“ãƒ©ãƒ³ãƒŠãƒ¼çŠ¶æ³æ›´æ–°
        if (batterPlay.includes('å®‰') || batterPlay.includes('å¡æ‰“') || batterPlay.includes('å››çƒ') || batterPlay.includes('æ­»çƒ') || batterPlay.includes('ã‚¨ãƒ©ãƒ¼')) {
            if (runners[0] && runners[1] && runners[2] && (batterPlay.includes('å››çƒ') || batterPlay.includes('æ­»çƒ'))) {
                 scoreOpp++; // æŠ¼ã—å‡ºã—
            } else {
                if (runners[1]) runners[2] = 'runner'; // 2å¡â†’3å¡
                if (runners[0]) runners[1] = runners[0]; // 1å¡â†’2å¡
                runners[0] = player.name; // æ‰“è€…â†’1å¡
            }
        }
        // ç°¡æ˜“å¾—ç‚¹è¨ˆç®—
        if (batterPlay.includes('æœ¬å¡æ‰“')) {
            scoreOpp += runners.filter(r => r !== null).length + 1;
            runners = [null, null, null];
        } else if (batterPlay.includes('ç‚¹')) {
             const rbiMatch = batterPlay.match(/(\d+)ç‚¹/);
             scoreOpp += rbiMatch ? parseInt(rbiMatch[1]) : 1;
             // ç°¡æ˜“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã€ã©ã®èµ°è€…ãŒé‚„ã£ãŸã‹ã¯ç„¡è¦–
        }

        playsProcessedCount++; // å‡¦ç†æ¸ˆã¿ãƒ—ãƒ¬ãƒ¼æ•°
    }

    // æ¬¡ã®æ‰“è€…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—ã—ã¦è¿”ã™
    const lastSimulatedPlayer = finalOrderedPlays[playsProcessedCount - 1]?.player;
    let nextBatterIdx = startingBatterIdx; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    if(lastSimulatedPlayer){
        const lastSimIdx = battingOrder.findIndex(p => p.order === lastSimulatedPlayer.order);
        if(lastSimIdx !== -1){
            nextBatterIdx = (lastSimIdx + 1) % battingOrder.length;
        }
    }


    return { runners, outs, scoreSelf, scoreOpp, nextBatterIdx }; // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã¨æ¬¡ã®æ‰“è€…ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿”ã™
}
// â–²â–²â–² ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã“ã“ã¾ã§ â–²â–²â–²

// â–²â–²â–² ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã“ã“ã¾ã§ â–²â–²â–²

/**
 * 1æ‰“å¸­åˆ†ã®å…¥åŠ›ãƒ–ãƒ­ãƒƒã‚¯HTMLã‚’ç”Ÿæˆã™ã‚‹ï¼ˆæ‰“çƒã®å‹¢ã„(Strength)å¯¾å¿œãƒ»ãƒã‚°ä¿®æ­£ç‰ˆï¼‰
 * @param {Array<object>} playersOnField - ç¾åœ¨å‡ºå ´ä¸­ã®é¸æ‰‹ãƒªã‚¹ãƒˆ
 * @param {string} atBatString - 1æ‰“å¸­åˆ†ã®ä¿å­˜æ¸ˆã¿æ–‡å­—åˆ— (ä¾‹: "S:ä¸­å®‰1ç‚¹")
 * @returns {string} - ç”Ÿæˆã•ã‚ŒãŸHTML
 */
function createBattingResultDropdowns(playersOnField, atBatString = '') {
    // 1. ä¿å­˜ã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’ã€Œæ‰“è€…ãƒ—ãƒ¬ãƒ¼ã€ã¨ã€Œèµ°è€…ãƒ—ãƒ¬ãƒ¼ã€ã«åˆ†é›¢
    const [batterPlay, runnerPlaysString] = (atBatString || '').split(';');
    
    // 2. â˜…â˜…â˜… ä¿®æ­£ç‚¹ â˜…â˜…â˜…
    // tempResult ã‚’ã“ã“ã§ã€Œå…ˆã«ã€å®šç¾©ã™ã‚‹
    let tempResult = (batterPlay || '').trim();
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

   // â–¼â–¼â–¼ ã“ã®ã€Œå‹¢ã„ã€ã¨ã€Œæ³¨ç›®ã€ã®ãƒ‘ãƒ¼ã‚¹å‡¦ç†ã‚’è¿½åŠ  â–¼â–¼â–¼
    let selectedStrength = '';
    let isMarked = false; // â˜…æ³¨ç›®ãƒ•ãƒ©ã‚°

    if (tempResult.startsWith('â˜…:')) {
        isMarked = true;
        tempResult = tempResult.substring(3); // "â˜…:" ã‚’å‰Šé™¤
    }
    if (tempResult.startsWith('S:')) {
        selectedStrength = 'S:';
        tempResult = tempResult.substring(2);
    } else if (tempResult.startsWith('W:')) {
        selectedStrength = 'W:';
        tempResult = tempResult.substring(2);
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    // 4. æ®‹ã‚Šã®æƒ…å ±ï¼ˆçµæœã€æ–¹å‘ã€æ‰“ç‚¹ãªã©ï¼‰ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
    let selectedResult = '', selectedDirection = '', selectedRbi = '', selectedRunnerPlay = '';
    
    if (tempResult) {
        const rbiMatch = tempResult.match(/(\d+ç‚¹)/);
        if (rbiMatch) {
            selectedRbi = rbiMatch[0];
            tempResult = tempResult.replace(selectedRbi, '').trim();
        }
        if (tempResult.includes('å¥½èµ°å¡')) {
            selectedRunnerPlay = 'å¥½èµ°å¡';
            tempResult = tempResult.replace('å¥½èµ°å¡', '').trim();
        }
        const allResultTypes = [ ...BATTING_RESULTS.hits, ...BATTING_RESULTS.outs, ...BATTING_RESULTS.walks, ...BATTING_RESULTS.sacrifices, ...BATTING_RESULTS.other ];
        for (const type of allResultTypes) {
            if (tempResult.includes(type)) {
                selectedResult = type;
                tempResult = tempResult.replace(type, '').trim();
                break;
            }
        }
        if (tempResult.length > 0 && DIRECTIONS.includes(tempResult)) {
            selectedDirection = tempResult;
        }
    }

    // 5. HTMLã‚’ç”Ÿæˆã™ã‚‹
    const resultOptions = [ ...BATTING_RESULTS.hits, ...BATTING_RESULTS.outs, ...BATTING_RESULTS.walks, ...BATTING_RESULTS.sacrifices, ...BATTING_RESULTS.other ]
        .map(r => `<option value="${r}" ${selectedResult === r ? 'selected' : ''}>${r}</option>`).join('');
    const directionOptions = DIRECTIONS.map(d => `<option value="${d}" ${selectedDirection === d ? 'selected' : ''}>${d}</option>`).join('');
    const rbiOptions = RBIS.map(r => `<option value="${r}" ${selectedRbi === r ? 'selected' : ''}>${r}</option>`).join('');
    const runnerPlayOptions = ['å¥½èµ°å¡'].map(r => `<option value="${r}" ${selectedRunnerPlay === r ? 'selected' : ''}>${r}</option>`).join('');
    const strengthOptions = `
        <option value="S:" ${selectedStrength === 'S:' ? 'selected' : ''}>å¼·</option>
        <option value="W:" ${selectedStrength === 'W:' ? 'selected' : ''}>å¼±</option>
    `;

    return `
        <div class="at-bat-block border-t border-dashed pt-2 mt-2 first:mt-0 first:pt-0 first:border-t-0">
            <div class="flex items-center gap-1 batting-result-container mb-1">
                <div class="flex-grow flex gap-1">
                    <select class="batting-result-part w-[25%] text-xs p-1 border rounded result-type"><option value="">-çµæœ-</option>${resultOptions}</select>
                    <select class="batting-result-part w-[20%] text-xs p-1 border rounded result-direction"><option value="">-æ–¹å‘-</option>${directionOptions}</select>
                    <select class="batting-result-part w-[20%] text-xs p-1 border rounded result-rbi"><option value="">-æ‰“ç‚¹-</option>${rbiOptions}</select>
                    <select class="batting-result-part w-[15%] text-xs p-1 border rounded result-strength bg-red-50"><option value="">-å‹¢ã„-</option>${strengthOptions}</select>
                    <select class="batting-result-part w-[20%] text-xs p-1 border rounded result-runner-play bg-yellow-50"><option value="">-èµ°å¡-</option>${runnerPlayOptions}</select>
                </div>

<div class="w-12 flex-shrink-0">
                    <button class="mark-at-bat-btn w-full h-full text-xs font-bold p-1 rounded border ${isMarked ? 'bg-yellow-300 border-yellow-500 text-yellow-900' : 'bg-gray-100 border-gray-300 text-gray-500 hover:bg-gray-200'}"
                            data-marked="${isMarked ? 'true' : 'false'}"
                            title="ã“ã®æ‰“å¸­ã‚’ã€Œæ³¨ç›®ã®æ‰“å¸­ã€ã¨ã—ã¦AIã«ãƒãƒ¼ã‚¯ã—ã¾ã™">
                        â˜… æ³¨ç›®
                    </button>
                </div>

            </div>
            ${createRunnerInputsHTML(playersOnField, runnerPlaysString)}
        </div>
    `;
}
/**
 * ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚’ãŸã©ã‚Šã€æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã®æƒ…å ±ã‚’ç‰¹å®šã™ã‚‹ï¼ˆâ˜…ã‚¿ã‚¤ãƒ—ãƒŸã‚¹ã‚’ä¿®æ­£ã—ãŸæœ€çµ‚ç‰ˆï¼‰
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 * @param {string} currentMatchId - ãã®ãƒãƒ¼ãƒ ãŒå‹åˆ©ã—ãŸç¾åœ¨ã®è©¦åˆID
 * @returns {object|null} - æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±
 */
function findNextOpponent(teamName, currentMatchId) {
    const allMatches = tournamentState.matches;
    // â˜…â˜…â˜… ã“ã“ãŒä¿®æ­£ç®‡æ‰€ï¼š allMessages -> allMatches ã«ä¿®æ­£ â˜…â˜…â˜…
    if (!allMatches || !allMatches[currentMatchId]) return null;

    const idParts = currentMatchId.split('-');
    const side = idParts[0];

    if (side === 'F') {
        return { opponentName: 'å„ªå‹', roundName: 'å¤§ä¼šçµ‚äº†' };
    }

    const roundNum = parseInt(idParts[1].slice(1));
    const matchNum = parseInt(idParts[2].slice(1));
    const numTeams = tournamentState.teams.length;
    const finalRound = Math.log2(numTeams);

    let nextMatchId, roundName;
    if (roundNum === finalRound - 1) {
        nextMatchId = 'F-R1-M1';
        roundName = 'æ±ºå‹';
    } else if (roundNum < finalRound - 1) {
        const nextRoundNum = roundNum + 1;
        nextMatchId = `${side}-R${nextRoundNum}-M${Math.ceil(matchNum / 2)}`;
        const roundNameMap = { [finalRound - 1]: "æº–æ±ºå‹", [finalRound - 2]: "æº–ã€…æ±ºå‹" };
        roundName = roundNameMap[nextRoundNum] || `${nextRoundNum}å›æˆ¦`;
    } else {
        return null;
    }

    const nextMatch = allMatches[nextMatchId];
    if (!nextMatch) return null;

    let opponentName = null;
    if (nextMatch.team1 && nextMatch.team1 !== teamName) opponentName = nextMatch.team1;
    else if (nextMatch.team2 && nextMatch.team2 !== teamName) opponentName = nextMatch.team2;

    if (opponentName) {
        return {
            opponentName: opponentName,
            opponentRank: calculateRank(opponentName, tournamentState),
            roundName: roundName
        };
    } else {
        // ç›¸æ‰‹ãŒæœªå®šã®å ´åˆã€ãã®ç›¸æ‰‹ã‚’æ±ºã‚ã‚‹è©¦åˆã‚’æ¢ã—ã«è¡Œã
        const feederMatchNumber = matchNum % 2 === 1 ? matchNum + 1 : matchNum - 1;
        const feederMatchId = `${side}-R${roundNum}-M${feederMatchNumber}`;
        const feederMatch = allMatches[feederMatchId];

        if (feederMatch && feederMatch.team1 && feederMatch.team2) {
            return {
                opponentName: 'ï¼ˆæœªå®šï¼‰',
                roundName: roundName,
                decidingMatch: {
                    team1: feederMatch.team1,
                    rank1: calculateRank(feederMatch.team1, tournamentState),
                    team2: feederMatch.team2,
                    rank2: calculateRank(feederMatch.team2, tournamentState)
                }
            };
        }
        
        return { opponentName: 'ï¼ˆæœªå®šï¼‰', opponentRank: '?', roundName: roundName };
    }
}

/**
 * è¤‡æ•°èµ°è€…ã«å¯¾å¿œã—ãŸèµ°å¡å…¥åŠ›æ¬„ã®HTMLã‚’ç”Ÿæˆã™ã‚‹
 * @param {Array<object>} playersOnField - ç¾åœ¨å‡ºå ´ä¸­ã®é¸æ‰‹ãƒªã‚¹ãƒˆ
 * @param {string} currentResult - ä¿å­˜æ¸ˆã¿ã®æ‰“å¸­çµæœæ–‡å­—åˆ—
 * @returns {string} - ç”Ÿæˆã•ã‚ŒãŸHTML
 */
/**
 * è¤‡æ•°èµ°è€…ã«å¯¾å¿œã—ãŸèµ°å¡å…¥åŠ›æ¬„ã®HTMLã‚’ç”Ÿæˆã™ã‚‹ï¼ˆåŒºåˆ‡ã‚Šæ–‡å­—ãƒã‚°ä¿®æ­£ç‰ˆï¼‰
 */
function createRunnerInputsHTML(playersOnField, runnerPlaysString = '') {
    const baserunningPlays = ['ç›—å¡', 'ç›—å¡æ­»', 'ã‚¿ãƒƒãƒã‚¢ãƒƒãƒ—', 'é€²å¡', 'ç”Ÿé‚„', 'èµ°å¡æ­»', 'ç‰½åˆ¶æ­»', 'æŒŸæ®ºãƒ—ãƒ¬ãƒ¼ã§ã‚¢ã‚¦ãƒˆ'];
    const bases = ['ä¸€å¡ã¸', 'äºŒå¡ã¸', 'ä¸‰å¡ã¸', 'æœ¬å¡ã¸(ç”Ÿé‚„)'];
    
    // â–¼â–¼â–¼ã€é‡è¦ä¿®æ­£ã€‘åŒºåˆ‡ã‚Šæ–‡å­—ã‚’ã€Œã€ã€ã‹ã‚‰ã€Œ,ã€ã«å¤‰æ›´â–¼â–¼â–¼
    const runnerEvents = runnerPlaysString ? runnerPlaysString.split(',') : [];
    // â–²â–²â–²

    let html = '<div class="runner-plays-container space-y-1 mt-1">';
    
    runnerEvents.forEach(event => {
        const parts = event.trim().split(' ');
        const name = parts[0] || '';
        const play = parts[1] || '';
        const base = parts.slice(2).join(' ') || '';
        
        const nameOptions = playersOnField.map(p => `<option value="${p.name}" ${p.name === name ? 'selected' : ''}>${p.name}</option>`).join('');
        const playOptions = baserunningPlays.map(p => `<option value="${p}" ${p === play ? 'selected' : ''}>${p}</option>`).join('');
        const baseOptions = bases.map(b => `<option value="${b}" ${b === base ? 'selected' : ''}>${b}</option>`).join('');

        html += `
            <div class="runner-play-input flex gap-1 items-center mt-1">
                <select class="runner-name w-1/3 text-xs p-1 border rounded"><option value="">-èª°ãŒ-</option>${nameOptions}</select>
                <select class="runner-play w-1/3 text-xs p-1 border rounded bg-green-50"><option value="">-ä½•ã‚’ã—ãŸ-</option>${playOptions}</select>
                <select class="runner-base w-1/3 text-xs p-1 border rounded bg-green-50"><option value="">-ã©ã“ã¸-</option>${baseOptions}</select>
                <button class="remove-runner-play-btn text-red-500 hover:text-red-700 font-bold text-lg leading-none p-1">Ã—</button>
            </div>
        `;
    });

    html += '</div>';
    html += '<button class="add-runner-play-btn text-xs mt-1 bg-gray-200 px-2 py-0.5 rounded hover:bg-gray-300">+ èµ°è€…ãƒ—ãƒ¬ãƒ¼ã‚’è¿½åŠ </button>';
    return html;
}

/**
 * é¸æ‰‹ã®å¤§ä¼šé€šç®—æˆç¸¾ã‚’ã€AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã®çŸ­ã„æ–‡ç« ã«è¦ç´„ã™ã‚‹
 * @param {string} playerName - é¸æ‰‹å
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 * @returns {string | null} - "å§«å·: æ‰“ç‡.500, 3æœ¬å¡æ‰“, 10æ‰“ç‚¹" ã®ã‚ˆã†ãªè¦ç´„æ–‡ã€‚æˆç¸¾ãŒãªã‘ã‚Œã°nullã€‚
 */
function getPlayerTournamentStatsSummary(playerName, teamName) {
    const teamRecord = tournamentState.teamRecords[teamName];
    if (!teamRecord || !teamRecord.playerStats) return null;

    const battingStats = teamRecord.playerStats.batting[playerName];
    const pitchingStats = teamRecord.playerStats.pitching[playerName];
    
    let summaries = [];

    if (battingStats && battingStats.ab > 0) {
        const avg = (battingStats.h / battingStats.ab).toFixed(3);
        summaries.push(`æ‰“ç‡${avg}, ${battingStats.hr}æœ¬å¡æ‰“, ${battingStats.rbi}æ‰“ç‚¹`);
    }

    if (pitchingStats && pitchingStats.ip > 0) {
        const era = pitchingStats.er > 0 ? ((pitchingStats.er * 9) / pitchingStats.ip).toFixed(2) : "0.00";
        summaries.push(`${pitchingStats.w}å‹${pitchingStats.l}æ•—, é˜²å¾¡ç‡${era}, ${pitchingStats.so}å¥ªä¸‰æŒ¯`);
    }

    if (summaries.length > 0) {
        return `${playerName}: ${summaries.join(' / ')}`;
    }
    
    return null;
}

/**
 * Analyzes the results of a half-inning, counts outs, and updates the UI (colors and disabled state).
 */
function updateInningState(teamKey, inningIndex) {
    const battingTable = document.getElementById(`batting-table-${teamKey}`);
    if (!battingTable) return;

    let outCount = 0;
    
    // --- 1. Analyze Batting Results ---
    battingTable.querySelectorAll('tbody tr').forEach(row => {
        const resultCell = row.children[5 + inningIndex];
        if (!resultCell) return;
        
        const atBatContainers = resultCell.querySelectorAll('.batting-result-container');
        atBatContainers.forEach(container => {
            const resultTypeSelect = container.querySelector('.result-type');
            const resultText = resultTypeSelect.value;
            
            // Count outs
            if (BATTING_RESULTS.outs.includes(resultText)) {
                outCount += (resultText === 'ä½µæ®º') ? 2 : 1;
            }

            // Color-code the dropdowns
            const dropdowns = container.querySelectorAll('select');
            dropdowns.forEach(dd => dd.classList.remove('result-hit', 'result-out', 'result-on-base'));

            if (BATTING_RESULTS.hits.includes(resultText)) {
                dropdowns.forEach(dd => dd.classList.add('result-hit'));
            } else if (BATTING_RESULTS.walks.includes(resultText) || BATTING_RESULTS.other.includes(resultText)) {
                dropdowns.forEach(dd => dd.classList.add('result-on-base'));
            } else if (BATTING_RESULTS.outs.includes(resultText) || BATTING_RESULTS.sacrifices.includes(resultText)) {
                dropdowns.forEach(dd => dd.classList.add('result-out'));
            }
        });
    });

    // --- 2. Count Outs from "Inning Events" (Baserunning) ---
    const eventsInput = document.querySelector(`.inning-events-input[data-team-key="${teamKey}"][data-inning-index="${inningIndex}"]`);
    if (eventsInput && eventsInput.value) {
        const events = eventsInput.value.split('ã€');
        events.forEach(event => {
            if (event.includes('ç›—å¡æ­»') || event.includes('èµ°å¡æ­»')) {
                outCount++;
            }
        });
    }

    // --- 3. Lock the Inning if 3 Outs are Reached ---
    const isLocked = outCount >= 3;
    battingTable.querySelectorAll('tbody tr').forEach(row => {
        const resultCell = row.children[5 + inningIndex];
        if (!resultCell) return;
        
        const dropdowns = resultCell.querySelectorAll('.batting-result-container select');
        const addButtons = resultCell.querySelectorAll('.add-at-bat-btn');
        
        dropdowns.forEach(dd => {
            dd.disabled = isLocked;
            if (isLocked) dd.classList.add('bg-gray-100');
        });
        addButtons.forEach(btn => {
            btn.disabled = isLocked;
            if (isLocked) btn.style.visibility = 'hidden';
        });
    });
     if (eventsInput) {
        eventsInput.disabled = isLocked;
        if (isLocked) eventsInput.classList.add('bg-gray-100');
     }
}



// â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
/**
 * æŒ‡å®šã•ã‚ŒãŸmatchIdã«é–¢é€£ã™ã‚‹ã€éå»ã«ç”Ÿæˆã•ã‚ŒãŸAIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å…¨ã¦å‰Šé™¤ã™ã‚‹
 * @param {string} matchId - å¯¾è±¡ã®è©¦åˆID
 */
function clearPreviousAiContent(matchId) {
    if (!matchId) return;

    // 1. ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ (é€šå¸¸è¨˜äº‹ã€ç¾½ç”°ãƒ¬ãƒãƒ¼ãƒˆã€ã‚¨ãƒ©ãƒ¼) ã‚’å‰Šé™¤
    // (context.matchId ã¾ãŸã¯ errorId ãŒ matchId ã¨ä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’å‰Šé™¤)
    tournamentState.news = tournamentState.news.filter(article => {
        if (article.context && article.context.matchId === matchId) return false;
        if (article.errorId === matchId) return false;
        return true;
    });

    // 2. æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆ (é€šå¸¸BBS) ã‚’å‰Šé™¤
    // (BBSã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã¯ãªãå€‹ã€…ã®ã‚³ãƒ¡ãƒ³ãƒˆãªã®ã§ã€context.matchId ã§å‰Šé™¤)
    tournamentState.bbsComments = tournamentState.bbsComments.filter(comment => {
        if (comment.context && comment.context.matchId === matchId) return false;
        if (comment.errorId && comment.errorId.includes(matchId)) return false;
        return true;
    });

    // 3. ã¾ã¨ã‚ã‚¹ãƒ¬ãƒƒãƒ‰ (matomeThreads) ã‚’å‰Šé™¤
    if (tournamentState.matomeThreads && tournamentState.matomeThreads[matchId]) {
        delete tournamentState.matomeThreads[matchId];
    }
}
// â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²



/**
 * è©¦åˆã®å‹è€…ã‚’å‡¦ç†ã™ã‚‹ä¸­å¿ƒçš„é–¢æ•°ï¼ˆå…¨æ©Ÿèƒ½çµ±åˆãƒ»å®Ÿè¡Œé †åºä¿®æ­£ãƒ»äº‹å®Ÿç¢ºèªå‰Šé™¤ã®æœ€çµ‚ç‰ˆï¼‰
 */
async function processMatchWin(matchId, winnerName) {
    // --- 1. è©¦åˆãƒ‡ãƒ¼ã‚¿ã®ç‰¹å®šã¨åŸºæœ¬æƒ…å ±ã®è¨­å®š ---
    let dbMatch = findMatchById(matchId);
    if (!dbMatch || !dbMatch.team1 || !dbMatch.team2) return;
// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆ â–¼â–¼â–¼
    // --- å†å‡¦ç†ï¼ˆå†ç”Ÿæˆï¼‰ã®ç¢ºèª ---
    if (dbMatch.winner) {
        // æ—¢ã«å‹è€…ãŒæ±ºã¾ã£ã¦ã„ã‚‹å ´åˆ
        const confirmed = await showConfirm(
            `ã“ã®è©¦åˆï¼ˆ${dbMatch.team1} vs ${dbMatch.team2}ï¼‰ã¯æ—¢ã«ã€Œ${dbMatch.winner}ã€ã®å‹åˆ©ã§å‡¦ç†æ¸ˆã¿ã§ã™ã€‚\n\n` +
            "ã€Œè©³ç´°å…¥åŠ›ã€ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£ã—ã¾ã—ãŸã‹ï¼Ÿ\n" +
            "ã€Œã¯ã„ã€ã‚’æŠ¼ã™ã¨ã€ç¾åœ¨ã®è©³ç´°å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã€AIè¨˜äº‹ã¨æ²ç¤ºæ¿ã‚’ã™ã¹ã¦å†ç”Ÿæˆã—ã¾ã™ã€‚\n\n" +
            "ï¼ˆæ³¨æ„ï¼šã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰"
        );
        
        if (!confirmed) {
            return; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã„ã„ãˆã€ã‚’æŠ¼ã—ãŸã‚‰ä¸­æ–­
        }
        
        // â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã¯ã„ã€ã‚’æŠ¼ã—ãŸå ´åˆã€å¤ã„AIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å‰Šé™¤
        clearPreviousAiContent(matchId);
        
        // â˜… å‹è€…ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã€æ–°ã—ã„å‹è€…ï¼ˆwinnerNameï¼‰ã§ä¸Šæ›¸ãã™ã‚‹
        // ï¼ˆâ€»é€šç®—æˆç¸¾ã¯ `saveDetailedStats` ã§ãƒªã‚»ãƒƒãƒˆæ¸ˆã¿ã¨ä»®å®šï¼‰
        dbMatch.winner = null; 
        
    } else {
        // ï¼ˆå‹è€…ãŒã¾ã æ±ºã¾ã£ã¦ã„ãªã„ã€é€šå¸¸ã®åˆå›å‡¦ç†ã®å ´åˆï¼‰
        // è©¦åˆé–‹å§‹å‰ã«ã€ä¸¡ãƒãƒ¼ãƒ ã®å¤ã„ã€Œä¸€æ™‚ãƒ•ãƒ©ã‚°ã€ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ
        for (const teamName of [dbMatch.team1, dbMatch.team2]) {
            const teamRecord = tournamentState.teamRecords[teamName];
            if (!teamRecord || !teamRecord.playerStats || !teamRecord.playerStats.batting) continue;
            
            // å…¨é¸æ‰‹ã® batting ã¨ pitching ã®ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
            for (const playerName in teamRecord.playerStats.batting) {
                teamRecord.playerStats.batting[playerName].narrative_flag = null;
            }
            for (const playerName in teamRecord.playerStats.pitching) {
                teamRecord.playerStats.pitching[playerName].narrative_flag = null;
            }
        }
    }
    // â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

    const loserName = dbMatch.team1 === winnerName ? dbMatch.team2 : dbMatch.team1;
    dbMatch.winner = winnerName;

    // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‹ã‚‰ã‚¹ã‚³ã‚¢ã¨summaryã‚’èª­ã¿å–ã‚‹
    const matchEl = document.querySelector(`.matchup[data-match-id="${matchId}"]`);
    if (matchEl) {
        const score1El = matchEl.querySelector('[data-team-pos="1"]');
        const score2El = matchEl.querySelector('[data-team-pos="2"]');
        // ã‚¹ã‚³ã‚¢ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿dbMatchã‚’æ›´æ–°
        if (score1El && score2El && score1El.value !== '' && score2El.value !== '') {
            dbMatch.score1 = score1El.value;
            dbMatch.score2 = score2El.value;
        } else {
            // ã‚¹ã‚³ã‚¢ãŒç©ºã®å ´åˆã€0-0ãªã©ã‚’ä»®ã§è¨­å®šã™ã‚‹ã‹ã€ã‚¨ãƒ©ãƒ¼å‡¦ç†ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“
            // ã“ã“ã§ã¯ä»®ã« 0-0 ã¨ã—ã¾ã™ãŒã€é©åˆ‡ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚„ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¤œè¨ã—ã¦ãã ã•ã„
            dbMatch.score1 = '0';
            dbMatch.score2 = '0';
        }
        dbMatch.summary = matchEl.querySelector('.match-summary-input')?.value || '';
    } else {
        // matchElãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã‚‚ã‚¹ã‚³ã‚¢ã‚’ä»®è¨­å®š (ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
        dbMatch.score1 = '0';
        dbMatch.score2 = '0';
    }


// â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ åˆ¤å®šï¼ˆä¿®æ­£ç‰ˆï¼‰ â–¼â–¼â–¼
    dbMatch.calledGame = false;
    dbMatch.calledInning = null;
    let earliestCalledInning = null; // ã‚³ãƒ¼ãƒ«ãƒ‰ãŒæˆç«‹ã—ãŸæœ€åˆã®ã‚¤ãƒ‹ãƒ³ã‚°ã‚’è¨˜éŒ²ã™ã‚‹å¤‰æ•°

    // è©³ç´°å…¥åŠ›ãŒã‚ã‚Šã€ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ãŒå­˜åœ¨ã—ã€æœ€ä½5ã‚¤ãƒ‹ãƒ³ã‚°ä»¥ä¸Šã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿åˆ¤å®š
    if (dbMatch.details && dbMatch.details.inningScore &&
        dbMatch.details.inningScore.team1 && dbMatch.details.inningScore.team2 &&
        dbMatch.details.inningScore.team1.length >= 5)
    {
        const inningScores1 = dbMatch.details.inningScore.team1;
        const inningScores2 = dbMatch.details.inningScore.team2;
        const actualNumInningsRecorded = inningScores1.length; // è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ‹ãƒ³ã‚°æ•°

        let cumulativeScore1 = 0;
        let cumulativeScore2 = 0;

        // 1å›ã‹ã‚‰è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹æœ€çµ‚ã‚¤ãƒ‹ãƒ³ã‚°ã¾ã§ã€å„ã‚¤ãƒ‹ãƒ³ã‚°çµ‚äº†æ™‚ç‚¹ã®ã‚¹ã‚³ã‚¢å·®ã‚’ãƒã‚§ãƒƒã‚¯
        for (let i = 0; i < actualNumInningsRecorded; i++) {
            cumulativeScore1 += parseInt(inningScores1[i] || 0);
            cumulativeScore2 += parseInt(inningScores2[i] || 0);
            const currentInning = i + 1; // ç¾åœ¨ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹ã‚¤ãƒ‹ãƒ³ã‚° (1å§‹ã¾ã‚Š)
            const scoreDiff = Math.abs(cumulativeScore1 - cumulativeScore2);

            // ã€é‡è¦ã€‘ãƒã‚§ãƒƒã‚¯ã¯ã‚¤ãƒ‹ãƒ³ã‚°çµ‚äº†æ™‚ç‚¹ã§è¡Œã†
            // 5å›çµ‚äº†æ™‚ç‚¹ã§10ç‚¹å·®ä»¥ä¸Šã‹ï¼Ÿ
            if (currentInning === 5 && scoreDiff >= 10) {
                earliestCalledInning = 5;
                break; // 5å›ã‚³ãƒ¼ãƒ«ãƒ‰æˆç«‹ãªã‚‰ä»¥é™ã®ãƒã‚§ãƒƒã‚¯ä¸è¦
            }
            // 6å›çµ‚äº†æ™‚ç‚¹ã§10ç‚¹å·®ä»¥ä¸Šã‹ï¼Ÿ
            if (currentInning === 6 && scoreDiff >= 10) {
                earliestCalledInning = 6;
                break; // 6å›ã‚³ãƒ¼ãƒ«ãƒ‰æˆç«‹
            }
            // 7å›çµ‚äº†æ™‚ç‚¹ã§7ç‚¹å·®ä»¥ä¸Šã‹ï¼Ÿ (10ç‚¹å·®ã‚‚å«ã‚€)
            if (currentInning === 7 && scoreDiff >= 7) {
                earliestCalledInning = 7;
                break; // 7å›ã‚³ãƒ¼ãƒ«ãƒ‰æˆç«‹
            }
            // 8å›çµ‚äº†æ™‚ç‚¹ã§7ç‚¹å·®ä»¥ä¸Šã‹ï¼Ÿ (10ç‚¹å·®ã‚‚å«ã‚€)
            if (currentInning === 8 && scoreDiff >= 7) {
                earliestCalledInning = 8;
                break; // 8å›ã‚³ãƒ¼ãƒ«ãƒ‰æˆç«‹
            }
            // â˜…â˜…â˜… 9å›ä»¥é™ã®ã‚³ãƒ¼ãƒ«ãƒ‰ã¯ãƒ«ãƒ¼ãƒ«ä¸Šãªã„ã®ã§ã€ã“ã“ã§ãƒ«ãƒ¼ãƒ—ã¯å®Ÿè³ªçµ‚äº† â˜…â˜…â˜…
        }

        // earliestCalledInning ãŒè¦‹ã¤ã‹ã£ã¦ã„ã‚Œã°ã€ã‚³ãƒ¼ãƒ«ãƒ‰æˆç«‹ã¨è¨˜éŒ²
        if (earliestCalledInning !== null) {
            dbMatch.calledGame = true;
            dbMatch.calledInning = earliestCalledInning; // â˜…æˆç«‹ã—ãŸã‚¤ãƒ‹ãƒ³ã‚°ã‚’è¨˜éŒ²
        }
    }
    // â–²â–²â–² ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ åˆ¤å®šã“ã“ã¾ã§ â–²â–²â–²


    // â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ â–¼â–¼â–¼
    // --- â˜…â˜…â˜… å‹è€…ã‚’æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚ã‚‹å‡¦ç†ã‚’å…ˆã«å®Ÿè¡Œ â˜…â˜…â˜… ---
    // ç§‹å­£/æ˜¥å­£ã®åœ°åŒºäºˆé¸ãƒ»é †ä½æ±ºå®šæˆ¦ã€Œä»¥å¤–ã€ã®å ´åˆï¼ˆã¤ã¾ã‚Šå¤å¤§ä¼š or ç§‹/æ˜¥ã®çœŒå¤§ä¼šæœ¬æˆ¦ï¼‰
    if (!(tournamentState.currentTournament === 'autumn' && tournamentState.autumnPhase !== 'main') &&
        !(tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'regional_qualifiers'))
    {
        // å‹æ•—æ•°ã‚’è¨˜éŒ² (teamRecordsãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿)
        if(tournamentState.teamRecords[winnerName]) tournamentState.teamRecords[winnerName].wins++;
        if(tournamentState.teamRecords[loserName]) tournamentState.teamRecords[loserName].losses++;

        const idParts = matchId.split('-');
        const side = idParts[0];

        // æ±ºå‹æˆ¦('F')ä»¥å¤–ã®å ´åˆã€æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸é€²ã‚ã‚‹
        if (side !== 'F') {
            const roundNum = parseInt(idParts[1].slice(1));
            const numTeamsInTournament = tournamentState.teams.length; // ç¾åœ¨ã®å¤§ä¼šã®ãƒãƒ¼ãƒ æ•°ã‚’å–å¾—
            const finalRound = Math.log2(numTeamsInTournament); // ç¾åœ¨ã®å¤§ä¼šã®æœ€çµ‚ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã‚’è¨ˆç®—

            // æœ€çµ‚ãƒ©ã‚¦ãƒ³ãƒ‰ã‚ˆã‚Šå‰ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®å ´åˆã®ã¿é€²è¡Œå‡¦ç†ã‚’è¡Œã†
            if (roundNum < finalRound) {
                const matchNum = parseInt(idParts[2].slice(1));
                const nextRoundNum = roundNum + 1;
                let nextMatchId = (nextRoundNum === finalRound) ? 'F-R1-M1' : `${side}-R${nextRoundNum}-M${Math.ceil(matchNum / 2)}`;

                // æ¬¡ã®è©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãªã‘ã‚Œã°ä½œæˆ
                if (!tournamentState.matches[nextMatchId]) {
                    tournamentState.matches[nextMatchId] = { id: nextMatchId, team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '' };
                }

                // å‹è€…ã‚’æ¬¡ã®è©¦åˆã®æ­£ã—ã„ã‚¹ãƒ­ãƒƒãƒˆ (team1 or team2) ã«æ›¸ãè¾¼ã‚€
                let slot;
                if (nextRoundNum === finalRound) { // æ¬¡ãŒæ±ºå‹ã®å ´åˆ
                    slot = (side === 'L' ? 1 : 2); // å·¦ãªã‚‰team1, å³ãªã‚‰team2
                } else { // æ±ºå‹ä»¥å¤–ã®å ´åˆ
                    slot = (matchNum % 2 !== 0 ? 1 : 2); // å¥‡æ•°è©¦åˆãªã‚‰team1, å¶æ•°è©¦åˆãªã‚‰team2
                }
                tournamentState.matches[nextMatchId][`team${slot}`] = winnerName;

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ  â–¼â–¼â–¼
                // æ¬¡ã®è©¦åˆã®ä¸¡ãƒãƒ¼ãƒ ãŒæƒã£ãŸã‹ãƒã‚§ãƒƒã‚¯
                const nextMatch = tournamentState.matches[nextMatchId];
                if (nextMatch.team1 && nextMatch.team2) {
                    nextMatch.rivalryType = checkRivalry(nextMatch.team1, nextMatch.team2);
                }
                // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
            }

        }
        // æ±ºå‹æˆ¦çµ‚äº†æ™‚ã®å‡¦ç†ã¯å¾Œç¶š (æ‰‹é †4ã®æœ€å¾Œ) ã«ç§»å‹•
    }
    // --- â˜…â˜…â˜… å‹è€…é€²è¡Œå‡¦ç†ã“ã“ã¾ã§ â˜…â˜…â˜… ---
    // â–²â–²â–² ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ â–²â–²â–²


    // --- 2. è©¦åˆå¾Œã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆãƒ†ã‚£ãƒƒã‚«ãƒ¼ã€ç§°å·ã€ã‚¹ã‚¿ãƒ¡ãƒ³è¨˜éŒ²ãªã©ï¼‰ ---
    const newHeadline = generateTickerHeadline({ winnerName, loserName, score1: dbMatch.score1, score2: dbMatch.score2 });
    if (newHeadline) {
        tournamentState.tickerHeadlines.unshift(newHeadline);
        if (tournamentState.tickerHeadlines.length > 20) tournamentState.tickerHeadlines.pop();
        updateTicker(); // ãƒ†ã‚£ãƒƒã‚«ãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
    }

    

    // ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒªãƒ³ã‚°ç§°å·ã®ä»˜ä¸åˆ¤å®š
    const winnerRank = calculateRank(winnerName, tournamentState);
    const loserRank = calculateRank(loserName, tournamentState);
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
    if ((rankValues[loserRank] - rankValues[winnerRank]) >= 2) { // ãƒ©ãƒ³ã‚¯å·®ãŒ2ä»¥ä¸Šã‚ã‚Œã°
        const winnerRecord = tournamentState.teamRecords[winnerName];
        if (winnerRecord && !winnerRecord.teamTraits.includes('giant_killer')) {
            winnerRecord.teamTraits.push('giant_killer'); // ç§°å·ã‚’è¿½åŠ 
        }
    }
// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    // --- ãƒãƒ¼ãƒ å…¨ä½“ã®æ‰“çƒã®è³ªã‚’é›†è¨ˆ ---
    let team1QualityText = "ï¼ˆæ‰“çƒå“è³ªãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰";
    let team2QualityText = "ï¼ˆæ‰“çƒå“è³ªãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰";
    
    if (dbMatch.details && dbMatch.details.playerGameStats) {
        const calculateQuality = (teamKey) => {
            const quality = { sH: 0, wH: 0, sO: 0, wO: 0, totalAB: 0 };
            const statsTeam = dbMatch.details.playerGameStats[teamKey] || {};
            for (const playerName in statsTeam) {
                const stats = statsTeam[playerName];
                quality.sH += stats.strongHits || 0;
                quality.wH += stats.weakHits || 0;
                quality.sO += stats.strongOuts || 0;
                quality.wO += stats.weakOuts || 0;
                quality.totalAB += stats.ab || 0;
            }
            return quality;
        };

        const team1Quality = calculateQuality('team1');
        const team2Quality = calculateQuality('team2');

        // AIãŒèª­ã¿ã‚„ã™ã„ã‚ˆã†ã«ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã™ã‚‹
        const formatQualityText = (teamName, quality) => {
            if (quality.totalAB === 0) return `(${teamName}: ãƒ‡ãƒ¼ã‚¿ãªã—)`;
            const totalHits = quality.sH + quality.wH;
            const totalOuts = quality.sO + quality.wO;
            return `(${teamName}: å®‰æ‰“${totalHits} (ã†ã¡é‹­ã„å½“ãŸã‚Š${quality.sH}æœ¬, è©°ã¾ã£ãŸå½“ãŸã‚Š${quality.wH}æœ¬) / å‡¡é€€${totalOuts} (ã†ã¡é‹­ã„å‡¡é€€${quality.sO}æœ¬, è©°ã¾ã£ãŸå‡¡é€€${quality.wO}æœ¬))`;
        };
        
        team1QualityText = formatQualityText(dbMatch.team1, team1Quality);
        team2QualityText = formatQualityText(dbMatch.team2, team2Quality);
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
    // --- 3. AIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆã®æº–å‚™ã¨å®Ÿè¡Œ ---
    // â˜…â˜…â˜… ã“ã®æ™‚ç‚¹ã§ findNextOpponent ãŒæ­£ã—ã„æƒ…å ±ã‚’å–å¾—ã§ãã‚‹ â˜…â˜…â˜…
    const matchContext = createMatchContext(matchId, winnerName, team1QualityText, team2QualityText);
    if (!matchContext) {
        console.error("AIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆã«å¿…è¦ãªmatchContextã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        renderTournament(tournamentState); // ã¨ã‚Šã‚ãˆãšç”»é¢ã¯æ›´æ–°
        saveState();
        return; // AIå‡¦ç†ã‚’ä¸­æ–­
    }

    let articlePromise = Promise.resolve(null);
    let commentsPromise = Promise.resolve(null);
let hadaReportPromise = Promise.resolve(null);
// â–¼â–¼â–¼ ã“ã®1è¡Œã‚’è¿½åŠ  â–¼â–¼â–¼
    let matomeThreadPromise = Promise.resolve(null);
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    // è¨­å®šã«å¿œã˜ã¦AIè¨˜äº‹ç”Ÿæˆã‚’é–‹å§‹
    if (tournamentState.settings.enableArticleGeneration) {
        newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒè¨˜äº‹ã‚’åŸ·ç­†ä¸­...</div>`;
        const documentary = tournamentState.documentary;

        // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼å¯¾è±¡ãƒãƒ¼ãƒ ã®è©¦åˆã‹ã©ã†ã‹ã§ç”Ÿæˆé–¢æ•°ã‚’åˆ‡ã‚Šæ›¿ãˆ
        if (documentary && documentary.target && (documentary.target === winnerName || documentary.target === loserName)) {
            const isWin = documentary.target === winnerName;
            const opponentName = isWin ? loserName : winnerName;
            const opponentData = TEAM_DATA[opponentName]; // TEAM_DATAã‹ã‚‰ç›¸æ‰‹æƒ…å ±ã‚’å–å¾—

            const matchInfoForArticle = {
                round: matchId.includes('-R') ? parseInt(matchId.split('-R')[1].split('-')[0]) : 1,
                opponent: opponentName,
                score: isWin ? `${dbMatch.score1}-${dbMatch.score2}` : `${dbMatch.score2}-${dbMatch.score1}`, // å‹è€…ã®ã‚¹ã‚³ã‚¢ãŒå…ˆ
                highlights: matchContext.highlights, // createMatchContextã§ç”Ÿæˆæ¸ˆã¿ã®ã‚‚ã®ã‚’ä½¿ç”¨
                summary: dbMatch.summary,
                opponentInfo: opponentData?.info || 'å¯¾æˆ¦ç›¸æ‰‹ã®æƒ…å ±ãªã—' // ç›¸æ‰‹ã®èƒŒæ™¯æƒ…å ±
            };

            articlePromise = generateDocumentaryArticle(isWin ? 'win' : 'lose', documentary.type, documentary.target, matchInfoForArticle);

            if (!isWin) tournamentState.documentary = { target: null, type: null }; // æ•—é€€ã—ãŸã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼çµ‚äº†
        } else {
            // é€šå¸¸ã®è¨˜äº‹ç”Ÿæˆ
            articlePromise = generateNewsArticle(matchContext);
        }
    }

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    // --- ç¾½ç”°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ (ç¢ºç‡ã§å®Ÿè¡Œ) ---
    const isNotableGame = (winnerRank === 'A' || winnerRank === 'B' || loserRank === 'A' || loserRank === 'B');

    if (tournamentState.settings.enableArticleGeneration && isNotableGame && Math.random() < 0.25) {
        // æ³¨ç›®æ ¡ã®è©¦åˆã®å ´åˆã€25%ã®ç¢ºç‡ã§ç¾½ç”°ãƒ¬ãƒãƒ¼ãƒˆã‚‚ç”Ÿæˆ
        hadaReportPromise = generateHadaReport(matchContext);
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    // è¨­å®šã«å¿œã˜ã¦AIæ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚’é–‹å§‹
    if (tournamentState.settings.enableBbsGeneration) {
        bbsCommentsContainer.innerHTML = `<div class="loader">AIãŒæ²ç¤ºæ¿ã‚’ç›£è¦–ä¸­...</div>`;
        commentsPromise = generateBbsComments(matchContext); // ä¿®æ­£æ¸ˆã¿é–¢æ•°ã‚’å‘¼ã³å‡ºã—
// â–¼â–¼â–¼ ã“ã®1è¡Œã‚’è¿½åŠ  â–¼â–¼â–¼
        matomeThreadPromise = generateGameMatchBbsComments(matchContext); // â˜…ã¾ã¨ã‚ã‚¹ãƒ¬ã‚‚ã“ã“ã§ç”Ÿæˆ
        // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
    }

    // --- 4. ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆé€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ (ç§‹å­£ãƒ»æ˜¥å­£ã®ç‰¹æ®Šå‡¦ç†) ---
    // â˜…â˜…â˜… ä¸Šã§å®Ÿè¡Œæ¸ˆã¿ã® Summer/Main Tournament ä»¥å¤–ã®é€²è¡Œå‡¦ç†ãŒã“ã“ã«æ¥ã‚‹ â˜…â˜…â˜…
    if (tournamentState.currentTournament === 'autumn' && tournamentState.autumnPhase !== 'main') {
        // ç§‹å­£åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸ã®å‹è€…é€²è¡Œ
        const [region, bracketId, roundStr, matchStr] = matchId.split('-');
        if (bracketId.startsWith('B')) { // é€šå¸¸ã®ãƒ–ãƒ­ãƒƒã‚¯
            const block = tournamentState.autumnData.regions[region].blocks.find(b => b.id === `${region}-${bracketId}`);
            if (block) {
                const roundNum = parseInt(roundStr.slice(1));
                const matchNum = parseInt(matchStr.slice(1));
                if (roundNum === 0) { // ãƒ—ãƒ¬ã‚¤ã‚¤ãƒ³ãƒãƒƒãƒ
                    block.matches[`${block.id}-R1-M1`].team1 = winnerName;
                } else if (roundNum === 1) { // æº–æ±ºå‹
                    const finalMatch = block.matches[`${block.id}-R2-M1`];
                    if (matchNum === 1) finalMatch.team1 = winnerName; else finalMatch.team2 = winnerName;
                } else if (roundNum === 2) { // æ±ºå‹
                    tournamentState.autumnData.regions[region].blockWinners.push(winnerName);
                    tournamentState.autumnData.regions[region].blockRunnersUp.push(loserName);
                }
            }
        } else if (bracketId === 'AUTUMN' && region === 'ä¼Šè±†') { // ä¼Šè±†åœ°åŒº
             const izuBracket = tournamentState.autumnData.regions['ä¼Šè±†'].izuBracket;
             if(izuBracket){
                const roundNum = parseInt(roundStr.slice(1));
                const matchNum = parseInt(matchStr.slice(1));
                if (roundNum === 1) { // æº–æ±ºå‹
                    const finalMatch = izuBracket.matches[`${izuBracket.id}-R2-M1`];
                    if (matchNum === 1) finalMatch.team1 = winnerName; else finalMatch.team2 = winnerName;
                } else if (roundNum === 2) { // æ±ºå‹
                    tournamentState.autumnData.regions['ä¼Šè±†'].finalReps.push({ team: winnerName, rank: 1 });
                }
             }
        }
        // ç§‹å­£åœ°åŒºé †ä½æ±ºå®šæˆ¦ã®å‹è€…é€²è¡Œ
        else if (tournamentState.autumnPhase === 'regional_ranking') {
            const roundNum = parseInt(roundStr.slice(1));
            const matchNum = parseInt(matchStr.slice(1));
            const isChamp = bracketId === 'CHAMP'; // æœ¬æ¥ã¯å»ƒæ­¢ã•ã‚Œã¦ã„ã‚‹ãŒå¿µã®ãŸã‚
            const bracket = tournamentState.autumnData.regions[region]?.repechageBracket; // æ•—è€…å¾©æ´»ã®ã¿

            if (bracket && roundNum === 1) { // æ•—è€…å¾©æ´»1å›æˆ¦
                const finalMatch = bracket.matches[`${bracket.id}-R2-M1`]; // 5ä½æ±ºå®šæˆ¦
                if (matchNum === 1) finalMatch.team1 = winnerName; else finalMatch.team2 = winnerName;
            } else if (bracket && roundNum === 2) { // 5ä½æ±ºå®šæˆ¦
                tournamentState.autumnData.regions[region].finalReps.push({ team: winnerName, rank: 5 });
                // æ•—é€€ãƒãƒ¼ãƒ (loserName)ã®é †ä½ã¯è¨˜éŒ²ã—ãªã„ (çœŒå¤§ä¼šã«å‡ºã‚‰ã‚Œãªã„ãŸã‚)
            }
        }
    } else if (tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'regional_qualifiers') {
        // æ˜¥å­£åœ°åŒºäºˆé¸ã®å‹è€…é€²è¡Œ
        const [region, bracketType] = matchId.split('-');
        // ä»£è¡¨æ±ºå®šãƒ–ãƒ­ãƒƒã‚¯
        if (bracketType.startsWith('SB')) {
            const block = tournamentState.springData.regions[region].blocks.find(b => b.id === `${region}-${bracketType}`);
            if (block) {
                // æº–æ±ºå‹ä»¥å‰ã®è©¦åˆã®å ´åˆã€å‹è€…ã‚’æ±ºå‹ã«é€²ã‚ã‚‹
                if (matchId.includes('-R1-') || matchId.includes('-R0-')) {
                    // æ±ºå‹æˆ¦ã®IDã‚’è¦‹ã¤ã‘ã‚‹ (R2-M1 or R1-M1 for 2/3 team blocks)
                    const finalMatchKey = Object.keys(block.matches).find(k => k.includes('-R2-') || (Object.keys(block.matches).length <= 2 && k.includes('-R1-')));
                    if (finalMatchKey) {
                        const finalMatch = block.matches[finalMatchKey];
                        // ã©ã£ã¡ã®å±±ã‹ã‚‰æ¥ãŸã‹ã§ team1 or team2 ã«å…¥ã‚Œã‚‹
                        if (matchId.endsWith('M1')) finalMatch.team1 = winnerName; else finalMatch.team2 = winnerName;
                    }
                } else { // æ±ºå‹æˆ¦ã®å ´åˆã€æ•—è€…ã‚’æ•—è€…å¾©æ´»ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã«é€ã‚‹
                    const repBracket = tournamentState.springData.regions[region].repechageBracket;
                    repBracket.teams.push(loserName); // æ•—è€…å¾©æ´»ã«å‚åŠ ã™ã‚‹ãƒãƒ¼ãƒ ãƒªã‚¹ãƒˆã«è¿½åŠ 
                    // æ•—è€…å¾©æ´»ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®ç©ºãã‚¹ãƒ­ãƒƒãƒˆã«æ•—è€…ã‚’ã‚»ãƒƒãƒˆ
                    if (repBracket.teams.length === 1) repBracket.matches[`${repBracket.id}-R1-M1`].team1 = loserName;
                    if (repBracket.teams.length === 2) repBracket.matches[`${repBracket.id}-R1-M1`].team2 = loserName;
                    if (repBracket.teams.length === 3) repBracket.matches[`${repBracket.id}-R1-M2`].team1 = loserName;
                    if (repBracket.teams.length === 4) repBracket.matches[`${repBracket.id}-R1-M2`].team2 = loserName;
                }
            }
        }
        // ç¬¬5ä»£è¡¨æ±ºå®šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ (æ•—è€…å¾©æ´»)
        else if (bracketType.startsWith('SREP')) {
             const repBracket = tournamentState.springData.regions[region].repechageBracket;
             if (repBracket){
                const finalMatch = repBracket.matches[`${repBracket.id}-R2-M1`]; // ä»£è¡¨æ±ºå®šæˆ¦
                 // 1å›æˆ¦ã®å‹è€…ã‚’ä»£è¡¨æ±ºå®šæˆ¦ã«é€²ã‚ã‚‹
                if (matchId.endsWith('M1')) finalMatch.team1 = winnerName;
                if (matchId.endsWith('M2')) finalMatch.team2 = winnerName;
             }
        }
        // ä¼Šè±†åœ°åŒºäºˆé¸
        else if (bracketType.startsWith('SIZU')) {
            const izuBracket = tournamentState.springData.regions['ä¼Šè±†'].izuBracket;
            if(izuBracket){
                const finalMatch = izuBracket.matches[`${izuBracket.id}-R2-M1`]; // æ±ºå‹æˆ¦
                // æº–æ±ºå‹ã®å‹è€…ã‚’æ±ºå‹ã«é€²ã‚ã‚‹
                 if (izuBracket.teams.length === 3 && matchId.includes('-R1-')) { // 3ãƒãƒ¼ãƒ ã®å ´åˆã®æº–æ±ºå‹
                     finalMatch.team1 = winnerName; // ä¸æˆ¦å‹ã® team2 ã¯ setupSpringRegionalQualifiers ã§è¨­å®šæ¸ˆã¿
                 } else if (matchId.endsWith('M1')) { // 4ãƒãƒ¼ãƒ ã®å ´åˆã®æº–æ±ºå‹1
                     finalMatch.team1 = winnerName;
                 } else if (matchId.endsWith('M2')) { // 4ãƒãƒ¼ãƒ ã®å ´åˆã®æº–æ±ºå‹2
                     finalMatch.team2 = winnerName;
                 }
            }
        }
    }
    // æ±ºå‹æˆ¦çµ‚äº†æ™‚ã®å¾Œå‡¦ç† (å…ˆã«å‹è€…é€²è¡Œå‡¦ç†ã‚’è¡Œã£ãŸãŸã‚ã€ã“ã“ã§ã¯æœ€çµ‚æˆç¸¾è¨˜éŒ²ã¨ç”²å­åœ’/ã‚»ãƒ³ãƒãƒ„å‡¦ç†ã®ã¿)
    else if (matchId.startsWith('F-R1-M1')) {
        updateTournamentFinishRecords(); // å…¨ãƒãƒ¼ãƒ ã®æœ€çµ‚é †ä½ã‚’è¨˜éŒ²

        if (tournamentState.currentTournament === 'summer') {
            // å¤å¤§ä¼šå„ªå‹ â†’ ç”²å­åœ’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            const winnerRecord = tournamentState.teamRecords[winnerName];
            if (winnerRecord) { // å¿µã®ãŸã‚å­˜åœ¨ç¢ºèª
                const winnerRank = calculateRank(winnerName, tournamentState);
                const koshienResultKey = simulateKoshien(winnerRank); // ãƒ©ãƒ³ã‚¯ã«åŸºã¥ãç”²å­åœ’ã®çµæœã‚’æ±ºå®š
                const koshienResult = KOSHIEN_RESULTS[koshienResultKey];
                winnerRecord.lastFinish = koshienResult.rank; // æœ€çµ‚æˆç¸¾ã‚’ç”²å­åœ’ã®ã‚‚ã®ã«æ›´æ–°
                const newHistoryRecord = { year: tournamentState.tournamentYear, tournament: 'summer_koshien', rank: koshienResult.rank }; // 'summer_koshien' ã¨ã—ã¦è¨˜éŒ²
                winnerRecord.history.unshift(newHistoryRecord); // å±¥æ­´ã«è¿½åŠ 
                // æœ€é«˜æˆç¸¾ã‚‚æ›´æ–°
                if (!winnerRecord.best || newHistoryRecord.rank < winnerRecord.best.rank) {
                    winnerRecord.best = newHistoryRecord;
                }
                // ç”²å­åœ’çµæœã®è¨˜äº‹ç”Ÿæˆã‚’éåŒæœŸã§é–‹å§‹ (å®Œäº†ã‚’å¾…ãŸãªã„)
                generateKoshienSummaryArticle(winnerName, koshienResult.label, 'summer')
                    .then(koshienArticle => {
                        if(koshienArticle) {
                            tournamentState.news.push(koshienArticle);
                            renderNews(tournamentState.news); // è¨˜äº‹ãŒã§ããŸã‚‰å†æç”»
                            saveState(); // ä¿å­˜
                        }
                    });
            }
        } else if (tournamentState.currentTournament === 'autumn') {
            // ç§‹å¤§ä¼šå„ªå‹/æº–å„ªå‹ â†’ ã‚»ãƒ³ãƒãƒ„é¸å‡ºåˆ¤å®š
            tournamentState.senbatsuTeams = []; // ãƒªã‚»ãƒƒãƒˆ
            const finalists = [winnerName, loserName];
            const selectionPromises = finalists.map(async (teamName) => {
                // 70%ã®ç¢ºç‡ã§é¸å‡º (ä»®ã®ç¢ºç‡)
                if (Math.random() < 0.70) {
                    tournamentState.senbatsuTeams.push(teamName);
                    // é¸å‡ºè¨˜äº‹ç”Ÿæˆã‚’éåŒæœŸã§é–‹å§‹
                    const senbatsuArticle = await generateKoshienSummaryArticle(teamName, 'ã‚»ãƒ³ãƒãƒ„å‡ºå ´æ±ºå®š', 'tokai'); // 'tokai' ã‚¿ã‚¤ãƒ—ã§å‘¼ã³å‡ºã—
                    if (senbatsuArticle) {
                        tournamentState.news.push(senbatsuArticle);
                    }
                }
            });
            // å…¨ã¦ã®é¸å‡ºè¨˜äº‹ç”ŸæˆãŒçµ‚ã‚ã‚‹ã®ã‚’å¾…ã¤
            await Promise.all(selectionPromises);
            // è¨˜äº‹ãŒã§ããŸã‚‰å†æç”»ãƒ»ä¿å­˜
            renderNews(tournamentState.news);
            saveState();
        }
    }

// --- 5. AIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å‡¦ç†ã¨æœ€çµ‚çš„ãªç”»é¢æ›´æ–° ---
  // â–¼â–¼â–¼ ã“ã® Promise.all ã‚’ä¿®æ­£ â–¼â–¼â–¼
    const [generatedArticle, generatedComments, generatedHadaReport, generatedMatomeThread] = await Promise.all([
        articlePromise, 
        commentsPromise,
        hadaReportPromise,
        matomeThreadPromise // â˜…è¿½åŠ 
    ]);
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    // â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ BBSã‚³ãƒ¡ãƒ³ãƒˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ä¿®æ­£ â–¼â–¼â–¼
    if (generatedComments) {
        // AIãŒé…åˆ—ã‚’è¿”ã—ã€ã‹ã¤ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å«ã¾ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        if (Array.isArray(generatedComments) && !generatedComments.some(c => c.error)) {
            const validComments = generatedComments.filter(comment => !comment.error);
            if (validComments.length > 0) {
                tournamentState.bbsComments.push(...validComments); // æˆåŠŸã‚³ãƒ¡ãƒ³ãƒˆã‚’BBSã«è¿½åŠ 
            }
        // AIãŒé…åˆ—ã‚’è¿”ã—ãŸãŒã€ä¸­ã«ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå«ã¾ã‚Œã‚‹å ´åˆã®å‡¦ç†
        } else if (Array.isArray(generatedComments)) {
            const errorCommentData = generatedComments.find(comment => comment.error);
            if (errorCommentData && errorCommentData.context) {
                // â˜…â˜…â˜… å¤‰æ›´ç‚¹: newsã§ã¯ãªãbbsCommentsã«ã‚¨ãƒ©ãƒ¼ã‚’è¿½åŠ  â˜…â˜…â˜…
                tournamentState.bbsComments.push({
                    title: "æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼", // renderBbsCommentsã§è¡¨ç¤ºã™ã‚‹ãŸã‚titleã‚’è¿½åŠ 
                    body: "AIã«ã‚ˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã«ä¸€éƒ¨å¤±æ•—ã—ã¾ã—ãŸã€‚", // bodyã¯ä½¿ã‚ã‚Œãªã„ãŒä¸€å¿œä¿æŒ
                    timestamp: Date.now(),
                    error: true,
                    errorId: `error-${matchId}-bbs-partial`,
                    context: errorCommentData.context
                });
            }
        // AIãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã®ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ãŸå ´åˆ (ä¾‹: { error: true, ... })
        } else if (generatedComments.error) {
            // â˜…â˜…â˜… å¤‰æ›´ç‚¹: newsã§ã¯ãªãbbsCommentsã«ã‚¨ãƒ©ãƒ¼ã‚’è¿½åŠ  â˜…â˜…â˜…
            tournamentState.bbsComments.push({
                title: generatedComments.title || "æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼",
                body: generatedComments.body || "AIã«ã‚ˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(),
                error: true,
                errorId: generatedComments.errorId || `error-${matchId}-bbs`,
                context: generatedComments.context || matchContext
            });
        // äºˆæœŸã—ãªã„å½¢å¼ã®å ´åˆ
        } else {
            console.error("Unexpected format from generateBbsComments:", generatedComments);
            // â˜…â˜…â˜… å¤‰æ›´ç‚¹: newsã§ã¯ãªãbbsCommentsã«ã‚¨ãƒ©ãƒ¼ã‚’è¿½åŠ  â˜…â˜…â˜…
            tournamentState.bbsComments.push({ title: "æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆå½¢å¼ã‚¨ãƒ©ãƒ¼", body:"äºˆæœŸã—ãªã„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™ã€‚", timestamp: Date.now(), error: true, context: matchContext });
        }
    }
    // â–²â–²â–² BBSã‚³ãƒ¡ãƒ³ãƒˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²  

    // --- è¨˜äº‹ã®å‡¦ç† (å¤‰æ›´ãªã—) ---
    if (generatedArticle) {
        if (!generatedArticle.error) {
             generatedArticle.context = matchContext;
             showArticleReviewModal(generatedArticle);
        } else {
            // ã‚¨ãƒ©ãƒ¼è¨˜äº‹ã‚’ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã«è¿½åŠ 
            const errorArticle = {
                title: generatedArticle.title || "è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼",
                body: generatedArticle.body || "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(),
                error: true,
                errorId: matchContext.matchId || 'error',
                context: matchContext
            };
            tournamentState.news.push(errorArticle);
        }
    }

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    // --- ç¾½ç”°ãƒ¬ãƒãƒ¼ãƒˆã®å‡¦ç† ---
    if (generatedHadaReport) {
        // æˆåŠŸã—ã¦ã‚‚å¤±æ•—ã—ã¦ã‚‚ã€newsé…åˆ—ã«è¿½åŠ ã™ã‚‹
        tournamentState.news.push(generatedHadaReport);
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// --- ã¾ã¨ã‚ã‚¹ãƒ¬ãƒƒãƒ‰ã®å‡¦ç† (æ–°è¨­) ---
    if (generatedMatomeThread) {
        // æˆåŠŸï¼ˆã‚³ãƒ¡ãƒ³ãƒˆé…åˆ—ï¼‰ã—ã¦ã‚‚å¤±æ•—ï¼ˆã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã—ã¦ã‚‚ã€matchIdã‚’ã‚­ãƒ¼ã«ä¿å­˜ã™ã‚‹
        tournamentState.matomeThreads[matchId] = {
            thread: generatedMatomeThread, // ã‚¹ãƒ¬ãƒƒãƒ‰æœ¬ä½“ï¼ˆã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ï¼‰
            context: matchContext         // â˜…å†ç”Ÿæˆç”¨ã®ã€Œè©¦åˆçµ‚äº†æ™‚ã®æƒ…å ±ã€
        };
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    // --- ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«ã€ç”»é¢æ›´æ–°ã€ä¿å­˜å‡¦ç† (å¤‰æ›´ãªã—) ---
    if (!tournamentState.activeScandal && Math.random() < 0.1) {
        triggerScandalEvent(winnerName, loserName);
    }

    renderTournament(tournamentState); // ã“ã®ä¸­ã§ renderBbsComments ãŒå‘¼ã°ã‚Œã‚‹
// å‹è€…ã¨æ•—è€…ã®å‰å›ã®ã‚¹ã‚¿ãƒ¡ãƒ³æƒ…å ±ã‚’è¨˜éŒ² (è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ)
    // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆ â–¼â–¼â–¼
    // --- è©¦åˆå¾Œã®ãƒ­ã‚¹ã‚¿ãƒ¼æƒ…å ±ï¼ˆèƒŒç•ªå·ã€ãƒã‚¸ã‚·ãƒ§ãƒ³ã€æŠ•æ‰“ï¼‰ã‚’è¨˜éŒ² ---
    if (dbMatch.details && dbMatch.details.batting) {
        for (const teamKey of ['team1', 'team2']) {
            const teamName = dbMatch[teamKey];
            const teamRecord = tournamentState.teamRecords[teamName];
            const battingData = dbMatch.details.batting[teamKey];
            
            if (teamRecord && battingData && battingData.length > 0) {
                // 1. ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´æ¤œçŸ¥ç”¨ã«ã€Œã‚¹ã‚¿ãƒ¡ãƒ³ã€ã ã‘ã‚’ previousStarters ã«ä¿å­˜ (æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯)
                teamRecord.previousStarters = battingData
                    .filter(p => p.order && !p.order.toString().includes('sub'))
                    .map(p => ({ order: p.order, name: p.name, pos: p.pos }));
                
                // 2. ã€Œå…¨é¸æ‰‹ã€ã®æƒ…å ±ã‚’ teamRoster ã«ä¿å­˜ (â˜…æ–°æ©Ÿèƒ½â˜…)
                // (æ‰“å¸­çµæœ(results)ã‚„å¤‰é·(posHistoryDisplay)ã‚’é™¤å¤–ã—ã€åŸºæœ¬æƒ…å ±ã®ã¿ã‚’ä¿å­˜)
                teamRecord.roster = battingData.map(p => ({
                    order: p.order,
                    name: p.name,
                    number: p.number,
                    pos: p.currentPos || p.pos, // â˜…å¤‰é·å¾Œã®æœ€æ–°ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
                    throwBat: p.throwBat,
                    sub_type: p.sub_type
                }));
            }
        }
    }
    // â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    // --- 6. è©¦åˆçµæœã«åŸºã¥ãã€é¸æ‰‹ã®ã€Œä¸€æ™‚çš„ãªçŠ¶æ…‹ç•°å¸¸ã€ãƒ•ãƒ©ã‚°ã‚’ä»˜ä¸ ---
    if (dbMatch.details && dbMatch.details.playerGameStats) {
        for (const teamKey of ['team1', 'team2']) {
            const teamName = dbMatch[teamKey];
            const teamRecord = tournamentState.teamRecords[teamName];
            if (!teamRecord) continue;

            // â–¼â–¼â–¼ æ‰“æ’ƒãƒ•ãƒ©ã‚°ã®ä»˜ä¸ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ â–¼â–¼â–¼
            const battingStats = dbMatch.details.playerGameStats[teamKey] || {};
            for (const playerName in battingStats) {
                const stats = battingStats[playerName];
                const careerStats = teamRecord.playerStats.batting[playerName];
                if (!stats || !careerStats) continue;

                // 4æ‰“æ•°0å®‰æ‰“ã§ã‚‚ã€"é‹­ã„å‡¡é€€(strongOuts)"ãŒå¤šã‘ã‚Œã° "ä¸æŒ¯(slumping)" ã«ã—ãªã„
                if (stats.ab >= 4 && stats.h === 0 && stats.strongOuts <= 1) {
                    careerStats.narrative_flag = "slumping"; // 4ã‚¿ã‚³ä»¥ä¸Šã§ã€ã‹ã¤é‹­ã„å½“ãŸã‚ŠãŒå°‘ãªã‹ã£ãŸå ´åˆã®ã¿ä¸æŒ¯
                }
                // 3å®‰æ‰“ä»¥ä¸Šã§ã‚‚ã€"è©°ã¾ã£ãŸãƒ’ãƒƒãƒˆ(weakHits)"ãŒå¤šã‘ã‚Œã° "çµ¶å¥½èª¿(hot_streak)" ã«ã—ãªã„
                else if (stats.h >= 3 && stats.weakHits <= 1) {
                    careerStats.narrative_flag = "hot_streak"; // çŒ›æ‰“è³ã§ã€ã‹ã¤è©°ã¾ã£ãŸå½“ãŸã‚ŠãŒå°‘ãªã‹ã£ãŸå ´åˆã®ã¿çµ¶å¥½èª¿
                }
                else if (stats.hr >= 1) careerStats.narrative_flag = "powered_up"; // HR (ã“ã‚Œã¯å‹¢ã„é–¢ä¿‚ãªã—)
                else if (stats.rbi >= 3) careerStats.narrative_flag = "clutch_hitter"; // å›ºã‚æ‰“ã¡ (ã“ã‚Œã‚‚å‹¢ã„é–¢ä¿‚ãªã—)
            }
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

            // â–¼â–¼â–¼ æŠ•æ‰‹ãƒ•ãƒ©ã‚°ã®ä»˜ä¸ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ â–¼â–¼â–¼
            const pitchingData = dbMatch.details.pitching?.[teamKey] || [];
            pitchingData.forEach(pitcher => {
                const careerStats = teamRecord.playerStats.pitching[pitcher.name];
                if (!careerStats) return;

                // ç›¸æ‰‹æ‰“ç·šã®æ‰“çƒã®å‹¢ã„ã‚’é›†è¨ˆ
                const opponentTeamKey = teamKey === 'team1' ? 'team2' : 'team1';
                const opponentBattingStats = dbMatch.details.playerGameStats[opponentTeamKey] || {};
                let totalStrongOuts = 0;
                let totalWeakOuts = 0;
                let totalStrongHits = 0;
                for (const oppPlayerName in opponentBattingStats) {
                    const oppStats = opponentBattingStats[oppPlayerName];
                    totalStrongOuts += oppStats.strongOuts || 0;
                    totalWeakOuts += oppStats.weakOuts || 0;
                    totalStrongHits += oppStats.strongHits || 0;
                }

                const innings = parseFloat(pitcher.innings || 0);
                const earnedRuns = parseInt(pitcher.earnedRuns || 0);
                const strikeouts = parseInt(pitcher.strikeouts || 0);

                if (pitcher.result === 'W' && innings >= 7 && earnedRuns === 0) careerStats.narrative_flag = "dominant"; // å®Œå° (å¤‰æ›´ãªã—)
                else if (strikeouts >= 10) careerStats.narrative_flag = "dominant"; // 2æ¡å¥ªä¸‰æŒ¯ (å¤‰æ›´ãªã—)
                else if (pitcher.result === 'W' && totalWeakOuts >= 5) careerStats.narrative_flag = "crafty_pitcher"; // è©°ã¾ã‚‰ã›ã‚‹æŠ€å·§æ´¾
                else if (pitcher.result === 'L' && totalStrongHits >= 5) careerStats.narrative_flag = "unlucky"; // é‹ãŒæ‚ªã„ (é‹­ã„å½“ãŸã‚Šã‚’æ‰“ãŸã‚Œã™ã)
                else if (pitcher.result === 'L' && earnedRuns >= 5) careerStats.narrative_flag = "seeking_redemption"; // ç‚ä¸Š (å¤‰æ›´ãªã—)
                else if (pitcher.result === 'L' && innings >= 7 && earnedRuns <= 2) careerStats.narrative_flag = "tough_loss"; // å­¤è»å¥®é—˜ (å¤‰æ›´ãªã—)
            });
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
        }
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    saveState();

    // --- æ˜¥å­£å¤§ä¼šã®é€²è¡Œç¢ºèª (å¤‰æ›´ãªã—) ---
    if (tournamentState.currentTournament === 'spring' && tournamentState.springPhase === 'main_round1') {
        const round1Matches = Object.values(tournamentState.matches).filter(m => m.id.includes('-R1-'));
        if (round1Matches.length === 8 && round1Matches.every(m => m.winner)) {
            const confirmed = await showConfirm("1å›æˆ¦ãŒã™ã¹ã¦çµ‚äº†ã—ã¾ã—ãŸã€‚ã‚·ãƒ¼ãƒ‰æ ¡ãŒç™»å ´ã™ã‚‹2å›æˆ¦ã«é€²ã¿ã¾ã™ã‹ï¼Ÿ");
            if (confirmed) {
                await setupSpringMainTournament_Round2();
            }
        }
    }
} // processMatchWin é–¢æ•°ã®çµ‚äº†
// processMatchWin é–¢æ•°ã®çµ‚äº†
// â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
/**
 * ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç”Ÿã•ã›ã‚‹
 * @param {string} winnerName 
 * @param {string} loserName 
 */
function triggerScandalEvent(winnerName, loserName) {
    const potentialTargets = [winnerName, loserName];
    const eligibleScandals = [];

    for (const team of potentialTargets) {
        for (const scandal of SCANDAL_DEFINITIONS) {
            if (scandal.condition(team)) {
                eligibleScandals.push({ team, scandal });
            }
        }
    }

    if (eligibleScandals.length > 0) {
        const selected = eligibleScandals[Math.floor(Math.random() * eligibleScandals.length)];
        
        tournamentState.activeScandal = {
            teamName: selected.team,
            scandalId: selected.scandal.id
        };

        // â–¼â–¼â–¼ ã“ã®éƒ¨åˆ†ã‚’ä¿®æ­£ â–¼â–¼â–¼
        const rumorArticle = {
            title: selected.scandal.rumorTitle(selected.team), // é–¢æ•°ã¨ã—ã¦å‘¼ã³å‡ºã—ã€teamNameã‚’æ¸¡ã™
            body: selected.scandal.rumorBody(selected.team),   // é–¢æ•°ã¨ã—ã¦å‘¼ã³å‡ºã—ã€teamNameã‚’æ¸¡ã™
            timestamp: Date.now(),
            isScandalRumor: true
        };
        // â–²â–²â–² ã“ã“ã¾ã§ä¿®æ­£ â–²â–²â–²

        tournamentState.news.push(rumorArticle);
        renderNews(tournamentState.news);
        saveState();
    }
}
// â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–²

// --- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
let articleForReview = null; // ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚çš„ã«ä¿æŒã™ã‚‹

/**
 * AIãŒç”Ÿæˆã—ãŸè¨˜äº‹ã‚’ç¢ºèªãƒ»ç·¨é›†ã™ã‚‹ãŸã‚ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
 * @param {object} article - AIãŒç”Ÿæˆã—ãŸè¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function showArticleReviewModal(article) {
    articleForReview = article; // è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ä¿å­˜

    document.getElementById('review-title').value = article.title;
    document.getElementById('review-body').value = article.body.replace(/\\n/g, '\n');
    
    document.getElementById('review-modal').classList.remove('hidden');
}

/**
 * ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
 */
function closeReviewModal() {
    articleForReview = null;
    document.getElementById('review-modal').classList.add('hidden');
}

// --- éŠã³æ–¹èª¬æ˜æ›¸ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('help-modal');
    const helpModalClose = document.getElementById('help-modal-close');

    helpBtn.addEventListener('click', () => {
        helpModal.classList.remove('hidden');
    });
    helpModalClose.addEventListener('click', () => {
        helpModal.classList.add('hidden');
    }); 


// â–¼â–¼â–¼ æŠ½é¸ä¼šã‚¤ãƒ™ãƒ³ãƒˆé–¢é€£ã®é–¢æ•°ç¾¤ â–¼â–¼â–¼

const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

/**
 * åŠ¹æœéŸ³ã‚’èª­ã¿è¾¼ã‚€
 */
async function loadSoundEffects() {
    try {
        const drumroll = new Audio("https://actions.google.com/sounds/v1/sports/drum_roll_long.ogg");
        const cheer = new Audio("https://actions.google.com/sounds/v1/crowds/battle_crowd_cheer_med.ogg");
        const gasp = new Audio("https://actions.google.com/sounds/v1/human_sounds/gasp.ogg");
        soundEffects = { drumroll, cheer, gasp };
    } catch (e) {
        console.error("åŠ¹æœéŸ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
    }
}

/**
 * æŠ½é¸ä¼šã‚¤ãƒ™ãƒ³ãƒˆã‚’é–‹å§‹ã™ã‚‹
 * (â˜…ã‚·ãƒ¼ãƒ‰æ ¡ã®ãƒ©ãƒ³ã‚¯æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã—ãŸæœ€çµ‚ç‰ˆ)
 */
async function startLotteryEvent() {
    const lotteryModal = document.getElementById('lottery-modal');
    lotteryModal.classList.remove('hidden');
    lotteryModal.classList.add('flex');

    // â–¼â–¼â–¼ ã‚·ãƒ¼ãƒ‰æ ¡æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ã‚’ (createNewTournamentã‹ã‚‰) ã“ã“ã«ç§»å‹• â–¼â–¼â–¼
    const historicalRanks = INITIAL_TEAM_POOL.map(teamName => ({ name: teamName, rank: getRankFromHistoryString(TEAM_DATA[teamName].last) }));
    historicalRanks.sort((a, b) => a.rank - b.rank); // TEAM_DATAã®æˆç¸¾é †
    // ã‚·ãƒ¼ãƒ‰æ ¡ã«ãƒ©ãƒ³ã‚¯1ã€œ8ã‚’ä»˜ä¸
    const seeds = historicalRanks.slice(0, 8).map((t, i) => ({ team: t.name, rank: i + 1 })); 
    // â–²â–²â–² ã‚·ãƒ¼ãƒ‰æ ¡æ±ºå®šã“ã“ã¾ã§ â–²â–²â–²
    
    // æŠ½é¸é †ã‚’æ±ºã‚ã‚‹ï¼ˆã‚·ãƒ¼ãƒ‰æ ¡ãŒå…ˆã€ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã¯ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰
    const seedTeamsList = seeds.map(s => s.team);
    const nonSeeds = INITIAL_TEAM_POOL.filter(t => !seedTeamsList.includes(t));
    const lotteryOrder = [...seedTeamsList, ...shuffleArray(nonSeeds)];

    // ç°¡æ˜“ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚’ä½œæˆ
    const leftBracket = document.getElementById('lottery-bracket-left');
    const rightBracket = document.getElementById('lottery-bracket-right');
    leftBracket.innerHTML = '';
    rightBracket.innerHTML = '';
    for(let i=0; i<64; i++){
        const slot = document.createElement('div');
        slot.className = 'lottery-slot';
        slot.dataset.index = i;
        slot.innerHTML = `<span>${i+1}.</span> <span class="team-name-placeholder">---</span>`;
        document.getElementById(i < 32 ? 'lottery-bracket-left' : 'lottery-bracket-right').appendChild(slot);
    }

    // ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    document.getElementById('start-lottery-btn').onclick = () => runLotteryAnimation(lotteryOrder, seeds); // â˜…ãƒ©ãƒ³ã‚¯ä»˜ãseedsã‚’æ¸¡ã™
    
    document.getElementById('skip-lottery-btn').onclick = () => {
        lotteryModal.classList.add('hidden');
        SoundManager.stopBgm(); // ã‚¹ã‚­ãƒƒãƒ—æ™‚ã‚‚BGMã‚’åœæ­¢
        createNewTournament(false, 'summer'); // â˜…å¼•æ•°(predeterminedTeams)ãªã—ã§å‘¼ã¶
    };

    // BGMå†ç”Ÿé–‹å§‹
    SoundManager.startBgm();
}

/**
 * æŠ½é¸ä¼šã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹
 * (â˜…ç¬¬1-4ã‚·ãƒ¼ãƒ‰ã®å±±åˆ†ã‘é…ç½®ã«å¯¾å¿œã—ãŸæœ€çµ‚ç‰ˆ)
 * @param {Array<string>} lotteryOrder - å…¨ãƒãƒ¼ãƒ ã®æŠ½é¸é † (ã‚·ãƒ¼ãƒ‰æ ¡ãŒå…ˆ)
 * @param {Array<object>} seeds - ã‚·ãƒ¼ãƒ‰æ ¡8ãƒãƒ¼ãƒ ã®ãƒ©ãƒ³ã‚¯ä»˜ãã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—
 */
async function runLotteryAnimation(lotteryOrder, seeds) {
    // --- 1. åˆæœŸè¨­å®š ---
    document.getElementById('lottery-pot').onclick = null;
    document.getElementById('skip-lottery-btn').style.display = 'none';

    const commentaryEl = document.getElementById('lottery-commentary').querySelector('p');
    const drawnTeamContainer = document.getElementById('drawn-team-container');
    const drawnTeamEl = document.getElementById('drawn-team');
    const potEl = document.getElementById('lottery-pot');
    const potNameEl = document.getElementById('pot-name');
    
    const teamPositions = Array(64).fill(null);
    const seedPositionsTemplate = [0, 32, 16, 48, 8, 40, 24, 56]; // [Aé ­, Bé ­, Cé ­, Dé ­, ...]
    
    // â–¼â–¼â–¼ ã‚·ãƒ¼ãƒ‰é…ç½®ã‚¹ãƒ­ãƒƒãƒˆã®æº–å‚™ (â˜…å±±åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯é©ç”¨) â–¼â–¼â–¼
    
    // ãƒ©ãƒ³ã‚¯é †ã«ã‚½ãƒ¼ãƒˆã•ã‚ŒãŸãƒˆãƒƒãƒ—4ã‚·ãƒ¼ãƒ‰
    const rank1_4_teams_sorted = seeds.filter(s => s.rank <= 4).sort((a, b) => a.rank - b.rank);

    // [ç¬¬1ã‚·ãƒ¼ãƒ‰, ç¬¬2ã‚·ãƒ¼ãƒ‰, ç¬¬4ã‚·ãƒ¼ãƒ‰, ç¬¬3ã‚·ãƒ¼ãƒ‰] ã®é †ã«ä¸¦ã¹æ›¿ãˆã‚‹
    const rank1_4_teams = [
        rank1_4_teams_sorted[0], // ç¬¬1ã‚·ãƒ¼ãƒ‰
        rank1_4_teams_sorted[1], // ç¬¬2ã‚·ãƒ¼ãƒ‰
        rank1_4_teams_sorted[3], // ç¬¬4ã‚·ãƒ¼ãƒ‰
        rank1_4_teams_sorted[2]  // ç¬¬3ã‚·ãƒ¼ãƒ‰
    ].filter(Boolean);
    
    const rank5_8_teams = shuffleArray(seeds.filter(s => s.rank > 4));
    
    const rank1_4_positions = seedPositionsTemplate.slice(0, 4); // [0, 32, 16, 48]
    const rank5_8_positions = shuffleArray(seedPositionsTemplate.slice(4)); // [8, 40, 24, 56] ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    
    let availableNonSeedSlots = Array.from({length: 64}, (_, i) => i).filter(p => !seedPositionsTemplate.includes(p));
    // â–²â–²â–² æº–å‚™ã“ã“ã¾ã§ â–²â–²â–²
    
    const blockDeathAnnounced = { A: false, B: false, C: false, D: false };

    // --- (å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: playSound, isStrongRank, checkDeathBlock ã¯å¤‰æ›´ãªã—) ---
    const playSound = (id) => {
        const soundElement = document.getElementById(id);
        if (soundElement) {
            soundElement.currentTime = 0;
            soundElement.play().catch(e => console.warn(`Audio play failed for ${id}:`, e));
        }
    };
    const isStrongRank = (team) => ['A'].includes(calculateRank(team, {})); // Aãƒ©ãƒ³ã‚¯ã®ã¿
    const checkDeathBlock = (position) => {
        const blockName = position < 16 ? 'A' : position < 32 ? 'B' : position < 48 ? 'C' : 'D';
        const startIdx = position < 16 ? 0 : position < 32 ? 16 : position < 48 ? 32 : 48;
        if (blockDeathAnnounced[blockName]) return false;
        const teamsInBlock = teamPositions.slice(startIdx, startIdx + 16);
        const strongTeamsCount = teamsInBlock.filter(team => team && ['A', 'B'].includes(calculateRank(team, {}))).length; 
        if (strongTeamsCount >= 3) {
            commentaryEl.textContent = `ã“ã‚Œã¯...ï¼ ${blockName}ãƒ–ãƒ­ãƒƒã‚¯ã¯æœ‰åŠ›æ ¡ãŒé›†ä¸­ã™ã‚‹ã€Œæ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã€ã«ãªã‚Šã¾ã—ãŸï¼`;
            blockDeathAnnounced[blockName] = true;
            playSound('sound-gasp');
            return true;
        }
        return false;
    };
    // --- (å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã“ã“ã¾ã§) ---


    // --- 2. æŠ½é¸ä¼šãƒ•ã‚§ãƒ¼ã‚º1ï¼šã‚·ãƒ¼ãƒ‰æ ¡ã®é…ç½® ---
    potNameEl.textContent = "ã‚·ãƒ¼ãƒ‰æ ¡";
    
    // â–¼â–¼â–¼ ç¬¬1ã€œç¬¬4ã‚·ãƒ¼ãƒ‰ã®é…ç½® (å›ºå®šä½ç½®ãƒ»å±±åˆ†ã‘) â–¼â–¼â–¼
    for (let i = 0; i < rank1_4_teams.length; i++) {
        const teamName = rank1_4_teams[i].team;
        const teamRank = rank1_4_teams[i].rank;
        const position = rank1_4_positions[i]; // é †ç•ª [0, 32, 16, 48] ã«å›ºå®šä½ç½®ã‚’å–å¾—

        let dreadBg = null;
        if (isStrongRank(teamName)) {
            dreadBg = document.createElement('div');
            dreadBg.className = 'dread-mode-bg';
            document.body.appendChild(dreadBg);
            potEl.classList.add('dread');
            commentaryEl.textContent = `ä¼šå ´ãŒé™ã¾ã‚Šè¿”ã‚‹... ç¬¬${teamRank}ã‚·ãƒ¼ãƒ‰ã€ ${teamName} ã§ã™...`;
            await sleep(2500);
        }

        commentaryEl.textContent = `ç¬¬${teamRank}ã‚·ãƒ¼ãƒ‰ã€${teamName}ãŒã‚¯ã‚¸ã‚’å¼•ãã¾ã™...`;
        playSound('sound-drumroll');
        await sleep(1500);

        drawnTeamEl.textContent = teamName;
        drawnTeamContainer.classList.add('fade-in-out');
        teamPositions[position] = teamName;

        await sleep(1250);

        const targetSlot = document.querySelector(`.lottery-slot[data-index="${position}"]`);
        targetSlot.querySelector('.team-name-placeholder').textContent = `[${teamRank}] ${teamName}`;
        targetSlot.classList.add('filled', 'highlight'); 
        playSound('sound-cymbal');
        
        if (dreadBg) {
            dreadBg.remove();
            potEl.classList.remove('dread');
            playSound('sound-gasp');
        }
        
        commentaryEl.textContent = `ç¬¬${teamRank}ã‚·ãƒ¼ãƒ‰ã€${teamName}ã¯ ${position + 1}ç•ªã«æ±ºå®šï¼`;
        await sleep(1500);
        drawnTeamContainer.classList.remove('fade-in-out');
        targetSlot.classList.remove('highlight');
    }
    // â–²â–²â–² ç¬¬1ã€œç¬¬4ã‚·ãƒ¼ãƒ‰ã“ã“ã¾ã§ â–²â–²â–²

    // â–¼â–¼â–¼ ç¬¬5ã€œç¬¬8ã‚·ãƒ¼ãƒ‰ã®é…ç½® (ãƒ©ãƒ³ãƒ€ãƒ ä½ç½®) â–¼â–¼â–¼
    for (let i = 0; i < rank5_8_teams.length; i++) {
        const teamName = rank5_8_teams[i].team;
        const teamRank = rank5_8_teams[i].rank;
        const position = rank5_8_positions[i]; // ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ¸ˆã¿ã®æ®‹ã‚Šã®ã‚·ãƒ¼ãƒ‰ä½ç½®

        commentaryEl.textContent = `ç¬¬${teamRank}ã‚·ãƒ¼ãƒ‰ã€${teamName}ãŒã‚¯ã‚¸ã‚’å¼•ãã¾ã™...`;
        playSound('sound-drumroll');
        await sleep(1500);

        drawnTeamEl.textContent = teamName;
        drawnTeamContainer.classList.add('fade-in-out');
        teamPositions[position] = teamName;

        await sleep(1250);

        const targetSlot = document.querySelector(`.lottery-slot[data-index="${position}"]`);
        targetSlot.querySelector('.team-name-placeholder').textContent = `[${teamRank}] ${teamName}`;
        targetSlot.classList.add('filled', 'highlight');
        playSound('sound-cymbal');
        
        commentaryEl.textContent = `ç¬¬${teamRank}ã‚·ãƒ¼ãƒ‰ã€${teamName}ã¯ ${position + 1}ç•ªã«æ±ºå®šï¼`;
        await sleep(1500);
        drawnTeamContainer.classList.remove('fade-in-out');
        targetSlot.classList.remove('highlight');
    }
    // â–²â–²â–² ç¬¬5ã€œç¬¬8ã‚·ãƒ¼ãƒ‰ã“ã“ã¾ã§ â–²â–²â–²


    // --- 3. æŠ½é¸ä¼šãƒ•ã‚§ãƒ¼ã‚º2ï¼šãƒãƒ¼ã‚·ãƒ¼ãƒ‰æ ¡ã®é…ç½® (ãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´ãªã—) ---
    potNameEl.textContent = "ãƒãƒ¼ã‚·ãƒ¼ãƒ‰æ ¡";
    const nonSeeds = lotteryOrder.filter(t => !seeds.map(s => s.team).includes(t));
    for (const teamName of nonSeeds) {
        let dreadBg = null;
        if (isStrongRank(teamName)) { // Aãƒ©ãƒ³ã‚¯ã®ãƒãƒ¼ã‚·ãƒ¼ãƒ‰
            dreadBg = document.createElement('div');
            dreadBg.className = 'dread-mode-bg';
            document.body.appendChild(dreadBg);
            potEl.classList.add('dread');
            commentaryEl.textContent = `ä¼šå ´ãŒé™ã¾ã‚Šè¿”ã‚‹... ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã®å¼·è±ª ${teamName} ãŒç™»å ´...`;
            await sleep(2500);
        }

        commentaryEl.textContent = `${teamName}ãŒã‚¯ã‚¸ã‚’å¼•ãã¾ã™...`;
        playSound('sound-drumroll');
        await sleep(250);

        drawnTeamEl.textContent = teamName;
        drawnTeamContainer.classList.add('fade-in-out');

        const slotIndex = Math.floor(Math.random() * availableNonSeedSlots.length);
        const position = availableNonSeedSlots.splice(slotIndex, 1)[0];
        teamPositions[position] = teamName;
        
        await sleep(200);

        const targetSlot = document.querySelector(`.lottery-slot[data-index="${position}"]`);
        targetSlot.querySelector('.team-name-placeholder').textContent = teamName;
        targetSlot.classList.add('filled');
        playSound('sound-cymbal');
        
        if (dreadBg) {
            dreadBg.remove();
            potEl.classList.remove('dread');
            playSound('sound-gasp');
        }
        
        commentaryEl.textContent = `${teamName}ã¯ ${position + 1}ç•ª ã«æ±ºå®šï¼`;
        let didComment = checkDeathBlock(position);

        if (!didComment) {
            const opponentIndex = position % 2 === 0 ? position + 1 : position - 1;
            if(teamPositions[opponentIndex]) {
                const opponentName = teamPositions[opponentIndex];
                const opponentIsSeed = seeds.some(s => s.team === opponentName);
                
                const isRival = (isStrongRank(teamName) && opponentIsSeed) || 
                              (['A','B'].includes(calculateRank(teamName, {})) && ['A','B'].includes(calculateRank(opponentName, {})));

                if (isRival) {
                    commentaryEl.textContent = `æ±ºã¾ã£ãŸãƒ¼ï¼1å›æˆ¦ã‹ã‚‰å±ˆæŒ‡ã®å¥½ã‚«ãƒ¼ãƒ‰ï¼ ${teamName} vs ${opponentName}`;
                    playSound('sound-gasp');
                    document.querySelector(`.lottery-slot[data-index="${opponentIndex}"]`).classList.add('highlight');
                    targetSlot.classList.add('highlight');
                    await sleep(1500);
                    document.querySelector(`.lottery-slot[data-index="${opponentIndex}"]`).classList.remove('highlight');
                    targetSlot.classList.remove('highlight');
                }
            }
        }
        await sleep(250);
        drawnTeamContainer.classList.remove('fade-in-out');
    }

    // --- 4. çµ‚äº†å‡¦ç† ---
    commentaryEl.textContent = 'å…¨ã¦ã®çµ„ã¿åˆã‚ã›ãŒæ±ºå®šã—ã¾ã—ãŸï¼';
    await sleep(2000);
    
    await generateCaptainInterviews(teamPositions);
    
    // æœ€å¾Œã«ã€æ±ºå®šã—ãŸçµ„ã¿åˆã‚ã›(teamPositions)ã‚’æ¸¡ã—ã¦ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
    document.getElementById('lottery-modal').classList.add('hidden');
    SoundManager.stopBgm();
    createNewTournament(false, 'summer', teamPositions); 
}

/**
 * æŠ½é¸ä¼šå¾Œã®ä¸»å°†ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆãƒ»è¡¨ç¤ºã™ã‚‹ï¼ˆãƒ©ãƒ³ã‚¯å·®å¯¾å¿œãƒ»æœ€çµ‚ç‰ˆï¼‰
 * @param {Array<string>} teamPositions - æŠ½é¸ä¼šã§æ±ºå®šã—ãŸæœ€çµ‚çš„ãªãƒãƒ¼ãƒ ã®çµ„ã¿åˆã‚ã›
 */
async function generateCaptainInterviews(teamPositions) {
    const interviewModal = document.getElementById('interview-modal');
    const interviewContent = document.getElementById('interview-content');
    interviewContent.innerHTML = `<div class="loader">AIè¨˜è€…ãŒä¸»å°†ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆä¸­...</div>`;
    interviewModal.classList.remove('hidden');

    const matchups = [];
    for(let i=0; i<64; i+=2){
        matchups.push({team1: teamPositions[i], team2: teamPositions[i+1]});
    }

    // æ³¨ç›®ã‚«ãƒ¼ãƒ‰ã‚’3ã¤ã«å¢—ã‚„ã™
    const notableMatchups = shuffleArray(matchups).slice(0, 3);

    // â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ãŒæ–°ã—ã„å‡¦ç† â–¼â–¼â–¼
    const matchupsWithRanks = notableMatchups.map(m => ({
        team1: m.team1,
        rank1: calculateRank(m.team1, tournamentState),
        team2: m.team2,
        rank2: calculateRank(m.team2, tournamentState)
    }));
    const promptDataText = matchupsWithRanks.map(m => 
        `- ${m.team1} (ãƒ©ãƒ³ã‚¯: ${m.rank1}) vs ${m.team2} (ãƒ©ãƒ³ã‚¯: ${m.rank2})`
    ).join('\n');
    // â–²â–²â–²

    const prompt = `ã‚ãªãŸã¯é«˜æ ¡é‡çƒå°‚é–€ã®AIè¨˜è€…ã§ã™ã€‚å¤ã®å¤§ä¼šã®çµ„ã¿åˆã‚ã›æŠ½é¸ä¼šãŒçµ‚äº†ã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã€ä¸¡ãƒãƒ¼ãƒ ã®ä¸»å°†ã«ãªã‚Šãã£ã¦ã€æŠ½é¸çµæœã«å¯¾ã™ã‚‹ãƒªã‚¢ãƒ«ãªåå¿œã‚’èªã£ã¦ãã ã•ã„ã€‚

### æ³¨ç›®ã‚«ãƒ¼ãƒ‰ã¨å„ãƒãƒ¼ãƒ ã®ãƒ©ãƒ³ã‚¯
${promptDataText}

### ã‚ãªãŸãŒãªã‚Šãã‚‹ã€Œé«˜æ ¡ç”Ÿã®ä¸»å°†ã€ã®æ€è€ƒãƒ‘ã‚¿ãƒ¼ãƒ³
- **æ ¼ä¸‹ã®ç›¸æ‰‹ã¨å½“ãŸã£ãŸå ´åˆ (ä¾‹: Aãƒ©ãƒ³ã‚¯ vs Dãƒ©ãƒ³ã‚¯):**
  - å°‘ã—å®‰å µã—ãŸæ§˜å­ã‚’è¦‹ã›ã‚‹ã€‚ã€Œæ­£ç›´ã€ãƒ›ãƒƒã¨ã—ãŸã€ã€Œè‡ªåˆ†ãŸã¡ã®é‡çƒã‚’ã™ã‚Œã°è² ã‘ãªã„ã€
  - ã—ã‹ã—æ²¹æ–­ã¯ç¦ç‰©ã ã¨ä»˜ã‘åŠ ãˆã‚‹ã€‚ã€Œã©ã®ãƒãƒ¼ãƒ ã‚‚å¼·ã„ã®ã§ã€ä¸€æˆ¦å¿…å‹ã§æˆ¦ã„ãŸã„ã€
- **æ ¼ä¸Šã®ç›¸æ‰‹ã¨å½“ãŸã£ãŸå ´åˆ (ä¾‹: Eãƒ©ãƒ³ã‚¯ vs Aãƒ©ãƒ³ã‚¯):**
  - æ˜ã‚‰ã‹ã«çµ¶æœ›ã—ãŸã‚Šã€é©šã„ãŸã‚Šã™ã‚‹ã€‚ã€Œã¾ã•ã‹åˆæˆ¦ã§å½“ãŸã‚‹ã¨ã¯â€¦ã€ã€Œæ­£ç›´ã€å³ã—ã„ç›¸æ‰‹ã€
  - ã—ã‹ã—ã€æŒ‘æˆ¦è€…ã¨ã—ã¦ã€Œèƒ¸ã‚’å€Ÿã‚Šã‚‹ã¤ã‚‚ã‚Šã§å…¨åŠ›ã§ã¶ã¤ã‹ã‚ŠãŸã„ã€ã€Œä¸€çŸ¢å ±ã„ãŸã„ã€ã¨é—˜å¿—ã‚‚è¦‹ã›ã‚‹ã€‚
- **å®ŸåŠ›ãŒæ‹®æŠ—ã—ã¦ã„ã‚‹ç›¸æ‰‹ã¨å½“ãŸã£ãŸå ´åˆ (ä¾‹: Cãƒ©ãƒ³ã‚¯ vs Cãƒ©ãƒ³ã‚¯):**
  - ã€Œã“ã“ãŒæœ€åˆã®å±±å ´ã«ãªã‚‹ã€ã€Œå³ã—ã„æˆ¦ã„ã«ãªã‚‹ã“ã¨ã¯è¦šæ‚Ÿã—ã¦ã„ã‚‹ã€ã¨ã€ç›¸æ‰‹ã¸ã®æ•¬æ„ã‚’ç¤ºã™ã€‚
  - ã€Œæœ€é«˜ã®è©¦åˆã‚’ã—ãŸã„ã€ã¨ã€ãƒ©ã‚¤ãƒãƒ«ã¨ã®å¯¾æˆ¦ã‚’å¿ƒå¾…ã¡ã«ã—ã¦ã„ã‚‹æ§˜å­ã‚’è¦‹ã›ã‚‹ã€‚

### æŒ‡ç¤º
- ä¸Šè¨˜ã®æ€è€ƒãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ãã€å„ã‚«ãƒ¼ãƒ‰ã®ä¸¡ä¸»å°†ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
- ãƒãƒ¼ãƒ ã®èƒŒæ™¯ï¼ˆä¾‹ï¼šç‹è€…ã€å¤è±ªï¼‰ã‚‚å°‘ã—ã ã‘ã‚³ãƒ¡ãƒ³ãƒˆã«åæ˜ ã•ã›ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼ (JSONé…åˆ—)
[
    {"team": "ã€‡ã€‡é«˜æ ¡", "captain_comment": "ï¼ˆä¸»å°†ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"},
    {"team": "â–³â–³é«˜æ ¡", "captain_comment": "ï¼ˆä¸»å°†ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"}
]`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        const interviews = parseJsonFromText(result.candidates[0].content.parts[0].text);

        if (interviews && Array.isArray(interviews)) {
            interviewContent.innerHTML = interviews.map(iv => `
                <div class.p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold text-lg text-gray-800">${iv.team} ä¸»å°†</h4>
                    <p class="mt-1 text-gray-700">ã€Œ${iv.captain_comment}ã€</p>
                </div>
            `).join('');
        } else {
            throw new Error("Parsed JSON is not an array or is null.");
        }
    } catch (e) {
        interviewContent.innerHTML = `<p class="text-center text-red-600">ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
        console.error(e);
    }
    
    document.getElementById('close-interview-btn').onclick = () => {
        interviewModal.classList.add('hidden');
        document.getElementById('lottery-modal').classList.add('hidden');
        SoundManager.stopBgm();
        createNewTournament(false, 'summer', teamPositions);
    };
}
     
    async function initializeApp() {
  SoundManager.init(); 
 // --- 1. Preload the background image ---
    const bgContainer = document.querySelector('.ballpark-background');
    if (bgContainer) {
        const img = new Image();
        const imageUrl = 'ballpark.jpg'; // The local image path
        
        img.onload = function() {
            // Image loaded successfully, set it as the background and start the dust effect
            bgContainer.style.backgroundImage = `url(${imageUrl})`;
            createDustEffect();
        };
        img.onerror = function() {
            // If the image fails to load, log an error but still start the dust effect
            console.error('Failed to load the background image.');
            createDustEffect();
        };
        
        img.src = imageUrl; // This starts the image download
    } else {
        // If the background container doesn't exist, just start the dust effect
        createDustEffect();
    }
       
 // --- ã“ã“ã‹ã‚‰è¨ºæ–­ã‚³ãƒ¼ãƒ‰ ---
        try {
            alert('ãƒ‡ãƒãƒƒã‚°é–‹å§‹ï¼šinitializeAppé–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚');
            
            if (teamsTextarea) {
                alert('æˆåŠŸï¼šãƒãƒ¼ãƒ ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚');
            } else {
                alert('ã‚¨ãƒ©ãƒ¼ï¼šãƒãƒ¼ãƒ ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ id="teams-list" ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (INITIAL_TEAM_POOL && INITIAL_TEAM_POOL.length > 0) {
                alert(`æˆåŠŸï¼š${INITIAL_TEAM_POOL.length}ä»¶ã®ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚`);
            } else {
                alert('ã‚¨ãƒ©ãƒ¼ï¼šãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ï¼ TEAM_DATAã®å®šç¾©ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            teamsTextarea.value = INITIAL_TEAM_POOL.join('\n');
            alert('æˆåŠŸï¼šãƒãƒ¼ãƒ ä¸€è¦§ã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¡¨ç¤ºã—ã¾ã—ãŸã€‚');

        } catch (e) {
            alert('è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š ' + e.message);
        }

        // --- ã“ã“ã¾ã§è¨ºæ–­ã‚³ãƒ¼ãƒ‰ ---

        
    const savedStateJSON = localStorage.getItem('tournamentState');
    if (savedStateJSON) {
        try {
            const lastState = JSON.parse(savedStateJSON);
            if (lastState && lastState.tournamentYear) {
                const confirmed = await showConfirm("å‰å›ã®ç¶šãã‹ã‚‰å†é–‹ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã€Œã„ã„ãˆã€ã§æœ€åˆã‹ã‚‰ã€ã¾ãŸã¯ã€Œåˆã„è¨€è‘‰ã€ã§å†é–‹ï¼‰");
                
                if (confirmed) { // ã€Œã¯ã„ã€ãŒæŠ¼ã•ã‚ŒãŸå ´åˆ
                    tournamentState = lastState;

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
                    // --- å¤ã„ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¸ã®ã€Œäº’æ›æ€§ãƒ‘ãƒƒãƒã€ ---
                    if (tournamentState.teamRecords) {
                        for (const teamName in tournamentState.teamRecords) {
                            const record = tournamentState.teamRecords[teamName];
                            
                            // 1. (model_156) ãƒãƒ¼ãƒ æ‰“ç‡(tournamentStats)ãŒãªã‘ã‚Œã°åˆæœŸåŒ–
                            if (!record.tournamentStats) {
                                record.tournamentStats = { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0 };
                            }
                            
                            // 2. (model_164) ãƒ­ã‚¹ã‚¿ãƒ¼(roster)ãŒãªã‘ã‚Œã°åˆæœŸåŒ–
                            if (!record.roster) {
                                record.roster = null;
                            }
                        }
                    }
                    // 3. (model_106) å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆ(preGameComments)ãŒãªã‘ã‚Œã°åˆæœŸåŒ–
                    if (!tournamentState.preGameComments) {
                        tournamentState.preGameComments = {};
                    }
                    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// â–¼â–¼â–¼ ã“ã®1è¡Œã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
                    if (!tournamentState.matomeThreads) tournamentState.matomeThreads = {};
                    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

                    setupEl.classList.add('hidden');
                    tournamentDisplayEl.classList.remove('hidden');
                    renderTournament(tournamentState);
                    return; 
                } else { // â–¼â–¼â–¼ ã€Œã„ã„ãˆã€ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã®å‡¦ç†ã‚’è¿½åŠ  â–¼â–¼â–¼
                    // å¤ã„ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«æ¶ˆå»ã™ã‚‹
                    localStorage.removeItem('tournamentState');
                }
            }
        } catch (e) {
            console.error("ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:", e);
            localStorage.removeItem('tournamentState'); 
        }
    }        
        setupEl.classList.remove('hidden');
        tournamentDisplayEl.classList.add('hidden');
ã€€ã€€ã€€ã€€teamsTextarea.value = INITIAL_TEAM_POOL.join('\n');

 updateTicker();
}

    // --- Event Listeners ---
    
    generateBtn.addEventListener('click', async () => {
    const confirmed = await showConfirm("æ–°ã—ã„ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’é–‹å§‹ã™ã‚‹ã¨ã€ç¾åœ¨ã®é€²è¡ŒçŠ¶æ³ã¯å¤±ã‚ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
    if (confirmed) startLotteryEvent();
});
    resumeBtn.addEventListener('click', () => {
        saveLoadModal.classList.remove('hidden');
        loadTabBtn.click();
    });

    nextTournamentBtn.addEventListener('click', async () => {
        const confirmed = await showConfirm("ç¾åœ¨ã®å¤§ä¼šã‚’çµ‚äº†ã—ã€æ¬¡ã®å¤§ä¼šã¸é€²ã¿ã¾ã™ã‹ï¼Ÿ");
        if(confirmed) {
            let nextTournamentType;
            if (tournamentState.currentTournament === 'summer') nextTournamentType = 'autumn';
            else if (tournamentState.currentTournament === 'autumn') nextTournamentType = 'spring';
            else nextTournamentType = 'summer';
            createNewTournament(true, nextTournamentType);
        }
    });

    resetBtn.addEventListener('click', async () => {
        const confirmed = await showConfirm("ã™ã¹ã¦ã®å¤§ä¼šè¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã€æœ€åˆã®çŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ");
        if(confirmed){
            localStorage.clear();
            location.reload();
        }
    });

    saveBtn.addEventListener('click', () => {
        document.getElementById('save-code-area').classList.add('hidden');
        saveLoadModal.classList.remove('hidden');
        saveTabBtn.click();
    });
    
    startRankingPlayoffsBtn.addEventListener('click', async () => {
         const confirmed = await showConfirm("å…¨ãƒ–ãƒ­ãƒƒã‚¯ã®äºˆé¸ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚åœ°åŒºå†…é †ä½æ±ºå®šæˆ¦ã«é€²ã¿ã¾ã™ã‹ï¼Ÿ");
         if(confirmed) setupAutumnRankingTournaments();
    });
    
    // startMainTournamentBtn ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å†…

startMainTournamentBtn.addEventListener('click', async () => {
    // â˜…â˜…â˜… æ˜¥å­£å¤§ä¼šç”¨ã®åˆ†å²ã‚’è¿½åŠ  â˜…â˜…â˜…
    if (tournamentState.currentTournament === 'spring') {
        const confirmed = await showConfirm("å…¨ä»£è¡¨æ ¡ãŒæ±ºå®šã—ã¾ã—ãŸã€‚çœŒå¤§ä¼šæœ¬æˆ¦ã«é€²ã¿ã¾ã™ã‹ï¼Ÿ");
        if (confirmed) setupSpringMainTournament_Round1();
    } 
    // â˜…â˜…â˜… ã“ã“ã¾ã§è¿½åŠ  â˜…â˜…â˜…
    else { // ç§‹å­£å¤§ä¼šã®æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯
        const confirmed = await showConfirm("å…¨ä»£è¡¨æ ¡ãŒæ±ºå®šã—ã¾ã—ãŸã€‚çœŒå¤§ä¼šæœ¬æˆ¦ã«é€²ã¿ã¾ã™ã‹ï¼Ÿ");
        if (confirmed) setupAutumnMainTournament();
    }
});

    skipR1Btn.addEventListener('click', async () => {
        const confirmed = await showConfirm("1å›æˆ¦ã‚’è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
        if (confirmed) skipRound(1);
    });
    skipR2Btn.addEventListener('click', async () => {
        const confirmed = await showConfirm("2å›æˆ¦ã‚’è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
        if (confirmed) skipRound(2);
    });
    skipR3Btn.addEventListener('click', async () => {
        const confirmed = await showConfirm("3å›æˆ¦ã‚’è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
        if (confirmed) skipRound(3);
    });

skipR4Btn.addEventListener('click', async () => {
    const confirmed = await showConfirm("æº–ã€…æ±ºå‹ã‚’è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
    if (confirmed) skipRound(4);
});

skipR5Btn.addEventListener('click', async () => {
    const confirmed = await showConfirm("æº–æ±ºå‹ã‚’è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
    if (confirmed) skipRound(5);
});

skipFinalBtn.addEventListener('click', async () => {
    const confirmed = await showConfirm("æ±ºå‹æˆ¦ã‚’è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
    if (confirmed) skipFinal();
});
skipAutumnBlocksBtn.addEventListener('click', async () => {
    const confirmed = await showConfirm("ç§‹å­£åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸ã‚’ã™ã¹ã¦è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
    if (confirmed) skipAutumnRegionalBlocks();
});

skipAutumnRankingBtn.addEventListener('click', async () => {
    const confirmed = await showConfirm("ç§‹å­£åœ°åŒºã®ç¬¬5ä»£è¡¨æ±ºå®šæˆ¦ã‚’ã™ã¹ã¦è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
    if (confirmed) skipAutumnRankingTournaments();
});

skipAutumnMainBtn.addEventListener('click', async () => {
    const confirmed = await showConfirm("ç§‹å­£çœŒå¤§ä¼šæœ¬æˆ¦ã‚’ã™ã¹ã¦è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
    if (confirmed) skipAutumnMainTournament();
});
    
skipSpringQualifiersBtn.addEventListener('click', async () => {
    const confirmed = await showConfirm("æ˜¥å­£åœ°åŒºäºˆé¸ã‚’ã™ã¹ã¦è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
    if (confirmed) skipSpringQualifiers();
});

skipSpringRound1Btn.addEventListener('click', async () => {
    const confirmed = await showConfirm("æ˜¥å­£çœŒå¤§ä¼š1å›æˆ¦ã‚’è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
    if (confirmed) skipSpringMainRound1();
});

skipSpringMainBtn.addEventListener('click', async () => {
    const confirmed = await showConfirm("æ˜¥å­£çœŒå¤§ä¼š2å›æˆ¦ä»¥é™ã‚’ã™ã¹ã¦è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
    if (confirmed) skipSpringMainTournament();
});

    generateSummaryBtn.addEventListener('click', async () => {
        generateSummaryBtn.disabled = true;
        generateSummaryBtn.textContent = 'è¨˜äº‹ã‚’ç”Ÿæˆä¸­...';
        newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆè¨˜äº‹ã‚’åŸ·ç­†ä¸­...</div>`;
        const summaryArticle = await generateBest8PreviewArticle();
        if (summaryArticle) {
            tournamentState.news.push(summaryArticle);
            saveState();
            renderNews(tournamentState.news);
        }
        generateSummaryBtn.classList.add('hidden');
        generateSummaryBtn.disabled = false;
        generateSummaryBtn.textContent = 'ãƒ™ã‚¹ãƒˆ8ãƒã‚¤ãƒ©ã‚¤ãƒˆè¨˜äº‹ã‚’ç”Ÿæˆ';
    });

document.body.addEventListener('click', async (e) => {



    // --- è©¦åˆé€²è¡Œãƒœã‚¿ãƒ³ (â–¶) ---
    if (e.target.matches('.win-btn')) {
        const teamSlot = e.target.closest('.team-slot');
        const matchEl = e.target.closest('[data-match-id]');
        if (!teamSlot || !matchEl || teamSlot.classList.contains('empty')) return;

        const matchId = matchEl.dataset.matchId;
        const winnerName = teamSlot.dataset.teamName;
        if (!winnerName) return;

        const score1El = matchEl.querySelector('[data-team-pos="1"]');
        const score2El = matchEl.querySelector('[data-team-pos="2"]');

        if(!score1El || !score2El || score1El.value === '' || score2El.value === '') {
            showAlert('ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        let dbMatch = findMatchById(matchId);
        if (dbMatch) {
            dbMatch.score1 = score1El.value;
            dbMatch.score2 = score2El.value;
            dbMatch.summary = matchEl.querySelector('.match-summary-input')?.value || '';
        }

        await processMatchWin(matchId, winnerName);
    }

// --- ã€Œå‹¢åŠ›å›³ã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼‰ ---
    else if (e.target.matches('.view-analysis-btn')) {
        document.getElementById('analysis-modal').classList.remove('hidden');
        currentBlock = 'A'; // åˆæœŸè¡¨ç¤ºã¯Aãƒ–ãƒ­ãƒƒã‚¯
        playBlockAnimation(currentBlock);
    }
    // --- ã€æ–°ã—ãè¿½åŠ ã€‘å‹¢åŠ›å›³ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('.analysis-block-tab-btn')) {
        const blockId = e.target.dataset.block;
        if (blockId && blockId !== currentBlock) {
            currentBlock = blockId;
            playBlockAnimation(currentBlock);
        }
    }
    // --- å‹¢åŠ›å›³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('#analysis-modal-close-btn')) {
        document.getElementById('analysis-modal').classList.add('hidden');
    }
    // --- è©¦åˆè©³ç´°å…¥åŠ›ãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('.details-btn')) {
        openDetailsModal(e.target.dataset.matchId);
    }

    // --- ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã€‘ã‚¤ãƒ‹ãƒ³ã‚°è¿½åŠ ãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('.add-inning-btn') || e.target.matches('#add-inning-score-btn')) {
        e.preventDefault();
        addExtraInning();
    }

// --- ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã€‘å®ˆå‚™ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚’è¿½åŠ ãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('.add-fielding-play-btn')) {
        e.preventDefault();
        const teamKey = e.target.dataset.teamKey;

        // â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ãŒå®‰å…¨è£…ç½®ä»˜ãã®ã‚³ãƒ¼ãƒ‰ â–¼â–¼â–¼
        // 1. ã¾ãšã€ä¸¡æ–¹ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ã‚’æ¢ã—ã«è¡Œã
        const fieldingTableEl = document.getElementById(`fielding-table-${teamKey}`);
        const battingTableEl = document.getElementById(`batting-table-${teamKey}`);
        
        // 2. ã©ã¡ã‚‰ã‹ä¸€ã¤ã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚‰ã€ã‚¨ãƒ©ãƒ¼ã‚’é€šçŸ¥ã—ã¦å‡¦ç†ã‚’ä¸­æ–­
        if (!fieldingTableEl || !battingTableEl) {
            console.error(`ã‚¨ãƒ©ãƒ¼: ${teamKey} ã® fielding-table (${fieldingTableEl}) ã¾ãŸã¯ batting-table (${battingTableEl}) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
            console.error("HTMLå´ã®idå®šç¾© (createFieldingTable, createPlayerBattingTable) ã«ã‚¿ã‚¤ãƒ—ãƒŸã‚¹ãŒãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            alert("è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ï¼šãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        
        // 3. ä¸¡æ–¹è¦‹ã¤ã‹ã£ãŸå ´åˆã®ã¿ã€å®‰å…¨ã«å‡¦ç†ã‚’ç¶šè¡Œ
        const tableBody = fieldingTableEl.querySelector('tbody');
        // â–²â–²â–² å®‰å…¨è£…ç½®ã“ã“ã¾ã§ â–²â–²â–²

        // é¸æ‰‹ãƒªã‚¹ãƒˆã‚’å–å¾—
        const playersOnField = Array.from(battingTableEl.querySelectorAll('.player-name')).map(input => ({name: input.value.trim()})).filter(p => p.name);
        const playerOptions = playersOnField.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        
        const newRow = tableBody.insertRow();
        newRow.dataset.fieldingIndex = tableBody.rows.length; // æ–°ã—ã„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        newRow.innerHTML = `
            <td class="w-16"><input type="number" class="fielding-inning" min="1"></td>
            <td>
                <select class="player-name w-full">
                    <option value="">- é¸æ‰‹ -</option>
                    ${playerOptions}
                </select>
            </td>
            <td><input type="text" class="fielding-play" placeholder="ä¾‹: ãƒ€ã‚¤ãƒ“ãƒ³ã‚°ã‚­ãƒ£ãƒƒãƒ"></td>
            <td class="w-12 text-center">
                <button class="remove-fielding-play-btn text-red-500 hover:text-red-700 font-bold text-lg leading-none p-1">Ã—</button>
            </td>
        `;
    }
    // --- ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã€‘å®ˆå‚™ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚’å‰Šé™¤ãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('.remove-fielding-play-btn')) {
        e.preventDefault();
        e.target.closest('tr').remove();
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
    
    // --- å¤©å€™ãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('.weather-btn')) {
        const weatherType = e.target.dataset.weather;
        setWeather(weatherType);
    }


   // document.body.addEventListener('click', ...) å†…ã®ã€ã¾ã¨ã‚ã‚µã‚¤ãƒˆé–¢é€£ã® if ãƒ–ãƒ­ãƒƒã‚¯ã‚’å…¨ã¦ã“ã‚Œã§ç½®ãæ›ãˆã‚‹

// â–¼â–¼â–¼ ã“ã® else if ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    // --- ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã€‘ã€Œæ‰“é †ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã€ãƒœã‚¿ãƒ³ï¼ˆæŠ•æ‰‹ï¼‰ ---
    else if (e.target.matches('.copy-pitchers-from-batting-btn')) {
        e.preventDefault();
        const teamKey = e.target.dataset.teamKey;
        
        // 1. æ‰“æ’ƒãƒ†ãƒ¼ãƒ–ãƒ«(battingTable)ã‚’ç‰¹å®š
        const battingTable = document.getElementById(`batting-table-${teamKey}`);
        if (!battingTable) {
            alert('æ‰“æ’ƒãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }

        // 2. æŠ•æ‰‹ãƒ†ãƒ¼ãƒ–ãƒ«(pitchingTable)ã‚’ç‰¹å®š
        const pitchingTableBody = document.getElementById(`pitching-table-${teamKey}`)?.querySelector('tbody');
        if (!pitchingTableBody) {
            alert('æŠ•æ‰‹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }

        // 3. æ‰“æ’ƒãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã€ŒæŠ•ã€ã®é¸æ‰‹ã‚’ã‚¹ã‚­ãƒ£ãƒ³
        const pitchersInBatting = [];
        battingTable.querySelectorAll('tbody tr').forEach(row => {
            const posSelect = row.querySelector('.player-pos');
            const nameInput = row.querySelector('.player-name');
            const throwBatSelect = row.querySelector('.player-throw-bat');
            
            // å®ˆå‚™ä½ç½®ãŒã€ŒæŠ•ã€ã§ã€åå‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹é¸æ‰‹ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
            if (posSelect && posSelect.value === 'æŠ•' && nameInput && nameInput.value.trim() !== '') {
                pitchersInBatting.push({
                    name: nameInput.value.trim(),
                    throwBat: throwBatSelect ? throwBatSelect.value : ''
                });
            }
        });

        if (pitchersInBatting.length === 0) {
            alert('æ‰“æ’ƒãƒ†ãƒ¼ãƒ–ãƒ«ã«ã€ŒæŠ•ã€ã¨è¨­å®šã•ã‚ŒãŸé¸æ‰‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\nå…ˆã«æ‰“æ’ƒãƒ†ãƒ¼ãƒ–ãƒ«ã®ã€Œå®ˆå‚™ã€æ¬„ã‚’ã€ŒæŠ•ã€ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        // 4. æŠ•æ‰‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã‚’æ›´æ–°
        const pitchingRows = pitchingTableBody.querySelectorAll('tr');
        let updatedCount = 0;
        
        pitchersInBatting.forEach((pitcher, index) => {
            if (pitchingRows[index]) {
                // æ—¢å­˜ã®è¡Œï¼ˆã¾ãŸã¯ç©ºã®è¡Œï¼‰ã«åå‰ã¨æŠ•æ‰“ã‚’è‡ªå‹•å…¥åŠ›
                const nameInput = pitchingRows[index].querySelector('.pitcher-name');
                const throwBatSelect = pitchingRows[index].querySelector('.pitcher-throw-bat');
                
                if (nameInput) nameInput.value = pitcher.name;
                if (throwBatSelect) throwBatSelect.value = pitcher.throwBat;
                updatedCount++;
            }
            // (ã‚‚ã—æŠ•æ‰‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡ŒãŒè¶³ã‚Šãªã„å ´åˆã€è‡ªå‹•ã§è¿½åŠ ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚‚ã“ã“ã«è¿½åŠ å¯èƒ½)
        });
        
        alert(`${updatedCount}äººã®æŠ•æ‰‹ã‚’æ‰“æ’ƒãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚`);
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// â–¼â–¼â–¼ ã“ã® else if ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    // --- ã€ã¾ã¨ã‚ã‚µã‚¤ãƒˆã€‘ã‚¹ãƒ¬ãƒƒãƒ‰å†ç”Ÿæˆãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('#retry-matome-thread-btn')) {
        e.preventDefault();
        const btn = e.target;
        const matchId = btn.dataset.matchId;

        const originalData = tournamentState.matomeThreads[matchId];
        if (!originalData || !originalData.context) {
            alert("å†ç”Ÿæˆã«å¿…è¦ãªã€Œè©¦åˆçµ‚äº†æ™‚ã®æƒ…å ±ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }

        // è©¦åˆçµ‚äº†æ™‚ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´ã‚„èª¿å­ãƒ•ãƒ©ã‚°ãŒæ­£ã—ã„çŠ¶æ…‹ï¼‰ã‚’å–å¾—
        const matchContext = originalData.context;
        const threadContentEl = document.getElementById('bbs-thread-content');
        
        btn.disabled = true;
        btn.textContent = 'ç”Ÿæˆä¸­...';
        threadContentEl.innerHTML = `<div class="loader text-center py-8">AIãŒã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å†ç”Ÿæˆä¸­ã§ã™...ï¼ˆ${matchContext.winnerLineupChanges || 'ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´ãªã—'}ï¼‰</div>`;

        // AIã«å†ç”Ÿæˆã‚’ä¾é ¼
        const newCommentsArray = await generateGameMatchBbsComments(matchContext);

        // 1. æˆåŠŸã—ãŸå ´åˆ (é…åˆ—)
        if (newCommentsArray && Array.isArray(newCommentsArray)) {
            tournamentState.matomeThreads[matchId].thread = newCommentsArray; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¸Šæ›¸ã
            saveState();
            
            // å†æç”»
            threadContentEl.innerHTML = '';
            for (const comment of newCommentsArray) {
                const commentEl = document.createElement('div');
                commentEl.className = 'bbs-comment opacity-0 transition-opacity duration-500';
                commentEl.innerHTML = `
                    <p class="font-semibold text-gray-700 text-sm">${comment.personality}</p>
                    <p class="text-gray-800 my-1 whitespace-pre-wrap">${comment.text}</p>
                `;
                threadContentEl.appendChild(commentEl);
                setTimeout(() => { commentEl.classList.remove('opacity-0'); }, 50);
                await new Promise(resolve => setTimeout(resolve, 50)); // å†æç”»ã¯é«˜é€Ÿã§
                threadContentEl.scrollTop = threadContentEl.scrollHeight;
            }
        } 
        // 2. å¤±æ•—ã—ãŸå ´åˆ (ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)
        else {
            tournamentState.matomeThreads[matchId].thread = newCommentsArray; // ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ä¸Šæ›¸ã
            saveState();
            threadContentEl.innerHTML = `<p class="text-center text-red-500">ã‚¹ãƒ¬ãƒƒãƒ‰ã®å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚(ã‚¨ãƒ©ãƒ¼: ${newCommentsArray.body || 'ä¸æ˜'})</p>`;
        }

        btn.disabled = false;
        btn.textContent = 'å†ç”Ÿæˆ';
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
    // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã§ã€çµ±åˆå‹ã¾ã¨ã‚ã‚µã‚¤ãƒˆé–¢é€£ã®å‡¦ç†ã‚’å…¨ã¦æ›¸ãæ›ãˆã‚‹ â–¼â–¼â–¼

    // --- ã€Œã¾ã¨ã‚ã‚µã‚¤ãƒˆã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ ---
    const showMatomeBtn = e.target.closest('#show-matome-site-btn');
    if (showMatomeBtn) {
        const modal = document.getElementById('integrated-matome-modal');
        const articlesContainer = document.getElementById('matome-articles-container');
        modal.classList.remove('hidden');
        
        // ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’è¡¨ç¤ºã—ã€æœ€æ–°è¨˜äº‹ã‚’èª­ã¿è¾¼ã‚€
        articlesContainer.innerHTML = `<div class="loader text-center py-8">è¨˜äº‹ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>`;
        
        // åˆæœŸè¡¨ç¤ºã¯ã€Œãƒˆãƒƒãƒ—ã€ã‚¿ãƒ–
        document.querySelectorAll('.matome-tab-content').forEach(tab => tab.classList.add('hidden'));
        document.getElementById('matome-tab-top').classList.remove('hidden');
        document.querySelectorAll('.matome-tab-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-600', 'text-white'));
        document.querySelector('.matome-tab-btn[data-tab="top"]').classList.add('active', 'bg-blue-600', 'text-white');

        (async () => {
            const matomeHtml = await generateMatomeSiteHtml();
            articlesContainer.innerHTML = matomeHtml;
        })();
    }

 // --- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã/é–‰ã˜ã‚‹ ---
    if (e.target.closest('#open-settings-btn')) {
        // ç¾åœ¨ã®è¨­å®šã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã«åæ˜ 
        document.getElementById('toggle-article-generation').checked = tournamentState.settings.enableArticleGeneration;
        document.getElementById('toggle-bbs-generation').checked = tournamentState.settings.enableBbsGeneration;
        document.getElementById('settings-modal').classList.remove('hidden');
    }
    if (e.target.closest('#settings-modal-close-btn')) {
        document.getElementById('settings-modal').classList.add('hidden');
    }


    // --- çµ±åˆå‹ã¾ã¨ã‚ã‚µã‚¤ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ ---
    if (e.target.closest('#matome-modal-close-btn')) {
        document.getElementById('integrated-matome-modal').classList.add('hidden');
        // BBSã‚¹ãƒ¬ãƒƒãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚‚éš ã™
        document.getElementById('bbs-thread-display-area').classList.add('hidden');
    }

    // --- ã¾ã¨ã‚ã‚µã‚¤ãƒˆå†…ã®ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
    const tabBtn = e.target.closest('.matome-tab-btn');
    if (tabBtn) {
        document.querySelectorAll('.matome-tab-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-blue-600', 'text-white', 'hover:bg-blue-700');
            btn.classList.add('text-gray-700', 'hover:bg-gray-100');
        });
        tabBtn.classList.add('active', 'bg-blue-600', 'text-white');
        tabBtn.classList.remove('text-gray-700', 'hover:bg-gray-100');

        const tabId = tabBtn.dataset.tab;
        document.querySelectorAll('.matome-tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(`matome-tab-${tabId}`).classList.remove('hidden');

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«BBSã‚¹ãƒ¬ãƒƒãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ã¯éš ã™
        document.getElementById('bbs-thread-display-area').classList.add('hidden');

        // ã€Œãƒˆãƒƒãƒ—ã€ã‚¿ãƒ–ã«æˆ»ã£ãŸã‚‰è¨˜äº‹ã‚’å†èª­ã¿è¾¼ã¿ (å¿…è¦ã«å¿œã˜ã¦)
        if (tabId === 'top') {
            const articlesContainer = document.getElementById('matome-articles-container');
            articlesContainer.innerHTML = `<div class="loader text-center py-8">è¨˜äº‹ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>`;
            (async () => {
                const matomeHtml = await generateMatomeSiteHtml();
                articlesContainer.innerHTML = matomeHtml;
            })();
        }
    }
    
    // --- ã¾ã¨ã‚ã‚µã‚¤ãƒˆå†…ã®è¨˜äº‹ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯ ---
    const matomeLink = e.target.closest('.matome-article-link');
    if (matomeLink) {
        e.preventDefault();
        const headline = matomeLink.dataset.headline; // â˜…ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ã¯ã“ã“ã‹ã‚‰å–å¾—
        const type = matomeLink.dataset.type;
        const category = matomeLink.dataset.category;
        const matchId = matomeLink.dataset.matchId;

        const threadDisplayArea = document.getElementById('bbs-thread-display-area');
        const threadTitleEl = document.getElementById('bbs-thread-title');
        const threadContentEl = document.getElementById('bbs-thread-content');

        document.querySelectorAll('.matome-tab-content').forEach(content => content.classList.add('hidden'));
        threadDisplayArea.classList.remove('hidden');

        threadTitleEl.textContent = headline;
        threadContentEl.innerHTML = `<div class="loader text-center py-8">AIãŒæ²ç¤ºæ¿ã®åå¿œã‚’ç”Ÿæˆä¸­...</div>`;

        (async () => {
            let commentsArray; // ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆé…åˆ—ï¼ˆã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ï¼‰ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°

            // ã€Œå†ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã®è¦ç´ ã‚’å–å¾—
            const retryBtn = document.getElementById('retry-matome-thread-btn');
            
            // ã‚²ãƒ¼ãƒ å†…ã®è¨˜äº‹ï¼ˆé«˜æ ¡é‡çƒï¼‰ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ
            if (type === 'game' && matchId) {
                
                // 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(tournamentState)ã‹ã‚‰ã€Œç”Ÿæˆæ¸ˆã¿ã€ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const preGeneratedData = tournamentState.matomeThreads[matchId];
                const preGeneratedThread = preGeneratedData ? preGeneratedData.thread : null;

                // 2. ã€Œå†ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã« matchId ã‚’ã‚»ãƒƒãƒˆã—ã¦è¡¨ç¤ºã™ã‚‹
                if (preGeneratedData && preGeneratedData.context) {
                    retryBtn.dataset.matchId = matchId;
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden'); // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒç„¡ã„å ´åˆã¯éš ã™
                }

                // 3. ã‚¹ãƒ¬ãƒƒãƒ‰ã®è¡¨ç¤ºå‡¦ç†
                if (preGeneratedThread) {
                    if (Array.isArray(preGeneratedThread)) { // 3A. æˆåŠŸ
                        commentsArray = preGeneratedThread;
                    } else if (preGeneratedThread.error) { // 3B. å¤±æ•—
                        threadContentEl.innerHTML = `<p class="text-center text-red-500">ã‚¹ãƒ¬ãƒƒãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚(ã‚¨ãƒ©ãƒ¼: ${preGeneratedThread.body || 'ä¸æ˜'})</p>`;
                        return; // å‡¦ç†ä¸­æ–­
                    }
                } else { // 3C. ã‚¹ãƒ¬ãƒƒãƒ‰ç„¡ã—
                    threadContentEl.innerHTML = `<p class="text-center text-gray-500">ã“ã®è©¦åˆã®ã¾ã¨ã‚ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                    retryBtn.classList.add('hidden'); // ã‚¹ãƒ¬ãƒƒãƒ‰ãŒç„¡ã„ãªã‚‰å†ç”Ÿæˆã‚‚éš ã™
                    return; // å‡¦ç†ä¸­æ–­
                }

            } 
            // ç¾å®Ÿã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ
            else if (type === 'real') {
                retryBtn.classList.add('hidden'); // ç¾å®Ÿãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯å†ç”Ÿæˆä¸å¯
                commentsArray = await generateRealNewsBbsComments(headline, category);
            }

            // --- 4. å–å¾—ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆé…åˆ—ã‚’æç”»ã™ã‚‹ ---
            if (commentsArray && Array.isArray(commentsArray)) {
                threadContentEl.innerHTML = ''; // ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’æ¶ˆã™
                // ... (æ—¢å­˜ã®ã€Œãƒ©ã‚¤ãƒ–æ„Ÿã®ã‚ã‚‹æç”»å‡¦ç†ã€forãƒ«ãƒ¼ãƒ—) ...
                for (const comment of commentsArray) {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'bbs-comment opacity-0 transition-opacity duration-500';
                    commentEl.innerHTML = `
                        <p class="font-semibold text-gray-700 text-sm">${comment.personality}</p>
                        <p class="text-gray-800 my-1 whitespace-pre-wrap">${comment.text}</p>
                    `;
                    threadContentEl.appendChild(commentEl);
                    setTimeout(() => { commentEl.classList.remove('opacity-0'); }, 50);
                    const delay = Math.random() * 800 + 200;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    threadContentEl.scrollTop = threadContentEl.scrollHeight;
                }
            } else if (!commentsArray) { // real news å¤±æ•—ãªã©
                threadContentEl.innerHTML = `<p class="text-center text-red-500">ã‚¹ãƒ¬ãƒƒãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
            }
        })();
    }

    // --- BBSã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰ä¸€è¦§ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ ---
    if (e.target.closest('#bbs-thread-back-btn')) {
        document.getElementById('bbs-thread-display-area').classList.add('hidden');
        document.getElementById('matome-tab-top').classList.remove('hidden'); // ãƒˆãƒƒãƒ—ã‚¿ãƒ–ã«æˆ»ã‚‹
    }
    // â–²â–²â–² ã“ã“ã¾ã§ç½®ãæ›ãˆ â–²â–²â–² 
   
 // --- ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«å‘Šç™º/ç„¡è¦–ãƒœã‚¿ãƒ³ ---
  // document.body.addEventListener('click', ...) å†…ã®ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«ãƒœã‚¿ãƒ³ã®å‡¦ç†ã‚’ç½®ãæ›ãˆ

    // --- ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«å‘Šç™º/ç„¡è¦–ãƒœã‚¿ãƒ³ ---
    const scandalBtn = e.target.closest('.report-scandal-btn, .ignore-scandal-btn');
    if (scandalBtn && tournamentState.activeScandal) {
        const { teamName, scandalId } = tournamentState.activeScandal;
        const scandalDef = SCANDAL_DEFINITIONS.find(s => s.id === scandalId);
        if (!scandalDef) return;

        const choice = scandalBtn.classList.contains('report-scandal-btn') ? 'report' : 'ignore';
        const consequence = scandalDef.consequences[choice];

        // åŠ¹æœã‚’é©ç”¨
        consequence.applyEffect(teamName, tournamentState);

        // çµæœè¨˜äº‹ã‚’ç”Ÿæˆ
        const outcomeArticle = {
            title: consequence.outcomeTitle(teamName),
            body: consequence.outcomeBody(teamName),
            timestamp: Date.now()
        };
        
        // å™‚è¨˜äº‹ã‚’ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã€çµæœè¨˜äº‹ã‚’è¿½åŠ 
        tournamentState.news = tournamentState.news.filter(n => !n.isScandalRumor);
        tournamentState.news.push(outcomeArticle);
        
        // ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«ã‚’è§£æ±ºæ¸ˆã¿ã«ã™ã‚‹
        tournamentState.activeScandal = null;

        renderTournament(tournamentState); // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã¨ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å†æç”»
        saveState();
    }
// --- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼å¯†ç€å–æãƒœã‚¿ãƒ³ ---
    // --- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼å¯†ç€å–æãƒœã‚¿ãƒ³ï¼ˆé€†å¢ƒï¼‰ ---
    else if (e.target.matches('.underdog-doc-btn')) { // â† ã‚¯ãƒ©ã‚¹åã‚’å¤‰æ›´
        const teamName = e.target.dataset.teamName;
        const confirmed = await showConfirm(`ã€Œ${teamName}ã€ã®å¯†ç€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ...`);
        if (confirmed) {
            startDocumentary('underdog', teamName); // â† type ã‚’æ¸¡ã™ã‚ˆã†ã«å¤‰æ›´
        }
    }

    // â–¼â–¼â–¼ ã“ã“ã‹ã‚‰è¿½åŠ  â–¼â–¼â–¼
    // --- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼å¯†ç€å–æãƒœã‚¿ãƒ³ï¼ˆå¼·è±ªï¼‰ ---
    else if (e.target.matches('.powerhouse-doc-btn')) {
        const teamName = e.target.dataset.teamName;
        const confirmed = await showConfirm(`ã€Œ${teamName}ã€ã®å¯†ç€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®å¤§ä¼šä¸­ã€ä»–ã®ãƒãƒ¼ãƒ ã¯é¸æŠã§ããªããªã‚Šã¾ã™ã€‚`);
        if (confirmed) {
            startDocumentary('powerhouse', teamName);
        }
    }

// â–¼â–¼â–¼ ã“ã“ã‹ã‚‰è¿½åŠ  â–¼â–¼â–¼
    // --- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼å¯†ç€å–æãƒœã‚¿ãƒ³ï¼ˆå¤è±ªå¾©æ´»ï¼‰ ---
    else if (e.target.matches('.powerhouse-revival-doc-btn')) {
        const teamName = e.target.dataset.teamName;
        const confirmed = await showConfirm(`ã€Œ${teamName}ã€ã®å¯†ç€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®å¤§ä¼šä¸­ã€ä»–ã®ãƒãƒ¼ãƒ ã¯é¸æŠã§ããªããªã‚Šã¾ã™ã€‚`);
        if (confirmed) {
            startDocumentary('powerhouse_revival', teamName);
        }
    }

 else if (e.target.matches('.one-man-team-doc-btn')) {
        const teamName = e.target.dataset.teamName;
        const confirmed = await showConfirm(`ã€Œ${teamName}ã€ã®å¯†ç€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®å¤§ä¼šä¸­ã€ä»–ã®ãƒãƒ¼ãƒ ã¯é¸æŠã§ããªããªã‚Šã¾ã™ã€‚`);
        if (confirmed) {
            startDocumentary('one_man_team', teamName);
        }
    }

    // --- ã€Œï¼‹ èµ°è€…ãƒ—ãƒ¬ãƒ¼ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('.add-runner-play-btn')) {
        e.preventDefault();
        const container = e.target.closest('.at-bat-block').querySelector('.runner-plays-container');
        if (!container) return;

        if (container.children.length >= 3) {
            alert('ä¸€åº¦ã«è¿½åŠ ã§ãã‚‹èµ°è€…ãƒ—ãƒ¬ãƒ¼ã¯3ã¤ã¾ã§ã§ã™ã€‚');
            return;
        }

        const table = e.target.closest('.batting-table');
        const playersOnField = Array.from(table.querySelectorAll('.player-name')).map(input => ({name: input.value.trim()})).filter(p => p.name);
        const nameOptions = playersOnField.map(p => `<option value="${p.name}">${p.name}</option>`).join('');

        const baserunningPlays = ['ç›—å¡', 'ç›—å¡æ­»', 'ã‚¿ãƒƒãƒã‚¢ãƒƒãƒ—', 'é€²å¡', 'ç”Ÿé‚„', 'èµ°å¡æ­»', 'ç‰½åˆ¶æ­»', 'æŒŸæ®ºãƒ—ãƒ¬ãƒ¼ã§ã‚¢ã‚¦ãƒˆ'];
        const bases = ['ä¸€å¡ã¸', 'äºŒå¡ã¸', 'ä¸‰å¡ã¸', 'æœ¬å¡ã¸(ç”Ÿé‚„)'];
        const playOptions = baserunningPlays.map(p => `<option value="${p}">${p}</option>`).join('');
        const baseOptions = bases.map(b => `<option value="${b}">${b}</option>`).join('');

        const newPlayHTML = `
            <div class="runner-play-input flex gap-1 items-center mt-1">
                <select class="runner-name w-1/3 text-xs p-1 border rounded"><option value="">-èª°ãŒ-</option>${nameOptions}</select>
                <select class="runner-play w-1/3 text-xs p-1 border rounded bg-green-50"><option value="">-ä½•ã‚’ã—ãŸ-</option>${playOptions}</select>
                <select class="runner-base w-1/3 text-xs p-1 border rounded bg-green-50"><option value="">-ã©ã“ã¸-</option>${baseOptions}</select>
                <button class="remove-runner-play-btn text-red-500 hover:text-red-700 font-bold text-lg leading-none p-1">Ã—</button>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', newPlayHTML);
    }
    
    // --- èµ°è€…ãƒ—ãƒ¬ãƒ¼ã®ã€ŒÃ—ã€å‰Šé™¤ãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('.remove-runner-play-btn')) {
        e.target.closest('.runner-play-input').remove();
    }

    // --- ãŠã¾ã‹ã›å…¥åŠ›ãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('.quick-sim-btn')) {
        e.preventDefault();
        autoFillMatchDetails(e.target.dataset.matchId);
    }

    // --- 1ã‚¤ãƒ‹ãƒ³ã‚°ã«è¤‡æ•°æ‰“å¸­ã‚’è¿½åŠ ã™ã‚‹ãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('.add-at-bat-btn')) {
        e.preventDefault();
        const table = e.target.closest('.batting-table');
        const playersOnField = Array.from(table.querySelectorAll('.player-name')).map(input => ({ name: input.value.trim() })).filter(p => p.name);
        
        // æ–°ã—ã„ç©ºã®æ‰“å¸­ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆæ‰“è€…å…¥åŠ›æ¬„ï¼‹èµ°è€…å…¥åŠ›æ¬„ã®æ­£ã—ã„ã‚»ãƒƒãƒˆï¼‰ã‚’ç”Ÿæˆ
        const newAtBatHTML = createBattingResultDropdowns(playersOnField, '');
        
        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã®ç›´å‰ã«ã€æ–°ã—ã„ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŒ¿å…¥
        e.target.insertAdjacentHTML('beforebegin', newAtBatHTML);
    }

   // --- äº¤ä»£é¸æ‰‹è¿½åŠ ãƒœã‚¿ãƒ³ ---
   // --- ã€æ–°UIã€‘ã€Œ+ äº¤ä»£ã€ãƒœã‚¿ãƒ³ï¼ˆè¡Œå†…ï¼‰ ---
    else if (e.target.matches('.add-sub-row-btn')) {
        e.preventDefault();
        const btn = e.target;
        const teamKey = btn.dataset.teamKey;
        const currentOrder = btn.dataset.order; // ä¾‹: "3" or "3-sub-1"
        const baseOrder = currentOrder.split('-')[0]; // ä¾‹: "3"
        
        const tableBody = btn.closest('tbody');
        if (!tableBody) return;

        // 1. æŒ¿å…¥ä½ç½®ã‚’æ±ºã‚ã‚‹ (åŒã˜æ‰“é †ã‚°ãƒ«ãƒ¼ãƒ—ã®æœ€å¾Œã®è¡Œ)
        const allOrderRows = Array.from(tableBody.querySelectorAll(`tr[data-order^="${baseOrder}"]`));
        const targetRow = allOrderRows[allOrderRows.length - 1];

        // 2. æ–°ã—ã„è¡Œã® order ã‚’æ±ºã‚ã‚‹
        const subCount = allOrderRows.filter(row => row.dataset.order.includes('sub')).length + 1;
        const newOrder = `${baseOrder}-sub-${subCount}`; // ä¾‹: "3-sub-1" or "3-sub-2"

        // 3. æ–°ã—ã„è¡Œã®HTMLã‚’ç”Ÿæˆ
        const newRow = document.createElement('tr');
        newRow.dataset.order = newOrder;

        // 4. HTMLã®ä¸­èº«ã‚’ï¼ˆmodel_150ã®ãƒ­ã‚¸ãƒƒã‚¯ã‹ã‚‰ï¼‰ç”Ÿæˆ
        const throwBatOptionsList = [
            { val: "R/R", label: "å³/å³" }, { val: "R/L", label: "å³/å·¦" }, { val: "R/S", label: "å³/ä¸¡" },
            { val: "L/L", label: "å·¦/å·¦" }, { val: "L/R", label: "å·¦/å³" }, { val: "L/S", label: "å·¦/ä¸¡" }
        ];
        const tbOptionsHtml = throwBatOptionsList.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        const subThrowBatSelect = `<select class="player-throw-bat w-full bg-transparent"><option value="">-æŠ•/æ‰“-</option>${tbOptionsHtml}</select>`;
        
        const numberOptions = Array.from({length: 20}, (_, i) => `<option value="${i + 1}">${i + 1}</option>`).join('');
        const posOptions = ['æŠ•', 'æ•', 'ä¸€', 'äºŒ', 'ä¸‰', 'éŠ', 'å·¦', 'ä¸­', 'å³'].map(p => `<option value="${p}">${p}</option>`).join('');
        
        const numInnings = tableBody.parentElement.querySelector('thead tr').children.length - 7; // ãƒ˜ãƒƒãƒ€ãƒ¼ã®åˆ—æ•°(7)
        let resultInputs = '';
        for (let j = 0; j < numInnings; j++) {
            resultInputs += `<td class="col-inning batting-result-cell align-top p-1">
                                ${createBattingResultDropdowns(null, '')}                                 <button class="add-at-bat-btn text-xs mt-2 bg-blue-100 px-2 py-1 rounded hover:bg-blue-200 w-full font-semibold">ï¼‹ 2æ‰“å¸­ç›®ã‚’è¿½åŠ </button>
                             </td>`;
        }
        
        newRow.innerHTML = `
            <td class="col-order"></td>
            <td class="col-number"><select class="player-number w-full bg-transparent"><option value=""></option>${numberOptions}</select></td>
            <td class="col-throw-bat">${subThrowBatSelect}</td>
            <td class="col-player pl-4"><input type="text" class="player-name" placeholder="äº¤ä»£é¸æ‰‹å"></td>
            <td class="col-pos">
                <div class="flex items-center justify-between">
                    <select class="player-pos w-full bg-transparent"><option value=""></option>${posOptions}</select>
                    <button class="text-xs bg-gray-200 px-1 ml-1 rounded pos-change-btn" data-team-key="${teamKey}">å¤‰æ›´</button>
                </div>
                <span class="text-xs text-gray-500 truncate" title=""></span>
            </td>
            <td class="col-sub-type align-top">
                <select class="sub-type-select w-full bg-transparent mb-1">
                    <option value="" selected>-</option>
                    <option value="PH">ä»£æ‰“</option><option value="PR">ä»£èµ°</option>
                    <option value="DEF">å®ˆå‚™</option><option value="PITCHER">æŠ•æ‰‹</option>
                </select>
                <button class="add-sub-row-btn text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 w-full" data-order="${newOrder}" data-team-key="${teamKey}">
                    + äº¤ä»£
                </button>
            </td>
            ${resultInputs}
        `;
        
        // 5. æŒ¿å…¥
        targetRow.parentNode.insertBefore(newRow, targetRow.nextSibling);
    }
    // â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

    /// --- å®ˆå‚™å¤‰æ›´ãƒœã‚¿ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼‰ ---
    else if (e.target.matches('.pos-change-btn')) {
        const btn = e.target;
        const teamKey = btn.dataset.teamKey;
        
        // åŒã˜è¡Œã® .player-name å…¥åŠ›æ¬„ã‹ã‚‰åå‰ã‚’å–å¾—
        const row = btn.closest('tr');
        const playerNameInput = row.querySelector('.player-name');
        if (!playerNameInput) return;
        
        const playerName = playerNameInput.value.trim();
        if (!playerName) {
            alert("å…ˆã«é¸æ‰‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å–å¾—
        const modal = document.getElementById('substitution-modal');
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã‚»ãƒƒãƒˆ
        document.getElementById('sub-modal-player-name').value = playerName;
        modal.dataset.teamKey = teamKey; // ã©ã®ãƒãƒ¼ãƒ ã®é¸æ‰‹ã‹
        modal.dataset.playerName = playerName; // ã©ã®é¸æ‰‹ã‹
        modal.dataset.matchId = currentMatchIdForDetails; // ã©ã®è©¦åˆã‹

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('sub-modal-inning').value = 1;
        document.getElementById('sub-modal-top-bottom').value = 'è¡¨';
        document.getElementById('sub-modal-timing-start').checked = true;
        document.getElementById('sub-modal-timing-mid').checked = false;
        document.getElementById('sub-modal-mid-inning-details').classList.add('hidden');
        document.getElementById('sub-modal-outs').value = '0';
        document.getElementById('sub-modal-runner1').checked = false;
        document.getElementById('sub-modal-runner2').checked = false;
        document.getElementById('sub-modal-runner3').checked = false;
        document.getElementById('sub-modal-new-pos').value = '';

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        modal.classList.remove('hidden');
    }   
// --- æŠ•æ‰‹è¿½åŠ ãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('.add-row-btn')) {
        e.preventDefault();
        const tableId = e.target.dataset.tableId;
        const table = document.getElementById(tableId).querySelector('tbody');
        const newRow = table.insertRow();
        
        // â–¼â–¼â–¼ 4ç¨®é¡ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠè‚¢ã‚’ã“ã“ã§å®šç¾© â–¼â–¼â–¼
        const throwBatOptions = [
            { val: "R/R", label: "å³/å³" }, { val: "R/L", label: "å³/å·¦" }, { val: "R/S", label: "å³/ä¸¡" },
            { val: "L/L", label: "å·¦/å·¦" }, { val: "L/R", label: "å·¦/å³" }, { val: "L/S", label: "å·¦/ä¸¡" }
        ];
        const throwStyleOptions = [
            { val: "over", label: "ã‚ªãƒ¼ãƒãƒ¼" }, { val: "three_quarter", label: "ã‚¹ãƒªãƒ¼ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼" },
            { val: "side", label: "ã‚µã‚¤ãƒ‰" }, { val: "under", label: "ã‚¢ãƒ³ãƒ€ãƒ¼" }
        ];
        const pitcherTypeOptions = [
            { val: "honkaku", label: "æœ¬æ ¼æ´¾" }, { val: "sokkyu", label: "é€Ÿçƒæ´¾" },
            { val: "giko", label: "æŠ€å·§æ´¾" }, { val: "nanto", label: "è»ŸæŠ•æ´¾" }
        ];
        const velocityOptions = [];
        for (let v = 100; v <= 165; v += 5) {
            velocityOptions.push({ val: `${v}km`, label: `${v}kmå¸¯` });
        }

        const tbOptionsHtml = throwBatOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        const styleOptionsHtml = throwStyleOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        const typeOptionsHtml = pitcherTypeOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        const velocityOptionsHtml = velocityOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

        // â–¼â–¼â–¼ newRow.innerHTML ã«3ã‚»ãƒ«è¿½åŠ  â–¼â–¼â–¼
        newRow.innerHTML = `
            <td class="col-pitcher-result"><select class="pitcher-result"><option value="" selected>-</option><option value="W">â—‹</option><option value="L">â—</option><option value="S">S</option><option value="H">H</option></select></td>
            <td class="col-pitcher-name"><input type="text" class="pitcher-name" value=""></td>
            <td class="col-pitcher-throw-bat"><select class="pitcher-throw-bat w-full bg-transparent"><option value="">-æŠ•/æ‰“-</option>${tbOptionsHtml}</select></td>
            <td class="col-pitcher-style"><select class="pitcher-throw-style w-full bg-transparent"><option value="">-æŠ•ã’æ–¹-</option>${styleOptionsHtml}</select></td>
            <td class="col-pitcher-type"><select class="pitcher-type w-full bg-transparent"><option value="">-ã‚¿ã‚¤ãƒ—-</option>${typeOptionsHtml}</select></td>
            <td class="col-pitcher-velocity"><select class="pitcher-velocity w-full bg-transparent"><option value="">-çƒé€Ÿå¸¯-</option>${velocityOptionsHtml}</select></td>
            <td class="col-stat"><input type="text" class="pitcher-innings" value=""></td>
            <td class="col-stat"><input type="number" class="pitcher-batters" value=""></td>
            <td class="col-stat"><input type="number" class="pitcher-pitches" value=""></td>
            <td class="col-stat"><input type="number" class="pitcher-hits" value=""></td>
            <td class="col-stat"><input type="number" class="pitcher-so" value=""></td>
            <td class="col-stat"><input type="number" class="pitcher-walks" value=""></td>
            <td class="col-stat"><input type="number" class="pitcher-runs" value=""></td>
            <td class="col-stat"><input type="number" class="pitcher-er" value=""></td>
        `;        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    }

    // --- å…ˆæ”»å¾Œæ”»å…¥ã‚Œæ›¿ãˆãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('#swap-teams-btn')) {
        swapTeamDetails(e.target.dataset.matchId);
    }

    // --- ãƒãƒ¼ãƒ åã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼‰ ---
    else if (e.target.matches('.clickable-team-name')) {
        const teamName = e.target.dataset.teamName;
        if(teamName && teamName !== 'null' && teamName !== '') {
            showTeamStatusModal(teamName);
        }
    }
    // --- è¨˜äº‹è¡¨ç¤ºãƒœã‚¿ãƒ³ï¼ˆé€šå¸¸è¨˜äº‹ã®ã€Œæœ¬æ–‡ã€ï¼‰ ---
    // --- è¨˜äº‹è¡¨ç¤ºãƒœã‚¿ãƒ³ï¼ˆé€šå¸¸è¨˜äº‹ã®ã€Œæœ¬æ–‡ã€ï¼‰ ---
    const newsArticleBtn = e.target.closest('.news-article-btn');
    if (newsArticleBtn) {
        const article = tournamentState.news[parseInt(newsArticleBtn.dataset.index, 10)];
        if (article && article.body) {
            document.getElementById('modal-title').textContent = article.title;
            document.getElementById('modal-body').textContent = article.body;
            document.getElementById('modal-meta').innerHTML = `<p>${new Date(article.timestamp).toLocaleDateString('ja-JP')}</p>`;
            newsModal.classList.remove('hidden');
            newsModal.classList.add('flex');
        } else {
            alert('è¨˜äº‹ã®æœ¬æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
        }
    }

    // --- è¨˜äº‹è¡¨ç¤ºãƒœã‚¿ãƒ³ï¼ˆæ–°èã®ã€Œæ–°èã‚’èª­ã‚€ã€ï¼‰ ---
    const newspaperViewBtn = e.target.closest('.newspaper-view-btn');
    if (newspaperViewBtn) {
        const article = tournamentState.news[parseInt(newspaperViewBtn.dataset.index, 10)];
        if (article.isNewspaper && article.newspaperData) {
            renderNewspaperModal(article.newspaperData);
            newspaperModal.classList.remove('hidden');
        }
    }
 // â–¼â–¼â–¼ æŠœã‘è½ã¡ã¦ã„ãŸã®ã¯ã€ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã§ã™ â–¼â–¼â–¼
    // --- æ²ç¤ºæ¿ã®ã€Œè¿”ä¿¡ã™ã‚‹ã€ãƒœã‚¿ãƒ³ ---
    const replyBtn = e.target.closest('.reply-btn');
    if (replyBtn) {
        e.preventDefault();
        const commentId = replyBtn.dataset.commentId;
        const formContainer = document.getElementById(`reply-form-container-${commentId}`);
        if (formContainer) {
            formContainer.classList.toggle('hidden');
        }
        return; // ä»–ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã¨ç«¶åˆã—ãªã„ã‚ˆã†ã« return ã—ã¾ã™
    }
// document.body.addEventListener('click', ...) ã®ä¸­

    
    // document.body.addEventListener('click', ...) å†…ã®è©²å½“ç®‡æ‰€ã‚’ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ãƒ»è¿½è¨˜

    // â–¼â–¼â–¼ æ—¢å­˜ã®ã€Œ.retry-btnã€ã® else if ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã€ä»¥ä¸‹ã®å†…å®¹ã«ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆã‚‹ â–¼â–¼â–¼
    // --- AIè¨˜äº‹ã®å†ç”Ÿæˆãƒœã‚¿ãƒ³ï¼ˆã‚¨ãƒ©ãƒ¼è¨˜äº‹ãƒ»æˆåŠŸè¨˜äº‹ã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰ ---
    // --- AIè¨˜äº‹ã®å†ç”Ÿæˆãƒœã‚¿ãƒ³ï¼ˆæˆåŠŸã—ãŸè¨˜äº‹ç”¨ï¼‰ ---
     // --- AIè¨˜äº‹ã®å†ç”Ÿæˆãƒœã‚¿ãƒ³ï¼ˆæˆåŠŸãƒ»å¤±æ•—è¨˜äº‹ã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰ ---
    const regenerateBtn = e.target.closest('.regenerate-btn, .retry-btn');
Â  Â  if (regenerateBtn) {
Â  Â  Â  Â  const articleIndex = parseInt(regenerateBtn.dataset.index, 10);
Â  Â  Â  Â  const originalArticle = tournamentState.news[articleIndex];
Â  Â  Â  Â  if (!originalArticle || !originalArticle.context) {
Â  Â  Â  Â  Â  Â  alert("ã“ã®è¨˜äº‹ã¯å†ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  articleForRegeneration = { index: articleIndex, article: originalArticle };
Â  Â  Â  Â  document.getElementById('feedback-include').value = '';
Â  Â  Â  Â  document.getElementById('feedback-exclude').value = '';
Â  Â  Â  Â  document.getElementById('feedback-modal').classList.remove('hidden');
Â  Â  }
    
    // --- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ã®å†ç”Ÿæˆå®Ÿè¡Œãƒœã‚¿ãƒ³ ---
    // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã§ã€æ—¢å­˜ã®è©²å½“ç®‡æ‰€ã‚’ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼

Â  Â // --- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ã®å†ç”Ÿæˆå®Ÿè¡Œãƒœã‚¿ãƒ³ ---
    const feedbackSubmitBtn = e.target.closest('#feedback-submit-btn');
    if (feedbackSubmitBtn) {
        if (!articleForRegeneration) return;
        const { index, article } = articleForRegeneration;
        const context = article.context; // ã‚¨ãƒ©ãƒ¼è¨˜äº‹ã‹ã‚‰ context ã‚’å–å¾—

        // UIã‚’æº–å‚™
        feedbackSubmitBtn.textContent = 'ç”Ÿæˆä¸­...';
        feedbackSubmitBtn.disabled = true;
        const userFeedback = {
            include: document.getElementById('feedback-include').value,
            exclude: document.getElementById('feedback-exclude').value
        };
        document.getElementById('feedback-modal').classList.add('hidden');
        articleForRegeneration = null;
        tournamentState.news.splice(index, 1); // å¤ã„è¨˜äº‹ï¼ˆã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ï¼‰ã‚’ä¸€æ—¦å‰Šé™¤
        renderNews(tournamentState.news);
        newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒã‚ãªãŸã®æŒ‡ç¤ºã‚’åŸºã«è¨˜äº‹ã‚’å†åŸ·ç­†ä¸­ã§ã™...</div>`;

        // éåŒæœŸã§AIã®å†ç”Ÿæˆå‡¦ç†ã‚’é–‹å§‹
        (async () => {
            let articlePromise;

            // â–¼â–¼â–¼ ã“ã®åˆ†å²ãƒ­ã‚¸ãƒƒã‚¯å…¨ä½“ã‚’ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
            
            // â˜…â˜…â˜… ã“ã“ãŒæœ€é‡è¦ä¿®æ­£ç‚¹ â˜…â˜…â˜…
            // context.theme ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãã‚Œã¯ã€Œè©±é¡Œæ ¡è¨˜äº‹ã€ã§ã‚ã‚‹ã¨åˆ¤æ–­ã—ã¾ã™ã€‚
            // (å¤ã„ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¯ isTopicArticle ãƒ•ãƒ©ã‚°ã‚’æŒã£ã¦ã„ãªã„ãŸã‚)
            
            if (context.isDocumentary) {
                // ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼è¨˜äº‹ã®å ´åˆã€‘
                const { type, teamName, matchData } = context;
                articlePromise = generateDocumentaryArticle('intro', type, teamName, matchData, userFeedback);
            
            } else if (context.isBracketAnalysis) {
                // ã€çµ„ã¿åˆã‚ã›åˆ†æè¨˜äº‹ã®å ´åˆã€‘
                articlePromise = generateBracketAnalysisNewsArticle(tournamentState); 
            
            } else if (context.isHadaReport) {
                // ã€ç¾½ç”°ãƒ¬ãƒãƒ¼ãƒˆã®å ´åˆã€‘
                articlePromise = generateHadaReport(context);
            
            } else if (context.isTopicArticle || context.theme) { // â˜…â˜…â˜… (|| context.theme) ã‚’è¿½åŠ  â˜…â˜…â˜…
                // ã€è©±é¡Œæ ¡ç´¹ä»‹è¨˜äº‹ã®å ´åˆã€‘
                // ãƒ©ãƒ³ã‚¯ã‚’å†è¨ˆç®—ã—ã¦ã‹ã‚‰é–¢æ•°ã‚’å‘¼ã¶
                const rank = calculateRank(context.teamName, tournamentState); 
                articlePromise = createTopicArticle(context.teamName, rank, context.theme); 
                // (æ³¨: è©±é¡Œæ ¡è¨˜äº‹ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç„¡è¦–ã—ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã§å†ç”Ÿæˆã—ã¾ã™)
            
            } else {
                // ã€é€šå¸¸ã®è©¦åˆè¨˜äº‹ã®å ´åˆã€‘
                articlePromise = generateNewsArticle(context, userFeedback);
            }
            // â–²â–²â–² åˆ†å²ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

            const createErrorArticle = () => ({
                title: "è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼", body: "è¨˜äº‹ã®å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(), error: true,
                errorId: context.matchId || context.errorId || `regen-error-${Date.now()}`,
                // â˜…å„ç¨®ãƒ•ãƒ©ã‚°ã‚’æ­£ã—ãå¼•ãç¶™ã
                isDocumentary: context.isDocumentary,
                isBracketAnalysis: context.isBracketAnalysis,
                isHadaReport: context.isHadaReport,
                isTopicArticle: (context.isTopicArticle || context.theme), // â˜…ä¿®æ­£
                context: context // ã‚¨ãƒ©ãƒ¼ãŒé€£é–ã—ã¦ã‚‚ context ã‚’å¼•ãç¶™ã
            });

            const newArticle = await articlePromise;

            if (newArticle && !newArticle.error) {
                newArticle.context = context; // æ–°ã—ã„è¨˜äº‹ã«ã‚‚ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä»˜ä¸
                tournamentState.news.splice(index, 0, newArticle); // å…ƒã®ä½ç½®ã«æ–°ã—ã„è¨˜äº‹ã‚’æŒ¿å…¥
                
                // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é€šã•ãšã€ãã®ã¾ã¾è¡¨ç¤ºã™ã‚‹è¨˜äº‹
                if (!context.isBracketAnalysis && !context.isHadaReport && ( !context.isTopicArticle && !context.theme )) { // â˜…ä¿®æ­£
                    showArticleReviewModal(newArticle);
                }
            } else {
                tournamentState.news.splice(index, 0, createErrorArticle()); // å…ƒã®ä½ç½®ã«ã‚¨ãƒ©ãƒ¼è¨˜äº‹ã‚’æŒ¿å…¥
            }
            
            saveState();
            renderNews(tournamentState.news); // ãƒ‹ãƒ¥ãƒ¼ã‚¹æ¬„ã‚’å†æç”»
            feedbackSubmitBtn.textContent = 'ã“ã®æŒ‡ç¤ºã§å†ç”Ÿæˆ';
            feedbackSubmitBtn.disabled = false;
        })();
    }

// â–²â–²â–² ã“ã“ã¾ã§ç½®ãæ›ãˆ â–²â–²â–²

// â–¼â–¼â–¼ ã“ã® else if ãƒ–ãƒ­ãƒƒã‚¯ã‚’ (model_114 ã®ææ¡ˆã¨) ç½®ãæ›ãˆ â–¼â–¼â–¼
    // --- è©¦åˆå‰ å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã ã‘ï¼‰ ---
    else if (e.target.matches('.pre-game-cheer-btn')) {
        e.preventDefault();
        const btn = e.target;
        const matchId = btn.dataset.matchId;
        const match = findMatchById(matchId);
        if (!match || !match.team1 || !match.team2) {
            alert("å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰ãŒæœªå®šã®ãŸã‚ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚");
            return;
        }

        const modal = document.getElementById('pre-game-modal');
        const titleEl = document.getElementById('pre-game-title');
        const bodyEl = document.getElementById('pre-game-body');
        const tab1 = document.getElementById('pre-game-tab-team1');
        const tab2 = document.getElementById('pre-game-tab-team2');

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨ã‚¿ãƒ–ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
        titleEl.textContent = `ã€${match.team1} vs ${match.team2}ã€‘è©¦åˆå‰ å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆ`;
        tab1.textContent = `${match.team1} å¿œæ´å¸­`;
        tab2.textContent = `${match.team2} å¿œæ´å¸­`;
        
        // ã‚¿ãƒ–ã«è©¦åˆæƒ…å ±ã‚’ä»•è¾¼ã‚€
        tab1.dataset.matchId = matchId;
        tab1.dataset.teamName = match.team1;
        tab1.dataset.opponentName = match.team2;
        tab2.dataset.matchId = matchId;
        tab2.dataset.teamName = match.team2;
        tab2.dataset.opponentName = match.team1;
        
        // ã‚¿ãƒ–ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        tab1.classList.remove('active', 'text-blue-600', 'border-blue-600');
        tab2.classList.remove('active', 'text-blue-600', 'border-blue-600');
        tab1.classList.add('text-gray-500', 'border-transparent');
        tab2.classList.add('text-gray-500', 'border-transparent');

        // æœ¬æ–‡ã‚’ãƒªã‚»ãƒƒãƒˆ
        bodyEl.innerHTML = `<p class="text-gray-500 text-center p-8">â†‘ è¦‹ãŸã„ãƒãƒ¼ãƒ ã®å¿œæ´å¸­ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ â†‘</p>`;
        
        modal.classList.remove('hidden');
    }
    // â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

// --- å®ˆå‚™äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('#sub-modal-cancel')) {
        document.getElementById('substitution-modal').classList.add('hidden');
    }

    // --- å®ˆå‚™äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã€Œäº¤ä»£ã‚’è¨˜éŒ²ã€ãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('#sub-modal-save')) {
        const modal = document.getElementById('substitution-modal');
        const matchId = modal.dataset.matchId;
        const teamKey = modal.dataset.teamKey;
        const playerName = modal.dataset.playerName;

        const match = findMatchById(matchId);
        if (!match) {
            alert("ã‚¨ãƒ©ãƒ¼: è©²å½“ã®è©¦åˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }
        
        const newPos = document.getElementById('sub-modal-new-pos').value;
        if (!newPos) {
            alert("ã€Œæ–°ã—ã„å®ˆå‚™ä½ç½®ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        // äº¤ä»£ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
        const substitutionData = {
            playerName: playerName,
            teamKey: teamKey,
            inning: document.getElementById('sub-modal-inning').value,
            topBottom: document.getElementById('sub-modal-top-bottom').value,
            timing: document.querySelector('input[name="sub-timing"]:checked').value, // 'start' or 'mid'
            newPos: newPos,
            outs: null,
            runners: null
        };

        // ã‚¤ãƒ‹ãƒ³ã‚°é€”ä¸­ã®å ´åˆã€è©³ç´°ã‚’è¿½åŠ 
        if (substitutionData.timing === 'mid') {
            substitutionData.outs = document.getElementById('sub-modal-outs').value;
            substitutionData.runners = {
                r1: document.getElementById('sub-modal-runner1').checked,
                r2: document.getElementById('sub-modal-runner2').checked,
                r3: document.getElementById('sub-modal-runner3').checked
            };
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’ match ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ä¿å­˜
        if (!match.details) match.details = {};
        if (!match.details.positionChanges) match.details.positionChanges = [];
        match.details.positionChanges.push(substitutionData);

        // ä¿å­˜ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        saveState();
        alert(`${substitutionData.inning}å›${substitutionData.topBottom}ã€${playerName}é¸æ‰‹ã‚’${newPos}ã«äº¤ä»£ã—ã¾ã—ãŸã€‚`);
        modal.classList.add('hidden');
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// --- ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã€‘ã€Œâ˜… æ³¨ç›®ã€ãƒœã‚¿ãƒ³ï¼ˆãƒˆã‚°ãƒ«ï¼‰ ---
    else if (e.target.matches('.mark-at-bat-btn')) {
        e.preventDefault();
        const btn = e.target;
        const isMarked = btn.dataset.marked === 'true';

        if (isMarked) {
            // æ³¨ç›®ã‚’è§£é™¤
            btn.dataset.marked = 'false';
            btn.classList.remove('bg-yellow-300', 'border-yellow-500', 'text-yellow-900');
            btn.classList.add('bg-gray-100', 'border-gray-300', 'text-gray-500', 'hover:bg-gray-200');
        } else {
            // æ³¨ç›®ã‚’è¨­å®š
            btn.dataset.marked = 'true';
            btn.classList.add('bg-yellow-300', 'border-yellow-500', 'text-yellow-900');
            btn.classList.remove('bg-gray-100', 'border-gray-300', 'text-gray-500', 'hover:bg-gray-200');
        }
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    // â–¼â–¼â–¼ ã“ã® else if ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã€Œæ–°è¦è¿½åŠ ã€ â–¼â–¼â–¼
    // --- å¿œæ´ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã€Œãƒãƒ¼ãƒ ã‚¿ãƒ–ã€ã‚¯ãƒªãƒƒã‚¯ ---
   // --- å¿œæ´ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã€Œãƒãƒ¼ãƒ ã‚¿ãƒ–ã€ã‚¯ãƒªãƒƒã‚¯ ---
    else if (e.target.matches('.pre-game-team-tab')) {
        e.preventDefault();
        const tabBtn = e.target;
        if (tabBtn.classList.contains('active')) return; // æ—¢ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚‰ä½•ã‚‚ã—ãªã„

        const teamKey = tabBtn.dataset.teamKey; // 'team1' or 'team2'
        const matchId = tabBtn.dataset.matchId;
        const teamName = tabBtn.dataset.teamName;
        const opponentName = tabBtn.dataset.opponentName;
        
        const bodyEl = document.getElementById('pre-game-body');
        const cacheKey = `${matchId}_${teamName}`; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’ãƒãƒ¼ãƒ åˆ¥ã«

        // ä»–ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
        document.querySelectorAll('.pre-game-team-tab').forEach(btn => {
            btn.classList.remove('active', 'text-blue-600', 'border-blue-600');
            btn.classList.add('text-gray-500', 'border-transparent');
        });
        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
        tabBtn.classList.add('active', 'text-blue-600', 'border-blue-600');
        tabBtn.classList.remove('text-gray-500', 'border-transparent');

        // 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºèª
        if (tournamentState.preGameComments[cacheKey]) {
            bodyEl.innerHTML = tournamentState.preGameComments[cacheKey];
            return;
        }

        // 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã€AIã§ç”Ÿæˆ
        bodyEl.innerHTML = `<div class="loader text-center py-8">${teamName} å¿œæ´å›£ï¼ˆOB, åœ¨æ ¡ç”Ÿ, åœ°å…ƒãƒ•ã‚¡ãƒ³ï¼‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆä¸­...</div>`;

        // ãƒ©ãƒ³ã‚¯ã¨ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’æ±ºå®š
        const rankValues = { 'A': 10, 'B': 8, 'C': 5, 'D': 3, 'E': 2 };
        const rank = calculateRank(teamName, tournamentState);
        const opponentRank = calculateRank(opponentName, tournamentState);
        const numComments = rankValues[rank] || 2;

        // â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ãŒä»Šå›ã®ä¿®æ­£ç®‡æ‰€ â–¼â–¼â–¼
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ–‡è„ˆï¼‰ã‚’æº–å‚™
        const teamData = TEAM_DATA[teamName] || {}; // â˜…ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const context = {
            name: teamName, 
            rank: rank,
            opponent: opponentName, 
            opponentRank: opponentRank,
            round: getRoundNameFromMatchId(matchId),
            path: getTournamentPathSummary(teamName, matchId),
            detailed: DETAILED_TEAM_DATA[teamName] || null,
            info: teamData.info || '' // â˜…ãƒãƒ¼ãƒ ã®èƒŒæ™¯(info)ã‚’è¿½åŠ 
        };
        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

        // ã“ã®ãƒãƒ¼ãƒ ã®åˆ†ã ã‘AIã«ç”Ÿæˆã•ã›ã‚‹
        const comments = await generatePreGameCheerComments(context, numComments); // â˜…contextã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™

        // 3. HTMLã‚’ç”Ÿæˆã—ã¦è¡¨ç¤º
        let html = '';
        comments.forEach(c => {
            html += `<div class="bbs-comment"><p class="font-semibold text-gray-700 text-sm">${c.personality}</p><p class="text-gray-800 my-1 whitespace-pre-wrap">${c.comment}</p></div>`;
        });

        bodyEl.innerHTML = html;
        tournamentState.preGameComments[cacheKey] = html; // HTMLã‚’ãƒãƒ¼ãƒ åˆ¥ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã—ã¦ä¿å­˜
        saveState();
    }

    // â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    // --- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('#feedback-cancel-btn')) {
        document.getElementById('feedback-modal').classList.add('hidden');
        articleForRegeneration = null;
    }
    // â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–²    // â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–²



// --- æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆã®ã‚¨ãƒ©ãƒ¼å†ç”Ÿæˆãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('.retry-bbs-btn')) {
        const btn = e.target;
        const index = parseInt(btn.dataset.index, 10);
        const errorItem = tournamentState.bbsComments[index];
        const regenType = btn.dataset.type; // 'bracket-thread' or 'match-comments'

        if (!errorItem || !errorItem.context) {
            alert("å†ç”Ÿæˆã«å¿…è¦ãªæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }

        btn.textContent = 'ç”Ÿæˆä¸­...';
        btn.disabled = true;
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ä¸€æ™‚çš„ã«ãƒ­ãƒ¼ãƒ€ãƒ¼ã«ç½®ãæ›ãˆã¦ã‚‚è‰¯ã„
        // btn.closest('.article-error').innerHTML = `<div class="loader text-sm">å†ç”Ÿæˆä¸­...</div>`;

        let newBbsData = null; // å†ç”Ÿæˆçµæœã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°

        try {
            if (regenType === 'bracket-thread') {
                // çµ„ã¿åˆã‚ã›ã‚¹ãƒ¬ãƒƒãƒ‰ã®å†ç”Ÿæˆ
                newBbsData = await generateBracketBbsThread(tournamentState); // stateå…¨ä½“ã‚’æ¸¡ã™
            } else if (regenType === 'match-comments' && errorItem.context.matchId) {
                // è©¦åˆå¾Œã‚³ãƒ¡ãƒ³ãƒˆã®å†ç”Ÿæˆ
                // contextã«å¿…è¦ãªæƒ…å ±ãŒæƒã£ã¦ã„ã‚‹ã‹ç¢ºèª
                if (errorItem.context.winnerName && errorItem.context.dbMatch) {
                     newBbsData = await generateBbsComments(errorItem.context); // ä¿å­˜ã•ã‚ŒãŸcontextã‚’æ¸¡ã™
                } else {
                    throw new Error("è©¦åˆå¾Œã‚³ãƒ¡ãƒ³ãƒˆå†ç”Ÿæˆã®ãŸã‚ã®Contextæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
                }
            } else {
                 throw new Error("ä¸æ˜ãªå†ç”Ÿæˆã‚¿ã‚¤ãƒ—ã§ã™: " + regenType);
            }

            // --- å†ç”Ÿæˆçµæœã®å‡¦ç† ---
            if (newBbsData && !newBbsData.error) {
                // æˆåŠŸã—ãŸå ´åˆï¼šã‚¨ãƒ©ãƒ¼é …ç›®ã‚’æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§ç½®ãæ›ãˆã‚‹
                if (Array.isArray(newBbsData)) { // generateBbsComments ã¯é…åˆ—ã‚’è¿”ã™
                    tournamentState.bbsComments.splice(index, 1, ...newBbsData);
                } else { // generateBracketBbsThread ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™
                    tournamentState.bbsComments.splice(index, 1, newBbsData);
                }
            } else {
                 // å†ç”Ÿæˆã«å¤±æ•—ã—ãŸå ´åˆï¼šã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã¯ãã®ã¾ã¾ or æ›´æ–°
                 alert('å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                 btn.textContent = 'å†ç”Ÿæˆ'; // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                 btn.disabled = false;
                 // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’å…ƒã«æˆ»ã™å‡¦ç†ãŒå¿…è¦ãªå ´åˆ
                 // const errorEl = btn.closest('.article-error');
                 // if(errorEl) errorEl.innerHTML = `<span>${errorItem.title}</span> ... å†ç”Ÿæ€§ãƒœã‚¿ãƒ³HTML ...`;
            }
        } catch(err) {
             console.error("BBSå†ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼:", err);
             alert('å†ç”Ÿæˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
             btn.textContent = 'å†ç”Ÿæˆ'; // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
             btn.disabled = false;
        }

        renderBbsComments(tournamentState.bbsComments); // æ²ç¤ºæ¿ã‚’å†æç”»
        saveState();
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
});
    

// <script>ã‚¿ã‚°ã®ã€ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿‘ãã«è¿½åŠ 

document.body.addEventListener('change', (e) => {
    if (e.target.matches('#toggle-article-generation')) {
        tournamentState.settings.enableArticleGeneration = e.target.checked;
        saveState();
    }
    if (e.target.matches('#toggle-bbs-generation')) {
        tournamentState.settings.enableBbsGeneration = e.target.checked;
        saveState();
    }
// â–¼â–¼â–¼ ã“ã® else if ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    // --- å®ˆå‚™äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ ---
    else if (e.target.name === 'sub-timing') {
        const detailsDiv = document.getElementById('sub-modal-mid-inning-details');
        if (e.target.value === 'mid') {
            detailsDiv.classList.remove('hidden');
        } else {
            detailsDiv.classList.add('hidden');
        }
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

});

   // ==========================================================
//  2.ã€Œé€ä¿¡ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼ (æ–°è¨­)
// ==========================================================
document.body.addEventListener('submit', async (e) => {
    
    // --- æ²ç¤ºæ¿ã®ã€Œè¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã€ãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆ ---
    if (e.target.matches('.reply-form')) {
        e.preventDefault();
        const form = e.target;
        const parentCommentId = form.dataset.commentId;
        const bbsType = form.dataset.bbsType;
        const textarea = form.querySelector('textarea');
        const userReplyText = textarea.value;

        if (!userReplyText.trim()) return;

        form.innerHTML = `<div class="loader text-xs">AIãŒè¿”ä¿¡ã‚’è€ƒãˆã¦ã„ã¾ã™...</div>`;
        
        const commentSource = bbsType === 'general' ? tournamentState.bbsComments : tournamentState.daiyaBbsComments;
        const parentComment = findCommentById(commentSource, parentCommentId);
        const aiPersona = parentComment.personality;
        const context = { tournamentSummary: getTournamentStatusSummary() };
        
        const aiReply = await generateBbsReply(parentCommentId, userReplyText, bbsType, aiPersona, context);

        if (aiReply) {
            const freshParentComment = findCommentById(commentSource, parentCommentId);
            if (freshParentComment) {
                if (!freshParentComment.replies) {
                    freshParentComment.replies = [];
                }
                freshParentComment.replies.push(aiReply);
            }
            if (bbsType === 'general') renderBbsComments(tournamentState.bbsComments);
            else renderDaiyaBbsComments(tournamentState.daiyaBbsComments);
            saveState();
        } else {
            form.innerHTML = `<textarea class="w-full p-2 border rounded text-sm" placeholder="è¿”ä¿¡ã‚’å…¥åŠ›..." required></textarea><button type="submit" class="mt-1 bg-blue-500 text-white px-3 py-1 text-xs rounded hover:bg-blue-600">é€ä¿¡</button>`;
            alert("AIãŒè¿”ä¿¡ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
        }
    } 
    // --- ãƒ¡ã‚¤ãƒ³ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆ ---
    else if (e.target.matches('#main-comment-form')) {
        e.preventDefault();
        const textarea = document.getElementById('main-comment-textarea');
        const userCommentText = textarea.value;
        if (!userCommentText.trim()) return;

        textarea.disabled = true;
        e.target.querySelector('button').disabled = true;
        e.target.querySelector('button').textContent = 'AIãŒè¿”ä¿¡ä¸­...';

        const userComment = {
            id: crypto.randomUUID(),
            personality: 'ã‚ãªãŸ',
            text: userCommentText,
            timestamp: Date.now(),
            replies: []
        };
        
        const aiReplies = await generateMultipleReplies(userCommentText);
        userComment.replies = aiReplies;

        tournamentState.bbsComments.push(userComment);
        renderBbsComments(tournamentState.bbsComments);
        saveState();

        textarea.value = '';
        textarea.disabled = false;
        e.target.querySelector('button').disabled = false;
        e.target.querySelector('button').textContent = 'æŠ•ç¨¿ã™ã‚‹';
    }

}); // â˜…â˜…â˜… é–‰ã˜ã‚«ãƒƒã‚³ } ã®æ­£ã—ã„ä½ç½®ã¯ã“ã“ã§ã™ â˜…â˜…â˜…

// --- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œã“ã®è¨˜äº‹ã§ç¢ºå®šã€ãƒœã‚¿ãƒ³ ---
    document.getElementById('review-save-btn').addEventListener('click', () => {
        if (articleForReview) {
            // ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ç¾åœ¨ã®å†…å®¹ã§è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            articleForReview.title = document.getElementById('review-title').value;
            articleForReview.body = document.getElementById('review-body').value.replace(/\n/g, '\\n');
            
            // æ›´æ–°ã—ãŸè¨˜äº‹ã‚’ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã«è¿½åŠ 
            tournamentState.news.push(articleForReview);
            renderNews(tournamentState.news);
            saveState();
            
            closeReviewModal();
        }
    });

    // --- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³ ---
    document.getElementById('review-cancel-btn').addEventListener('click', () => {
        closeReviewModal();
    });

document.body.addEventListener('input', (e) => {
        if (e.target.matches('.match-summary-input')) {
            const matchId = e.target.dataset.matchId;
            let match;
            if (tournamentState.matches[matchId]) {
                match = tournamentState.matches[matchId];
            } else {
                 const [region, bracketId] = matchId.split('-');
                 if (tournamentState.autumnData?.regions[region]) {
                    const regionData = tournamentState.autumnData.regions[region];
                    if(bracketId.startsWith('B')) match = regionData.blocks.find(b=>b.id === `${region}-${bracketId}`).matches[matchId];
                    else if(bracketId === 'CHAMP') match = regionData.champBracket.matches[matchId];
                    else if(bracketId === 'REP') match = regionData.repechageBracket.matches[matchId];
                 }
            }
            if (match) {
                match.summary = e.target.value;
                saveState();
            }
        }

// â–¼â–¼â–¼ ã“ã® else if ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    // --- è©¦åˆå‰ã®é›°å›²æ°—/å…¬ç´„ ---
    else if (e.target.matches('.team-atmosphere-input')) {
        const matchId = e.target.dataset.matchId;
        const teamKey = e.target.dataset.teamKey; // 'team1' or 'team2'
        const match = findMatchById(matchId);

        if (match) {
            // 'atmosphere_team1' ã¾ãŸã¯ 'atmosphere_team2' ã¨ã„ã†ã‚­ãƒ¼ã§ä¿å­˜
            match[`atmosphere_${teamKey}`] = e.target.value;
            saveState(); // å…¥åŠ›ã™ã‚‹ãŸã³ã«è‡ªå‹•ä¿å­˜
        }
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ãŒå…¥åŠ›ã•ã‚ŒãŸå ´åˆ
    else if (e.target.closest('#inning-score-table')) {
        updateTotalScores();
    }


    
// â–¼â–¼â–¼ THIS IS THE NEW BLOCK TO ADD â–¼â–¼â–¼
    // --- When an "Inning Event" is typed in ---
    else if (e.target.matches('.inning-events-input')) {
        const teamKey = e.target.dataset.teamKey;
        const inningIndex = parseInt(e.target.dataset.inningIndex, 10);
        if (inningIndex >= 0) {
            updateInningState(teamKey, inningIndex); // Instantly update the out count
        }
    }
    // â–²â–²â–² END OF ADDITION â–²â–²â–²
});
// ==========================================================
//  ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã®ç›£è¦– (change)
// ==========================================================
document.body.addEventListener('change', (e) => {
    // --- æ‰“å¸­çµæœãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆ ---
    if (e.target.matches('.batting-result-part')) {
        const cell = e.target.closest('td.batting-result-cell');
        if (!cell) return;
        
        const inningIndex = Array.from(cell.parentElement.children).indexOf(cell) - 5;
        const teamKey = e.target.closest('table.batting-table').id.includes('team1') ? 'team1' : 'team2';
        
        if (inningIndex >= 0) {
            updateInningState(teamKey, inningIndex); // å³åº§ã«ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
        }
    }
});

    modalBg.addEventListener('click', () => newsModal.classList.add('hidden'));
    modalClose.addEventListener('click', () => newsModal.classList.add('hidden'));
    document.getElementById('details-save').addEventListener('click', saveDetailedStats);
    document.getElementById('details-close').addEventListener('click', () => detailsModal.classList.add('hidden'));
    saveLoadCloseBtn.addEventListener('click', () => saveLoadModal.classList.add('hidden'));
    newspaperCloseBtn.addEventListener('click', () => newspaperModal.classList.add('hidden'));
// â–¼â–¼â–¼ ã“ã®2è¡Œã‚’ 10953è¡Œç›® ã®ç›´å¾Œã«è¿½åŠ  â–¼â–¼â–¼
    const preGameModalClose = document.getElementById('pre-game-modal-close');
    if (preGameModalClose) preGameModalClose.addEventListener('click', () => document.getElementById('pre-game-modal').classList.add('hidden'));
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
document.getElementById('status-modal-close').addEventListener('click', () => {
    document.getElementById('team-status-modal').classList.add('hidden');
});

    saveTabBtn.addEventListener('click', () => {
        saveTabBtn.classList.add('border-blue-500'); saveTabBtn.classList.remove('text-gray-500');
        loadTabBtn.classList.remove('border-blue-500'); loadTabBtn.classList.add('text-gray-500');
        saveTabContent.classList.remove('hidden'); loadTabContent.classList.add('hidden');
    });
    loadTabBtn.addEventListener('click', () => {
        loadTabBtn.classList.add('border-blue-500'); loadTabBtn.classList.remove('text-gray-500');
        saveTabBtn.classList.remove('border-blue-500'); saveTabBtn.classList.add('text-gray-500');
        loadTabContent.classList.remove('hidden'); saveTabContent.classList.add('hidden');
    });
    generateSaveCodeBtn.addEventListener('click', () => {
        const jsonString = JSON.stringify(tournamentState);
        const compressed = pako.deflate(jsonString);
        const base64 = uint8ArrayToBase64(compressed);
        document.getElementById('save-code-output').textContent = base64;
        document.getElementById('save-code-area').classList.remove('hidden');
    });
    copySaveCodeBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(document.getElementById('save-code-output').textContent);
        const feedback = document.getElementById('copy-feedback');
        feedback.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
        setTimeout(() => { feedback.textContent = '' }, 2000);
    });
    loadFromCodeBtn.addEventListener('click', () => {
        try {
            const code = document.getElementById('load-code-input').value;
            const binaryString = atob(code);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }
            const decompressed = pako.inflate(bytes, { to: 'string' });
            const loadedState = JSON.parse(decompressed);
            tournamentState = loadedState;
            saveState();
            location.reload();
        } catch (e) {
            showAlert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
    });




    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
    initializeApp();
</script>

<script>
    mermaid.initialize({ startOnLoad: true });
</script>
<div id="pre-game-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center z-[150]">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 id="pre-game-title" class="text-xl font-bold">è©¦åˆå‰ å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
            <button id="pre-game-modal-close" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        
        <div class="flex border-b mb-4">
            <button id="pre-game-tab-team1" class="pre-game-team-tab py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent" data-team-key="team1">
                ï¼ˆãƒãƒ¼ãƒ 1ï¼‰
            </button>
            <button id="pre-game-tab-team2" class="pre-game-team-tab py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent" data-team-key="team2">
                ï¼ˆãƒãƒ¼ãƒ 2ï¼‰
            </button>
        </div>
        <div id="pre-game-body" class="overflow-y-auto space-y-3 p-2 bg-gray-50 rounded min-h-[200px]">
            <p class="text-gray-500 text-center p-8">â†‘ è¦‹ãŸã„ãƒãƒ¼ãƒ ã®å¿œæ´å¸­ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ â†‘</p>
        </div>
    </div>
</div>

<div id="substitution-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center z-[150]">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
        <h3 class="text-xl font-bold mb-4 border-b pb-3">å®ˆå‚™äº¤ä»£</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">é¸æ‰‹å</label>
                <input type="text" id="sub-modal-player-name" class="w-full bg-gray-100 p-2 border rounded" readonly>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="sub-modal-inning" class="block text-sm font-medium text-gray-700">ã‚¤ãƒ‹ãƒ³ã‚°</label>
                    <input type="number" id="sub-modal-inning" value="1" min="1" max="20" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="sub-modal-top-bottom" class="block text-sm font-medium text-gray-700">è¡¨ / è£</label>
                    <select id="sub-modal-top-bottom" class="w-full p-2 border rounded bg-white">
                        <option value="è¡¨">è¡¨</option>
                        <option value="è£">è£</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">äº¤ä»£ã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
                <div class="flex gap-4 mt-1">
                    <label><input type="radio" name="sub-timing" id="sub-modal-timing-start" value="start" checked> ã‚¤ãƒ‹ãƒ³ã‚°é–‹å§‹æ™‚</label>
                    <label><input type="radio" name="sub-timing" id="sub-modal-timing-mid" value="mid"> ã‚¤ãƒ‹ãƒ³ã‚°é€”ä¸­</label>
                </div>
            </div>

            <div id="sub-modal-mid-inning-details" class="hidden space-y-3 p-3 bg-gray-50 rounded border">
                <div>
                    <label for="sub-modal-outs" class="block text-sm font-medium text-gray-700">ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆ</label>
                    <select id="sub-modal-outs" class="w-full p-2 border rounded bg-white">
                        <option value="0">0ã‚¢ã‚¦ãƒˆ</option>
                        <option value="1">1ã‚¢ã‚¦ãƒˆ</option>
                        <option value="2">2ã‚¢ã‚¦ãƒˆ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ãƒ©ãƒ³ãƒŠãƒ¼çŠ¶æ³</label>
                    <div class="flex gap-4 mt-1">
                        <label><input type="checkbox" id="sub-modal-runner1"> 1å¡</label>
                        <label><input type="checkbox" id="sub-modal-runner2"> 2å¡</label>
                        <label><input type="checkbox" id="sub-modal-runner3"> 3å¡</label>
                    </div>
                </div>
            </div>
            <div>
                <label for="sub-modal-new-pos" class="block text-sm font-medium text-gray-700">æ–°ã—ã„å®ˆå‚™ä½ç½®</label>
                <select id="sub-modal-new-pos" class="w-full p-2 border rounded bg-white">
                    <option value="">- é¸æŠ -</option>
                    <option value="æŠ•">æŠ•æ‰‹ (æŠ•)</option>
                    <option value="æ•">æ•æ‰‹ (æ•)</option>
                    <option value="ä¸€">ä¸€å¡æ‰‹ (ä¸€)</option>
                    <option value="äºŒ">äºŒå¡æ‰‹ (äºŒ)</option>
                    <option value="ä¸‰">ä¸‰å¡æ‰‹ (ä¸‰)</option>
                    <option value="éŠ">éŠæ’ƒæ‰‹ (éŠ)</option>
                    <option value="å·¦">å·¦ç¿¼æ‰‹ (å·¦)</option>
                    <option value="ä¸­">ä¸­å …æ‰‹ (ä¸­)</option>
                    <option value="å³">å³ç¿¼æ‰‹ (å³)</option>
                </select>
            </div>
        </div>

        <div class="mt-6 text-center border-t pt-4">
            <button id="sub-modal-save" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 mr-4">
                äº¤ä»£ã‚’è¨˜éŒ²
            </button>
            <button id="sub-modal-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
        </div>
    </div>
</div>

    </body>
</html>