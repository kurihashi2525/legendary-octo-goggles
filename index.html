
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€æœ€çµ‚å®Ÿè£…ç‰ˆã€‘AIè¨˜è€…ä»˜ããƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨</title>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@700&display=swap" rel="stylesheet">
 <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
/* styleã‚¿ã‚°å†…ã®åˆ†ã‹ã‚Šã‚„ã™ã„å ´æ‰€ã«è¿½åŠ  */

/* â–¼â–¼â–¼ ãƒãƒ¼ãƒãƒ£ãƒ«ãƒãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ç”¨CSS (æ–°è¦è¿½åŠ ) â–¼â–¼â–¼ */
.virtual-card-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    z-index: 300; /* æœ€å‰é¢ */
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}
.virtual-card-overlay.active {
    opacity: 1;
    pointer-events: auto;
}

.virtual-card {
    width: 320px;
    background: linear-gradient(135deg, #ffffff 0%, #f3f4f6 100%);
    border-radius: 20px;
    box-shadow: 
        0 20px 50px rgba(0,0,0,0.3),
        0 0 0 1px rgba(255,255,255,0.5) inset;
    padding: 2rem;
    text-align: center;
    transform: scale(0.8) translateY(50px) rotateX(20deg);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    opacity: 0;
    position: relative;
    overflow: hidden;
}

.virtual-card-overlay.active .virtual-card {
    transform: scale(1) translateY(0) rotateX(0);
    opacity: 1;
}

/* ãƒ›ãƒ­ã‚°ãƒ©ãƒ é¢¨ã®å…‰æ²¢ */
.virtual-card::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: linear-gradient(
        45deg,
        rgba(255,255,255,0) 40%,
        rgba(255,255,255,0.4) 50%,
        rgba(255,255,255,0) 60%
    );
    transform: rotate(30deg);
    pointer-events: none;
    animation: hologramShine 6s infinite linear;
}

@keyframes hologramShine {
    0% { transform: translateY(-100%) rotate(30deg); }
    100% { transform: translateY(100%) rotate(30deg); }
}

/* ç”Ÿæˆã•ã‚ŒãŸãƒ­ã‚´ã‚¹ã‚¿ã‚¤ãƒ« */
.generated-logo {
    width: 110px;
    height: 110px;
    margin: 0 auto 1.5rem auto;
    border-radius: 50%; /* å††å½¢ï¼ˆæ ¡ç« é¢¨ï¼‰ */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Yuji Syuku', serif;
    color: white;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    box-shadow: 
        0 10px 25px rgba(0,0,0,0.3),
        0 0 0 4px rgba(255, 255, 255, 0.8), /* å†…å´ã®ç™½æ  */
        0 0 0 6px rgba(0, 0, 0, 0.1);      /* å¤–å´ã®è–„ã„å½±æ  */
    position: relative;
    z-index: 1;
    border: 2px solid white;
    overflow: hidden; /* èƒŒæ™¯æ¼”å‡ºã®ã¯ã¿å‡ºã—é˜²æ­¢ */
}

/* æ–‡å­—ï¼ˆé ­æ–‡å­—ï¼‰ */
.logo-initial {
    font-size: 3rem;
    font-weight: 900;
    line-height: 1;
    z-index: 2;
}

/* ã‚µãƒ–ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆèƒŒæ™¯ã«è–„ãæµ®ã‹ã¶ï¼‰ */
.logo-icon {
    position: absolute;
    font-size: 5rem;
    opacity: 0.3;
    z-index: 1;
    filter: blur(1px);
    transform: rotate(-15deg);
}

/* --- ãƒ†ãƒ¼ãƒåˆ¥ãƒ‡ã‚¶ã‚¤ãƒ³å®šç¾© --- */

/* ğŸŒŠ æµ·ãƒ»æ°´ç”£ãƒ»é’ç³» (ç„¼æ´¥æ°´ç”£, æµœå, 283å­¦åœ’ãªã©) */
.theme-ocean {
    background: linear-gradient(135deg, #0284c7 0%, #0ea5e9 50%, #38bdf8 100%);
    border-color: #bae6fd;
}
.theme-ocean .logo-initial { color: #f0f9ff; }

/* ğŸ”¥ ç†±è¡€ãƒ»ç«ãƒ»èµ¤ç³» (å¸¸è‘‰èŠå·, é£›é¾, ç†±æµ·ãªã©) */
.theme-fire {
    background: linear-gradient(135deg, #991b1b 0%, #dc2626 50%, #f87171 100%);
    border-color: #fca5a5;
}
.theme-fire .logo-initial { color: #fef2f2; }

/* ğŸŒ² æ£®ãƒ»å±±ãƒ»è¾²æ¥­ãƒ»ç·‘ç³» (å¤©ç«œ, ç”°æ–¹è¾²æ¥­, é™å²¡è¾²æ¥­ãªã©) */
.theme-nature {
    background: linear-gradient(135deg, #166534 0%, #22c55e 50%, #86efac 100%);
    border-color: #bbf7d0;
}
.theme-nature .logo-initial { color: #f0fdf4; }

/* âš™ï¸ å·¥æ¥­ãƒ»æŠ€è¡“ãƒ»ã‚°ãƒ¬ãƒ¼ç³» (æµœæ¾å·¥, å³¶ç”°å·¥, ç§‘å­¦æŠ€è¡“ãªã©) */
.theme-tech {
    background: linear-gradient(135deg, #374151 0%, #6b7280 50%, #9ca3af 100%);
    border-color: #e5e7eb;
}
.theme-tech .logo-initial { color: #f9fafb; text-shadow: 0 0 5px #000; }

/* ğŸ‘‘ ç‹è€…ãƒ»ä¼çµ±ãƒ»ç´«ç´ºç³» (é™å²¡, é™å²¡å•†, 765ç·åˆãªã©) */
.theme-royal {
    background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 50%, #a78bfa 100%);
    border-color: #ddd6fe;
}
.theme-royal .logo-initial { color: #fff; }

/* ğŸ¯ çŒ›è™ãƒ»å•†æ¥­ãƒ»é»„è‰²ç³» (å¾¡æ®¿å ´è¥¿, èª æµãªã©) */
.theme-tiger {
    background: linear-gradient(135deg, #854d0e 0%, #eab308 50%, #fde047 100%);
    border-color: #fef08a;
    color: #422006; /* æ–‡å­—è‰²ã‚’æ¿ƒã */
}
.theme-tiger .logo-initial { text-shadow: none; color: #422006; }

/* ğŸŒ¸ ã‚¢ã‚¤ãƒ‰ãƒ«ãƒ»å¥³å­ãƒ»ãƒ”ãƒ³ã‚¯ç³» (åˆæ˜Ÿå­¦åœ’ãªã©) */
.theme-idol {
    background: linear-gradient(135deg, #be185d 0%, #ec4899 50%, #fbcfe8 100%);
    border-color: #fce7f3;
}

/* â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² */

.card-rank-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-weight: bold;
    font-size: 0.9rem;
    padding: 4px 12px;
    border-radius: 20px;
    color: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.card-team-name {
    font-size: 1.8rem;
    font-weight: 800;
    color: #1f2937;
    margin-bottom: 0.5rem;
    font-family: 'Yuji Syuku', serif;
    line-height: 1.2;
}

.card-info-text {
    font-size: 0.85rem;
    color: #4b5563;
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.card-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 1.5rem;
    background: rgba(255,255,255,0.5);
    padding: 10px;
    border-radius: 10px;
}

.card-stat-item {
    display: flex;
    flex-direction: column;
}
.card-stat-label { font-size: 0.7rem; color: #6b7280; font-weight: bold; }
.card-stat-value { font-size: 1.1rem; font-weight: 800; color: #1f2937; }

.card-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
}

/* ãƒãƒ¼ãƒ ã‚«ãƒ©ãƒ¼åˆ¥ã®èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
.logo-bg-red { background: linear-gradient(135deg, #ef4444, #b91c1c); }
.logo-bg-blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
.logo-bg-purple { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
.logo-bg-green { background: linear-gradient(135deg, #10b981, #047857); }
.logo-bg-orange { background: linear-gradient(135deg, #f97316, #c2410c); }
.logo-bg-gray { background: linear-gradient(135deg, #6b7280, #374151); }

/* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */


.player-profile-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
            padding: 1rem;
            transition: all 0.2s ease-out;
        }
        .player-profile-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
        }
        .player-profile-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .player-profile-number {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 900;
            color: #1e3a8a; /* 283å­¦åœ’ã®ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ */
            line-height: 1;
            margin-right: 0.75rem;
        }
        .player-profile-name {
            font-size: 1.125rem; /* text-xl */
            font-weight: 700;
            color: #1f2937; /* text-gray-800 */
            flex-grow: 1;
        }
        .player-profile-grade {
            font-size: 0.875rem; /* text-sm */
            font-weight: 700;
            color: #1e3a8a;
        }
        .player-profile-captain {
            font-size: 0.75rem;
            font-weight: 700;
            color: #b91c1c; /* text-red-700 */
            margin-left: 0.25rem;
        }
        .player-profile-body {
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* text-gray-600 */
            line-height: 1.6;
        }
        .player-profile-body strong {
            color: #1f2937; /* text-gray-800 */
            font-weight: 600;
            margin-right: 0.25rem;
        }



       
        #campus-map-container {
            position: relative;
            width: 100%;
            max-width: 800px; 
            margin: 1.5rem auto; /* ä¸Šä¸‹ã«ãƒãƒ¼ã‚¸ãƒ³ã€å·¦å³ã«auto */
            aspect-ratio: 16 / 9;
            background-color: #e5e7eb; /* bg-gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }
        #campus-map-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: grayscale(30%) brightness(1.1);
        }

        /* 2. ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ (+) ãƒœã‚¿ãƒ³ */
        .hotspot {
            position: absolute;
            width: 32px;
            height: 32px;
            background-color: #1e3a8a; /* 283å­¦åœ’ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ */
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            transition: all 0.2s ease-out;
            /* è„ˆå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            animation: hotspotPulse 2s infinite ease-in-out;
        }
        .hotspot:hover {
            transform: scale(1.2);
            animation-play-state: paused; /* ãƒ›ãƒãƒ¼ä¸­ã¯è„ˆå‹•ã‚’åœæ­¢ */
        }
        @keyframes hotspotPulse {
            0% { transform: scale(1); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 6px 25px rgba(30, 58, 138, 0.7); }
            100% { transform: scale(1); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); }
        }
        .hotspot > span {
            pointer-events: none; /* ä¸­ã®+ãƒãƒ¼ã‚¯ãŒã‚¯ãƒªãƒƒã‚¯ã‚’é‚ªé­”ã—ãªã„ã‚ˆã†ã« */
        }

        /* 3. ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆãƒ»ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .hotspot-popup {
            position: absolute;
            width: 280px;
            background-color: white;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 60; /* ãƒ˜ãƒƒãƒ€ãƒ¼(z-50)ã‚ˆã‚Šæ‰‹å‰ */
            /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
            opacity: 0;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            pointer-events: none; /* è¦‹ãˆãªã„ã¨ãã¯ã‚¯ãƒªãƒƒã‚¯ã•ã›ãªã„ */
            transform: translateY(0);
        }
        .hotspot-popup.visible {
            opacity: 1;
            transform: translateY(-10px); /* å°‘ã—æµ®ãä¸ŠãŒã‚‹ */
            pointer-events: auto;
        }
        .hotspot-popup-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .hotspot-popup-content {
            padding: 1rem;
        }
        .hotspot-popup-title {
            font-weight: 700;
            font-size: 1.125rem; /* text-lg */
            color: #1e3a8a; /* 283å­¦åœ’ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ */
            margin-bottom: 0.5rem;
        }
        .hotspot-popup-text {
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* text-gray-600 */
        }
        .hotspot-popup-close {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 28px;
            height: 28px;
            background-color: #4b5563; /* text-gray-600 */
            color: white;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        /* â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* â–¼â–¼â–¼ å‹¢åŠ›å›³åˆ†æã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®CSSï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿®æ­£ç‰ˆï¼‰â–¼â–¼â–¼ */
#analysis-stage {
    background: radial-gradient(ellipse at center, rgba(15, 23, 42, 1) 0%, rgba(0, 0, 0, 1) 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    padding: 2rem; /* å†…å´ã«ä½™ç™½ã‚’è¿½åŠ  */
}
.round-column {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    height: 100%;
}
.analysis-matchup {
    margin: 10px 0;
    position: relative;
}
.analysis-team {
    padding: 4px 10px;
    background-color: rgba(0, 183, 255, 0.2);
    border: 1px solid rgba(0, 183, 255, 0.7);
    color: #e0f2fe;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.9rem;
    margin: 4px 0;
    transition: all 0.5s ease-in-out;
    opacity: 0;
    width: 150px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    /* â–¼â–¼â–¼ ä»¥ä¸‹ã®2è¡Œã‚’å‰Šé™¤ã€ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ â–¼â–¼â–¼ */
    /* position: absolute; */
    /* â–²â–²â–² */
}
.analysis-team.show {
    opacity: 1;
}
.analysis-team.highlight {
    background-color: rgba(255, 204, 0, 0.4);
    border-color: rgba(255, 204, 0, 1);
    color: white;
    transform: scale(1.1);
    box-shadow: 0 0 15px rgba(255, 204, 0, 0.7);
}

.new-thread-modal {
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.75);
    display: flex; /* hidden/flexã§è¡¨ç¤ºåˆ‡æ›¿ */
    align-items: center;
    justify-content: center;
    z-index: 250; /* ã¾ã¨ã‚ã‚µã‚¤ãƒˆã‚ˆã‚Šæ‰‹å‰ */
}

/* å‹ã¡ä¸ŠãŒã‚Šç·šã®ã‚¹ã‚¿ã‚¤ãƒ« */
.matchup-connector {
    position: absolute;
    top: 50%;
    right: -20px;
    width: 20px;
    height: 2px;
    background-color: rgba(0, 183, 255, 0.5);
}
.round-connector {
    position: absolute;
    top: 25%;
    right: -30px;
    width: 2px;
    height: 50%;
    background-color: rgba(0, 183, 255, 0.5);
}
/* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */

/* â–¼â–¼â–¼ ã‚¹ã‚«ã‚¦ãƒ†ã‚£ãƒ³ã‚°ãƒ¬ãƒãƒ¼ãƒˆç”¨CSS (æ–°è¦è¿½åŠ ) â–¼â–¼â–¼ */
.scout-report-card {
    background-color: #f0fdf4; /* è–„ã„ç·‘ */
    border-left: 5px solid #16a34a; /* ç·‘ã®ãƒ©ã‚¤ãƒ³ */
    font-family: 'Noto Serif JP', serif; /* æ˜æœä½“ã§ç„äººæ„Ÿã‚’å‡ºã™ */
}
.scout-report-title {
    color: #14532d;
    font-weight: bold;
    border-bottom: 1px dashed #16a34a;
    padding-bottom: 0.5rem;
    margin-bottom: 0.5rem;
}
.scout-report-body {
    font-size: 0.95rem;
    line-height: 1.8;
    color: #374151;
}
.scout-signature {
    text-align: right;
    font-weight: bold;
    margin-top: 1rem;
    color: #16a34a;
}
/* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* ã¾ã¨ã‚ã‚µã‚¤ãƒˆã®ãƒ­ã‚´ã‚¹ã‚¿ã‚¤ãƒ« */
.matome-site-logo-container {
    position: relative;
    width: 80px; /* ãƒ­ã‚´ã®å¹… */
    height: 50px; /* ãƒ­ã‚´ã®é«˜ã• */
    overflow: hidden;
    border-radius: 5px; /* è§’ã‚’å°‘ã—ä¸¸ã‚ã‚‹ */
    box-shadow: 0 2px 4px rgba(0,0,0,0.3); /* å½±ã§ç«‹ä½“æ„Ÿã‚’å‡ºã™ */
}

.matome-site-logo-bg {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ç”»åƒã‚’ã‚³ãƒ³ãƒ†ãƒŠã«åˆã‚ã›ã¦è¡¨ç¤º */
    position: absolute;
    top: 0;
    left: 0;
    filter: brightness(0.7) blur(1px); /* å°‘ã—æš—ãã€ã¼ã‹ã—ã¦æ–‡å­—ã‚’èª­ã¿ã‚„ã™ã */
}

.matome-site-logo-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    font-size: 0.9rem; /* æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8); /* æ–‡å­—ã®è¦–èªæ€§ã‚’é«˜ã‚ã‚‹å½± */
    white-space: nowrap; /* ãƒ†ã‚­ã‚¹ãƒˆã®æŠ˜ã‚Šè¿”ã—ã‚’é˜²ã */
}

/* æ–°ã—ã„ã¾ã¨ã‚ã‚µã‚¤ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º (TailwindCSS JIT mode with plugins is better, but this is a quick fix) */
.scrollbar-thin {
    scrollbar-width: thin;
    scrollbar-color: #a0aec0 #edf2f7; /* thumb color track color */
}

.scrollbar-thin::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.scrollbar-thin::-webkit-scrollbar-thumb {
    background-color: #a0aec0; /* gray-400 */
    border-radius: 10px;
    border: 2px solid #edf2f7; /* gray-200 */
}

.scrollbar-thin::-webkit-scrollbar-track {
    background-color: #edf2f7; /* gray-200 */
    border-radius: 10px;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ­ã‚´ç”»åƒã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¸¦æ–¹å‘ã«ä¸­å¤®æƒãˆ */
#integrated-matome-modal .flex.justify-between.items-center img {
    vertical-align: middle;
}

/* ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.matome-tab-btn {
    position: relative;
    z-index: 1;
    margin-right: -1px; /* ã‚¿ãƒ–é–“ã®éš™é–“ã‚’ãªãã™ */
    border: 1px solid #e2e8f0; /* gray-300 */
    border-bottom: none;
    background-color: #f7fafc; /* gray-50 */
}
.matome-tab-btn.active {
    background-color: #2563eb; /* blue-600 */
    color: white;
    border-color: #2563eb; /* active tab border color */
    border-bottom-color: transparent;
    z-index: 2;
}

/* è¨˜äº‹ãƒªãƒ³ã‚¯ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
.matome-article-link p.font-bold:hover {
    color: #2563eb; /* blue-600 */
    text-decoration: underline;
}

/* BBSã‚³ãƒ¡ãƒ³ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
.bbs-comment {
    background-color: #ffffff;
    border: 1px solid #e2e8f0;
    padding: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}
.bbs-comment p.font-semibold {
    color: #4a5568; /* gray-700 */
    font-size: 0.875rem; /* text-sm */
    margin-bottom: 0.25rem;
}
.bbs-comment p.text-gray-800 {
    color: #2d3748; /* gray-800 */
    line-height: 1.5;
}

/* â–¼â–¼â–¼ æ–°ã—ã„ãƒ­ãƒ¼ãƒ€ãƒ¼ç”¨ã®CSS â–¼â–¼â–¼ */
.loader {
    text-align: center;
    padding: 40px 20px;
    font-style: italic;
    color: #4b5563; /* gray-600 */
    font-size: 1.1rem;
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 8px;
    margin: 1rem 0;
}

.loader .ellipsis span {
    opacity: 0;
    animation: pulse-ellipsis 1.4s infinite;
}
.loader .ellipsis span:nth-child(1) { animation-delay: 0s; }
.loader .ellipsis span:nth-child(2) { animation-delay: 0.2s; }
.loader .ellipsis span:nth-child(3) { animation-delay: 0.4s; }

@keyframes pulse-ellipsis {
    0% { opacity: 0.2; }
    50% { opacity: 1; }
    100% { opacity: 0.2; }
}
/* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */

/* â–¼â–¼â–¼ ç¦ã€…ã—ã„é›°å›²æ°—ç”¨ã®CSS â–¼â–¼â–¼ */
.dread-mode-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(127, 29, 29, 0.5); /* ä¸æ°—å‘³ãªèµ¤è‰²ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    z-index: 199; /* æŠ½é¸ä¼šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã™ãä¸‹ */
    pointer-events: none;
    animation: fadeIn 0.5s forwards;
}

#lottery-pot.dread {
    background-color: #7f1d1d; /* red-900 */
    border-color: #fca5a5; /* red-300 */
    animation: pulse-dread 1s infinite;
}

@keyframes pulse-dread {
    0%, 100% {
        transform: scale(1.05);
        box-shadow: 0 0 15px 5px rgba(255, 100, 100, 0.7);
    }
    50% {
        transform: scale(1.1);
        box-shadow: 0 0 30px 15px rgba(255, 100, 100, 0.9);
    }
}
/* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */

/* â–¼â–¼â–¼ æŠ½é¸ä¼šã‚¤ãƒ™ãƒ³ãƒˆç”¨ã®CSS â–¼â–¼â–¼ */
#drawn-team-container.fade-in-out {
    animation: fadeInOut 2.5s ease-in-out forwards;
}

@keyframes fadeInOut {
    0% { opacity: 0; transform: scale(0.8); }
    20%, 80% { opacity: 1; transform: scale(1); }
    100% { opacity: 0; transform: scale(0.8); }
}

.lottery-slot {
    border: 1px solid #d1d5db;
    background-color: #f3f4f6;
    padding: 4px 8px;
    font-size: 14px;
    font-weight: 500;
    border-radius: 4px;
    transition: all 0.3s ease-in-out;
}
.lottery-slot.filled {
    background-color: #fffbeb; /* amber-100 */
    border-color: #f59e0b; /* amber-500 */
    font-weight: 700;
    transform: scale(1.05);
}
.lottery-slot.highlight {
    background-color: #ef4444; /* red-500 */
    color: white;
    border-color: #b91c1c; /* red-700 */
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
.animate-fade-in-up {
    animation: fadeInUp 0.5s ease-out forwards;
}
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
/* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */

/* Weather Effects */
.rain {
    position: absolute;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2;
}
.drop {
    position: absolute;
    bottom: 100%;
    width: 1px;
    height: 50px;
    background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.4));
    animation: drop 0.5s linear infinite;
}
@keyframes drop {
    to { transform: translateY(100vh); }
}

.sunshine {
    position: absolute;
    top: -50px;
    left: -50px;
    width: 100px;
    height: 100px;
    z-index: 2;
}
.sun {
    position: absolute;
    width: 100px;
    height: 100px;
    background: radial-gradient(circle, rgba(255,255,220,0.8) 0%, rgba(255,255,220,0) 60%);
    border-radius: 50%;
}
.sun-flare {
    position: absolute;
    width: 200px;
    height: 200px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    animation: flare 5s infinite;
}
@keyframes flare {
    0% { transform: scale(1); opacity: 0.1; }
    50% { transform: scale(1.2); opacity: 0.2; }
    100% { transform: scale(1); opacity: 0.1; }
}

/* Weather Control Buttons */
.weather-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.5);
    background-color: rgba(255, 255, 255, 0.2);
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}
.weather-btn:hover {
    background-color: rgba(255, 255, 255, 0.4);
    border-color: white;
}

/* â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ  â–¼â–¼â–¼ */
        .subtitle-text {
            color: white;
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.7);
        }
        .setup-header {
            color: white !important; /* Tailwind CSSã‚ˆã‚Šå„ªå…ˆã•ã›ã‚‹ */
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.7);
            border-bottom-color: rgba(255, 255, 255, 0.5) !important; /* ä¸‹ç·šã‚‚ç™½ã£ã½ãã™ã‚‹ */
        }
        /* â–²â–²â–² â–²â–²â–² */
/* ãƒãƒ¼ãƒ é€šç®—æˆç¸¾ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.team-stats-tab-btn {
    border-color: transparent;
    color: #6b7280; /* text-gray-500 */
    padding: 0.5rem 1rem;
    font-weight: 600;
    border-bottom-width: 2px;
}
.team-stats-tab-btn:hover {
    color: #1f2937; /* text-gray-800 */
}
.team-stats-tab-btn.active {
    color: #2563eb; /* text-blue-600 */
    border-color: #2563eb; /* border-blue-600 */
}
.team-stats-tab-content.hidden {
    display: none;
}
/* ã‚¹ã‚¿ãƒ¡ãƒ³å±¥æ­´ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.lineup-history-tournament {
    margin-bottom: 1.5rem;
}
.lineup-history-title {
    font-size: 1.25rem; /* text-xl */
    font-weight: 700;
    color: #1f2937; /* text-gray-800 */
    border-bottom: 2px solid #e5e7eb; /* border-gray-200 */
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}
.lineup-history-match {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px dashed #d1d5db; /* border-gray-300 */
}
.lineup-history-match:last-child {
    border-bottom: none;
    margin-bottom: 0;
}
.lineup-history-match-header {
    font-size: 1rem;
    font-weight: 600;
    color: #1e3a8a; /* text-blue-800 */
    margin-bottom: 0.5rem;
}
/* ã‚¹ã‚³ã‚¢ãƒ–ãƒƒã‚¯é¢¨ãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
.lineup-history-list {
    display: grid;
    /* ç”»é¢å¹…ã«å¿œã˜ã¦åˆ—æ•°ã‚’è‡ªå‹•èª¿æ•´ */
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 0.5rem 1rem;
    font-family: 'Yuji Syuku', serif; 
    font-size: 1rem; /* å°‘ã—ãƒ•ã‚©ãƒ³ãƒˆã‚’å¤§ãã */
}
/* â–¼â–¼â–¼ ã‚¹ãƒãƒ¼ãƒ„å ±çŸ¥é¢¨ Webè¨˜äº‹ãƒ‡ã‚¶ã‚¤ãƒ³ â–¼â–¼â–¼ */
        .newspaper-container { 
            font-family: 'Noto Sans JP', sans-serif; 
            padding: 1.5rem; 
            background-color: #ffffff; 
            border: 1px solid #ddd;
        }
        .newspaper-early { /* æ˜”ã®è©¦åˆã¯ç™½é»’ã« */
            filter: grayscale(80%);
        }
        .newspaper-late { /* æœ€è¿‘ã®è©¦åˆã¯ã‚«ãƒ©ãƒ¼ */
            border-top: 4px solid #a10e25;
        }
        .newspaper-header { 
            text-align: left; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 0.75rem; 
            margin-bottom: 1rem; 
        }
        .newspaper-title { /* ã‚¹ãƒãƒ¼ãƒ„å ±çŸ¥ */
            font-size: 1.5rem; 
            font-weight: 700;
            color: #d00;
            font-family: 'sans-serif'; /* ãƒ­ã‚´é¢¨ */
        }
        .newspaper-date { 
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
        }
        
        /* ç¸¦æ›¸ããƒ»flexãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å»ƒæ­¢ */
        .newspaper-content { 
            /* display: flex; ã‚’å‰Šé™¤ */
        }
        
        /* ãƒ¡ã‚¤ãƒ³è¦‹å‡ºã— (ç¸¦æ›¸ã -> æ¨ªæ›¸ã) */
        .newspaper-main-headline { 
            /* writing-mode ã‚’å‰Šé™¤ */
            font-size: 2.25rem; /* 36px */
            font-weight: 900; 
            color: #222;
            line-height: 1.3;
            letter-spacing: 0.05em;
            /* border-right ã‚’å‰Šé™¤ */
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #333;
        }
        .newspaper-late .newspaper-main-headline { 
            color: #a10e25;
            border-bottom-color: #a10e25;
        }

        /* ã‚µãƒ–è¦‹å‡ºã— (è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ« -> ãƒªãƒ¼ãƒ‰æ–‡) */
        .newspaper-sub-headline { 
            font-size: 1.1rem; /* 18px */
            font-weight: 700; 
            color: #333;
            margin-bottom: 1.5rem; 
            border: none;
            padding-bottom: 0;
            line-height: 1.7;
            background-color: #f9f9f9;
            padding: 1rem;
            border-radius: 4px;
            border-left: 4px solid #a10e25;
        }
        
        /* å†™çœŸ (æœ¬æ–‡ã®å‰ã«ç§»å‹•) */
        .newspaper-image-placeholder { 
            width: 100%; 
            max-width: 600px;
            margin: 0 auto 0.5rem auto; /* ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã¨ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´ */
            height: auto;
            aspect-ratio: 16 / 10;
            background-color: #e0e0e0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-family: 'Noto Sans JP', sans-serif; 
            color: #888; 
            border: 1px dashed #aaa; 
            border-radius: 4px;
        }
        /* å†™çœŸã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ (sinbun.txtã®figcaptionå‚è€ƒ) */
        .newspaper-image-caption {
            font-size: 0.85rem;
            color: #555;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        /* æœ¬æ–‡ (å¤šæ®µçµ„ã‚’å»ƒæ­¢) */
        .newspaper-text { 
            font-family: 'Noto Sans JP', sans-serif; 
            /* column-count ã‚’å‰Šé™¤ */
            text-align: left; /* justify ã‚’ã‚„ã‚ã‚‹ */
            font-size: 1rem; /* 16px */
            line-height: 1.9; /* è¡Œé–“ã‚’åºƒãã¨ã‚‹ */
            color: #333;
        }

        /* ã‚¹ã‚³ã‚¢ãƒœãƒƒã‚¯ã‚¹ (ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ›´) */
        .newspaper-score-box { 
            border: 1px solid #ccc; 
            padding: 1rem; 
            text-align: center; 
            margin-top: 2rem; 
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .newspaper-score-box h3 { 
            font-weight: 700; 
            margin-bottom: 0.75rem; 
            font-size: 1rem; 
            color: #333;
        }
        .newspaper-score-box .score { 
            font-size: 1.75rem; 
            font-weight: 700;
            color: #000;
        }
        .newspaper-late .newspaper-score-box { 
            background-color: #fff8f8; 
            border-color: #a10e25; 
        }
        /* â–²â–²â–² ã‚¹ãƒãƒ¼ãƒ„å ±çŸ¥é¢¨ Webè¨˜äº‹ãƒ‡ã‚¶ã‚¤ãƒ³ ã“ã“ã¾ã§ â–²â–²â–² */
.lineup-history-list li {
    padding-left: 0.5rem;
    white-space: nowrap;
}
/* â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ  â–¼â–¼â–¼ */
     .main-title {
            font-family: 'Yuji Syuku', serif;
            font-size: 3rem; /* å°‘ã—å¤§ããã—ã¦è¿«åŠ›ã‚’å‡ºã™ */
            letter-spacing: 0.2em; /* æ–‡å­—é–“ã‚’èª¿æ•´ */
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
            animation: fadeIn 2s ease-in-out; /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        }

        .subtitle-text {
            color: white;
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.7);
            animation: fadeIn 2.2s ease-in-out; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  */
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã‚’ã‚¬ãƒ©ã‚¹ãƒ‘ãƒãƒ«é¢¨ã« */
        .setup-card {
            background-color: rgba(10, 10, 20, 0.65) !important; /* åŠé€æ˜èƒŒæ™¯ã‚’å„ªå…ˆ */
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px); /* èƒŒæ™¯ã‚’ã¼ã‹ã™ï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰ */
            padding: 2.5rem !important; /* paddingã‚’èª¿æ•´ */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            animation: fadeIn 1.5s ease-in-out;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .setup-header {
            color: white !important;
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.7);
            border-bottom-color: rgba(255, 255, 255, 0.5) !important;
        }

        /* ãƒãƒ¼ãƒ ä¸€è¦§ã‚¨ãƒªã‚¢ã‚’åç°¿é¢¨ã« */
        #teams-list {
            background-color: rgba(0, 0, 0, 0.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #f0f0f0 !important;
            font-size: 0.9rem;
            line-height: 1.6;
            padding: 1.5rem !important;
        }

        /* ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  */
        #setup .mt-8 {
            animation: fadeIn 2.5s ease-in-out;
        }

        /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šç¾© */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

/* 5. æ‰“ç‚¹(RBI)ãƒœã‚¿ãƒ³ */
        .rbi-btn {
            border: 2px solid #16a34a; /* border-green-600 */
            background-color: #f0fdf4; /* bg-green-50 */
            color: #15803d; /* text-green-700 */
            padding: 0.75rem 0.5rem;
            font-size: 1rem; /* text-base */
            font-weight: 700;
            border-radius: 0.375rem; /* rounded-md */
            transition: all 0.1s ease-in;
            text-align: center;
        }
        .rbi-btn:hover {
            background-color: #16a34a; /* hover:bg-green-600 */
            color: white;
            transform: scale(1.05);
        }
        /* â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */
/* â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ <style> ã‚¿ã‚°å†…ã«ã€Œæ–°è¦è¿½åŠ ã€ â–¼â–¼â–¼ */
/* å€‹äººé€šç®—æˆç¸¾ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.player-stats-header {
    text-align: center;
    border-bottom: 2px solid #1e3a8a;
    margin-bottom: 1rem;
}
.player-stats-name {
    font-size: 1.75rem; /* text-2xl */
    font-weight: 700;
    color: #1f2937; /* text-gray-800 */
}
.player-stats-team {
    font-size: 1rem;
    font-weight: 500;
    color: #4b5563; /* text-gray-600 */
    margin-bottom: 0.5rem;
}
.stats-section-title {
    font-size: 1.25rem; /* text-xl */
    font-weight: 700;
    color: #1e3a8a; /* text-blue-800 */
    margin-bottom: 0.75rem;
    border-bottom: 1px solid #dbeafe; /* border-blue-200 */
    padding-bottom: 0.25rem;
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4åˆ—ã‚°ãƒªãƒƒãƒ‰ */
    gap: 0.75rem;
    background-color: #f9fafb; /* bg-gray-50 */
    padding: 0.75rem;
    border-radius: 0.375rem;
}
.stats-grid-item {
    text-align: center;
    background-color: #ffffff;
    padding: 0.5rem;
    border-radius: 0.25rem;
    border: 1px solid #e5e7eb;
}
.stats-grid-item .stats-label {
    font-size: 0.75rem; /* text-xs */
    font-weight: 600;
    color: #6b7280; /* text-gray-500 */
    text-transform: uppercase;
}
.stats-grid-item .stats-value {
    font-size: 1.5rem; /* text-2xl */
    font-weight: 700;
    color: #1f2937;
    line-height: 1.2;
}
.stats-grid-item.highlight .stats-value {
    color: #1e3a8a; /* text-blue-800 */
}
/* â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ  â–¼â–¼â–¼ */
#news-ticker-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    display: flex;
    align-items: center;
    z-index: 50; /* ä»–ã®è¦ç´ ã‚ˆã‚Šæ‰‹å‰ã« */
    height: 30px;
    font-family: 'Noto Sans JP', sans-serif;
    border-top: 1px solid rgba(255, 255, 255, 0.3);
}
.ticker-label {
    background-color: #e53935; /* èµ¤è‰² */
    font-weight: bold;
    padding: 0 12px;
    height: 100%;
    display: flex;
    align-items: center;
    font-size: 0.9rem;
}
.ticker-content {
    flex-grow: 1;
    overflow: hidden; /* ã¯ã¿å‡ºã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’éš ã™ */
    padding-left: 1rem;
}
#ticker-text {
    white-space: nowrap; /* ãƒ†ã‚­ã‚¹ãƒˆã‚’æ”¹è¡Œã•ã›ãªã„ */
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã‚’å°‘ã—é•·ã‚ã«è¨­å®šã—ã¦ã‚†ã£ãã‚Šæµã™ */
    animation: scroll-ticker 40s linear infinite;
}
@keyframes scroll-ticker {
    0% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
}
/* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */

/* å†™å®Ÿçš„ãªå¤©å€™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
   /* å†™å®Ÿçš„ãªå¤©å€™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆâ˜…èª¿æŸ»ãƒ¢ãƒ¼ãƒ‰â˜…ï¼‰ */
/* èƒŒæ™¯ç”»åƒ */
.ballpark-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1; /* Layer 1 (Bottom) */
    /* â–¼â–¼â–¼ This line is the only change â–¼â–¼â–¼ */
    background-image: url('ballpark.jpg'); /* Use the local image */
    /* â–²â–²â–² END OF CHANGE â–²â–²â–² */
    background-size: cover;
    background-position: center;
    filter: blur(2px) brightness(0.7);
    animation: subtle-breathing 20s ease-in-out infinite;
}
/* åœŸåŸƒã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚³ãƒ³ãƒ†ãƒŠ */
#dust-container {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã®é‚ªé­”ã‚’ã—ãªã„ */
    z-index: 2; /* éšå±¤2ï¼ˆä¸­é–“ï¼‰ */
}
/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚³ãƒ³ãƒ†ãƒŠ */
#app-container {
    position: relative; /* z-indexã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ */
    z-index: 3; /* éšå±¤3ï¼ˆä¸€ç•ªæ‰‹å‰ï¼‰ */
}
@keyframes subtle-breathing {
    0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); }
}
.dust-particle {
    position: absolute; background-color: rgba(255, 255, 255, 0.5);
    border-radius: 50%; opacity: 0; animation: drift-up linear infinite;
}
@keyframes drift-up {
    0% { transform: translateY(100vh) translateX(var(--x-start)); opacity: 0; }
    10% { opacity: 1; } 90% { opacity: 1; }
    100% { transform: translateY(-100px) translateX(var(--x-end)); opacity: 0; }
}
/* Input field color-coding */
.result-hit { background-color: #eff6ff !important; color: #1d4ed8; } /* Blue for hits */
.result-out { background-color: #fee2e2 !important; color: #b91c1c; } /* Red for outs */
.result-on-base { background-color: #f0fdf4 !important; color: #15803d; } /* Green for walks, etc. */

.clickable-team-name {
    cursor: pointer;
    transition: color 0.2s;
}
.clickable-team-name:hover {
    color: #1d4ed8; /* blue-700 */
}
        body { 
    font-family: 'Inter', 'Noto Sans JP', sans-serif; 
}
.setup-card { 
    background-color: transparent; /* èƒŒæ™¯ã‚’é€æ˜ã« */
    padding: 24px; 
    border-radius: 12px; 
    box-shadow: none; /* å½±ã‚’å‰Šé™¤ */
    margin-bottom: 24px;
}
.display-card {
    background-color: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 24px;
}
        #main-bracket-container { display: flex; justify-content: flex-start;
 padding: 20px; font-size: 12px; overflow-x: auto; border: 1px solid #e5e7eb; background-color: #f9fafb; border-radius: 8px;}
        .bracket-half { display: flex; }
        .bracket-half.right { flex-direction: row-reverse; }
        .bracket-final { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0 10px; flex-shrink: 0; min-width: 60px; }
        .bracket-final .final-matchup { border: 2px solid #f59e0b; background-color: #fffbeb; border-radius: 6px; padding: 5px; margin-top: 10px; }
        .bracket-final .winner-box { font-weight: bold; color: #b45309; text-align: center; padding: 10px 20px; white-space: nowrap; font-size: 1.25rem; }
        .bracket-final .final-title { font-weight: 600; color: #4b5563; margin-bottom: 10px; writing-mode: vertical-rl; letter-spacing: 2px; }
        .round { display: flex; flex-direction: column; justify-content: space-around; flex-shrink: 0; width: 280px; padding: 0 10px; }
        .matchup { margin: 8px 0; position: relative; display: flex; flex-direction: column; justify-content: center; flex-grow: 1; }
        .team-slot { display: flex; align-items: center; background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 4px; transition: background-color 0.3s; position: relative; }
        .team-slot:last-of-type { margin-bottom: 0; }
        .team-name { flex-grow: 1; padding: 6px 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .team-name .rank { font-weight: bold; margin-right: 4px; }
        .team-name .rank-A { color: #ef4444; }
        .team-name .rank-B { color: #f97316; }
        .team-name .rank-C { color: #eab308; }
        .team-name .rank-D { color: #3b82f6; }
        .team-name .rank-E { color: #6b7280; }
        .team-name.seed { font-weight: bold; color: #ca8a04; }
        .score-input { width: 40px; padding: 6px 4px; border-left: 1px solid #e5e7eb; text-align: center; background-color: #fff; }
        .win-btn { background-color: #d1d5db; color: #fff; border: none; padding: 6px 8px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .team-slot:not(.empty) .win-btn { background-color: #3b82f6; }
        .team-slot:not(.empty):hover .win-btn { background-color: #2563eb; }
        .team-slot.winner { background-color: #dbeafe; border-color: #93c5fd; font-weight: 600; }
        .team-slot.loser { background-color: #f3f4f6; opacity: 0.6; }
        .team-slot.empty .team-name { color: #9ca3af; }
        .team-slot.empty .score-input, .team-slot.empty .win-btn, .team-slot.empty .details-btn { display: none; }
        .matchup::after { content: ''; position: absolute; top: 50%; width: 10px; height: 2px; background-color: #cbd5e1; }
        .bracket-half.left .matchup::after { right: -10px; }
        .bracket-half.right .matchup::after { left: -10px; }
        .round.subsequent-round .matchup::before { content: ''; position: absolute; top: -8px; height: calc(100% + 16px); width: 2px; background-color: #cbd5e1; }
        .bracket-half.left .round.subsequent-round .matchup::before { right: -10px; }
        .bracket-half.right .round.subsequent-round .matchup::before { left: -10px; }
        .hidden { display: none; }
        .news-article { border-left: 4px solid #3b82f6; cursor: pointer; transition: background-color 0.2s; }
        #modal-bg { background-color: rgba(0,0,0,0.5); }
        .confirm-modal, .details-modal, .save-load-modal, .newspaper-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .confirm-modal-content, .details-modal-content, .save-load-modal-content, .newspaper-modal-content { background-color: white; padding: 24px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .details-modal-content { width: 95%; max-width: 1000px; max-height: 90vh; overflow-y: auto;}
        .save-load-modal-content { width: 95%; max-width: 500px; }
        .newspaper-modal-content { width: 95%; max-width: 800px; max-height: 95vh; overflow-y: auto; }
        .confirm-modal-content { text-align: center; }
        .loader { text-align: center; padding: 20px; font-style: italic; color: #6b7280; }
        .details-btn { background-color: #6b7280; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: auto; margin-right: 2px; }
        .details-btn:hover { background-color: #4b5563; }
        .matchup-footer { text-align: center; margin-top: 2px; display: flex; justify-content: center; align-items: center; gap: 4px;}
        .stats-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .stats-table th, .stats-table td { border: 1px solid #e5e7eb; padding: 4px 6px; text-align: center; }
        .stats-table th { background-color: #f3f4f6; }
        .stats-table input { width: 100%; border: none; text-align: center; background: transparent;}
        .stats-table input:focus { outline: 1px solid #3b82f6; }
        .modal-body-scroll { max-height: 70vh; overflow-y: auto; }
        #save-code-output { word-break: break-all; background-color: #f3f4f6; padding: 8px; border-radius: 4px; max-height: 200px; overflow-y: auto; user-select: all; }
        .bbs-comment { background-color: #ffffff; border: 1px solid #e5e7eb; padding: 8px 12px; border-radius: 8px; font-size: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .match-summary-input { resize: none; height: 40px; }
        .article-error { background-color: #fee2e2; border-left: 4px solid #ef4444; color: #b91c1c; padding: 1rem; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .retry-btn { background-color: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; }
        .retry-btn:hover { background-color: #dc2626; }
        .namco-news-item { cursor: pointer; transition: background-color 0.2s; }
        .namco-news-tag { background-color: #f97316; color: white; font-size: 0.75rem; padding: 2px 8px; border-radius: 9999px; margin-left: 8px; }
      
.region-map-scroll-container {
    display: flex;
    overflow-x: auto;
    padding-bottom: 16px; /* Space for the scrollbar */
    gap: 16px;
}
.region-column { 
    flex: 0 0 250px; /* Prevent cards from shrinking */
    background-color: #ffffff; 
    border: 1px solid #e5e7eb; 
    border-radius: 8px; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
}
.region-header { 
    padding: 12px 16px; 
    background-color: #f9fafb; 
    border-bottom: 1px solid #e5e7eb; 
}
.region-title { 
    font-weight: 700; 
    font-size: 1.1rem; 
    color: #1f2937; 
}
.region-stats { 
    font-size: 0.8rem; 
    color: #4b5563; 
    font-weight: 500;
}
.region-team-list { 
    list-style: none; 
    padding: 12px 16px; 
    margin: 0;
    flex-grow: 1; /* Allow list to fill space */
}
.region-team { 
    padding: 6px 0; 
    font-size: 0.9rem;
    border-bottom: 1px solid #f3f4f6;
}
.region-team:last-child {
    border-bottom: none;
}
.team-surviving { 
    font-weight: 500; 
    color: #1f2937; 
}
.team-eliminated { 
    color: #9ca3af; 
    text-decoration: line-through; 
}
         .scorebook-font {
            font-family: 'Yuji Syuku', serif;
        }
        

        .rivalry-match .team-slot { border: 2px solid #ef4444 !important; background-color: #fff1f2; }
        .feud-match .team-slot { border: 2px solid #8b5cf6 !important; background-color: #f5f3ff; }
        .rivalry-match .team-slot.winner { background-color: #fecaca; }
        .feud-match .team-slot.winner { background-color: #ddd6fe; }
    
/* è©³ç´°å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
/* è©³ç´°å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæœ€çµ‚ç‰ˆï¼‰ */
/* â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ <style> ã‚¿ã‚°å†…ã«ã€Œæ–°è¦è¿½åŠ ã€ â–¼â–¼â–¼ */
/* ãƒãƒ¼ãƒ é€šç®—æˆç¸¾ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.career-stats-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    table-layout: auto;
}
.career-stats-table th, .career-stats-table td {
    border: 1px solid #e5e7eb;
    padding: 6px 4px;
    text-align: center;
    white-space: nowrap;
}
.career-stats-table thead tr {
    background-color: #f3f4f6; /* bg-gray-100 */
}
.career-stats-table .player-name {
    text-align: left;
    padding-left: 8px;
    font-weight: 600;
    min-width: 100px;
}
.career-stats-table .stat-highlight {
    font-weight: 700;
    background-color: #fef9c3; /* bg-yellow-100 */
}
.career-stats-table tbody tr:hover {
    background-color: #f9fafb; /* bg-gray-50 */
}

/* â–¼â–¼â–¼ ã‚¹ã‚«ã‚¦ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”¨CSS â–¼â–¼â–¼ */
.scout-card {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
    padding: 1rem;
    border-left: 5px solid #ccc;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.scout-card.rank-S { border-left-color: #fbbf24; background-color: #fffbeb; } /* Gold */
.scout-card.rank-A { border-left-color: #f87171; background-color: #fef2f2; } /* Red */
.scout-card.rank-B { border-left-color: #60a5fa; background-color: #eff6ff; } /* Blue */

.scout-rank-badge {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 900;
    color: white;
    margin-right: 1rem;
    flex-shrink: 0;
}
.rank-bg-S { background: linear-gradient(135deg, #fbbf24, #d97706); box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
.rank-bg-A { background-color: #ef4444; }
.rank-bg-B { background-color: #3b82f6; }
.rank-bg-C { background-color: #10b981; }

.scout-comment-box {
    background-color: #f3f4f6;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.85rem;
    color: #4b5563;
    font-style: italic;
    margin-top: 0.5rem;
    border-left: 2px solid #6b7280;
}

/* 1. ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down {
            animation: fadeInDown 1.0s ease-out forwards;
        }
        .animate-fade-in-up {
            opacity: 0; /* æœ€åˆã¯éè¡¨ç¤º */
            animation: fadeInUp 1.0s ease-out 0.5s forwards; /* 0.5ç§’é…ã‚Œã¦é–‹å§‹ */
        }
        /* .is-visible ã¯JSã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã«ä»˜ä¸ã•ã‚Œã¾ã™ */
        .animate-fade-in-up.is-visible {
            opacity: 1;
        }

        /* 2. ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€£å‹•ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ç”¨ */
        .fade-in-section {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .fade-in-section.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* 3. é¸æ‰‹ã‚«ãƒ¼ãƒ‰ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå¼·åŒ– */
        .player-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        /* â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ <style> ã‚¿ã‚°å†…ã«ã€Œæ–°è¦è¿½åŠ ã€ â–¼â–¼â–¼ */
/* ãƒãƒ¼ãƒ é€šç®—æˆç¸¾ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ä»˜ãï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.career-stats-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    table-layout: auto;
}
.career-stats-table th, .career-stats-table td {
    border: 1px solid #e5e7eb;
    padding: 6px 4px;
    text-align: center;
    white-space: nowrap;
}
.career-stats-table thead tr {
    background-color: #f3f4f6; /* bg-gray-100 */
}
/* â˜… ã‚½ãƒ¼ãƒˆå¯èƒ½ãªãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« â˜… */
.career-stats-table th.sortable-header {
    cursor: pointer;
    position: relative;
    padding-right: 20px; /* çŸ¢å°ç”¨ã®ã‚¹ãƒšãƒ¼ã‚¹ */
}
.career-stats-table th.sortable-header:hover {
    background-color: #e5e7eb; /* bg-gray-200 */
}
.career-stats-table .sort-arrow {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    color: #9ca3af; /* text-gray-400 */
}

/* 4. æ‰“çƒæ–¹å‘ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ */
.direction-hotspot {
    position: absolute;
    width: 15%;
    height: 15%;
    background-color: rgba(255, 255, 255, 0.8);
    border: 2px dashed #9ca3af; /* border-gray-400 */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: 700;
    color: #374151; /* text-gray-700 */
    cursor: pointer;
    transform: rotate(-45deg); /* ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®å›è»¢ã‚’æˆ»ã™ */
    transition: all 0.2s ease-out;
    opacity: 0; /* æ™®æ®µã¯éè¡¨ç¤º */
    pointer-events: none; /* æ™®æ®µã¯ã‚¯ãƒªãƒƒã‚¯ã•ã›ãªã„ */
}
.direction-hotspot:hover {
    background-color: #fef9c3; /* bg-yellow-100 */
    border-color: #f59e0b; /* border-yellow-500 */
    transform: rotate(-45deg) scale(1.1);
}
/* .direction-mode ã‚¯ãƒ©ã‚¹ãŒä»˜ä¸ã•ã‚ŒãŸã‚‰è¡¨ç¤º */
.baseball-diamond.direction-mode .direction-hotspot {
    opacity: 1;
    pointer-events: auto;
}

/* å„å®ˆå‚™ä½ç½®ã®é…ç½® (45åº¦å›è»¢ã—ãŸåŸºæº–ã§) */
#pos-p { top: 42.5%; left: 42.5%; } /* æŠ•æ‰‹ */
#pos-c { top: 75%; left: 42.5%; } /* æ•æ‰‹ */
#pos-1b { top: 42.5%; left: 75%; } /* ä¸€å¡ */
#pos-2b { top: 25%; left: 60%; } /* äºŒå¡ */
#pos-3b { top: 42.5%; left: 10%; } /* ä¸‰å¡ */
#pos-ss { top: 25%; left: 25%; } /* éŠæ’ƒ */
#pos-lf { top: 15%; left: 0%; } /* å·¦ç¿¼ */
#pos-cf { top: 0%; left: 42.5%; } /* ä¸­å … */
#pos-rf { top: 15%; left: 85%; } /* å³ç¿¼ */
/* â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* â˜… æ˜‡é †ãƒ»é™é †ã®çŸ¢å° â˜… */
.career-stats-table th.sort-asc .sort-arrow::after {
    content: ' â–²';
    color: #1e3a8a; /* text-blue-800 */
}
.career-stats-table th.sort-desc .sort-arrow::after {
    content: ' â–¼';
    color: #1e3a8a; /* text-blue-800 */
}
.career-stats-table .player-name {
    text-align: left;
    padding-left: 8px;
    font-weight: 600;
    min-width: 100px;
}
.career-stats-table .stat-highlight {
    font-weight: 700;
    background-color: #fef9c3; /* bg-yellow-100 */
}
.career-stats-table tbody tr:hover {
    background-color: #f9fafb; /* bg-gray-50 */
}
/* â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®èƒŒæ™¯ */
        .hero-bg {
            background: linear-gradient(rgba(17, 24, 39, 0.7), rgba(17, 24, 39, 0.7)), url('https://images.unsplash.com/photo-1519069632080-756b57d9b542?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNjAzNTV8MHwxfGFsbHx8fHx8fHx8fDE3MTUyNDU0Njd8&ixlib=rb-4.0.3&q=80&w=1080');
            background-size: cover;
            background-position: center 70%;
            background-attachment: fixed; /* èƒŒæ™¯ã‚’å›ºå®šã—ã€ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ï¼ˆè¦–å·®ï¼‰åŠ¹æœã‚’å‡ºã™ */
        }
        /* ã‚¹ãƒ­ãƒ¼ã‚¬ãƒ³ç”¨ã®ç‰¹å¤§ãƒ•ã‚©ãƒ³ãƒˆ */
        .slogan {
            font-size: clamp(4rem, 15vw, 10rem); /* ç”»é¢å¹…ã«å¿œã˜ã¦ã‚µã‚¤ã‚ºå¤‰æ›´ */
            font-weight: 900;
            line-height: 1;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã®ä¸‹ç·š */
        .section-title {
            position: relative;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -1px; /* ãƒœãƒ¼ãƒ€ãƒ¼ãƒ©ã‚¤ãƒ³ä¸Šã«é…ç½® */
            left: 0;
            width: 60px;
            height: 4px;
            background-color: #1e3a8a; /* æ¿ƒã„é’ (283å­¦åœ’ã®ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼) */
        }
        /* é¸æ‰‹ã‚«ãƒ¼ãƒ‰ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .player-card {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        /* ãƒšãƒ¼ã‚¸å†…ãƒªãƒ³ã‚¯ãŒé£›ã‚“ã éš›ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚ºãƒ¬ã‚’èª¿æ•´ */
        section[id] {
            scroll-margin-top: 80px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•åˆ†ï¼ˆç´„ï¼‰ */
        }
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .nav-link {
            position: relative;
            transition: color 0.2s;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1e3a8a;
            transition: width 0.3s ease-out;
        }
        .nav-link:hover::after,
        .nav-link:focus::after {
            width: 100%;
        }
        /* ã‚®ãƒ£ãƒ©ãƒªãƒ¼ç”»åƒã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .gallery-image {
            transition: transform 0.3s ease-in-out, filter 0.3s ease-in-out;
        }
        .gallery-image:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

/* â–¼â–¼â–¼ ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç”¨CSS â–¼â–¼â–¼ */
.suggestion-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f3f4f6;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.1s;
}
.suggestion-item:hover {
    background-color: #eff6ff; /* ãƒ›ãƒãƒ¼æ™‚ã«è–„ã„é’è‰²ã« */
}
.suggestion-item:last-child {
    border-bottom: none;
}
.suggestion-match {
    color: #2563eb;
    font-weight: bold;
}
.suggestion-meta {
    font-size: 0.75rem;
    color: #6b7280;
}

/* â–¼â–¼â–¼ ã‚»ã‚¤ãƒãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨CSS â–¼â–¼â–¼ */
.saber-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-top: 15px;
    background-color: #f8fafc;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}
.saber-card {
    background-color: white;
    padding: 10px;
    border-radius: 6px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    text-align: center;
}
.saber-title {
    font-size: 0.7rem;
    color: #64748b;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
.saber-value {
    font-size: 1.4rem;
    font-weight: 800;
    color: #1e293b;
    line-height: 1.2;
}
.saber-desc {
    font-size: 0.65rem;
    color: #94a3b8;
    margin-top: 2px;
}
/* è©•ä¾¡è‰² */
.val-excellent { color: #ef4444; } /* èµ¤ (æœ€é«˜) */
.val-good { color: #f59e0b; }      /* ã‚ªãƒ¬ãƒ³ã‚¸ (è‰¯ã„) */
.val-average { color: #3b82f6; }   /* é’ (æ™®é€š) */
.val-poor { color: #64748b; }      /* ã‚°ãƒ¬ãƒ¼ (æ‚ªã„) */
/* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* â–¼â–¼â–¼ 283å­¦åœ’ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ç”¨CSS (ã‚¹ãƒãƒ›å¯¾å¿œç‰ˆ) â–¼â–¼â–¼ */
/* ãƒ™ãƒ¼ã‚¹èƒŒæ™¯ */
#homepage-scroll-container {
    background-color: #f9fafb;
    -webkit-overflow-scrolling: touch; /* iOSã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ»‘ã‚‰ã‹ã« */
}

/* ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒˆãƒƒãƒ—ç”»åƒï¼‰ */
.hero-section {
    position: relative;
    width: 100%;
    height: 200px; /* ã‚¹ãƒãƒ›: é«˜ã•ã‚’æŠ‘ãˆã‚‹ */
    background-image: linear-gradient(rgba(17, 24, 39, 0.6), rgba(17, 24, 39, 0.4)), url('https://images.unsplash.com/photo-1519069632080-756b57d9b542?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=1080');
    background-size: cover;
    background-position: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    margin-bottom: 1.5rem;
}

/* PCã‚µã‚¤ã‚ºä»¥ä¸Šã§ã®èª¿æ•´ */
@media (min-width: 768px) {
    .hero-section {
        height: 350px; /* PC: é«˜ã•ã‚’æˆ»ã™ */
        margin-bottom: 2rem;
    }
}

/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ */
.homepage-nav {
    background-color: rgba(255, 255, 255, 0.98);
    border-bottom: 1px solid #e5e7eb;
    position: sticky;
    top: 0;
    z-index: 50;
}

/* ãƒ•ãƒƒã‚¿ãƒ¼ */
.homepage-footer {
    background-color: #f3f4f6;
    color: #6b7280;
    padding: 2rem 1rem; /* å·¦å³ã«ä½™ç™½ã‚’æŒãŸã›ã‚‹ */
    margin-top: 2rem;
    border-top: 1px solid #e5e7eb;
    font-size: 0.75rem; /* æ–‡å­—ã‚’å°‘ã—å°ã•ã */
}

/* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒå¿…è¦ãªãƒ†ãƒ¼ãƒ–ãƒ«ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼ */
.table-scroll-wrapper {
    width: 100%;
    overflow-x: auto; /* ã¯ã¿å‡ºãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    -webkit-overflow-scrolling: touch;
    margin-bottom: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
}

/* éƒ¨å“¡ã‚«ãƒ¼ãƒ‰ã®èª¿æ•´ */
.player-profile-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
    /* ã‚¹ãƒãƒ›ã§æ½°ã‚Œãªã„ã‚ˆã†ã« */
    min-width: 0; 
    word-break: break-word;
}
/* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* â–¼â–¼â–¼ ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ãƒœã‚¿ãƒ³ç”¨CSS (æ–°è¦è¿½åŠ ) â–¼â–¼â–¼ */
.captain-btn {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 1px solid #cbd5e1; /* gray-300 */
    color: #9ca3af; /* gray-400 */
    font-size: 12px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8fafc;
    transition: all 0.2s;
    margin-left: 4px;
    margin-right: 4px;
}
.captain-btn:hover {
    background-color: #e2e8f0;
}
.captain-btn.active {
    background-color: #f59e0b; /* amber-500 (ã‚´ãƒ¼ãƒ«ãƒ‰ã£ã½ã„è‰²) */
    color: white;
    border-color: #d97706; /* amber-600 */
    box-shadow: 0 0 5px rgba(245, 158, 11, 0.5);
}
/* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* â–¼â–¼â–¼ ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚­ãƒƒãƒ—æ–°èãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®CSS (ã“ã“ã‹ã‚‰ä¿®æ­£) â–¼â–¼â–¼ */
.newspaper-modal-backdrop {
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200;
    padding: 1rem;
    overflow-y: auto; /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒç”»é¢ã‚ˆã‚Šå¤§ãã„å ´åˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
}

.skip-newspaper-container {
    background-color: #fdfaf4; /* å°‘ã—é»„ã°ã‚“ã ç´™ã®è‰² */
    background-image:
        linear-gradient(to right,
            rgba(0, 0, 0, 0) 49.8%,
            rgba(0, 0, 0, 0.08) 50%, /* æŠ˜ã‚Šç›®ã®å½±ã‚’å°‘ã—æ§ãˆã‚ã« */
            rgba(0, 0, 0, 0) 50.2%
        ),
        radial-gradient(ellipse at center, #fdfaf4 70%, #f0e8d8 100%);
    border: 1px solid #333;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    width: 100%;
    max-width: 1000px; /* å°‘ã—æ¨ªå¹…ã‚’åºƒã’ã€ã‚ˆã‚Šå¤šãã®æƒ…å ±ã‚’è¡¨ç¤º */
    min-height: 80vh; /* æœ€ä½é™ã®é«˜ã•ã‚’ç¢ºä¿ */
    max-height: 98vh; /* ç”»é¢ã®é«˜ã•ã«åˆã‚ã›ã‚‹ */
    font-family: 'Noto Serif JP', 'Yuji Syuku', serif;
    color: #222; /* æ–‡å­—è‰²ã‚’å°‘ã—æ¿ƒã */
    display: flex;
    flex-direction: column;
    overflow: hidden; /* å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯bodyã§è¡Œã† */
    position: relative; /* å­è¦ç´ ã®é…ç½®ã®ãŸã‚ */
}

.skip-newspaper-header {
    text-align: center;
    padding: 0.5rem 1rem;
    border-bottom: 2px solid #222; /* ç·šã‚’å°‘ã—æ¿ƒã */
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    font-size: 0.8rem;
    color: #555;
}

.skip-newspaper-logo {
    font-family: 'Yuji Syuku', serif;
    font-size: 1.5rem; /* ãƒ­ã‚´ã‚’è¿½åŠ  */
    font-weight: 700;
    color: #a00; /* èµ¤è‰²ã§å¼·èª¿ */
    white-space: nowrap;
}

.skip-newspaper-title {
    font-size: 2.2rem; /* ãƒˆãƒƒãƒ—è¦‹å‡ºã—ã‚’å°‘ã—å°ã•ã */
    font-weight: 700;
    letter-spacing: 0.1em;
    font-family: 'Yuji Syuku', serif;
    flex-grow: 1;
    text-align: center;
    line-height: 1; /* è¡Œé–“ã‚’è©°ã‚ã‚‹ */
}

.skip-newspaper-date {
    font-size: 0.75rem;
    color: #555;
    white-space: nowrap;
    text-align: right;
}

.skip-newspaper-body {
    padding: 0.75rem 1rem; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
    flex-grow: 1;
    overflow-y: auto; /* ã“ã“ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹ */
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    gap: 1rem; /* ã‚«ãƒ©ãƒ é–“ã®ã‚®ãƒ£ãƒƒãƒ— */
    align-items: start; /* ä¸Šæƒãˆ */
}

/* ãƒ¡ã‚¤ãƒ³è¨˜äº‹ã‚¨ãƒªã‚¢ */
.skip-newspaper-main-article {
    grid-column: 2 / span 2; /* ä¸­å¤®2ã‚«ãƒ©ãƒ ã‚’å æœ‰ */
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.skip-newspaper-main-headline {
    writing-mode: vertical-rl; /* ç¸¦æ›¸ã */
    text-orientation: upright;
    font-family: 'Yuji Syuku', serif;
    font-size: 3rem; /* å¤§è¦‹å‡ºã—ã‚’å¤§ãã */
    font-weight: 900;
    letter-spacing: 0.15em; /* å­—é–“ã‚’è©°ã‚ã‚‹ */
    line-height: 1.1; /* è¡Œé–“ */
    color: #000;
    text-align: center;
    display: block; /* ç¸¦æ›¸ãã§ä¸­å¤®æƒãˆã«ã™ã‚‹ãŸã‚ã«å¿…è¦ */
    padding-right: 0.5rem;
    border-right: 3px solid #000; /* å¼·ã„å¢ƒç•Œç·š */
    margin-left: -0.5rem; /* å°‘ã—å·¦ã«å¯„ã›ã¦ã€ä¸­å¤®ã‚«ãƒ©ãƒ ã¨ã®éš™é–“ã‚’èª¿æ•´ */
    height: 100%; /* è¦ªè¦ç´ ã®é«˜ã•ã«åˆã‚ã›ã‚‹ */
    grid-column: 1; /* 1ã‚«ãƒ©ãƒ ç›®ã‚’å æœ‰ */
    align-self: stretch; /* ç¸¦æ–¹å‘ã«å…¨ä½“ã«åºƒãŒã‚‹ */
}

.skip-newspaper-main-image {
    background-color: #ddd; /* ç”»åƒã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */
    height: 200px; /* ç”»åƒã®é«˜ã• */
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: #666;
    border: 1px solid #aaa;
    margin-bottom: 0.5rem;
}
.skip-newspaper-image-caption {
    font-size: 0.8rem;
    color: #555;
    text-align: center;
    margin-top: -0.25rem;
    margin-bottom: 0.5rem;
}

.skip-newspaper-main-body {
    column-count: 2; /* ãƒ¡ã‚¤ãƒ³è¨˜äº‹ã‚’2æ®µçµ„ã« */
    column-gap: 1rem;
    column-rule: 1px dotted #ccc; /* ç‚¹ç·šã§åŒºåˆ‡ã‚Š */
    font-size: 0.9rem;
    line-height: 1.7;
    text-align: justify;
    padding-left: 0.5rem; /* å·¦å´ã«å°‘ã—ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
}
.skip-newspaper-main-body h4 {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    column-span: all; /* å°è¦‹å‡ºã—ã¯æ®µçµ„ã‚’ã¾ãŸã */
    break-before: column;
}
.skip-newspaper-main-body p {
    margin-bottom: 0.75rem;
    text-indent: 1em; /* æ®µè½ã®é ­ã«ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ */
}

/* ã‚µã‚¤ãƒ‰è¨˜äº‹ */
.skip-newspaper-side-article {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}
.skip-newspaper-side-article.left {
    grid-column: 1; /* å·¦ç«¯ã®ã‚«ãƒ©ãƒ  */
    border-right: 1px dotted #ccc;
    padding-right: 0.5rem;
}
.skip-newspaper-side-article.right {
    grid-column: 4; /* å³ç«¯ã®ã‚«ãƒ©ãƒ  */
    border-left: 1px dotted #ccc;
    padding-left: 0.5rem;
}

.skip-newspaper-side-headline {
    font-family: 'Yuji Syuku', serif;
    font-size: 1.3rem;
    font-weight: 700;
    line-height: 1.3;
    letter-spacing: 0.05em;
    border-bottom: 1px solid #aaa;
    padding-bottom: 0.25rem;
    margin-bottom: 0.5rem;
}
.skip-newspaper-side-body {
    font-size: 0.8rem;
    line-height: 1.6;
    text-align: justify;
    column-count: 1; /* åŸºæœ¬1æ®µçµ„ */
}
.skip-newspaper-side-body p {
    margin-bottom: 0.5rem;
    text-indent: 0.5em;
}

/* è©¦åˆçµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.skip-newspaper-results-section {
    grid-column: span 4; /* å…¨å¹…ã‚’å æœ‰ */
    border-top: 2px solid #222;
    padding-top: 0.75rem;
    margin-top: 1rem;
    text-align: center;
}
.skip-newspaper-results-section h2 {
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    font-family: 'Yuji Syuku', serif;
    color: #000;
    border-bottom: 1px solid #ccc;
    padding-bottom: 0.25rem;
    display: inline-block; /* ä¸­å¤®å¯„ã› */
}

.skip-newspaper-match-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* è©¦åˆçµæœã‚’ç´°ã‹ãä¸¦ã¹ã‚‹ */
    gap: 0.5rem; /* ã‚®ãƒ£ãƒƒãƒ—ã‚’å°ã•ã */
    margin-top: 0.75rem;
}
.skip-newspaper-match {
    font-size: 0.85rem; /* æ–‡å­—ã‚’å°ã•ã */
    padding: 0.3rem 0.5rem;
    border: 1px solid #ccc;
    background: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    white-space: nowrap; /* ãƒ†ã‚­ã‚¹ãƒˆã®æŠ˜ã‚Šè¿”ã—ã‚’é˜²ã */
}
.skip-newspaper-match .winner {
    font-weight: 700;
    color: #000;
}
.skip-newspaper-match .loser {
    color: #666;
}
.skip-newspaper-match .score {
    font-weight: 700;
    margin-left: 0.5rem;
}

.skip-newspaper-footer {
    padding: 0.4rem 1rem;
    text-align: center;
    border-top: 1px solid #ccc;
    background-color: #f9f9f9;
    font-size: 0.8rem;
}
/* â–²â–²â–² ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚­ãƒƒãƒ—æ–°èãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®CSS (ã“ã“ã¾ã§ä¿®æ­£) â–²â–²â–² */

        /* â–¼â–¼â–¼ ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ç”¨ã®CSS â–¼â–¼â–¼ */
        .bracket-wrapper {
            max-width: 100%;
            overflow-x: auto; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¯èƒ½ã«ã™ã‚‹ */
            padding: 2rem 1rem;
            background-color: #ffffff; /* bg-white */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            margin-top: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .tournament-container {
            display: flex;
            align-items: stretch; /* å„ãƒ©ã‚¦ãƒ³ãƒ‰ã®é«˜ã•ã‚’æƒãˆã‚‹ */
            min-width: 3200px; /* å…¨ä½“ã®æœ€å°å¹…ã‚’æŒ‡å®š */

.baseball-diamond.runner-select-mode .base.runner {
    cursor: pointer;
    background-color: #f59e0b; /* bg-yellow-500 */
    border-color: #d97706; /* border-yellow-600 */
    animation: runnerPulse 1s infinite;
}
@keyframes runnerPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

        }
        .bracket-final {
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; padding: 0 1.5rem; flex-shrink: 0;
        }
        .final-matchup { width: 280px; }
        .final-matchup .match {
            border-width: 2px; border-color: #f59e0b;
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.2);
        }
        .final-matchup .team { font-size: 1.125rem; padding: 0.75rem 1rem; }
        .final-matchup .score { font-size: 1.25rem; }
        .winner-box {
            text-align: center; margin-top: 1.5rem; padding: 0.75rem 1.5rem;
            background-color: #fffbeb; border: 2px solid #fcd34d; border-radius: 0.375rem;
        }
        .winner-box h2 { font-size: 1.5rem; font-weight: 700; color: #d97706; }
        .bracket-half { display: flex; align-items: stretch; }
        .bracket-half.right { flex-direction: row-reverse; }
        .round {
            /* width: 230px; ã‚„ width: 280px; ãªã©ã®å®šç¾©ã¯
               index.html å´ã®æ—¢å­˜ã® .round å®šç¾©ã¨ç«¶åˆã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯é™¤å¤–ã—ã¾ã™ */
        }
        .round-title {
            text-align: center; font-weight: 700; font-size: 1rem;
            color: #4b5563; margin-bottom: 1rem; white-space: nowrap;
        }
        .matchup {
            /* .matchup ã®å®šç¾©ã‚‚ index.html å´ã¨ç«¶åˆã™ã‚‹ãŸã‚ã€å¿…è¦ãªã‚‚ã®ä»¥å¤–ã¯é™¤å¤– */
        }
        .match {
            border: 1px solid #d1d5db; background: #fff;
            border-radius: 0.375rem; overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .team {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.5rem 0.75rem; font-size: 0.875rem; line-height: 1.25; min-height: 38px;
        }
        .team.winner { font-weight: 700; color: #111827; }
        .team.loser { color: #6b7280; opacity: 0.7; }
        .team.loser .name { text-decoration: line-through; }
        .team .score {
            width: 30px; text-align: right; border-left: 1px solid #e5e7eb;
            padding-left: 0.5rem; font-size: 0.95rem; font-weight: 500;
        }
        .team.winner .score { color: #dc2626; font-weight: 700; }
        .team:first-child { border-bottom: 1px solid #d1d5db; }
        .r1 .matchup { margin: 0.25rem 0; }
        .r1 .team { padding: 3px 6px; font-size: 11px; min-height: 28px; }
        .r1 .team .score { width: 20px; font-size: 11px; }
        .connector-line {
            position: absolute; top: 50%; width: 1.5rem; height: 2px;
            background-color: #9ca3af; z-index: 1;
        }
        .bracket-half.left .connector-line { right: -1.5rem; }
        .bracket-half.right .connector-line { left: -1.5rem; }
        .connector-path {
            position: absolute; top: 50%; height: 100%; width: 2px;
            background-color: #9ca3af; z-index: 0;
        }
        .r2 .matchup { margin: 0.5rem 0; }
        .r2 .connector-path { top: -25%; height: 150%; }
        .r3 .matchup { margin: 1.25rem 0; }
        .r3 .connector-path { top: -75%; height: 250%; }
        .r4 .matchup { margin: 3.25rem 0; }
        .r4 .connector-path { top: -175%; height: 450%; }
        .r5 .matchup { margin: 8rem 0; }
        .r5 .connector-path { top: -400%; height: 900%; }
        .bracket-half.left .connector-path { right: -1.5rem; }
        .bracket-half.right .connector-path { left: -1.5rem; }
        /* â–²â–²â–² ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨CSSã“ã“ã¾ã§ â–²â–²â–² */
        
/* 8. H2H (Head-to-Head) æˆ¦åŠ›æ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆ */
        .h2h-chart-container {
            border-top: 2px solid #e5e7eb; /* border-gray-200 */
            margin-top: 1.5rem; /* mt-6 */
            padding-top: 1.5rem; /* pt-6 */
        }
        .h2h-chart-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700;
            color: #1f2937; /* text-gray-800 */
            margin-bottom: 1rem; /* mb-4 */
        }
        .h2h-stat-row {
            margin-bottom: 1rem; /* mb-4 */
        }
        .h2h-stat-label {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
            color: #4b5563; /* text-gray-600 */
            margin-bottom: 0.25rem; /* mb-1 */
        }
        .h2h-stat-label-team1 { color: #1d4ed8; } /* text-blue-700 */
        .h2h-stat-label-team2 { color: #be123c; } /* text-red-700 */
        
        .h2h-bar-wrapper {
            display: flex;
            gap: 2px; /* éš™é–“ */
            height: 24px; /* ãƒãƒ¼ã®é«˜ã• */
            background-color: #e5e7eb; /* bg-gray-200 */
            border-radius: 0.25rem; /* rounded */
            overflow: hidden;
        }
        .h2h-bar {
            transition: width 0.5s ease-out;
        }
        .h2h-bar-team1 { background-color: #3b82f6; } /* bg-blue-500 */
        .h2h-bar-team2 { background-color: #e11d48; } /* bg-red-600 */
        /* â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* 7. é¸æ‰‹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ (èª¿å­) ã‚¢ã‚¤ã‚³ãƒ³ */
        .condition-icon {
            font-size: 0.9em;
            margin-left: 4px;
            display: inline-block;
            vertical-align: baseline;
        }
        .details-table .condition-icon {
            font-size: 1.1em;
            vertical-align: middle;
        }

        /* â–¼â–¼â–¼ ä¸€çƒé€Ÿå ±ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®CSS â–¼â–¼â–¼ */
        .modal-hidden { display: none; }
        #boxscore-modal-body {
            background-color: #f9fafb; /* bg-gray-50 */
            padding: 1rem;
            border-radius: 0.25rem;
            font-size: 12px; /* ãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º */
        }
        /* ä¸€çƒé€Ÿå ±.comé¢¨ ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ */
        .boxscore-table {
            width: 100%; border-collapse: collapse;
            font-size: 14px; margin-bottom: 1rem;
        }
        .boxscore-table th, .boxscore-table td {
            border: 1px solid #d1d5db; padding: 6px 8px; text-align: center;
        }
        .boxscore-table .team-name {
            text-align: left; font-weight: 700; width: 20%;
        }
        .boxscore-table .inning-header th {
            background-color: #374151; color: white;
            font-weight: 500; padding: 4px 6px;
        }
        .boxscore-table .total-header { background-color: #374151; color: white; }
        .boxscore-table .score-cell {
            font-size: 1.1rem; font-weight: 700; width: 35px;
        }
        .boxscore-table .total-score {
            font-size: 1.25rem; font-weight: 700; background-color: #fef9c3;
        }
        /* ä¸€çƒé€Ÿå ±.comé¢¨ æ‰“æ’ƒæˆç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« */
        .batting-stats-table {
            width: 100%; border-collapse: collapse; font-size: 12px;
            table-layout: fixed; /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å›ºå®š */
        }
        .batting-stats-table th, .batting-stats-table td {
            border: 1px solid #e5e7eb; padding: 5px 4px;
            text-align: center; white-space: nowrap; /* æŠ˜ã‚Šè¿”ã—ç¦æ­¢ */
        }
        .batting-stats-table thead tr { background-color: #f3f4f6; }
        .batting-stats-table .pos { width: 8%; }
        .batting-stats-table .player { width: 20%; text-align: left; padding-left: 8px; }
        .batting-stats-table .at-bat { width: 5%; }
        .batting-stats-table .runs { width: 5%; }
        .batting-stats-table .hits { width: 5%; }
        .batting-stats-table .rbi { width: 5%; }
        .batting-stats-table .so { width: 5%; }
        .batting-stats-table .walks { width: 5%; }
        .batting-stats-table .results { width: 42%; text-align: left; padding-left: 8px; white-space: normal; } /* çµæœã¯æŠ˜ã‚Šè¿”ã—è¨±å¯ */
        .batting-stats-table tbody tr:hover { background-color: #fef9c3; }
        .batting-stats-table .sub-player td { background-color: #f9fafb; color: #4b5563; }
        .batting-stats-table .sub-player .player { padding-left: 20px; }
        .batting-stats-table .team-totals { font-weight: 700; background-color: #f3f4f6; }
        /* æŠ•æ‰‹æˆç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« */
        .pitching-stats-table {
            width: 100%; border-collapse: collapse; font-size: 12px;
            margin-top: 1rem; table-layout: fixed;
        }
        .pitching-stats-table th, .pitching-stats-table td {
            border: 1px solid #e5e7eb; padding: 5px 4px;
            text-align: center; white-space: nowrap;
        }
        .pitching-stats-table thead tr { background-color: #f3f4f6; }
        .pitching-stats-table .player { width: 25%; text-align: left; padding-left: 8px; }
        .pitching-stats-table .result { width: 6%; }
        .pitching-stats-table .ip { width: 8%; }
        .pitching-stats-table .bf { width: 8%; }
        .pitching-stats-table .hits { width: 8%; }
        .pitching-stats-table .so { width: 8%; }
        .pitching-stats-table .walks { width: 8%; }
        .pitching-stats-table .runs { width: 8%; }
        .pitching-stats-table .er { width: 8%; }
        .pitching-stats-table .era { width: 13%; }
        /* â–²â–²â–² ä¸€çƒé€Ÿå ±CSSã“ã“ã¾ã§ â–²â–²â–² */

/* â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */
.skip-newspaper-container {
    /* æ—¢å­˜ã®ç´™ã®è‰²(#fdfaf4)ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¨æŠ˜ã‚Šç›®ã‚’è¿½åŠ  */
    background-color: #fdfaf4;
    background-image: 
        /* 1. ä¸­å¤®ã®æŠ˜ã‚Šç›® */
        linear-gradient(to right, 
            rgba(0, 0, 0, 0) 49.8%,  /* ä¸­å¤®ã®å°‘ã—æ‰‹å‰ã¾ã§é€æ˜ */
            rgba(0, 0, 0, 0.1) 50%,   /* ä¸­å¤®ã«æš—ã„å½± */
            rgba(0, 0, 0, 0) 50.2%   /* ä¸­å¤®ã®å°‘ã—å¾Œã‹ã‚‰é€æ˜ */
        ),
        /* 2. ç´™ã®é»„ã°ã¿ãƒ»è³ªæ„Ÿ (ä¸­å¿ƒãŒæ˜ã‚‹ãã€ç«¯ãŒå°‘ã—æš—ã„) */
        radial-gradient(ellipse at center, #fdfaf4 70%, #f0e8d8 100%);

    border: 1px solid #333;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    width: 100%;
    max-width: 900px;
    max-height: 95vh;
    font-family: 'Noto Serif JP', 'Yuji Syuku', serif;
    color: #333;
    display: flex;
    flex-direction: column;
}
/* â–²â–²â–² ç½®ãæ›ãˆã¯ã“ã“ã¾ã§ â–²â–²â–² */
/* â–¼â–¼â–¼ æ¤œç´¢çµæœãƒªã‚¹ãƒˆç”¨CSS â–¼â–¼â–¼ */
.search-result-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.search-result-item {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.search-result-item:hover {
    background-color: #f3f4f6;
}
.search-result-name {
    font-weight: bold;
    font-size: 1.1rem;
    color: #1f2937;
}
.search-result-info {
    font-size: 0.85rem;
    color: #6b7280;
}
.search-result-tag {
    background-color: #dbeafe;
    color: #1e40af;
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 9999px;
    margin-left: 8px;
}
/* â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* â–¼â–¼â–¼ ãƒãƒ¼ãƒ è¿½è·¡æ©Ÿèƒ½ç”¨CSS (æ–°è¦è¿½åŠ ) â–¼â–¼â–¼ */
#team-tracker-container {
    position: fixed;
    bottom: 50px; /* ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã®ä¸Š */
    left: 20px;
    z-index: 200;
    width: 260px;
    transition: all 0.3s ease;
}

.tracker-bar {
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid #3b82f6;
    border-radius: 30px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    padding: 5px 15px;
    backdrop-filter: blur(5px);
}

.tracker-input {
    border: none;
    background: transparent;
    outline: none;
    width: 100%;
    font-size: 14px;
    font-weight: bold;
    color: #1f2937;
}

.tracker-icon {
    font-size: 16px;
    margin-right: 8px;
    color: #3b82f6;
}

/* å€™è£œãƒªã‚¹ãƒˆ */
#tracker-suggestions {
    position: absolute;
    bottom: 110%; /* ãƒãƒ¼ã®ä¸Šã«å‡ºã™ */
    left: 0;
    width: 100%;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    max-height: 200px;
    overflow-y: auto;
    display: none;
}
#tracker-suggestions.visible {
    display: block;
}
.tracker-suggestion-item {
    padding: 8px 12px;
    font-size: 13px;
    cursor: pointer;
    border-bottom: 1px solid #f3f4f6;
    transition: background 0.1s;
}
.tracker-suggestion-item:hover {
    background-color: #eff6ff;
}

/* ãƒãƒ¼ãƒ ç™ºè¦‹æ™‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes targetPulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); background-color: #fee2e2; }
    50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); background-color: #fecaca; }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); background-color: white; }
}

.team-slot.tracker-highlight {
    animation: targetPulse 1.5s ease-in-out infinite;
    z-index: 10;
    border: 2px solid #ef4444 !important;
}
/* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* â–¼â–¼â–¼ å­¦æ ¡ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨CSS â–¼â–¼â–¼ */
.archive-header {
    border-left: 5px solid #e60012; /* æœæ—¥æ–°èé¢¨ã®èµ¤ */
    padding-left: 15px;
    margin-bottom: 20px;
}
.archive-school-name {
    font-size: 24px;
    font-weight: bold;
    color: #333;
}
.archive-pref {
    font-size: 16px;
    font-weight: normal;
    color: #666;
    margin-left: 10px;
}
.archive-section-title {
    border-bottom: 2px solid #333;
    font-size: 18px;
    font-weight: bold;
    padding-bottom: 5px;
    margin-top: 30px;
    margin-bottom: 15px;
}
.archive-sub-title {
    background-color: #f0f0f0;
    border-left: 4px solid #666;
    padding: 8px 15px;
    font-size: 16px;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
}

/* æˆç¸¾æ¦‚è¦ */
.result-summary-box {
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}
.result-summary-row {
    display: flex;
    border-bottom: 1px dashed #ccc;
    padding: 8px 0;
}
.result-summary-row:last-child { border-bottom: none; }
.result-summary-dt { font-weight: bold; width: 100px; color: #e60012; }
.result-summary-dd { flex: 1; }

/* æˆ¦ç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« */
.record-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin-bottom: 20px;
}
.record-table th {
    background-color: #e0e0e0;
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
    white-space: nowrap;
}
.record-table td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
}
.record-table tr:nth-child(even) {
    background-color: #f9f9f9;
}
.record-table .result-win { color: #e60012; font-weight: bold; }
.record-table .result-lose { color: #3366cc; font-weight: bold; }
.record-table .score-cell { font-weight: bold; font-size: 1.1em; }
.record-table .opponent-cell { text-align: left; padding-left: 15px; }

/* ç›´è¿‘æˆç¸¾ãƒªã‚¹ãƒˆ */
.history-list {
    list-style: none;
    padding: 0;
}
.history-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    border-bottom: 1px solid #eee;
}
.history-year { font-weight: bold; color: #555; width: 120px; }
.history-rank { font-weight: bold; }

/* â–¼â–¼â–¼ SNSãƒˆãƒ¬ãƒ³ãƒ‰æ©Ÿèƒ½ (Xé¢¨ãƒ‡ã‚¶ã‚¤ãƒ³) â–¼â–¼â–¼ */
.sns-modal-content {
    background-color: #ffffff;
    max-width: 600px;
    width: 100%;
    border-radius: 16px;
    overflow: hidden;
}
.sns-header {
    background-color: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(12px);
    padding: 12px 16px;
    border-bottom: 1px solid #eff3f4;
    position: sticky;
    top: 0;
    z-index: 10;
}
.sns-trend-item {
    padding: 12px 16px;
    border-bottom: 1px solid #eff3f4;
    transition: background-color 0.2s;
    cursor: pointer;
}
.sns-trend-item:hover { background-color: #f7f9f9; }
.sns-trend-meta { font-size: 13px; color: #536471; }
.sns-trend-word { font-size: 15px; font-weight: 700; color: #0f1419; margin-top: 2px; }
.sns-trend-count { font-size: 13px; color: #536471; margin-top: 4px; }

.sns-post {
    padding: 12px 16px;
    border-bottom: 1px solid #eff3f4;
    display: flex;
    gap: 12px;
    animation: fadeIn 0.5s ease-out;
}
.sns-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #cfd9de;
    flex-shrink: 0;
}
.sns-content { flex-grow: 1; }
.sns-user-info { display: flex; align-items: baseline; gap: 4px; }
.sns-name { font-weight: 700; color: #0f1419; font-size: 15px; }
.sns-handle { color: #536471; font-size: 14px; }
.sns-time { color: #536471; font-size: 14px; }
.sns-text { margin-top: 4px; font-size: 15px; line-height: 1.4; color: #0f1419; white-space: pre-wrap; }
.sns-actions {
    display: flex; justify-content: space-between; margin-top: 12px; max-width: 425px; color: #536471; font-size: 13px;
}
.sns-action-btn { display: flex; align-items: center; gap: 6px; cursor: pointer; transition: color 0.2s; }
.sns-action-btn:hover.like { color: #f91880; }
.sns-action-btn:hover.retweet { color: #00ba7c; }

/* ãƒˆãƒ¬ãƒ³ãƒ‰é€šçŸ¥ãƒãƒŠãƒ¼ */
#trend-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #1d9bf0; /* X Blue */
    color: white;
    padding: 12px 20px;
    border-radius: 30px;
    box-shadow: 0 4px 15px rgba(29, 155, 240, 0.4);
    z-index: 300;
    transform: translateX(120%);
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
}
#trend-notification.show { transform: translateX(0); }
/* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* ä½œæˆ¦ãƒœãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« (ã‚¹ãƒãƒ›å¯¾å¿œç‰ˆ) */
.lineup-card {
    display: flex;
    align-items: center;
    background-color: #1e293b; /* slate-800 */
    border: 1px solid #334155; /* slate-700 */
    border-radius: 8px;
    padding: 12px 10px; /* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã„ã‚ˆã†ã«åºƒã’ã‚‹ */
    color: white;
    cursor: pointer;
    transition: all 0.15s ease;
    user-select: none;
    margin-bottom: 4px; /* ã‚«ãƒ¼ãƒ‰é–“ã®éš™é–“ */
    /* ã‚¹ãƒãƒ›ç”¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
    touch-action: manipulation; 
}

.lineup-card:active {
    transform: scale(0.98);
    background-color: #334155;
}

.lineup-card.selected {
    background-color: #2563eb; /* blue-600 */
    border: 2px solid #fbbf24; /* amber-400 (é»„è‰²ã„æ ç·šã§å¼·èª¿) */
    box-shadow: 0 0 15px rgba(37, 99, 235, 0.8);
    transform: scale(1.02);
    z-index: 10;
    position: relative; /* é‡ãªã‚Šé †ã‚’åˆ¶å¾¡ */
}

/* é¸æŠã•ã‚ŒãŸçŠ¶æ…‹ã®ã¨ãã€ç•ªå·ã‚’å…‰ã‚‰ã›ã‚‹ */
.lineup-card.selected .lineup-order-num {
    color: #fbbf24;
    text-shadow: 0 0 5px #fbbf24;
}

.lineup-order-num {
    font-family: 'Impact', sans-serif;
    font-size: 1.4rem;
    color: #94a3b8; /* slate-400 */
    width: 35px;
    text-align: center;
    margin-right: 8px;
}

.lineup-pos-badge {
    font-size: 0.8rem;
    font-weight: bold;
    padding: 3px 8px;
    border-radius: 4px;
    background-color: #475569;
    color: #e2e8f0;
    margin-right: 10px;
    min-width: 40px;
    text-align: center;
    box-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.lineup-name {
    font-weight: bold;
    flex-grow: 1;
    font-size: 1rem; /* åå‰ã‚’å°‘ã—å¤§ãã */
}

.lineup-stat {
    font-size: 0.7rem;
    color: #94a3b8;
    margin-left: 8px;
    min-width: 40px;
    text-align: right;
}
/* ãƒã‚¸ã‚·ãƒ§ãƒ³åˆ¥ã®è‰² */
.pos-P { background-color: #be185d; } /* Pink */
.pos-C { background-color: #1d4ed8; } /* Blue */
.pos-IF { background-color: #0f766e; } /* Teal */
.pos-OF { background-color: #ea580c; } /* Orange */

/* â–¼â–¼â–¼ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³èª¬æ˜ç”¨ã®CSS â–¼â–¼â–¼ */
.match-schedule {
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 11px;
            font-weight: 600;
            color: #4b5563; /* gray-600 */
            text-align: center;
            padding: 2px 0;
            border-top: 1px dashed #cbd5e1; /* gray-300 */
            border-bottom: 1px dashed #cbd5e1; /* gray-300 */
            margin-top: 3px;
            background-color: #f9fafb; /* gray-50 */
        }
/* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */
/* â–¼â–¼â–¼ é«˜æ©Ÿèƒ½ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ‰ç”¨CSS â–¼â–¼â–¼ */

/* ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚³ãƒ³ãƒ†ãƒŠå…¨ä½“ */
#news-section {
    background-color: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
}

/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¿ãƒ– */
.news-filter-tab {
    display: flex;
    background-color: #fff;
    border-bottom: 1px solid #e2e8f0;
}
.news-filter-btn {
    flex: 1;
    padding: 10px;
    text-align: center;
    font-size: 0.85rem;
    font-weight: bold;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s;
    border-bottom: 3px solid transparent;
}
.news-filter-btn:hover {
    background-color: #f1f5f9;
    color: #334155;
}
.news-filter-btn.active {
    color: #2563eb;
    border-bottom-color: #2563eb;
    background-color: #eff6ff;
}

/* è¨˜äº‹ãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢ */
#news-articles {
    max-height: 500px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
    overflow-y: auto;
    padding: 10px;
    background-color: #f8fafc;
}

/* å€‹åˆ¥è¨˜äº‹ã‚«ãƒ¼ãƒ‰ */
.news-card {
    background-color: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin-bottom: 10px;
    padding: 12px;
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
    display: flex;
    gap: 12px;
    align-items: start;
}
.news-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

/* é‡è¦åº¦åˆ¥ã®å·¦ç·š */
.news-card.type-gogai { border-left: 5px solid #ef4444; background-color: #fef2f2; } /* å·å¤– */
.news-card.type-score { border-left: 5px solid #3b82f6; } /* è©¦åˆçµæœ */
.news-card.type-column { border-left: 5px solid #10b981; } /* ã‚³ãƒ©ãƒ  */
.news-card.type-scandal { border-left: 5px solid #a855f7; background-color: #faf5ff; } /* ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ« */

/* è¨˜äº‹å†…ã®è¦ç´  */
.news-meta {
    display: flex;
    justify-content: space-between;
    font-size: 0.7rem;
    color: #94a3b8;
    margin-bottom: 4px;
}
.news-category-badge {
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    color: #fff;
}
.badge-gogai { background-color: #ef4444; }
.badge-score { background-color: #3b82f6; }
.badge-column { background-color: #10b981; }
.badge-scandal { background-color: #a855f7; }

.news-headline {
    font-size: 1rem;
    font-weight: bold;
    color: #1e293b;
    line-height: 1.4;
    margin-bottom: 4px;
}
.news-snippet {
    font-size: 0.8rem;
    color: #64748b;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* 2è¡Œã§çœç•¥ */
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ (ãƒ€ãƒŸãƒ¼) */
.news-thumbnail {
    width: 80px;
    height: 60px;
    background-color: #e2e8f0;
    border-radius: 4px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}
#animation-stage {
    font-size: 0.75rem; /* å…¨ä½“ã®æ–‡å­—ã‚µã‚¤ã‚ºã‚’å°ã•ã‚ã« */
    transition: background-color 0.5s ease;
}
.anim-region, .anim-block, .anim-bracket {
    border: 1px solid #ccc;
    background-color: white;
    padding: 8px;
    margin: 5px;
    border-radius: 4px;
    text-align: center;
    opacity: 0;
    transition: all 0.5s ease-in-out;
    position: relative; /* å­è¦ç´ ã®çµ¶å¯¾é…ç½®åŸºæº– */
}
.anim-team {
    display: inline-block;
    background-color: #e0f2fe; /* blue-100 */
    border: 1px solid #7dd3fc; /* blue-300 */
    color: #0c4a6e; /* blue-800 */
    padding: 2px 5px;
    margin: 1px;
    border-radius: 3px;
    font-weight: 500;
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.3s ease-in-out;
}
.anim-team.seed {
    background-color: #fef9c3; /* yellow-100 */
    border-color: #facc15; /* yellow-400 */
    color: #713f12; /* yellow-900 */
    font-weight: bold;
}
.anim-team.winner {
    background-color: #dcfce7; /* green-100 */
    border-color: #4ade80; /* green-400 */
    color: #14532d; /* green-900 */
    font-weight: bold;
}
.anim-team.loser {
    background-color: #f1f5f9; /* slate-100 */
    border-color: #cbd5e1; /* slate-300 */
    color: #64748b; /* slate-500 */
    opacity: 0.6 !important;
    text-decoration: line-through;
}
.anim-team.show, .anim-region.show, .anim-block.show, .anim-bracket.show {
    opacity: 1;
    transform: scale(1);
}
.anim-highlight {
    box-shadow: 0 0 15px 5px rgba(251, 191, 36, 0.7); /* amber-400 */
    transform: scale(1.1) !important;
    z-index: 10;
}
.anim-arrow {
    position: absolute;
    width: 0;
    height: 0;
    border-top: 5px solid transparent;
    border-bottom: 5px solid transparent;
    opacity: 0;
    transition: opacity 0.5s ease-in-out 0.5s; /* å°‘ã—é…ã‚Œã¦è¡¨ç¤º */
}
.anim-arrow.right {
    border-left: 8px solid #60a5fa; /* blue-400 */
}
.anim-arrow.show {
    opacity: 1;
}

.details-table { 
    border-collapse: collapse; 
    font-size: 12px; 
    
}

/* 1. ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ»ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“ */
#scorecard-modal {
    z-index: 180; /* ãƒãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹(170)ã‚ˆã‚Šæ‰‹å‰ */
}
.scorecard-grid {
    display: grid;
    grid-template-areas:
        "header"
        "diamond"
        "actions"
        "log";
    grid-template-rows: auto 1fr auto auto;
    gap: 1rem;
    width: 100%;
    height: 100%;
    padding: 1rem;
}
@media (min-width: 768px) { /* md: */
    .scorecard-grid {
        grid-template-areas:
            "header header"
            "diamond actions"
            "diamond log";
        grid-template-columns: 2fr 1fr;
        grid-template-rows: auto 1fr auto;
    }
}

/* 2. é‡çƒã®ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ */
.baseball-diamond {
    grid-area: diamond;
    position: relative;
    width: 100%;
    max-width: 400px; /* æœ€å¤§å¹… */
    aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢ */
    margin: auto;
    background-color: #f7fafc; /* bg-gray-50 */
    border: 2px solid #e2e8f0; /* border-gray-300 */
    border-radius: 8px;
    transform: rotate(45deg);
}
.base {
    position: absolute;
    width: 12%;
    height: 12%;
    background-color: white;
    border: 2px solid #a0aec0; /* border-gray-400 */
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s ease-out;
}
.base.runner {
    background-color: #2563eb; /* bg-blue-600 */
    border-color: #1d4ed8;
    box-shadow: 0 0 15px 5px rgba(59, 130, 246, 0.7);
}
#base-home { bottom: -6%; left: 50%; transform: translateX(-50%) rotate(-45deg); border-radius: 0; width: 15%; height: 15%; }
#base-1b { top: 50%; right: -6%; transform: translateY(-50%); }
#base-2b { top: -6%; left: 50%; transform: translateX(-50%); }
#base-3b { top: 50%; left: -6%; transform: translateY(-50%); }
#pitchers-mound {
    position: absolute;
    top: 50%; left: 50%;
    width: 10%; height: 10%;
    background-color: #a0aec0; /* bg-gray-400 */
    border-radius: 50%;
    transform: translate(-50%, -50%);
}

/* 3. æ“ä½œãƒ‘ãƒãƒ« */
#scorecard-actions { grid-area: actions; }
#scorecard-log { grid-area: log; }
.result-btn {
    border: 1px solid #d1d5db; /* border-gray-300 */
    padding: 0.75rem 0.5rem;
    font-size: 0.875rem; /* text-sm */
    font-weight: 600;
    border-radius: 0.375rem; /* rounded-md */
    transition: all 0.1s ease-in;
    text-align: center;
}
.result-btn:hover {
    border-color: #9ca3af; /* hover:border-gray-400 */
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}
.result-btn-hit { background-color: #eff6ff; color: #1d4ed8; } /* bg-blue-50, text-blue-700 */
.result-btn-out { background-color: #fee2e2; color: #b91c1c; } /* bg-red-50, text-red-700 */
.result-btn-walk { background-color: #f0fdf4; color: #15803d; } /* bg-green-50, text-green-700 */
.result-btn-other { background-color: #fef9c3; color: #a16207; } /* bg-yellow-50, text-yellow-700 */
/* â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* 283å­¦åœ’ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ç”¨ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
        #homepage-modal #results .team.hp-team-283 {
            background-color: #eff6ff; /* bg-blue-50 */
            border-color: #93c5fd; /* border-blue-300 */
        }
        #homepage-modal #results .team.hp-team-283.winner {
            background-color: #1e3a8a; /* bg-blue-800 */
            color: white;
            font-weight: 900;
        }
        #homepage-modal #results .team.hp-team-283.winner .score,
        #homepage-modal #results .team.hp-team-283.winner .name {
            color: white;
        }
        #homepage-modal #results .team.hp-team-283.loser {
            background-color: #eef2ff; /* bg-indigo-50 */
            opacity: 0.8;
        }
        #homepage-modal #results .team.hp-team-283.loser .name {
            text-decoration: line-through;
        }
        /* â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

/* â–¼â–¼â–¼ ã“ã®æ–°ã—ã„ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ  â–¼â–¼â–¼ */
.details-table th {
    white-space: nowrap; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ–‡å­—ãŒæŠ˜ã‚Šè¿”ã•ãªã„ã‚ˆã†ã«ã™ã‚‹ */
}
/* â–²â–²â–² â–²â–²â–² */
.details-table td { 
    border: 1px solid #e5e7eb; 
    padding: 4px; 
    text-align: center; 
    vertical-align: middle; 
}
.details-table th { background-color: #f9fafb; font-weight: 600; }
.details-table input, .details-table select { width: 100%; border: none; text-align: center; background: transparent; font-size: 12px; }
.details-table input:focus, .details-table select:focus { outline: 1px solid #3b82f6; }

/* â˜…åˆ—å¹…è¨­å®šâ˜… */
/* ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ãƒ†ãƒ¼ãƒ–ãƒ« */
#inning-score-table { table-layout: auto; width: auto; } /* ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã¯è‡ªå‹•å¹… */
#inning-score-table .col-team { min-width: 120px; text-align: left; padding-left: 8px; }
#inning-score-table .col-inning-score { width: 40px; }
#inning-score-table .col-total { width: 50px; }
#inning-score-table .col-add-inning { width: 40px; }

/* â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼ */
/* æŠ•æ‰‹æˆç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« */
.details-table[id^="pitching-table"] .col-pitcher-result { min-width: 50px; }
.details-table[id^="pitching-table"] .col-pitcher-name { min-width: 130px; } /* é¸æ‰‹åæ¬„ã‚’åºƒã */
.details-table[id^="pitching-table"] .col-pitcher-throw-bat { min-width: 80px; }
.details-table[id^="pitching-table"] .col-pitcher-style { min-width: 110px; } /* æŠ•ã’æ–¹ (ã‚¹ãƒªãƒ¼ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼) */
.details-table[id^="pitching-table"] .col-pitcher-type { min-width: 80px; }
.details-table[id^="pitching-table"] .col-pitcher-velocity { min-width: 80px; }
.details-table[id^="pitching-table"] .col-stat { min-width: 60px; } /* å›æ•°, æ‰“è€…, çƒæ•° etc. */
/* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */



/* æ‰“æ’ƒæˆç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« */
/* â˜…åˆ—å¹…è¨­å®šï¼ˆmin-widthã§æœ€ä½å¹…ã‚’ä¿è¨¼ï¼‰â˜… */
.batting-table .col-order { min-width: 40px; }
.batting-table .col-number { min-width: 60px; }
.batting-table .col-throw-bat { min-width: 80px; } /* ã€ŒæŠ•/æ‰“ã€åˆ—ã®å¹…ã‚’ç¢ºä¿ */
.batting-table .col-player { min-width: 120px; }
.batting-table .col-pos { min-width: 100px; }
.batting-table .col-sub-type { min-width: 80px; }
.batting-table .col-inning { min-width: 400px; }  /* â†ãŠå¥½ã¿ã®å¹…ã«èª¿æ•´ã—ã¦ãã ã•ã„ */
/* â–²â–²â–² â–²â–²â–² */
        .add-row-btn { background-color: #e5e7eb; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-top: 4px; }

        .add-row-btn:hover { background-color: #d1d5db; }ã€€



ã€€ </style>
</head>
<body class="p-4 md:p-8">
     <audio id="lottery-bgm" src="./bgm.mp3" loop preload="auto"></audio>
    <div class="ballpark-background"></div>
    <div id="dust-container"></div>
 <div id="rain-container" class="rain hidden"></div>
    <div id="sun-container" class="sunshine hidden">
        <div class="sun"></div>
        <div class="sun-flare"></div>
    </div>
    <div id="app-container" class="max-w-full mx-auto">
/div>

<div id="team-tracker-container">
    <ul id="tracker-suggestions"></ul>
    <div class="tracker-bar">
        <span class="tracker-icon">ğŸ”</span>
        <input type="text" id="tracker-input" class="tracker-input" placeholder="ãƒãƒ¼ãƒ ä½ç½®ã‚’æ¤œç´¢..." autocomplete="off">
        <button id="tracker-clear-btn" class="text-gray-400 hover:text-gray-600 text-xs ml-1 font-bold hidden">âœ•</button>
    </div>
</div>

<div id="news-ticker-container">
    <div class="ticker-label">NEWS</div>
    <div class="ticker-content">
        <p id="ticker-text"></p>
    </div>
</div>

    <div id="weather-controls" class="fixed bottom-4 right-4 z-10">
        <div class="flex gap-2 p-2 bg-black bg-opacity-20 rounded-lg">
            <button id="unmute-btn" class="weather-btn">ğŸ”‡</button>
            <button class="weather-btn" data-weather="sun">â˜€ï¸</button>
            <button class="weather-btn" data-weather="rain">ğŸŒ§ï¸</button>
            <button class="weather-btn" data-weather="none">ğŸ’¨</button>
        </div>
    </div>
        
<div class="flex items-center justify-center space-x-4 p-4 mt-4 bg-slate-800/50 rounded-lg">
            <span class="font-semibold text-white">å¤§ä¼šé–‹å§‹æ™‚ã®AIè‡ªå‹•ç”Ÿæˆ</span>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="initial-ai-generation-toggle" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                <span class="ml-3 text-sm font-medium text-gray-300 peer-checked:text-white">ON</span>
            </label>
        </div>

<div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center z-[200]">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 class="text-xl font-bold">è¨­å®š</h3>
            <button id="settings-modal-close-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>
<div class="mb-6">
            <h4 class="text-sm font-bold text-gray-600 mb-2 text-center">ç¾åœ¨ã®å‹¢åŠ›åˆ†å¸ƒå›³</h4>
            <div id="rank-pyramid-container" class="w-full bg-gray-50 p-4 rounded-lg border border-gray-200">
                </div>

</div>
<div id="school-archive-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center z-[300] font-sans">
    <div class="bg-white w-full max-w-5xl h-[95vh] overflow-y-auto rounded-lg shadow-2xl relative">
        <button id="school-archive-close-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
        
        <div id="school-archive-content" class="p-8">
        </div>
    </div>
</div>
<div class="flex justify-center items-center space-x-2 mb-6">
    <div class="relative w-full max-w-md">
    <input type="text" id="school-search-input" 
        class="w-full p-3 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500" 
        placeholder="å­¦æ ¡åã€ç›£ç£åã€åœ°åŸŸ (ä¾‹: æµœæ¾ã€è¥¿éƒ¨)..." autocomplete="off">
    
    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
        <svg aria-hidden="true" class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
    </div>



    <ul id="search-suggestions" class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-xl mt-1 hidden max-h-60 overflow-y-auto">
        </ul>
</div>
<button id="school-search-btn" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-3">æ¤œç´¢</button>
</div>

<div class="flex flex-wrap justify-center gap-2 mb-8">
    <button class="rank-filter-btn bg-red-100 text-red-800 border border-red-300 hover:bg-red-200 font-bold py-1 px-3 rounded-full text-sm transition-colors" data-rank="A">
        ğŸ‘‘ Aãƒ©ãƒ³ã‚¯ (åé–€)
    </button>
    <button class="rank-filter-btn bg-blue-100 text-blue-800 border border-blue-300 hover:bg-blue-200 font-bold py-1 px-3 rounded-full text-sm transition-colors" data-rank="B">
        ğŸ›¡ï¸ Bãƒ©ãƒ³ã‚¯ (å¼·è±ª)
    </button>
    <button class="rank-filter-btn bg-yellow-100 text-yellow-800 border border-yellow-300 hover:bg-yellow-200 font-bold py-1 px-3 rounded-full text-sm transition-colors" data-rank="C">
        ğŸ¦„ Cãƒ©ãƒ³ã‚¯ (ä¸­å …)
    </button>
    <button class="rank-filter-btn bg-gray-100 text-gray-800 border border-gray-300 hover:bg-gray-200 font-bold py-1 px-3 rounded-full text-sm transition-colors" data-rank="D">
        ğŸ”¥ Dãƒ©ãƒ³ã‚¯ (ç™ºå±•é€”ä¸Š)
    </button>
    <button class="rank-filter-btn bg-white text-gray-600 border border-gray-300 hover:bg-gray-100 font-bold py-1 px-3 rounded-full text-sm transition-colors" data-rank="E">
        ğŸŒ± Eãƒ©ãƒ³ã‚¯ (æŒ‘æˆ¦è€…)
    </button>
</div>

        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <span class="font-semibold">è©¦åˆè¨˜äº‹ã®è‡ªå‹•ç”Ÿæˆ</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggle-article-generation" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <div class="flex items-center justify-between">
                <span class="font-semibold">æ²ç¤ºæ¿ã®è‡ªå‹•ç”Ÿæˆ</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggle-bbs-generation" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
        </div>
    </div>
</div>



        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white main-title">AIè¨˜è€…ä»˜ããƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨</h1>
            <p id="tournament-year-display" class="mt-2 subtitle-text">ï¼ˆæœ€çµ‚å®Ÿè£…ç‰ˆï¼‰</p>
        </div>

        <div id="setup" class="setup-card">
             <div class="w-full">
                 <h2 class="text-xl font-semibold mb-4 border-b pb-2 setup-header">å‚åŠ ãƒãƒ¼ãƒ  (126ãƒãƒ¼ãƒ )</h2>
                 <textarea id="teams-list" class="w-full h-96 p-3 border border-gray-300 rounded-lg" readonly></textarea>
             </div>
             <div class="mt-8 text-center">
                 <button id="resume-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 shadow-md mb-4 w-full md:w-auto">
                   å†é–‹ï¼ˆåˆã„è¨€è‘‰å…¥åŠ›ï¼‰
                 </button>
                 <button id="generate-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 shadow-md w-full md:w-auto">
                     æ–°ã—ã„ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’é–‹å§‹
                 </button>
ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<button id="help-btn" class="bg-gray-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-600 shadow-md mt-4 w-full md:w-auto">
    éŠã³æ–¹
</button>
 <button id="show-matome-site-btn" class="bg-orange-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-orange-600 shadow-md mt-4 w-full md:w-auto">
    ğŸ“° ã¾ã¨ã‚ã‚µã‚¤ãƒˆã‚’è¦‹ã‚‹
    </button>
<button id="open-sns-btn-main" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-600 shadow-md ml-2">
    ğŸ“± SNS
</button>            
 </div>
        </div>


<button id="show-awards-btn" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600 shadow-md ml-2">
    ğŸ† å¤§ä¼šè¡¨å½°å¼
</button>

<div id="awards-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden items-center justify-center z-[260] font-sans">
    <div class="bg-white w-full max-w-5xl h-[90vh] overflow-y-auto rounded-lg shadow-2xl flex flex-col">
        <div class="flex justify-between items-center p-4 border-b bg-amber-600 text-white sticky top-0 z-10">
            <h3 class="text-xl font-bold flex items-center">
                <span class="text-2xl mr-2">ğŸ‘‘</span> å¤§ä¼šå…¬å¼è¨˜éŒ²ãƒ»è¡¨å½°å¼
            </h3>
            <button id="awards-modal-close-btn" class="text-gray-200 hover:text-white text-2xl font-bold">&times;</button>
        </div>
        <div id="awards-content" class="p-6 bg-gray-50 flex-grow">
            <div class="loader">é›†è¨ˆä¸­...</div>
        </div>
    </div>
</div>

        <div id="tournament-display" class="hidden">
            <div id="autumn-regional-blocks-container" class="display-card hidden"></div>
            <div id="autumn-ranking-playoffs-container" class="display-card hidden"></div>
            <button id="skip-autumn-blocks-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 shadow-md hidden">åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸ã‚’ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-autumn-ranking-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 shadow-md hidden">åœ°åŒºé †ä½æ±ºå®šæˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-autumn-main-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 shadow-md hidden">çœŒå¤§ä¼šæœ¬æˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-spring-qualifiers-btn" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 shadow-md hidden">æ˜¥å­£åœ°åŒºäºˆé¸ã‚’ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-spring-round1-btn" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 shadow-md hidden">æ˜¥å­£çœŒå¤§ä¼š1å›æˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-spring-main-btn" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 shadow-md hidden">æ˜¥å­£çœŒå¤§ä¼š2å›æˆ¦ä»¥é™ã‚’ã‚¹ã‚­ãƒƒãƒ—</button>


            <div id="autumn-controls" class="text-center my-4 hidden">
                <button id="start-ranking-playoffs-btn" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-purple-700 shadow-md hidden">
                    åœ°åŒºå†…é †ä½æ±ºå®šæˆ¦ã¸é€²ã‚€
                </button>
                <button id="start-main-tournament-btn" class="bg-teal-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-teal-700 shadow-md hidden">
                    çœŒå¤§ä¼šæœ¬æˆ¦ã¸é€²ã‚€
                </button>

            </div>

            

<div id="region-map-section" class="display-card hidden scorebook-font">
                 <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">åœ°åŒºåˆ¥ å‹ã¡æ®‹ã‚ŠçŠ¶æ³</h2>
                 <div id="region-map-container" class="w-full"></div>
            </div>
             <div id="namco-news-section" class="hidden display-card border-2 border-orange-400">
                 <h2 class="text-xl font-bold text-orange-600 mb-3 text-center">ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</h2>
                 <div id="namco-news-content" class="space-y-2"></div>
             </div>
            <div class="flex justify-between items-start mb-4">
                <div>
                    <button id="generate-summary-btn" class="hidden bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 shadow-md">
                        ã“ã“ã¾ã§ã®å¤§ä¼šãƒã‚¤ãƒ©ã‚¤ãƒˆè¨˜äº‹ã‚’ç”Ÿæˆ
                    </button>
                    <button id="next-tournament-btn" class="hidden bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 shadow-md">
                        æ¬¡ã®å¤§ä¼šã¸é€²ã‚€
                    </button>
                </div>
               <div class="ml-auto">
                    <div class="flex items-center justify-end space-x-2">
                       
<button id="skip-r1-btn" class="hidden bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 shadow-md">1å›æˆ¦ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-r2-btn" class="hidden bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 shadow-md">2å›æˆ¦ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-r3-btn" class="hidden bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 shadow-md">3å›æˆ¦ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-r4-btn" class="hidden bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 shadow-md">4å›æˆ¦ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-r5-btn" class="hidden bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 shadow-md">æº–ã€…æ±ºå‹ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-r6-btn" class="hidden bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 shadow-md">æº–æ±ºå‹ã‚¹ã‚­ãƒƒãƒ—</button>
<button id="skip-final-btn" class="hidden bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 shadow-md">æ±ºå‹ã‚¹ã‚­ãƒƒãƒ—</button>

<button id="generate-summary-btn" class="hidden bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 shadow-md">
    æº–ã€…æ±ºå‹(R5) å±•æœ›è¨˜äº‹ã‚’ç”Ÿæˆ
</button>


                        <span id="save-feedback" class="text-gray-600 font-bold opacity-0 transition-opacity duration-500"></span>
<button id="show-matome-site-btn" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 shadow-md">
    ğŸ“° ã¾ã¨ã‚
    </button>
<button id="open-sns-btn" class="bg-sky-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-sky-600 shadow-md mt-4 w-full md:w-auto ml-2">
    ğŸ“± SNSã‚’è¦‹ã‚‹
 </button>
<button id="show-contribution-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 shadow-md ml-2">
    ğŸŒŒ è²¢çŒ®åº¦ãƒ»å¤©ä½“è¦³æ¸¬
</button>

<div id="contribution-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden items-center justify-center z-[250] font-sans">
    <div class="bg-white w-full max-w-6xl h-[90vh] overflow-y-auto rounded-lg shadow-2xl flex flex-col">
        
        <div class="flex justify-between items-center p-4 border-b bg-purple-900 text-white sticky top-0 z-10">
            <h3 class="text-xl font-bold flex items-center">
                <span class="text-2xl mr-2">ğŸŒŒ</span> ãƒãƒ¼ãƒ è²¢çŒ®åº¦ã‚·ã‚§ã‚¢ & å¤©ä½“è¦³æ¸¬
            </h3>
            <button id="contribution-close-btn" class="text-gray-300 hover:text-white text-2xl font-bold">&times;</button>
        </div>
        
        <div class="p-6 bg-gray-50 flex-grow">
            
            <div class="mb-6 flex justify-center relative max-w-md mx-auto">
                <div class="relative w-full">
                    <input type="text" id="contribution-team-input" class="w-full p-3 pl-10 text-lg font-bold text-gray-700 border-2 border-purple-300 rounded-lg focus:ring-purple-500 focus:border-purple-500" placeholder="åˆ†æã—ãŸã„ãƒãƒ¼ãƒ åã‚’å…¥åŠ›..." autocomplete="off">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <ul id="contribution-suggestions" class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-xl mt-1 hidden max-h-60 overflow-y-auto text-left"></ul>
                </div>
            </div>

            <div id="contribution-content" class="hidden space-y-8">
                
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-gray-400">
                    <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <span class="text-xl mr-2">ğŸ’¡</span> æŒ‡æ¨™ã®ç›®å®‰ã¨è©•ä¾¡åŸºæº–
                    </h4>
                    <div id="rc-guidelines" class="space-y-3">
                        </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-purple-500">
                    <h4 class="text-lg font-bold text-gray-800 mb-4">ğŸ“Š å¾—ç‚¹å‰µå‡ºã‚·ã‚§ã‚¢ (Runs Created Share)</h4>
                    <div class="flex flex-col md:flex-row items-center gap-8">
                        <div class="w-full md:w-1/2 h-64">
                            <canvas id="rc-pie-chart"></canvas>
                        </div>
                        <div class="w-full md:w-1/2">
                            <p class="text-sm text-gray-600 mb-2">
                                â€» <strong>RC (Runs Created)</strong>: ãã®é¸æ‰‹ãŒã€Œä¸€äººã§ä½•ç‚¹ç”Ÿã¿å‡ºã—ãŸã‹ã€ã‚’æ¨å®šã™ã‚‹æŒ‡æ¨™ã€‚
                            </p>
                            <div id="rc-analysis-text" class="text-md font-bold text-purple-800 p-3 bg-purple-50 rounded"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-yellow-500">
                    <h4 class="text-lg font-bold text-gray-800 mb-4">æ£’ã‚°ãƒ©ãƒ•ï¼šRC/Gï¼ˆè©¦åˆã‚ãŸã‚Šè²¢çŒ®åº¦ï¼‰ãƒ©ãƒ³ã‚­ãƒ³ã‚° (Top 10)</h4>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="rc-bar-chart"></canvas>
                    </div>
                </div>
                
               <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-indigo-500">
    
    <h4 class="text-lg font-bold text-gray-800 mb-4">âš¾ æ‰“è€…ã‚¿ã‚¤ãƒ—ãƒ»ãƒãƒƒãƒ— (OPSåˆ†æ)</h4>
    
    <div style="height: 400px; width: 100%;">
        <canvas id="stellar-scatter-chart"></canvas>
    </div>
    
    <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-center">
        
        <div class="p-2 bg-red-50 border border-red-200 rounded"><span class="text-lg">ğŸ’£ çˆ†ç™ºå‹</span><br>é•·æ‰“åŠ›ç‰¹åŒ– (OPSé«˜)</div>
        
        <div class="p-2 bg-blue-50 border border-blue-200 rounded"><span class="text-lg">ğŸ¯ ç†æƒ³å‹</span><br>æ‰“ç‡ãƒ»OPSã®ãƒãƒ©ãƒ³ã‚¹å‹</div>
        
        <div class="p-2 bg-orange-50 border border-orange-200 rounded"><span class="text-lg">ğŸ¹ è·äººå‹</span><br>é«˜æ‰“ç‡ãƒ»ç¢ºå®Ÿæ€§å‹ (AVGé«˜)</div>
        
        <div class="p-2 bg-gray-100 border border-gray-300 rounded"><span class="text-lg">ğŸ“ˆ æˆé•·æ ª</span><br>è¦å®šæ‰“å¸­æœªåˆ°é”/è‚²æˆæ </div>
    </div>
    </div>
</div>
</div>
      </div> 
</div>
<button id="show-rivalry-map-btn" class="bg-pink-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-pink-700 shadow-md ml-2">
    ğŸ’ å› ç¸ç›¸é–¢å›³
</button>

<div id="rivalry-map-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden items-center justify-center z-[250] font-sans">
    <div class="bg-white w-full max-w-6xl h-[90vh] overflow-y-auto rounded-lg shadow-2xl flex flex-col">
        <div class="flex justify-between items-center p-4 border-b bg-pink-900 text-white sticky top-0 z-10">
            <h3 class="text-xl font-bold flex items-center">
                <span class="text-2xl mr-2">ğŸ•¸ï¸</span> çœŒå†…å‹¢åŠ›ãƒ»å› ç¸ç›¸é–¢å›³
            </h3>
            <button id="rivalry-map-close-btn" class="text-gray-300 hover:text-white text-2xl font-bold">&times;</button>
        </div>
        <div class="p-6 bg-gray-50 flex-grow flex flex-col items-center">
            <div id="mermaid-container" class="w-full overflow-x-auto flex justify-center bg-white p-4 rounded border shadow-inner min-h-[300px]">
                </div>

            <div class="w-full mt-6">
                <h4 class="text-lg font-bold text-gray-700 mb-2 flex items-center">
                    <span class="mr-2">ğŸ“</span> AIæˆ¦æ³è¨˜è€…ã«ã‚ˆã‚‹ã€Œå‹¢åŠ›å›³ã€åˆ†æ
                </h4>
                <div id="rivalry-analysis-content" class="bg-white p-5 rounded-lg border border-gray-300 text-gray-800 leading-relaxed shadow-sm">
                    <p class="text-gray-400 text-center">ï¼ˆç›¸é–¢å›³ã®ç”Ÿæˆå¾Œã«åˆ†æãŒå§‹ã¾ã‚Šã¾ã™...ï¼‰</p>
                </div>
            </div>
            </div>
    </div>
</div>

<button id="show-scout-report-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 shadow-md ml-2">
    ğŸ•µï¸ ã‚¹ã‚«ã‚¦ãƒˆè©•ä¾¡
</button>

<div id="scout-report-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-[250] font-sans">
    <div class="bg-white w-full max-w-5xl h-[90vh] overflow-y-auto rounded-lg shadow-2xl flex flex-col">
        <div class="flex justify-between items-center p-4 border-b bg-indigo-900 text-white sticky top-0 z-10">
            <h3 class="text-xl font-bold flex items-center">
                <span class="text-2xl mr-2">ğŸ•µï¸</span> ãƒ—ãƒ­ã‚¹ã‚«ã‚¦ãƒˆè¦–å¯Ÿãƒ¬ãƒãƒ¼ãƒˆ
            </h3>
            <button id="scout-report-close-btn" class="text-gray-300 hover:text-white text-2xl font-bold">&times;</button>
        </div>
        <div id="scout-report-content" class="p-6 bg-gray-100 flex-grow">
            </div>
    </div>
</div>

<button id="show-lineup-analysis-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 shadow-md ml-2">
    âš¾ é©æ­£æ‰“é †åˆ†æ
</button>
                        

   <button id="open-settings-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 shadow-md">âš™ï¸ è¨­å®š</button>
<button id="save-btn" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 shadow-md">ã‚»ãƒ¼ãƒ–</button>
                        <button id="reset-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 shadow-md">ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                    <div id="skip-loader-container" class="h-6 text-right mt-1">
                         <span id="skip-loader" class="hidden text-sm text-gray-600 font-bold">è©¦åˆã‚’é€²è¡Œã—ã¦ã„ã¾ã™...</span>
                    </div>
                </div>
            </div>
            <div id="main-bracket-wrapper" class="display-card scorebook-font">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨</h2>
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4 rounded-md text-sm">
                    <p><b>PCã§ã®è¡¨ç¤ºã«ã¤ã„ã¦:</b> ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®å…¨ä½“ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ã€è¡¨ã®ã‚¨ãƒªã‚¢å†…ã§ãƒã‚¦ã‚¹ã®ãƒ›ã‚¤ãƒ¼ãƒ«ã‚’å›ã—ãªãŒã‚‰ <b>Shiftã‚­ãƒ¼</b> ã‚’æŠ¼ã™ã‹ã€è¡¨ã®ä¸‹ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’ç›´æ¥ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã“ã¨ã§ã€å·¦å³ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã¾ã™ã€‚</p>
                </div>
                <div id="main-bracket-container"></div>
            </div>
           <div id="news-section" class="display-card">
    <div class="p-4 border-b bg-white rounded-t-lg flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
            <span class="text-2xl mr-2">ğŸ“°</span> é€Ÿå ±ãƒ‹ãƒ¥ãƒ¼ã‚¹
        </h2>
        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Auto Update</span>
    </div>

    <div class="news-filter-tab">
        <div class="news-filter-btn active" data-filter="all">ã™ã¹ã¦</div>
        <div class="news-filter-btn" data-filter="score">è©¦åˆçµæœ</div>
        <div class="news-filter-btn" data-filter="column">ã‚³ãƒ©ãƒ /ç‰¹é›†</div>
        <div class="news-filter-btn" data-filter="gogai">é‡è¦/å·å¤–</div>
    </div>

    <div id="news-articles" class="space-y-2">
        <p class="text-gray-500 text-center py-8">ã¾ã ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </div>
</div>
             <div id="daiya-bbs-section" class="hidden display-card border-4 border-green-600">
                 <h2 id="daiya-bbs-title" class="text-2xl font-bold text-green-800 mb-4 text-center">ã€ç‰¹è¨­ã€‘ä»£çŸ¢æ± å¿œæ´æ²ç¤ºæ¿</h2>
                 <div id="daiya-bbs-comments" class="space-y-3">
                     <p class="text-gray-500 text-center">ã¾ã åå¿œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                 </div>
             </div>
             <div id="bbs-section" class="display-card">
                 <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">æ²ç¤ºæ¿ã®åå¿œ</h2>
<div class="mb-4 p-4 border rounded-lg bg-white">
    <form id="main-comment-form">
        <textarea id="main-comment-textarea" class="w-full p-2 border rounded" rows="2" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãè¾¼ã‚€... (ä¾‹: ä»Šæ—¥ã®å§«å·ã¯ãƒ¬ãƒ™ãƒã ã£ãŸã‚ï¼)" required></textarea>
        <div class="text-right mt-2">
            <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">æŠ•ç¨¿ã™ã‚‹</button>
        </div>
    </form>
</div>
                 <div id="bbs-comments" class="space-y-3">
                     <p class="text-gray-500 text-center">ã¾ã åå¿œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                 </div>
             </div>
        </div>
    </div>

    <div id="news-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div id="modal-bg" class="absolute inset-0"></div>
        <div class="relative bg-white rounded-lg shadow-xl max-w-2xl w-full m-4">
            <div class="p-6 modal-body-scroll">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-900"></h3>
                <div id="modal-meta" class="text-gray-400 text-sm mt-2 flex items-center gap-4"></div>
                <p id="modal-body" class="mt-4 text-gray-600 whitespace-pre-wrap"></p>
            </div>
            <button id="modal-close" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>
    
  
<div id="integrated-matome-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-[200]">
    <div class="bg-gray-100 p-2 md:p-4 rounded-lg shadow-xl w-full max-w-7xl max-h-[95vh] flex flex-col overflow-hidden">
        
        <div class="flex justify-between items-center mb-2 px-2 md:px-0">
            <h2 class="text-2xl md:text-3xl font-extrabold text-red-700 font-sans tracking-wide">
                <img src="koshien.jpg" alt="ãªã‚“Jã‚¹ã‚¿ã‚¸ã‚¢ãƒ " class="h-10 md:h-12 inline-block mr-2">
                ä¿ºãŸã¡ã®ç”²å­åœ’é€Ÿå ±ï¼ ãªã‚“Jã¾ã¨ã‚
            </h2>
            <button id="matome-modal-close-btn" class="text-gray-400 hover:text-gray-600">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="flex border-b border-gray-300 bg-white shadow-sm mb-3 text-sm md:text-base sticky top-0 z-10">
            <button class="matome-tab-btn active bg-blue-600 text-white py-2 px-4 rounded-t hover:bg-blue-700 transition-colors" data-tab="top">ãƒˆãƒƒãƒ—</button>
            <button class="matome-tab-btn text-gray-700 py-2 px-4 hover:bg-gray-100 transition-colors" data-tab="blog">ã“ã®ãƒ–ãƒ­ã‚°ã«ã¤ã„ã¦</button>
            <button class="matome-tab-btn text-gray-700 py-2 px-4 hover:bg-gray-100 transition-colors" data-tab="twitter">Twitter</button>
            <button class="matome-tab-btn text-gray-700 py-2 px-4 hover:bg-gray-100 transition-colors" data-tab="antenna">ãªã‚“Jã‚¢ãƒ³ãƒ†ãƒŠ</button>
            <button class="matome-tab-btn text-gray-700 py-2 px-4 hover:bg-gray-100 transition-colors" data-tab="baseball-mag">BaseBall MAG</button>
            </div>

        <div id="matome-content-area" class="flex-grow overflow-y-auto bg-gray-50 p-2 md:p-4 rounded-b-lg scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-200">
            
            <div id="matome-tab-top" class="matome-tab-content grid grid-cols-1 md:grid-cols-3 gap-4 active">
                <div class="md:col-span-2 mb-4">
                    <button id="open-new-thread-modal-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 shadow-md transition-all duration-150">
                        ï¼‹ æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç«‹ã¦ã‚‹
                    </button>
                </div>
                <div class="md:col-span-2 space-y-4">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">ğŸ”¥ æœ¬æ—¥ã®æ³¨ç›®è¨˜äº‹</h3>
                        <div id="matome-articles-container" class="space-y-2">
                            <div class="loader text-center py-8">è¨˜äº‹ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">âœ… ã¾ã¨ã‚</h3>
                        <ul class="list-none space-y-1">
                            <li class="flex items-start"><span class="text-blue-500 mr-2">âœ…</span><a href="#" class="text-gray-700 hover:text-blue-600">é‡çƒéƒ¨å“¡(14)ã€Œç”²å­åœ’ã¯èˆˆå‘³ãªã„ã€</a></li>
                            <li class="flex items-start"><span class="text-blue-500 mr-2">âœ…</span><a href="#" class="text-gray-700 hover:text-blue-600">DeNAãƒ»ã‚¸ãƒ£ã‚¯ã‚½ãƒ³ã€è¡æ’ƒã®ã‚¹ãƒªãƒ¼ãƒ©ãƒ³ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³ï½—ï½—ï½—ï½—ï½—ï½—</a></li>
                            <li class="flex items-start"><span class="text-blue-500 mr-2">âœ…</span><a href="#" class="text-gray-700 hover:text-blue-600">ã€ç”»åƒã€‘ã€Œä¸‹ç€ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ã€ãƒ‘ã‚¹ï½—ï½—ï½—ï½—ï½—ï½—ï½—ï½—ï½—</a></li>
                            <li class="flex items-start"><span class="text-blue-500 mr-2">âœ…</span><a href="#" class="text-gray-700 hover:text-blue-600">ã€æ‚²å ±ã€‘ãƒ¬ãƒ³ãƒãƒ³ã§ç°¡å˜ã«æ—¨ã„ãƒãƒ†ãƒå‘³ä»˜ã‘ã‚‰ã‚Œã‚‹ãƒ©ã‚¤ãƒ•ãƒãƒƒã‚¯ãŒãƒ¤ãƒã‚¤</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-white p-2 rounded-lg shadow-md text-center">
                        <h3 class="text-md font-bold text-gray-800 border-b pb-1 mb-2">ä»–ç¤¾ã‹ã‚‰ä¹—ã‚Šæ›ãˆã§</h3>
                        <img src="sumaho.jpg" alt="åºƒå‘Š" class="w-full h-auto rounded">
                        <p class="text-sm text-gray-600 mt-1">äººæ°—ã‚¹ãƒãƒ›<span class="text-xl font-bold text-red-600">500</span>å††ï¼</p>
                        <p class="text-xs text-gray-500">2025/8/31ã¾ã§</p>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">ğŸ’¡ ãªã‚“Jã‚¢ãƒ³ãƒ†ãƒŠ</h3>
                        <ul class="list-none space-y-1 text-sm">
                            <li><a href="#" class="text-gray-700 hover:text-blue-600">ãªã‚“J PRIDE: å·¨äººå²¡æœ¬å’ŒçœŸ(28) .300 40æœ¬ 100æ‰“ç‚¹</a></li>
                            <li><a href="#" class="text-gray-700 hover:text-blue-600">MLB NEWS: å¤§è°·ç¿”å¹³ã€æœ¬æ—¥ã‚‚äºŒåˆ€æµã§å¤§æ´»èº</a></li>
                            <li><a href="#" class="text-gray-700 hover:text-blue-600">ã¾ã¨ã‚ãƒ’ã‚¹ãƒˆãƒªã‚¢: æ˜”ã®ãªã‚“Jã‚¹ãƒ¬ã‚’æŒ¯ã‚Šè¿”ã‚‹</a></li>
                        </ul>
                    </div>
                    
                </div>
            </div>

            <div id="matome-tab-blog" class="matome-tab-content hidden p-4 bg-white rounded-lg shadow-md">
                <h3 class="text-xl font-bold">ã“ã®ãƒ–ãƒ­ã‚°ã«ã¤ã„ã¦</h3>
                <p class="mt-2 text-gray-700">å½“ãƒ–ãƒ­ã‚°ã€Œä¿ºãŸã¡ã®ç”²å­åœ’é€Ÿå ±ï¼ ãªã‚“Jã¾ã¨ã‚ã€ã¯ã€æ¶ç©ºã®é«˜æ ¡é‡çƒãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã¨ç¾å®Ÿä¸–ç•Œã®ãªã‚“Jãƒã‚¿ã‚’èåˆã•ã›ãŸã€å”¯ä¸€ç„¡äºŒã®ã¾ã¨ã‚ã‚µã‚¤ãƒˆã§ã™ã€‚</p>
                <p class="mt-2 text-gray-700">é‡çƒã«é–¢ã™ã‚‹è©±é¡Œã‚’ä¸­å¿ƒã«ã€æ™‚äº‹ãƒã‚¿ã‚„èŠ¸èƒ½ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€å­¦æ­´ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹ã‹ã‚‰æ´¾ç”Ÿã™ã‚‹è­°è«–ã¾ã§ã€ãªã‚“Jã§è©±é¡Œã«ãªã£ãŸæ§˜ã€…ãªã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç‹¬è‡ªã®è¦–ç‚¹ã§ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚</p>
                <p class="mt-2 text-gray-700">ç®¡ç†äººã€Œç”²å­åœ’ã®ç”³ã—å­ã€ãŒã€æ—¥å¤œå·¡å›ã—ã€ãƒ›ãƒƒãƒˆãªæƒ…å ±ã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚</p>
            </div>
            <div id="matome-tab-twitter" class="matome-tab-content hidden p-4 bg-white rounded-lg shadow-md">
                <h3 class="text-xl font-bold">Twitter</h3>
                <p class="mt-2 text-gray-700">@koshien_nanjã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã€æ—¥ã€…ç†±ã„å®Ÿæ³ã‚’ã—ã¦ã„ã¾ã™ï¼</p>
                <div class="mt-4 bg-gray-100 p-3 rounded">
                    <p class="font-bold">ãªã‚“Jã¾ã¨ã‚é€Ÿå ± @koshien_nanj</p>
                    <p class="text-sm mt-1">ä»Šæ—¥ã®è©¦åˆã‚‚ç†±ã™ãã‚‹ï¼â—‹â—‹é«˜æ ¡ã€ã¾ã•ã‹ã®é€†è»¢ã‚µãƒ¨ãƒŠãƒ©å‹ã¡ï½—ï½—ï½— #é«˜æ ¡é‡çƒ #ç”²å­åœ’ <span class="text-blue-500">#ãªã‚“J</span></p>
                    <p class="text-xs text-gray-500 mt-2">1æ™‚é–“å‰</p>
                </div>
                <div class="mt-4 bg-gray-100 p-3 rounded">
                    <p class="font-bold">ãªã‚“Jã¾ã¨ã‚é€Ÿå ± @koshien_nanj</p>
                    <p class="text-sm mt-1">ã€æ‚²å ±ã€‘ãƒ¯ã‚¤ã®å¿œæ´ã—ã¦ãŸé«˜æ ¡ã€åˆæˆ¦æ•—é€€â€¦ä»Šå¹´ã¯ã‚‚ã†çµ‚ã‚ã‚Šã‚„â€¦ <span class="text-blue-500">#ç”²å­åœ’ã®å¤</span></p>
                    <p class="text-xs text-gray-500 mt-2">3æ™‚é–“å‰</p>
                </div>
            </div>
            <div id="bbs-thread-display-area" class="hidden p-4 bg-white rounded-lg shadow-md flex flex-col h-full">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 id="bbs-thread-title" class="text-xl md:text-2xl font-bold text-gray-800"></h3>

<div>
                        <button id="retry-matome-thread-btn" class="bg-red-600 text-white font-bold py-1 px-3 rounded hover:bg-red-700 text-sm hidden" data-match-id="">
                            å†ç”Ÿæˆ
                        </button>

                    <button id="bbs-thread-back-btn" class="bg-blue-500 text-white font-bold py-1 px-3 rounded hover:bg-blue-600 text-sm">
                        ä¸€è¦§ã«æˆ»ã‚‹
                    </button>
                </div>
</div>
                <div id="bbs-thread-content" class="overflow-y-auto space-y-4 flex-grow">
                    <div class="loader text-center py-8">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                </div>
                <div class="mt-4 p-3 bg-gray-50 rounded-lg border-t text-sm text-gray-600">
                    <p>ã‚³ãƒ¡ãƒ³ãƒˆã¯ã€AIã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆã§ã™ã€‚ç‰¹å®šã®æ„è¦‹ã‚„äººç‰©ã‚’æ„å›³ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                </div>
            </div>

        </div>
    </div>
</div>

  <div id="confirm-modal" class="confirm-modal hidden">
        <div class="confirm-modal-content">
            <p id="confirm-modal-text" class="mb-4 text-lg"></p>
            <button id="confirm-ok" class="bg-red-600 text-white px-6 py-2 rounded-lg mr-2">ã¯ã„</button>
            <button id="confirm-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">ã„ã„ãˆ</button>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="details-modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
        <h3 class="text-xl font-bold mb-4 text-center border-b pb-3">è©¦åˆè©³ç´°å…¥åŠ›</h3>
        <div id="details-modal-body" class="overflow-y-auto space-y-6 flex-grow pr-2"> {/* pr-2 ã‚’è¿½åŠ ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã¨ã®éš™é–“ã‚’ä½œã‚‹ */}
            </div>
        
                <div class="mt-6 text-center border-t pt-4">
            <button id="details-save" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 mr-4">
                ã“ã®å†…å®¹ã§ä¿å­˜
            </button>
            <button id="details-close" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
        </div>
               
    </div>
</div>
            



    
<div id="save-load-modal" class="save-load-modal hidden fixed inset-0 bg-gray-900 bg-opacity-80 items-center justify-center z-[300]">
    <div class="save-load-modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
        <h3 class="text-xl font-bold mb-4 border-b pb-2 text-gray-800 flex items-center">
            <span class="text-2xl mr-2">ğŸ’¾</span> ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        </h3>

        <div class="flex border-b mb-4">
            <button id="tab-slots" class="px-6 py-2 font-bold border-b-2 border-blue-600 text-blue-600 transition-colors">
                ã‚¹ãƒ­ãƒƒãƒˆä¿å­˜/èª­è¾¼
            </button>
            <button id="tab-code" class="px-6 py-2 font-bold text-gray-500 border-b-2 border-transparent hover:text-gray-700 transition-colors">
                åˆã„è¨€è‘‰ (ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)
            </button>
        </div>

        <div id="content-slots" class="space-y-4">
            <p class="text-sm text-gray-600 mb-2">ãƒ–ãƒ©ã‚¦ã‚¶ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™ã€‚ã“ã¾ã‚ãªã‚»ãƒ¼ãƒ–ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>
            
            <div class="bg-yellow-50 border border-yellow-200 p-3 rounded flex justify-between items-center mb-4">
                <div>
                    <span class="text-xs font-bold bg-yellow-200 text-yellow-800 px-2 py-1 rounded">AUTO</span>
                    <span id="autosave-info" class="text-sm ml-2 text-gray-600">ãƒ‡ãƒ¼ã‚¿ãªã—</span>
                </div>
                <button id="load-autosave-btn" class="bg-yellow-500 text-white text-xs font-bold px-3 py-1.5 rounded hover:bg-yellow-600 shadow">
                    å†é–‹ã™ã‚‹
                </button>
            </div>

            <div id="save-slots-container" class="space-y-2">
                </div>
        </div>

        <div id="content-code" class="hidden space-y-4">
            <div class="p-4 bg-gray-50 rounded border">
                <h4 class="font-bold text-sm mb-2">ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ› (ã‚»ãƒ¼ãƒ–)</h4>
                <button id="generate-save-code-btn" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-bold shadow">
                    åˆã„è¨€è‘‰ã‚’ç™ºè¡Œã—ã¦ã‚³ãƒ”ãƒ¼
                </button>
                <textarea id="save-code-output" class="w-full h-24 mt-2 p-2 text-xs border rounded bg-gray-100" readonly placeholder="ã“ã“ã«ã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
            </div>

            <div class="p-4 bg-gray-50 rounded border">
                <h4 class="font-bold text-sm mb-2">ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ› (ãƒ­ãƒ¼ãƒ‰)</h4>
                <textarea id="load-code-input" class="w-full h-24 p-2 text-xs border rounded" placeholder="ã“ã“ã«åˆã„è¨€è‘‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
                <button id="load-from-code-btn" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 font-bold shadow mt-2">
                    ã“ã®ãƒ‡ãƒ¼ã‚¿ã§å†é–‹
                </button>
            </div>
        </div>

        <div class="mt-6 text-right border-t pt-4">
            <button id="save-load-close" class="bg-gray-200 text-gray-700 font-bold px-6 py-2 rounded hover:bg-gray-300">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>
</div>
    <div id="newspaper-modal" class="newspaper-modal hidden">
        <div class="newspaper-modal-content">
            <div id="newspaper-modal-body"></div>
            <div class="mt-4 text-center">
                <button id="newspaper-close" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>


<div id="feedback-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-[150]">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
        <h3 class="text-xl font-bold mb-4 text-center border-b pb-3">AIè¨˜è€…ã¸ã®è¿½åŠ æŒ‡ç¤º</h3>
        <div class="space-y-4">
            <div>
                <label for="feedback-include" class="block text-sm font-medium text-gray-700">âœ… ã“ã®è¦ç´ ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„</label>
                <textarea id="feedback-include" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹ï¼šæ®Šå‹²æ‰“ã‚’æ”¾ã£ãŸã€‡ã€‡é¸æ‰‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸­å¿ƒã«ã€‚&#10;ä¾‹ï¼šæ•—ã‚ŒãŸâ–³â–³é«˜æ ¡ã®ã‚¨ãƒ¼ã‚¹ã®æ¶™ã«ã‚‚è§¦ã‚Œã¦ã»ã—ã„ã€‚"></textarea>
            </div>
            <div>
                <label for="feedback-exclude" class="block text-sm font-medium text-gray-700">âŒ ã“ã®è¦ç´ ãƒ»å±•é–‹ã¯é¿ã‘ã¦ãã ã•ã„</label>
                <textarea id="feedback-exclude" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹ï¼šç›£ç£ã®é‡‡é…ãƒŸã‚¹ã¨ã„ã†è«–èª¿ã¯ã‚‚ã†ã„ã„ã€‚&#10;ä¾‹ï¼šã‚ã‚ŠããŸã‚Šãªã€Œå…¨å“¡é‡çƒã€ã¨ã„ã†è¨€è‘‰ã¯ä½¿ã‚ãªã„ã§ã€‚"></textarea>
            </div>
        </div>
        <div class="mt-6 text-center border-t pt-4">
            <button id="feedback-submit-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg mr-2">ã“ã®æŒ‡ç¤ºã§å†ç”Ÿæˆ</button>
            <button id="feedback-cancel-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<div id="review-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <h3 class="text-xl font-bold mb-4 text-center border-b pb-3">AIè¨˜äº‹ã®æœ€çµ‚ç¢ºèªãƒ»ç·¨é›†</h3>
        <div class="overflow-y-auto space-y-4 flex-grow">
            <div>
                <label for="review-title" class="block text-sm font-medium text-gray-700">ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" id="review-title" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="review-body" class="block text-sm font-medium text-gray-700">æœ¬æ–‡</label>
                <textarea id="review-body" rows="15" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 whitespace-pre-wrap"></textarea>
            </div>
        </div>
        <div class="mt-6 text-center border-t pt-4">
            <button id="review-save-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg mr-2">ã“ã®è¨˜äº‹ã§ç¢ºå®š</button>
            <button id="review-cancel-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<div id="lottery-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-[200] font-sans">
    <div id="lottery-content" class="bg-white rounded-lg shadow-2xl w-full max-w-6xl h-[95vh] flex flex-col p-6">
        <h2 class="text-4xl font-bold text-center mb-4 scorebook-font text-gray-800 tracking-widest">å¤ã®é«˜æ ¡é‡çƒ çµ„ã¿åˆã‚ã›æŠ½é¸ä¼š</h2>
        <div id="lottery-stage" class="flex-grow bg-gray-800 rounded p-4 flex gap-4 overflow-hidden relative border-4 border-gray-600">
            <div class="w-1/3 flex flex-col items-center justify-between bg-gray-200 rounded-lg shadow-inner p-4">
                <div id="lottery-pot-container" class="w-full flex flex-col items-center">
                    <p id="pot-name" class="text-2xl font-bold text-gray-700 mb-2">Aã‚·ãƒ¼ãƒ‰</p>
                    <div id="lottery-pot" class="w-48 h-48 bg-red-800 border-4 border-yellow-400 text-white flex items-center justify-center text-5xl font-bold shadow-lg rounded-full cursor-pointer transition-transform duration-200 hover:scale-105">
                        æŠ½é¸
                    </div>
                </div>
                <div id="drawn-team-container" class="w-full h-32 border-4 border-dashed border-gray-400 rounded-lg flex items-center justify-center opacity-0 bg-white">
                    <p id="drawn-team" class="text-4xl font-bold text-gray-800"></p>
                </div>
            </div>
            <div id="lottery-bracket" class="w-2/3 grid grid-cols-2 gap-x-4 h-full overflow-y-auto p-2 bg-gray-100 rounded-lg shadow-inner">
                <div id="lottery-bracket-left" class="space-y-1"></div>
                <div id="lottery-bracket-right" class="space-y-1"></div>
            </div>
        </div>
        <div class="h-32 flex flex-col justify-between pt-4">
            <div id="lottery-commentary" class="h-20 text-center text-2xl font-semibold text-gray-800 bg-yellow-100 border-2 border-yellow-300 rounded p-2 flex items-center justify-center">
                <p>é™å²¡å¤§ä¼š æŠ½é¸ä¼šã¸ã‚ˆã†ã“ãã€‚ä¸»å°†ã¯æŠ½é¸ç®±ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¯ã‚¸ã‚’å¼•ã„ã¦ãã ã•ã„ã€‚</p>
            </div>
            <div id="lottery-controls" class="text-center">
    <button id="start-lottery-btn" class="bg-blue-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-blue-700">æŠ½é¸ã‚’é–‹å§‹</button>
    <button id="skip-lottery-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 ml-4">ã‚¹ã‚­ãƒƒãƒ—</button>
</div>
        </div>
    </div>
</div>

<div id="analysis-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden flex flex-col items-center justify-center z-[250] p-4 font-sans">
    <div class="w-full max-w-6xl h-full flex flex-col">
        <div class="flex-shrink-0 flex justify-between items-center mb-4">
            <div id="analysis-block-tabs" class="flex space-x-1 p-1 bg-gray-800 rounded-lg">
                <button class="analysis-block-tab-btn px-4 py-2 rounded-md text-sm font-bold transition-colors" data-block="A">Aãƒ–ãƒ­ãƒƒã‚¯</button>
                <button class="analysis-block-tab-btn px-4 py-2 rounded-md text-sm font-bold transition-colors" data-block="B">Bãƒ–ãƒ­ãƒƒã‚¯</button>
                <button class="analysis-block-tab-btn px-4 py-2 rounded-md text-sm font-bold transition-colors" data-block="C">Cãƒ–ãƒ­ãƒƒã‚¯</button>
                <button class="analysis-block-tab-btn px-4 py-2 rounded-md text-sm font-bold transition-colors" data-block="D">Dãƒ–ãƒ­ãƒƒã‚¯</button>
            </div>
            <button id="analysis-modal-close-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
        </div>
        
        <div id="analysis-stage" class="flex-grow bg-gray-900 rounded-lg relative overflow-hidden">
            </div>

        <div id="analysis-narration-box" class="flex-shrink-0 h-28 mt-4 bg-gray-800 border-t-2 border-cyan-500 rounded-b-lg p-4 overflow-y-auto">
            <p id="analysis-narration-text" class="text-white text-lg leading-relaxed whitespace-pre-wrap"></p>
        </div>
    </div>
</div>

<div id="interview-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-[300]">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 m-4 animate-fade-in-up">
        <h3 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">æŠ½é¸ä¼šå¾Œ ä¸»å°†ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼</h3>
        <div id="interview-content" class="space-y-4 max-h-[60vh] overflow-y-auto"></div>
        <div class="text-center mt-6">
            <button id="close-interview-btn" class="bg-blue-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-blue-700">å¤§ä¼šã‚’å§‹ã‚ã‚‹</button>
        </div>
    </div>
</div>

<div id="new-thread-modal" class="new-thread-modal hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
        <h3 class="text-xl font-bold mb-4 text-center border-b pb-3">æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</h3>
        <div class="space-y-4">
            <div>
                <label for="new-thread-title" class="block text-sm font-medium text-gray-700">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" id="new-thread-title" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="ä¾‹ï¼šã€‡ã€‡é«˜æ ¡ã®éˆ´æœ¨ã€ã‚¬ãƒã§å¤©æ‰ã™ãã‚‹">
            </div>
            <div>
                <label for="new-thread-comment" class="block text-sm font-medium text-gray-700">æœ¬æ–‡ (>>1)</label>
                <textarea id="new-thread-comment" rows="6" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="ä¾‹ï¼š1å›æˆ¦ã®ãƒ”ãƒƒãƒãƒ³ã‚°è¦‹ãŸã‹ï¼Ÿã‚ã‚Œã¯æœ¬ç‰©ã ã‚..."></textarea>
            </div>
        </div>
        <div class="mt-6 text-center border-t pt-4">
            <button id="new-thread-submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 mr-4">
                ã‚¹ãƒ¬ã‚’ç«‹ã¦ã‚‹
            </button>
            <button id="new-thread-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
        </div>
    </div>
</div>

<div id="help-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <h3 class="text-xl font-bold mb-4 text-center border-b pb-3">AIè¨˜è€…ä»˜ããƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ å–æ‰±èª¬æ˜æ›¸ (Ver. ç§‹/æ˜¥å¯¾å¿œç‰ˆ)</h3>
        <div class="overflow-y-auto space-y-6 flex-grow pr-4 text-gray-700">

            <div>
                <h4 class="font-bold text-lg text-blue-700 mb-2">ã¯ã˜ã‚ã«ï¼šã‚ãªãŸã ã‘ã®é«˜æ ¡é‡çƒå²ã‚’å‰µã‚‹</h4>
                <p class="text-sm">
                    ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ç›®çš„ã¯ã€å˜ã«è©¦åˆã®å‹ã¡è² ã‘ã‚’æ±ºã‚ã‚‹ã“ã¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚ãªãŸã®é‡‡é…ã‚„å…¥åŠ›ã—ãŸè©³ç´°ãªè©¦åˆå†…å®¹ã«åŸºã¥ãã€AIãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã€Œãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã€ã€Œæ²ç¤ºæ¿ã®åå¿œã€ã€Œã¾ã¨ã‚ã‚µã‚¤ãƒˆé¢¨ã‚¹ãƒ¬ãƒƒãƒ‰ã€ã€æ™‚ã«ã¯ã€Œå¯†ç€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ã€ã‚’ç”Ÿæˆã—ã¾ã™ã€‚å¤ã®ç”²å­åœ’ã€ç§‹ã®æ–°ãƒãƒ¼ãƒ ã€æ˜¥ã®é¸æŠœã¸ã¨ç¶šãä¸€å¹´é–“ã®ãƒ‰ãƒ©ãƒã‚’é€šã˜ã¦ã€ã‚ãªãŸã ã‘ã®å”¯ä¸€ç„¡äºŒã®é«˜æ ¡é‡çƒã®æ­´å²ã‚’å‰µã‚Šä¸Šã’ã€ãã®ç›®æ’ƒè€…ã¨ãªã‚‹ã“ã¨ãŒã€ã“ã®ã‚²ãƒ¼ãƒ ã®æœ€å¤§ã®é†é†å‘³ã§ã™ã€‚
                </p>
            </div>

            <div>
                <h4 class="font-bold text-lg text-blue-700 mb-2">åŸºæœ¬çš„ãªã‚²ãƒ¼ãƒ ã®æµã‚Œ</h4>
                <ol class="list-decimal list-inside space-y-2 text-sm">
                    <li><strong>ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆé–‹å§‹:</strong> ã€Œæ–°ã—ã„ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’é–‹å§‹ã€ãƒœã‚¿ãƒ³ã§ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã¾ã™ã€‚åˆå›ã¯å¤ã®é™å²¡çœŒå¤§ä¼šã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚æŠ½é¸ä¼šã‚¤ãƒ™ãƒ³ãƒˆã‚’çµŒã¦ã€çµ„ã¿åˆã‚ã›ãŒæ±ºå®šã•ã‚Œã¾ã™ã€‚</li>
                    <li><strong>ã‚¹ã‚³ã‚¢å…¥åŠ›:</strong> ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®å„è©¦åˆã‚«ãƒ¼ãƒ‰ã«ã€åŠè§’æ•°å­—ã§æœ€çµ‚ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›ã—ã¾ã™ã€‚</li>
                    <li><strong>å‹è€…æ±ºå®š:</strong> ã‚¹ã‚³ã‚¢å…¥åŠ›å¾Œã€å‹ã£ãŸæ–¹ã®ãƒãƒ¼ãƒ ã®é’ã„ã€Œâ–¶ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚</li>
                    <li><strong>AIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ:</strong> å‹è€…ãŒæ±ºã¾ã‚‹ã¨ã€AIãŒè‡ªå‹•ã§è©¦åˆã«é–¢ã™ã‚‹ã€Œãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã€ã‚„ã€Œæ²ç¤ºæ¿ã®åå¿œã€ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ï¼ˆè¨­å®šã§ON/OFFå¯èƒ½ï¼‰</li>
                    <li><strong>è©³ç´°å…¥åŠ› (ä»»æ„ãƒ»æ¨å¥¨):</strong> è©¦åˆã‚«ãƒ¼ãƒ‰ã®ã€Œè©³ç´°å…¥åŠ›ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ã‚„å€‹äººæˆç¸¾ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€AIãŒç”Ÿæˆã™ã‚‹ç‰©èªã®ãƒªã‚¢ãƒªãƒ†ã‚£ã¨æ·±ã¿ãŒæ ¼æ®µã«å‘ä¸Šã—ã¾ã™ã€‚</li>
                    <li><strong>å¤§ä¼šé€²è¡Œ:</strong> å…¨ã¦ã®è©¦åˆãŒçµ‚äº†ã™ã‚‹ã¨ã€å„ªå‹ãƒãƒ¼ãƒ ãŒæ±ºå®šã—ã¾ã™ã€‚å¤ã®å¤§ä¼šçµ‚äº†å¾Œã¯è‡ªå‹•çš„ã«ç§‹ã®å¤§ä¼šã¸ã€ç§‹ã®å¾Œã¯æ˜¥ã¸ã€æ˜¥ã®å¾Œã¯æ¬¡ã®å¹´ã®å¤ã¸ã¨é€²ã¿ã¾ã™ã€‚</li>
                    <li><strong>ã‚»ãƒ¼ãƒ–ï¼†ãƒ­ãƒ¼ãƒ‰:</strong> ã€Œã‚»ãƒ¼ãƒ–ã€ãƒœã‚¿ãƒ³ã§ã„ã¤ã§ã‚‚é€²è¡ŒçŠ¶æ³ã‚’ã€Œåˆã„è¨€è‘‰ã€ã¨ã—ã¦ä¿å­˜ã§ãã¾ã™ã€‚ã€Œå†é–‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€Œåˆã„è¨€è‘‰ã€ã‚’å…¥åŠ›ã™ã‚Œã°ã€ä¸­æ–­ã—ãŸã¨ã“ã‚ã‹ã‚‰å†é–‹ã§ãã¾ã™ã€‚</li>
                </ol>
            </div>

            <div>
                <h4 class="font-bold text-lg text-orange-700 mb-2">ã€é‡è¦ã€‘ä¸€å¹´é–“ã®å¤§ä¼šã‚µã‚¤ã‚¯ãƒ«ã¨ãƒ«ãƒ¼ãƒ«</h4>
                <p class="text-sm mb-3">
                    ã“ã®ä¸–ç•Œã§ã¯ã€é«˜æ ¡é‡çƒã®ä¸€å¹´é–“ï¼ˆå¤â†’ç§‹â†’æ˜¥ï¼‰ãŒè‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã€‚å„å¤§ä¼šã«ã¯ç•°ãªã‚‹ç›®çš„ã¨ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚Šã€ãã‚Œãã‚ŒãŒæ¬¡ã®å¤§ä¼šã®ã‚·ãƒ¼ãƒ‰æ¨©ãªã©ã«å½±éŸ¿ã—ã¾ã™ã€‚
                </p>
                <div class="space-y-4">
                    <div class="p-4 border rounded-lg bg-yellow-50">
                        <h5 class="font-semibold text-gray-800">å¤ã®å¤§ä¼š (ç”²å­åœ’ã¸ã®é“)</h5>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            <li>3å¹´ç”Ÿã«ã¨ã£ã¦æœ€å¾Œã®å¤§ä¼šã€‚64æ ¡ã«ã‚ˆã‚‹ä¸€ç™ºå‹è² ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã€‚</li>
                            <li>æ˜¥å­£å¤§ä¼šã®ãƒ™ã‚¹ãƒˆ8ãŒã‚·ãƒ¼ãƒ‰æ ¡ã¨ãªã‚Šã¾ã™ã€‚</li>
                            <li>å„ªå‹æ ¡ã¯å¤ã®ç”²å­åœ’ã«å‡ºå ´ã—ãŸã¨ã¿ãªã•ã‚Œã€AIãŒãã®å…¨å›½ã§ã®æˆ¦ç¸¾ï¼ˆä¾‹: å…¨å›½ãƒ™ã‚¹ãƒˆ8ã€ç”²å­åœ’åˆæˆ¦æ•—é€€ãªã©ï¼‰ã‚’è‡ªå‹•ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã€è¨˜éŒ²ã—ã¾ã™ã€‚</li>
                            <li>å¤§ä¼šå‰ã«ã¯çµ„ã¿åˆã‚ã›æŠ½é¸ä¼šã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¾ã™ã€‚</li>
                        </ul>
                    </div>

                    <div class="p-4 border rounded-lg bg-purple-50">
                        <h5 class="font-semibold text-gray-800">ç§‹ã®å¤§ä¼š (æ–°ãƒãƒ¼ãƒ å§‹å‹•ãƒ»ã‚»ãƒ³ãƒãƒ„ã¸ã®åºç« )</h5>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            <li>1,2å¹´ç”Ÿã®æ–°ãƒãƒ¼ãƒ ã§æŒ‘ã‚€æœ€åˆã®å…¬å¼æˆ¦ã€‚</li>
                            <li>ã¾ãšã€æ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨ãƒ»ä¼Šè±†ã®4åœ°åŒºã«åˆ†ã‹ã‚Œã¦åœ°åŒºäºˆé¸ã‚’è¡Œã„ã¾ã™ã€‚
                                <div class="mt-2 mb-2 p-2 bg-purple-100 rounded text-xs border border-purple-300">
                                    <p class="font-semibold mb-1">åœ°åŒºäºˆé¸ã®ä»•çµ„ã¿:</p>
                                    <p class="mb-1"><strong>æ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨åœ°åŒº (å„5æ ):</strong></p>
                                    <pre class="whitespace-pre-wrap leading-tight">
[åœ°åŒº20ãƒãƒ¼ãƒ ]
    â”‚
    â”œâ”€â–¶ [ãƒ–ãƒ­ãƒƒã‚¯A (5)] â”€â–¶ å„ªå‹ (çœŒ) / æº–å„ªå‹ â”
    â”œâ”€â–¶ [ãƒ–ãƒ­ãƒƒã‚¯B (5)] â”€â–¶ å„ªå‹ (çœŒ) / æº–å„ªå‹ â”¤
    â”œâ”€â–¶ [ãƒ–ãƒ­ãƒƒã‚¯C (5)] â”€â–¶ å„ªå‹ (çœŒ) / æº–å„ªå‹ â”¼â”€â–¶ [ç¬¬5ä»£è¡¨æ±ºå®šæˆ¦ (4)] â”€â–¶ å„ªå‹ (çœŒ)
    â””â”€â–¶ [ãƒ–ãƒ­ãƒƒã‚¯D (5)] â”€â–¶ å„ªå‹ (çœŒ) / æº–å„ªå‹ â”˜   (æ•—è€…å¾©æ´»)</pre>
                                    <p class="mt-1"><strong>ä¼Šè±†åœ°åŒº (1æ ):</strong></p>
                                    <pre class="whitespace-pre-wrap leading-tight">[ä¼Šè±†4ãƒãƒ¼ãƒ ] â”€â–¶ [ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ] â”€â–¶ å„ªå‹ (çœŒ)</pre>
                                </div>
                            </li>
                            <li>å„åœ°åŒºäºˆé¸ã‚’å‹ã¡æŠœã„ãŸè¨ˆ16ãƒãƒ¼ãƒ ãŒçœŒå¤§ä¼šæœ¬æˆ¦ (ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ) ã«é€²å‡ºã—ã¾ã™ã€‚
                                <div class="mt-2 mb-2 p-2 bg-purple-100 rounded text-xs border border-purple-300">
                                    <p class="font-semibold mb-1">çœŒå¤§ä¼šæœ¬æˆ¦ (16ãƒãƒ¼ãƒ ):</p>
                                    <pre class="whitespace-pre-wrap leading-tight">
    â”Œâ”€ æ±éƒ¨ä»£è¡¨ (5) â”
    â”œâ”€ ä¸­éƒ¨ä»£è¡¨ (5) â”¤
    â”œâ”€ è¥¿éƒ¨ä»£è¡¨ (5) â”¼â”€â–¶ [çœŒå¤§ä¼š (16ãƒãƒ¼ãƒ T)] â”€â–¶ å„ªå‹/æº–å„ªå‹ (ã‚»ãƒ³ãƒãƒ„æœ‰åŠ›)
    â””â”€ ä¼Šè±†ä»£è¡¨ (1) â”˜                       â””â”€â–¶ ãƒ™ã‚¹ãƒˆ8ä»¥ä¸Š (æ˜¥å­£ã‚·ãƒ¼ãƒ‰)</pre>
                                </div>
                            </li>
                            <li>çœŒå¤§ä¼šã®**å„ªå‹ãƒ»æº–å„ªå‹æ ¡**ã¯ã€æ˜¥ã®ã‚»ãƒ³ãƒãƒ„ç”²å­åœ’ã¸ã®å‡ºå ´æ¨©ã‚’å¾—ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆAIãŒç¢ºç‡ã§åˆ¤å®šï¼‰ã€‚</li>
                            <li>çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8ä»¥ä¸Šã®æˆç¸¾ã‚’åã‚ã‚‹ã¨ã€æ¬¡ã®**æ˜¥å­£å¤§ä¼šã®ã‚·ãƒ¼ãƒ‰æ¨©**ã‚’ç²å¾—ã§ãã¾ã™ã€‚</li>
                        </ul>
                    </div>

                    <div class="p-4 border rounded-lg bg-green-50">
                        <h5 class="font-semibold text-gray-800">æ˜¥ã®å¤§ä¼š (å¤ã®ã‚·ãƒ¼ãƒ‰æ¨©ç²å¾—æˆ¦)</h5>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            <li>å¤ã®å¤§ä¼šã®å‰å“¨æˆ¦ã¨ãªã‚‹é‡è¦ãªå¤§ä¼šã€‚</li>
                            <li>ç§‹å­£å¤§ä¼šãƒ™ã‚¹ãƒˆ8ã®ãƒãƒ¼ãƒ ã¯ã‚·ãƒ¼ãƒ‰æ ¡ã¨ãªã‚Šã€çœŒå¤§ä¼š2å›æˆ¦ã‹ã‚‰ç™»å ´ã—ã¾ã™ã€‚</li>
                            <li>ãã‚Œä»¥å¤–ã®å…¨ãƒãƒ¼ãƒ ã¯ã€ã¾ãšåœ°åŒºäºˆé¸ã«å‚åŠ ã—ã€å„åœ°åŒºä»£è¡¨æ  (æ±5, ä¸­5, è¥¿5, ä¼Šè±†1) ã‚’äº‰ã„ã¾ã™ã€‚</li>
                            <li>åœ°åŒºäºˆé¸ã‚’çªç ´ã—ãŸ16ãƒãƒ¼ãƒ ãŒã€çœŒå¤§ä¼š1å›æˆ¦ã§å¯¾æˆ¦ã—ã¾ã™ã€‚</li>
                            <li>1å›æˆ¦ã®å‹è€…8ãƒãƒ¼ãƒ ãŒã€2å›æˆ¦ã§å¾…ã¤ã‚·ãƒ¼ãƒ‰8ãƒãƒ¼ãƒ ã¨å¯¾æˆ¦ã—ã¾ã™ï¼ˆè¨ˆ16ãƒãƒ¼ãƒ ã«ã‚ˆã‚‹æœ¬æˆ¦ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆï¼‰ã€‚</li>
                            <li>ã“ã®å¤§ä¼šã§**ãƒ™ã‚¹ãƒˆ8**ä»¥ä¸Šã®æˆç¸¾ã‚’åã‚ã‚‹ã¨ã€æ¬¡ã®**å¤ã®å¤§ä¼šã®ã‚·ãƒ¼ãƒ‰æ¨©**ã‚’ç²å¾—ã§ãã¾ã™ã€‚
                                <div class="mt-2 mb-2 p-2 bg-green-100 rounded text-xs border border-green-300">
                                    <p class="font-semibold mb-1">çœŒå¤§ä¼šã®ä»•çµ„ã¿:</p>
                                    {/* Mermaid Diagram Code Block - Requires Mermaid.js library */}
                                    <pre><code class="language-mermaid">
graph TD
    subgraph çœŒå¤§ä¼š
        R1[1å›æˆ¦ (äºˆé¸çªç ´16ãƒãƒ¼ãƒ )] --> |å‹è€…8ãƒãƒ¼ãƒ | R2
        subgraph æœ¬æˆ¦ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ
            S[ã‚·ãƒ¼ãƒ‰8ãƒãƒ¼ãƒ  (ç§‹ãƒ™ã‚¹ãƒˆ8)] --> R2{2å›æˆ¦ (16ãƒãƒ¼ãƒ )}
            R2 --> QF{æº–ã€…æ±ºå‹ (ãƒ™ã‚¹ãƒˆ8)}
            QF --> SF{æº–æ±ºå‹ (ãƒ™ã‚¹ãƒˆ4)}
            SF --> F{æ±ºå‹}
        end
        QF --â–¶ |å¤ã®ã‚·ãƒ¼ãƒ‰æ¨©ç²å¾—| SumSeed(å¤ã®å¤§ä¼šã‚·ãƒ¼ãƒ‰æ¨©)
    end

    subgraph åœ°åŒºäºˆé¸
        O[ã‚·ãƒ¼ãƒ‰ä»¥å¤–ã®ãƒãƒ¼ãƒ ] --> RegQ{åœ°åŒºäºˆé¸}
        RegQ --> |16ãƒãƒ¼ãƒ | R1
    end

    style S fill:#f9f,stroke:#333,stroke-width:2px
    style SumSeed fill:#ccf,stroke:#333,stroke-width:2px
                                    </code></pre>
                                    <p class="mt-1 text-gray-500">(å›³ã®èª¬æ˜) ã‚·ãƒ¼ãƒ‰æ ¡ã¯2å›æˆ¦ã‹ã‚‰ç™»å ´ã€‚åœ°åŒºäºˆé¸çªç ´çµ„ã¯1å›æˆ¦ã‹ã‚‰æˆ¦ã„ã€å‹ã¡ä¸ŠãŒã‚‹ã¨ã‚·ãƒ¼ãƒ‰æ ¡ã¨å¯¾æˆ¦ã€‚ãƒ™ã‚¹ãƒˆ8ä»¥ä¸Šã§å¤ã®ã‚·ãƒ¼ãƒ‰æ¨©ç²å¾—ã€‚</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div>
                <h4 class="font-bold text-lg text-teal-700 mb-2">ã€æœ€é‡è¦ã€‘è©³ç´°å…¥åŠ›ï¼šç‰©èªã‚’æ·±åŒ–ã•ã›ã‚‹éµ</h4>
                <p class="text-sm mb-3">
                    è©¦åˆçµæœã®ã‚¹ã‚³ã‚¢ã ã‘ã§ãªãã€ã€Œè©³ç´°å…¥åŠ›ã€ã‚’è¡Œã†ã“ã¨ã§ã€AIãŒç”Ÿæˆã™ã‚‹è¨˜äº‹ã‚„ã‚³ãƒ¡ãƒ³ãƒˆã®è³ªãŒåŠ‡çš„ã«å‘ä¸Šã—ã€ã‚ˆã‚Šæ·±ã¿ã®ã‚ã‚‹ç‰©èªãŒç”Ÿã¾ã‚Œã¾ã™ã€‚é¢å€’ã§ã‚‚ã€ãœã²å…¥åŠ›ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
                </p>
                <ul class="list-disc list-inside space-y-2 text-sm bg-teal-50 p-4 rounded-lg">
                    <li><strong>ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢:</strong> è©¦åˆå±•é–‹ã‚’AIã«ä¼ãˆã¾ã™ã€‚ã€Œåˆå›ã«å¤§é‡å¾—ç‚¹ã—ãŸè©¦åˆã€ã¨ã€Œ9å›ã«é€†è»¢ã‚µãƒ¨ãƒŠãƒ©ã—ãŸè©¦åˆã€ã§ã¯ã€ç”Ÿæˆã•ã‚Œã‚‹è¨˜äº‹ã®ãƒ‰ãƒ©ãƒæ€§ãŒå…¨ãç•°ãªã‚Šã¾ã™ã€‚å»¶é•·æˆ¦ã¯ã€Œ+å›ã€ãƒœã‚¿ãƒ³ã§è¿½åŠ ã§ãã¾ã™ã€‚</li>
                    <li><strong>æ‰“æ’ƒæˆç¸¾:</strong>
                        <ul class="list-circle list-inside ml-4 text-xs">
                            <li>**æ‰“å¸­çµæœ:** ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰çµæœãƒ»æ–¹å‘ãƒ»æ‰“ç‚¹ãªã©ã‚’é¸æŠã—ã¾ã™ã€‚1ã‚¤ãƒ‹ãƒ³ã‚°ã«è¤‡æ•°æ‰“å¸­ã‚ã£ãŸå ´åˆã¯ã€Œ+2æ‰“å¸­ç›®ã‚’è¿½åŠ ã€ã§å…¥åŠ›ã§ãã¾ã™ã€‚</li>
                            <li>**èµ°å¡:** ã€Œ+èµ°è€…ãƒ—ãƒ¬ãƒ¼ã‚’è¿½åŠ ã€ã§ç›—å¡ã€é€²å¡ã€èµ°å¡æ­»ãªã©ã‚’å…¥åŠ›ã§ãã¾ã™ã€‚</li>
                            <li>**å‡ºå ´:** ä»£æ‰“ãƒ»ä»£èµ°ãƒ»å®ˆå‚™äº¤ä»£ãªã©ã®æƒ…å ±ã¯ã€äº¤ä»£é¸æ‰‹ã®æ´»èºã‚’æå†™ã™ã‚‹ä¸Šã§é‡è¦ã§ã™ã€‚</li>
                            <li>AIã¯ã“ã“ã§ã®å…¥åŠ›ã«åŸºã¥ãã€ãã®è©¦åˆã®ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚’ç‰¹å®šã—ã€è¨˜äº‹ã®ä¸­å¿ƒäººç‰©ã¨ã—ã¦æå†™ã—ã¾ã™ã€‚</li>
                        </ul>
                    </li>
                    <li><strong>æŠ•æ‰‹æˆç¸¾:</strong> æŠ•æ‰‹åã€æŠ•çƒå›ã€å¤±ç‚¹ã€å¥ªä¸‰æŒ¯ãªã©ã‚’å…¥åŠ›ã—ã¾ã™ã€‚å…ˆç™ºå®ŒæŠ•ã€ãƒªãƒªãƒ¼ãƒ•æˆåŠŸã€ç‚ä¸Šãªã©ã€æŠ•æ‰‹ã®æ´»èºã‚„è‹¦é—˜ãŒè¨˜äº‹ã«åæ˜ ã•ã‚Œã¾ã™ã€‚ã€Œ+æŠ•æ‰‹ã‚’è¿½åŠ ã€ã§ç¶™æŠ•ã‚‚è¨˜éŒ²ã§ãã¾ã™ã€‚</li>
                    <li><strong>è©¦åˆã®æ±ºã‚æ‰‹ (ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢):</strong> ã‚¹ã‚³ã‚¢å…¥åŠ›æ¬„ã®ä¸‹ã«ã‚ã‚‹å°ã•ãªãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã§ã™ã€‚ã“ã“ã«**æœ€ã‚‚ä¼ãˆãŸã„è©¦åˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ**ï¼ˆä¾‹ï¼šã€Œã‚¨ãƒ¼ã‚¹ã€‡ã€‡ã€æ°—è¿«ã®150çƒå®ŒæŠ•å‹åˆ©ã€ã€Œä¼å…µâ–³â–³ã®ã‚µãƒ¨ãƒŠãƒ©æ‰“ã€ãªã©ï¼‰ã‚’ç°¡æ½”ã«å…¥åŠ›ã™ã‚‹ã¨ã€AIã¯ä»–ã®ã©ã®æƒ…å ±ã‚ˆã‚Šã‚‚ã“ã‚Œã‚’**æœ€å„ªå…ˆ**ã—ã€è¨˜äº‹å…¨ä½“ã®ãƒ†ãƒ¼ãƒã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚</li>
                </ul>
                <p class="text-xs mt-2 text-gray-600">â€»è©³ç´°å…¥åŠ›ç”»é¢ã®ã€Œå…ˆæ”»ãƒ»å¾Œæ”»ã‚’å…¥ã‚Œæ›¿ãˆã€ãƒœã‚¿ãƒ³ã§ã€å…¥åŠ›å†…å®¹ã”ã¨ãƒãƒ¼ãƒ ã‚’å…¥ã‚Œæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</p>
                <p class="text-xs mt-1 text-gray-600">â€»ã‚¹ã‚³ã‚¢å…¥åŠ›æ¬„ã®æ¨ªã«ã‚ã‚‹ã€ŒğŸ²ã€ãƒœã‚¿ãƒ³ã§ã€ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ã¦AIãŒãŠã¾ã‹ã›ã§è©³ç´°å†…å®¹ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</p>
            </div>

            <div>
                <h4 class="font-bold text-lg text-indigo-700 mb-2">AIãŒç”Ÿæˆã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹:</strong> è©¦åˆçµæœã‚„å¤§ä¼šã®å±•æœ›ã€æ™‚ã«ã¯ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«ç–‘æƒ‘(!)ãªã©ã€æ§˜ã€…ãªè¨˜äº‹ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã€Œæœ¬æ–‡ã€ãƒœã‚¿ãƒ³ã§å†…å®¹ã‚’èª­ã‚ã¾ã™ã€‚è¨˜äº‹ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’åˆã‚ã›ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã€Œå†ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€AIã«è¿½åŠ æŒ‡ç¤ºã‚’ä¸ãˆã¦è¨˜äº‹ã‚’æ›¸ãç›´ã•ã›ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ©Ÿèƒ½ï¼‰ã€‚</li>
                    <li><strong>æ²ç¤ºæ¿ã®åå¿œ:</strong> AIãŒåŒ¿åæ²ç¤ºæ¿ã®ãƒ•ã‚¡ãƒ³ã«ãªã‚Šãã‚Šã€è©¦åˆçµæœã‚„ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«å¯¾ã—ã¦ãƒªã‚¢ãƒ«ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã‚ãªãŸã‚‚ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã§ãã€AIãƒ•ã‚¡ãƒ³ãŒãã‚Œã«è¿”ä¿¡ã—ã¦ãã‚Œã¾ã™ã€‚</li>
                    <li><strong>ã¾ã¨ã‚ã‚µã‚¤ãƒˆé¢¨ã‚¹ãƒ¬ãƒƒãƒ‰:</strong> ã€ŒğŸ“° ã¾ã¨ã‚ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§ã€ç¾å®Ÿã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¨ã‚²ãƒ¼ãƒ å†…ã®è©¦åˆçµæœãŒæ··åœ¨ã—ãŸã€ãªã‚“Jã¾ã¨ã‚ã‚µã‚¤ãƒˆé¢¨ã®è¡¨ç¤ºãŒæ¥½ã—ã‚ã¾ã™ã€‚å„è¨˜äº‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®è©±é¡Œã«é–¢ã™ã‚‹AIç”Ÿæˆã®æ²ç¤ºæ¿ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’èª­ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚</li>
                    <li><strong>ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ãƒ‹ãƒ¥ãƒ¼ã‚¹:</strong> ç³»åˆ—æ ¡ï¼ˆ765ç·åˆã€283å­¦åœ’ãªã©ï¼‰ã®è©¦åˆçµæœã‚„çµ„ã¿åˆã‚ã›ã«é–¢ã™ã‚‹ã€ä¼æ¥­å…¬å¼ç™ºè¡¨é¢¨ã®ãŠçŸ¥ã‚‰ã›ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</li>
                    <li><strong>ã‚¹ãƒãƒ¼ãƒ„æ–°è:</strong> å¤§ä¼šãŒé€²ã‚€ã¨ï¼ˆæº–ã€…æ±ºå‹ä»¥é™ï¼‰ã€AIãŒãã®æ—¥ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ä¸€é¢è¨˜äº‹ã«ã—ãŸã‚¹ãƒãƒ¼ãƒ„æ–°èé¢¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã€Œæ–°èã‚’èª­ã‚€ã€ãƒœã‚¿ãƒ³ã§è¡¨ç¤ºã§ãã¾ã™ã€‚</li>
                    <li><strong>å¯†ç€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼:</strong> ç‰¹å®šã®ãƒãƒ¼ãƒ ï¼ˆå¼·è±ªã€å¤è±ªã€é€†å¢ƒæ ¡ãªã©ï¼‰ã«ç„¦ç‚¹ã‚’å½“ã¦ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼è¨˜äº‹ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚è©¦åˆã®å‹æ•—ã«å¿œã˜ã¦é€£è¼‰å½¢å¼ã§ç‰©èªãŒé€²è¡Œã—ã¾ã™ã€‚</li>
                </ul>
            </div>

             <div>
                <h4 class="font-bold text-lg text-pink-700 mb-2">ãã®ä»–ã®æ©Ÿèƒ½</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>ãƒãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®ãƒãƒ¼ãƒ åã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®ãƒãƒ¼ãƒ ã®éå»ã®æœ€é«˜æˆç¸¾ã‚„ç›´è¿‘ã®æˆç¸¾ã€ç²å¾—ã—ãŸç§°å·ï¼ˆä¾‹ï¼šã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒ©ãƒ¼ï¼‰ãªã©ã‚’ç¢ºèªã§ãã¾ã™ã€‚</li>
                    <li><strong>ã‚¹ã‚­ãƒƒãƒ—æ©Ÿèƒ½:</strong> å„å¤§ä¼šã‚„ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã«ç”¨æ„ã•ã‚ŒãŸã€Œã‚¹ã‚­ãƒƒãƒ—ã€ãƒœã‚¿ãƒ³ã‚’ä½¿ã†ã¨ã€è©¦åˆçµæœã‚’è‡ªå‹•ã§ï¼ˆãƒ©ãƒ³ã‚¯å·®ãªã©ã‚’è€ƒæ…®ã—ã¦ï¼‰ç”Ÿæˆã—ã€å¤§ä¼šã‚’é«˜é€Ÿã§é€²è¡Œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</li>
                    <li><strong>è¨­å®š:</strong> ç”»é¢å³ä¸Šã®ã€Œâš™ï¸ è¨­å®šã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚„æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆã®è‡ªå‹•ç”Ÿæˆã‚’ON/OFFã§ãã¾ã™ã€‚</li>
                    <li><strong>æŠ½é¸ä¼š/å‹¢åŠ›å›³åˆ†æ:</strong> å¤ã®å¤§ä¼šé–‹å§‹æ™‚ã«ã¯æŠ½é¸ä¼šã‚¤ãƒ™ãƒ³ãƒˆãŒã€æŠ½é¸å¾Œã«ã¯å„ãƒ–ãƒ­ãƒƒã‚¯ã®å‹¢åŠ›å›³ã‚’AIãŒåˆ†æãƒ»è§£èª¬ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
                 </ul>
            </div>

            <div>
                <h4 class="font-bold text-lg text-red-700 mb-2">ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h4>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong>ã‚¨ãƒ©ãƒ¼ã§å‹•ä½œãŒãŠã‹ã—ããªã£ãŸ / ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹:</strong> æœ€ã‚‚å¤šã„åŸå› ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å¤ã„ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¨ã€æœ€æ–°ç‰ˆã®ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã®é–“ã§çŸ›ç›¾ãŒç”Ÿã˜ã¦ã„ã‚‹ã“ã¨ã§ã™ã€‚**ã€Œãƒªã‚»ãƒƒãƒˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä¸€åº¦å®Œå…¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¦ã‹ã‚‰**ã€Œæ–°ã—ã„ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’é–‹å§‹ã€ã™ã‚‹ã¨è§£æ±ºã™ã‚‹ã“ã¨ãŒã»ã¨ã‚“ã©ã§ã™ã€‚é–‹ç™ºä¸­ã®ä»•æ§˜å¤‰æ›´å¾Œã¯ç‰¹ã«ãƒªã‚»ãƒƒãƒˆã‚’ãŠè©¦ã—ãã ã•ã„ã€‚</li>
                    <li><strong>AIã®è¨˜äº‹ã‚„ã‚³ãƒ¡ãƒ³ãƒˆãŒãŠã‹ã—ã„ / äº‹å®Ÿã¨é•ã†:</strong> AIã«ä¸ãˆã‚‹æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹ã‹ã€AIãŒç¨€ã«å‹˜é•ã„ã‚’ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
                        <ul class="list-circle list-inside ml-4 text-xs">
                            <li>è¨˜äº‹ã®å ´åˆã¯ã€ã€Œå†ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¸ãˆã¦ã¿ã¦ãã ã•ã„ã€‚</li>
                            <li>æ€ã£ãŸã‚ˆã†ãªè¨˜äº‹ã«ãªã‚‰ãªã„å ´åˆã€è©³ç´°å…¥åŠ›ã§ã‚ˆã‚Šå¤šãã®æƒ…å ±ï¼ˆç‰¹ã«æ•—ã‚ŒãŸãƒãƒ¼ãƒ ã®æˆç¸¾ã‚„ã€æ´»èºã—ãŸé¸æ‰‹åï¼‰ã‚’å…·ä½“çš„ã«å…¥åŠ›ã—ãŸã‚Šã€ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€æ¬„ã‚’æ´»ç”¨ã—ãŸã‚Šã™ã‚‹ã¨æ”¹å–„ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</li>
                        </ul>
                    </li>
                     <li><strong>ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆåˆã„è¨€è‘‰ï¼‰ãŒèª­ã¿è¾¼ã‚ãªã„:</strong> ã‚³ãƒ¼ãƒ‰ãŒæ›´æ–°ã•ã‚Œã‚‹ã¨ã€å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®åˆã„è¨€è‘‰ã¯èª­ã¿è¾¼ã‚ãªããªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã”äº†æ‰¿ãã ã•ã„ã€‚</li>
                </ul>
            </div>

       </div> <div id="tournament-animation-section" class="mt-6 border-t pt-4">

                <h4 class="font-bold text-lg text-purple-700 mb-3 text-center">å›³è§£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¦‹ã‚‹å¤§ä¼šã‚·ã‚¹ãƒ†ãƒ </h4>

                <div class="flex justify-center space-x-4 mb-4">

                    <button id="show-autumn-anim-btn" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">ğŸ‚ ç§‹å­£å¤§ä¼šã‚’è¦‹ã‚‹</button>

                    <button id="show-spring-anim-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">ğŸŒ¸ æ˜¥å­£å¤§ä¼šã‚’è¦‹ã‚‹</button>

                </div>

                <div id="animation-stage" class="bg-gray-100 p-4 rounded min-h-[300px] border relative overflow-hidden flex flex-col justify-center items-center">

                    <p id="anim-placeholder" class="text-gray-500">ä¸Šã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹</p>

                </div>

                <p id="animation-narration" class="mt-3 text-center text-sm font-semibold h-10"></p>

                <div class="flex justify-center space-x-4 mt-3">

                    <button id="prev-step-btn" class="bg-gray-400 text-white px-4 py-1 rounded hover:bg-gray-500 disabled:opacity-50" disabled>ï¼œ å‰ã¸</button>

                    <button id="next-step-btn" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600 disabled:opacity-50" disabled>æ¬¡ã¸ ï¼</button>

                </div>

            </div>

            </div> <div class="mt-6 text-center border-t pt-4">

            <button id="help-modal-close" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">é–‰ã˜ã‚‹</button>

        </div>

    </div> </div>

<div id="player-stats-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center z-[170]">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 class="text-xl font-bold text-gray-800">å€‹äººé€šç®—æˆç¸¾</h3>
            <button id="player-stats-modal-close" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
        </div>
        
        <div id="player-stats-modal-body" class="overflow-y-auto flex-grow space-y-6 p-2">
            <div class="loader text-center py-16">é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>
</div>

<div id="team-stats-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center z-[170]">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 id="team-stats-modal-title" class="text-2xl font-bold text-gray-800">ï¼ˆãƒãƒ¼ãƒ åï¼‰ é€šç®—æˆç¸¾</h3>
            <button id="team-stats-modal-close" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
        </div>
        
        <div id="team-stats-modal-body" class="overflow-y-auto flex-grow p-2">
            <div class="flex border-b mb-4 sticky top-0 bg-white z-10">
                <button class="team-stats-tab-btn active" data-tab="stats">
                    é€šç®—æˆç¸¾
                </button>
                <button class="team-stats-tab-btn" data-tab="lineups">
                    è©¦åˆåˆ¥ã‚¹ã‚¿ãƒ¡ãƒ³
                </button>
            </div>

            <div id="team-stats-tab-content-stats" class="team-stats-tab-content space-y-6">
                <div class="loader text-center py-16">é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            
            <div id="team-stats-tab-content-lineups" class="team-stats-tab-content hidden space-y-4">
                <div class="loader text-center py-16">ã‚¹ã‚¿ãƒ¡ãƒ³å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>
        
    </div>
</div>

<div id="team-status-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">


    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 id="status-modal-team-name" class="text-2xl font-bold text-gray-800"></h3>
            <button id="status-modal-close" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <div class="space-y-4 overflow-y-auto pr-2">
            <div>
                <h4 class="font-semibold text-sm text-gray-500 uppercase tracking-wider">æœ€é«˜æˆ¦ç¸¾</h4>
                <p id="status-modal-best" class="text-lg text-amber-600 font-bold"></p>
            </div>
            <div>
                <h4 class="font-semibold text-sm text-gray-500 uppercase tracking-wider">ç›´è¿‘ã®æˆç¸¾</h4>
                <div id="status-modal-history" class="space-y-1 text-gray-700"></div>
            </div>
            <div>
                <h4 class="font-semibold text-sm text-gray-500 uppercase tracking-wider">ç§°å·</h4>
                <div id="status-modal-traits" class="flex flex-wrap gap-2"></div>
            </div>
            
            <div>
                <h4 class="font-semibold text-sm text-gray-500 uppercase tracking-wider mb-2">ä»Šå¤§ä¼š ãƒãƒ¼ãƒ ãƒãƒ£ãƒ¼ãƒˆ</h4>
                <div id="team-chart-container" class="relative" style="height: 300px;">
                    <canvas id="team-radar-chart"></canvas>
                </div>
            </div>
            
            <div class="mt-4">
                <h4 class="font-semibold text-sm text-gray-500 uppercase tracking-wider">ä»Šå¤§ä¼š ãƒãƒ¼ãƒ æˆç¸¾ (æ•°å­—)</h4>
                <p id="status-modal-team-stats" class="text-lg text-blue-700 font-bold"></p>
            </div>

<div class="mt-6">
                <h4 class="font-semibold text-sm text-gray-500 uppercase tracking-wider border-b pb-1 mb-2 flex items-center">
                    <span>ğŸ“Š ã‚»ã‚¤ãƒãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹è©³ç´°åˆ†æ</span>
                    <span class="ml-auto text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded">Beta</span>
                </h4>
                <div id="status-modal-sabermetrics">
                    </div>
            </div>

            <div>
                <h4 class="font-semibold text-sm text-gray-500 uppercase tracking-wider">ãƒãƒ¼ãƒ é€šç®—æˆç¸¾ (å…¨å¤§ä¼š)</h4>
                <p id="status-modal-career-stats" class="text-lg text-gray-800 font-bold"></p>
            </div>
            
            <div>
                <h4 class="font-semibold text-sm text-gray-500 uppercase tracking-wider">ç›£ç£</h4>
                <div id="status-modal-coach" class="text-gray-700"></div>
            </div>

<div id="status-modal-homepage-link-container" class="mt-6 border-t pt-4 text-center hidden">
                <a id="status-modal-homepage-link" class="inline-block bg-blue-700 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-800 transition-colors cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 inline-block -mt-1 mr-2">
                        <path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.665l3-3Z" />
                        <path d="M8.603 17.39a4 4 0 0 0 5.656-5.656l-3-3a4 4 0 0 0-.225-5.865.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.665l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 0 0 5.656 5.656Z" />
                    </svg>
                    å…¬å¼ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¸
                </a>
            </div>

        </div>
        
    </div>
</div>

<div id="sns-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-[250]">
    <div class="sns-modal-content h-[80vh] flex flex-col">
        <div class="sns-header flex justify-between items-center">
            <h3 class="text-xl font-bold">ãƒˆãƒ¬ãƒ³ãƒ‰</h3>
            <button id="sns-modal-close" class="text-2xl text-gray-600 hover:bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center">&times;</button>
        </div>
        
        <div class="flex border-b border-gray-200">
            <button class="flex-1 py-3 font-bold hover:bg-gray-100 border-b-4 border-blue-500 text-gray-900" id="sns-tab-trend">ãŠã™ã™ã‚</button>
            <button class="flex-1 py-3 font-bold text-gray-500 hover:bg-gray-100" id="sns-tab-timeline">æœ€æ–°</button>
        </div>

        <div id="sns-content-area" class="overflow-y-auto flex-grow bg-white">
            </div>
    </div>
</div>

<div id="trend-notification">
    <span class="text-xl">ğŸ“ˆ</span>
    <div>
        <p class="text-xs opacity-90">æ—¥æœ¬ã®ãƒˆãƒ¬ãƒ³ãƒ‰</p>
        <p id="trend-notification-word" class="font-bold">#283å­¦åœ’</p>
    </div>
</div>


<script type="module">

const BATTING_RESULTS = {
    hits: ['å®‰', 'äºŒå¡æ‰“', 'ä¸‰å¡æ‰“', 'æœ¬å¡æ‰“'],
    outs: ['ä¸‰æŒ¯', 'ã‚´ãƒ­', 'é£›', 'é‚ª', 'ç›´', 'ä½µæ®º'],
    walks: ['å››çƒ', 'æ­»çƒ', 'æ•¬é '],
    sacrifices: ['çŠ æ‰“', 'çŠ é£›', 'çŠ å¤±'], // â† ã“ã“ã«è¿½åŠ 
    other: ['é‡é¸', 'ã‚¨ãƒ©ãƒ¼']
};
const DIRECTIONS = ['æŠ•', 'æ•', 'ä¸€', 'äºŒ', 'ä¸‰', 'éŠ', 'å·¦', 'ä¸­', 'å³'];
const RBIS = ['1ç‚¹', '2ç‚¹', '3ç‚¹', '4ç‚¹'];

    // --- ãƒ©ã‚¤ãƒãƒ«é–¢ä¿‚ã¨ç§°å·ã®å®šç¾© ---
    const RIVALRIES = [
        { teams: ["é™å²¡", "æ›å·è¥¿"], type: "å…¬ç«‹ã®è¦‡æ¨©äº‰ã„" },
        { teams: ["283å­¦åœ’", "é™å²¡å•†æ¥­"], type: "ä¼çµ±ã¨ç‹è€…ã®è¦‡æ¨©å¯¾æ±º" },
        { teams: ["765ç·åˆé«˜æ ¡", "é™å²¡"], type: "æ–°æ—§ç‹è€…å¯¾æ±º" },
        { teams: ["é™å²¡", "é™å²¡å•†æ¥­"], type: "ä¼çµ±ã®ä¸€æˆ¦" }
    ];
    const TITLES = {
        GIANT_KILLER: { id: 'giant_killer', name: 'ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒ©ãƒ¼', desc: 'æ ¼ä¸Šã®å¼·è±ªæ ¡ã‚’å€’ã—ãŸå®Ÿç¸¾ã‚’æŒã¤ã€‚' },
        REPECHAGE_KING: { id: 'repechage_king', name: 'ä¸å±ˆã®æ•—è€…å¾©æ´»çµ„', desc: 'æ•—è€…å¾©æ´»æˆ¦ã‹ã‚‰é€™ã„ä¸ŠãŒã£ã¦ããŸå®Ÿç¸¾ãŒã‚ã‚Šã€éå¸¸ã«ç²˜ã‚Šå¼·ã„ã€‚' },
        WALL_OF_TOKYO: { id: 'wall_of_tokyo', name: 'è¥¿æ±äº¬ã®å£', desc: 'è¥¿æ±äº¬åœ°åŒºã«ç«‹ã¡ã¯ã ã‹ã‚‹çµ¶å¯¾çš„å¼·è€…ã€‚' } // ä¾‹
    };
const tournamentNameMap = { summer: 'å¤å­£å¤§ä¼š', autumn: 'ç§‹å­£å¤§ä¼š', spring: 'æ˜¥å­£å¤§ä¼š' };


// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆã‚‹ â–¼â–¼â–¼
const SCANDAL_DEFINITIONS = [
    {
        id: 'overpractice',
        condition: (teamName) => ['A', 'B'].includes(calculateRank(teamName, tournamentState)),
        
        // æ–‡å­—åˆ—ã‹ã‚‰é–¢æ•°ã«å¤‰æ›´
        rumorTitle: (teamName) => `ã€é€±åˆŠç†±é—˜ã€‘${teamName}ã«ã€Œé•æ³•ç·´ç¿’ã€ç–‘æƒ‘ã‹ï¼Ÿ`,
        rumorBody: (teamName) => `å¼·è±ªã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹${teamName}ã ãŒã€ãã®å¼·ã•ã®è£ã«ã¯ã€é«˜æ ¡é‡çƒé€£ç›ŸãŒå®šã‚ã‚‹ç·´ç¿’æ™‚é–“è¦å®šã‚’å¤§å¹…ã«è¶…éã™ã‚‹ã»ã©ã®çŒ›ç·´ç¿’ãŒã‚ã‚‹ã¨ã„ã†ã‚¿ãƒ¬ã‚³ãƒŸãŒæœ¬èªŒã«å¯„ã›ã‚‰ã‚ŒãŸã€‚æ·±å¤œã¾ã§ãƒãƒƒãƒˆã®éŸ³ãŒé³´ã‚ŠéŸ¿ãã¨ã„ã†è¿‘éš£ä½æ°‘ã®è¨¼è¨€ã‚‚ã‚ã‚Šã€ä»Šå¾Œã®å‹•å‘ãŒæ³¨ç›®ã•ã‚Œã‚‹ã€‚`,
        
        consequences: {
            report: {
                // ã“ã¡ã‚‰ã‚‚åŒæ§˜ã«é–¢æ•°ã«å¤‰æ›´
                outcomeTitle: (teamName) => `ã€é€Ÿå ±ã€‘${teamName}ã€ç·´ç¿’è¦å®šé•åã§å…¬å¼æˆ¦ã‚’è¾é€€`,
                outcomeBody: (teamName) => `å…ˆæ—¥ã€é€±åˆŠèªŒã§å ±ã˜ã‚‰ã‚ŒãŸ${teamName}ã®ç·´ç¿’æ™‚é–“è¦å®šé•åå•é¡Œã§ã€é«˜é‡é€£ã¯èª¿æŸ»ã®çµæœã€é•åã®äº‹å®Ÿã‚’èªå®šã€‚åŒæ ¡ã¯äº‹æ…‹ã‚’é‡ãå—ã‘æ­¢ã‚ã€ä»Šå¤§ä¼šã®æ®‹ã‚Šè©¦åˆã‚’è¾é€€ã™ã‚‹ã“ã¨ã‚’ç™ºè¡¨ã—ãŸã€‚`,
                applyEffect: (teamName, state) => {
        if (state.teamRecords[teamName]) {
            state.teamRecords[teamName].penalty = 'forfeit';
        }

        const currentMatch = findCurrentMatchForTeam(teamName, state);
        if (!currentMatch) return; // è©²å½“ã™ã‚‹è©¦åˆãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

        const opponent = currentMatch.team1 === teamName ? currentMatch.team2 : currentMatch.team1;

        // ç›¸æ‰‹ãŒã„ãªã„å ´åˆï¼ˆã‚·ãƒ¼ãƒ‰ãªã©ï¼‰ã¯ã€å˜ã«è² ã‘æ‰±ã„ã«ã™ã‚‹
        if (!opponent) {
            currentMatch.winner = `(ä¸æˆ¦æ•—)`;
            currentMatch.team1 = teamName;
            currentMatch.team2 = null;
            return;
        }

        // ä¸æˆ¦å‹ã¨ã—ã¦è©¦åˆçµæœã‚’è¨˜éŒ²
        currentMatch.winner = opponent;
        currentMatch.summary = `${teamName}ã®ä¸ç¥¥äº‹ã«ã‚ˆã‚‹ä¸æˆ¦å‹`;

        if (currentMatch.team1 === opponent) {
            currentMatch.score1 = 'W'; // Win
            currentMatch.score2 = 'L'; // Lose
        } else {
            currentMatch.score1 = 'L';
            currentMatch.score2 = 'W';
        }

        // ãƒãƒ¼ãƒ è¨˜éŒ²ã‚’æ›´æ–°
        if(state.teamRecords[opponent]) state.teamRecords[opponent].wins++;
        if(state.teamRecords[teamName]) state.teamRecords[teamName].losses++;
        
        // å‹è€…ã‚’æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸è‡ªå‹•ã§é€²ã‚ã‚‹
        advanceWinnerToNextRound(currentMatch, opponent, state);
    }
            },
            ignore: {
                outcomeTitle: (teamName) => `${teamName}ã®ç·´ç¿’å•é¡Œã€é«˜é‡é€£ã¯ã€Œäº‹å®Ÿç¢ºèªã§ããšã€`,
                outcomeBody: (teamName) => `å…ˆæ—¥ã€ä¸€éƒ¨é€±åˆŠèªŒã§å ±ã˜ã‚‰ã‚ŒãŸ${teamName}ã®ç·´ç¿’æ™‚é–“ã«é–¢ã™ã‚‹ç–‘æƒ‘ã«å¯¾ã—ã€é«˜é‡é€£ã¯ã€Œç¾æ™‚ç‚¹ã§é•åã®äº‹å®Ÿã¯ç¢ºèªã§ããªã‹ã£ãŸã€ã¨ç™ºè¡¨ã€‚å™‚ã¯å™‚ã®ã¾ã¾ã€çƒå…ãŸã¡ã®å¤ã¯ç¶šãã€‚`,
                applyEffect: (teamName, state) => { /* ä½•ã‚‚ã—ãªã„ */ }
            }
        }
    }
];
// â–²â–²â–² ã“ã“ã¾ã§ç½®ãæ›ãˆ â–²â–²â–²
    // --- DOM Elements ---
    const setupEl = document.getElementById('setup');
    const tournamentDisplayEl = document.getElementById('tournament-display');
    const teamsTextarea = document.getElementById('teams-list');
    const generateBtn = document.getElementById('generate-btn');
    const resumeBtn = document.getElementById('resume-btn');
    const resetBtn = document.getElementById('reset-btn');
    const nextTournamentBtn = document.getElementById('next-tournament-btn');
    const saveBtn = document.getElementById('save-btn');
    const mainBracketContainer = document.getElementById('main-bracket-container');
    const mainBracketWrapper = document.getElementById('main-bracket-wrapper');
    const newsContainer = document.getElementById('news-articles');
    const bbsCommentsContainer = document.getElementById('bbs-comments');
    const daiyaBbsSection = document.getElementById('daiya-bbs-section');
    const daiyaBbsCommentsContainer = document.getElementById('daiya-bbs-comments');
    const namcoNewsSection = document.getElementById('namco-news-section');
    const namcoNewsContent = document.getElementById('namco-news-content');
    const tournamentYearDisplay = document.getElementById('tournament-year-display');

    let skipR1Btn = document.getElementById('skip-r1-btn');
    let skipR2Btn = document.getElementById('skip-r2-btn');
    let skipR3Btn = document.getElementById('skip-r3-btn');
    let skipR4Btn = document.getElementById('skip-r4-btn');
    let skipR5Btn = document.getElementById('skip-r5-btn');
    let skipR6Btn = document.getElementById('skip-r6-btn'); // â˜… æ–°è¦è¿½åŠ 
    let skipFinalBtn = document.getElementById('skip-final-btn');
    let generateSummaryBtn = document.getElementById('generate-summary-btn');
    let skipLoader = document.getElementById('skip-loader');

    // Autumn Tournament UI
    const autumnRegionalContainer = document.getElementById('autumn-regional-blocks-container');
    const autumnRankingContainer = document.getElementById('autumn-ranking-playoffs-container');
    const autumnControls = document.getElementById('autumn-controls');
    const startRankingPlayoffsBtn = document.getElementById('start-ranking-playoffs-btn');
    const startMainTournamentBtn = document.getElementById('start-main-tournament-btn');
// â–¼â–¼â–¼ ã“ã“ã‹ã‚‰3è¡Œè¿½åŠ  â–¼â–¼â–¼
const skipAutumnBlocksBtn = document.getElementById('skip-autumn-blocks-btn');
const skipAutumnRankingBtn = document.getElementById('skip-autumn-ranking-btn');
const skipAutumnMainBtn = document.getElementById('skip-autumn-main-btn');
// â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–²
// â–¼â–¼â–¼ ã“ã“ã‹ã‚‰3è¡Œè¿½åŠ  â–¼â–¼â–¼
const skipSpringQualifiersBtn = document.getElementById('skip-spring-qualifiers-btn');
const skipSpringRound1Btn = document.getElementById('skip-spring-round1-btn');
const skipSpringMainBtn = document.getElementById('skip-spring-main-btn');
// â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–²
    // Modals
    const newsModal = document.getElementById('news-modal');
    const modalBg = document.getElementById('modal-bg');
    const modalClose = document.getElementById('modal-close');
    const confirmModal = document.getElementById('confirm-modal');
    const detailsModal = document.getElementById('details-modal');
    const saveLoadModal = document.getElementById('save-load-modal');
    const saveTabBtn = document.getElementById('save-tab-btn');
    const loadTabBtn = document.getElementById('load-tab-btn');
    const saveTabContent = document.getElementById('save-tab-content');
    const loadTabContent = document.getElementById('load-tab-content');
    const generateSaveCodeBtn = document.getElementById('generate-save-code-btn');
    const loadFromCodeBtn = document.getElementById('load-from-code-btn');
    const saveLoadCloseBtn = document.getElementById('save-load-close');
    const copySaveCodeBtn = document.getElementById('copy-save-code-btn');
    const newspaperModal = document.getElementById('newspaper-modal');
    const newspaperModalBody = document.getElementById('newspaper-modal-body');
    const newspaperCloseBtn = document.getElementById('newspaper-close');

    
    // --- State Management ---
    let tournamentState = {};
    let currentMatchIdForDetails = null;
    let articleForRegeneration = null; 
    let soundEffects = {};
let currentBlock = 'A';
let activeAnalysisMode = 'CONTRIBUTION';

    const UNDERDOG_TEAMS = ["è™åºœå³¶ç·åˆ", "æµœæ¾ç‰¹æ”¯", "å·æ ¹", "ä¼Šè±†ç·åˆ", "æ¹–è¥¿", "æ–°å±…", "ç†±æµ·", "ä¼Šè±†ä¸­å¤®", "å³¶ç”°", "å³¶ç”°å·¥æ¥­", "è£¾é‡"];
    const POWERHOUSE_TEAMS = ["283å­¦åœ’", "å¸¸è‘‰èŠå·", "é™å²¡", "æ›å·è¥¿", "é™å²¡å•†æ¥­", "è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼", "765ç·åˆé«˜æ ¡"];
ã€€ã€€const POWERHOUSE_REVIVAL_TEAMS = ["æµœæ¾å•†æ¥­", "é™æ¸…", "é£›é¾"];
ã€€ã€€const ONE_MAN_TEAMS = ["å¯Œå£«å®®åŒ—"];

// â–¼â–¼â–¼ ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã€æ—¢å­˜ã®SoundManagerã‚’å®Œå…¨ã«ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
// â–¼â–¼â–¼ ã‚µã‚¦ãƒ³ãƒ‰ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  â–¼â–¼â–¼
// â–¼â–¼â–¼ ã‚µã‚¦ãƒ³ãƒ‰ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œãƒ»æœ€çµ‚å®Œæˆç‰ˆï¼‰â–¼â–¼â–¼
// â–¼â–¼â–¼ BGMç®¡ç†ã«ç‰¹åŒ–ã—ãŸæ–°ã—ã„ã‚µã‚¦ãƒ³ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ â–¼â–¼â–¼
// â–¼â–¼â–¼ BGMã®éŸ³é‡èª¿æ•´æ©Ÿèƒ½ä»˜ãã‚µã‚¦ãƒ³ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ â–¼â–¼â–¼
const SoundManager = {
    bgm: null,
    isReady: false,
    volume: 0.07, // BGMã®éŸ³é‡ã‚’è¨­å®š (0.0ãŒãƒŸãƒ¥ãƒ¼ãƒˆ, 1.0ãŒæœ€å¤§)

    init() {
        this.bgm = document.getElementById('lottery-bgm');
        
        const unlockAudio = () => {
            if (!this.isReady && this.bgm) {
                this.isReady = true;
                this.bgm.volume = this.volume; // åˆæœŸéŸ³é‡ã‚’è¨­å®š
                this.bgm.play().catch(e => console.error("BGM unlock failed:", e));
                this.bgm.pause();
                console.log("BGM ready.");
            }
            document.body.removeEventListener('click', unlockAudio);
        };
        
        document.body.addEventListener('click', unlockAudio, { once: true });
    },

    startBgm() {
        if (this.isReady && this.bgm) {
            this.bgm.volume = this.volume; // å†ç”Ÿå‰ã«éŸ³é‡ã‚’è¨­å®š
            this.bgm.currentTime = 0;
            this.bgm.play().catch(e => console.error("BGM play failed:", e));
        }
    },

    stopBgm() {
        if (this.bgm) {
            this.bgm.pause();
            this.bgm.currentTime = 0;
        }
    }
};
// â–²â–²â–²
// â–²â–²â–²
// â–²â–²â–² â–²â–²â–²
// â–²â–²â–²

    // â–¼â–¼â–¼ 100ç¨®é¡ã®æ—¥æœ¬ã®è‹—å­—ãƒªã‚¹ãƒˆ â–¼â–¼â–¼
const JAPANESE_SURNAMES = [
    "ä½è—¤", "éˆ´æœ¨", "é«˜æ©‹", "ç”°ä¸­", "ä¼Šè—¤", "æ¸¡è¾º", "å±±æœ¬", "ä¸­æ‘", "å°æ—", "åŠ è—¤",
    "å‰ç”°", "å±±ç”°", "ä½ã€…æœ¨", "å±±å£", "æ¾æœ¬", "äº•ä¸Š", "æœ¨æ‘", "æ—", "æ–è—¤", "æ¸…æ°´",
    "å±±å´", "æ£®", "æ± ç”°", "æ©‹æœ¬", "é˜¿éƒ¨", "çŸ³å·", "å±±ä¸‹", "ä¸­å³¶", "çŸ³äº•", "å°å·",
    "å‰ç”°", "å²¡ç”°", "é•·è°·å·", "è—¤ç”°", "å¾Œè—¤", "æ‘ä¸Š", "è¿‘è—¤", "å‚æœ¬", "é è—¤", "é’æœ¨",
    "è—¤äº•", "è¥¿æ‘", "ä¸‰æµ¦", "å²¡æœ¬", "æ¾ç”°", "ä¸­å·", "ä¸­é‡", "åŸç”°", "å°é‡", "ç”°æ‘",
    "ç«¹å†…", "é‡‘å­", "å’Œç”°", "ä¸­å±±", "çŸ³ç”°", "ä¸Šç”°", "æ£®ç”°", "åŸ", "æŸ´ç”°", "é…’äº•",
    "å·¥è—¤", "æ¨ªå±±", "å®®å´", "å®®æœ¬", "å†…ç”°", "é«˜æœ¨", "å®‰è—¤", "è°·å£", "å¤§é‡", "ä¸¸å±±",
    "ä»Šäº•", "é«˜ç”°", "è—¤åŸ", "æ­¦ç”°", "æ¾äº•", "æ‰å±±", "æ‘ç”°", "å¤§å¡š", "åƒè‘‰", "å²©å´",
    "æ¡œäº•", "é‡å£", "æ¾å°¾", "èŠåœ°", "é‡æ‘", "æ–°äº•", "æ¸¡éƒ¨", "ä½é‡", "å®‰ç”°", "å®®ç”°",
    "å°å³¶", "å¤§è¥¿", "æ‰æœ¬", "å¸‚å·", "å¤å·", "ä¹…ä¿", "å·å´", "é£¯ç”°", "ä¸­ç”°", "å €"
];

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã€Œæ–°è¦è¿½åŠ ã€(11984è¡Œç›®ã‚ãŸã‚Š) â–¼â–¼â–¼
const FACILITY_DATA = {
    "ground": {
        title: "ãƒ¡ã‚¤ãƒ³ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰",
        text: "ç”²å­åœ’ã¨åŒã˜é»’åœŸã¨å¤©ç„¶èŠã‚’ä½¿ç”¨ã€‚ä¸¡ç¿¼100mã€ã‚»ãƒ³ã‚¿ãƒ¼122mã®åºƒã•ã‚’èª‡ã‚Šã€ãƒŠã‚¤ã‚¿ãƒ¼è¨­å‚™ã‚‚å®Œå‚™ã—ã¦ã„ã¾ã™ã€‚",
        imgSrc: "https://images.unsplash.com/photo-1515512210878-38904790e8c7?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=1080"
    },
    "dome": {
        title: "å±‹å†…ç·´ç¿’å ´ã€ŒTSUBASA DOMEã€",
        text: "å¤©å€™ã«å·¦å³ã•ã‚Œãªã„å…¨å¤©å€™å‹ãƒ‰ãƒ¼ãƒ ã€‚ãƒ–ãƒ«ãƒšãƒ³4ç®‡æ‰€ã€ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°3ç®‡æ‰€ã‚’å®Œå‚™ã—ã€é›¨ã®æ—¥ã§ã‚‚å®Ÿæˆ¦çš„ãªç·´ç¿’ãŒå¯èƒ½ã§ã™ã€‚",
        imgSrc: "https://images.unsplash.com/photo-1578899653835-34a162d355e0?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=1080"
    },
    "data-lab": {
        title: "ãƒ‡ãƒ¼ã‚¿è§£æå®¤",
        text: "å¤©äº•ç›£ç£ã®IDé‡çƒã®å¿ƒè‡“éƒ¨ã€‚å…¨é¸æ‰‹ã®æŠ•çƒãƒ»æ‰“æ’ƒãƒ•ã‚©ãƒ¼ãƒ ã‚’å¸¸æ™‚ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã—ã€AIã«ã‚ˆã‚‹åˆ†æãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡Œã‚ã‚Œã¾ã™ã€‚",
        imgSrc: "https://images.unsplash.com/photo-1551288049-bebda4e38f71?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=1080"
    }
};

// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨ã€Œæ–°è¦è¿½åŠ ã€(1191è¡Œç›®ã‚ãŸã‚Šã€JAPANESE_SURNAMES ã®ä¸‹ãªã©) â–¼â–¼â–¼
const TEAM_ROSTER_MASTER = {
    "283å­¦åœ’": [
        // --- ã‚¹ã‚¿ãƒ¡ãƒ³ (æŒ‡å®šã‚ªãƒ¼ãƒ€ãƒ¼é †) ---
{ number: "8", name: "åç‹", grade: 3, position: "ä¸­å …æ‰‹", throwBat: "L/L", height: 176, weight: 70, origin: "åå¤å±‹ãƒ‰ãƒªãƒ¼ãƒ ã‚¹", desc: "1ç•ªã‚»ãƒ³ã‚¿ãƒ¼ã€‚å“è¶Šã—ãŸå®ˆå‚™ã‚»ãƒ³ã‚¹ã«åŠ ãˆã€ã¤ãªãã®æ‰“æ’ƒã‚‚ã“ãªã™å™¨ç”¨ãªé¸æ‰‹ã€‚æŠ•æ‰‹ã¨ã—ã¦ãƒã‚¦ãƒ³ãƒ‰ã«ä¸ŠãŒã‚‹ã“ã¨ã‚‚ã‚ã‚‹ãƒãƒ¼ãƒ ã®ç²¾ç¥çš„æ”¯æŸ±ã€‚", isCaptain: false },        
 { number: "6", name: "èŠ±æµ·ä½‘", grade: 1, position: "ä¸­å …æ‰‹", throwBat: "R/R", height: 177, weight: 73, origin: "åŒ—æµ·é“ã‚·ãƒ‹ã‚¢", desc: "2ç•ªã‚·ãƒ§ãƒ¼ãƒˆã€‚1å¹´ç”ŸãªãŒã‚‰ä¸Šä½æ‰“ç·šã‚’ä»»ã•ã‚Œã‚‹æ€ªç‰©ã€‚èº«ä½“èƒ½åŠ›ã®é«˜ã•ã¯ãƒãƒ¼ãƒ ï¼‘ã€‚", isCaptain: false },
        { number: "7", name: "æµ…å€‰", grade: 2, position: "å·¦ç¿¼æ‰‹", throwBat: "R/R", height: 168, weight: 64, origin: "é•·å´ã‚·ãƒ‹ã‚¢", desc: "3ç•ªãƒ¬ãƒ•ãƒˆã€‚é«˜ã„èº«ä½“èƒ½åŠ›ã¨ä¿Šè¶³ã‚’ç”Ÿã‹ã—ã€æ‰“ç·šã‚’ç¹‹ãä»•äº‹äººã€‚", isCaptain: false },
        { number: "9", name: "èŠ±æµ·å’²", grade: 3, position: "å³ç¿¼æ‰‹", throwBat: "L/L", height: 178, weight: 75, origin: "åŒ—æµ·é“ã‚·ãƒ‹ã‚¢", desc: "4ç•ªãƒ©ã‚¤ãƒˆã€‚ä¸»å°†ã¨ã—ã¦ãƒãƒ¼ãƒ ã‚’æ”¯ãˆã‚‹ã€‚é•·æ‰“åŠ›ã‚‚ã‚ã‚Šã€ãƒãƒ£ãƒ³ã‚¹ãƒ¡ã‚¤ã‚¯ã‚‚é‚„ã™å½¹å‰²ã‚‚ã“ãªã™ã€‚æŠ•æ‰‹ã¨ã—ã¦ãƒã‚¦ãƒ³ãƒ‰ã«ä¸ŠãŒã‚‹ã“ã¨ã‚‚ã‚ã‚‹å¤§é»’æŸ±ã§ã‚ã‚‹ã€‚", isCaptain: true },
        { number: "5", name: "æ¨‹å£", grade: 3, position: "ä¸‰å¡æ‰‹", throwBat: "R/R", height: 170, weight: 68, origin: "é™å²¡è‘µä¸­å­¦", desc: "5ç•ªã‚µãƒ¼ãƒ‰ã€‚å‹è² å¼·ã•ã¯ãƒãƒ¼ãƒ éšä¸€ã€‚å¾—ç‚¹åœã§ç„¡é¡ã®å¼·ã•ã‚’ç™ºæ®ã™ã‚‹ã‚¯ãƒ©ãƒƒãƒãƒ’ãƒƒã‚¿ãƒ¼ã€‚" },
        { number: "13", name: "æ¡‘å±±", grade: 3, position: "ä¸€å¡æ‰‹", throwBat: "R/R", height: 163, weight: 65, origin: "å±±å£", desc: "6ç•ªãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã€‚ãƒ‘ãƒ³ãƒåŠ›ã®ã‚ã‚‹æ‰“æ’ƒãŒé­…åŠ›ã®é•·è·é›¢ç ²ã€‚ä¸€ç™ºã§è©¦åˆã®æµã‚Œã‚’å¤‰ãˆã‚‹ã€‚", isCaptain: false },
        { number: "3", name: "å§«å·", grade: 3, position: "æŠ•æ‰‹", throwBat: "R/R", height: 182, weight: 80, origin: "å¤§é˜ªã‚·ãƒ‹ã‚¢", desc: "7ç•ªãƒ”ãƒƒãƒãƒ£ãƒ¼ã€‚ã‚¨ãƒ¼ã‚¹ã¨ã—ã¦ãƒã‚¦ãƒ³ãƒ‰ã‚’å®ˆã‚ŠãªãŒã‚‰ã€æ‰“å¸­ã§ã‚‚ä¸€ç™ºã‚’ç‹™ã†äºŒåˆ€æµã€‚", isCaptain: false },
        { number: "4", name: "æ«»æœ¨", grade: 2, position: "äºŒå¡æ‰‹", throwBat: "R/R", height: 168, weight: 62, origin: "æ±äº¬", desc: "8ç•ªã‚»ã‚«ãƒ³ãƒ‰ã€‚åºƒè§’ã«æ‰“ã¡åˆ†ã‘ã‚‹ãƒãƒƒãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¨è»½å¿«ãªå®ˆå‚™ã§ãƒãƒ¼ãƒ ã‚’ç‰½å¼•ã™ã‚‹åˆ‡ã‚Šè¾¼ã¿éšŠé•·ã€‚", isCaptain: false },
       { number: "2", name: "æœ‰æ –å·", grade: 3, position: "æ•æ‰‹", throwBat: "R/L", height: 178, weight: 78, origin: "ç¥å¥ˆå·ãƒœãƒ¼ã‚¤ã‚º", desc: "9ç•ªã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼ã€‚å¼·æ‰“ã®æ•æ‰‹ã¨ã—ã¦ä¸‹ä½æ‰“ç·šã®æ ¸ã¨ãªã‚‹ã€‚ãƒªãƒ¼ãƒ‰é¢ã§ã‚‚æŠ•æ‰‹é™£ã‚’æ”¯ãˆã‚‹ã€‚", isCaptain: false },
        
        // --- æ§ãˆé¸æ‰‹ (å¤‰æ›´ãªã—) ---
        { number: "1", name: "ç™½ç€¬", grade: 3, position: "æŠ•æ‰‹", throwBat: "R/R", height: 184, weight: 82, origin: "æ±äº¬ã‚·ãƒ‹ã‚¢" },
        { number: "10", name: "é»›", grade: 3, position: "æŠ•æ‰‹", throwBat: "R/R", height: 180, weight: 76, origin: "å¯Œå£«ã‚·ãƒ‹ã‚¢" },
        { number: "11", name: "å¸‚å·", grade: 2, position: "æŠ•æ‰‹", throwBat: "L/L", height: 179, weight: 74, origin: "é™å²¡è’²åŸä¸­å­¦" },
        { number: "12", name: "å°å®®", grade: 1, position: "æ•æ‰‹", throwBat: "R/R", height: 172, weight: 70, origin: "åŸ¼ç‰ã‚·ãƒ‹ã‚¢" },
        { number: "14", name: "éˆ´æœ¨", grade: 2, position: "å†…é‡æ‰‹", throwBat: "R/L", height: 181, weight: 85, origin: "æ„›çŸ¥ãƒœãƒ¼ã‚¤ã‚º" },
        { number: "15", name: "å…«å®®", grade: 2, position: "å†…é‡æ‰‹", throwBat: "R/R", height: 175, weight: 72, origin: "æµœæ¾ãƒœãƒ¼ã‚¤ã‚º" },
        { number: "16", name: "èŠ¹æ²¢", grade: 2, position: "å¤–é‡æ‰‹", throwBat: "R/S", height: 172, weight: 69, origin: "æ²¼æ´¥ã‚·ãƒ‹ã‚¢" },
        { number: "17", name: "å¤§å´", grade: 1, position: "å¤–é‡æ‰‹", throwBat: "R/L", height: 170, weight: 68, origin: "ä¸‰å³¶ãƒªãƒˆãƒ«ã‚·ãƒ‹ã‚¢" },
        { number: "18", name: "è¥¿åŸ", grade: 2, position: "æŠ•æ‰‹", throwBat: "R/R", height: 183, weight: 81, origin: "åºƒå³¶ãƒœãƒ¼ã‚¤ã‚º" },
        { number: "19", name: "é¢¨é‡", grade: 2, position: "å†…é‡æ‰‹", throwBat: "R/R", height: 169, weight: 65, origin: "æ–°æ½Ÿã‚·ãƒ‹ã‚¢" },
        { number: "20", name: "æœé‡", grade: 1, position: "å¤–é‡æ‰‹", throwBat: "L/L", height: 171, weight: 67, origin: "å®®åŸã‚·ãƒ‹ã‚¢" }
    ]
};
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
// â–¼â–¼â–¼ ã‚µã‚¦ãƒ³ãƒ‰ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  â–¼â–¼â–¼

// â–²â–²â–²

// --- Team Master Data ---
    const TEAM_DATA = {
    "å¤©ç«œ": {
        name_yomi: "ã¦ã‚“ã‚Šã‚…ã†",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 38,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "å‰µéƒ¨3å¹´ç›®ã«ã—ã¦ãƒ™ã‚¹ãƒˆ16å…¥ã‚Šã‚’æœãŸã—ãŸæœŸå¾…ã®æ–°èˆˆå‹¢åŠ›ã€‚æ–°ä»»ã®å¿—è³€ç›£ç£ã®ä¸‹ã€æŒ‘æˆ¦è€…ã¨ã—ã¦ã®ã³ã®ã³ã¨ãƒ—ãƒ¬ãƒ¼ã—ãŸæ˜¨å¹´ã¨ã¯ä¸€è»¢ã€ä»Šå¹´ã¯ä»–æ ¡ã‹ã‚‰ã®ãƒãƒ¼ã‚¯ã‚‚å³ã—ããªã‚‹ã€‚æ˜¨å¹´ã®èºé€²ãŒãƒ•ãƒ­ãƒƒã‚¯ã§ãªã‹ã£ãŸã“ã¨ã‚’è¨¼æ˜ã§ãã‚‹ã‹ã€çœŸä¾¡ãŒå•ã‚ã‚Œã‚‹å¤ã¨ãªã‚‹ã€‚è¥¿éƒ¨åœ°åŸŸã®å­¦æ ¡ã‹ã‚‰ã®ç”²å­åœ’ã§ã®æˆç¸¾ãŒä¹ã—ã„ãŸã‚ã€çªå¦‚ç¾ã‚ŒãŸå½—æ˜Ÿã«æœŸå¾…ã®å£°ã‚‚å¤šã„ã€‚ã‚¨ãƒ¼ã‚¹ã®ä¸‰æ©‹ã‚„ãƒªãƒ¼ãƒ‰ã‚ªãƒ•ãƒãƒ³ã®ç”°å³¶ã‚’ç­†é ­ã«éƒ¨å“¡æ•°ã¯å°‘ãªã„ãªãŒã‚‰ã‚‚åŠ›ã®ã‚ã‚‹é¸æ‰‹ã‚‚å¤šã„ã€‚ãƒãƒ¼ãƒ ã¨ã—ã¦ã®ç›®æ¨™ã¯æ˜¨å¹´ã‚’è¶…ãˆã‚‹ãƒ™ã‚¹ãƒˆ8ã§ã¯ãªãç”²å­åœ’å‡ºå ´ã€‚è¥¿éƒ¨åœ°åŸŸã®é›„ã¨ãªã‚‹ãŸã‚ã«ã€ã¾ãšã¯ä»Šå¹´ã€ã©ã“ã¾ã§ä¸Šä½å‹¢ã«é£Ÿã‚‰ã„ã¤ã‘ã‚‹ã‹ãŒæ­£å¿µå ´ã§ã‚ã‚‹ã€‚ã€‚",
        coach: { name: 'å¿—è³€ å‰›', style: 'è‚²æˆä¸Šæ‰‹', experience: 'æ–°ä»»' }
    },
    "æ¡é™½": {
        name_yomi: "ã¨ã†ã‚ˆã†",
        region: "æ±éƒ¨",
        type: "ç§ç«‹",
        deviation: 80,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        last: "åˆæˆ¦æ•—é€€",
        info: "å…ƒãƒ—ãƒ­ã®å…ƒæœ¨ç›£ç£ã‚’æ‹›è˜ã—ã€å¼·åŒ–ã«ä¹—ã‚Šå‡ºã—ãŸæ–°èˆˆç§ç«‹ã€‚ãƒ—ãƒ­æµã®å³ã—ã„ç·´ç¿’ã¯ãƒãƒ¼ãƒ å†…ã«è»‹è½¢ã‚‚ç”Ÿã‚“ã§ã„ã‚‹ãŒã€å€‹ã€…ã®èƒ½åŠ›ã¯é£›èºçš„ã«å‘ä¸Šã—ã¦ãŠã‚Šã€140kmä»¥ä¸Šã‚’è¨ˆæ¸¬ã™ã‚‹é¸æ‰‹ãŒ6äººã‚‚ã„ã‚‹ãªã©ã€ãã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã¯è¨ˆã‚ŠçŸ¥ã‚Œãªã„ã€‚ç›£ç£ã®æŒ‡å°æ–¹é‡ãŒãƒãƒ¼ãƒ ã¨ã—ã¦å®Œå…¨ã«å™›ã¿åˆã£ãŸæ™‚ã€ä¸€æ°—ã«å¤§ä¼šã®ä¸»å½¹ã¸èºã‚Šå‡ºã‚‹å¯èƒ½æ€§ã‚’ç§˜ã‚ã¦ã„ã‚‹ã€‚",
        coach: { name: 'å…ƒæœ¨ å¤§ä»‹', style: 'ç©æ¥µæ‰“æ’ƒ', experience: 'ãƒ—ãƒ­OB' }
    },
    "æµœæ¾å•†æ¥­": {
        name_yomi: "ã¯ã¾ã¾ã¤ã—ã‚‡ã†ãã‚‡ã†",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 2,
        best: "ç”²å­åœ’å„ªå‹",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "30å¹´å‰ã®ç”²å­åœ’å„ªå‹æ ¡ã¨ã—ã¦é‡çƒãƒ•ã‚¡ãƒ³ã®é–“ã§ã¯çŸ¥ååº¦ã®ã‚ã‚‹é«˜æ ¡ã€‚è¿‘å¹´ã¯ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã‚„æ–°èˆˆç§ç«‹ã®å°é ­ã«ã‚ˆã‚Šä½è¿·ã—ã¦ãŠã‚Šã€æ˜”ã®ã‚ˆã†ãªåœ§å€’çš„ãªå¼·ã•ã¯ãªã„ãŒã€ä»Šã‚‚ãªãŠä¸­å …ãƒ¬ãƒ™ãƒ«ã®å®ŸåŠ›æ ¡ã¨ã—ã¦è™è¦–çœˆã€…ã¨è–åœ°ã‚’ç‹™ã£ã¦ã„ã‚‹ã€‚è¼ã‹ã—ã„æ „å…‰ã‚’å–ã‚Šæˆ»ã™ã¹ãã€ä»Šå¤§ä¼šã§ã®èºé€²ã«æœŸå¾…ã—ãŸã„ã„ã€‚",
        coach: { name: 'ä¼Šæ­¦ é›…ä¹‹', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "åˆæ˜Ÿå­¦åœ’": {
        name_yomi: "ã¯ã¤ã¼ã—ãŒããˆã‚“",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 110,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "å…¨å›½ã§å”¯ä¸€ã‚¢ã‚¤ãƒ‰ãƒ«ç§‘ã‚’æŒã¤å­¦æ ¡ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã¦ã„ã‚‹å‰µç«‹3å¹´ç›®ã®ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ç³»åˆ—æ ¡ã€‚å…¨å›½ã‹ã‚‰ã‚¢ã‚¤ãƒ‰ãƒ«ç§‘ã‚’ç›®å½“ã¦ã«å—é¨“ã™ã‚‹äººã‚‚å¤šãã€å­¦æ ¡ã¨ã—ã¦ã®æ³¨ç›®åº¦ã‚‚é«˜ã„ã€‚ç”·å¥³æ¯”ã§ã¯å­¦æ ¡ã®ç‰¹è‰²ã‚‚ç›¸ã¾ã£ã¦é©šç•°ã®8å‰²ãŒå¥³å­ã§ã‚ã‚‹ã€‚å‰µéƒ¨3å¹´ç›®ã®é‡çƒéƒ¨ã¨ã—ã¦ã®è¨­å‚™ã¯ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ç³»åˆ—ã¨ã„ã†ã“ã¨ã‚‚ã‚ã‚Šæ•´ã£ã¦ãŠã‚Šã€ç›´è¿‘ã®ç·´ç¿’è©¦åˆã§ã¯ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³ã‚‚è¤‡æ•°é£›ã³å‡ºã™ãªã©ã€é¸æ‰‹ã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚‚ä½ãã¯ãªã„ã€‚ç·´ç¿’ã§ã¯ã‚¢ã‚¤ãƒ‰ãƒ«ç§‘ã®ç”Ÿå¾’ã¨ã®åˆåŒãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’çµ„ã‚€ã“ã¨ã‚‚ã‚ã‚Šã€é•ã†å­¦ç§‘ã§ã‚ã‚Œã©ã€ãŠäº’ã„ã‚¢ã‚¹ãƒªãƒ¼ãƒˆã®è¦–ç‚¹ã§ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’é€ã‚Šã‚ã†ãªã©å­¦æ ¡ã®ç‰¹è‰²ã‚’æ´»ã‹ã—ãŸç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚‚ã‚ã‚‹ã€‚é‡çƒéƒ¨ã§ç›®ç«‹ã£ãŸå®Ÿç¸¾ã¯ãªã„ãŒã€ã‚¢ã‚¤ãƒ‰ãƒ«ç§‘ã§ã¯ãªãã€Œé‡çƒã®åˆæ˜Ÿã€ã¨å‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«èºé€²ã—ã¦ã»ã—ã„",
        coach: { name: 'çŸ³å· å®Ÿ', style: 'è‚²æˆä¸Šæ‰‹', experience: 'ä¸­å …' }
    },
    "æµœæ¾ç‰¹æ”¯": {
        name_yomi: "ã¯ã¾ã¾ã¤ã¨ãã—",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 45,
        best: "ãªã—",
        last: "ãªã—",
        info: "å‰µéƒ¨ä¸€å¹´ç›®ã€å…¨å“¡1å¹´ç”Ÿã€‚çœŒå†…åˆã®è©¦ã¿ã¨ã—ã¦ã€ç‰¹åˆ¥æ”¯æ´å­¦æ ¡ã«è¨­ç«‹ã•ã‚ŒãŸé‡çƒéƒ¨ã€‚è¦–è¦šéšœå®³ã€è´è¦šéšœå®³ã€çŸ¥çš„éšœå®³ã€è‚¢ä½“ä¸è‡ªç”±ã€ç—…å¼±ãƒ»èº«ä½“è™šå¼±ã®å­ã©ã‚‚ã‚’å¯¾è±¡ã¨ã—ãŸç‰¹åˆ¥æ”¯æ´å­¦æ ¡ã¯ã€å…¨å›½ã«ãŠã‚ˆã1100æ ¡ã‚ã‚‹ã€‚ãã®ä¸­ã§é«˜é‡é€£ã«åŠ ç›Ÿã—ã€å˜ç‹¬ãƒãƒ¼ãƒ ã¨ã—ã¦å…¬å¼æˆ¦ã«å‡ºå ´ã—ã¦ã„ã‚‹ã®ã¯ã€ã“ã®æµœæ¾ç‰¹åˆ¥æ”¯æ´å­¦æ ¡ã ã‘ã ã€‚éƒ¨å“¡ãŸã¡ã¯ã€é‡çƒã®ãƒ«ãƒ¼ãƒ«ã‚’è¦šãˆã‚‹ã“ã¨ã‚„ã€ä»²é–“ã¨å£°ã‚’æ›ã‘åˆã†ã“ã¨ã€ãã®ä¸€ã¤ä¸€ã¤ãŒå¤§ããªæŒ‘æˆ¦ã ã€‚åŒ—æ‘ç›£ç£ã¯ã€é‡çƒã®æŠ€è¡“ä»¥å‰ã«ã€å½¼ã‚‰ãŒé‡çƒã¨ã„ã†ã‚¹ãƒãƒ¼ãƒ„ã‚’å¿ƒã‹ã‚‰æ¥½ã—ã¿ã€è‡ªåˆ†ã‚’è¡¨ç¾ã™ã‚‹å–œã³ã‚’çŸ¥ã£ã¦ã‚‚ã‚‰ã†ã«ã¯ã©ã†ã™ã‚Œã°è‰¯ã„ã®ã‹ã€ç­”ãˆã®ãªã„å•ã„ã«æ—¥ã€…å‘ãåˆã£ã¦ã„ã‚‹ã€‚ã—ã‹ã—ã€æ˜¥ã®ç·´ç¿’è©¦åˆã§ä»Šå¤§ä¼šç¬¬ä¸€ã‚·ãƒ¼ãƒ‰ã®283å­¦åœ’ã¨ã®æ‹›å¾…è©¦åˆã§å–«ã—ãŸã€52-0ã€ã®å¤§æ•—ã¯ã€å½¼ã‚‰ã‹ã‚‰é‡çƒã®æ¥½ã—ã•ã‚’æ ¹ã“ããå¥ªã„å»ã£ãŸã€‚éƒ¨å®¤ä»£ã‚ã‚Šã®ç†ç§‘æº–å‚™å®¤ã«ã¯ã€å½¼ã‚‰ã®é‡çƒãƒãƒ¼ãƒˆãŒç½®ã‹ã‚Œã¦ãŠã‚Šã€ä¸­ã‚’è¦‹ã‚‹ã¨ã€ŒãŸã®ã—ããªã„ã€ã€Œã“ã‚ã„ã€ã¨ã„ã£ãŸæ–‡é¢ãŒå¤šãè¦‹å—ã‘ã‚‰ã‚ŒãŸã€‚ã‚¨ãƒ©ãƒ¼ã‚’ã™ã‚Œã°ä¸‹ã‚’å‘ã„ã¦æ³£ãå‡ºã—ã€æ‰“å¸­ã§ã¯ãƒ‡ãƒƒãƒ‰ãƒœãƒ¼ãƒ«ã‚’æ€–ãŒã£ã¦è…°ãŒå¼•ã‘ã‚‹ã€‚ãã—ã¦ã€ãªã«ã‚ˆã‚ŠçŸ¥çš„éšœå®³ã‚’æŒã£ãŸå­ãŒç¡¬å¼é‡çƒã‚’è¡Œã†ã“ã¨ã«ã¤ã„ã¦ã®å®‰å…¨æ€§ã‚’å•ã‚ã‚Œã‚‹å£°ãŒå¤šã€…ã‚ã£ãŸã€‚åŒ—æ‘ç›£ç£ã¯å‹åˆ©ã§ã¯ãªãã€è©¦åˆã‚’æˆç«‹ã•ã›ã‚‹ã“ã¨ã€ã®çµ¶æœ›çš„ãªé›£ã—ã•ã«ç›´é¢ã—ã¦ã„ã‚‹ã€‚å¤ã®ç›®æ¨™ã¯9å›ã‚’æˆ¦ã„æŠœãã€ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã«ã€0ã€ä»¥å¤–ã®æ•°å­—ã‚’ç¯ã™ã“ã¨ã€‚ãã‚Œã¯ç”²å­åœ’å‡ºå ´ã‚ˆã‚Šã‚‚é¥ã‹ã«é«˜ãã€ãã—ã¦åˆ‡å®Ÿãªå£ã ã€‚",
        coach: { name: 'åŒ—æ‘ å¤§è¼”', style: 'å…¨å“¡é‡çƒ', experience: 'æ–°ä»»' }
    },
    "765ç·åˆé«˜æ ¡": {
        name_yomi: "ãªã‚€ã“ãã†ã”ã†",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 95,
        best: "ç”²å­åœ’ãƒ™ã‚¹ãƒˆ16",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "å¤§æ‰‹ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ãŒæ¯ä½“ã¨ãªã‚‹ã€çœŒå†…å±ˆæŒ‡ã®è³‡é‡‘åŠ›ã¨è¨­å‚™ã‚’èª‡ã‚‹ç§ç«‹æ ¡ã€‚é»’äº•ç›£ç£ã®å¾¹åº•ã—ãŸç®¡ç†é‡çƒã®ä¸‹ã€å€‹ã€…ã®èƒ½åŠ›ãŒé«˜ãã€å¤§å´©ã‚Œã—ãªã„å®‰å®šã—ãŸæˆ¦ã„ã¶ã‚ŠãŒç‰¹å¾´ã€‚ï¼’å¹´å‰ã«ã¯ç”²å­åœ’åˆå‡ºå ´ã‚‚æœãŸã—ã€ç ´ç«¹ã®å‹¢ã„ã§ãƒ™ã‚¹ãƒˆ16ã¾ã§å‹ã¡é€²ã¿ã€ä¸€èºæœ‰åæ ¡ã¨ãªã£ãŸã®ã¯è¨˜æ†¶ã«æ–°ã—ã„ã ã‚ã†ã€‚ã—ã‹ã—æ˜¨å¹´ã®å¤ã¯ï¼’å›æˆ¦æ•—é€€ã€ç§‹ã¯åˆæˆ¦æ•—é€€ã€æ˜¥ã‚‚åˆæˆ¦æ•—é€€ã¨è‹¦ã—ã„æ™‚æœŸãŒç¶šã„ã¦ã„ã‚‹ã€‚è–åœ°ã‚’çŸ¥ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã¯ä»Šã®3å¹´ç”Ÿã®ã¿ã¨ãªã£ãŸä»Šã€é€†è¥²ã‚’èª“ã„å†ã³ç”²å­åœ’ã‚’ç›®æŒ‡ã™ã€‚ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã§ã¯ã‚ã‚‹ãŒãã®å®ŸåŠ›ã¯ã‚·ãƒ¼ãƒ‰æ ¡ç´šã§ã‚ã‚Šä»Šå¤§ä¼šã®ãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ã¨è¨€ã£ã¦ã‚‚éè¨€ã§ã¯ãªã„ã ã‚ã†",
        popularity: true,
        coach: { name: 'é»’äº• å´‡ç”·', style: 'ç·åˆåŠ›', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "å·æ ¹": {
        name_yomi: "ã‹ã‚ã­",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 53,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "åˆæˆ¦æ•—é€€",
        info: "ä»Šå¹´åº¦é™ã‚Šã§ã®é–‰æ ¡ãŒæ±ºã¾ã£ã¦ãŠã‚Šã€é‡çƒéƒ¨ã«ã¨ã£ã¦ã¯ã“ã‚ŒãŒæœ€å¾Œã®å¤ã¨ãªã‚‹ã€‚ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰è„‡ã§ã¯æ ¡èˆã®è§£ä½“ä½œæ¥­ãŒé€²ã‚€ã¨ã„ã†ç•°ä¾‹ã®ç’°å¢ƒã ãŒã€é¸æ‰‹ãŸã¡ã¯å‹•æºã‚’è¦‹ã›ãšç·´ç¿’ã«æ‰“ã¡è¾¼ã‚€ã€‚ç›£ç£ãƒ»é¸æ‰‹ã¨ã‚‚ã«å¤§ä¼šçµ‚äº†å¾Œã¯ãã‚Œãã‚Œåˆ¥ã®é“ã‚’æ­©ã‚€ã“ã¨ã«ãªã‚‹ã€‚ã€Œæ¯æ ¡ã®åã‚’åˆ»ã¿ãŸã„ã€ã¨ã„ã†æƒ³ã„ã¯ä¸€ã¤ã€‚æœ‰çµ‚ã®ç¾ã‚’é£¾ã‚‹ã¹ãã€ãƒãƒ¼ãƒ ã®å£«æ°—ã¯éå¸¸ã«é«˜ã„ã€‚",
        coach: { name: 'éˆ´æœ¨ èª ', style: 'å …å®Ÿ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "283å­¦åœ’": {
        name_yomi: "ã¤ã°ã•ãŒããˆã‚“",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 80,
        best: "ç”²å­åœ’1å›æˆ¦",
        last: "çœŒå„ªå‹(ç”²å­åœ’åˆæˆ¦æ•—é€€)",
        info: "æ˜¨å¹´åº¦ã®çœŒå¤§ä¼šç‹è€…ã€‚æ„›ç§°ã¯ã€Œãƒ„ãƒã‚¬ã‚¯ã€ã€‚ã‚¨ãƒ¼ã‚¹ç™½ç€¬ã€äºŒåˆ€æµã®å§«å·ã‚„åç‹ã€èŠ±æµ·å’²ãªã©ï¼‘å¹´æ¬¡ã‹ã‚‰ã®ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ãƒ¡ãƒ³ãƒãƒ¼ã‚’è»¸ã«æŠ•æ‰“ã®ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚ŒãŸå¼·è±ªæ ¡ã€‚ã€‚ã—ã‹ã—ã€åˆå‡ºå ´ã¨ãªã£ãŸæ˜¨å¹´ã®å¤ã®ç”²å­åœ’ã§ã¯åˆæˆ¦ã®æµ¦å’Œå­¦é™¢æˆ¦ã«7-9ã§æ•—æˆ¦ã—æ¶™ã‚’é£²ã¿ã€å…¨å›½ã®å£ã‚’ç—›æ„Ÿã—ãŸã€‚æ–°ãƒãƒ¼ãƒ ã«ãªã£ã¦ã‹ã‚‰ã¯æ¨‹å£ã‚„èŠ±æµ·ä½‘ãªã©ã®æ–°æˆ¦åŠ›ã‚‚å°é ­ã—ã€æ˜¥ã®å¤§ä¼šã§ã¯åœ§å€’çš„ãªæˆ¦ã„ã§å„ªå‹ã—ã€ç¬¬ï¼‘ã‚·ãƒ¼ãƒ‰ã«å›è‡¨ã€‚åå°†ãƒ»å¤©äº•ç›£ç£ã¯ã€æ˜¨å¹´ã®çµŒé¨“ã‚’ç³§ã«ã€çœŒå†…é€£è¦‡ã¨ãã®å…ˆã®ã€Œå…¨å›½ã§ã®ä¸€å‹ã€ã‚’è¦‹æ®ãˆã‚‹ã€‚ç‹è€…ã¨ã—ã¦ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‚’ã¯ã­ã®ã‘ã€å†ã³é ‚ç‚¹ã«ç«‹ã¦ã‚‹ã‹æ³¨ç›®ãŒé›†ã¾ã‚‹ã€‚",
        popularity: true,
        coach: { name: 'å¤©äº• åŠª', style: 'IDé‡çƒ', experience: 'åå°†' }
    },
    "å³¶ç”°å·¥æ¥­": {
        name_yomi: "ã—ã¾ã ã“ã†ãã‚‡ã†",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 41,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "çœŒå†…ã§ã‚‚æœ‰æ•°ã®å·¥æ¥­é«˜æ ¡ã§ã€éƒ¨å“¡ã®å¤šããŒæŠ€è¡“è·ã‚’ç›®æŒ‡ã—ã¦ã„ã‚‹ã€‚å®Ÿç¿’ãªã©ã§ç·´ç¿’æ™‚é–“ãŒé™ã‚‰ã‚Œã‚‹ãƒãƒ³ãƒ‡ã‚’ã€ç”°ä¸­ç›£ç£ãŒå©ãè¾¼ã‚€ã€Œæ ¹æ€§é‡çƒã€ã§ã‚«ãƒãƒ¼ã€‚æœ€å¾Œã¾ã§è«¦ã‚ãªã„ç²˜ã‚Šå¼·ã•ãŒãƒãƒ¼ãƒ ã®æŒã¡å‘³ã€‚ã‚¹ã‚¿ãƒ¼é¸æ‰‹ã¯ä¸åœ¨ã ãŒã€ä¸€ä¸¸ã¨ãªã£ãŸæ™‚ã®çµæŸåŠ›ã¯é«˜ãã€å¼·è±ªæ ¡ã«ã¨ã£ã¦ã¯ã‚„ã‚Šã«ãã„ç›¸æ‰‹ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹ã€‚ã€‚",
        coach: { name: 'ç”°ä¸­ é‰„å¹³', style: 'æ ¹æ€§é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "ç£ç”°å—": {
        name_yomi: "ã„ã‚ãŸã¿ãªã¿",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 73,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "åˆæˆ¦æ•—é€€",
        info: "å…¨å›½ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã®é€²å­¦æ ¡ã€‚é‡çƒã¯ã€Œæ–‡æ­¦ä¸¡é“ã€ã‚’æ²ã’ã‚‹èª²å¤–æ´»å‹•ã®ä¸€ç’°ã ãŒã€ãã®å®ŸåŠ›ã¯ä¾®ã‚Œãªã„ã€‚é¸æ‰‹å€‹ã€…ã®é‡çƒIQãŒé«˜ãã€ãƒ‡ãƒ¼ã‚¿ã‚’é§†ä½¿ã—ãŸç·»å¯†ãªæˆ¦è¡“ã‚’å¾—æ„ã¨ã™ã‚‹ã€‚çŸ¥æ€§æ´¾é›†å›£ãŒã€å¤ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã«æ—‹é¢¨ã‚’å·»ãèµ·ã“ã™ã€‚ä½™è«‡ã ãŒã€å…¨å›½åˆ¶è¦‡ã®çµŒé¨“ã‚’æŒã¤ã‚µãƒƒã‚«ãƒ¼éƒ¨ãŒå¿œæ´ã«é§†ã‘ã¤ã‘ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã€ãã®ç‹¬ç‰¹ã®å¿œæ´ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚åç‰©ã¨ãªã£ã¦ã„ã‚‹ã€‚ã¡ãªã¿ã«ã‚µãƒƒã‚«ãƒ¼å½¢å¼ã®é‡çƒå¿œæ´ãŒçã—ã„ã¨ã„ã†ã“ã¨ã§ã€ã“ã‚Œã‚’ç›®å½“ã¦ã«è©¦åˆã«è¦‹ã«æ¥ã‚‹ã¨ã„ã†éš ã‚Œãƒ•ã‚¡ãƒ³ã‚‚å¤šã„ã€‚",
        coach: { name: 'ä¸­ç”° è­²äºŒ', style: 'å®ˆå‚™é‡è¦–', experience: 'ä¸­å …' }
    },
    "ä¸‰å³¶åŒ—": {
        name_yomi: "ã¿ã—ã¾ããŸ",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 60,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        info: "2å¹´ç”Ÿã‚¨ãƒ¼ã‚¹å·¦è…•ãƒ»æ¦›åã‚’æ“ã™ã‚‹å…¬ç«‹ã®å®ŸåŠ›æ ¡ã€‚max148ã‚­ãƒ­ã®çƒé€Ÿã‚’æŒã¤æ¦›åã®æŠ•çƒãŒè©¦åˆã®éµã‚’æ¡ã‚‹ãŒã€æ‰“ç·šãŒã‚¨ãƒ¼ã‚¹ã‚’æ´è­·ã§ãã‚‹ã‹ãŒé•·å¹´ã®èª²é¡Œã€‚çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ã®å­˜åœ¨ã«é ¼ã‚‹ã ã‘ã§ãªãã€ãƒãƒ¼ãƒ å…¨ä½“ã§å¾—ç‚¹ã‚’å¥ªã†ç·åˆåŠ›ãŒè©¦ã•ã‚Œã‚‹ã€‚å®‰å®šã—ã¦ä¸Šä½ã«é€²å‡ºã™ã‚‹åŠ›ã¯ååˆ†ã«æŒã£ã¦ã„ã‚‹ã€‚",
        coach: { name: 'å¤§å· é€', style: 'æŠ•æ‰‹ä¸­å¿ƒ', experience: 'ä¸­å …' }
    },
    "é™å²¡": {
        name_yomi: "ã—ãšãŠã‹",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 105,
        best: "ç”²å­åœ’3å›æˆ¦",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4",
        info: "å‰µç«‹93å¹´ã€ç”²å­åœ’å‡ºå ´13å›ã€‚ãã—ã¦ã‚¹ãƒãƒ¼ãƒ„ã«åŠ›ã‚’å…¥ã‚ŒãªãŒã‚‰ã‚‚å‹‰å­¦ã§ã‚‚å„ªç§€ã€‚ãã®è¼ã‹ã—ã„æ­´å²ã€å®Ÿç¸¾ã¯åœ°å…ƒæ°‘ã®ã¿ãªã‚‰ãšçœŒæ°‘ã®èª‡ã‚Šã€ã¾ãŸæ†§ã‚Œã§ã‚‚ã‚ã‚Šã€è€è‹¥ç”·å¥³å•ã‚ãšåœ°å…ƒæ°‘ã«æ„›ã•ã‚Œã‚‹ä¼çµ±æ ¡ã§ã‚ã‚‹ã€‚è¿‘å¹´ã¯ä»–æ ¡ã®ç§ç«‹ã‚„ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã¨ã®é¸æ‰‹ç²å¾—ç«¶äº‰ã«ä¸€ã¤é…ã‚Œã‚’ã¨ã£ã¦ãŠã‚Šã€ç”²å­åœ’ã‹ã‚‰ã¯é ã–ã‹ã£ã¦ã„ã‚‹ãŒã€æ­´å²ã¯åšãã€ç§ç«‹ä¸¦ã¿ã®è¨­å‚™ã¨OBã‹ã‚‰ã®åšã„æ”¯æ´ã€ãã—ã¦ã€ãªã«ã‚ˆã‚Šã‚‚é™é«˜ã®è©¦åˆãŒã‚ã‚‹éš›ã«ã¯çƒå ´ã«å¤šãã®OBãŒé§†ã‘ä»˜ã‘ã€å¤§å¿œæ´å›£ã‚’çµæˆã—ã€ç›¸æ‰‹ã‚’åœ§å€’ã™ã‚‹ã€‚è¿‘å¹´ã¯ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ãŒçœŒå†…ã‚’ç‰›è€³ã‚Šã‹ã‘ã¦ã„ã‚‹ãŸã‚ã€å…¬ç«‹ã®å¸Œæœ›ã®æ˜Ÿã¨ã—ã¦ãƒ¡ãƒ‡ã‚£ã‚¢ã«å–ã‚Šä¸Šã’ã‚‰ã‚Œã‚‹ã“ã¨ã‚‚å¤šã„ã€‚çœŒå†…ã‚’å¸­å·»ã™ã‚‹ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã¸ã®ã€å…¬ç«‹æœ€å¾Œã®ç ¦ã€ã¨ã—ã¦ã€ãã®å­˜åœ¨ã¯è±¡å¾´çš„ãªæ„å‘³ã‚’æŒã¡å§‹ã‚ãŸã€‚åå°†ãƒ»é«˜å³¶ã¯ä¼çµ±ã¨ç¾ä»£é‡çƒã®èåˆã«è…å¿ƒã™ã‚‹ã€‚ã“ã‚Œã¯å˜ãªã‚‹é«˜æ ¡é‡çƒã§ã¯ãªã„ã€‚åœ°åŸŸã®èª‡ã‚Šã¨æœªæ¥ã‚’ã‹ã‘ãŸä»£ç†æˆ¦äº‰ãªã®ã ã€‚",
        popularity: true,
        coach: { name: 'é«˜å³¶ ç¤¼', style: 'ä¼çµ±é‡çƒ', experience: 'åå°†' }
    },
    "é£›é¾": {
        name_yomi: "ã²ã‚Šã‚…ã†",
        region: "æ±éƒ¨",
        type: "ç§ç«‹",
        deviation: 99,
        best: "ç”²å­åœ’2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "ã‹ã¤ã¦ã¯ç”²å­åœ’å‡ºå ´çµŒé¨“ã‚‚ã‚ã‚‹ç§ç«‹æ ¡ã ãŒã€æ•°å¹´å‰ã«èµ·ããŸä¸ç¥¥äº‹ã®å½±éŸ¿ã§ãƒãƒ¼ãƒ ã¯ä½è¿·ã€‚ç¾åœ¨ã¯è‹¥ãæ—ç”°ç›£ç£ã¨å…±ã«ã€å¤±ã‚ã‚ŒãŸä¿¡é ¼ã‚’å–ã‚Šæˆ»ã™ã¹ãå†å»ºã®é“ã‚’æ­©ã‚“ã§ã„ã‚‹ã€‚åœ°åŸŸã¸ã®æ¸…æƒæ´»å‹•ãªã©ã‚’é€šã˜ã¦åœ°é“ãªåŠªåŠ›ã‚’ç¶šã‘ã¦ãŠã‚Šã€ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®çµæœã§å®Œå…¨å¾©æ´»ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã—ãŸã„ã¨ã“ã‚ã ã€‚ã€‚",
        coach: { name: 'æ—ç”° å¥å¤ªéƒ', style: 'æ©Ÿå‹•åŠ›é‡çƒ', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼": {
        name_yomi: "ã›ã„ã‚Œã„ãã‚Šã™ã¨ãµããƒ¼",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 114,
        best: "ç”²å­åœ’2å›æˆ¦",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        info: "æ¯å¹´å„ªå‹å€™è£œã«æŒ™ã’ã‚‰ã‚Œã‚‹è¥¿éƒ¨åœ°åŒºã®é›„ã€‚åå°†ãƒ»ç‰‡å²¡ç›£ç£ãŒç¯‰ãä¸Šã’ãŸæŠ•æ‰‹ã‚’ä¸­å¿ƒã¨ã—ãŸå …å®ˆã¯å…¨å›½ãƒ¬ãƒ™ãƒ«ã¨è©•ã•ã‚Œã‚‹ã€‚ã—ã‹ã—ã€ãã®å …å®Ÿã•ã‚†ãˆã«æ‰“ç·šãŒæ¹¿ã‚ŠãŒã¡ã§ã€ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆçµ‚ç›¤ã§æ¶™ã‚’é£²ã‚€å±•é–‹ãŒç¶šãã€‚ã‚¿ãƒ¬ãƒ³ãƒˆã¯æƒã£ã¦ãŠã‚Šã€æ‚²é¡˜ã®ç”²å­åœ’å‡ºå ´ã«å‘ã‘ã¦ã€ä¼çµ±ã®å®ˆå‚™åŠ›ã«åŠ ãˆã¦å¾—ç‚¹åŠ›ã‚’ã©ã†å‘ä¸Šã•ã›ã‚‹ã‹ã€‚é•·å¹´ã®èª²é¡Œã§ã‚ã‚‹ã€Œãƒ™ã‚¹ãƒˆ8ã®å£ã€ã‚’è¶Šãˆã‚‰ã‚Œã‚‹ã‹ãŒä»Šå¤§ä¼šã®ç„¦ç‚¹ã¨ãªã‚‹ã€‚",
        popularity: true,
        coach: { name: 'ç‰‡å²¡ é‰„å¿ƒ', style: 'å®ˆå‚™é‡è¦–', experience: 'åå°†' }
    },
    "è£¾é‡": {
        name_yomi: "ã™ãã®",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 48,
        best: "ãªã—",
        last: "ãªã—",
        info: "ã‚¨ãƒ¼ã‚¹ã®èŒ‚é‡ãŒä¸­å¿ƒã¨ãªã£ã¦å‰µéƒ¨ã•ã‚ŒãŸæ–°ã—ã„ãƒãƒ¼ãƒ ã€‚éƒ¨å“¡ã®ã»ã¨ã‚“ã©ãŒé«˜æ ¡ã‹ã‚‰é‡çƒã‚’å§‹ã‚ãŸåˆå¿ƒè€…ã§ã‚ã‚Šã€æˆ¦åŠ›ã¨ã—ã¦ã¯æœªçŸ¥æ•°ã€‚èŒ‚é‡ã®åœ§å€’çš„ãªå€‹äººæŠ€ã§ã©ã“ã¾ã§å‹ã¡ä¸ŠãŒã‚Œã‚‹ã‹ãŒæ³¨ç›®ã•ã‚Œã‚‹ã€‚ãƒãƒ¼ãƒ ã¨ã—ã¦ã®ä¸€ä½“æ„ŸãŒç”Ÿã¾ã‚Œã‚Œã°ã€é¢ç™½ã„å­˜åœ¨ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚",
        coach: { name: 'èŒ‚é‡ å¾éƒ', style: 'è¶…æ”»æ’ƒå‹', experience: 'æ–°ä»»' }
    },
    "å¯Œå£«å®®åŒ—": {
        name_yomi: "ãµã˜ã®ã¿ã‚„ããŸ",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 71,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "åˆæˆ¦æ•—é€€",
        info: "ãƒ—ãƒ­æ³¨ç›®ã®max158kmã®æœ¬æ ¼æ´¾å³è…•ãƒ»æ–è—¤ã‚’æ“ã™ã‚‹å…¬ç«‹æ ¡ã€‚å½¼ã®å­˜åœ¨ã«ã‚ˆã‚Šã€ä¾‹å¹´ä»¥ä¸Šã®æ³¨ç›®ã‚’é›†ã‚ã¦ã„ã‚‹ã€‚ä½ã€…æœ¨ç›£ç£ã¯ã‚¨ãƒ¼ã‚¹ã¸ã®è² æ‹…ã‚’è€ƒæ…®ã—ã¤ã¤ã€ãƒãƒ¼ãƒ å…¨ä½“ã®åº•ä¸Šã’ã‚’å›³ã‚‹ã€‚æ–è—¤ã®å¿«æŠ•ã¯ã‚‚ã¡ã‚ã‚“ã€å½¼ã‚’æ”¯ãˆã‚‹é‡æ‰‹é™£ã®å¥®èµ·ãŒã€ä¸Šä½é€²å‡ºã¸ã®éµã¨ãªã‚‹ã€‚",
        coach: { name: 'ä½ã€…æœ¨ æœ—', style: 'æŠ•æ‰‹ä¸­å¿ƒ', experience: 'ä¸­å …' }
    },
    "ç¾åŸå­¦åœ’": {
        name_yomi: "ã¿ã—ã‚ãŒããˆã‚“",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 81,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ç³»åˆ—æ ¡ã®è‰åˆ†ã‘çš„å­˜åœ¨ã€‚ã‹ã¤ã¦ã¯ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸­å¿ƒã ã£ãŸãŒã€è¿‘å¹´ã¯åŒã˜ç³»åˆ—ã®765ç·åˆã‚„283å­¦åœ’ã«æœ‰åŠ›é¸æ‰‹ãŒé›†ã¾ã‚Šã€è‹¦æˆ¦ã‚’å¼·ã„ã‚‰ã‚Œã¦ã„ã‚‹ã€‚ä¸‰åŸç›£ç£ã®ä¸‹ã€ãƒ—ãƒ©ã‚¤ãƒ‰ã‚’ã‹ã‘ãŸæˆ¦ã„ã§å¤è±ªã®æ„åœ°ã‚’è¦‹ã›ã€ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§ã®åºåˆ—ã‚’è¦†ã—ãŸã„ã¨ã“ã‚ã ã€‚",
        coach: { name: 'ä¸‰åŸ å¸¸å‹™', style: 'ã‚¨ãƒªãƒ¼ãƒˆé‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æ²¼æ´¥é«˜å°‚": {
        name_yomi: "ã¬ã¾ã¥ã“ã†ã›ã‚“",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 18,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "å…¨å›½ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã®åå·®å€¤ã‚’èª‡ã‚‹è¶…é€²å­¦æ ¡ã€‚ç›¸æ‰‹ãƒãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾¹åº•çš„ã«åˆ†æã—ã€ç¢ºç‡ã«åŸºã¥ã„ãŸæˆ¦è¡“ã‚’çµ„ã¿ç«‹ã¦ã‚‹ã€Œã‚·ãƒ³ã‚­ãƒ³ã‚°ãƒ»ãƒ™ãƒ¼ã‚¹ãƒœãƒ¼ãƒ«ã€ãŒæŒã¡å‘³ã€‚èº«ä½“èƒ½åŠ›ã§ã¯ä»–æ ¡ã«åŠ£ã‚‹éƒ¨åˆ†ã‚‚ã‚ã‚‹ãŒã€ãã®çŸ¥æ€§ã§è£œã£ã¦ä½™ã‚Šã‚ã‚‹ã€‚ã‚»ã‚ªãƒªãƒ¼ã®ç©´ã‚’çªãæˆ¦ã„æ–¹ã¯ã€ã©ã‚“ãªå¼·è±ªã«ã¨ã£ã¦ã‚‚è„…å¨ã¨ãªã‚‹ã€‚ã€‚",
        coach: { name: 'äº¬å¤§ ä¸€éƒ', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'ä¸­å …' }
    },
    "ä¸‰å³¶å—": {
        name_yomi: "ã¿ã—ã¾ã¿ãªã¿",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 62,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æ•°å¹´å‰ã«21ä¸–ç´€æ ã¨ã—ã¦ç”²å­åœ’ã«å‡ºå ´ã—ãŸçµŒé¨“ã‚’æŒã¤ã€‚æ•°å¹´å‰ã»ã©ã®åŠ›ã¯ãªã„ãŒã€ä»Šå¹´ã®ãƒãƒ¼ãƒ ã¯å…¨å“¡é‡çƒã§ç›¸æ‰‹ã«æŒ‘ã¿ã€å®ˆå‚™ã§ãƒªã‚ºãƒ ã‚’ä½œã‚ŠãªãŒã‚‰ã€ã¤ãªããƒãƒƒãƒ†ã‚£ãƒ³ã‚°ã§å¾—ç‚¹ã™ã‚‹é‡çƒãŒç‰¹é•·ã€‚ã‚¨ãƒ¼ã‚¹ã®å‰ç”°ã¨ä¸»ç ²ã®æ‰“å·ã‚’ä¸­å¿ƒã«ã€æ³¥è‡­ã„é‡çƒã§ã“ã®å¤ã¯ä¸‹å…‹ä¸Šã§ç”²å­åœ’ã¾ã§å‹ã¡ä¸ŠãŒã‚‹ã€‚",
        popularity: true,
        coach: { name: 'å‰ç”° è¼å¤«', style: 'å…¨å“¡é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "å¾¡æ®¿å ´å—": {
        name_yomi: "ã”ã¦ã‚“ã°ã¿ãªã¿",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 34,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "50å¹´ã¶ã‚Šã¨ãªã‚‹ãƒ™ã‚¹ãƒˆ16ã«é€²å‡ºã—ãŸæ˜¨å¹´ã®èºé€²ã§ã€åœ°å…ƒã‚’å¤§ã„ã«æ²¸ã‹ã›ãŸå…¬ç«‹æ ¡ã€‚ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’å¾—æ„ã¨ã™ã‚‹å±±å†…ç›£ç£ã®æŒ‡å°ã®ä¸‹ã€æ´¾æ‰‹ã•ã¯ãªã„ãŒå …å®Ÿãªé‡çƒã§å‹ã¡ä¸ŠãŒã£ãŸã€‚å‘¨å›²ã®ã€Œã¾ãã‚Œã€ã¨ã„ã†å£°ã‚’è¦†ã—ã€è‡ªåˆ†ãŸã¡ã®å®ŸåŠ›ãŒæœ¬ç‰©ã§ã‚ã‚‹ã“ã¨ã‚’è¨¼æ˜ã—ãŸã„ä»Šå¤§ä¼šã¯ã€çœŸä¾¡ã‚’å•ã‚ã‚Œã‚‹é‡è¦ãªå¤ã¨ãªã‚‹ã€‚ã€‚",
        coach: { name: 'å±±å†… æµ©å¸', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "æ›å·è¥¿": {
        name_yomi: "ã‹ã‘ãŒã‚ã«ã—",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 151,
        best: "ç”²å­åœ’2å›æˆ¦",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4",
        info: "é™å²¡é«˜æ ¡ã¨ä¸¦ã¶ã‚¹ãƒãƒ¼ãƒ„ãŒç››ã‚“ãªçœŒå†…äºŒå¤§å…¬ç«‹æ ¡ã€‚ã‚µãƒƒã‚«ãƒ¼éƒ¨ãªã©ãŒå…¨å›½çš„ã«æœ‰åãªã‚¹ãƒãƒ¼ãƒ„å¼·è±ªæ ¡ã§ã‚ã‚Šã€é‡çƒéƒ¨ã‚‚æ¯å¹´å®‰å®šã—ã¦ä¸Šä½ã«é€²å‡ºã™ã‚‹å®ŸåŠ›ã‚’æŒã¤ãŒã€ã‚ã¨ä¸€æ­©ã§ç”²å­åœ’ã«å±Šã‹ãªã„ã‚·ãƒ¼ã‚ºãƒ³ãŒç¶šãã€‚åå°†ãƒ»å††å ‚ç›£ç£ãŒæ²ã’ã‚‹ã€å¸¸è­˜ã«ã¨ã‚‰ã‚ã‚Œãªã„å¤§èƒ†ãªé‡‡é…ã¯ã€å¤šãã®ãƒ•ã‚¡ãƒ³ã‚’é­…äº†ã—ã¦ã„ã‚‹ã€‚ä»Šå¹´ã“ãä»–ç«¶æŠ€ã®è¼ã‹ã—ã„å®Ÿç¸¾ã«è¿½ã„ã¤ããŸã„ã€‚ã€‚",
        coach: { name: 'å††å ‚ å®ˆ', style: 'è¶…æ¬¡å…ƒé‡çƒ', experience: 'åå°†' }
    },
    "æµœæ¾å¸‚ç«‹": {
        name_yomi: "ã¯ã¾ã¾ã¤ã„ã¡ã‚Šã¤",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 75,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æ¯å¹´å®‰å®šã—ãŸåŠ›ã‚’æŒã¤ä¸­å …å…¬ç«‹æ ¡ã ãŒã€ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆä¸­ç›¤ã§å¼·è±ªæ ¡ã¨å½“ãŸã‚Šæ•—é€€ã™ã‚‹ã“ã¨ãŒå¤šãã€ã€Œå£ã€ã‚’è¶Šãˆã‚‰ã‚Œãšã«ã„ã‚‹ã€‚ã“ã®çŠ¶æ³ã‚’æ‰“ç ´ã™ã¹ãã€ãƒ™ãƒ†ãƒ©ãƒ³ã®å±±å£ç›£ç£ã¯ä»Šå¹´ã¯æ©Ÿå‹•åŠ›é‡çƒã«ç‰¹åŒ–ã€‚å¡ã«å‡ºã‚Œã°ç©æ¥µçš„ã«æ¬¡ã®å¡ã‚’ç‹™ã†ã€ã—ã¤ã“ã„é‡çƒã§ç•ªç‹‚ã‚ã›ã‚’ç‹™ã†ã€‚ã€‚",
        coach: { name: 'å±±å£ ä¸€', style: 'æ©Ÿå‹•åŠ›é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æµœæ¾å­¦é™¢èˆˆèª ": {
        name_yomi: "ã¯ã¾ã¾ã¤ãŒãã„ã‚“ã“ã†ã›ã„",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 72,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "ä½“è‚²ç§‘ã®ã¿ã§æ§‹æˆã•ã‚Œã‚‹é€šä¿¡åˆ¶ã®ç§ç«‹æ ¡ã€‚å…¨å›½ã‹ã‚‰é¸æ‰‹ãŒé›†ã¾ã‚Šã€å¯®ç”Ÿæ´»ã‚’é€ã‚ŠãªãŒã‚‰é‡çƒã«æ‰“ã¡è¾¼ã‚“ã§ã„ã‚‹ã€‚ã‚µãƒƒã‚«ãƒ¼ç•Œã§å®Ÿç¸¾ã®ã‚ã‚‹å²¡ç”°ç›£ç£ãŒã€ç«¶æŠ€ã®å£æ ¹ã‚’è¶Šãˆã¦æŒ‡å°ã«ã‚ãŸã£ã¦ãŠã‚Šã€ãã®è‚²æˆæ‰‹è…•ã«æ³¨ç›®ãŒé›†ã¾ã‚‹ã€‚ç‹¬ç‰¹ã®ç’°å¢ƒã§è‚²ã£ãŸé¸æ‰‹ãŸã¡ãŒã€ãƒãƒ¼ãƒ ã¨ã—ã¦ã©ã†æ©Ÿèƒ½ã™ã‚‹ã‹ãŒéµã€‚",
        coach: { name: 'å²¡ç”° æ­¦å²', style: 'è‚²æˆä¸Šæ‰‹', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "ç„¼æ´¥æ°´ç”£": {
        name_yomi: "ã‚„ã„ã¥ã™ã„ã•ã‚“",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 44,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æ¸¯ç”ºã«æ ¹ã–ã—ãŸæ°´ç”£é«˜æ ¡ã§ã€ã‚¹ã‚¿ãƒ³ãƒ‰ã«ç¿»ã‚‹å¤§æ¼æ——ãŒãƒãƒ¼ãƒ ã®ã‚·ãƒ³ãƒœãƒ«ã€‚ä¸€æ˜¨å¹´ã®ãƒ™ã‚¹ãƒˆ16é€²å‡ºã¨ã„ã†å®Ÿç¸¾ã‚‚ã‚ã‚Šã€åœ°å…ƒã®æœŸå¾…ã¯å¤§ãã„ã€‚æµœç”°ç›£ç£ãŒç‡ã„ã‚‹ãƒãƒ¼ãƒ ã¯ã€ãƒãƒ£ãƒ³ã‚¹ã§ã®é›†ä¸­æ‰“ã‚’å¾—æ„ã¨ã™ã‚‹æ”»æ’ƒçš„ãªé‡çƒãŒæŒã¡å‘³ã€‚æ˜¨å¹´ã®ä¸æŒ¯ã‚’ä¹—ã‚Šè¶Šãˆã€å†ã³ã€Œå¤§æ¼ã€ã‚’ç‹™ã†ã€‚",
        coach: { name: 'æµœç”° å¤§å‰', style: 'ç©æ¥µæ‰“æ’ƒ', experience: 'ä¸­å …' }
    },
    "è¢‹äº•": {
        name_yomi: "ãµãã‚ã„",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 79,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        last: "åˆæˆ¦æ•—é€€",
        info: "çœŒå†…æœ‰æ•°ã®ãƒãƒ³ãƒ¢ã‚¹æ ¡ã§ã€æ¯å¹´ä¸€å®šæ•°ã®æœ‰æœ›ãªæ–°å…¥ç”ŸãŒå…¥éƒ¨ã™ã‚‹ã€‚çªå‡ºã—ãŸã‚¹ã‚¿ãƒ¼é¸æ‰‹ã¯ã„ãªã„ã‚‚ã®ã®ã€å…¨éƒ¨å“¡ã®ãƒ¬ãƒ™ãƒ«ãŒé«˜ãã€ç·åˆåŠ›ã§å‹è² ã™ã‚‹ãƒãƒ¼ãƒ ã€‚ãƒ™ãƒ†ãƒ©ãƒ³åƒè‘‰ç›£ç£ã®ä¸‹ã€é¸æ‰‹å±¤ã®åšã•ã‚’æ´»ã‹ã—ãŸå¤šå½©ãªæˆ¦è¡“ãŒå¼·ã¿ã€‚æ˜¨å¹´ã®åˆæˆ¦æ•—é€€ã®é›ªè¾±ã‚’èª“ã†ã€‚ã€‚",
        coach: { name: 'åƒè‘‰ ç¹', style: 'ç·åˆåŠ›', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æµœæ¾åŸåŒ—å·¥æ¥­": {
        name_yomi: "ã¯ã¾ã¾ã¤ã˜ã‚‡ã†ã»ãã“ã†ãã‚‡ã†",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 76,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4",
        last: "åˆæˆ¦æ•—é€€",
        info: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4ã®çµŒé¨“ã‚‚ã‚ã‚‹å…¬ç«‹æ ¡ã€‚å…ƒãƒ—ãƒ­ã®é‡‘æœ¬ç›£ç£ãŒæ³¨å…¥ã™ã‚‹ã€ç©æ¥µæœæ•¢ãªãƒ•ãƒ«ã‚¹ã‚¤ãƒ³ã‚°é‡çƒãŒãƒãƒ¼ãƒ ã®ä»£åè©ã€‚ãã®æ”»æ’ƒçš„ãªã‚¹ã‚¿ã‚¤ãƒ«ã¯ã€æ™‚ã«ãƒ©ãƒ•ãƒ—ãƒ¬ãƒ¼ã¨æ‰¹åˆ¤ã•ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚‹ãŒã€å‹åˆ©ã¸ã®åŸ·å¿µã¯ã©ã®ãƒãƒ¼ãƒ ã‚ˆã‚Šã‚‚å¼·ã„ã€‚æ˜¨å¹´ã®åˆæˆ¦æ•—é€€ã‹ã‚‰é€™ã„ä¸ŠãŒã‚Šã€å†ã³é ‚ç‚¹ã‚’ç›®æŒ‡ã™ã€‚ã€‚",
        coach: { name: 'é‡‘æœ¬ çŸ¥æ†²', style: 'ç©æ¥µæ‰“æ’ƒ', experience: 'ãƒ—ãƒ­OB' }
    },
    "ç£ç”°æ±": {
        name_yomi: "ã„ã‚ãŸã²ãŒã—",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 90,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "è½Ÿç›£ç£ã®ã€Œæ‰“æ’ƒã“ãæ­£ç¾©ã€ã¨ã„ã†å“²å­¦ã«åŸºã¥ãã€ç·´ç¿’ã®å¤§éƒ¨åˆ†ã‚’æ‰“æ’ƒç·´ç¿’ã«è²»ã‚„ã™è¶…æ”»æ’ƒå‹ãƒãƒ¼ãƒ ã€‚ãã®ç ´å£ŠåŠ›ã¯çœŒå†…ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã§ã€å¤§é‡å¾—ç‚¹ã§è©¦åˆã‚’ã²ã£ãã‚Šè¿”ã™åŠ›ã‚’æŒã¤ã€‚ä¸€æ–¹ã§ã€å®ˆå‚™åŠ›ã«èª²é¡Œã‚’æ®‹ã—ã¦ãŠã‚Šã€è©¦åˆå±•é–‹ãŒéå¸¸ã«ä¸å®‰å®šãªã®ãŒç‰¹å¾´ã€‚è¦³å®¢ã‚’é­…äº†ã™ã‚‹ã€ã‚¹ãƒªãƒªãƒ³ã‚°ãªè©¦åˆé‹ã³ã§å‹ã¡ä¸ŠãŒã‚Šã‚’ç‹™ã†ã€‚ã€‚",
        coach: { name: 'è½Ÿ é›·è”µ', style: 'æ‰“æ’ƒåé‡', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "é™å²¡å•†æ¥­": {
        name_yomi: "ã—ãšãŠã‹ã—ã‚‡ã†ãã‚‡ã†",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 7,
        best: "ç”²å­åœ’å„ªå‹",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        info: "ç”²å­åœ’å„ªå‹çµŒé¨“ã‚‚ã‚ã‚‹ä¼çµ±æ ¡ã§ã€æ¯å¹´å„ªå‹å€™è£œã®ç­†é ­ã«æŒ™ã’ã‚‰ã‚Œã‚‹ã€‚ã‚¨ãƒ¼ã‚¹æˆå®®ã‚’ç­†é ­ã¨ã™ã‚‹æŠ•æ‰‹åŠ›ã¯å…¨å›½å±ˆæŒ‡ã®ãƒ¬ãƒ™ãƒ«ã‚’èª‡ã‚‹ã€‚æ˜¨å¹´ã®å¤§ä¼šã§ã¯æº–ã€…æ±ºå‹ã§æ•—é€€ã—ã¦ãŠã‚Šã€ä»Šå¹´ã¯ç‹åº§å¥ªé‚„ã‚’ç›®æŒ‡ã™ã€‚åå°†ãƒ»å›½å‹ç›£ç£ã®ä¸‹ã€æŠ•æ‰“ã«éš™ãŒãªãã€ç·åˆåŠ›ã¯çœŒå†…ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã€‚ã€‚",
        popularity: true,
        coach: { name: 'å›½å‹ åºƒé‡', style: 'ç·åˆåŠ›', experience: 'åå°†' }
    },
    "å¾¡æ®¿å ´è¥¿": {
        name_yomi: "ã”ã¦ã‚“ã°ã«ã—",
        region: "æ±éƒ¨",
        type: "ç§ç«‹",
        deviation: 96,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆä¸­ç›¤ã®å¤§ããªå£ã¨ã—ã¦ã€æ¯å¹´å®‰å®šã—ãŸåŠ›ã‚’è¦‹ã›ã‚‹ç§ç«‹ã®å®ŸåŠ›æ ¡ã€‚ãƒ™ãƒ†ãƒ©ãƒ³ç”°å´ç›£ç£ãŒç¯‰ãä¸Šã’ãŸå …å®Ÿãªé‡çƒã¯ã€ã©ã®ãƒãƒ¼ãƒ ã«ã¨ã£ã¦ã‚‚ã‚„ã‚Šã«ãã„ã€‚ä¸€æ–¹ã§ã€è¿‘å¹´ã¯ãƒ™ã‚¹ãƒˆ8å‰å¾Œã§ã®æ•—é€€ãŒç¶šãã€ä¸Šä½é€²å‡ºã«ã¯èª²é¡Œã‚‚æ®‹ã‚‹ã€‚å¼·è±ªæ ¡ã«ã¨ã£ã¦ã¯å„ä»‹ãªã€Œé–€ç•ªã€ã‹ã‚‰è„±å´ã—ã€é ‚ç‚¹ã‚’ç‹™ãˆã‚‹ã‹ãŒå•ã‚ã‚Œã‚‹ã€‚ã€‚",
        coach: { name: 'ç”°å´ åœ­ä»‹', style: 'å …å®Ÿ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "èª æµ": {
        name_yomi: "ã›ã„ã‘ã„",
        region: "æ±éƒ¨",
        type: "ç§ç«‹",
        deviation: 58,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "åˆæˆ¦æ•—é€€",
        info: "ã‹ã¤ã¦ã¯ç”²å­åœ’ã«ã‚‚å‡ºå ´ã—ãŸå¤è±ªã ãŒã€è¿‘å¹´ã¯éƒ¨å“¡ä¸è¶³ã«æ‚©ã¿ä½è¿·ã—ã¦ã„ã‚‹ã€‚å‹åˆ©ã®ãŸã‚ãªã‚‰æ‰‹æ®µã‚’é¸ã°ãªã„ãƒ™ãƒ†ãƒ©ãƒ³å½±å±±ç›£ç£ã®éæƒ…ãªé‡‡é…ã¯ã€ç‰©è­°ã‚’é†¸ã™ã“ã¨ã‚‚å°‘ãªããªã„ã€‚ã—ã‹ã—ã€æµã¾ã‚Œãªã„æˆ¦åŠ›ã§å‹ã¡ä¸ŠãŒã‚‹ãŸã‚ã€ç¶ºéº—äº‹ã ã‘ã§ã¯æ¸ˆã¾ã•ã‚Œãªã„ã¨ã„ã†ãƒãƒ¼ãƒ ã®ç¾å®Ÿã‚‚è¡¨ã—ã¦ã„ã‚‹ã€‚ã€‚",
        coach: { name: 'å½±å±± ç§€è·¯', style: 'ãƒ©ãƒ•ãƒ—ãƒ¬ãƒ¼', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "ç§‘å­¦æŠ€è¡“": {
        name_yomi: "ã‹ãŒããã˜ã‚…ã¤",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 43,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "VRãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚„AIã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿è§£æãªã©ã€æœ€æ–°æŠ€è¡“ã‚’ç©æ¥µçš„ã«å°å…¥ã—ã¦ã„ã‚‹æ–°æ™‚ä»£ã®ç§ç«‹æ ¡ã€‚ãã®å…ˆé€²çš„ãªå–ã‚Šçµ„ã¿ã¯ãƒ¡ãƒ‡ã‚£ã‚¢ã§ã‚‚åº¦ã€…å–ã‚Šä¸Šã’ã‚‰ã‚Œã€çŸ¥ååº¦ã¯é«˜ã„ã€‚é€Ÿæ°´ç›£ç£ã®ä¸‹ã€ç§‘å­¦çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§é¸æ‰‹ã®èƒ½åŠ›ã‚’æœ€å¤§é™ã«å¼•ãå‡ºã™ã€‚ãƒ‡ãƒ¼ã‚¿é‡çƒãŒä¼çµ±çš„ãªå¼·è±ªæ ¡ã«ã©ã“ã¾ã§é€šç”¨ã™ã‚‹ã®ã‹ã€æ³¨ç›®ãŒé›†ã¾ã‚‹ã€‚ã€‚",
        coach: { name: 'é€Ÿæ°´ å¥¨', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'ä¸­å …' }
    },
    "ç¾åŸå­¦åœ’B": { 
        name_yomi: "ã¿ã—ã‚ãŒããˆã‚“ã³ãƒ¼", 
        region: "ä¸­éƒ¨", 
        type: "ç§ç«‹", 
        deviation: 95, 
        best: "ãªã—", 
        last: "ãªã—", 
        info: "å¤è±ªãƒ»ç¾åŸå­¦åœ’ã®Bãƒãƒ¼ãƒ ã€‚é¸æ‰‹å±¤ã®åšã„ç¾åŸå­¦åœ’ã«ãŠã„ã¦ã€å‡ºå ´æ©Ÿä¼šã«é£¢ãˆãŸé¸æ‰‹ãŸã¡ã§æ§‹æˆã•ã‚Œã‚‹ã€Œç¬¬2ã®çŸ¢ã€ã€‚ãƒˆãƒƒãƒ—ãƒãƒ¼ãƒ ã¸ã®æ˜‡æ ¼ã€ãã—ã¦ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼å¥ªå–ã‚’ç›®æ¨™ã«ã€ä¸‰åŸå¸¸å‹™ã®ç›®ã«ã¨ã¾ã‚‹ã‚ˆã†ãªã‚¢ãƒ”ãƒ¼ãƒ«ã‚’ç¶šã‘ã‚‹ã€‚ãã®ãƒãƒ³ã‚°ãƒªãƒ¼ç²¾ç¥ã¯Aãƒãƒ¼ãƒ ä»¥ä¸Šã‹ã‚‚ã—ã‚Œãªã„ã€‚", 
        coach: { name: 'åƒå· ã¡ã²ã‚', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'æ–°ä»»' } 
    },
    "è™åºœå³¶ç·åˆ": {
        name_yomi: "ã“ãµã¨ã†ãã†ã”ã†",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 47,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "åˆæˆ¦æ•—é€€",
        info: "æœ¬åœŸã‹ã‚‰å®šæœŸèˆ¹ã§4æ™‚é–“ã€‚å°é¢¨ãŒæ¥ã‚Œã°1é€±é–“ã¯å­¤å³¶ã¨åŒ–ã™ã€‚ãã‚ŒãŒè™åºœå³¶ã ã€‚ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã¯å¡©å®³ã§èŠç”ŸãŒã¾ã ã‚‰ã«æ¯ã‚Œã€é›¨ãŒé™ã‚Œã°æ²¼åœ°ã¨åŒ–ã™ã€‚ç·´ç¿’ç›¸æ‰‹ã¯æ¼ã®åˆé–“ã«é›†ã¾ã‚‹å³¶ã®è‰é‡çƒãƒãƒ¼ãƒ ã®åœ°å…ƒã®æ–¹ã€…ã€‚å½¼ã‚‰ã‹ã‚‰æ•™ã‚ã‚‹ã®ã¯ã€æ°—åˆã€ã¨ã€æ½®ã®æµã‚Œã®èª­ã¿æ–¹ã€ã ã€‚æœ¬åœŸã®ä»–æ ¡ã®æƒ…å ±ã¯ã€æœˆã«ä¸€åº¦å±Šãé‡çƒé›‘èªŒã ã‘ã€‚ã—ã‹ã—ã€ã“ã®çµ¶æœ›çš„ãªãƒãƒ³ãƒ‡ãŒå½¼ã‚‰ã®é­‚ã‚’é‹¼é‰„ã«å¤‰ãˆãŸã€‚ãã®é€†å¢ƒãŒã€Œè™åºœå³¶ã‚¹ãƒ”ãƒªãƒƒãƒ„ã€ã¨å‘¼ã°ã‚Œã‚‹å¼·é­ãªç²¾ç¥åŠ›ã¨ãƒãƒ¼ãƒ ã®çµæŸã‚’è‚²ã‚“ã ã€‚è©¦åˆã®æ—¥ã«ã¯å³¶æ°‘ãŒå¤§æŒ™ã—ã¦å¿œæ´ã«é§†ã‘ã¤ã‘ã‚‹ãªã©ã€åœ°åŸŸã¨ã®çµ†ã¯ã©ã“ã‚ˆã‚Šã‚‚å¼·ã„ã€‚å™‚ã«ã‚ˆã‚‹ã¨å³¶æ°‘ã®ç´„åŠæ•°ã«ã‚‚åŠã¶ã‚‰ã—ã„ã€‚ã‚‚ã¯ã‚„ã“ã‚Œã¯å˜ãªã‚‹ã‚¹ãƒãƒ¼ãƒ„ã§ã¯ãªã„ã€‚å³¶ãŒã€ç”Ÿãã‚‹ãŸã‚ã«æˆ¦ã†ç‰©èªã ã€‚",
        coach: { name: 'å³¶è¢‹ è­²äºŒ', style: 'å…¨å“¡é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "çŸ¥å¾³": {
        name_yomi: "ã¡ã¨ã",
        region: "æ±éƒ¨",
        type: "ç§ç«‹",
        deviation: 71,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        last: "åˆæˆ¦æ•—é€€",
        info: "ã€åŠ›ã“ãå…¨ã¦ã€ã‚’æ ¡è¨“ã«æ²ã’ã€ç·´ç¿’ã®ã»ã¨ã‚“ã©ã‚’ã‚¦ã‚¨ã‚¤ãƒˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«è²»ã‚„ã™è„³ç­‹é›†å›£ã€‚é‡‘å‰›ç›£ç£ã®æŒ‡å°ã®ä¸‹ã€å…¨é¸æ‰‹ãŒãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹100kgä»¥ä¸Šã‚’èª‡ã‚‹ãƒ‘ãƒ¯ãƒ¼ã¯æœ¬ç‰©ã ã€‚ã—ã‹ã—ã€ãã®å¤§å‘³ãªé‡çƒã¯ã€æ „é¤Šç®¡ç†ã‚„ç§‘å­¦çš„ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å–ã‚Šå…¥ã‚Œã‚‹å¼·è±ªæ ¡ã®å‰ã«ã€ã„ã¤ã‚‚ã‚ã¨ä¸€æ­©ã§å±ˆã—ã¦ããŸã€‚ç­‹è‚‰ã¯è£åˆ‡ã‚‰ãªã„ã€‚ãã®è¨€è‘‰ã‚’ä¿¡ã˜ã€å½¼ã‚‰ã¯ä»Šæ—¥ã‚‚é‰„ã‚¢ãƒ¬ã‚¤ã‚’æ¡ã‚‹ã€‚",
        coach: { name: 'é‡‘å‰› æ¯…', style: 'ãƒ‘ãƒ¯ãƒ¼é‡çƒ', experience: 'ä¸­å …' }
    },
    "é™æ¸…": {
        name_yomi: "ã›ã„ã›ã„",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 45,
        best: "ç”²å­åœ’å„ªå‹",
        last: "åˆæˆ¦æ•—é€€",
        info: "åŠä¸–ç´€å‰ã«ç”²å­åœ’5é€£è¦‡ã‚’é”æˆã—ãŸä¼èª¬çš„ãªå¤è±ªã€‚è¿‘å¹´ã¯ä½è¿·ãŒç¶šããŒã€ãã®åå‰ã¯ä»Šã‚‚é«˜æ ¡é‡çƒãƒ•ã‚¡ãƒ³ã«ç•æ•¬ã®å¿µã‚’æŠ±ã‹ã›ã¦ã„ã‚‹ã€‚ã‹ã¤ã¦ã®åå°†ã®è¡€ã‚’å¼•ãçŠ¬é£¼ç›£ç£ãŒã€ä¼çµ±ã®å …å®ˆã‚’å¾©æ´»ã•ã›ã€ã€Œå¸å›½ã®å†å»ºã€ã‚’ç›®æŒ‡ã™ã€‚å¤è±ªå¾©æ´»ã¸ã®é“ã®ã‚Šã¯é™ºã—ã„ãŒã€ãã®ä¸€æŒ™æ‰‹ä¸€æŠ•è¶³ã«æ³¨ç›®ãŒé›†ã¾ã‚‹ã€‚ã€‚",
        coach: { name: 'çŠ¬é£¼ è³¢äºº', style: 'å®ˆå‚™é‡è¦–', experience: 'åå°†' }
    },
    "æ—¥å¤§ä¸‰å³¶": {
        name_yomi: "ã«ã¡ã ã„ã¿ã—ã¾",
        region: "æ±éƒ¨",
        type: "ç§ç«‹",
        deviation: 96,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "2022å¹´ã®æ˜¥å¤é€£ç¶šç”²å­åœ’å‡ºå ´ãŒè¨˜æ†¶ã«æ–°ã—ã„æ—¥å¤§ä¸‰å³¶ã€‚æ˜¨ç§‹ã¯çœŒå¤§ä¼š3å›æˆ¦ã§æ•—é€€ã—ã€æ°—åˆã‚’å…¥ã‚Œç›´ã—ãŸã¨ã“ã‚ã ã€‚æŒ‡æ®ã‚’ã¨ã‚‹ã®ã¯æ°¸ç”°è£•æ²»ç›£ç£ã ã€‚å ±å¾³å­¦åœ’ï¼ˆå…µåº«ï¼‰æ™‚ä»£ã«ã¯å…¨å›½åˆ¶è¦‡ã‚’å«ã‚€ã€æ˜¥å¤é€šç®—18å›ã®ç”²å­åœ’å‡ºå ´ã€‚2020å¹´ã«æ—¥å¤§ä¸‰å³¶ã«èµ´ä»»ã™ã‚‹ã¨ã€2022å¹´ã«ã¯æ˜¥å¤é€£ç¶šã§ç”²å­åœ’ã«å°ã„ãŸã€‚ä»Šãƒãƒ¼ãƒ ã‚‚ç™¾æˆ¦éŒ¬ç£¨ã®åå°†ã‹ã‚‰å…¨å“¡é‡çƒã®å¤§åˆ‡ã•ã€å‹è² ã«å¯¾ã™ã‚‹å³ã—ã•ã‚’å­¦ã³ã€é¸æ‰‹ãŸã¡ã®é¡”ã¤ããŒå°‘ã—ãšã¤å¤‰ã‚ã£ã¦ããŸã€‚åå°†ã®å°±ä»»ã‹ã‚‰4å¹´ãŒéãã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã€‚ã€‚",
        coach: { name: 'å°å’Œç”° é›…äºº', style: 'å …å®Ÿ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æµœæ¾é–‹èª é¤¨": {
        name_yomi: "ã¯ã¾ã¾ã¤ã‹ã„ã›ã„ã‹ã‚“",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 120,
        best: "ç”²å­åœ’2å›æˆ¦",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã¯çœŒå†…ãƒˆãƒƒãƒ—ã¨ã‚‚ç§°ã•ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚‹ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆå±ˆæŒ‡ã®ãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ã€‚2023å¹´ã«ã¯ç”²å­åœ’å‡ºå ´ã‚‚æœãŸã—ã€ä¸€èºå¼·è±ªã¨ã—ã¦ã®åèª‰ã‚’ç¯‰ã„ãŸã€‚ç­–å£«ãƒ»ä½é‡ç›£ç£ãŒç‡ã„ã‚‹ãƒãƒ¼ãƒ ã¯ã€ç›¸æ‰‹ãƒãƒ¼ãƒ ã®å¾¹åº•çš„ãªåˆ†æã«åŸºã¥ã„ãŸå¥‡ç­–ã‚’å¾—æ„ã¨ã™ã‚‹ã€‚ãã®äºˆæ¸¬ä¸èƒ½ãªæˆ¦ã„ã¶ã‚Šã¯ã€ã€ã²ã¨ãŸã³æ³¢ã«ä¹—ã‚Œã°ä¸€æ°—ã«å‹ã¡ä¸ŠãŒã‚‹åŠ›ã‚’æŒã£ã¦ã„ã‚‹ã€‚ã€‚",
        coach: { name: 'ä½é‡ ç§€å¹¸', style: 'å¥‡ç­–', experience: 'ç­–å£«' }
    },
    "æ±æµ·å¤§ç¿”æ´‹": {
        name_yomi: "ã¨ã†ã‹ã„ã ã„ã—ã‚‡ã†ã‚ˆã†",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 91,
        best: "çœŒæº–å„ªå‹",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "ä¸€æ˜¨å¹´ã®å¤ã¯ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã‹ã‚‰æ±ºå‹ã¾ã§å‹ã¡é€²ã‚€ã‚‚765ç·åˆã«æ•—ã‚Œã€æº–å„ªå‹ã€‚æ–°ã—ã„ã‚¹ã‚¿ã‚¤ãƒ«ã§ä»Šå¤ã“ãç”²å­åœ’ã¸ï¼å‹åˆ©ã¸ã®åŸ·å¿µã‚’å¼•ãç¶™ãç¾ãƒãƒ¼ãƒ ã®ç‰¹å¾´ã¯ã€Œæ©Ÿå‹•åŠ›ã€ã€‚å‰ãƒãƒ¼ãƒ ã¨ã¯ã¾ãŸé•ã£ãŸã‚¹ã‚¿ã‚¤ãƒ«ã«æœŸå¾…ãŒã‹ã‹ã‚‹ã€‚æ©Ÿå‹•åŠ›ä»¥å¤–ã‚‚ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã—ã¦ã„ã‚‹ã€‚æŠ•æ‰‹ã¯140ã‚­ãƒ­å³è…•ã®ç”˜ç”°åœ­æ¾„ï¼ˆ2å¹´ï¼‰ãŒå›è‡¨ã€‚èª²é¡Œã ã£ãŸ2ç•ªæ‰‹ã‚‚ã€1å¹´ç”Ÿã‚’ä¸­å¿ƒã«å°é ­ã—ã¤ã¤ã‚ã‚‹ã€‚ä¸€æ–¹ã®æ”»æ’ƒåŠ›ã¯7è©¦åˆè¨ˆ90å®‰æ‰“ã‚’å©ãå‡ºã—ãŸæ˜¨å¹´ã®ãƒãƒ¼ãƒ ã«æ¯”ã¹ã¦åŠ£ã‚‹ãŒã€æ©Ÿå‹•åŠ›ã‚’ä½¿ã£ãŸé‡çƒã‚’å±•é–‹ã€‚ãƒãƒ¼ãƒ ãƒŠãƒ³ãƒãƒ¼ãƒ¯ãƒ³ã®ä¿Šè¶³ãƒ»æ¾ä¸‹æ®äººï¼ˆ2å¹´ï¼å¤–é‡æ‰‹ï¼‰ã‚„å²¸å·ã‚’ç­†é ­ã«è¶³ã®é€Ÿã„é¸æ‰‹ãŒå¤šã„ã®ã‚‚è¿½ã„é¢¨ã¨ãªã£ã¦ã„ã‚‹ã€‚å®ˆã‚Šã‹ã‚‰ãƒªã‚ºãƒ ã‚’ä½œã‚Šã€1ç‚¹ãšã¤ç©ã¿é‡ã­ã¦ã„ããƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ãŒæµ¸é€ã—ã¦ããŸã€Œã‚¿ãƒ†ã‚¸ãƒè»å›£ã€ã€‚2004å¹´å¤ä»¥æ¥ã¨ãªã‚‹ç”²å­åœ’ã«å‘ã‘ã¦ç‰™ã‚’ç ”ãã€‚ã€‚",
        coach: { name: 'é ˆç”° å¹¸é›„', style: 'ç·åˆåŠ›', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "283å­¦åœ’B": {
        name_yomi: "ã¤ã°ã•ãŒããˆã‚“B",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 59,
        best: "ãªã—",
        last: "ãªã—",
        info: "ç‹è€…ãƒ»283å­¦åœ’ã®ã€äºŒè»ã€ã€‚æ˜¨å¹´ã®å„ªå‹ã«ã‚ˆã‚Šéƒ¨å“¡æ•°ãŒæ€¥æ¿€ã«å¢—åŠ ã—ãŸ283å­¦åœ’ã€‚ä¸€æ™‚ã¯100äººã‚‚è¶…ãˆãŸãŸã‚ã€ãã‚Œã«ä¼´ã„ã€ç•°ä¾‹ã®æªç½®ã¨ã—ã¦è¨­ç«‹ã•ã‚ŒãŸBãƒãƒ¼ãƒ ã€‚Aãƒãƒ¼ãƒ ã«ä¸ŠãŒã‚Œãªã‹ã£ãŸé¸æ‰‹ã§æ§‹æˆã•ã‚Œã¦ã„ã‚‹ãŒã€ç›£ç£ã«å°±ä»»ã—ãŸä¸ƒè‰ã®æ‰‹è…•ã‚‚ã‚ã‚Šã€ãã®å®ŸåŠ›ã¯ä¾®ã‚Œãªã„ã€‚ã€Œæ‰“å€’Aãƒãƒ¼ãƒ ã€ã‚’æ²ã’ã€ãƒãƒ³ã‚°ãƒªãƒ¼ç²¾ç¥ã¯æœ¬å®¶ä»¥ä¸Šã€‚å…¬å¼æˆ¦ã§ã®å…„å¼Ÿå¯¾æ±ºãŒå®Ÿç¾ã™ã‚Œã°ã€å¤§ããªæ³¨ç›®ã‚’é›†ã‚ã‚‹ã ã‚ã†ã€‚çœŒå†…ã‹ã‚‰ã¯åŒã˜çœŒå†…ã«åŒã˜é«˜æ ¡ã®ãƒãƒ¼ãƒ ã®äºŒã¤ç›®ã‚’ä½œã‚Šå¤§ä¼šã«å‚åŠ ã•ã›ã‚‹ã®ã¯é•åè¡Œç‚ºãªã®ã§ã¯ã€ã¨ã„ã†å£°ãŒå¤šãä¸ŠãŒã£ãŸãŒã€çœŒå†…ã¯ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ãŒç‰›è€³ã£ã¦ã„ã‚‹ãŸã‚ã€ã”ã‚ŠæŠ¼ã—ã§å¯æ±ºã•ã›ãŸã€‚",
        coach: { name: 'ä¸ƒè‰ ã¯ã¥ã', style: 'è‚²æˆä¸Šæ‰‹', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "ä¼Šè±†ä¼Šæ±": {
        name_yomi: "ã„ãšã„ã¨ã†",
        region: "ä¼Šè±†",
        type: "å…¬ç«‹",
        deviation: 43,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æ•°å¹´å‰ã«å…±å­¦åŒ–ã—ãŸå…ƒå¥³å­é«˜ã§ã€é‡çƒéƒ¨ã¯å‰µéƒ¨ã¾ã‚‚ãªã„æ–°ã—ã„ãƒãƒ¼ãƒ ã€‚å­¦æ ¡å´ã®å…¨é¢çš„ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å—ã‘ã€æœŸå¾…ã®è‹¥æ‰‹ã€ä¼Šé›†é™¢ç›£ç£ãŒæŒ‡å°ã«ã‚ãŸã‚‹ã€‚å…¨å›½ãƒ¬ãƒ™ãƒ«ã¨åé«˜ã„å¹å¥æ¥½éƒ¨ã®å¿œæ´ã‚‚ãƒãƒ¼ãƒ ã®å¤§ããªæ­¦å™¨ã€‚ã¾ã ç™ºå±•é€”ä¸Šã ãŒã€ä»Šå¾Œã®æˆé•·ãŒæœŸå¾…ã•ã‚Œã‚‹æ³¨ç›®æ ªã ã€‚ã€‚",
        coach: { name: 'ä¼Šé›†é™¢ éš¼äºº', style: 'æ©Ÿå‹•åŠ›é‡çƒ', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "å¯Œå£«æ±": {
        name_yomi: "ãµã˜ã²ãŒã—",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 63,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "å¯Œå£«æ±ã¯æœ€ä¸Šç´šç”Ÿã®å¥®èµ·ã«æ³¨ç›®ã ã€‚æ˜¨å¹´ã¯ï¼”äººã—ã‹ã„ãªã„ï¼“å¹´ç”Ÿå…¨å“¡ãŒæ´»èºã‚’è¦‹ã›ã€åˆæˆ¦ã§ç”²å­åœ’å‡ºå ´çµŒé¨“ã‚‚ã‚ã‚‹å¯Œå£«å®®åŒ—ã‚’ï¼—â€•ï¼–ã§ç ´ã£ãŸã€‚ä¸€ç·’ã«ãƒ—ãƒ¬ãƒ¼ã—ãŸå²©ç”°ä¸»å°†ï¼ˆï¼“å¹´ï¼‰ã¯ã€Œãã†ã„ã†ä¸Šç´šç”Ÿã®å§¿ã‚’ä»Šå¹´ã‚‚å¾Œè¼©ãŸã¡ã«è¦‹ã›ãŸã„ã€ã¨æ„æ°—è¾¼ã‚€ã€‚ã‚¨ãƒ¼ã‚¹ã®çœå±±ï¼ˆï¼“å¹´ï¼‰ã¯ã€ï¼”æ—¥ã®æ‹›å¾…è©¦åˆã§æ—¥å¤§ä¸‰å³¶ã«ï¼‘å¤±ç‚¹å®ŒæŠ•å‹åˆ©ã€‚è‡ªä¿¡ã‚’èƒ¸ã«ã€Œãƒãƒ¼ãƒ ã‚’é¼“èˆã™ã‚‹æŠ•çƒã‚’ã—ãŸã„ã€ã¨å¤§èˆå°ã‚’è¦‹æ®ãˆã‚‹ã€‚ã€‚",
        coach: { name: 'é«˜æ©‹ ç•™ç¾', style: 'å®ˆå‚™é‡è¦–', experience: 'ä¸­å …' }
    },
    "å¸¸è‘‰èŠå·": {
        name_yomi: "ã¨ã“ã¯ãããŒã‚",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 55,
        best: "ç”²å­åœ’æº–å„ªå‹",
        last: "çœŒæº–å„ªå‹",
        info: "ç¹”ç”°ç›£ç£ãŒç‡ã„ã‚‹ã€è¶…æ”»æ’ƒçš„ãªé‡çƒã‚’æ¨™æ¦œã™ã‚‹ç§ç«‹æ ¡ã€‚æ˜¨å¹´ã®çœŒå¤§ä¼šã§ã¯ã€ãã®åœ§å€’çš„ãªæ‰“æ’ƒåŠ›ã§æº–å„ªå‹ã«è¼ã„ãŸã€‚å®ˆå‚™ã«èª²é¡Œã‚’æ®‹ã™ã‚‚ã®ã®ã€ã€Œç‚¹ã‚’å–ã‚‰ã‚ŒãŸã‚‰å–ã‚Šè¿”ã™ã€ã¨ã„ã†ã‚¹ã‚¿ã‚¤ãƒ«ã¯å¤šãã®ãƒ•ã‚¡ãƒ³ã‚’é­…äº†ã—ã¦ã„ã‚‹ã€‚ä»Šå¹´ã‚‚ãã®ç ´å£Šçš„ãªæ‰“ç·šã¯å¥åœ¨ã§ã€é ‚ç‚¹ã‚’ç›®æŒ‡ã™ã€‚ã€‚",
        coach: { name: 'ç¹”ç”° ä¿¡é•·', style: 'è¶…æ”»æ’ƒå‹', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "å¸¸è‘‰æ©˜": {
        name_yomi: "ã¨ã“ã¯ãŸã¡ã°ãª",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 92,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æŠ•æ‰‹é™£ã¯ç·©æ€¥ã‚’ã¤ã‘ã‚‹ä¸‰æµ¦ã€æ€ã„åˆ‡ã‚Šã®ã„ã„å±±å£ã‚‰ãŒä¸»æˆ¦ã‚’äº‰ã†ã€‚æ‰“ç·šã¯é•·æ‰“åŠ›ãŒã‚ã‚‹ãƒ–ãƒ©ãƒ³ã‚³ã€ä¸­æ‘ã‚‰ä¸­è»¸ãŒä¿¡é ¼ã§ãã‚‹ã€‚çŸ³å·ã€ãƒ¢ãƒ¼ã‚¬ãƒ³ã‚‰ä¸Šä½ãŒå‡ºã¦ã€å¾—ç‚¹æ©Ÿã‚’ã¤ãã‚ŠãŸã„ã€‚ä¸‹ä½æ‰“ç·šã®å……å®ŸãŒéµã€‚å®ˆå‚™ã¯ä¸€å¹´ç”Ÿã®æ™‚ã‹ã‚‰è©¦åˆã«å‡ºã¦ã„ã‚‹éŠæ’ƒæ¢¶è°·ã€æ˜¨å¹´ã‚’çµŒé¨“ã—ãŸæ•æ‰‹é¶´å²¡ã‚‰ã‚»ãƒ³ã‚¿ãƒ¼ãƒ©ã‚¤ãƒ³ãŒè»¸ã€‚ç¢ºå®Ÿã«ã‚¢ã‚¦ãƒˆã‚’å–ã‚Œã‚‹å®‰å®šæ„ŸãŒæŒã¡å‘³ã ã€‚",
        coach: { name: 'æ¸¡è¾º å…ƒæ™º', style: 'ç·åˆåŠ›', experience: 'åå°†' }
    },
    "è—¤ææ˜èª ": {
        name_yomi: "ãµã˜ãˆã ã‚ã„ã›ã„",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 90,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        info: "ã€Œé›‘è‰è»å›£ã€ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã€å …å®Ÿãªå®ˆå‚™ã¨æ‰‹å …ã„æ”»ã‚ã®é‡çƒãŒæŒã¡å‘³ã®ãƒãƒ³ã‚°ãƒªãƒ¼ç²¾ç¥ã®å¼·ã„ãƒãƒ¼ãƒ ã€‚ãƒ™ãƒ†ãƒ©ãƒ³çŒªç‹©ç›£ç£ã®æŒ‡å°ã®ä¸‹ã€å€‹ã€…ã®é¸æ‰‹ã®èƒ½åŠ›ã¯éå¸¸ã«é«˜ã„ã€‚ãƒãƒ¼ãƒ ã¨ã—ã¦å™›ã¿åˆã£ãŸæ™‚ã®çˆ†ç™ºåŠ›ã¯ã€å„ªå‹å€™è£œã‚’ã‚‚è„…ã‹ã™ã€‚è¿‘å¹´ç€ã€…ã¨çµæœã‚’å‡ºã—ã¦ãŠã‚Šã€ä»Šå¤§ä¼šã¯æ˜¥ã®å¤§ä¼šã§ä¸Šä½ã®æˆç¸¾ã‚’åã‚ãŸã“ã¨ã«ã‚ˆã‚Šã€ã‚·ãƒ¼ãƒ‰æ ¡ã¨ã—ã¦å›è‡¨ã—ã¦ã„ã‚‹ã€‚ã€Œé©å‘½ã€ã®æ™‚ã¯è¿‘ã„ã€‚",
        coach: { name: 'çŒªç‹© èŒ‚', style: 'æŠ•æ‰‹ä¸­å¿ƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "é§¿æ²³ç·åˆ": {
        name_yomi: "ã™ã‚‹ãŒãã†ã”ã†",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 57,
        best: "çœŒå¤§ä¼šæº–å„ªå‹",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "2019å¹´å¤ã«åˆã®çœŒæ±ºå‹é€²å‡ºã‚’æœãŸã—ãŸé§¿æ²³ç·åˆã€‚æ˜¨å¤ã®ã€Œ2020å¹´å¤å­£é™å²¡çœŒé«˜ç­‰å­¦æ ¡é‡çƒå¤§ä¼šçµæœã€ã§ã‚‚ãƒ™ã‚¹ãƒˆ4å…¥ã‚Šã€‚æ‚²é¡˜ã®ç”²å­åœ’ãŒæ‰‹ã®å±Šãä½ç½®ã¾ã§ãã¦ã„ã‚‹ã€‚åŒæ ¡ã¯ãƒãƒ¼ãƒ åŠ›ãŒå¹´ã€…ä¸Šæ˜‡ã™ã‚‹ã¨åŒæ™‚ã«ã€ä¸Šã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§æ´»èºã™ã‚‹å’æ¥­ç”ŸãŒå¢—ãˆã¦ã„ã‚‹ã€‚2018å¹´ã«ç¤¾ä¼šäººé‡çƒã‚’çµŒã¦OBã®æ‰å±±ä¸€æ¨¹ï¼ˆç¦å²¡ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯ï¼‰ãŒãƒ—ãƒ­å…¥ã‚Šã€‚æœ€é€Ÿ157ã‚­ãƒ­ã®å‰›é€Ÿçƒã‚’æ­¦å™¨ã«ä»Šå­£ã¯ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸€è§’ã¨ã—ã¦æœŸå¾…ã•ã‚Œã‚‹ã€‚ã•ã‚‰ã«ã€2019å¹´ã®ãƒ‰ãƒ©ãƒ•ãƒˆã§æŒ‡åã•ã‚ŒãŸç´…æ—å¼˜å¤ªéƒï¼ˆã‚ªãƒªãƒƒã‚¯ã‚¹ï¼‰ã¯ãƒ—ãƒ­1å¹´ç›®ã‹ã‚‰1è»æˆ¦ã«å‡ºå ´ã€‚å°†æ¥ã®ä¸»è»¸å€™è£œã¨ã—ã¦æ³¨ç›®ã‚’é›†ã‚ã¦ã„ã‚‹ã€‚æœŸå¾…ã®è‹¥æ‰‹ãƒ»è—¤å´ç›£ç£ãŒæŒã¡è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿é‡çƒã‚’æ­¦å™¨ã«ã€ç€å®Ÿã«åŠ›ã‚’ã¤ã‘ã¦ã„ã‚‹ã€‚ç›¸æ‰‹ã®æ²¹æ–­ã‚’çªãæƒ…å ±æˆ¦ã‚’å¾—æ„ã¨ã—ã€ä¸‹é¦¬è©•ã‚’è¦†ã™ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã¯ååˆ†ã€‚æ ¡åã¨ã¯è£è…¹ã«ã€å†·é™æ²ˆç€ãªé‡çƒã§ç•ªç‹‚ã‚ã›ã‚’ç‹™ã†ã€‚ã€‚",
        coach: { name: 'è—¤å´ è©©ç¹”', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "åŠ è—¤å­¦åœ’": {
        name_yomi: "ã‹ã¨ã†ãŒããˆã‚“",
        region: "æ±éƒ¨",
        type: "ç§ç«‹",
        deviation: 129,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æŠ•æ‰‹é™£ã¯ç·©æ€¥ã‚’ã¤ã‘ã‚‹å¶‹ã€æ€ã„åˆ‡ã‚Šã®ã„ã„æ¦æœ¬ã‚‰ãŒä¸»æˆ¦ã‚’äº‰ã†ã€‚æ‰“ç·šã¯é•·æ‰“åŠ›ãŒã‚ã‚‹å³ç”°ã€å¯ºç”°ã‚‰ä¸­è»¸ãŒä¿¡é ¼ã§ãã‚‹ã€‚å·å´ã‚‰ä¸Šä½ãŒå‡ºã¦ã€å¾—ç‚¹æ©Ÿã‚’ã¤ãã‚ŠãŸã„ã€‚ä¸‹ä½æ‰“ç·šã®å……å®ŸãŒéµã€‚å®ˆå‚™ã¯ä¸€å¹´ç”Ÿã®æ™‚ã‹ã‚‰è©¦åˆã«å‡ºã¦ã„ã‚‹éŠæ’ƒå‚å£ã€æ˜¨å¹´ã‚’çµŒé¨“ã—ãŸæ•æ‰‹å¤ç”°ã‚‰ã‚»ãƒ³ã‚¿ãƒ¼ãƒ©ã‚¤ãƒ³ãŒè»¸ã€‚å¤ã¾ã§ã«ç¢ºå®Ÿã«ã‚¢ã‚¦ãƒˆã‚’å–ã‚Œã‚‹å®‰å®šæ„Ÿã‚’èº«ã«ã¤ã‘ãŸã„ç›´è¿‘ã®ç·´ç¿’è©¦åˆã§ã¯æ±æµ·å¤§ç¿”æ´‹ã«ã‚‚å‹åˆ©ã™ã‚‹ãªã©ä»Šå¤§ä¼šã®å„ªå‹å€™è£œã¨è¨€ã£ã¦ã‚‚éè¨€ã§ã¯ãªã„",
        coach: { name: 'é°¯æ°´ ç­‰', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "æµœæ¾å·¥æ¥­": {
        name_yomi: "ã¯ã¾ã¾ã¤ã“ã†ãã‚‡ã†",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 64,
        best: "ç”²å­åœ’ãƒ™ã‚¹ãƒˆ8",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ç´„30å¹´å‰ã«ç”²å­åœ’ãƒ™ã‚¹ãƒˆ8ã«é€²å‡ºã—ã€ã€Œæµœå·¥æ—‹é¢¨ã€ã‚’å·»ãèµ·ã“ã—ãŸã“ã¨ã§çŸ¥ã‚‰ã‚Œã‚‹ã€‚è¿‘å¹´ã¯ä½è¿·ã—ã¦ã„ãŸãŒã€å½“æ™‚ã®ã‚¨ãƒ¼ã‚¹ã ã£ãŸé’è‘‰ãŒç›£ç£ã«å°±ä»»ã—ã€å†å»ºã«ä¹—ã‚Šå‡ºã—ãŸã€‚ã‹ã¤ã¦ã®è‹±é›„ã®å¸°é‚„ã«ã€OBã‚„åœ°å…ƒã®æœŸå¾…ã‚‚é«˜ã¾ã£ã¦ã„ã‚‹ã€‚æ–°ã—ã„ä¸–ä»£ã®é¸æ‰‹ãŸã¡ã¨å…±ã«ã€å†ã³è–åœ°ã‚’ç›®æŒ‡ã™ã€‚ã€‚",
        coach: { name: 'é’è‘‰ å¥å¸', style: 'è‚²æˆä¸Šæ‰‹', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "ä¼Šè±†ç·åˆ": {
        name_yomi: "ã„ãšãã†ã”ã†",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 43,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "ã‚¨ãƒ¼ã‚¹ã¯æœ€é€Ÿï¼‘ï¼“ï¼–ã‚­ãƒ­ã®åŠ›ã®ã‚ã‚‹ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã§å‹è² ã™ã‚‹ã€‚æ‰“æ’ƒé™£ã«æ´¾æ‰‹ã•ã¯ãªã„ã‚‚ã®ã®èµ°å¡ã‚„æˆ¦è¡“ã«ç£¨ãã‚’ã‹ã‘ã€è¶³ã‚Šãªã„é•·æ‰“åŠ›ã‚’ã‚«ãƒãƒ¼ã™ã‚‹ã€‚è½ã¡ç€ã„ãŸé›°å›²æ°—ã§é‡çƒã«å–ã‚Šçµ„ã‚“ã§ã„ã‚‹ã€‚å°¾å³¶å¤ªéƒç›£ç£ã®æŒ‡å°ã¯ã€å …å®Ÿãªå®ˆå‚™ã¨ç¢ºå®Ÿãªãƒãƒ³ãƒˆãªã©ã‚’é‡è¦–ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã€‚æ´¾æ‰‹ã•ã¯ãªã„ãŒã€å¤§å´©ã‚Œã—ãªã„å®‰å®šæ„ŸãŒã‚ã‚‹ã€‚ã€‚",
        coach: { name: 'å°¾å³¶ å¤ªéƒ', style: 'å®ˆå‚™é‡è¦–', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "å¯Œå£«å®®è¥¿": {
        name_yomi: "ãµã˜ã®ã¿ã‚„ã«ã—",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 88,
        best: "ç”²å­åœ’ãƒ™ã‚¹ãƒˆ16",
        last: "åˆæˆ¦æ•—é€€",
        info: "ç´„30å¹´å‰ã«ç”²å­åœ’å‡ºå ´çµŒé¨“ã®ã‚ã‚‹å¤è±ªã€‚è¿‘å¹´ã¯ç§ç«‹æ ¡ã®å°é ­ã«æŠ¼ã•ã‚Œã€ä¸Šä½é€²å‡ºã‹ã‚‰é ã–ã‹ã£ã¦ã„ã‚‹ã€‚OBã‚„åœ°å…ƒãƒ•ã‚¡ãƒ³ã®ã€Œå¾©æ´»ã‚’ã€ã¨ã„ã†æœŸå¾…ãŒã€æ™‚ã«é¸æ‰‹ãŸã¡ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã«ãªã‚‹ã“ã¨ã‚‚ã€‚ãƒ™ãƒ†ãƒ©ãƒ³æ‹³å´ç›£ç£ã¯ã€é¸æ‰‹ãŸã¡ãŒæ°—è² ã‚ãšã«å®ŸåŠ›ã‚’ç™ºæ®ã§ãã‚‹ç’°å¢ƒä½œã‚Šã«åŠªã‚ã¦ã„ã‚‹ã€‚",
        coach: { name: 'æ‹³å´ å²éƒ', style: 'ç©æ¥µæ‰“æ’ƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "å¯Œå£«å¸‚ç«‹": {
        name_yomi: "ãµã˜ã„ã¡ã‚Šã¤",
        region: "æ±éƒ¨",
        type: "ç§ç«‹",
        deviation: 81,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ã‚»ã‚¤ãƒãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ã„ã¡æ—©ãå°å…¥ã—ã€ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸé‡çƒã‚’å¾¹åº•ã™ã‚‹ç§ç«‹æ ¡ã€‚èµ¤å¶ºç›£ç£ã®é‡‡é…ã¯ã€é¸æ‰‹ã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚„ç›¸æ‰‹ã¨ã®ç›¸æ€§ãªã©ã€ã‚ã‚‰ã‚†ã‚‹æƒ…å ±ã‚’åˆ†æã—ãŸä¸Šã§æ±ºå®šã•ã‚Œã‚‹ã€‚ãã®åˆç†çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€æ™‚ã«éæƒ…ã¨ã‚‚æ˜ ã‚‹ãŒã€ç€å®Ÿã«çµæœã‚’æ®‹ã—ã¦ã„ã‚‹ã€‚",
        coach: { name: 'èµ¤å¶º è­²äºŒ', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'ä¸­å …' }
    },
    "ã‚ªã‚¤ã‚¹ã‚«æµœæ¾å›½éš›": {
        name_yomi: "ãŠã„ã™ã‹ã¯ã¾ã¾ã¤ã“ãã•ã„",
        region: "è¥¿éƒ¨",
        type: "ç§ç«‹",
        deviation: 59,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4",
        last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "çœŒå†…ã‚’ç‰›è€³ã‚‹å·¨å¤§è³‡æœ¬ã€ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã€ã«å¯¾æŠ—ã™ã¹ãã€åœ°å…ƒã®æœ‰å¿—ã€ã‚ªã‚¤ã‚¹ã‚«ã‚°ãƒ«ãƒ¼ãƒ—ã€ãŒè¨­ç«‹ã—ãŸç•°è‰²ã®é«˜æ ¡ã€‚æ½¤æ²¢ãªè³‡é‡‘ã‚’æŒã¤ãƒŠãƒ ã‚³ç³»åˆ—æ ¡ã¨ã¯å¯¾ç…§çš„ã«ã€å½¼ã‚‰ãŒæŒã¤ã®ã¯åéª¨ç²¾ç¥ã¨çµæŸåŠ›ã ã‘ã ã€‚ã€Œä¼èª¬ã€ã¨ç§°ã•ã‚Œã‚‹æ¡ç”Ÿç›£ç£ã®æŒ‡å°ã¯ã€æŠ€è¡“ã‚ˆã‚Šã‚‚ç²¾ç¥çš„ãªå¼·ã•ã‚’é‡è¦–ã™ã‚‹ã€‚ãã®ç†±ã„ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ã¨åéª¨ç²¾ç¥ã¯å¤šãã®ãƒ•ã‚¡ãƒ³ã‚’æƒ¹ãã¤ã‘ã¦ãŠã‚Šã€å¤§ä¼šã®æ³¢ä¹±è¦å› ã¨ã—ã¦æ³¨ç›®ã•ã‚Œã¦ã„ã‚‹ã€‚",
        coach: { name: 'æ¡ç”Ÿ ä¸€é¦¬', style: 'æ ¹æ€§é‡çƒ', experience: 'ä¼èª¬' }
    },
    "æ–°å±…": {
        name_yomi: "ã‚ã‚‰ã„",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 48,
        best: "çœŒå¤§ä¼šåˆæˆ¦æ•—é€€",
        last: "åˆæˆ¦æ•—é€€",
        info: "å¤ã®å¤§ä¼šã€å…¬å¼æˆ¦é€šç®—0å‹32æ•—ã€‚ãã‚ŒãŒã“ã®å­¦æ ¡ã®æ­´å²ã®å…¨ã¦ã ã€‚é•·å¹´å…¬å¼æˆ¦ã§ã®å‹åˆ©ã‹ã‚‰é ã–ã‹ã£ã¦ãŠã‚Šã€éƒ¨å“¡æ•°ã‚‚å¸¸ã«ã‚®ãƒªã‚®ãƒªã¨ã„ã†å³ã—ã„çŠ¶æ³ãŒç¶šãå…¬ç«‹æ ¡ã€‚ç·´ç¿’ç’°å¢ƒã‚‚æµã¾ã‚Œã¦ã„ã‚‹ã¨ã¯è¨€ãˆãªã„ãŒã€é¸æ‰‹ãŸã¡ã¯é‡çƒãŒå¥½ãã ã¨ã„ã†ç´”ç²‹ãªæ°—æŒã¡ã§ç™½çƒã‚’è¿½ã„ç¶šã‘ã¦ã„ã‚‹ã€‚ãƒãƒ¼ãƒ ã®æ‚²é¡˜ã¯ã€ã¾ãšã€Œå…¬å¼æˆ¦ã§ä¸€å‹ã€ã‚’æŒ™ã’ã‚‹ã“ã¨ã€‚ãã®ç¬é–“ã«å‘ã‘ã¦ã€ã²ãŸã‚€ããªåŠªåŠ›ã‚’é‡ã­ã‚‹ã€‚",
        coach: { name: 'ç”°ä¸­ ä¸€éƒ', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "éŸ®å±±": {
        name_yomi: "ã«ã‚‰ã‚„ã¾",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 88,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "åˆæˆ¦æ•—é€€",
        info: "çœŒã®ã‚·ãƒ³ãƒœãƒ«ã€ä¼Šè±†å±±ã€ã®éº“ã«ã‚ã‚‹çœŒå†…å±ˆæŒ‡ã®é€²å­¦æ ¡ã€‚å½¼ã‚‰ã®åç‰©ã¯ã€é™ºã—ã„å±±é“ã‚’æ¯æ—¥é§†ã‘ä¸ŠãŒã‚‹åœ°ç„ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã ã€‚ãã‚Œã§é›ãˆä¸Šã’ã‚‰ã‚ŒãŸå¼·é­ãªè¶³è…°ã¯ã€ä»–æ ¡ã®è„…å¨ã€‚ãƒ™ãƒ†ãƒ©ãƒ³å±±è·¯ç›£ç£ãŒç‡ã„ã‚‹æ©Ÿå‹•åŠ›é‡çƒã¯ã€ä¸€åº¦å‡ºå¡ã‚’è¨±ã™ã¨æ­¢ã¾ã‚‰ãªã„ã€‚å±±ã®æ°‘ã®èª‡ã‚Šã‚’èƒ¸ã«ã€ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’åµã®ã‚ˆã†ã«é§†ã‘å·¡ã‚‹ã€‚",
        coach: { name: 'å±±è·¯ å’Œå¼˜', style: 'æ©Ÿå‹•åŠ›é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "é™å²¡å­¦åœ’": {
        name_yomi: "ã—ãšãŠã‹ãŒããˆã‚“",
        region: "ä¸­éƒ¨",
        type: "ç§ç«‹",
        deviation: 61,
        best: "ç”²å­åœ’å‡ºå ´",
        last: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        info: "å‰µéƒ¨19å¹´ã®æ–°èˆˆå‹¢åŠ›ãªãŒã‚‰ã€ç”²å­åœ’å‡ºå ´çµŒé¨“ã‚’æŒã¤å®ŸåŠ›æ ¡ã€‚ã—ã‹ã—æ›´ãªã‚‹é£›èºã®ãŸã‚ã€å­¦æ ¡ã¯å¤§ããªè³­ã‘ã«å‡ºãŸã€‚ã‹ã¤ã¦å¸ç‹å®Ÿæ¥­ã‚’ç”²å­åœ’5é€£è¦‡ã«å°ã„ãŸä¼èª¬ã®åå°†ãƒ»åœ‹æ‘ç›£ç£ã‚’æ‹›è˜ã—ãŸã®ã ã€‚è¦å¾‹ã‚’é‡ã‚“ã˜ã‚‹ãƒ™ãƒ†ãƒ©ãƒ³ç›£ç£ã®ä¸‹ã€æ‰èƒ½ã‚ã‚‹é¸æ‰‹ãŸã¡ãŒã©ã†èåˆã™ã‚‹ã®ã‹ã€å„ªå‹å€™è£œã®ä¸€è§’ã¨ã—ã¦å¤§ããªæ³¨ç›®ã‚’é›†ã‚ã¦ã„ã‚‹ã€‚ã€‚",
        coach: { name: 'åœ‹æ‘ éš¼', style: 'ç·åˆåŠ›', experience: 'åå°†' }
    },
    "å¸‚ç«‹æ²¼æ´¥": {
        name_yomi: "ã„ã¡ã‚Šã¤ã¬ã¾ã¥",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 82,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "åˆæˆ¦æ•—é€€",
        info: "å…¨å›½ãƒ¬ãƒ™ãƒ«ã®å¹å¥æ¥½éƒ¨ãŒå¥ã§ã‚‹å¿œæ´ã¯ã€å¸‚æ²¼ã‚µã‚¦ãƒ³ãƒ‰ã€ã¨ã—ã¦æœ‰åã€‚ãã®ç¾ã—ãã‚‚åŠ›å¼·ã„éŸ³åœ§ã¯ã€ç›¸æ‰‹ãƒãƒ¼ãƒ ã®é›†ä¸­åŠ›ã‚’å‰Šãã€å‘³æ–¹ã‚’é¼“èˆã™ã‚‹ã€‚ãƒ™ãƒ†ãƒ©ãƒ³çŒ«åˆç›£ç£ãŒç‡ã„ã‚‹ãƒãƒ¼ãƒ ã¯ã€ãã®å¿œæ´ã‚’ãƒãƒƒã‚¯ã«ã€ç²˜ã‚Šå¼·ã„å®ˆå‚™ã§ãƒªã‚ºãƒ ã‚’ä½œã‚‹ã€‚æ´¾æ‰‹ãªé¸æ‰‹ã¯ã„ãªã„ãŒã€ç¹‹ãæ„è­˜ã¯çœŒå†…éšä¸€ã€‚éŸ³ã®é­”è¡“å¸«ãŸã¡ãŒã€é™ã‹ã«ã€ã—ã‹ã—ç¢ºå®Ÿã«ç›¸æ‰‹ã‚’è¿½ã„è©°ã‚ã¦ã„ãã€‚",
        coach: { name: 'çŒ«åˆ è‚²å²', style: 'å®ˆå‚™é‡è¦–', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æ²¼æ´¥åŸåŒ—": {
        name_yomi: "ã¬ã¾ã¥ã˜ã‚‡ã†ã»ã",
        region: "æ±éƒ¨",
        type: "å…¬ç«‹",
        deviation: 55,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "ç”Ÿå¾’ã®è‡ªä¸»æ€§ã‚’é‡ã‚“ã˜ã‚‹è‡ªç”±ãªæ ¡é¢¨ã§çŸ¥ã‚‰ã‚Œã‚‹å…¬ç«‹æ ¡ã€‚é‡çƒéƒ¨ã‚‚è¥¿å£ç›£ç£ã®æŒ‡å°æ–¹é‡ã®ä¸‹ã€é¸æ‰‹ãŸã¡ãŒè‡ªã‚‰ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚„æˆ¦è¡“ã‚’è€ƒãˆã‚‹ã€Œè€ƒãˆã‚‹é‡çƒã€ã‚’å®Ÿè·µã—ã¦ã„ã‚‹ã€‚ãã®å‹ã«ã¯ã¾ã‚‰ãªã„ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ã¯ã€æ™‚ã«ã‚»ã‚ªãƒªãƒ¼ã‚’è¦†ã™å¤§ããªæ³¢ä¹±ã‚’å·»ãèµ·ã“ã™å¯èƒ½æ€§ã‚’ç§˜ã‚ã¦ã„ã‚‹ã€‚",
        coach: { name: 'è¥¿å£ å¥ˆã€…', style: 'å¥‡ç­–', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "ä¸‹ç”°": {
        name_yomi: "ã—ã‚‚ã ",
        region: "ä¼Šè±†",
        type: "å…¬ç«‹",
        deviation: 50,
        best: "çœŒå¤§ä¼šåˆæˆ¦æ•—é€€",
        last: "åˆæˆ¦æ•—é€€",
        info: "éç–åŒ–ãŒé€²ã‚€é™ã‹ãªæ¸¯ã®ç”ºã€‚å…¨æ ¡ç”Ÿå¾’80äººã€é‡çƒéƒ¨å“¡ã¯å¥‡è·¡çš„ã«é›†ã¾ã£ãŸãŒã€ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã¯é›‘è‰ãŒç”Ÿã„èŒ‚ã‚Šã€ç·´ç¿’ã¯ç´…ç™½æˆ¦ã‚‚ã§ããšã€ç›£ç£ãŒæ‰“ã¤ãƒœãƒ¼ãƒ«ã‚’ãŸã å»¶ã€…ã¨è¿½ã„ã‹ã‘ã‚‹ã ã‘ã€‚æ˜¨å¹´ã€ç”ºã§å”¯ä¸€ã®ã‚¹ãƒãƒ¼ãƒ„ç”¨å“åº—ãŒã‚·ãƒ£ãƒƒã‚¿ãƒ¼ã‚’ä¸‹ã‚ã—ã€ä»Šã¯ç ´ã‚ŒãŸãƒœãƒ¼ãƒ«ã‚’è‡ªåˆ†ãŸã¡ã§ç¸«ã£ã¦ä½¿ã†ã—ã‹ãªã„ã€‚ç”ºã®å¤§äººãŸã¡ã¯ã€å½¼ã‚‰ãŒé‡çƒã‚’ã—ã¦ã„ã‚‹ã“ã¨ã™ã‚‰çŸ¥ã‚‰ãªã„ã‹ã‚‚ã—ã‚Œãªã„ã€‚æ¶ˆãˆã‚†ãç”ºã§ã€èª°ã«ã‚‚çŸ¥ã‚‰ã‚Œãšæ¶ˆãˆã¦ã„ãé‡çƒéƒ¨ã€‚å½¼ã‚‰ãŒå¤ã®å¤§ä¼šã«å‡ºå ´ã™ã‚‹ã®ã¯ã€å‹åˆ©ã®ãŸã‚ã§ã¯ãªã„ã€‚è‡ªåˆ†ãŸã¡ãŒã€ä¸‹ç”°é«˜æ ¡é‡çƒéƒ¨ã€ã¨ã—ã¦ç¢ºã‹ã«ã“ã“ã«å­˜åœ¨ã—ãŸã¨ã„ã†ã€ãŸã£ãŸä¸€ã¤ã®è¨¼ã‚’å¤ã®é’ç©ºã«åˆ»ã¿è¾¼ã‚€ãŸã‚ã ã‘ã®ã€ã‚ã¾ã‚Šã«ã‚‚åˆ‡ãªã„æˆ¦ã„ã ã€‚",
        coach: { name: 'æ°´ä¸Š å–„æ¬¡', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "æ¹–è¥¿": {
        name_yomi: "ã“ã•ã„",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 77,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8",
        last: "åˆæˆ¦æ•—é€€",
        info: "å¤§ä¼šã”ã¨ã«æˆç¸¾ãŒå¤§ããå¤‰å‹•ã™ã‚‹ã€ãƒ ãƒ©ãƒƒæ°—ã®ã‚ã‚‹ãƒãƒ¼ãƒ ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹ã€‚ä¸Šä½é€²å‡ºçµŒé¨“ã‚‚ã‚ã‚Šãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã¯é«˜ã„ãŒã€æ ¼ä¸‹ç›¸æ‰‹ã¸ã®å–ã‚Šã“ã¼ã—ã‚‚å°‘ãªããªã„ã€‚ãƒ™ãƒ†ãƒ©ãƒ³æµ·é‡ç›£ç£ã¯ã€é•·å¹´ã®èª²é¡Œã§ã‚ã‚‹ç²¾ç¥çš„ãªå®‰å®šæ„Ÿã‚’ãƒãƒ¼ãƒ ã«ã‚‚ãŸã‚‰ãã†ã¨æŒ‡å°ã€‚ä»Šå¤§ä¼šã§å®‰å®šã—ãŸæˆ¦ã„ã¶ã‚Šã‚’è¦‹ã›ã‚‰ã‚Œã‚‹ã‹ãŒèºé€²ã®éµã¨ãªã‚‹ã€‚ã€‚",
        coach: { name: 'æµ·é‡ å¹³', style: 'æ©Ÿå‹•åŠ›é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "ç†±æµ·": {
        name_yomi: "ã‚ãŸã¿",
        region: "ä¼Šè±†",
        type: "å…¬ç«‹",
        deviation: 46,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "åˆæˆ¦æ•—é€€",
        info: "å‰µç«‹70å¹´ã‚’è¿ãˆã‚‹åœ°åŸŸã®ä¼çµ±æ ¡ã ãŒã€è¿‘å¹´ã¯éç–åŒ–ã®æ³¢ã«é£²ã¾ã‚Œã€æ´»æ°—ã‚’å¤±ã„ã¤ã¤ã‚ã‚‹ã€‚é‡çƒéƒ¨ã®æ´»èºã¯ã€ç”ºã«æ®‹ã•ã‚ŒãŸæ•°å°‘ãªã„å¸Œæœ›ã ã€‚ã€ä¿ºãŸã¡ãŒå‹ã¦ã°ã€ç”ºãŒå…ƒæ°—ã«ãªã‚‹ã€ã€‚ãã®æƒ³ã„ã‚’èƒ¸ã«ã€é¸æ‰‹ãŸã¡ã¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç«‹ã¤ã€‚é¸æ‰‹ã¯å…¨å“¡ãŒåœ°å…ƒå‡ºèº«ã€‚è‚²æˆã«å®šè©•ã®ã‚ã‚‹æ ¹æœ¬ç›£ç£ã®ä¸‹ã€éƒ·åœŸæ„›ã‚’åŠ›ã«å¤‰ãˆã¦æˆ¦ã†ã€‚ãã®ã²ãŸã‚€ããªãƒ—ãƒ¬ãƒ¼ã«ã¯ã€å¤šãã®åœ°å…ƒãƒ•ã‚¡ãƒ³ãŒã¤ã„ã¦ã„ã‚‹ã€‚åœ°å…ƒå‡ºèº«ã®é¸æ‰‹ãŸã¡ãŒã€æ„›ã™ã‚‹æ•…éƒ·ã«å‹åˆ©ã‚’å±Šã‘ã‚‹ã€‚",
        coach: { name: 'æ ¹æœ¬ é™¸å¤«', style: 'è‚²æˆä¸Šæ‰‹', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "é™å²¡å¸‚ç«‹": {
        name_yomi: "ã—ãšãŠã‹ã„ã¡ã‚Šã¤",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 83,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16",
        last: "åˆæˆ¦æ•—é€€",
        info: "æ¯å¹´æŠ•æ‰“ã«ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸå¥½ãƒãƒ¼ãƒ ã‚’ç·¨æˆã™ã‚‹ãŒã€ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®çµ„ã¿åˆã‚ã›ã«æµã¾ã‚Œãšã€å®ŸåŠ›ä»¥ä¸Šã®çµæœã‚’æ®‹ã›ã¦ã„ãªã„ã€Œæ‚²é‹ã®å…¬ç«‹æ ¡ã€ã€‚äº•ä¸Šç›£ç£ã¯ã©ã‚“ãªç›¸æ‰‹ã«ã‚‚è‡ªåˆ†ãŸã¡ã®é‡çƒã‚’è²«ãã“ã¨ã‚’é¸æ‰‹ã«æ±‚ã‚ã‚‹ã€‚ä»Šå¹´ã“ãã€å³ã—ã„çµ„ã¿åˆã‚ã›ã‚’ä¹—ã‚Šè¶Šãˆã¦ä¸Šä½é€²å‡ºã‚’æœãŸã—ãŸã„ã€‚ã€‚",
        coach: { name: 'äº•ä¸Š å’Œå½¦', style: 'ç·åˆåŠ›', experience: 'ä¸­å …' }
    },
    "åŸå—é™å²¡": {
        name_yomi: "ã˜ã‚‡ã†ãªã‚“ã—ãšãŠã‹",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 59,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4",
        last: "åˆæˆ¦æ•—é€€",
        info: "ã‹ã¤ã¦çœŒãƒ™ã‚¹ãƒˆ4ã®å®Ÿç¸¾ã‚’æŒã¤å…¬ç«‹ã®å®ŸåŠ›æ ¡ã€‚æ˜¨å¹´ã®åˆæˆ¦æ•—é€€ã®å±ˆè¾±ã‹ã‚‰ã€ãƒãƒ¼ãƒ ã¯ã€ŒåŸç‚¹å›å¸°ã€ã‚’ãƒ†ãƒ¼ãƒã«ä¼çµ±ã®ç©æ¥µæ‰“æ’ƒã‚’å¾¹åº•çš„ã«ç£¨ãç›´ã—ãŸã€‚ä¼Šè—¤ç›£ç£ã®ä¸‹ã€å¤è±ªå¾©æ´»ã‚’ç›®æŒ‡ã™ãƒãƒ¼ãƒ ã®å£«æ°—ã¯é«˜ã„ã€‚ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã‹ã‚‰ã®ä¸‹å‰‹ä¸Šã‚’ç‹™ã†ã€‚ã€‚",
        coach: { name: 'ä¼Šè—¤ å¥å¤ªéƒ', style: 'ç©æ¥µæ‰“æ’ƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æµœæ¾å—": {
        name_yomi: "ã¯ã¾ã¾ã¤ã¿ãªã¿",
        region: "è¥¿éƒ¨",
        type: "å…¬ç«‹",
        deviation: 56,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "è¿‘å¹´ã€æ ¡èˆãŒæ–°ç¯‰ã•ã‚Œã€ç·´ç¿’ç’°å¢ƒãŒå¤§å¹…ã«æ”¹å–„ã•ã‚ŒãŸå…¬ç«‹æ ¡ã€‚å­¦æ ¡å…¨ä½“ã®æœŸå¾…ãŒé«˜ã¾ã‚‹ä¸­ã€æœŸå¾…ã®è‹¥æ‰‹ãƒ»é«˜æœ¨ç›£ç£ãŒãƒãƒ¼ãƒ ã‚’ç‡ã„ã‚‹ã€‚ã¾ã ç›®ç«‹ã£ãŸå®Ÿç¸¾ã¯ãªã„ãŒã€æœ€æ–°ã®è¨­å‚™ã¨æ–°ã—ã„ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ã§å¿ƒæ©Ÿä¸€è»¢ã€æ–°ãŸãªæ­´å²ã‚’ä½œã‚‹ã¹ãä»Šå¤§ä¼šã«æŒ‘ã‚€ã€‚ã€‚",
        coach: { name: 'é«˜æœ¨ æ¸‰', style: 'è‚²æˆä¸Šæ‰‹', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "å³¶ç”°": {
        name_yomi: "ã—ã¾ã ",
        region: "ä¸­éƒ¨",
        type: "å…¬ç«‹",
        deviation: 53,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "å¤§æ­£8å¹´å‰µç«‹ã¨ã„ã†é•·ã„æ­´å²ã‚’æŒã¤ä¼çµ±æ ¡ã ãŒã€è¿‘å¹´ã¯éƒ¨å“¡ä¸è¶³ã‹ã‚‰é€£åˆãƒãƒ¼ãƒ ã‚’çµ„ã‚€ãªã©ã€è‹¦ã—ã„æ™‚æœŸãŒç¶šã„ã¦ã„ã‚‹ã€‚ä»Šå­£ã‹ã‚‰å†ã³å˜ç‹¬ãƒãƒ¼ãƒ ã¨ã—ã¦å‡ºå ´ã™ã‚‹ãŒã€æˆ¦åŠ›ã¯ã¾ã æ•´ã£ã¦ã„ãªã„ã€‚ã¾ãšã¯å¤§ä¼šã§ä¸€å‹ã‚’æŒ™ã’ã€ãƒãƒ¼ãƒ ã®æ–°ãŸãªä¸€æ­©ã‚’è¸ã¿å‡ºã™ã“ã¨ãŒç›®æ¨™ã¨ãªã‚‹ã€‚ã€‚",
        coach: { name: 'å³¶æœ¬ å®', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "ä¼Šè±†ä¸­å¤®": {
        name_yomi: "ã„ãšã¡ã‚…ã†ãŠã†",
        region: "ä¼Šè±†",
        type: "å…¬ç«‹",
        deviation: 51,
        best: "çœŒå¤§ä¼š2å›æˆ¦",
        last: "åˆæˆ¦æ•—é€€",
        info: "é•·å¹´ã®éƒ¨å“¡ä¸è¶³ã‹ã‚‰æ˜¨å¹´ã¾ã§é€£åˆãƒãƒ¼ãƒ ã¨ã—ã¦å‡ºå ´ã—ã¦ã„ãŸãŒã€ä»Šå¹´ã‹ã‚‰å¾…æœ›ã®å˜ç‹¬å‡ºå ´ã‚’æœãŸã™ã€‚éƒ¨å“¡ã®å¤šããŒé‡çƒçµŒé¨“ã®æµ…ã„1å¹´ç”Ÿã§ã€ãƒãƒ¼ãƒ ã¯ã¾ã ç™ºå±•é€”ä¸Šã€‚ä¸­ç”°ç›£ç£ã¯ã€ã¾ãšã¯å…¬å¼æˆ¦ã§æˆ¦ã†çµŒé¨“ã‚’ç©ã¾ã›ã€ãƒãƒ¼ãƒ ã®åœŸå°ä½œã‚Šã‚’é€²ã‚ã¦ã„ã‚‹æ®µéšã€‚ä»Šå¤§ä¼šã¯æœªæ¥ã¸ã®ç¬¬ä¸€æ­©ã¨ãªã‚‹ã€‚ã€‚",
        coach: { name: 'ä¸­ç”° å³¶è”µ', style: 'å…¨å“¡é‡çƒ', experience: 'ä¸­å …' }
    },
"æµœæ¾ä¿®å­¦èˆ": {
        name_yomi: "ã¯ã¾ã¾ã¤ã—ã‚…ã†ãŒãã—ã‚ƒ", region: "è¥¿éƒ¨", type: "ç§ç«‹", deviation: 70,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8", last: "çœŒå¤§ä¼š3å›æˆ¦",
        info: "è¿‘å¹´æ€¥é€Ÿã«åŠ›ã‚’ã¤ã‘ã¦ã„ã‚‹ç§ç«‹æ ¡ã€‚è±Šå¯Œãªç·´ç¿’é‡ã¨ã€Œä¿®å­¦èˆãƒ¡ã‚½ãƒƒãƒ‰ã€ã¨å‘¼ã°ã‚Œã‚‹ç‹¬è‡ªã®è‚²æˆæ³•ã§ã€ä¸Šä½ã‚’è™è¦–çœˆã€…ã¨ç‹™ã†ã€‚",
        coach: { name: 'é«˜æ©‹ æ­£å’Œ', style: 'ç·åˆåŠ›', experience: 'ä¸­å …' }
    },
    "æµœæ¾æ—¥ä½“": {
        name_yomi: "ã¯ã¾ã¾ã¤ã«ã£ãŸã„", region: "è¥¿éƒ¨", type: "ç§ç«‹", deviation: 58,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8", last: "çœŒå¤§ä¼š3å›æˆ¦",
        info: "æ–‡æ­¦ä¸¡é“ã‚’æ²ã’ã‚‹ç§ç«‹æ ¡ã€‚å®‰å®šã—ãŸå®ŸåŠ›ã‚’æŒã¡ã€æ¯å¹´ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆä¸­ç›¤ã®å£ã¨ãªã‚‹ã€‚",
        coach: { name: 'æ¸¡è¾º å¾¹', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "æ›å·å·¥æ¥­": {
        name_yomi: "ã‹ã‘ãŒã‚ã“ã†ãã‚‡ã†", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 93,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "æ›å·è¥¿ã€æ›å·æ±ã¨ã¯ç•°ãªã‚‹ã€å·¥æ¥­é«˜æ ¡ã‚‰ã—ã„å®Ÿç›´ãªé‡çƒãŒæŒã¡å‘³ã€‚",
        coach: { name: 'æ›å¸ƒ é›…ä¹‹', style: 'ç©æ¥µæ‰“æ’ƒ', experience: 'ãƒ—ãƒ­OB' }
    },
    "æ¸…æ°´æ±": {
        name_yomi: "ã—ã¿ãšã²ãŒã—", region: "ä¸­éƒ¨", type: "å…¬ç«‹", deviation: 68,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "å…¨å›½ã«åã‚’è½Ÿã‹ã›ã‚‹ã‚µãƒƒã‚«ãƒ¼éƒ¨ã®å½±ã«éš ã‚ŒãŒã¡ã ãŒã€é‡çƒéƒ¨ã‚‚çœŒå†…å±ˆæŒ‡ã®é€²å­¦æ ¡ã¨ã—ã¦çŸ¥æ€§æº¢ã‚Œã‚‹ãƒ—ãƒ¬ãƒ¼ã‚’è¦‹ã›ã‚‹ã€‚",
        coach: { name: 'é•·è°·éƒ¨ èª ', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "å³¶ç”°æ¨Ÿèª ": {
        name_yomi: "ã—ã¾ã ã—ã‚‡ã†ã›ã„", region: "ä¸­éƒ¨", type: "ç§ç«‹", deviation: 95,
        best: "çœŒå¤§ä¼š3å›æˆ¦", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "è¿‘å¹´ã€é‡çƒéƒ¨ã®å¼·åŒ–ã«åŠ›ã‚’å…¥ã‚Œã¦ã„ã‚‹ç§ç«‹æ ¡ã€‚ç²˜ã‚Šå¼·ã„æˆ¦ã„ãŒæŒã¡å‘³ã€‚",
        coach: { name: 'ä½ã€…æœ¨ æ­ä»‹', style: 'ç·åˆåŠ›', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "å¯Œå£«å®®æ±": {
        name_yomi: "ãµã˜ã®ã¿ã‚„ã²ãŒã—", region: "æ±éƒ¨", type: "å…¬ç«‹", deviation: 73,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "å¯Œå£«å±±éº“ã®åœ°å…ƒé¸æ‰‹ã§æ§‹æˆã•ã‚ŒãŸãƒãƒ¼ãƒ ã€‚åœ°ã®åˆ©ã‚’æ´»ã‹ã—ãŸæˆ¦ã„ã‚’ã—ãŸã„ã€‚",
        coach: { name: 'å·¥è—¤ å…¬åº·', style: 'æŠ•æ‰‹ä¸­å¿ƒ', experience: 'ãƒ—ãƒ­OB' }
    },
    "æµœå": {
        name_yomi: "ã¯ã¾ãª", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 55,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4", last: "çœŒå¤§ä¼š3å›æˆ¦",
        info: "ã€Œæµœåã‚¹ãƒã‚¤ãƒ«ã€ã‚’åˆè¨€è‘‰ã«ã€å¸¸ã«å…¨åŠ›ç–¾èµ°ã¨ç¬‘é¡”ã‚’çµ¶ã‚„ã•ãªã„å¥½ãƒãƒ¼ãƒ ã€‚å…¬ç«‹æ ¡ãªãŒã‚‰å®‰å®šã—ã¦ä¸Šä½ã«é€²å‡ºã™ã‚‹å®ŸåŠ›ã‚’æŒã¤ã€‚",
        coach: { name: 'å±±ç”° å¤ªéƒ', style: 'å…¨å“¡é‡çƒ', experience: 'ä¸­å …' }
    },
    "æ›å·æ±": {
        name_yomi: "ã‹ã‘ãŒã‚ã²ãŒã—", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 63,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8", last: "çœŒå¤§ä¼š3å›æˆ¦",
        info: "æ–‡æ­¦ä¸¡é“ã‚’æ²ã’ã‚‹é€²å­¦æ ¡ã€‚æ›å·è¥¿ã®ãƒ©ã‚¤ãƒãƒ«æ ¡ã®ä¸€ã¤ã¨ã—ã¦ã€å®‰å®šã—ãŸå®ŸåŠ›ã‚’æŒã¤ã€‚",
        coach: { name: 'æ±å±± ç´€ä¹‹', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "å³¶ç”°å•†æ¥­": {
        name_yomi: "ã—ã¾ã ã—ã‚‡ã†ãã‚‡ã†", region: "ä¸­éƒ¨", type: "å…¬ç«‹", deviation: 72,
        best: "ç”²å­åœ’å‡ºå ´", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ã€Œå³¶å•†ï¼ˆã—ã¾ã—ã‚‡ã†ï¼‰ã€ã®æ„›ç§°ã§çŸ¥ã‚‰ã‚Œã‚‹å¤è±ªã€‚è¿‘å¹´ã¯ä¸­å …ã«ç”˜ã‚“ã˜ã¦ã„ã‚‹ãŒã€ä¼çµ±ã®å …å®Ÿãªã€Œå³¶å•†é‡çƒã€ã§å¾©æ´»ã‚’ç›®æŒ‡ã™ã€‚",
        coach: { name: 'æ± è°· å¹¸é›„', style: 'å …å®Ÿ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æ¸…æ°´æ¡œãŒä¸˜": {
        name_yomi: "ã—ã¿ãšã•ãã‚‰ãŒãŠã‹", region: "ä¸­éƒ¨", type: "å…¬ç«‹", deviation: 77,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æ¸…æ°´å•†æ¥­ã¨åºµåŸé«˜æ ¡ã®çµ±åˆæ ¡ã€‚ã‚µãƒƒã‚«ãƒ¼éƒ¨ãŒæœ‰åã ãŒã€é‡çƒéƒ¨ã‚‚ã€Œæ¸…å•†ï¼ˆã‚­ãƒ¨ã‚·ãƒ§ã‚¦ï¼‰ã€æ™‚ä»£ã®å‹è² å¼·ã•ã‚’å—ã‘ç¶™ãã€‚",
        coach: { name: 'å¤§æ¦ å…‹å·±', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "æ²¼æ´¥å•†æ¥­": {
        name_yomi: "ã¬ã¾ã¥ã—ã‚‡ã†ãã‚‡ã†", region: "æ±éƒ¨", type: "å…¬ç«‹", deviation: 79,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æ±éƒ¨ã®ä¼çµ±ã‚ã‚‹å•†æ¥­é«˜æ ¡ã€‚ç·»å¯†ãªãƒ‡ãƒ¼ã‚¿åˆ†æã¨æ©Ÿå‹•åŠ›ã‚’çµ¡ã‚ãŸã€Œè€ƒãˆã‚‹é‡çƒã€ãŒæŒã¡å‘³ã€‚",
        coach: { name: 'å°å®®å±± æ‚Ÿ', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "ç”°æ–¹è¾²æ¥­": {
        name_yomi: "ãŸãŒãŸã®ã†ãã‚‡ã†", region: "ä¼Šè±†", type: "å…¬ç«‹", deviation: 42,
        best: "çœŒå¤§ä¼š3å›æˆ¦", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ä¼Šè±†åœ°åŒºã®é›„ã€‚è¾²æ¥­å®Ÿç¿’ã§é›ãˆãŸä½“åŠ›ã¨ã€ç²˜ã‚Šå¼·ã•ãŒæŒã¡å‘³ã€‚ã€Œã‚¿ãƒã‚¦ã€ã®æ„›ç§°ã§è¦ªã—ã¾ã‚Œã‚‹ã€‚",
        coach: { name: 'æ¡‘ç”° çœŸæ¾„', style: 'è‚²æˆä¸Šæ‰‹', experience: 'ãƒ—ãƒ­OB' }
    },
    "æµœæ¾æ¹–å—": {
        name_yomi: "ã¯ã¾ã¾ã¤ã“ãªã‚“", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 54,
        best: "çœŒå¤§ä¼š3å›æˆ¦", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æ¯å¹´å®‰å®šã—ãŸåŠ›ã‚’æŒã¤ä¸­å …æ ¡ã€‚ä¸Šä½é€²å‡ºã‚’è™è¦–çœˆã€…ã¨ç‹™ã†ã€‚",
        coach: { name: 'å°æ— å¹¹è‹±', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "æ²¼æ´¥æ±": {
        name_yomi: "ã¬ã¾ã¥ã²ãŒã—", region: "æ±éƒ¨", type: "å…¬ç«‹", deviation: 69,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8", last: "çœŒå¤§ä¼š3å›æˆ¦",
        info: "æ±éƒ¨åœ°åŒºå±ˆæŒ‡ã®é€²å­¦æ ¡ã€‚ä¼çµ±çš„ã«ã€Œæ–‡æ­¦ä¸¡é“ã€ã‚’æ²ã’ã€çŸ¥çš„ãªãƒ—ãƒ¬ãƒ¼ã§ç›¸æ‰‹ã‚’ç¿»å¼„ã™ã‚‹ã€‚",
        coach: { name: 'å¤ç”° æ•¦ä¹Ÿ', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'ãƒ—ãƒ­OB' }
    },
    "å‰åŸ": {
        name_yomi: "ã‚ˆã—ã‚ã‚‰", region: "æ±éƒ¨", type: "å…¬ç«‹", deviation: 51,
        best: "çœŒå¤§ä¼š3å›æˆ¦", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "å¯Œå£«å¸‚ã‚’ä»£è¡¨ã™ã‚‹å…¬ç«‹æ ¡ã®ä¸€ã¤ã€‚ç²˜ã‚Šå¼·ã„å®ˆå‚™ã¨ã€ã¤ãªãæ‰“ç·šã§ä¸Šä½é€²å‡ºã‚’ç‹™ã†ã€‚",
        coach: { name: 'å‰äº• ç†äºº', style: 'æŠ•æ‰‹ä¸­å¿ƒ', experience: 'ä¸­å …' }
    },
    "æµœæ¾å¤§å¹³å°": {
        name_yomi: "ã¯ã¾ã¾ã¤ãŠãŠã²ã‚‰ã ã„", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 40,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "æ¯”è¼ƒçš„æ–°ã—ã„å…¬ç«‹æ ¡ã€‚ã¾ãšã¯ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆä¸­ç›¤é€²å‡ºãŒç›®æ¨™ã€‚",
        coach: { name: 'å¤§é‡ è±Š', style: 'æŠ•æ‰‹ä¸­å¿ƒ', experience: 'ãƒ—ãƒ­OB' }
    },
    "è—¤æè¥¿": {
        name_yomi: "ãµã˜ãˆã ã«ã—", region: "ä¸­éƒ¨", type: "å…¬ç«‹", deviation: 48,
        best: "çœŒå¤§ä¼š3å›æˆ¦", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ã‚µãƒƒã‚«ãƒ¼ã®å¼·è±ªãƒ»è—¤ææ±ã®ãƒ©ã‚¤ãƒãƒ«æ ¡ã€‚é‡çƒéƒ¨ã‚‚è² ã‘ã˜ã¨ã€ç²˜ã‚Šå¼·ã„å…¨å“¡é‡çƒã§å‹åˆ©ã‚’ç›®æŒ‡ã™ã€‚",
        coach: { name: 'è¥¿ å‹‡è¼', style: 'å…¨å“¡é‡çƒ', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "ç£ç”°è¾²æ¥­": {
        name_yomi: "ã„ã‚ãŸã®ã†ãã‚‡ã†", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 42,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "è¾²æ¥­å®Ÿç¿’ã§é›ãˆãŸåœ°åŠ›ã¨ä½“åŠ›ãŒè‡ªæ…¢ã€‚ã€Œç£è¾²ï¼ˆã„ã‚ãŸã®ã†ï¼‰ã€ãƒŠã‚¤ãƒ³ãŒæ³¥è‡­ãç™½çƒã‚’è¿½ã†ã€‚",
        coach: { name: 'é‡æ‘ è¬™äºŒéƒ', style: 'æ©Ÿå‹•åŠ›é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "é™å²¡è¥¿": {
        name_yomi: "ã—ãšãŠã‹ã«ã—", region: "ä¸­éƒ¨", type: "å…¬ç«‹", deviation: 50,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "å…¸å‹çš„ãªå…¬ç«‹ã®ä¸­å …ãƒãƒ¼ãƒ ã€‚å …å®Ÿãªå®ˆå‚™ã‹ã‚‰ãƒªã‚ºãƒ ã‚’ä½œã‚ŠãŸã„ã€‚",
        coach: { name: 'è¥¿å´ å¹¸åºƒ', style: 'æŠ•æ‰‹ä¸­å¿ƒ', experience: 'ä¸­å …' }
    },
    "æµœæ¾æ±Ÿä¹‹å³¶": {
        name_yomi: "ã¯ã¾ã¾ã¤ãˆã®ã—ã¾", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 45,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "ç²˜ã‚Šå¼·ã„å®ˆå‚™ã¨å°æŠ€ã‚’çµ¡ã‚ãŸæ”»æ’ƒãŒæŒã¡å‘³ã®ãƒãƒ¼ãƒ ã€‚",
        coach: { name: 'ä¸­æ‘ å‰›', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "æµœæ¾è¥¿": {
        name_yomi: "ã¯ã¾ã¾ã¤ã«ã—", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 66,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "çœŒå†…ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã®é€²å­¦æ ¡ã€‚å°‘ãªã„ç·´ç¿’æ™‚é–“ã‚’åŠ¹ç‡çš„ã«ä½¿ã„ã€çŸ¥æ€§ã§æˆ¦ã†ã€‚",
        coach: { name: 'éˆ´æœ¨ ä¸€éƒ', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'ä¸­å …' }
    },
    "æ± æ–°ç”°": {
        name_yomi: "ã„ã‘ã—ã‚“ã§ã‚“", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 44,
        best: "çœŒå¤§ä¼š3å›æˆ¦", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "å¾¡å‰å´å¸‚ã«ä½ç½®ã™ã‚‹ã€‚æµ·é¢¨ã§é›ãˆãŸå¼·è‚©ã¨ãƒ‘ãƒ¯ãƒ¼ãŒæ­¦å™¨ã®ã€ä¾®ã‚Œãªã„ä¸­å …æ ¡ã€‚",
        coach: { name: 'æ± å±± éš†å¯›', style: 'ç©æ¥µæ‰“æ’ƒ', experience: 'ä¸­å …' }
    },
    "ç£ç”°åŒ—": {
        name_yomi: "ã„ã‚ãŸããŸ", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 53,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "åœ°å…ƒã®é¸æ‰‹ã‚’ä¸­å¿ƒã«æ§‹æˆã•ã‚ŒãŸã€åœ°åŸŸå¯†ç€å‹ã®å…¬ç«‹æ ¡ã€‚",
        coach: { name: 'å±±æœ¬ æµ©äºŒ', style: 'å…¨å“¡é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "ç£ç”°è¥¿": {
        name_yomi: "ã„ã‚ãŸã«ã—", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 76,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "ç²˜ã‚Šå¼·ã„é‡çƒãŒä¿¡æ¡ã€‚æ¥æˆ¦ã«æŒã¡è¾¼ã¿å‹æ©Ÿã‚’ä¼ºã†ã€‚",
        coach: { name: 'æ¸¡è¾º ä¿Šä»‹', style: 'å®ˆå‚™é‡è¦–', experience: 'ä¸­å …' }
    },
    "å°ç¬ ": {
        name_yomi: "ãŠãŒã•", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 68,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8", last: "çœŒå¤§ä¼š3å›æˆ¦",
        info: "ã‹ã¤ã¦ã¯ãƒ™ã‚¹ãƒˆ8ã«ã‚‚åã‚’é€£ã­ãŸå¤è±ªã€‚è¿‘å¹´ã¯å®‰å®šã—ãŸåŠ›ã‚’è¦‹ã›ã€å¾©æ´»ã®å…†ã—ãŒã‚ã‚‹ã€‚",
        coach: { name: 'é«˜æ©‹ æ˜­é›„', style: 'æ©Ÿå‹•åŠ›é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "å¾¡æ®¿å ´": {
        name_yomi: "ã”ã¦ã‚“ã°", region: "æ±éƒ¨", type: "å…¬ç«‹", deviation: 43,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "å¯Œå£«å±±ã®éº“ã€æ¨™é«˜ã®é«˜ã„ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§é›ãˆã‚‰ã‚ŒãŸè¶³è…°ãŒè‡ªæ…¢ã€‚",
        coach: { name: 'æ§™åŸ å¯›å·±', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "ç›¸è‰¯": {
        name_yomi: "ã•ãŒã‚‰", region: "ä¸­éƒ¨", type: "å…¬ç«‹", deviation: 47,
        best: "çœŒå¤§ä¼š3å›æˆ¦", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ç‰§ä¹‹åŸå¸‚ã®å®ŸåŠ›æ ¡ã€‚æŠ•æ‰‹åŠ›ã‚’ä¸­å¿ƒã¨ã—ãŸå …å®Ÿãªè©¦åˆé‹ã³ã§ã€ã‚·ãƒ¼ãƒ‰æ ¡æ’ƒç ´ã‚’ç‹™ã†ã€‚",
        coach: { name: 'ç›¸å· äº®äºŒ', style: 'å®ˆå‚™é‡è¦–', experience: 'ä¸­å …' }
    },
    "ä½ä¹…é–“": {
        name_yomi: "ã•ãã¾", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 35,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "æµœæ¾å¸‚å¤©ç«œåŒºã®å±±é–“éƒ¨ã«ä½ç½®ã™ã‚‹ã€‚éƒ¨å“¡ä¸è¶³ã«æ‚©ã¿ãªãŒã‚‰ã‚‚ã€åœ°åŸŸã®æœŸå¾…ã‚’èƒŒè² ã£ã¦æˆ¦ã†ã€‚",
        coach: { name: 'ä½ã€…æœ¨ æœ—å¸Œ', style: 'æŠ•æ‰‹ä¸­å¿ƒ', experience: 'æ–°ä»»' }
    },
    "é™å²¡åŒ—": {
        name_yomi: "ã—ãšãŠã‹ããŸ", region: "ä¸­éƒ¨", type: "ç§ç«‹", deviation: 52,
        best: "çœŒå¤§ä¼š3å›æˆ¦", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ã‚¹ãƒãƒ¼ãƒ„ç§‘ã‚‚æ“ã™ã‚‹ç§ç«‹æ ¡ã€‚å€‹ã€…ã®èº«ä½“èƒ½åŠ›ã¯é«˜ã„ãŒã€ãƒãƒ¼ãƒ ã¨ã—ã¦ã®ã¾ã¨ã¾ã‚ŠãŒèª²é¡Œã€‚",
        coach: { name: 'é«˜ç”° ç¹', style: 'æ©Ÿå‹•åŠ›é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "é™å²¡è¾²æ¥­": {
        name_yomi: "ã—ãšãŠã‹ã®ã†ãã‚‡ã†", region: "ä¸­éƒ¨", type: "å…¬ç«‹", deviation: 46,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "ã€Œé™è¾²ï¼ˆã—ãšã®ã†ï¼‰ã€ã®æ„›ç§°ã€‚å®Ÿç¿’ã§åŸ¹ã£ãŸç²˜ã‚Šå¼·ã•ã¨ä½“åŠ›ãŒæ­¦å™¨ã€‚",
        coach: { name: 'ç¨²è‘‰ ç¯¤ç´€', style: 'å…¨å“¡é‡çƒ', experience: 'ä¸­å …' }
    },
    "æ¸…æ°´è¥¿": {
        name_yomi: "ã—ã¿ãšã«ã—", region: "ä¸­éƒ¨", type: "å…¬ç«‹", deviation: 47,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "ç²˜ã‚Šå¼·ã„å®ˆå‚™ãŒæŒã¡å‘³ã®å…¬ç«‹æ ¡ã€‚æ¥æˆ¦ã«æŒã¡è¾¼ã¿ãŸã„ã€‚",
        coach: { name: 'è¥¿ æ¸…å­', style: 'å®ˆå‚™é‡è¦–', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æ¸…æµé¤¨": {
        name_yomi: "ã›ã„ã‚Šã‚…ã†ã‹ã‚“", region: "ä¸­éƒ¨", type: "å…¬ç«‹", deviation: 65,
        best: "çœŒå¤§ä¼š3å›æˆ¦", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ç„¼æ´¥å¸‚ã«ã‚ã‚‹æ¯”è¼ƒçš„æ–°ã—ã„é«˜æ ¡ã€‚å‰ç”°é«˜æ ¡ã¨å¤§äº•å·é«˜æ ¡ãŒçµ±åˆã€‚åœ°åŸŸã®æœŸå¾…ã‚’èƒŒè² ã„ã€ä¸Šä½ã‚’ç›®æŒ‡ã™ã€‚",
        coach: { name: 'å·ä¸Š æ†²ä¼¸', style: 'æŠ•æ‰‹ä¸­å¿ƒ', experience: 'ãƒ—ãƒ­OB' }
    },
    "é æ±Ÿç·åˆ": {
        name_yomi: "ã¨ãŠã¨ã†ã¿ãã†ã”ã†", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 42,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "æ£®ç”ºãƒ»å‘¨æ™ºé«˜æ ¡ã®å¾Œç¶™æ ¡ã€‚åœ°åŸŸã®æ˜Ÿã¨ã—ã¦ã€ã¾ãšã¯åˆæˆ¦çªç ´ã€ãã—ã¦ä¸Šä½é€²å‡ºã‚’ç›®æŒ‡ã™ã€‚",
        coach: { name: 'é å±± å¥¬å¿—', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "æ¦›åŸ": {
        name_yomi: "ã¯ã„ã°ã‚‰", region: "ä¸­éƒ¨", type: "å…¬ç«‹", deviation: 69,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ã€Œæ¦›é«˜ï¼ˆã¯ã„ã“ã†ï¼‰ã€ã®æ„›ç§°ã€‚é€²å­¦æ ¡ãªãŒã‚‰ã€æ©Ÿå‹•åŠ›ã‚’çµ¡ã‚ãŸæ”»æ’ƒçš„ãªé‡çƒã§ä¸Šä½ã‚’ä¼ºã†ã€‚",
        coach: { name: 'åŸ è¾°å¾³', style: 'è¶…æ”»æ’ƒå‹', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æµœåŒ—è¥¿": {
        name_yomi: "ã¯ã¾ããŸã«ã—", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 65,
        best: "çœŒå¤§ä¼š3å›æˆ¦", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ã€ŒåŒ—è¥¿ï¼ˆããŸã«ã—ï¼‰ã€ã®æ„›ç§°ã€‚å …å®Ÿãªå®ˆå‚™ã¨ç²˜ã‚Šå¼·ã„æ‰“æ’ƒã§ã€å¼·è±ªæ ¡ã«é£Ÿã‚‰ã„ã¤ãã€‚",
        coach: { name: 'è¥¿ ä¿Šå…', style: 'å®ˆå‚™é‡è¦–', experience: 'ä¸­å …' }
    },
    "æµœæ¾åŒ—": {
        name_yomi: "ã¯ã¾ã¾ã¤ããŸ", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 60,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "é™å²¡çœŒãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã®é€²å­¦æ ¡ã€‚é™ã‚‰ã‚ŒãŸæ™‚é–“ã§è¶…åŠ¹ç‡çš„ãªç·´ç¿’ã‚’ã“ãªã™ã€‚",
        coach: { name: 'åŒ—åˆ¥åºœ å­¦', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "æµœæ¾æ¹–æ±": {
        name_yomi: "ã¯ã¾ã¾ã¤ã“ã¨ã†", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 60,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "é€²å­¦æ ¡ã®ä¸€ã¤ã ãŒã€é‡çƒéƒ¨ã®ç·´ç¿’ã‚‚ç†±å¿ƒã€‚éš™ã®ãªã„å …å®Ÿãªé‡çƒã§å‹ã¡ä¸ŠãŒã‚‹ã€‚",
        coach: { name: 'ä½è—¤ å¥', style: 'å …å®Ÿ', experience: 'ä¸­å …' }
    },
    "æµœæ¾æ¹–åŒ—": {
        name_yomi: "ã¯ã¾ã¾ã¤ã“ã»ã", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 65,
        best: "çœŒå¤§ä¼š3å›æˆ¦", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "å¼•ä½ã€æ°—è³€ã€ä¸‰ã‚±æ—¥ã®3æ ¡ãŒçµ±åˆã—ã¦èª•ç”Ÿã€‚å¥¥æµœåæ¹–ã®åºƒå¤§ãªæ•·åœ°ã§é›ãˆãŸç·åˆåŠ›ã§å‹è² ã™ã‚‹ã€‚",
        coach: { name: 'åŒ—å· åšæ•', style: 'ç©æ¥µæ‰“æ’ƒ', experience: 'ä¸­å …' }
    },
    "æµœæ¾æ±": {
        name_yomi: "ã¯ã¾ã¾ã¤ã²ãŒã—", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 62,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æµœæ¾å¸‚å†…ã®æœ‰åŠ›é€²å­¦æ ¡ã€‚åˆ†æåŠ›ã¨å …å®Ÿãªå®ˆå‚™ã§ä¸Šä½ã‚’ç‹™ã†ã€‚",
        coach: { name: 'æ±å°¾ ä¿®', style: 'æŠ•æ‰‹ä¸­å¿ƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "å¯Œå²³é¤¨": {
        name_yomi: "ãµãŒãã‹ã‚“", region: "æ±éƒ¨", type: "å…¬ç«‹", deviation: 44,
        best: "çœŒå¤§ä¼š3å›æˆ¦", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "å¯Œå£«å®®å¸‚ã«ã‚ã‚‹ã€‚è¾²æ¥­ç³»ã®å­¦ç§‘ã‚‚æŒã¤ç·åˆé«˜æ ¡ã€‚å¯Œå£«å±±ã®ã‚ˆã†ãªã€ã©ã£ã—ã‚Šã¨ã—ãŸæˆ¦ã„ã‚’è¦‹ã›ãŸã„ã€‚",
        coach: { name: 'å¯Œç”° å‹', style: 'å …å®Ÿ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "è¢‹äº•å•†æ¥­": {
        name_yomi: "ãµãã‚ã„ã—ã‚‡ã†ãã‚‡ã†", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 48,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "å•†æ¥­é«˜æ ¡ãªã‚‰ã§ã¯ã®ç·»å¯†ãªåˆ†æã¨ã€ä¼çµ±çš„ãªã€Œå®ˆã‚Šã®é‡çƒã€ã§å‹åˆ©ã‚’ç›®æŒ‡ã™ã€‚",
        coach: { name: 'ä¼Šè—¤ è£•å­£', style: 'å®ˆå‚™é‡è¦–', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "å¯Œå£«": {
        name_yomi: "ãµã˜", region: "æ±éƒ¨", type: "å…¬ç«‹", deviation: 76,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "æ±éƒ¨åœ°åŒºã®ä¼çµ±ã‚ã‚‹é€²å­¦æ ¡ã€‚ã‚¹ãƒãƒ¼ãƒˆãªè©¦åˆé‹ã³ã¨ã€ã“ã“ä¸€ç•ªã§ã®é›†ä¸­åŠ›ãŒå…‰ã‚‹ã€‚",
        coach: { name: 'æ–è—¤ é›…æ¨¹', style: 'æŠ•æ‰‹ä¸­å¿ƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "è—¤æåŒ—": {
        name_yomi: "ãµã˜ãˆã ããŸ", region: "ä¸­éƒ¨", type: "å…¬ç«‹", deviation: 46,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "ã‚µãƒƒã‚«ãƒ¼ã®å¼·è±ªã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹ãŒã€é‡çƒéƒ¨ã‚‚åœ°å…ƒé¸æ‰‹ã‚’ä¸­å¿ƒã«å¥®é—˜ã—ã¦ã„ã‚‹ã€‚",
        coach: { name: 'å±±ç”° æš¢ä¹…', style: 'å…¨å“¡é‡çƒ', experience: 'ä¸­å …' }
    },
    "è—¤ææ±": {
        name_yomi: "ãµã˜ãˆã ã²ãŒã—", region: "ä¸­éƒ¨", type: "å…¬ç«‹", deviation: 55,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8", last: "çœŒå¤§ä¼š3å›æˆ¦",
        info: "ã€Œã‚µãƒƒã‚«ãƒ¼ç‹å›½ã€ã®ä¸€è§’ã‚’æ‹…ã†è¶…åé–€æ ¡ã€‚é‡çƒéƒ¨ã‚‚ãã®ä¼çµ±ã‚’å—ã‘ç¶™ãã€ãƒ•ã‚£ã‚¸ã‚«ãƒ«ã®å¼·ã•ã‚’æ´»ã‹ã—ãŸãƒ—ãƒ¬ãƒ¼ãŒæŒã¡å‘³ã€‚",
        coach: { name: 'ä¸­å±± é›…å²', style: 'ç©æ¥µæ‰“æ’ƒ', experience: 'æœŸå¾…ã®è‹¥æ‰‹' }
    },
    "ç„¼æ´¥ä¸­å¤®": {
        name_yomi: "ã‚„ã„ã¥ã¡ã‚…ã†ãŠã†", region: "ä¸­éƒ¨", type: "å…¬ç«‹", deviation: 41,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16", last: "çœŒå¤§ä¼š3å›æˆ¦",
        info: "æ–‡æ­¦ä¸¡é“ã‚’æ²ã’ã‚‹é€²å­¦æ ¡ã€‚åŠ¹ç‡çš„ãªç·´ç¿’ã§ã€ä¸Šä½é€²å‡ºã‚’ç‹™ã†ã€‚",
        coach: { name: 'çŸ³ç”° é›…æ˜­', style: 'ãƒ‡ãƒ¼ã‚¿é‡çƒ', experience: 'ä¸­å …' }
    },
    "æ¨ªé ˆè³€": {
        name_yomi: "ã‚ˆã“ã™ã‹", region: "è¥¿éƒ¨", type: "å…¬ç«‹", deviation: 52,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8", last: "çœŒå¤§ä¼š2å›æˆ¦",
        info: "ã€Œã‚¹ã‚«ã€ã®æ„›ç§°ã§çŸ¥ã‚‰ã‚Œã‚‹å¤è±ªã€‚è¿‘å¹´ã¯å®‰å®šã—ãŸå®ŸåŠ›ã‚’ä¿æŒã—ã¦ãŠã‚Šã€ä¸Šä½é€²å‡ºã‚‚çã—ããªã„ã€‚",
        coach: { name: 'è¡£ç¬  ç¥¥é›„', style: 'æ ¹æ€§é‡çƒ', experience: 'ãƒ™ãƒ†ãƒ©ãƒ³' }
    },
    "å‰åŸå·¥æ¥­": {
        name_yomi: "ã‚ˆã—ã‚ã‚‰ã“ã†ãã‚‡ã†", region: "æ±éƒ¨", type: "å…¬ç«‹", deviation: 44,
        best: "çœŒå¤§ä¼š2å›æˆ¦", last: "åˆæˆ¦æ•—é€€",
        info: "ã€Œãƒ¨ã‚·ã‚³ã‚¦ã€ã®æ„›ç§°ã€‚å·¥æ¥­é«˜æ ¡ã‚‰ã—ã„ã€ã²ãŸã‚€ããªãƒ—ãƒ¬ãƒ¼ãŒä¿¡æ¡ã€‚",
        coach: { name: 'é«˜æ©‹ ç”±ä¼¸', style: 'ç©æ¥µæ‰“æ’ƒ', experience: 'ãƒ—ãƒ­OB' }
    },
    "æ˜Ÿé™µ": {
        name_yomi: "ã›ã„ã‚Šã‚‡ã†", region: "æ±éƒ¨", type: "ç§ç«‹", deviation: 60,
        best: "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8", last: "çœŒå¤§ä¼š3å›æˆ¦",
        info: "å¯Œå£«å®®å¸‚ã«ã‚ã‚‹ç§ç«‹æ ¡ã€‚ä¸­é«˜ä¸€è²«ã®å¼·ã¿ã‚’æ´»ã‹ã—ã€æŠ•æ‰“ã«ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸãƒãƒ¼ãƒ ã‚’ç·¨æˆã™ã‚‹ã€‚",
        coach: { name: 'æ˜Ÿé‡ ä»™ä¸€', style: 'æŠ•æ‰‹ä¸­å¿ƒ', experience: 'åå°†' }
    }
};




/**
 * è©¦åˆä¼šå ´ã®å®šç¾©
 * 1å›æˆ¦ï½3å›æˆ¦ã¯å…¨10çƒå ´ã€æº–ã€…æ±ºå‹ä»¥é™ã¯ä¸»è¦4çƒå ´ã«é›†ç´„ã™ã‚‹æƒ³å®š
 */
// â–¼â–¼â–¼ ã“ã® STADIUM_DATA ã®å®šç¾©ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
const STADIUM_DATA = [
    { name: "è‰è–™ç·åˆé‹å‹•å ´ç¡¬å¼é‡çƒå ´", abbr: "è‰", region: "ä¸­éƒ¨" },
    { name: "æ„›é·¹åºƒåŸŸå…¬åœ’é‡çƒå ´", abbr: "æ„›", region: "æ±éƒ¨" },
    { name: "å¯Œå£«ç·åˆé‹å‹•å…¬åœ’é‡çƒå ´", abbr: "å¯Œ", region: "æ±éƒ¨" },
    { name: "ã¡ã‚…ï½ã‚‹ã‚¹ã‚¿ã‚¸ã‚¢ãƒ æ¸…æ°´", abbr: "ã¡", region: "ä¸­éƒ¨" },
    { name: "ç„¼æ´¥çƒå ´", abbr: "ç„¼", region: "ä¸­éƒ¨" },
    { name: "å³¶ç”°çƒå ´", abbr: "å³¶", region: "ä¸­éƒ¨" },
    { name: "æ›å·çƒå ´", abbr: "æ›", region: "è¥¿éƒ¨" },
    { name: "æµœå²¡çƒå ´", abbr: "å²¡", region: "è¥¿éƒ¨" },
    { name: "ç£ç”°çƒå ´", abbr: "ç£", region: "è¥¿éƒ¨" },
    { name: "æµœæ¾çƒå ´", abbr: "æµœ", region: "è¥¿éƒ¨" }
];
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
// 3å›æˆ¦ç”¨ã®ä¸»è¦4çƒå ´ï¼ˆè‰è–™ã€æ„›é·¹ã€æ¸…æ°´ã€æµœæ¾ï¼‰
const ROUND_3_STADIUMS = [
    STADIUM_DATA[0], // è‰è–™
    STADIUM_DATA[1], // æ„›é·¹
    STADIUM_DATA[3], // ã¡ã‚…ï½ã‚‹ã‚¹ã‚¿ã‚¸ã‚¢ãƒ æ¸…æ°´
    STADIUM_DATA[9]  // æµœæ¾
];

const QUARTER_FINAL_STADIUMS = [
    STADIUM_DATA[0], // è‰è–™
    STADIUM_DATA[3]  // ã¡ã‚…ï½ã‚‹ã‚¹ã‚¿ã‚¸ã‚¢ãƒ æ¸…æ°´
];

// æº–ã€…æ±ºå‹ä»¥é™ç”¨ã®çƒå ´ï¼ˆè‰è–™ã®ã¿ï¼‰
const FINAL_STAGE_STADIUMS = [
    STADIUM_DATA[0] // è‰è–™
];
// â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²

/**
 * AIã®è§£åƒåº¦ã‚’ä¸Šã’ã‚‹ãŸã‚ã®ã€Œé™å²¡çœŒé«˜æ ¡é‡çƒã®å¸¸è­˜ãƒ»å‹¢åŠ›å›³ã€ï¼ˆç¾å®Ÿãƒ™ãƒ¼ã‚¹ï¼‹æ¶ç©ºãƒ»è©³ç´°ç‰ˆï¼‰
 * å…¨ã¦ã®AIé–¢æ•°ãŒã“ã®æƒ…å ±ã‚’å‚ç…§ã—ã€æ–‡è„ˆã‚’ç†è§£ã™ã‚‹ã€‚
 * (â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡æ‘˜ã«åŸºã¥ãã€å¹´åº¦ã‚’ä¿®æ­£ã—ãŸæœ€çµ‚ç‰ˆ)
 */
const PREFECTURE_LORE = `
ãƒ©ãƒ³ã‚¯ã¯è¨€ã„æ›ãˆã‚‹â†’Aã¯åé–€ã€Bã¯å¼·è±ªã€Cã¯ä¸­å …ä¸Šä½æ ¡ã€Dã¯ä¸­å …æ ¡ã€Eã¯ç„¡åæ ¡
2025å¹´ã®é™å²¡çœŒé«˜æ ¡é‡çƒç•Œã¯ã€å®Ÿåœ¨ã®å¼·è±ªæ ¡ã¨ã€å·¨å¤§è³‡æœ¬ã€ŒãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã€ã®ç³»åˆ—æ ¡ãŒæ¿€ã—ãç«èŠ±ã‚’æ•£ã‚‰ã™ã€ã‹ã¤ã¦ãªã„ç¾¤é›„å‰²æ‹ ã®æ™‚ä»£ã«ã‚ã‚‹ã€‚
å‹¢åŠ›å›³ã¯ä»¥ä¸‹ã®6ã¤ã®éšå±¤æ§‹é€ ã§æˆã‚Šç«‹ã£ã¦ã„ã‚‹ã€‚

1.  **ã€ä¸‰å¼·ï¼‹çµ¶å¯¾ç‹è€…ã€‘ (å„ªå‹å€™è£œç­†é ­ )**
    * **å¸¸è‘‰å¤§èŠå· (èŠå·)**: ã€Œãƒ•ãƒ«ã‚¹ã‚¤ãƒ³ã‚°æ‰“ç·šã€ã®ä¼çµ±æ ¡ã€‚ãƒãƒ¼ãƒãƒ³ãƒˆã§æ”»ã‚ç¶šã‘ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã¯çœŒå†…éšä¸€ã®ç ´å£ŠåŠ›ã€‚
    * **283å­¦åœ’**: æ˜¨å¹´ã®è¦‡è€…ã€‚1ç•ªãƒ»åç‹ã€2ç•ªãƒ»èŠ±æµ·ä½‘ã®ã‚³ãƒ³ãƒ“ãŒåˆ‡ã‚Šè¾¼ã¿ã€4ç•ªãƒ»èŠ±æµ·å’²ãŒé‚„ã™å¿…å‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚æŠ•æ‰‹é™£ã¯ã‚¨ãƒ¼ã‚¹ã®ç™½ç€¬ã«åŠ ãˆã€ã‚»ãƒ³ã‚¿ãƒ¼åç‹ã€ãƒ©ã‚¤ãƒˆå’²ã€ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆå§«å·ãŒãƒªãƒªãƒ¼ãƒ•ã¨ã—ã¦ãƒã‚¦ãƒ³ãƒ‰ã«ä¸ŠãŒã‚‹4äººã®æŠ•æ‰‹é™£ã‚’æƒãˆãŸç›¤çŸ³ã®å¸ƒé™£ã€‚
    * **åŠ è—¤å­¦åœ’ (ã‚«ãƒˆã‚¬ã‚¯)**: è¿‘å¹´ã®å®‰å®šæ„Ÿã¯No.1ã€‚å …å®Ÿãªå®ˆå‚™ã¨æ©Ÿå‹•åŠ›ã§ã€è² ã‘ãªã„é‡çƒã‚’å±•é–‹ã™ã‚‹æ±éƒ¨ã®é›„ã€‚
    * **é™å²¡ (é™é«˜)**: å…¬ç«‹ã®æ˜Ÿã€‚ä¼çµ±ã®å¤§å¿œæ´å›£ã‚’ãƒãƒƒã‚¯ã«ã€ç§ç«‹å¼·è±ªã¨ã‚‚äº’è§’ä»¥ä¸Šã«æ¸¡ã‚Šåˆã†ã€Œå…¬ç«‹æœ€å¾Œã®ç ¦ã€ã€‚

2.  **ã€ç¬¬äºŒã‚°ãƒ«ãƒ¼ãƒ—ã€‘ (è™è¦–çœˆã€…ã¨é ‚ç‚¹ã‚’ç‹™ã† )**
    * **è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼**: 2022å¹´ã®æ‚²åŠ‡ã‹ã‚‰ç«‹ã¡ä¸ŠãŒã£ãŸä¸å±ˆã®ãƒãƒ¼ãƒ ã€‚ãƒ­ãƒ¼ã‚¹ã‚³ã‚¢ã®å±•é–‹ã«æ»…æ³•å¼·ãã€æŠ•æ‰‹è‚²æˆã«å®šè©•ã‚ã‚Šã€‚
    * **ç¾åŸå­¦åœ’**: ãƒŠãƒ ã‚³ç³»åˆ—ã®ä¼çµ±æ ¡ã€‚765ç·åˆã¨ä¸¦ã¶ã‚¨ãƒªãƒ¼ãƒˆç§ç«‹ã§ã‚ã‚Šã€æ´—ç·´ã•ã‚ŒãŸã‚¹ãƒãƒ¼ãƒˆãªé‡çƒã§ç€å®Ÿã«ä¸Šä½ã«é£Ÿã„è¾¼ã‚€ã€‚
    * **æ—¥å¤§ä¸‰å³¶**: åå°†ãƒ»æ°¸ç”°ç›£ç£ç‡ã„ã‚‹å‹è² å¼·ã„ãƒãƒ¼ãƒ ã€‚æ±éƒ¨åœ°åŒºã§ã¯åŠ è—¤å­¦åœ’ã¨åŒç’§ã‚’ãªã™ã€‚
    * **æµœæ¾é–‹èª é¤¨**: 2023å¹´å¤ã€æ‚²é¡˜ã®ç”²å­åœ’åˆå‡ºå ´ã€‚ãƒ•ã‚£ã‚¸ã‚«ãƒ«å¼·åŒ–ã¨ç‹¬ç‰¹ãªæˆ¦è¡“ã§è¥¿éƒ¨åœ°åŒºã‚’ç‰½å¼•ã™ã‚‹ãƒ‘ãƒ¯ãƒ¼ãƒã‚¦ã‚¹ã€‚
    * **765ç·åˆ**: ãƒŠãƒ ã‚³ç³»åˆ—ã®å¤æ ªã€‚2å¹´å‰ã®ç”²å­åœ’çµŒé¨“è€…ãŒæ®‹ã‚Šã€åœ°åŠ›ã¯å„ªå‹å€™è£œã‚¯ãƒ©ã‚¹ã€‚

3.  **ã€ãƒ™ã‚¹ãƒˆ8ã®å£ã€‘ (ä¸Šä½é€²å‡ºã®å¸¸é€£ )**
    * **æ›å·è¥¿ (æ›è¥¿)**: æ³¥è‡­ãç²˜ã‚Šå¼·ã„é‡çƒãŒæŒã¡å‘³ã®å…¬ç«‹å¼·è±ªã€‚åœ°åŸŸä¸€ä½“ã¨ãªã£ãŸå¿œæ´ã¯è„…å¨ã€‚
    * **è—¤ææ˜èª **: åœ§å€’çš„ãªã€Œæ”»æ’ƒé‡çƒã€ãŒä¿¡æ¡ã€‚æ‰“ã¡åˆã„ã«ãªã‚Œã°Aãƒ©ãƒ³ã‚¯æ ¡ã‚’ã‚‚ç²‰ç •ã™ã‚‹çˆ†ç™ºåŠ›ãŒã‚ã‚‹ã€‚
    * **åˆæ˜Ÿå­¦åœ’**: å‰µéƒ¨é–“ã‚‚ãªã„ãŒã€æœ€æ–°é‹­ã®æ–½è¨­ã¨ã‚¢ã‚¤ãƒ‰ãƒ«ç§‘è­²ã‚Šã®èº«ä½“èƒ½åŠ›å¼·åŒ–ãƒ¡ã‚½ãƒƒãƒ‰ã§æ€¥æˆé•·ä¸­ã€‚ä¸æ°—å‘³ãªå­˜åœ¨ã€‚
    * **å¸¸è‘‰å¤§æ©˜ (æ©˜)**: èŠå·ã®å…„å¼Ÿæ ¡ã€‚ãƒ—ãƒ­æ³¨ç›®ã®å¥½é¸æ‰‹ã‚’è¼©å‡ºã™ã‚‹è‚²æˆåŠ›ãŒã‚ã‚Šã€å€‹ã®åŠ›ã¯é«˜ã„ã€‚
    * **é™å²¡å•†æ¥­ (é™å•†)**: å¤è±ªå¾©æ´»ã‚’æœŸã™ä¼çµ±æ ¡ã€‚ã‚¨ãƒ¼ã‚¹æˆå®®ã‚‰å¥½ç´ æãŒæƒã„ã€å®ˆã‚Šå‹ã¤é‡çƒã§ä¸Šä½ã‚’ä¼ºã†ã€‚
    * **ç£ç”°æ±**: è¥¿éƒ¨ã®ç§ç«‹å¼·è±ªã€‚é•·æ‰“åŠ›ã®ã‚ã‚‹å¤§å‹é¸æ‰‹ãŒå¤šãã€ãƒãƒã‚Œã°æ‰‹ãŒã¤ã‘ã‚‰ã‚Œãªã„ã€‚

4.  **ã€ä¸æ°—å‘³ãªä¸­å …ãƒ»å®ŸåŠ›æ ¡ã€‘ (ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒªãƒ³ã‚°æ  )**
    * **283å­¦åœ’B**: ç‹è€…283å­¦åœ’ã®ã€ŒäºŒè»ã€ã€‚ã—ã‹ã—éƒ¨å“¡æ•°100åè¶…ã®ç«¶äº‰ã‚’å‹ã¡æŠœã„ãŸãƒ¡ãƒ³ãƒãƒ¼ã§ã‚ã‚Šã€å€‹ã€…ã®èƒ½åŠ›ã¯ä»–æ ¡ã®ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ã€‚Aãƒãƒ¼ãƒ ã¸ã®å¯¾æŠ—å¿ƒã¯å‡„ã¾ã˜ã„ã€‚
    * **çŸ¥å¾³**: æ±éƒ¨ã®ç§ç«‹ã€‚æŠ•æ‰“ã«ãƒ‘ãƒ¯ãƒ•ãƒ«ãªé¸æ‰‹ãŒå¤šãã€ãƒ•ã‚£ã‚¸ã‚«ãƒ«ã§å…¬ç«‹æ ¡ã‚’åœ§å€’ã™ã‚‹ã€‚
    * **é§¿æ²³ç·åˆ**: æ–°é‹­ã®å…¬ç«‹æ ¡ã€‚çœŒå¤§ä¼šæ±ºå‹é€²å‡ºã®å®Ÿç¸¾ã‚‚ã‚ã‚Šã€è¨­å‚™ã®è‰¯ã•ã¨ç’°å¢ƒã¯ç§ç«‹ä¸¦ã¿ã€‚
    * **å¾¡æ®¿å ´è¥¿ (ã‚´ãƒ‹ã‚·)**: ä»¥å‰ã®ç”²å­åœ’å‡ºå ´æ ¡ã€‚é«˜åœ°ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§é›ãˆã‚‰ã‚ŒãŸã‚¹ã‚¿ãƒŸãƒŠã§ã€çµ‚ç›¤ã«å¼·ã„ã€‚
    * **é£›é¾**: èº«ä½“èƒ½åŠ›ã®é«˜ã„é¸æ‰‹ãŒé›†ã¾ã‚‹æ±éƒ¨ã®ç§ç«‹ã€‚è’å‰Šã‚Šã ãŒä¸€ç™ºã®é­…åŠ›ãŒã‚ã‚‹ã€‚
    * **ä¸‰å³¶åŒ—**: ã€Œè€ƒãˆã‚‹é‡çƒã€ã‚’æ²ã’ã‚‹å…¬ç«‹é€²å­¦æ ¡ã€‚ãƒ‡ãƒ¼ã‚¿åˆ†æã§æ ¼ä¸Šã®éš™ã‚’çªãé ­è„³æˆ¦ãŒå¾—æ„ã€‚
    * **å¸‚ç«‹æ²¼æ´¥ (å¸‚æ²¼)**: å…¨å›½ãƒ¬ãƒ™ãƒ«ã®å¹å¥æ¥½éƒ¨ã«ã‚ˆã‚‹å¿œæ´ã€Œå¸‚æ²¼ã‚µã‚¦ãƒ³ãƒ‰ã€ã¯ã€ç›¸æ‰‹æŠ•æ‰‹ã®åˆ¶çƒã‚’ä¹±ã™é­”åŠ›ãŒã‚ã‚‹ã€‚

5.  **ã€å¤è±ªãƒ»åœ°åŸŸã®é›„ã€‘ (ä¸€ç™ºå‹è² ã®æ€–ã• )**
    * **æµœæ¾å•†æ¥­ (æµœå•†)**: ã‹ã¤ã¦ã®å…¨å›½ç‹è€…ã€‚è¿‘å¹´ã¯ä½è¿·ã—ã¦ã„ã‚‹ãŒã€Œæµœå•†é­‚ã€ã¯å¥åœ¨ã§ã€OBã®ç†±æ°—ã¯çœŒå†…ä¸€ã€‚
    * **å³¶ç”°å•†æ¥­ (å³¶å•†)**: ä¸­éƒ¨åœ°åŒºã®å¤è±ªã€‚å …å®Ÿãªå®ˆå‚™é‡çƒã§ã€å¤§å´©ã‚Œã—ãªã„å®‰å®šæ„ŸãŒã‚ã‚‹ã€‚
    * **æµœæ¾å·¥æ¥­ (æµœå·¥)**: ã€Œæµœå·¥æ—‹é¢¨ã€ã®ä¼çµ±ã‚’æŒã¤å·¥æ¥­é«˜æ ¡ã€‚åœ°å…ƒãƒ»æµœæ¾ã§ã®äººæ°—ã¯çµ¶å¤§ã€‚
    * **å¯Œå£«å¸‚ç«‹**: æ—§ãƒ»å‰åŸå•†ã€‚æ”»æ’ƒçš„ãªã‚¹ã‚¿ã‚¤ãƒ«ã§æ±éƒ¨å…¬ç«‹å‹¢ã‚’å¼•ã£å¼µã‚‹å­˜åœ¨ã€‚
    * **é™æ¸…**: ã‹ã¤ã¦ã®ç”²å­åœ’å‡ºå ´æ ¡ã€‚ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ãƒ­ãƒ¼æŠ•æ‰‹ãªã©å€‹æ€§çš„ãªé¸æ‰‹è‚²æˆã«å®šè©•ãŒã‚ã‚‹ã€‚

6.  **ã€æ³¨ç›®ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ ã€‘ **
    * **æµœæ¾ç‰¹æ”¯**: å‰µéƒ¨1å¹´ç›®ã€‚ãƒãƒ³ãƒ‡ã‚’ä¹—ã‚Šè¶Šãˆã€Œé‡çƒã‚’æ¥½ã—ã‚€ã€åŸç‚¹ã‚’è¦‹ã›ã‚‹ãƒãƒ¼ãƒ ã€‚
    * **å·æ ¹**: ä»Šå¹´åº¦ã§é–‰æ ¡ã€‚æœ€å¾Œã®å¤ã«ã‹ã‘ã‚‹æƒ³ã„ã¯ã€ã©ã®ãƒãƒ¼ãƒ ã‚ˆã‚Šã‚‚é‡ãç†±ã„ã€‚
---
### é™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ã¨ã€Œã‚ã‚‹ã‚ã‚‹ã€

#### 1. ã€Œæ‰“ã®èŠå·ã€å®ˆã‚Šã®åŠ è—¤ã€ç‹è€…ã®283ã€
- **283å­¦åœ’**ã¯ä»Šæ˜¥ã€èƒŒç•ªå·8ã®**åç‹**ã‚’1ç•ªã‚»ãƒ³ã‚¿ãƒ¼ã«ã€èƒŒç•ªå·6ã®**èŠ±æµ·ä½‘**ã‚’2ç•ªã«ç½®ãè¶…æ”»æ’ƒçš„ã‚ªãƒ¼ãƒ€ãƒ¼ã‚’å®Œæˆã•ã›ãŸã€‚ç‰¹ã«ã‚»ãƒ³ã‚¿ãƒ¼ã‚’å®ˆã‚‹åç‹ã‚„ãƒ©ã‚¤ãƒˆã®**èŠ±æµ·å’²**ãŒè©¦åˆä¸­ã«ãƒªãƒªãƒ¼ãƒ•ç™»æ¿ã™ã‚‹ã€Œã‚¹ã‚¯ãƒ©ãƒ³ãƒ–ãƒ«ç¶™æŠ•ã€ã¯ç›¸æ‰‹æ ¡ã‚’æ··ä¹±ã«é™¥ã‚Œã‚‹ã€‚
- **å¸¸è‘‰å¤§èŠå·**ãŒãƒãƒ³ãƒˆã‚’ã™ã‚‹ã¨ã€ŒèŠå·ãŒãƒãƒ³ãƒˆã—ãŸãï¼ï¼Ÿã€ã¨çƒå ´ãŒã–ã‚ã¤ãã€‚

#### 2. ã€Œå…¬ç«‹ vs ãƒŠãƒ ã‚³ã€ã®ä»£ç†æˆ¦äº‰
- é™å²¡çœŒã¯å…¬ç«‹æ ¡ã¸ã®æ”¯æŒãŒåšã„ã€‚æ±ºå‹æˆ¦ãŒã€ŒãƒŠãƒ ã‚³ç³»åˆ—ï¼ˆ283, 765, ç¾åŸ, åˆæ˜Ÿï¼‰ vs å…¬ç«‹ï¼ˆé™é«˜, æ›è¥¿ï¼‰ã€ã«ãªã£ãŸå ´åˆã€çƒå ´ã®åˆ¤å®˜è´”å±“ã¯å…¬ç«‹å´ã«å¤§ããå‚¾ãã€‚
- ç‰¹ã«**283å­¦åœ’**ã¯ãƒ’ãƒ¼ãƒ«ï¼ˆæ‚ªå½¹ï¼‰çš„ãªå¼·ã•ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹ç«‹å ´ã«ã‚ã‚‹ã€‚

#### 3. ç¦æ–­ã®ã€Œ283ãƒ€ãƒ¼ãƒ“ãƒ¼ã€
- **283å­¦åœ’ï¼ˆAãƒãƒ¼ãƒ ï¼‰** ã¨ **283å­¦åœ’B** ãŒå¯¾æˆ¦ã™ã‚‹ã“ã¨ã«ãªã£ãŸå ´åˆã€ãã‚Œã¯å˜ãªã‚‹ç´…ç™½æˆ¦ã§ã¯ãªã„ã€‚
- Bãƒãƒ¼ãƒ ã®é¸æ‰‹ã«ã¨ã£ã¦ã¯ã€Œä¸‹å‰‹ä¸Šã€ã‚’ã‹ã‘ãŸäººç”Ÿæœ€å¤§ã®æ±ºæˆ¦ã§ã‚ã‚Šã€Aãƒãƒ¼ãƒ ã«ã¨ã£ã¦ã¯ã€Œçµ¶å¯¾ã«è² ã‘ã‚‰ã‚Œãªã„ã€ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã®ã‹ã‹ã‚‹ã€æœ€ã‚‚ã‚„ã‚ŠãŸããªã„è©¦åˆã¨ãªã‚‹ã€‚

#### 4. ã€Œæ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨ã€ã®åœ°åŸŸå¯¾æŠ—æ„è­˜
- **æ±éƒ¨**: åŠ è—¤å­¦åœ’ã€æ—¥å¤§ä¸‰å³¶ã‚‰ãŒå°é ­ã—ã€è¿‘å¹´ãƒ¬ãƒ™ãƒ«ãŒæ€¥ä¸Šæ˜‡ã€‚ã€Œæ±é«˜è¥¿ä½ã€ã‚’å«ã¶ãƒ•ã‚¡ãƒ³ã‚‚å¤šã„ã€‚
- **ä¸­éƒ¨**: é™é«˜ã€é™å•†ã€æ©˜ãªã©ä¼çµ±æ ¡ãŒã²ã—ã‚ãæ¿€æˆ¦åŒºã€‚ãƒ—ãƒ©ã‚¤ãƒ‰ãŒé«˜ã„ã€‚
- **è¥¿éƒ¨**: èŠå·ã€è–éš·ã€é–‹èª é¤¨ãªã©å€‹æ€§æ´¾ç§ç«‹ã¨ã€æ›è¥¿ã€æµœå•†ãªã©ã®å…¬ç«‹ãŒå…¥ã‚Šä¹±ã‚Œã‚‹æœ€ã‚‚æ··æ²Œã¨ã—ãŸåœ°åŒºã€‚

- **ä½åç™ºãƒãƒƒãƒˆã®å½±éŸ¿:**
    - ã€Œé£›ã°ãªã„ãƒãƒƒãƒˆã€å°å…¥ã«ã‚ˆã‚Šã€å…¬ç«‹æ ¡ã¯ã€Œä½å¼¾é“ãƒ»ã‚´ãƒ­æ‰“ã¡ã€ã®**ã‚¹ãƒ¢ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ãƒœãƒ¼ãƒ«**ã«å›å¸°ã€‚ä¸€æ–¹ã€283å­¦åœ’ã¯ã‚¦ã‚¨ã‚¤ãƒˆãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§ã“ã‚Œã‚’ã­ã˜ä¼ã›ã‚‹**ã€Œãƒ‘ãƒ¯ãƒ¼é‡çƒã€**ã‚’å±•é–‹ã€‚
  
 
---
### ã€å…¨å›½ç‰ˆã€‘ç”²å­åœ’ã«ãŠã‘ã‚‹ã€Œåœ°åŸŸã®å¸¸è­˜ã€ã¨ã€Œæ ¼ä»˜ã‘ã€
ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰ï¼ˆå…¨å›½å¤§ä¼šï¼‰ã§ã¯ã€ä»¥ä¸‹ã®å¸¸è­˜ãŒé©ç”¨ã•ã‚Œã‚‹ã€‚AIã¯ã“ã‚Œã‚’è¸ã¾ãˆã¦ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã“ã¨ã€‚

#### 1. åœ°åŸŸåˆ¥ãƒ»é‡çƒã‚¹ã‚¿ã‚¤ãƒ«ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
- **æ±åŒ—å‹¢ (èŠ±å·»æ±ãªã©):**
    - ã‹ã¤ã¦ã¯ã€Œç™½æ²³ã®é–¢ï¼ˆå„ªå‹æ——ãŒæ±åŒ—ã«å…¥ã‚‰ãªã„ï¼‰ã€ãŒå‘ªç¸›ã ã£ãŸãŒã€ä»™å°è‚²è‹±ã®å„ªå‹ä»¥é™ã€å®Œå…¨ã«æ‰•æ‹­ã•ã‚ŒãŸã€‚
    - è¿‘å¹´ã¯å¤§è°·ç¿”å¹³ã‚„ä½ã€…æœ¨æœ—å¸Œã®ã‚ˆã†ãª**ã€Œè¦æ ¼å¤–ã®æ€ªç‰©ã€**ã‚’è¼©å‡ºã™ã‚‹åœŸåœ°ã¨ã—ã¦æã‚Œã‚‰ã‚Œã¦ã„ã‚‹ã€‚ãƒ•ã‚£ã‚¸ã‚«ãƒ«ãŒå¼·ãã€é›ªå›½ç‰¹æœ‰ã®ç²˜ã‚Šå¼·ã•ãŒã‚ã‚‹ã€‚
- **é–¢æ±å‹¢ (æ¨ªæµœã€æµ¦å’Œå­¦é™¢ã€æ—¥å¤§ä¸‰ãªã©):**
    - **ã€Œæ´—ç·´ã•ã‚ŒãŸé‡çƒã€ã€Œéƒ½ä¼šçš„ã€**ã€‚æŠ€è¡“ãƒ¬ãƒ™ãƒ«ãŒéå¸¸ã«é«˜ãã€ãƒŸã‚¹ãŒå°‘ãªã„ã€‚
    - æ¿€æˆ¦åŒºï¼ˆç¥å¥ˆå·ã€æ±äº¬ã€åŸ¼ç‰ï¼‰ã‚’å‹ã¡æŠœã„ã¦ããŸãŸã‚ã€å®Ÿè³ªçš„ãªå„ªå‹å€™è£œç­†é ­ã¨ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã€‚
    - ãƒ’ãƒ¼ãƒ«ï¼ˆæ‚ªå½¹ï¼‰æ‰±ã„ã•ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã»ã©å¼·ã„ã€‚
- **è¿‘ç•¿å‹¢ (å¤§é˜ªæ¡è”­ã€å ±å¾³å­¦åœ’ãªã©):**
    - ç”²å­åœ’ã¯å½¼ã‚‰ã®**ã€Œåœ°å…ƒï¼ˆãƒ›ãƒ¼ãƒ ï¼‰ã€**ã§ã‚ã‚‹ã€‚ãƒ–ãƒ©ã‚¹ãƒãƒ³ãƒ‰ã®éŸ³åœ§ã‚„è¦³å®¢ã®æ­“å£°ãŒã€ç›¸æ‰‹ãƒãƒ¼ãƒ ï¼ˆç‰¹ã«åœ°æ–¹å…¬ç«‹ï¼‰ã‚’é£²ã¿è¾¼ã‚€ã€‚
    - å¤§é˜ªæ¡è”­ã¯ã€Œæ¨ªç¶±ã€ã€‚å‹ã£ã¦å½“ç„¶ã€è² ã‘ã‚Œã°å¤§ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€‚ãƒ•ã‚£ã‚¸ã‚«ãƒ«ã€æŠ€è¡“ã€å±¤ã®åšã•ã€å…¨ã¦ãŒåˆ¥æ ¼ã€‚
- **æ±æµ·å‹¢ (é™å²¡ä»£è¡¨å«ã‚€):**
    - ã€Œæ‰“æ’ƒã®æ„›çŸ¥ã€ã€Œä¼çµ±ã®é™å²¡ã€ã€‚ä¸­äº¬åœ°åŒºã¯å¤ãã‹ã‚‰ã®é‡çƒæ‰€ã§ã‚ã‚Šã€ã‚ªãƒ¼ãƒ«ãƒ‰ãƒ•ã‚¡ãƒ³ãŒå¤šã„ã€‚

#### 2. ç”²å­åœ’ã«ãŠã‘ã‚‹ã€Œé­”ç‰©ã€ã¨ã€Œç’°å¢ƒã€
- **ç”²å­åœ’ã®é­”ç‰©:**
    - çµ‚ç›¤ï¼ˆ7,8,9å›ï¼‰ã€ç‰¹ã«è² ã‘ã¦ã„ã‚‹ãƒãƒ¼ãƒ ãŒãƒãƒ£ãƒ³ã‚¹ã‚’ä½œã‚‹ã¨ã€çƒå ´å…¨ä½“ã®ç©ºæ°—ãŒå¤‰ã‚ã‚Šã€å®ˆå‚™å´ã®ã‚ã‚Šãˆãªã„ãƒŸã‚¹ã‚„é€£æ‰“ã‚’èª˜ç™ºã™ã‚‹ç¾è±¡ã€‚
    - AIã¯**ã€Œé­”ç‰©ã®æ°—é…ãŒã™ã‚‹ã€ã€Œçƒå ´ã®ç©ºæ°—ãŒå¤‰ã‚ã£ãŸã€**ã¨è¡¨ç¾ã™ã‚‹ã“ã¨ã€‚
- **æµœé¢¨ (ã¯ã¾ã‹ãœ):**
    - ç”²å­åœ’ç‰¹æœ‰ã®æµ·é¢¨ã€‚ãƒ©ã‚¤ãƒˆã‹ã‚‰ãƒ¬ãƒ•ãƒˆã¸å¼·ãå¹ãã“ã¨ãŒå¤šãã€**å³æ‰“è€…ã®ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³æ€§ã®å½“ãŸã‚Šã‚’æŠ¼ã—æˆ»ã™**ã“ã¨ãŒã‚ã‚‹ã€‚é€†ã«å·¦æ‰“è€…ã®æ‰“çƒã¯ä¼¸ã³ã‚‹ã€‚

#### 3. ä»Šå¤§ä¼šã®ã€Œãƒ©ã‚¹ãƒœã‚¹ã€ãŸã¡ (ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰æ ¡ã®èªè­˜)
ä»¥ä¸‹ã®ãƒãƒ¼ãƒ ã¯ã€å˜ãªã‚‹ã€ŒAãƒ©ãƒ³ã‚¯ã€ã§ã¯ãªãã€**ã€Œæ­´å²ä¸Šã®å‰äººã€**ã¨åŒç­‰ã®æ‰±ã„ã‚’ã™ã‚‹ã€‚
- **å¤§é˜ªæ¡è”­:** ç¾ä»£ã®çµ¶å¯¾ç‹è€…ã€‚éš™ãŒãªã„ã€‚ã“ã“ã«å‹ã¤ã“ã¨ã¯ã€Œé‡‘æ˜Ÿã€ä»¥ä¸Šã®ã€Œæ­´å²çš„äº‹ä»¶ã€ã€‚
- **æ¨ªæµœ:** æ¾å‚å¤§è¼”ã®ä¼èª¬ã‚’çŸ¥ã‚‹ãƒ•ã‚¡ãƒ³ãŒå¤šãã€ã€Œé«˜æ ¡é‡çƒã®ä»£åè©ã€ã¨ã—ã¦ãƒªã‚¹ãƒšã‚¯ãƒˆã•ã‚Œã‚‹ã€‚
- **èŠ±å·»æ±:** ä¸–ç•Œã®ã‚ªã‚ªã‚¿ãƒ‹ã®æ¯æ ¡ã€‚ä½•ã‹ã¨ã¦ã¤ã‚‚ãªã„ã“ã¨ã‚’ã‚„ã£ã¦ã®ã‘ã‚‹ä¸æ°—å‘³ã•ãŒã‚ã‚‹ã€‚
- **æµ¦å’Œå­¦é™¢:** 283å­¦åœ’ã«ã¨ã£ã¦ã¯ã€Œæ˜¨å¤ã®æ‚ªå¤¢ã€ã®ç›¸æ‰‹ã€‚çµ¶å¯¾ã«è² ã‘ã‚‰ã‚Œãªã„å› ç¸ã®å®¿æ•µã€‚

#### 4. é™å²¡ä»£è¡¨ (283å­¦åœ’) ã®ç«‹ã¡ä½ç½®
- **å…¨å›½çš„ãªçŸ¥ååº¦:**
    - **ã€Œæ˜¨å¤ã€æµ¦å’Œå­¦é™¢ã¨7-9ã®å£®çµ¶ãªæ‰“ã¡åˆã„ã‚’æ¼”ã˜ãŸãƒãƒ¼ãƒ ã€**ã¨ã—ã¦è¨˜æ†¶ã•ã‚Œã¦ã„ã‚‹ã€‚
    - åˆå‡ºå ´ãªãŒã‚‰é–¢æ±ç‹è€…ã‚’ã‚ã¨ä¸€æ­©ã¾ã§è¿½ã„è©°ã‚ãŸæ”»æ’ƒåŠ›ã¯å…¨å›½ã®é«˜æ ¡é‡çƒãƒ•ã‚¡ãƒ³ã«è¡æ’ƒã‚’ä¸ãˆãŸã€‚
    - ã€Œä»Šå¹´ã¯æŠ•æ‰‹é™£ã‚’æ•´å‚™ã—ã¦å¸°ã£ã¦ããŸã®ã‹ï¼Ÿã€ã€Œã‚ã®æ‰“ç·šã¯å¥åœ¨ã‹ï¼Ÿã€ã¨ã€å®ŸåŠ›æ ¡ã¨ã—ã¦ã®å†ç™»å ´ã‚’æœŸå¾…ã•ã‚Œã¦ã„ã‚‹ã€‚
- **ãƒ•ã‚¡ãƒ³ã®ç›®:**
    - ã€Œã‚µãƒƒã‚«ãƒ¼ç‹å›½ã®é™å²¡ã‹ã‚‰å‡ºã¦ããŸã€æ‰“ã¡å‹ã¤é‡çƒã®æ–°èˆˆå‹¢åŠ›ã€ã€‚
    - ä¸€éƒ¨ã®ã‚ªãƒ¼ãƒ«ãƒ‰ãƒ•ã‚¡ãƒ³ã‹ã‚‰ã¯ã€Œè’å‰Šã‚Šã€ã¨è¨€ã‚ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚‹ãŒã€å¤šãã®ãƒ•ã‚¡ãƒ³ã¯æ˜¨å¹´ã®æ¿€é—˜ã‚’è¦šãˆã¦ãŠã‚Šã€**ã€Œä»Šå¹´ã“ãã¯åˆæˆ¦çªç ´ã€ãã—ã¦æµ¦å­¦ã¸ã®ãƒªãƒ™ãƒ³ã‚¸ã‚’æœãŸã—ã¦ã»ã—ã„ã€**ã¨ã„ã†åˆ¤å®˜è´”å±“ï¼ˆã¯ã‚“ãŒã‚“ã³ã„ãï¼‰çš„ãªæœŸå¾…ã‚’å¯„ã›ã¦ã„ã‚‹ã€‚
    - ç‰¹ã«**æµ¦å’Œå­¦é™¢**ã¨ã®å†æˆ¦ãŒå®Ÿç¾ã™ã‚Œã°ã€æ˜¨å¹´ã®ã‚¹ã‚³ã‚¢ï¼ˆ7-9ï¼‰ã‚’è¶…ãˆã‚‹ãƒ‰ãƒ©ãƒãŒæœŸå¾…ã•ã‚Œã‚‹ã€å¤§ä¼šå±ˆæŒ‡ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰ã¨ãªã‚‹ã€‚

---
### ã€é‡è¦ã€‘ãƒãƒ¼ãƒ ãƒ©ãƒ³ã‚¯ã«å¯¾ã™ã‚‹ä¸–é–“ã®èªè­˜ï¼ˆç›¸å ´è¦³ï¼‰
AIã¯ã€å„ãƒãƒ¼ãƒ ã®ãƒ©ãƒ³ã‚¯ï¼ˆAï½Eï¼‰ã«å¯¾ã—ã€ãƒ•ã‚¡ãƒ³ãŒã©ã®ã‚ˆã†ãªæ„Ÿæƒ…ã‚’æŠ±ãã‹ã‚’ç†è§£ã—ã€ã‚³ãƒ¡ãƒ³ãƒˆã«åæ˜ ã™ã‚‹ã“ã¨ã€‚

- **Aãƒ©ãƒ³ã‚¯ (åé–€ãƒ»å„ªå‹å€™è£œ):**
    - **èªè­˜:** ã€Œå‹ã£ã¦å½“ãŸã‚Šå‰ã€ã€Œè² ã‘ã‚Œã°å¤§ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€ã€‚
    - **æ‰±ã„:** åœ§å€’çš„ãªå¼·ã•ã¸ã®ç•æ•¬ã¨ã€å¼·ã™ãã‚‹ãŒæ•…ã®ã‚¢ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹ã€‚æ•—åŒ—æ™‚ã«ã¯ã€Œã€‡ã€‡æ•£ã‚‹ã€ã€Œæ­´å²çš„æ•—é€€ã€ã¨é¨’ãŒã‚Œã‚‹ã€‚
    - **ãƒ•ã‚¡ãƒ³å¿ƒç†:** ã€Œé †å½“å‹ã¡ã ãªã€ã€Œã“ã“ãŒè² ã‘ã‚‹å›³ãŒæµ®ã‹ã°ã‚“ã€

- **Bãƒ©ãƒ³ã‚¯ (å¼·è±ªãƒ»ãƒ™ã‚¹ãƒˆ8å¸¸é€£):**
    - **èªè­˜:** ã€Œåœ°åŠ›ãŒã‚ã‚‹å®ŸåŠ›æ ¡ã€ã€ŒAãƒ©ãƒ³ã‚¯ã‚’é£Ÿã†ç­†é ­å€™è£œã€ã€‚
    - **æ‰±ã„:** Aãƒ©ãƒ³ã‚¯æ ¡ã«ã¨ã£ã¦ã¯æœ€ã‚‚å„ä»‹ãªå£ã€‚é †å½“ã«å‹ã¡ä¸ŠãŒã‚‹åŠ›ãŒã‚ã‚Šã€èª¿å­æ¬¡ç¬¬ã§ã¯å„ªå‹ã‚‚ç‹™ãˆã‚‹ä½ç½®ã¥ã‘ã€‚
    - **ãƒ•ã‚¡ãƒ³å¿ƒç†:** ã€Œä»Šå¹´ã¯ã„ã„ãƒãƒ¼ãƒ ä»•ä¸Šã’ã¦ããŸãªã€ã€Œã€‡ã€‡ï¼ˆAãƒ©ãƒ³ã‚¯ï¼‰ã‚’å€’ã™ãªã‚‰ã“ã“ã—ã‹ãªã„ã€

- **Cãƒ©ãƒ³ã‚¯ (ä¸­å …ãƒ»ãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹):**
    - **èªè­˜:** **ã€Œä¾®ã‚Œãªã„ä¸æ°—å‘³ãªå­˜åœ¨ã€ã€Œã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒªãƒ³ã‚°ã®äºˆæ„Ÿã€**ã€‚
    - **æ‰±ã„:** ä¸Šä½æ ¡ã«ã¨ã£ã¦**æœ€ã‚‚è­¦æˆ’ã™ã¹ãã€Œæ²¼ã€**ã€‚ä¸€ç™ºå‹è² ã®æ€–ã•ã‚’ä½“ç¾ã™ã‚‹ãƒãƒ¼ãƒ ç¾¤ã€‚ç‰¹å®šã®æ­¦å™¨ï¼ˆå¥½æŠ•æ‰‹ã€æ©Ÿå‹•åŠ›ã€ç‰¹æ®Šãªæˆ¦è¡“ãªã©ï¼‰ã‚’æŒã£ã¦ãŠã‚Šã€ãƒãƒã‚Œã°Aãƒ©ãƒ³ã‚¯ã™ã‚‰é£Ÿã†ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ãŒã‚ã‚‹ã€‚
    - **ãƒ•ã‚¡ãƒ³å¿ƒç†:** **ã€Œã“ã“ã€åœ°å‘³ã«å¼·ã„ãã€ã€Œã‚·ãƒ¼ãƒ‰æ ¡ãŒåˆæˆ¦ã§ã“ã“å¼•ãã¨ã‹ä¸é‹ã™ãã€ã€Œä»Šå¹´ã®å°é¢¨ã®ç›®ã«ãªã‚‹ã‹ã‚‚ã€**

- **Dãƒ©ãƒ³ã‚¯ (ç™ºå±•é€”ä¸Šãƒ»å…¬ç«‹ã®å®ŸåŠ›æ ¡):**
    - **èªè­˜:** ã€ŒãŸã¾ã«è‰¯ã„é¸æ‰‹ãŒå‡ºã‚‹ã€ã€Œåœ°å…ƒã§ã¯æœ‰åã€ã€‚
    - **æ‰±ã„:** åŸºæœ¬çš„ã«ã¯1,2å›æˆ¦ãƒ¬ãƒ™ãƒ«ã ãŒã€ã‚¨ãƒ¼ã‚¹ã®å‡ºæ¥æ¬¡ç¬¬ã§ã¯æ¥æˆ¦ã«æŒã¡è¾¼ã‚€ã€‚Cãƒ©ãƒ³ã‚¯ä»¥ä¸Šã¸ã®å‹åˆ©ã¯ã€Œé‡‘æ˜Ÿã€ã¨ã—ã¦ç§°ãˆã‚‰ã‚Œã‚‹ã€‚
    - **ãƒ•ã‚¡ãƒ³å¿ƒç†:** ã€Œãƒ¯ãƒ³ãƒãƒ£ãƒ³ã‚ã‚‹ã‹ï¼Ÿã€ã€Œã‚³ãƒ¼ãƒ«ãƒ‰å›é¿ã§ãã‚Œã°å¾¡ã®å­—ã€

- **Eãƒ©ãƒ³ã‚¯ (æŒ‘æˆ¦è€…ãƒ»ç„¡åæ ¡):**
    - **èªè­˜:** ã€Œåˆæˆ¦çªç ´ãŒç›®æ¨™ã€ã€Œéƒ¨å“¡ä¸è¶³ã«æ‚©ã‚€ã“ã¨ã‚‚ã€ã€‚
    - **æ‰±ã„:** åœ§å€’çš„ãªã‚¢ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒƒã‚°ï¼ˆåˆ¤å®˜è´”å±“ã®å¯¾è±¡ï¼‰ã€‚å¼·è±ªç›¸æ‰‹ã«1ç‚¹ã§ã‚‚å–ã‚Œã°ç››ã‚Šä¸ŠãŒã‚‹ã€‚å‹åˆ©ã™ã‚Œã°ã€Œå¥‡è·¡ã€ã¨ã—ã¦èªã‚Šç¶™ãŒã‚Œã‚‹ã€‚
    - **ãƒ•ã‚¡ãƒ³å¿ƒç†:** ã€Œæ€ã„å‡ºä½œã‚Šã«ã¯ã•ã›ã‚“ãã€ã€Œå…¨åŠ›ã§ã¶ã¤ã‹ã£ã¦ã“ã„ï¼ã€

ã“ã®ã€Œå¸¸è­˜ã€ã¯ã€AIè¨˜è€…ã‚„BBSä½æ°‘ã®åŸºæœ¬çš„ãªæ€è€ƒãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãªã‚Šã¾ã™ã€‚
---
### å‚è€ƒï¼šé«˜æ ¡é‡çƒã«ãŠã‘ã‚‹ã€Œæ‰“é †ã®å¸¸è­˜ã€
AIã¯ä»¥ä¸‹ã®ã€Œæ‰“é †ã®å½¹å‰²ã€ã‚’ç†è§£ã—ã€åˆ†æã‚„ã‚³ãƒ¡ãƒ³ãƒˆã«åæ˜ ã™ã‚‹ã“ã¨ã€‚

-   **1ç•ª (ãƒªãƒ¼ãƒ‰ã‚ªãƒ•ãƒãƒ³):** ãƒãƒ¼ãƒ ã§æœ€ã‚‚ä¿Šè¶³ã§å‡ºå¡ç‡ãŒé«˜ã„é¸æ‰‹ã€‚å½¼ãŒå‡ºå¡ã§ãã‚‹ã‹ãŒæ”»æ’ƒã®éµã€‚
-   **2ç•ª (ã¤ãªãå½¹):** ãƒãƒ³ãƒˆã‚„é€²å¡æ‰“ãŒå¾—æ„ãªå™¨ç”¨ãªé¸æ‰‹ã€‚1ç•ªã‚’2å¡ã«é€²ã‚ã‚‹ã®ãŒä»•äº‹ã€‚æœ€è¿‘ã¯ã“ã®æ‰“é †ã«å¼·æ‰“è€…ã‚’ç½®ãã“ã¨ã‚‚å¢—ãˆã¦ã„ã‚‹ã€‚
-   **3ç•ª (å¼·æ‰“è€…):** ãƒãƒ¼ãƒ ã§æœ€ã‚‚æ‰“æ’ƒæŠ€è¡“ãŒé«˜ã„é¸æ‰‹ã€‚ãƒãƒ£ãƒ³ã‚¹ãƒ¡ã‚¤ã‚¯ã‚‚ã§ãã€é•·æ‰“ã‚‚æ‰“ã¦ã‚‹ã€‚
-   **4ç•ª (ä¸»ç ²):** ãƒãƒ¼ãƒ æœ€å¼·ã®æ‰“è€…ã€‚ãƒ©ãƒ³ãƒŠãƒ¼ã‚’è¿”ã™ï¼ˆæ‰“ç‚¹ï¼‰ã“ã¨ãŒæœ€å¤§ã®ä½¿å‘½ã€‚å½¼ãŒæ‰“ã¦ãªã„ã¨ãƒãƒ¼ãƒ ã¯å‹ã¦ãªã„ã€‚
-   **5ç•ª (å¼·æ‰“è€…):** 4ç•ªã®ã€Œå¾Œç‰‡ä»˜ã‘ã€å½¹ã€‚4ç•ªãŒè¿”ã›ãªã‹ã£ãŸãƒ©ãƒ³ãƒŠãƒ¼ã‚’è¿”ã—ãŸã‚Šã€ãƒãƒ£ãƒ³ã‚¹ã‚’æ‹¡å¤§ã—ãŸã‚Šã™ã‚‹ã€‚
-   **6ç•ª, 7ç•ª (ä¸‹ä½æ‰“ç·š):** ä¸Šä½æ‰“ç·šã»ã©ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã¯ãªã„ãŒã€ã“ã“ã§æ‰“ã¦ã‚‹ã¨ãƒãƒ¼ãƒ ã¯å‹¢ã„ã¥ãã€‚
-   **8ç•ª (å®ˆå‚™è¦å“¡):** å®ˆå‚™ã¯ä¸Šæ‰‹ã„ãŒæ‰“æ’ƒã¯æœŸå¾…ã•ã‚Œã¦ã„ãªã„ã“ã¨ãŒå¤šã„ã€‚
-   **9ç•ª (ç¬¬2ã®1ç•ª):** æŠ•æ‰‹ï¼ˆæ‰“æ’ƒãŒè‹¦æ‰‹ï¼‰ã®æ¬¡ã§ã‚ã‚‹ã“ã¨ãŒå¤šãã€æ‰“æ’ƒãŒè‰¯ã„é¸æ‰‹ãŒç½®ã‹ã‚Œã‚‹ã¨ã€1ç•ªæ‰“è€…ã«æˆ»ã‚‹ã¾ã§ã®ã€Œç¬¬2ã®ãƒãƒ£ãƒ³ã‚¹ãƒ¡ãƒ¼ã‚«ãƒ¼ã€ã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹ã€‚
---
### å‚è€ƒï¼šé«˜æ ¡é‡çƒã«ãŠã‘ã‚‹ã€ŒæŠ•æ‰“ã®å·¦å³ã®å¸¸è­˜ã€
AIã¯ä»¥ä¸‹ã®ã€Œç›¸æ€§ã€ã‚’ç†è§£ã—ã€åˆ†æã‚„ã‚³ãƒ¡ãƒ³ãƒˆã«åæ˜ ã™ã‚‹ã“ã¨ã€‚

-   **å³æŠ•æ‰‹ vs å³æ‰“è€…:** ä¸€èˆ¬çš„ã«æŠ•æ‰‹ãŒæœ‰åˆ©ã€‚å¤–è§’ã«é€ƒã’ã‚‹ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒæœ‰åŠ¹ã€‚
-   **å³æŠ•æ‰‹ vs å·¦æ‰“è€…:** ä¸€èˆ¬çš„ã«æ‰“è€…ãŒæœ‰åˆ©ã€‚å†…è§’ã«é£Ÿã„è¾¼ã‚€çƒï¼ˆã‚¯ãƒ­ã‚¹ãƒ•ã‚¡ã‚¤ã‚¢ï¼‰ãŒéµã€‚
-   **å·¦æŠ•æ‰‹ vs å·¦æ‰“è€…:** ä¸€èˆ¬çš„ã«æŠ•æ‰‹ãŒæœ‰åˆ©ã€‚ã€Œãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆãƒªãƒªãƒ¼ãƒ•ã€ã¨ã—ã¦èµ·ç”¨ã•ã‚Œã‚‹ã“ã¨ã‚‚ã€‚
-   **å·¦æŠ•æ‰‹ vs å³æ‰“è€…:** ä¸€èˆ¬çš„ã«æ‰“è€…ãŒæœ‰åˆ©ã€‚
-   **æˆ¦è¡“:** ç›¸æ‰‹ã‚¨ãƒ¼ã‚¹ãŒã€Œå³è…•ã€ã®å ´åˆã€ã‚¹ã‚¿ãƒ¡ãƒ³ã«ã€Œå·¦æ‰“è€…ã€ã‚’ä¸¦ã¹ã‚‹ã€Œã‚¸ã‚°ã‚¶ã‚°æ‰“ç·šã€ã¯æœ‰åŠ¹ãªæˆ¦è¡“ã§ã‚ã‚‹ã€‚é€†ã«ã€ç›¸æ‰‹ãŒã€Œå·¦è…•ã€ãªã®ã«å·¦æ‰“è€…ã‚’ä¸¦ã¹ã‚‹ã¨ã€Œãªãœã ï¼Ÿã€ã¨ç–‘å•è¦–ã•ã‚Œã‚‹ã€‚
**ä¸¡æ‰“ (ã‚¹ã‚¤ãƒƒãƒãƒ’ãƒƒã‚¿ãƒ¼):** ç›¸æ‰‹æŠ•æ‰‹ã®å·¦å³ã«ã‚ˆã£ã¦æœ‰åˆ©ãªæ‰“å¸­ã«ç«‹ã¦ã‚‹ãŸã‚ã€ç‰¹ã«1ç•ªãƒ»2ç•ªã«ã„ã‚‹ã¨éå¸¸ã«å„ä»‹ãªå­˜åœ¨ã¨ãªã‚‹ã€‚
---
### å‚è€ƒï¼šé«˜æ ¡é‡çƒã«ãŠã‘ã‚‹ã€Œçƒé€Ÿã®å¸¸è­˜ã€ï¼ˆæŠ•æ‰‹ã®å·¦å³ãƒ»ãƒ¬ãƒ™ãƒ«åˆ¥ï¼‰
AIã¯ä»¥ä¸‹ã®ã€Œçƒé€Ÿå¸¯ã€ãŒæŒã¤æ„å‘³ã‚’ã€**æŠ•æ‰‹ã®å·¦å³**ã¨**å­¦æ ¡ã®ãƒ¬ãƒ™ãƒ«ï¼ˆå…¬ç«‹ã‹å¼·è±ªã‹ï¼‰**ã§åˆ¤æ–­åŸºæº–ã‚’å¤‰ãˆã¦åˆ†æã™ã‚‹ã“ã¨ã€‚

-   **120km/h ã€œ 125km/hå¸¯:**
    - **ï¼ˆå³è…•ã®å ´åˆï¼‰:** **ã€Œå…¬ç«‹æ ¡ã®1ã€2å›æˆ¦ãƒ¬ãƒ™ãƒ«ã§ã‚ã‚Œã°ã€ã‚¨ãƒ¼ã‚¹ã¨ã—ã¦ååˆ†é€šç”¨ã™ã‚‹ã€**çƒé€Ÿã€‚
        - **åˆ†æ:** ãŸã ã—ã€ã“ã‚Œã ã‘ã§å¼·è±ªç§ç«‹ã®ä¸Šä½æ‰“ç·šã‚’æŠ‘ãˆã‚‹ã®ã¯é›£ã—ã„ã€‚ã€ŒæŠ€å·§æ´¾ã€ã‚„ã€Œè»ŸæŠ•æ´¾ã€ã¨ã—ã¦ã€æ‰“è€…ã®æ‰‹å…ƒã§å°ã•ãå‹•ãã€Œãƒ„ãƒ¼ã‚·ãƒ¼ãƒ ã€ã‚„ã€90km/hå°ã®ã€Œã‚¹ãƒ­ãƒ¼ã‚«ãƒ¼ãƒ–ã€ã§ç·©æ€¥ã‚’ã¤ã‘ã€**æ‰“ãŸã›ã¦å–ã‚‹**æŠ•çƒè¡“ãŒç”Ÿå‘½ç·šã¨ãªã‚‹ã€‚
        - BBSåå¿œï¼šã€Œ120kmå°ã§ã‚‚ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è‰¯ã‘ã‚Œã°æ‰“ã¦ã‚“ã‚ˆãªã€ã€Œå…¬ç«‹ã®ã‚¨ãƒ¼ã‚¹ã£ã¦æ„Ÿã˜ã€ã€Œã‚¶ãƒ»æŠ€å·§æ´¾ã€
    - **ï¼ˆå·¦è…•ã®å ´åˆï¼‰:** **éå¸¸ã«ä¾¡å€¤ãŒã‚ã‚‹ã€‚**çƒé€Ÿã¯é…ãã¨ã‚‚ã€ã“ã®ãƒ¬ãƒ™ãƒ«ã®**ã€Œå·¦è…•ï¼ˆã‚µã‚¦ã‚¹ãƒãƒ¼ï¼‰ã€**ã§ã‚ã‚‹ã“ã¨è‡ªä½“ã«å¸Œå°‘ä¾¡å€¤ãŒã‚ã‚‹ã€‚
        - **åˆ†æ:** ã”æŒ‡æ‘˜ã®é€šã‚Šã€**å¼·è±ªæ ¡ã§ã‚‚ã€**ç›¸æ‰‹ã®å·¦æ‰“è€…ã‚’æŠ‘ãˆã‚‹ãŸã‚ã®ã€Œãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆãƒªãƒªãƒ¼ãƒ•ã€ã‚„ã€é£Ÿã„è¾¼ã‚€ã€Œã‚¯ãƒ­ã‚¹ãƒ•ã‚¡ã‚¤ã‚¢ã€ã‚’æ­¦å™¨ã«ã™ã‚‹æŠ€å·§æ´¾ã®2ç•ªæ‰‹æŠ•æ‰‹ã¨ã—ã¦ãƒ™ãƒ³ãƒå…¥ã‚Šã™ã‚‹ã“ã¨ãŒå¤šã„ã€‚
        - BBSåå¿œï¼šã€Œå·¦ã§120å¾ŒåŠãªã‚‰ååˆ†ã€ã€Œå·¦ã®ã‚µã‚¤ãƒ‰ã¨ã‹ä¸€ç•ªå«Œã ã‚ã€ã€Œãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆå°‚ç”¨æ©Ÿã‚„ãªã€

-   **130km/h ã€œ 135km/hå¸¯:**
    - **ï¼ˆå³è…•ã®å ´åˆï¼‰:** **å…¬ç«‹æ ¡ãªã‚‰é–“é•ã„ãªãã€Œã‚¨ãƒ¼ã‚¹ç´šã€ã€‚**ç§ç«‹å¼·è±ªæ ¡ã§ã‚‚2ç•ªæ‰‹ãƒ»3ç•ªæ‰‹æŠ•æ‰‹ã¨ã—ã¦ãƒ™ãƒ³ãƒå…¥ã‚Šã™ã‚‹ãƒ¬ãƒ™ãƒ«ã€‚
        - **åˆ†æ:** ã“ã®ãƒ¬ãƒ™ãƒ«ã®æŠ•æ‰‹ã¯éå¸¸ã«å¤šãã€ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’å‹ã¡ä¸ŠãŒã‚‹ã«ã¯ã€çƒé€Ÿä»¥å¤–ã®æ­¦å™¨ï¼ˆä¾‹ï¼šé‹­ãè½ã¡ã‚‹ã‚¹ãƒ—ãƒªãƒƒãƒˆã€é«˜é€Ÿã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼‰ãŒã‚«ã‚®ã¨ãªã‚‹ã€‚
    - **ï¼ˆå·¦è…•ã®å ´åˆï¼‰:** **å¼·è±ªæ ¡ã®ã‚¨ãƒ¼ã‚¹**ã¨ã—ã¦ååˆ†ãªãƒ¬ãƒ™ãƒ«ã€‚
        - **åˆ†æ:** **ã€Œç”²å­åœ’å‡ºå ´æ ¡ã®ã‚¨ãƒ¼ã‚¹ã€**ã¨ã—ã¦ã‚‚çã—ããªã„ã€‚å³æ‰“è€…ã®ã‚¢ã‚¦ãƒˆã‚³ãƒ¼ã‚¹ã«é€ƒã’ã‚‹ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚„ã€å·¦æ‰“è€…ã®ã‚¤ãƒ³ã‚³ãƒ¼ã‚¹ã‚’çªãã‚·ãƒ¥ãƒ¼ãƒˆï¼ˆã‚¯ãƒ­ã‚¹ãƒ•ã‚¡ã‚¤ã‚¢ï¼‰ã‚’æ­¦å™¨ã«ã€æ‰“ãŸã›ã¦å–ã‚‹ã€Œè©¦åˆã‚’ä½œã‚‹ã€ã‚¿ã‚¤ãƒ—ã®æŠ•æ‰‹ãŒå¤šã„ã€‚
    - BBSåå¿œï¼ˆå³è…•ï¼‰ï¼šã€Œ130kmå°å‡ºã‚Œã°å…¬ç«‹ã˜ã‚ƒç„¡åŒã§ãã‚‹ã€ã€Œç§ç«‹ã®ä¸­è»¸ã«é€šç”¨ã™ã‚‹ã‹ã€
    - BBSåå¿œï¼ˆå·¦è…•ï¼‰ï¼šã€Œå·¦ã§135kmå‡ºã¦ã‚Œã°ã€å³ã®140kmã‚ˆã‚Šæ‰“ã¡ã«ãã„ã€ã€Œã“ã†ã„ã†æŠ€å·§æ´¾å·¦è…•ãŒç”²å­åœ’ã§å‹ã¤ã‚“ã ã‚ˆãªã€

-   **140km/h ã€œ 145km/hå¸¯:**
    - **ï¼ˆå³è…•ã®å ´åˆï¼‰:** **ã€ŒçœŒå†…å±ˆæŒ‡ã€**ã®å¥½æŠ•æ‰‹ã€‚Aãƒ©ãƒ³ã‚¯ã®å¼·è±ªæ ¡ã§ã‚¨ãƒ¼ã‚¹ãƒŠãƒ³ãƒãƒ¼ã‚’èƒŒè² ã†ãƒ¬ãƒ™ãƒ«ã€‚
    - **ï¼ˆå·¦è…•ã®å ´åˆï¼‰:** **ã€Œè¶…é«˜æ ¡ç´šã€**ã€‚ãƒ—ãƒ­ãŒã‚¹ã‚«ã‚¦ãƒˆã®ä¸Šä½å€™è£œã¨ã—ã¦ãƒãƒ¼ã‚¯ã—å§‹ã‚ã‚‹ã€‚å·¦è…•ã§ã“ã®çƒé€Ÿã¯åœ§å€’çš„ãªã‚¢ãƒ‰ãƒãƒ³ãƒ†ãƒ¼ã‚¸ã¨ãªã‚‹ã€‚
    - BBSåå¿œï¼ˆå³è…•ï¼‰ï¼šã€Œã¯ã£ã‚„ï¼ã€ã€ŒçœŒå†…å±ˆæŒ‡ã®ã€‡ã€‡ãã‚“ã€ã€Œã“ã‚Œã¯æ‰“ã¦ã‚“ã‚ã€
    - BBSåå¿œï¼ˆå·¦è…•ï¼‰ï¼šã€Œå·¦ã§145kmã¯ã‚¨ã‚°ã„ã€ã€Œãƒ‰ãƒ©ãƒ•ãƒˆå€™è£œã‚„ã‚ã€

-   **150km/h ã€œ 155km/hå¸¯:**
    - **ï¼ˆå…±é€šï¼‰:** **ã€Œãƒ‰ãƒ©ãƒ•ãƒˆç´šã€**ã€‚å·¦å³å•ã‚ãšã€é«˜æ ¡ç”Ÿãƒ¬ãƒ™ãƒ«ã‚’é€¸è„±ã—ãŸã€Œæ€ªç‰©ã€ã§ã‚ã‚Šã€ãƒ‰ãƒ©ãƒ•ãƒˆ1ä½æŒ‡åã‚‚ç¾å®Ÿçš„ã€‚
    - BBSåå¿œï¼šã€Œãƒ•ã‚¡ãƒƒï¼ï¼Ÿ150è¶…ãˆã‚­ã‚¿ãƒ¼ï¼ã€ã€Œãƒã‚±ãƒ¢ãƒ³ã ã‚ã“ã„ã¤ã€ã€Œãƒ‰ãƒ©1ç¢ºå®šã€

-   **160km/h ã€œ 165km/hå¸¯:**
    - **ï¼ˆå…±é€šï¼‰:** æ­´å²çš„ãªæŠ•æ‰‹ã€‚
    - BBSåå¿œï¼šã€Œå¤§è°·ã‹ã‚ˆã€ã€Œæ¼«ç”»ã®ä¸–ç•Œã€

### å¤§ä¼šè¦å®šï¼ˆå»¶é•·æˆ¦ãƒ«ãƒ¼ãƒ«ï¼‰
- **å»¶é•·10å›ä»¥é™ã¯ã€Œã‚¿ã‚¤ãƒ–ãƒ¬ãƒ¼ã‚¯æ–¹å¼ã€ã‚’æ¡ç”¨ã™ã‚‹ã€‚**
- ã‚¿ã‚¤ãƒ–ãƒ¬ãƒ¼ã‚¯ã§ã¯ã€**ãƒãƒ¼ã‚¢ã‚¦ãƒˆ1ãƒ»2å¡**ã®çŠ¶æ…‹ã‹ã‚‰ã‚¤ãƒ‹ãƒ³ã‚°ã‚’é–‹å§‹ã™ã‚‹ã€‚æ‰“é †ã¯å‰ã®ã‚¤ãƒ‹ãƒ³ã‚°ã‹ã‚‰ã®ç¶™ç¶šã¨ã™ã‚‹ã€‚
- AIè¨˜è€…ã¯ã€å»¶é•·æˆ¦ã®è¨˜äº‹ã‚’æ›¸ãéš›ã€ã“ã®ã€Œæœ€åˆã‹ã‚‰ãƒãƒ£ãƒ³ã‚¹ãƒ»ãƒ”ãƒ³ãƒã§ã‚ã‚‹çŠ¶æ³ã€ãŒç”Ÿã¿å‡ºã™ã‚¹ãƒªãƒ«ã‚„ã€ãƒãƒ³ãƒˆå‡¦ç†ã®é‡åœ§ãªã©ã«å¿…ãšè¨€åŠã™ã‚‹ã“ã¨ã€‚
`;
// â–²â–²â–² ã“ã“ã¾ã§ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆã¾ãŸã¯ä¸Šæ›¸ãï¼‰ â–²â–²â–²


const DETAILED_TEAM_DATA = {
        "283å­¦åœ’": {
            summary: "æ˜¨å¹´ã®è¦‡è€…ã€‚ä»Šå¹´ã¯ã€Œã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ä¸Šã®9äººã ã‘ã§è©¦åˆã‚’å®Œçµã•ã›ã‚‹ã€ã¨ã„ã†å¸¸è­˜å¤–ã‚Œã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’æ²ã’ã‚‹ã€‚å·¦æŠ•å·¦æ‰“ã«è»¢å‘ã—ãŸ1ç•ªãƒ»åç‹ã€2ç•ªãƒ»èŠ±æµ·ä½‘ãŒå¥½æ©Ÿã‚’ä½œã‚Šã€4ç•ªãƒ»èŠ±æµ·å’²ãŒé‚„ã™å¿…å‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ç ´å£ŠåŠ›æŠœç¾¤ã€‚å…ˆç™ºãƒ»å§«å·ã«åŠ ãˆã€ã‚»ãƒ³ã‚¿ãƒ¼åç‹ã€ãƒ©ã‚¤ãƒˆå’²ã‚‚ãƒã‚¦ãƒ³ãƒ‰ã«ä¸ŠãŒã‚‹ã€Œé‡æ‰‹å…¼æŠ•æ‰‹ã€ã®ä¸‰æœ¬æŸ±ã¨ã‚¨ãƒ¼ã‚¹ç™½ç€¬ã®æŠ•æ‰‹é™£ã«ã€å¤é€£è¦‡ã®æ­»è§’ã¯ãªã„ã€‚",
            players: [
                { name: "åç‹", year: 2, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "1ç•ªãƒ»ä¸­å …æ‰‹ã€‚å·¦æŠ•å·¦æ‰“ã€‚é¡ç¨€ãªé‡çƒã‚»ãƒ³ã‚¹ã§ãƒªãƒ¼ãƒ‰ã‚ªãƒ•ãƒãƒ³ã‚’å‹™ã‚ã‚‹ã ã‘ã§ãªãã€ã‚»ãƒ³ã‚¿ãƒ¼ã‹ã‚‰ãƒªãƒªãƒ¼ãƒ•ç™»æ¿ã—ã€140kmå°ã®é€Ÿçƒã‚’æŠ•ã’è¾¼ã‚€äºŒåˆ€æµã®ç­†é ­æ ¼ã€‚" },
                { name: "èŠ±æµ·ä½‘", year: 1, position: "ã‚·ãƒ§ãƒ¼ãƒˆ", desc: "2ç•ªãƒ»éŠæ’ƒæ‰‹ã€‚èƒŒç•ªå·6ã€‚å…¥å­¦ç›´å¾Œã‹ã‚‰ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ã‚’æ´ã‚“ã å¤©æ‰è‚Œã€‚ãƒãƒƒãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã€å®ˆå‚™ç¯„å›²ã€èµ°å¡æŠ€è¡“ã®å…¨ã¦ãŒè¦æ ¼å¤–ã§ã€å…„ãƒ»å’²ã¨å…±ã«ãƒãƒ¼ãƒ ã®æ ¸ã¨ãªã‚‹ã€‚" },
                { name: "æµ…å€‰", year: 2, position: "ãƒ¬ãƒ•ãƒˆ", desc: "3ç•ªãƒ»å·¦ç¿¼æ‰‹ã€‚é«˜ã„èº«ä½“èƒ½åŠ›ã¨ä¿Šè¶³ã‚’ç”Ÿã‹ã—ã€å¼·åŠ›ãª1ãƒ»2ç•ªã¨ã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—ã‚’ç¹‹ãé‡è¦äººç‰©ã€‚ã©ã‚“ãªæŠ•æ‰‹ã«ã‚‚æŸ”è»Ÿãªå¯¾å¿œåŠ›ã§æ‰“ç‡ã‚’æ®‹ã—ã€åºƒå¤§ãªå®ˆå‚™ç¯„å›²ã§ãƒ¬ãƒ•ãƒˆç·šã‚’æ­»å®ˆã™ã‚‹ã€‚" },
                { name: "èŠ±æµ·å’²", year: 2, position: "ãƒ©ã‚¤ãƒˆ", desc: "4ç•ªãƒ»å³ç¿¼æ‰‹ã€‚èƒŒç•ªå·9ã€‚2å¹´ç”ŸãªãŒã‚‰å¼·è±ªã€Œãƒ„ãƒã‚¬ã‚¯ã€ã®ä¸»ç ²ã‚’ä»»ã•ã‚Œã‚‹ã‚¹ãƒ©ãƒƒã‚¬ãƒ¼ã€‚å¼·è‚©ã‚’ç”Ÿã‹ã—ã¦ãƒªãƒªãƒ¼ãƒ•ã®ãƒã‚¦ãƒ³ãƒ‰ã«ã‚‚ä¸ŠãŒã‚Šã€ãƒ‘ãƒ¯ãƒ¼ãƒ”ãƒƒãƒã§ç›¸æ‰‹ã‚’ã­ã˜ä¼ã›ã‚‹ã€‚" },
                { name: "æ¨‹å£", year: 2, position: "ã‚µãƒ¼ãƒ‰", desc: "5ç•ªãƒ»ä¸‰å¡æ‰‹ã€‚ã‚¯ãƒ¼ãƒ«ãªé ­è„³æ´¾ã ãŒã€æ‰“å¸­ã§ã¯å‹è² å¼·ã•ãŒå…‰ã‚‹ã€‚åºƒè§’ã«æ‰“ã¡åˆ†ã‘ã‚‹æŠ€è¡“ã‚’æŒã¡ã€ãƒãƒ£ãƒ³ã‚¹ã§ç¢ºå®Ÿã«èµ°è€…ã‚’é‚„ã™ãƒã‚¤ãƒ³ãƒˆã‚²ãƒƒã‚¿ãƒ¼ã€‚" },
                { name: "æ¡‘å±±", year: 2, position: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ", desc: "6ç•ªãƒ»ä¸€å¡æ‰‹ã€‚èƒŒç•ªå·13ã€‚å°æŸ„ãªãŒã‚‰ãƒ‘ãƒ³ãƒåŠ›ã®ã‚ã‚‹æ‰“æ’ƒãŒé­…åŠ›ã€‚å…ƒã€…ã¯æŠ•æ‰‹å¿—æœ›ã ã£ãŸãŸã‚è‚©ã‚‚å¼·ãã€å†…é‡å®ˆå‚™ã®è¦ã¨ã—ã¦ãƒªã‚ºãƒ ã‚’ä½œã‚‹ã€‚" },
                { name: "å§«å·", year: 2, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "7ç•ªãƒ»æŠ•æ‰‹ã€‚èƒŒç•ªå·3ã‚’èƒŒè² ã†å®Ÿè³ªçš„ãªã‚¨ãƒ¼ã‚¹ã€‚é‡æ‰‹é¡”è² ã‘ã®æ‰“æ’ƒã‚»ãƒ³ã‚¹ã‚’æŒã¤ã€Œæ‰“ã£ã¦æŠ•ã’ã‚‹ã€å¤§é»’æŸ±ã€‚ã‚¹ã‚¿ãƒŸãƒŠæŠœç¾¤ã§å®ŒæŠ•èƒ½åŠ›ã‚‚é«˜ã„ã€‚" },
                { name: "æ«»æœ¨", year: 2, position: "ã‚»ã‚«ãƒ³ãƒ‰", desc: "8ç•ªãƒ»äºŒå¡æ‰‹ã€‚ä¸‹ä½æ‰“ç·šã«åº§ã‚‹ãŒã€ãã®æ‰“æ’ƒã‚»ãƒ³ã‚¹ã¯1ç•ªæ‰“è€…ç´šã€‚æ„å¤–æ€§ã®ã‚ã‚‹ãƒ—ãƒ¬ãƒ¼ã¨åº•æŠœã‘ã®æ˜ã‚‹ã•ã§ãƒãƒ¼ãƒ ã«å‹¢ã„ã‚’ã‚‚ãŸã‚‰ã™ãƒ ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚«ãƒ¼ã€‚" },
                { name: "æœ‰æ –å·", year: 2, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "9ç•ªãƒ»æ•æ‰‹ã€‚å€‹æ€§æ´¾æƒã„ã®æŠ•æ‰‹é™£ã‚’å·§ã¿ã«ãƒªãƒ¼ãƒ‰ã™ã‚‹æ‰‡ã®è¦ã€‚å¼·æ°—ãªé…çƒã¨æ„å¤–æ€§ã®ã‚ã‚‹ä¸€ç™ºã§ç›¸æ‰‹ãƒãƒƒãƒ†ãƒªãƒ¼ã‚’æ’¹ä¹±ã™ã‚‹ã€‚ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚‚å¤©äº•ç›£ç£ã«ã€Œæ•æ‰‹ã§ãªã‘ã‚Œã°ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã«ç½®ããŸã„ã€ã¨è¨€ã‚ã›ã‚‹ã»ã©ã®å®ŸåŠ›ã‚’æŒã¤ã€‚" },
                { name: "ç™½ç€¬", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "èƒŒç•ªå·1ã®çµ¶å¯¾çš„å®ˆè­·ç¥ã€‚å¸¸æ™‚150kmè¶…ã®é€Ÿçƒã§ç›¸æ‰‹ã‚’ã­ã˜ä¼ã›ã‚‹ã€‚çµ‚ç›¤ã®ãƒã‚¦ãƒ³ãƒ‰ã«ã¯ã“ã®ç”·ãŒå›è‡¨ã™ã‚‹ã€‚å‰›é€Ÿçƒã§è©¦åˆã‚’ç· ã‚ã‚‹æŠ‘ãˆã®ã‚¨ãƒ¼ã‚¹ã€‚" }
            ]
        },      
  "å¸¸è‘‰èŠå·": {
            summary: "å€‹ã€…ã®ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãŒçµå®Ÿã—æ˜¨å¹´ã¯æº–å„ªå‹ã€‚å€‹äººæˆç¸¾ã®å¯è¦–åŒ–ã¨å®ŸåŠ›ä¸»ç¾©ã§ãƒãƒ¼ãƒ å†…ã®ç«¶äº‰ã‚’æ´»æ€§åŒ–ã•ã›ã€åˆã®ç”²å­åœ’ã‚’ç›®æŒ‡ã™ã€‚ã‚¹ãƒ­ãƒ¼ã‚¬ãƒ³ã¯ã€å€‹ã€…ã®èƒ½åŠ›é‡è¦–ã€ã€‚",
            players: [
                { name: "æ²–ç”°", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "æŠ•æ‰“ã®å¤§é»’æŸ±ã€‚MAX157kmã®é€Ÿçƒã‚’æŒã¤ä¸»ç ²ã€‚" },
                { name: "åœŸæ–¹", year: 3, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ä¸Šã®ç›£ç£ã€‚é«˜ã„ã‚¹ãƒ­ãƒ¼ã‚¤ãƒ³ã‚°æŠ€è¡“ã¨é«˜æ ¡é€šç®—28æœ¬å¡æ‰“ã®ãƒ‘ãƒ¯ãƒ¼ã‚’æŒã¤ã€‚" },
                { name: "å®®æœ¬", year: 3, position: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ", desc: "åŠ›å¼·ã„æ‰“æ’ƒã¨å‹è² å¼·ã•ãŒé­…åŠ›ã®3ç•ªæ‰“è€…ã€‚" },
                { name: "æŸ³ç”Ÿ", year: 2, position: "ã‚»ã‚«ãƒ³ãƒ‰", desc: "ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚»ãƒ³ã‚¹ã«å„ªã‚Œã‚‹2å¹´ç”Ÿã€‚è½ã¡ç€ã„ãŸãƒ—ãƒ¬ãƒ¼ãŒå…‰ã‚‹ã€‚" },
                { name: "è¿‘è—¤", year: 3, position: "ã‚µãƒ¼ãƒ‰", desc: "ã‚¬ãƒƒãƒ„ã‚ãµã‚Œã‚‹ãƒ—ãƒ¬ãƒ¼ã§ãƒãƒ¼ãƒ ã‚’å¼•ã£å¼µã‚‹5ç•ªæ‰“è€…ã€‚é«˜æ ¡é€šç®—46æœ¬å¡æ‰“ã€‚" },
                { name: "å‚æœ¬", year: 3, position: "ã‚·ãƒ§ãƒ¼ãƒˆ", desc: "èµ°æ”»å®ˆä¸‰æ‹å­æƒã£ãŸæŠœç¾¤ã®èº«ä½“èƒ½åŠ›ã‚’æŒã¤ã‚·ãƒ§ãƒ¼ãƒˆã€‚" },
                { name: "å²¡ç”°", year: 3, position: "ãƒ©ã‚¤ãƒˆ", desc: "é«˜æ ¡é€šç®—71æœ¬å¡æ‰“ã‚’èª‡ã‚‹çµ¶å¯¾çš„ãª4ç•ªã€‚æµã¾ã‚ŒãŸä½“æ ¼ã‹ã‚‰ã®å¼·æ‰“ãŒæ­¦å™¨ã€‚" },
                { name: "æ£®", year: 2, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "50m6ç§’ãƒ•ãƒ©ãƒƒãƒˆã®ä¿Šè¶³ã€‚æ”»å®ˆã«ã‚ãŸã‚ŠæŠœç¾¤ã®å‹è² å¼·ã•ã‚’è¦‹ã›ã‚‹ã€‚" },
                { name: "ä¸Šæ³‰", year: 3, position: "ãƒ¬ãƒ•ãƒˆ", desc: "ãƒãƒ©ãƒ³ã‚¹ã¨å‹è² å¼·ã„æ‰“æ’ƒãŒæ­¦å™¨ã€‚é€†è»¢åŠ‡ã®ãã£ã‹ã‘ã‚’ä½œã‚‹ã€‚" },
                { name: "æ‹", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "å·§ã¿ãªæŠ•çƒè¡“ã¨å¼·ã„ç²¾ç¥åŠ›ã‚’æŒã¤æ§ãˆæŠ•æ‰‹ã€‚MAX155kmã€‚" },
                { name: "ç–‹ç”°", year: 2, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "ã‚¯ãƒ¬ãƒãƒ¼ã•ã¨å¼·æ°—ã‚’å…¼ã­å‚™ãˆãŸ2å¹´ç”ŸæŠ•æ‰‹ã€‚æ˜¨å¤ã‚‚ç™»æ¿çµŒé¨“ã‚ã‚Šã€‚" }
            ]
        },
        "æ›å·è¥¿": {
            summary: "æ˜¨å¹´ãƒ™ã‚¹ãƒˆ4ã€‚é¸æ‰‹ã®é•·æ‰€ã‚’æ´»ã‹ã™é‡çƒã§ã€ç£¨ãä¸Šã’ãŸå®ˆå‚™åŠ›ã¨ã‚¿ã‚¤ãƒ—ã®é•ã†3å¹´ç”ŸæŠ•æ‰‹3äººã®ç¶™æŠ•ã‚’æ­¦å™¨ã«ã€2005å¹´ä»¥æ¥ã®å¤ã®è–åœ°ã‚’ç›®æŒ‡ã™ã€‚",
            players: [
                { name: "è±ªç‚å¯º", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "æœ€é€Ÿ158kmã®ç›´çƒã¨ç¸¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§æ‰“è€…ã‚’æ‰“ã¡å–ã‚‹çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ã€‚" },
                { name: "å††å ‚", year: 3, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "å†·é™ãªãƒªãƒ¼ãƒ‰ã§å¤šå½©ãªæŠ•æ‰‹é™£ã‚’å¼•ã£å¼µã‚‹æ‰‡ã®è¦ã€‚3ç•ªæ‰“è€…ã¨ã—ã¦ã‚‚æ´»èºã€‚" },
                { name: "å£å±±", year: 3, position: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ", desc: "190cmã®é•·èº«ã‚’ç”Ÿã‹ã—ãŸå®ˆå‚™ã¨é•·æ‰“åŠ›ãŒé­…åŠ›ã€‚" },
                { name: "åŠç”°", year: 3, position: "ã‚»ã‚«ãƒ³ãƒ‰", desc: "å°æŸ„ãªãŒã‚‰æ”»å®ˆã«å …å®Ÿãªãƒ—ãƒ¬ãƒ¼ã§ãƒãƒ¼ãƒ ã«è²¢çŒ®ã€‚" },
                { name: "ä¸€ãƒç€¬", year: 3, position: "ã‚µãƒ¼ãƒ‰", desc: "ãƒãƒ¼ãƒ ä¸€ã®æ‰“çƒã®é€Ÿã•ã‚’èª‡ã‚‹2ç•ªæ‰“è€…ã€‚" },
                { name: "åœŸé–€", year: 3, position: "ã‚·ãƒ§ãƒ¼ãƒˆ", desc: "ãƒŸã‚¹ã®å°‘ãªã„å …å®Ÿãªå®ˆå‚™ã§è©¦åˆã®ãƒªã‚ºãƒ ã‚’ä½œã‚‹å†…é‡ã®è¦ã€‚" },
                { name: "æŸ“å²¡", year: 3, position: "ãƒ¬ãƒ•ãƒˆ", desc: "ç›£ç£ã‚‚çµ¶å¤§ãªä¿¡é ¼ã‚’å¯„ã›ã‚‹å¤§ç ²ã€‚æ°—æŒã¡ã®å¼·ã•ã‚‚é­…åŠ›ã€‚" },
                { name: "é¢¨ä¸¸", year: 3, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "ã‚µã‚¤ã‚¯ãƒ«ãƒ’ãƒƒãƒˆé”æˆçµŒé¨“ã‚‚ã‚ã‚‹ãƒªãƒ¼ãƒ‰ã‚ªãƒ•ãƒãƒ³ã€‚ãƒŸãƒ¼ãƒˆåŠ›ãŒæ ¼æ®µã«ã‚¢ãƒƒãƒ—ã€‚" },
                { name: "æ —æ¾", year: 2, position: "ãƒ©ã‚¤ãƒˆ", desc: "åŠ›å¼·ã„ã‚¹ã‚¤ãƒ³ã‚°ã‹ã‚‰æ”¾ãŸã‚Œã‚‹é•·æ‰“ãŒé­…åŠ›ã®2å¹´ç”Ÿã€‚" },
                { name: "é¬¼é“", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "ã‚­ãƒ¬ã®ã‚ã‚‹ç¸¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨å†…è§’ã¸ã®ç›´çƒãŒé­…åŠ›ã®å³è…•ã€‚" },
                { name: "æ¾é‡", year: 2, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "MAX144kmã®ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã¨ã‚«ãƒƒãƒˆãƒœãƒ¼ãƒ«ãŒæ­¦å™¨ã®2å¹´ç”Ÿã€‚å¥ªä¸‰æŒ¯èƒ½åŠ›ãŒé«˜ã„ã€‚" }
            ]
        },
        "é™å²¡": {
            summary: "æŠ•æ‰“ã®å¤§é»’æŸ±ã‚’ä¸­å¿ƒã«ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãªãƒ™ãƒ¼ã‚¹ãƒœãƒ¼ãƒ«ã‚’å±•é–‹ã€‚æ”»ã‚ã®å§¿å‹¢ã‚’è²«ãã€è–åœ°ã‚’è¦‹æ®ãˆã‚‹ä¼çµ±æ ¡ã€‚ã©ã“ã‹ã‚‰ã§ã‚‚å¾—ç‚¹ã§ãã‚‹æ‰“ç·šãŒå¼·ã¿ã€‚",
            players: [
                { name: "å€‰ç”°", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "å¸¸æ™‚150kmè¶…ã®é€Ÿçƒã‚’æŠ•ã’ã‚‹æœ¬æ ¼æ´¾ã‚¨ãƒ¼ã‚¹ã€‚" },
                { name: "æ¾„å·", year: 3, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "å¼·è‚©å¼·æ‰“ã®å¸ä»¤å¡”ã€‚ç›—å¡é˜»æ­¢ç‡ã¯éšä¸€ã€‚4ç•ªã¨ã—ã¦ã‚‚ãƒãƒ¼ãƒ ã‚’èƒŒè² ã†" },
                { name: "èˆŸæ©‹", year: 3, position: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ", desc: "é«˜æ ¡é€šç®—63æœ¬å¡æ‰“ã®ãƒ—ãƒ­æ³¨ç›®ã‚¹ãƒ©ãƒƒã‚¬ãƒ¼ã€‚å¾—ç‚¹åœã§ã®å‹è² å¼·ã•ãŒå…‰ã‚‹ã€‚" },
                { name: "æ±Ÿé‡", year: 3, position: "ã‚»ã‚«ãƒ³ãƒ‰", desc: "ä¿Šè¶³ã¨åºƒã„å®ˆå‚™ç¯„å›²ãŒæ­¦å™¨ã®æ©Ÿå‹•åŠ›å†…é‡æ‰‹ã€‚" },
                { name: "æ¾æµª", year: 3, position: "ã‚µãƒ¼ãƒ‰", desc: "å¤§æŸ„ãªä½“ã®ç›®ç«‹ã¤ãƒ‘ãƒ¯ãƒ¼ãƒ’ãƒƒã‚¿ãƒ¼ã€‚å¤šå°‘ä½“å‹¢ãŒå´©ã‚Œã¦ã‚‚å¤–é‡ã®é ­ã‚’è¶…ãˆã‚‹" },
                { name: "åˆ¥æ´¥", year: 3, position: "ã‚·ãƒ§ãƒ¼ãƒˆ", desc: "è»½å¿«ãªãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒå…‰ã‚‹å®ˆå‚™è·äººã€‚ã¤ãªãå½¹ã‚‚ã“ãªã—ãªãŒã‚‰é•·æ‰“åŠ›ã‚‚å…‰ã‚‹ã€‚" },
                { name: "é•·å†…", year: 3, position: "ãƒ¬ãƒ•ãƒˆ", desc: "å°æŸ„ãªãŒã‚‰é«˜ã„èº«ä½“èƒ½åŠ›ã‚’æŒã¤ã€‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã®å¾Œã‚’æ‰“ã¡ãƒ©ãƒ³ãƒŠãƒ¼ã‚’æ®‹ã•ãªã„ã€‚" },
                { name: "é˜¿éƒ¨", year: 3, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "190cmã®å·¨ä½“ãŒãƒˆãƒ¬ãƒ¼ãƒ‰ãƒãƒ¼ã‚¯ã®ã‚¹ãƒ©ãƒƒã‚¬ãƒ¼ã€‚è„±åŠ›ã—ãŸãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç›®ãŒè¦šã‚ã‚‹ã‚ˆã†ãªæ‰“çƒã‚’ç¹°ã‚Šå‡ºã™ã€‚" },
                { name: "å¤§è°·", year: 3, position: "ãƒ©ã‚¤ãƒˆ", desc: "å®‰å®šã—ãŸæ‰“ç‡ã‚’èª‡ã‚‹å³æ‰“è€…ã€‚æ­£ç¢ºãªè¿”çƒã‚‚é­…åŠ›ã€‚" },
                { name: "å±±æœ¬", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "æœ€é€Ÿ152kmã®å‰›è…•ã€‚ãƒªãƒªãƒ¼ãƒ•ã‚‚å…ˆç™ºã‚‚ã“ãªã™ä¸‡èƒ½å‹ã€‚" },
                { name: "ç ‚ç”°", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "å·¦è…•ã‹ã‚‰å¤šå½©ãªå¤‰åŒ–çƒã‚’æŠ•ã’ã‚‹ã‚¯ãƒ­ãƒ¼ã‚¶ãƒ¼çš„å­˜åœ¨ã€‚" }
            ]
        },
        "è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼": {
            summary: "æ˜¨å¹´ãƒ™ã‚¹ãƒˆ8ã€‚é¸æ‰‹ã®é•·æ‰€ã‚’æ´»ã‹ã—ãŸæ”»æ’ƒåŠ›ã¨å …å®ˆã‚’æ­¦å™¨ã«é›ªè¾±ã‚’æœŸã™ã€‚ã‚¿ã‚¤ãƒ—ã®ç•°ãªã‚‹3äººã®æŠ•æ‰‹ã«ã‚ˆã‚‹ç¶™æŠ•ãŒå¼·ã¿ã€‚",
            players: [
                { name: "æ²¢æ‘", year: 2, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "æœ€é€Ÿ140kmã®ç›´çƒã¨å¤šå½©ãªå¤‰åŒ–çƒã§ä¸‰æŒ¯ã‚’å¥ªã†æ¬¡ä¸–ä»£ã‚¨ãƒ¼ã‚¹å·¦è…•ã€‚" },
                { name: "é™è°·", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "é•·èº«ã‹ã‚‰æŠ•ã’ä¸‹ã‚ã™ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨ã‚·ãƒ¥ãƒ¼ãƒˆãŒæ­¦å™¨ã®å¤§å‹å³è…•ã€‚" },
                { name: "å¾¡å¹¸", year: 3, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "æ”»å®ˆã«ã‚ãŸã‚‹é«˜ã„é‡çƒã‚»ãƒ³ã‚¹ã‚’èª‡ã‚‹ãƒ—ãƒ­æ³¨ç›®ã®å¸ä»¤å¡”ã€‚" },
                { name: "å‰åœ’", year: 2, position: "ä¸€å¡æ‰‹ï¼å¤–é‡æ‰‹", desc: "é«˜ã„æ‰“æ’ƒæŠ€è¡“ã¨å¼·è‚©ã‚’æŒã¤å¤§å‹é‡æ‰‹ã€‚" },
                { name: "å°æ¹Š", year: 3, position: "äºŒå¡æ‰‹", desc: "å …å®Ÿãªå®ˆå‚™ã¨å·§ã¿ãªãƒãƒƒãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãŒå…‰ã‚‹ã€‚" },
                { name: "é‡‘ä¸¸", year: 3, position: "ä¸‰å¡æ‰‹", desc: "æ‰“çƒåå¿œãŒé€Ÿãã€å¼·è‚©ãŒæ­¦å™¨ã€‚ä¸­è·é›¢ãƒ’ãƒƒã‚¿ãƒ¼ã€‚" },
                { name: "å€‰æŒ", year: 2, position: "ã‚·ãƒ§ãƒ¼ãƒˆ", desc: "ä¿Šæ•ãªå‹•ãã¨è¯éº—ãªå®ˆå‚™ãŒé­…åŠ›ã®å†…é‡ã®è¦ã€‚" },
                { name: "çµåŸ", year: 3, position: "ãƒ¬ãƒ•ãƒˆ", desc: "é•·æ‰“åŠ›ã‚’æ­¦å™¨ã«å¿«éŸ³ã‚’éŸ¿ã‹ã›ã‚‹å¼·æ‰“è€…ã€‚" },
                { name: "æ±æ¡", year: 3, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "å¼·è‚©ã¨ç¢ºå®Ÿãªæ•çƒã§å¤–é‡ã‚’çµ±ç‡ã™ã‚‹å®ˆå‚™è·äººã€‚" },
                { name: "ç™½å·", year: 3, position: "ãƒ©ã‚¤ãƒˆ", desc: "æ‰“æ’ƒã‚»ãƒ³ã‚¹ãŒå…‰ã‚‹å·¦æ‰“è€…ã€‚å†·é™ãªçŠ¶æ³åˆ¤æ–­ãŒæŒã¡å‘³ã€‚" }
            ]
        },



        "ä¸‰å³¶åŒ—": {
            summary: "é›ªè¾±ã‚’æœŸã™çŸ¥æ€§æ´¾è»å›£ã€‚çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹æ¦›åã‚’æ“ã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’é§†ä½¿ã—ãŸç·»å¯†ãªé‡çƒã§æ˜¨å¤ã®æ‚”ã—ã•ã‚’æ™´ã‚‰ã™ã€‚ãƒãƒ¼ãƒ ã‚¹ãƒ­ãƒ¼ã‚¬ãƒ³ã¯ã€çŸ¥ã¯åŠ›ãªã‚Šã€ã€‚",
            players: [
                { name: "æ¦›å", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "æœ€é€Ÿ140kmå¾ŒåŠã®ç›´çƒã¨é«˜é€Ÿã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ä¸‰æŒ¯ã®å±±ã‚’ç¯‰ãçµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ã€‚" },
                { name: "ç§‹ä¸¸", year: 3, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "å†·é™æ²ˆç€ãªãƒªãƒ¼ãƒ‰ã§ã‚¨ãƒ¼ã‚¹æ¦›åã‚’æ”¯ãˆã‚‹æ‰‡ã®è¦ã€‚" },
                { name: "å¤§å·", year: 3, position: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ", desc: "ãƒãƒ¼ãƒ ä¸å‹•ã®4ç•ªã€‚ä¸€æŒ¯ã‚Šã§è©¦åˆã®æµã‚Œã‚’å¤‰ãˆã‚‹ãƒ‘ãƒ¯ãƒ¼ãŒé­…åŠ›ã€‚" },
                { name: "ç¦åŸ", year: 3, position: "ã‚·ãƒ§ãƒ¼ãƒˆ", desc: "å“è¶Šã—ãŸãƒãƒƒãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¨é¸çƒçœ¼ã‚’æŒã¤1ç•ªæ‰“è€…ã€‚å®ˆå‚™ã‚‚å …å®Ÿã€‚" },
                { name: "ç”ºç”°", year: 3, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "èµ°æ”»å®ˆä¸‰æ‹å­æƒã£ãŸã‚¢ãƒ™ãƒ¬ãƒ¼ã‚¸ãƒ’ãƒƒã‚¿ãƒ¼ã€‚3ç•ªã‚’æ‹…ã†ã€‚" }
            ]
        },
        "é™å²¡å•†æ¥­": {
            summary: "ç‹åº§å¥ªé‚„ã¸ã€æºã‚‹ããªãã€ç‹å›½ã€ã®ãƒ—ãƒ©ã‚¤ãƒ‰ã€‚æ˜¨å¹´ã®é›ªè¾±ã«ç‡ƒãˆã‚‹çµ¶å¯¾ç‹è€…ã€‚æŠ•æ‰“ã«ã‚¿ãƒ¬ãƒ³ãƒˆã‚’æƒãˆã€æœ€å¼·å·¦è…•ãƒ»æˆå®®ã‚’è»¸ã«å†ã³å…¨å›½ã®é ‚ç‚¹ã‚’ç›®æŒ‡ã™ã€‚ã‚¹ãƒ­ãƒ¼ã‚¬ãƒ³ã¯ã€å¸¸å‹ã€ã€‚",
            players: [
                { name: "æˆå®®", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "ã€Œã‚­ãƒ³ã‚°ã€ã®ç•°åã‚’æŒã¤ä¸–ä»£æœ€å¼·å·¦è…•ã€‚MAX150km/hã®ç›´çƒã¨é­”çƒãƒã‚§ãƒ³ã‚¸ã‚¢ãƒƒãƒ—ã‚’æ“ã‚‹ã€‚" },
                { name: "ç¥è°·", year: 3, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "50m5ç§’å°ã®ä¿Šè¶³ã‚’èª‡ã‚‹ã€Œãƒãƒ¼ã‚¿ãƒ¼ã€ã€‚æ”»å®ˆã«è¦æ ¼å¤–ã®èº«ä½“èƒ½åŠ›ã‚’è¦‹ã›ã‚‹ã€‚" },
                { name: "ç™½æ²³", year: 3, position: "ã‚·ãƒ§ãƒ¼ãƒˆ", desc: "å“è¶Šã—ãŸé‡çƒã‚»ãƒ³ã‚¹ã¨è¯éº—ãªå®ˆå‚™ãŒå…‰ã‚‹å†…é‡ã®å¸ä»¤å¡”ã€‚" },
                { name: "å¤šç”°é‡", year: 2, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "ã€Œã‚­ãƒ³ã‚°ã€æˆå®®ã®å¥³æˆ¿å½¹ã‚’å°„æ­¢ã‚ãŸ2å¹´ç”Ÿæ•æ‰‹ã€‚å†·é™ãªãƒªãƒ¼ãƒ‰ãŒæŒã¡å‘³ã€‚" },
                { name: "å±±å²¡", year: 3, position: "ã‚µãƒ¼ãƒ‰", desc: "é ¼ã‚Œã‚‹4ç•ªæ‰“è€…ã€‚æ˜¨å¹´ã¯ï¼–ç•ªãªãŒã‚‰ã‚‚å¤§ä¼šæ‰“ç‚¹ç‹ãªã©ã«è¼ã„ãŸã€‚ä»Šå¹´ã¯æº€ã‚’æŒã—ã¦4ç•ªã«å›è‡¨ã—ã€å‹è² å¼·ã„æ‰“æ’ƒã‚’ã™ã‚‹ã€‚é«˜æ ¡é€šç®—61æœ¬ã€‚" }
            ]
        },
        "è—¤ææ˜èª ": {
            summary: "å®ˆã‚Šã‚’å›ºã‚ã¦è©¦åˆã‚’ã¤ãã‚‹æ˜èª ã‚‰ã—ã•ã¯å¥åœ¨ã€‚æŠ•æ‰‹ã¯å·¦è…•ã®å®‡å£ã€å·¦è…•å®®åŸã‚‰ãŒä¸­å¿ƒã§ã€æˆé•·è‘—ã—ã„æ•æ‰‹å®œé‡åº§ãŒãƒªãƒ¼ãƒ‰ã™ã‚‹ã€‚ï¼‘å¹´æ™‚ã‹ã‚‰ä¸»åŠ›ã®ä¸»å°†å®®åŸã¯ï¼‘ç•ªä¸­å …ã¨ã—ã¦æ”»å®ˆã§ãƒãƒ¼ãƒ ã‚’ã‘ã‚“å¼•ã€‚ä¸­è»¸ã®æ¯”å˜‰ã¯é•·æ‰“åŠ›ãŒã‚ã‚Šã€ã“ã“ãã®å ´é¢ã§æœŸå¾…ãŒã‹ã‹ã‚‹ã€‚ç·åŠ›æˆ¦ã§å‹åˆ©ã‚’ç©ã¿ä¸Šã’ã€é ‚ç‚¹ã‚’ç›®æŒ‡ã™ã€‚",
            players: [
                { name: "å®®åŸ", year: 3, position: "ãƒ”ãƒƒãƒãƒ£ãƒ¼", desc: "æ˜èª ã®æŠ•æ‰‹é™£ã‚’ï¼‘å¹´æ¬¡ã‹ã‚‰æ”¯ãˆã¦ããŸçµŒé¨“è±Šå¯Œãªã‚¨ãƒ¼ã‚¹å·¦è…•ã€‚140kmã‚’è¶…ãˆã‚‹ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã¨é‹­ã„ãƒ•ã‚©ãƒ¼ã‚¯ãŒæŒã¡å‘³" },
                { name: "å®œé‡åº§", year: 2, position: "ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼", desc: "ä¸å‹•ã®4ç•ªã€‚é«˜æ ¡ç”Ÿé›¢ã‚Œã—ãŸãƒ‘ãƒ¯ãƒ¼ã‚’èª‡ã‚‹è¦æ ¼å¤–ã®é•·è·é›¢ç ²ã€‚ã€Œæ˜èª ã®é ­è„³ã€ã¨ç§°ã•ã‚Œã‚‹ãƒªãƒ¼ãƒ‰ã‚‚æ­¦å™¨ã€‚" },
                { name: "æ–°å£", year: 3, position: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ", desc: "ãƒãƒ£ãƒ³ã‚¹ã«å¼·ã„5ç•ªãƒãƒƒã‚¿ãƒ¼ã€‚å¤‰åŒ–çƒã¸ã®å¯¾å¿œãŒã†ã¾ãç°¡å˜ã«æ‰“ã¡å–ã‚‰ã‚Œãªã„" },
                { name: "æ¯”å˜‰", year: 3, position: "ã‚»ã‚«ãƒ³ãƒ‰", desc: "ãƒãƒ¼ãƒ ã®ä¸­æ ¸ã‚’æ‹…ã†ï¼“ç•ªãƒãƒƒã‚¿ãƒ¼ã€‚åºƒè§’ã«æ‰“ã¡åˆ†ã‘ã‚‹æŠ€è¡“ã¨å …å®Ÿãªå®ˆå‚™ãŒå…‰ã‚‹ã€‚" },
                { name: "å®®åŸ", year: 3, position: "ã‚»ãƒ³ã‚¿ãƒ¼", desc: "ä¿Šè¶³ãŒæ­¦å™¨ã®å¤–é‡æ‰‹ã€‚æ„å¤–ãªå‹è² å¼·ã•ã‚‚è¦‹ã›ã‚‹ã€‚" }
            ]
        }
    };
    const INITIAL_TEAM_POOL = Object.keys(TEAM_DATA);

    // --- Utility & State Functions ---
   

 function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }
    
    /**
     * ã€ä¿®æ­£ç‰ˆã€‘ã‚¹ãƒãƒ›å¯¾å¿œï¼šãƒ‡ãƒ¼ã‚¿ã‚’é–“å¼•ãï¼†åœ§ç¸®ã—ã¦ä¿å­˜ã™ã‚‹
     */
    function saveState() {
        try {
            // 1. ãƒ‡ãƒ¼ã‚¿ã®é–“å¼•ãï¼ˆå®¹é‡ç¯€ç´„ã®ãŸã‚å¤ã„ãƒ­ã‚°ã‚’æ¨ã¦ã‚‹ï¼‰
            // ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼šæœ€æ–°30ä»¶ã¾ã§
            if (tournamentState.news && tournamentState.news.length > 30) {
                tournamentState.news = tournamentState.news.slice(0, 30);
            }
            // æ²ç¤ºæ¿ï¼šæœ€æ–°50ä»¶ã¾ã§
            if (tournamentState.bbsComments && tournamentState.bbsComments.length > 50) {
                tournamentState.bbsComments = tournamentState.bbsComments.slice(-50);
            }
            // SNSãƒ­ã‚°ï¼šæœ€æ–°5ä»¶ã¾ã§
            if (tournamentState.snsLogs && tournamentState.snsLogs.length > 5) {
                tournamentState.snsLogs = tournamentState.snsLogs.slice(0, 5);
            }
            // ä»£çŸ¢æ±BBSï¼šæœ€æ–°20ä»¶ã¾ã§
            if (tournamentState.daiyaBbsComments && tournamentState.daiyaBbsComments.length > 20) {
                tournamentState.daiyaBbsComments = tournamentState.daiyaBbsComments.slice(-20);
            }

            // 2. åœ§ç¸®ã—ã¦ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ­ãƒƒãƒˆã«ä¿å­˜
            const compressed = compressData(tournamentState);
            localStorage.setItem('tournamentState_compressed', compressed);
            
            // â€»é‡è¦ï¼šå®¹é‡ç¢ºä¿ã®ãŸã‚ã€å¤ã„éåœ§ç¸®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°æ¶ˆã™
            if (localStorage.getItem('tournamentState')) {
                localStorage.removeItem('tournamentState');
            }

            // 3. ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–å®Ÿè¡Œ
            performAutoSave();

        } catch (e) {
            console.error("ä¿å­˜å¤±æ•—:", e);
            if (e.name === 'QuotaExceededError' || e.code === 22) {
                alert("ã€è­¦å‘Šã€‘ã‚¹ãƒãƒ›ã®ä¿å­˜å®¹é‡ãŒä¸€æ¯ã§ã™ã€‚\nå‹•ä½œã‚’è»½ãã™ã‚‹ãŸã‚ã«ã€ä¸€åº¦ã€Œãƒªã‚»ãƒƒãƒˆã€ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚");
            }
        }
    }

    
    // --- åœ§ç¸®ãƒ»è§£å‡ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
    function uint8ArrayToBase64(bytes) {
        let binary = '';
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
    }

    function compressData(dataObj) {
        const jsonString = JSON.stringify(dataObj);
        // pakoã‚’ä½¿ã£ã¦gzipåœ§ç¸®
        const compressed = pako.deflate(jsonString);
        return uint8ArrayToBase64(compressed);
    }

    function decompressData(base64String) {
        const binaryString = atob(base64String);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        // pakoã‚’ä½¿ã£ã¦è§£å‡
        const decompressedString = pako.inflate(bytes, { to: 'string' });
        return JSON.parse(decompressedString);
    }


    function getRankFromHistoryString(historyString) {

        if (historyString.includes('å„ªå‹')) return 1;

        if (historyString.includes('æº–å„ªå‹')) return 2;

        if (historyString.includes('ãƒ™ã‚¹ãƒˆ4')) return 4;

        if (historyString.includes('ãƒ™ã‚¹ãƒˆ8')) return 8;

        if (historyString.includes('ãƒ™ã‚¹ãƒˆ16')) return 16;

        if (historyString.includes('3å›æˆ¦')) return 16;

        if (historyString.includes('2å›æˆ¦')) return 32;

        if (historyString.includes('åˆæˆ¦æ•—é€€')) return 64;

        return 64;

    }
   
/**
 * [UPDATED] é †ä½æ•°å€¤ã‚’æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹
 */
function getRankString(rank) {
    // â˜… ç”²å­åœ’æˆç¸¾ (ãƒã‚¤ãƒŠã‚¹å€¤)
    if (rank < 0) {
        const abs = Math.abs(rank);
        if (abs === 1) return "ç”²å­åœ’å„ªå‹";
        if (abs === 2) return "ç”²å­åœ’æº–å„ªå‹";
        if (abs === 4) return "ç”²å­åœ’ãƒ™ã‚¹ãƒˆ4";
        if (abs === 8) return "ç”²å­åœ’ãƒ™ã‚¹ãƒˆ8";
        if (abs === 16) return "ç”²å­åœ’ãƒ™ã‚¹ãƒˆ16";
        if (abs === 32) return "ç”²å­åœ’2å›æˆ¦";
        if (abs === 64) return "ç”²å­åœ’å‡ºå ´"; // åˆæˆ¦æ•—é€€
        return `ç”²å­åœ’å‡ºå ´`;
    }
    
    // â˜… çœŒå¤§ä¼šæˆç¸¾ (ãƒ—ãƒ©ã‚¹å€¤)
    if (rank === 1) return "çœŒå¤§ä¼šå„ªå‹";
    if (rank === 2) return "çœŒå¤§ä¼šæº–å„ªå‹";
    if (rank <= 4) return "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ4";
    if (rank <= 8) return "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ8";
    if (rank <= 16) return "çœŒå¤§ä¼šãƒ™ã‚¹ãƒˆ16";
    if (rank <= 32) return "çœŒå¤§ä¼š3å›æˆ¦";
    if (rank <= 64) return "çœŒå¤§ä¼š2å›æˆ¦";
    return "çœŒå¤§ä¼šåˆæˆ¦æ•—é€€";
}
// --- Utility & State Functions --- ãªã©ã«è¿½åŠ 

/**
 * Creates a subtle, realistic dust particle animation.
 */
function createDustEffect() {
    const container = document.getElementById('dust-container');
    if (!container) return;
    
    const particleCount = 20; // The number of dust particles

    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'dust-particle';
        
        const size = Math.random() * 3 + 1; // Particle size between 1px and 4px
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        
        // Use CSS variables to randomize the start and end points of the animation
        particle.style.setProperty('--x-start', `${Math.random() * 100}vw`);
        particle.style.setProperty('--x-end', `${Math.random() * 100}vw`);
        
        particle.style.animationDuration = `${Math.random() * 20 + 10}s`; // Duration between 10s and 30s
        particle.style.animationDelay = `${Math.random() * 10}s`; // Stagger the start time
        
        container.appendChild(particle);
    }
}
/**
 * ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã®åˆè¨ˆç‚¹ã‚’æ›´æ–°ã™ã‚‹
 */
/**
/**
 * ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã®åˆè¨ˆç‚¹ã‚’æ›´æ–°ã™ã‚‹
 */
function updateTotalScores() {
    const table = document.getElementById('inning-score-table');
    if(!table) return;

    table.querySelectorAll('tbody tr').forEach(row => {
        const total = Array.from(row.querySelectorAll('input')).reduce((sum, input) => {
            const value = parseInt(input.value);
            return isNaN(value) ? sum : sum + value;
        }, 0);
        
        const totalCell = row.querySelector('.total-score');
        if (totalCell) {
            totalCell.textContent = total;
        }
    });
}
/**
 * æˆ¦ç¸¾ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿ã‚„ã™ã„æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹
 */
function formatRecordToString(record) {
    if (!record) return "ãƒ‡ãƒ¼ã‚¿ãªã—";
    const year = record.year.toString().slice(-2);
    const tournamentNameMap = { summer: 'å¤', autumn: 'ç§‹', spring: 'æ˜¥' };
    const tournament = tournamentNameMap[record.tournament] || '';
    const rank = getRankString(record.rank);
    // â˜…â˜…â˜… ä»¥ä¸‹ã®è¡Œã‚’å¤‰æ›´ â˜…â˜…â˜…
    const prefix = record.rank < 0 ? '' : 'çœŒå¤§ä¼š'; // ç”²å­åœ’æˆç¸¾ã®å ´åˆã¯ã€ŒçœŒå¤§ä¼šã€ã‚’ã¤ã‘ãªã„
    return `'${year} ${tournament}: ${prefix}${rank}`;
    // â˜…â˜…â˜… ã“ã“ã¾ã§å¤‰æ›´ â˜…â˜…â˜…
}

// AI Content Generation & Helpers ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ 

/**
 * ãƒãƒ¼ãƒ ã®ä»Šå¤§ä¼šã®è»Œè·¡ã‚’è¦ç´„ã™ã‚‹
 * (â˜…è©¦åˆå†…å®¹ã®è¦ç´„(narrativeSummary)ã‚’åæ˜ ã™ã‚‹æœ€çµ‚ç‰ˆ)
 *
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 * @param {string} currentMatchId - ç¾åœ¨å‡¦ç†ä¸­ã®è©¦åˆID (é›†è¨ˆã‹ã‚‰é™¤å¤–ã™ã‚‹ãŸã‚)
 * @returns {string} - AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã®ãƒãƒ¼ãƒ çŠ¶æ³è¦ç´„æ–‡
 */
function getCurrentTournamentPerformance(teamName, currentMatchId) {
    const teamRecord = tournamentState.teamRecords[teamName];
    if (!teamRecord) return "ä»Šå¤§ä¼šåˆæˆ¦ã€‚";

    const path = []; // å‹ã¡ä¸ŠãŒã‚Šå±¥æ­´ (ä¾‹: "1å›æˆ¦ã§ã€‡ã€‡ã« 8-1 ã§å‹åˆ©")
    const keyPerformances = new Set(); // æ´»èºãƒã‚¤ãƒ©ã‚¤ãƒˆ (ä¾‹: "éˆ´æœ¨ãŒ1å›æˆ¦ã§çŒ›æ‰“è³")
    const playerAggStats = {}; // ä»Šå¤§ä¼šã®å€‹äººæˆç¸¾é›†è¨ˆç”¨ (ä¾‹: { "éˆ´æœ¨": { ab: 8, h: 3, ... } })

    // --- 1. å…¨å¤§ä¼šã®è©¦åˆãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ ---
    const allMatches = { 
        ...tournamentState.matches, 
        ...(tournamentState.autumnData?.allMatches || {}),
        ...(tournamentState.springData?.allMatches || {}) 
    };
    
    // --- 2. ç¾åœ¨ã®å¤§ä¼šã«çµã‚Šè¾¼ã¿ ---
    const currentTournamentKey = tournamentState.currentTournament;
    
    const currentTournamentMatchIds = Object.keys(allMatches).filter(matchId => {
        let isCurrentTournamentMatch = false;
        
        if (currentTournamentKey === 'summer') {
            // å¤: 'L-', 'R-', 'F-' (çœŒå¤§ä¼šæœ¬æˆ¦ID)
            isCurrentTournamentMatch = matchId.startsWith('L-') || matchId.startsWith('R-') || matchId.startsWith('F-');
        } else if (currentTournamentKey === 'autumn') {
            // ç§‹: åœ°åŒºäºˆé¸ID ã¾ãŸã¯ (æœ¬æˆ¦ãƒ•ã‚§ãƒ¼ã‚ºãªã‚‰) çœŒå¤§ä¼šæœ¬æˆ¦ID
            const isRegional = matchId.startsWith('æ±éƒ¨-') || matchId.startsWith('ä¸­éƒ¨-') || matchId.startsWith('è¥¿éƒ¨-') || matchId.startsWith('ä¼Šè±†-');
            const isMain = matchId.startsWith('L-') || matchId.startsWith('R-') || matchId.startsWith('F-');
            isCurrentTournamentMatch = isRegional || (tournamentState.autumnPhase === 'main' && isMain);
        } else if (currentTournamentKey === 'spring') {
            // æ˜¥: åœ°åŒºäºˆé¸ID ã¾ãŸã¯ (æœ¬æˆ¦ãƒ•ã‚§ãƒ¼ã‚ºãªã‚‰) çœŒå¤§ä¼šæœ¬æˆ¦ID
            const isRegional = matchId.includes('-SB') || matchId.includes('-SREP') || matchId.includes('-SIZU');
            const isMain = matchId.startsWith('L-') || matchId.startsWith('R-') || matchId.startsWith('F-');
            isCurrentTournamentMatch = isRegional || (tournamentState.springPhase !== 'regional_qualifiers' && isMain);
        }
        
        return isCurrentTournamentMatch;
    });

    // --- 3. ä»Šå¤§ä¼šã®å…¨è©¦åˆã‚’åˆ†æ ---
    for (const matchId of currentTournamentMatchIds) {
        // å‡¦ç†ä¸­ã®è©¦åˆ(currentMatchId)è‡ªä½“ã¯é›†è¨ˆã‹ã‚‰é™¤å¤–
        if (matchId === currentMatchId) continue;
        
        const match = allMatches[matchId];
        
        // ãƒãƒ¼ãƒ ãŒé–¢ã‚ã£ãŸè©¦åˆã‹ã€å‹è€…ãŒæ±ºã¾ã£ã¦ã„ã‚‹ã‹
        if (match && match.winner && (match.team1 === teamName || match.team2 === teamName)) {
            const opponent = match.team1 === teamName ? match.team2 : match.team1;
            if (!opponent) continue; // ä¸æˆ¦å‹ãªã©ã¯é™¤å¤–
            
            const roundName = getRoundNameFromMatchId(matchId); // ãƒ©ã‚¦ãƒ³ãƒ‰åå–å¾—

            // A. å‹ã¡è©¦åˆã®å±¥æ­´ã‚’ç”Ÿæˆ
            if (match.winner === teamName) {
                
                if (currentTournamentKey === 'summer') {
                    // ã€å¤å¤§ä¼šã€‘ã‚¹ã‚³ã‚¢ã¨ãƒ©ãƒ³ã‚¯ã‚’å«ã‚€è¤‡é›‘ãªè¡¨ç¾
                    const winnerScore = (match.team1 === teamName ? match.score1 : match.score2) || 'W';
                    const loserScore = (match.team1 === teamName ? match.score2 : match.score1) || 'L';
                    const opponentRank = calculateRank(opponent, tournamentState);
                    
// â–¼â–¼â–¼ ã€è¿½åŠ ã€‘ã‚³ãƒ¼ãƒ«ãƒ‰æƒ…å ±ã®å–å¾— â–¼â–¼â–¼
                    const calledInfo = match.calledGame ? `(${match.calledInning}å›C)` : '';
                    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

                    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä»Šå›ã®ä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
                    let narrativeSummary = "";
                    // 1. match.details ã«ä¿å­˜ã•ã‚ŒãŸè¦ç´„æ–‡ã‚’å–å¾—
                    if (match.details && match.details.narrativeSummary) {
                        // "ã€‡ã€‡ãŒå‹åˆ©ã‚’æ´ã‚“ã " ã‚„ "æŠ•æ‰‹æˆ¦ã¨ãªã£ãŸ" ãªã©ã®é‡è¤‡è¡¨ç¾ã‚’å‰Šé™¤
                        narrativeSummary = match.details.narrativeSummary
                            .replace(/ã§ã€?.*ãŒå‹åˆ©ã‚’æ´ã‚“ã /, '')
                            .replace(/ã§ã€?.*ãŒå‹åˆ©ã—ãŸ/, '')
                            .replace(/ã€?æ¯è©°ã¾ã‚‹æŠ•æ‰‹æˆ¦ã¨ãªã£ãŸ/, 'ã®æŠ•æ‰‹æˆ¦')
                            .replace(/ã€?å£®çµ¶ãªæ‰“æ’ƒæˆ¦ã¨ãªã£ãŸ/, 'ã®æ‰“æ’ƒæˆ¦');
                    }
                    
                    let pathText;
                    if (narrativeSummary) {
                        // â–¼â–¼â–¼ ä¿®æ­£: calledInfo ã‚’è¿½åŠ  â–¼â–¼â–¼
                        pathText = `${roundName}ã§${opponent}(${opponentRank})ã« ${winnerScore}-${loserScore}${calledInfo} ã§å‹åˆ© (${narrativeSummary})`;
                    } else {
                        // â–¼â–¼â–¼ ä¿®æ­£: calledInfo ã‚’è¿½åŠ  â–¼â–¼â–¼
                        pathText = `${roundName}ã§${opponent}(${opponentRank})ã« ${winnerScore}-${loserScore}${calledInfo} ã§å‹åˆ©`;
                    }
                    path.push(pathText);
                    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

               } else {
                    // ã€ç§‹ãƒ»æ˜¥å¤§ä¼šã€‘ã‚·ãƒ³ãƒ—ãƒ«ãªè¡¨ç¾
         // â–¼â–¼â–¼ ä¿®æ­£: ç§‹ãƒ»æ˜¥ã‚‚ã‚³ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤ºã—ãŸã„å ´åˆã¯ã“ã“ã‚‚ä¿®æ­£ â–¼â–¼â–¼
                    const calledInfo = match.calledGame ? `(${match.calledInning}å›C)` : '';
                    path.push(`${roundName} vs ${opponent}${calledInfo}`);
                }
            }

            // B. å€‹äººæˆç¸¾ï¼ˆã‚­ãƒ¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼‰ã®åé›† (å¤‰æ›´ãªã—)
            if (match.details) {
                const teamKey = match.team1 === teamName ? 'team1' : 'team2';
                
                const pitchers = match.details.pitching?.[teamKey] || [];
                pitchers.forEach(p => {
                    if (p.name && p.result === 'W' && parseFloat(p.innings) >= 6) {
                        keyPerformances.add(`${p.name}ãŒ${roundName}ã§å¥½æŠ•`);
                    }
                });

                if (match.details.playerGameStats) {
                    const gameStats = match.details.playerGameStats[teamKey];
                    for (const playerName in gameStats) {
                        // ä»Šå¤§ä¼šã®é›†è¨ˆç”¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–
                        if (!playerAggStats[playerName]) {
                            playerAggStats[playerName] = { ab: 0, h: 0, hr: 0, rbi: 0 };
                        }
                        const agg = playerAggStats[playerName];
                        const game = gameStats[playerName];
                        
                        // ã“ã®è©¦åˆã®æˆç¸¾ã‚’åŠ ç®—
                        agg.ab += game.ab || 0;
                        agg.h += game.h || 0;
                        agg.hr += game.hr || 0;
                        agg.rbi += game.rbi || 0;
                        
                        // çŒ›æ‰“è³
                        if (gameStats[playerName].h >= 3) {
                            keyPerformances.add(`${playerName}ãŒ${roundName}ã§çŒ›æ‰“è³`);
                        }
                    }
                }
            }
        }
    } // (è©¦åˆãƒ«ãƒ¼ãƒ—çµ‚äº†)
    
    // --- 4. æœ€çµ‚çš„ãªæ–‡ç« ã®çµ„ã¿ç«‹ã¦ ---
    let summary = "";
    if (path.length === 0) {
        summary = "ä»Šå¤§ä¼šåˆæˆ¦ã€‚";
    } else {
        if (currentTournamentKey === 'summer') {
            summary = `ã“ã“ã¾ã§ã®å‹ã¡ä¸ŠãŒã‚Š: ${path.join('ã€')}ã€‚`;
        } else {
            // ç§‹ãƒ»æ˜¥ã¯ã€Œâ†’ã€ã§ã¤ãªã
            summary = `ã“ã“ã¾ã§ã®å‹ã¡ä¸ŠãŒã‚Š: ${path.join(' â†’ ')}ã€‚`;
        }
    }
    
    // 5. ä»Šå¤§ä¼šã®é€šç®—æˆç¸¾ã®åˆ†æ (å¤‰æ›´ãªã—)
    for (const playerName in playerAggStats) {
        const stats = playerAggStats[playerName];
        if (stats.ab >= 5) { // 5æ‰“æ•°ä»¥ä¸Šã®é¸æ‰‹ã‚’å¯¾è±¡
            const battingAverage = (stats.ab > 0) ? (stats.h / stats.ab) : 0;
            if (battingAverage >= 0.4) {
                keyPerformances.add(`${playerName}ãŒæ‰“ç‡${battingAverage.toFixed(3)}ã¨çµ¶å¥½èª¿`);
            } else if (battingAverage <= 0.2 && battingAverage > 0) { // 0å‰²ã¯ä¸æŒ¯ã¨è¨€ã‚ãªã„
                keyPerformances.add(`${playerName}ãŒæ‰“ç‡${battingAverage.toFixed(3)}ã¨ä¸æŒ¯`);
            }
        }
    }
    
    if (keyPerformances.size > 0) {
        summary += ` ä»Šå¤§ä¼šã®ä¸»ãªæ´»èº: ${Array.from(keyPerformances).join('ã€')}ã€‚`;
    }

    return summary;
}
// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼

/**
 * æœ¬æ ¼çš„ãªã¾ã¨ã‚ã‚µã‚¤ãƒˆã®HTMLã‚’ã€ç¾å®Ÿã¨æ¶ç©ºã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’èåˆã•ã›ã¦ç”Ÿæˆã™ã‚‹
 * (â˜…ã€Œãƒ©ã‚¦ãƒ³ãƒ‰ç·æ‹¬ã‚¹ãƒ¬ãƒƒãƒ‰ã€ã‚‚ä¸€è¦§ã«è¡¨ç¤ºã™ã‚‹ã‚ˆã†ä¿®æ­£)
 * @returns {Promise<string>} ç”Ÿæˆã•ã‚ŒãŸHTMLæ–‡å­—åˆ—
 */
async function generateMatomeSiteHtml() {
    let articles = [];
    
    // --- 1. ç¾å®Ÿã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ã¾ã¨ã‚ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ---
    try {
        const response = await fetch('/.netlify/functions/get-news');
        if (!response.ok) {
            throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`);
        }
        const realNewsArticles = await response.json();
        articles.push(...realNewsArticles);

    } catch (e) {
        console.error("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
        articles.push({ headline: "ã€é€Ÿå ±ã€‘ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚µãƒ¼ãƒãƒ¼ã€ãƒ€ã‚¦ãƒ³ä¸­", type: 'real', timestamp: Date.now(), category: 'ã‚·ã‚¹ãƒ†ãƒ ' });
    }

    // --- 2. ã‚²ãƒ¼ãƒ å†…ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å–å¾— ---
    const gameNewsList = tournamentState.news || [];
    
    // (A) è©¦åˆçµæœã®è¨˜äº‹ (dbMatch ã‚’æŒã¤)
    gameNewsList.filter(n => n.context && n.context.dbMatch).slice(-5).forEach(gameNews => {
        const { winnerName, loserName, dbMatch } = gameNews.context;
        const winnerRank = calculateRank(winnerName, tournamentState);
        const loserRank = calculateRank(loserName, tournamentState);
        const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
        let gameTitle = `ã€é«˜æ ¡é‡çƒã€‘${winnerName}ãŒ${loserName}ã«å‹åˆ©ï¼`;

        if (rankValues[winnerRank] < rankValues[loserRank]) {
            gameTitle = `ã€è¶…çµ¶æ‚²å ±ã€‘${loserName}(${loserRank}ãƒ©ãƒ³ã‚¯)ã€æ ¼ä¸‹ã®${winnerName}(${winnerRank}ãƒ©ãƒ³ã‚¯)ã«è² ã‘ã‚‹ï½—ï½—ï½—ï½—`;
        } else if ((parseInt(dbMatch.score1) + parseInt(dbMatch.score2)) > 15) {
            gameTitle = `ã€ä¹±æ‰“æˆ¦ã€‘${winnerName}vs${loserName}ã€ã¨ã‚“ã§ã‚‚ãªã„è©¦åˆã«ãªã‚‹`;
        }
        
        articles.push({
            headline: gameTitle,
            type: 'game',
            matchId: dbMatch.id,
            timestamp: gameNews.timestamp,
            category: 'é«˜æ ¡é‡çƒ'
        });
    });
    
    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
    // (B) ãƒ©ã‚¦ãƒ³ãƒ‰ç·æ‹¬ã®è¨˜äº‹ (isMatomeLink ã‚’æŒã¤)
    gameNewsList.filter(n => n.isMatomeLink === true).forEach(summaryNews => {
        articles.push({
            headline: summaryNews.title, // è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: ã€1å›æˆ¦ ç·æ‹¬ã€‘...)
            type: 'game', // ã¾ã¨ã‚ã‚¹ãƒ¬ãƒƒãƒ‰ãªã®ã§ 'game' ã‚¿ã‚¤ãƒ—ã¨ã—ã¦æ‰±ã†
            matchId: summaryNews.matomeThreadId, // ãƒªãƒ³ã‚¯å…ˆã®ã‚¹ãƒ¬ãƒƒãƒ‰ID
            timestamp: summaryNews.timestamp,
            category: 'å¤§ä¼šç·æ‹¬' // å°‚ç”¨ã‚«ãƒ†ã‚´ãƒª
        });
    });
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    // --- 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å–å¾— ---
    const userThreads = tournamentState.userThreads || [];
    userThreads.forEach(userThread => {
        articles.push(userThread);
    });

    // --- 4. å…¨è¨˜äº‹ã‚’ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ã‚½ãƒ¼ãƒˆã—ã¦HTMLã‚’ç”Ÿæˆ ---
    articles.sort((a, b) => b.timestamp - a.timestamp);

    if (articles.length === 0) {
        return '<p class="text-center text-gray-500">ã¾ã è¡¨ç¤ºã§ãã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
    }

    const categoryColors = {
        "é«˜æ ¡é‡çƒ": "bg-green-100 text-green-800",
        "å¤§ä¼šç·æ‹¬": "bg-yellow-100 text-yellow-800", // â˜…ç·æ‹¬ã‚¹ãƒ¬ãƒƒãƒ‰ç”¨ã®è‰²
        "è‡ªã‚¹ãƒ¬": "bg-blue-100 text-blue-800", // â˜…è‡ªã‚¹ãƒ¬ç”¨ã®è‰²
        "ã‚¹ãƒãƒ¼ãƒ„": "bg-blue-100 text-blue-800",
        "ã‚¨ãƒ³ã‚¿ãƒ¡": "bg-pink-100 text-pink-800",
        "å›½å†…": "bg-indigo-100 text-indigo-800",
        "å›½éš›": "bg-teal-100 text-teal-800",
        "çµŒæ¸ˆ": "bg-yellow-100 text-yellow-800",
        "IT": "bg-purple-100 text-purple-800",
        "ç§‘å­¦": "bg-gray-200 text-gray-800",
        "ä¸»è¦": "bg-red-100 text-red-800",
        "ã‚·ã‚¹ãƒ†ãƒ ": "bg-red-100 text-red-800"
    };

    return articles.map(article => {
        const time = new Date(article.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        const commentCount = Math.floor(Math.random() * 800) + 50;
        const color = categoryColors[article.category] || "bg-gray-100 text-gray-800";

        const linkHref = article.type === 'real' ? `href="${article.url}" target="_blank" rel="noopener noreferrer"` : 'href="javascript:void(0)"';
        const dataAttributes = `data-headline="${article.headline}" data-type="${article.type}" data-category="${article.category}" data-match-id="${article.matchId || ''}"`;

        return `
            <a ${linkHref} class="matome-article-link block p-3 rounded-lg hover:bg-gray-100 transition-colors" ${dataAttributes}>
                <div class="flex items-center text-xs text-gray-500">
                    <span class="font-bold py-0.5 px-2 rounded-full ${color}">${article.category}</span>
                    <span class="ml-auto">${time}</span>
                </div>
                <p class="font-bold text-gray-800 mt-2 text-base">${article.headline}</p>
                <div class="text-right text-xs text-gray-500 mt-1">ã‚³ãƒ¡ãƒ³ãƒˆ: ${commentCount} ğŸ’¬</div>
            </a>
        `;
    }).join('');
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²


/**
 * [ä¿®æ­£ç‰ˆ] ã‚²ãƒ¼ãƒ å†…ã®è©¦åˆçµæœã«å¯¾ã™ã‚‹ã€ãªã‚“Jã¾ã¨ã‚ã‚µã‚¤ãƒˆé¢¨ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’AIã«ç”Ÿæˆã•ã›ã‚‹
 * (â˜…ã€Œè»½å‚·ã€é¸æ‰‹ã¨ã€Œé‡è¦åº¦ã€ã¸ã®è¨€åŠæŒ‡ç¤ºã‚’å¼·åŒ–)
 */
async function generateGameMatchBbsComments(matchContext) {
    const { 
        winnerName, loserName, dbMatch, matchId, playerStatsText, 
        winnerJourney, loserJourney, nextOpponent, nextOpponentJourney, 
        winnerLineupChanges, loserLineupChanges, highlights,
        injuryReport
    } = matchContext;

    const score = `${dbMatch.score1}-${dbMatch.score2}`;
    const winnerData = TEAM_DATA[winnerName];
    const loserData = TEAM_DATA[loserName];
    const winnerDynamicInfo = generateDynamicTeamInfo(winnerName, winnerData, tournamentState.teamRecords[winnerName]);
    const loserDynamicInfo = generateDynamicTeamInfo(loserName, loserData, tournamentState.teamRecords[loserName]);
    const winnerRank = calculateRank(winnerName, tournamentState);
    const loserRank = calculateRank(loserName, tournamentState);
    const loserRankDesc = getRankDescription(loserRank);
    const winnerSeedRank = getSeedRankString(winnerName, tournamentState.seeds);
    const loserSeedRank = getSeedRankString(loserName, tournamentState.seeds);
    const tournamentName = tournamentNameMap[tournamentState.currentTournament] || 'å¤§ä¼š';
    const tournamentYear = tournamentState.tournamentYear;
    let tournamentBbsContext = "";
    if (tournamentState.currentTournament === 'summer') {
        tournamentBbsContext = "3å¹´ç”Ÿã«ã¨ã£ã¦ã¯ã‚¬ãƒã§æœ€å¾Œã®å¤ã‚„ã€‚";
    } else if (tournamentState.currentTournament === 'autumn') {
        tournamentBbsContext = "æ–°ãƒãƒ¼ãƒ ã®åˆé™£ã‚„ãªã€‚ã“ã“ã§ã®çµæœãŒã‚»ãƒ³ãƒãƒ„é¸è€ƒã«éŸ¿ãã§ã€‚";
    } else if (tournamentState.currentTournament === 'spring') {
        tournamentBbsContext = "å¤ã®ã‚·ãƒ¼ãƒ‰æ¨©ãŒã‹ã‹ã£ãŸå‰å“¨æˆ¦ã‚„ã€‚";
    }

    let nextOpponentText = 'æ¬¡ã®ç›¸æ‰‹ã¯æœªå®šã‚„ãªã€‚';
    if (nextOpponent) {
        if (nextOpponent.opponentName === 'å„ªå‹') {
            nextOpponentText = (tournamentState.currentTournament === 'summer')
                ? 'å¤ã®ç”²å­åœ’å‡ºå ´æ±ºå®šã‚„ï¼'
                : (tournamentState.currentTournament === 'autumn' ? 'ã‚»ãƒ³ãƒãƒ„å‡ºå ´ãŒæœ‰åŠ›ã¨ãªã£ãŸã€‚' : 'ä»Šå¤§ä¼šã€è¦‹äº‹å„ªå‹ã‚’æœãŸã—ãŸã€‚');
        }
        else if (nextOpponent.opponentName && nextOpponent.opponentName !== 'ï¼ˆæœªå®šï¼‰') {
            const nextOpponentSeed = getSeedRankString(nextOpponent.opponentName, tournamentState.seeds); 
            const rankText = nextOpponent.opponentRank ? `(ãƒ©ãƒ³ã‚¯:${nextOpponent.opponentRank})` : '';
            nextOpponentText = `æ¬¡ã®${nextOpponent.roundName}ã®ç›¸æ‰‹ã¯${nextOpponent.opponentName}${nextOpponentSeed}${rankText}ã‹ã€‚`;
        } 
        else if (nextOpponent.decidingMatch) {
            const dm = nextOpponent.decidingMatch;
            const team1Seed = getSeedRankString(dm.team1, tournamentState.seeds); 
            const team2Seed = getSeedRankString(dm.team2, tournamentState.seeds); 
            nextOpponentText = `æ¬¡ã®${nextOpponent.roundName}ã®ç›¸æ‰‹ã¯ã€${dm.team1}${team1Seed}(${dm.rank1}ãƒ©ãƒ³ã‚¯)ã¨${dm.team2}${team2Seed}(${dm.rank2}ãƒ©ãƒ³ã‚¯)ã®å‹è€…ã‚„ãªã€‚`;
        }
    }
    const nextOpponentJourneyText = (nextOpponent && nextOpponentJourney) ? `ã¡ãªã¿ã«ã€ãã®${nextOpponent.opponentName}ã®ã“ã“ã¾ã§ã®è»Œè·¡ã¯ã€Œ${nextOpponentJourney}ã€ã€‚` : '';

    let highlightsText = 'ä¸»ãªå‡ºæ¥äº‹ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
    if (highlights && highlights.length > 0) {
        highlightsText = highlights.map(fact => `- ${fact.inning || ''}å› ${fact.team || ''} ${fact.player || ''}: ${fact.description}`).join('\n');
    }

    const roundName = getRoundNameFromMatchId(matchId);
    
    const hadaReportText = matchContext.hadaReportSummary ? `\n### ãƒ‡ãƒ¼ã‚¿6ï¼šè¨˜è€…ã®è¦–ç‚¹ï¼ˆç¾½ç”°ãƒ¬ãƒãƒ¼ãƒˆï¼‰\n${matchContext.hadaReportSummary}\n` : '';
    const calledGameText = matchContext.calledGame ? `\n- **ç‰¹è¨˜äº‹é …:** ${matchContext.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ` : '';
    const rivalryText = matchContext.rivalryType ? `\n- **ç‰¹è¨˜äº‹é …:** ã“ã®è©¦åˆã¯ã€Œ${matchContext.rivalryType}ã€ã¨ã„ã†å› ç¸ã®å¯¾æ±ºã§ã—ãŸã€‚` : '';
    const lineupChangesText = `- ${winnerName}: ${winnerLineupChanges}\n- ${loserName}: ${loserLineupChanges}`;
    let atmosphereText = '';
    if (matchContext.atmosphere_team1 || matchContext.atmosphere_team2) {
        atmosphereText = '\n### ãƒ‡ãƒ¼ã‚¿6ï¼šè©¦åˆå‰ã®é›°å›²æ°—ãƒ»å…¬ç´„\n';
        if (matchContext.atmosphere_team1) atmosphereText += `- ${dbMatch.team1}: ${matchContext.atmosphere_team1}\n`;
        if (matchContext.atmosphere_team2) atmosphereText += `- ${dbMatch.team2}: ${matchContext.atmosphere_team2}\n`;
    }
    let scheduleText = '';
    if (matchContext.schedule) {
        const sched = matchContext.schedule;
        const team1Region = TEAM_DATA[dbMatch.team1]?.region || 'ä¸æ˜';
        const team2Region = TEAM_DATA[dbMatch.team2]?.region || 'ä¸æ˜';
        let advantage = 'ãªã—';
        if (sched.region === team1Region && sched.region !== team2Region) advantage = `${dbMatch.team1}ã®åœ°å…ƒ`;
        else if (sched.region !== team1Region && sched.region === team2Region) advantage = `${dbMatch.team2}ã®åœ°å…ƒ`;
        scheduleText = `\n### ãƒ‡ãƒ¼ã‚¿7ï¼šçƒå ´æƒ…å ±\n- **çƒå ´:** ${sched.stadiumFull} (${sched.region}åœ°åŒº)\n- **åœ°ã®åˆ©:** ${advantage}\n`;
    }
    let ballQualityText = '';
    if (matchContext.team1BallQuality && matchContext.team2BallQuality) {
        ballQualityText = `\n### ãƒ‡ãƒ¼ã‚¿3ï¼šãƒãƒ¼ãƒ åˆ¥ æ‰“çƒå“è³ªãƒ¬ãƒãƒ¼ãƒˆ\n- ${matchContext.team1BallQuality}\n- ${matchContext.team2BallQuality}\n`;
    }
    
    let cinderellaPraiseInstruction = "";
    const idParts = matchId.split('-');
    let roundNum = 0;
    if (idParts[0] !== 'F' && idParts[1] && idParts[1].startsWith('R')) {
        roundNum = parseInt(idParts[1].slice(1));
    }
    if ( (loserRank === 'E' && roundNum >= 3) ||
         (loserRank === 'D' && roundNum >= 4) ||
         (loserRank === 'C' && roundNum >= 5) )
    {
        cinderellaPraiseInstruction = `
- **ã€â˜…å¿«é€²æ’ƒã¸ã®è¨€åŠã€‘**: æ•—åŒ—ã—ãŸ${loserName}ã¯${loserRankDesc}(${loserRank}ãƒ©ãƒ³ã‚¯)ã ã£ãŸãŒã€${roundName}ã¾ã§å‹ã¡ä¸ŠãŒã£ãŸã€‚ã“ã®ã€Œå¿«é€²æ’ƒã€ã‚’**ã€Œ${loserName}ã€ã‚ˆã†ã‚„ã£ã¨ã‚‹ã€ã€Œæ¥å¹´ãŒæ¥½ã—ã¿ãªãƒãƒ¼ãƒ ã€**ã®ã‚ˆã†ã«ã€å¿…ãšç§°è³›ã™ã‚‹ã“ã¨ã€‚`;
    }
    
// â–¼â–¼â–¼ 1. ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆï¼ˆã“ã“ã«è¿½åŠ ï¼‰ â–¼â–¼â–¼
    let interviewPromptPart = "";
    if (matchContext.interview) {
        const { manager, hero } = matchContext.interview;
        
        interviewPromptPart = `
### ã€é€Ÿå ±ã€‘è©¦åˆå¾Œã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼
**â–  å‹åˆ©ç›£ç£**
Q: ${manager.question}
A: "${manager.answer}"

**â–  ãƒ’ãƒ¼ãƒ­ãƒ¼é¸æ‰‹**
Q: ${hero.question}
A: "${hero.answer}"

**è¿½åŠ æŒ‡ç¤º:** ã‚¹ãƒ¬ãƒƒãƒ‰ã®æµã‚Œã®ä¸­ã§ã€ã“ã®ç›£ç£ã‚„é¸æ‰‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã«è¨€åŠã—ã¦ãã ã•ã„ã€‚
ï¼ˆä¾‹ï¼š>>15ã€Œç›£ç£ã®ã‚³ãƒ¡ãƒ³ãƒˆæ³£ã‘ã‚‹ã‚ã€ >>22ã€Œã€‡ã€‡é¸æ‰‹ã®ã€${hero.answer.substring(0, 10)}...ã€ã£ã¦ç™ºè¨€ã€é ¼ã‚‚ã—ã™ãã‚‹ã ã‚ã€ãªã©ï¼‰
`;
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    const prompt = `ã‚ãªãŸã¯ã€åŒ¿åæ²ç¤ºæ¿ã€Œãªã‚“ã§ã‚‚å®Ÿæ³Jï¼ˆãªã‚“Jï¼‰ã€ã®ä½æ°‘ã§ã™ã€‚ã‚ãªãŸã¯é«˜æ ¡é‡çƒã«è©³ã—ãã€ç…½ã‚Šã‚„ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚’äº¤ãˆãªãŒã‚‰ä¼šè©±ã‚’ç››ã‚Šä¸Šã’ã¾ã™ã€‚
ä»¥ä¸‹ã®è©¦åˆãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€ãƒ•ã‚¡ãƒ³ãŸã¡ã®ãƒªã‚¢ãƒ«ãªä¼šè©±ã‚³ãƒ¡ãƒ³ãƒˆã‚’**25ã€œ27å€‹**ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰
${PREFECTURE_LORE}

### ç¾åœ¨ã®è©¦åˆçŠ¶æ³
- **å¤§ä¼š:** ${tournamentYear}å¹´åº¦ ${tournamentName}
- **æ–‡è„ˆ:** ${tournamentBbsContext}
- **ãƒ©ã‚¦ãƒ³ãƒ‰:** ${roundName}
${scheduleText} 

### ãƒ‡ãƒ¼ã‚¿1ï¼šè©¦åˆçµæœ
- **å‹åˆ©:** ${winnerName} ${winnerSeedRank} (ãƒ©ãƒ³ã‚¯: ${winnerRank})
- **æ•—åŒ—:** ${loserName} ${loserSeedRank} (ãƒ©ãƒ³ã‚¯: ${loserRank})
- **ã‚¹ã‚³ã‚¢:** ${score}
- **ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´:**
${lineupChangesText}
${calledGameText} 
${rivalryText} 
${injuryReport || ''}
${interviewPromptPart}
### ãƒ‡ãƒ¼ã‚¿2ï¼šãƒãƒ¼ãƒ ã®èƒŒæ™¯
- **${winnerName} ${winnerSeedRank}**: ${winnerDynamicInfo}
  - **è»Œè·¡**: ${winnerJourney}
- **${loserName} ${loserSeedRank}**: ${loserDynamicInfo}
  - **è»Œè·¡**: ${loserJourney}

### ãƒ‡ãƒ¼ã‚¿3ï¼šã“ã®è©¦åˆã®å€‹äººæˆç¸¾ (æœ€çµ‚çµæœã®è¦ç´„)
${playerStatsText || 'å€‹äººæˆç¸¾ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}

### ãƒ‡ãƒ¼ã‚¿4ï¼šè©¦åˆã®ä¸»ãªå‡ºæ¥äº‹ (ãƒã‚¤ãƒ©ã‚¤ãƒˆ)
${highlightsText}
${ballQualityText} 

### ãƒ‡ãƒ¼ã‚¿5ï¼šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆå…¨ä½“ã®çŠ¶æ³
- **${winnerName}ã®è»Œè·¡(å‹ã¡ä¸ŠãŒã‚Š)**: ${winnerJourney || 'ä»Šå¤§ä¼šåˆæˆ¦'}
- **æ¬¡ã®è©¦åˆ**: ${nextOpponentText} ${nextOpponentJourneyText}
${atmosphereText}
${hadaReportText}

### ãƒ‡ãƒ¼ã‚¿6ï¼šä»Šå¤§ä¼šã®ä¸»ãªæŠ•æ‰‹ç™»æ¿å±¥æ­´ (ã“ã®è©¦åˆã‚ˆã‚Šå‰)
${matchContext.pitcherGamelogInfo || 'ä»Šå¤§ä¼šã€ã“ã‚ŒãŒåˆç™»æ¿ã§ã™ã€‚'}

### ãƒ‡ãƒ¼ã‚¿7ï¼šä»Šå¤§ä¼šã®ä¸»ãªæ‰“è€…æˆç¸¾å±¥æ­´ (ã“ã®è©¦åˆã‚ˆã‚Šå‰)
${matchContext.batterGamelogInfo || 'æ‰“è€…ã®è©¦åˆå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}

### æŒ‡ç¤º
ã‚ãªãŸã¯ä»Šã€ä¸Šè¨˜ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’çœºã‚ãªãŒã‚‰ã€ä»–ã®ãƒ•ã‚¡ãƒ³ã¨ä¼šè©±ã—ã¦ã„ã¾ã™ã€‚**ç¾åœ¨ã®è©¦åˆãŒã€Œ${roundName}ã€ã§ã‚ã‚‹ã“ã¨**ã€**å‹è€…ã®è»Œè·¡**ã€**æ¬¡ã®è©¦åˆæƒ…å ±**ã‚’è¸ã¾ãˆã¤ã¤ã€ä»¥ä¸‹ã®ç‚¹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã¦ãã ã•ã„ã€‚

- **ã€â˜…å¤§ä¼šã®æ–‡è„ˆã‚’åæ˜ ã€‘**: ${tournamentName}ãªã‚‰ã§ã¯ã®è¦–ç‚¹ï¼ˆä¾‹ï¼šã€Œå¤ã¯3å¹´ç”Ÿæœ€å¾Œã‚„ãªã€ã€Œç§‹ã®æ–°ãƒãƒ¼ãƒ ã®ä»•ä¸ŠãŒã‚Šè¦‹ãˆã¦ããŸãªã€ï¼‰ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã‚‹ã“ã¨ã€‚
- **ã€â˜…â˜…æ¬ å ´è€…ã¸ã®è¨€åŠ (æœ€é‡è¦)ã€‘**: ã‚‚ã—ã€Œä¸»ãªæ¬ å ´è€…ã€ã«é¸æ‰‹åï¼ˆä¾‹ï¼šã€‡ã€‡ [ğŸ¥] (ä¸»åŠ›), â–³â–³ [ğŸ©¹] (æ§ãˆ)ï¼‰ãŒã‚ã‚‹å ´åˆã€ãã®é¸æ‰‹ã®**é‡è¦åº¦ï¼ˆä¸»åŠ›ã‹æ§ãˆã‹ï¼‰**ã«å¿œã˜ã¦ã€åå¿œã®æ·±åˆ»åº¦ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€ã‚¨ãƒ¼ã‚¹å§«å·(ä¸»åŠ›)æŠœãã§ã‚ˆãå‹ã£ãŸã‚ã€ã€éˆ´æœ¨(æ§ãˆ)ã®æ€ªæˆ‘ã¯ç—›ã„ãŒã€ã¾ã...ã€ï¼‰
${cinderellaPraiseInstruction}
- **ã€æœ€é‡è¦ï¼šæ¬¡æˆ¦æƒ…å ±ã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿5ã€ã®**\`æ¬¡ã®è©¦åˆ:\`** ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹æƒ…å ±ã‚’**å¿…ãš**ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã¦ãã ã•ã„ã€‚ã€Œæ¬¡ã¯ã€‡ã€‡ã‹â€¦ã€ã®ã‚ˆã†ã«å…·ä½“çš„ã«è¨€åŠã—ã€**ã€Œæœªå®šã€ã¨ã„ã†è¨€è‘‰ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚**ã‚ãªãŸã¯ä»Šã€ä¸Šè¨˜ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’çœºã‚ãªãŒã‚‰ã€ä»–ã®ãƒ•ã‚¡ãƒ³ã¨ä¼šè©±ã—ã¦ã„ã¾ã™ã€‚**ç¾åœ¨ã®è©¦åˆãŒã€Œ${roundName}ã€ã§ã‚ã‚‹ã“ã¨**ã€**å‹è€…ã®è»Œè·¡**ã€**æ¬¡ã®è©¦åˆæƒ…å ±**ã‚’è¸ã¾ãˆã¤ã¤ã€ä»¥ä¸‹ã®ç‚¹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã¦ãã ã•ã„ã€‚

- **ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘**: è©¦åˆæƒ…å ±ã«ã€Œ(ç¬¬1ã‚·ãƒ¼ãƒ‰)ã€ãªã©ã®ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚**ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã•ã™ãŒã‚„ãªã€ã€Œç¬¬5ã‚·ãƒ¼ãƒ‰ãŒè² ã‘ãŸãƒ³ã‚´wwwã€**ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚å…·ä½“çš„ã«è¨€åŠã—ã¦ãã ã•ã„ã€‚
- **ã€æœ€é‡è¦ï¼šæ¬¡æˆ¦æƒ…å ±ã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿5ã€ã®**\`æ¬¡ã®è©¦åˆ:\`** ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹æƒ…å ±ã‚’**å¿…ãš**ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã¦ãã ã•ã„ã€‚ã€Œæ¬¡ã¯ã€‡ã€‡ã‹â€¦ã€ã®ã‚ˆã†ã«å…·ä½“çš„ã«è¨€åŠã—ã€**ã€Œæœªå®šã€ã¨ã„ã†è¨€è‘‰ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚**
- **ã€è©¦åˆã¸ã®åå¿œã€‘**:
    - è©¦åˆçµæœï¼ˆã‚¹ã‚³ã‚¢ã€å‹æ•—ï¼‰ã«å¯¾ã™ã‚‹æ„Ÿæƒ³ã€‚
    - ã€Œãƒ‡ãƒ¼ã‚¿3ï¼ˆå€‹äººæˆç¸¾ï¼‰ã€ã‚„ã€Œãƒ‡ãƒ¼ã‚¿4ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ã€ã§ç›®ç«‹ã£ãŸé¸æ‰‹ã‚„ãƒ—ãƒ¬ãƒ¼ã¸ã®è¨€åŠã€‚ã€Œãƒ‡ãƒ¼ã‚¿3ã€ã®**èƒŒç•ªå·**ã«ã‚‚æ³¨ç›®ã™ã‚‹ã“ã¨ã€‚
    - **ï¼ˆé‡è¦ï¼‰** 1æ¡ç•ªå·ï¼ˆã‚¨ãƒ¼ã‚¹/ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ï¼‰ãŒæ´»èºã™ã‚‹ã®ã¯å½“ç„¶ã ãŒã€**èƒŒç•ªå·2æ¡ã®é¸æ‰‹ãŒæ´»èºã—ãŸå ´åˆ**ã€ãã‚Œã‚’ã€Œæ§ãˆã®æ´»èºã€ã¨å®‰æ˜“ã«æ–­å®šã›ãšã€ã€Œ**èƒŒç•ªå·10ã ã‘ã©å®Ÿè³ªã‚¨ãƒ¼ã‚¹**ã€ã€Œ**2æ¡ã®ã€‡ã€‡ãŒä»•äº‹ã—ãŸãª**ã€ã¨ã„ã£ãŸã€**ãã®é¸æ‰‹ã®å®ŸåŠ›ã‚’è©•ä¾¡ã™ã‚‹**ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã€‚
    - ã‚‚ã—æ•—åŒ—ãƒãƒ¼ãƒ ãŒå–„æˆ¦ã—ãŸå ´åˆ (ã‚¹ã‚³ã‚¢å·®ãŒå°ã•ã„ã€ãƒ©ãƒ³ã‚¯å·®ãŒã‚ã‚‹ã®ã«æ¥æˆ¦ãªã©) ã¯ã€ãã®å¥é—˜ã‚’ç§°ãˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã€‚
- **ã€å¸¸è­˜ã®åæ˜ ã€‘**: ã‚ãªãŸãŒç†ŸçŸ¥ã—ã¦ã„ã‚‹ã€Œå¸¸è­˜ã€ï¼ˆä¾‹ï¼šãƒŠãƒ ã‚³ vs å…¬ç«‹ã®ç ¦ã€å¤è±ªã®å¾©æ´»ã€ç‹è€…283å­¦åœ’ã®å‹•å‘ï¼‰ã‚’ã€è©¦åˆçµæœã‚„ãƒ‡ãƒ¼ã‚¿ã¨é–¢é€£ä»˜ã‘ã¦ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã“ã¨ã€‚
- **ã€ãã®ä»–ã€‘**:
    - ãªã‚“Jã‚‰ã—ã„çŸ­ã„ç…½ã‚Šã‚„è‰(w)ã‚’é©åº¦ã«å«ã‚ã‚‹ã€‚
    - ä»–ã®ã‚³ãƒ¡ãƒ³ãƒˆã¸ã®å®‰ä¾¡ (>>) ã‚’ã„ãã¤ã‹å«ã‚ã‚‹ã€‚
    - ãƒ©ãƒ³ã‚¯åã‚’è¨€ã„æ›ãˆã‚‹ï¼ˆAâ†’åé–€ã€Bâ†’å¼·è±ªã€Câ†’ä¸­å …ã€Dâ†’æŒ‘æˆ¦æ ¡ã€Eâ†’ç„¡åæ ¡ï¼‰ã€‚
- **#ã¯èƒŒç•ªå·ã¨è¨€ã„æ›ãˆã¦ãã ã•ã„ã€‚(ä¾‹ã€€#1â†’èƒŒç•ªå·1)**
- **ã€ç¾½ç”°ãƒ¬ãƒãƒ¼ãƒˆã¸ã®è¨€åŠã€‘**: ã‚‚ã—ã€Œãƒ‡ãƒ¼ã‚¿6ï¼šè¨˜è€…ã®è¦–ç‚¹ã€ã«ç¾½ç”°è¨˜è€…ã®åˆ†æãŒã‚ã‚‹å ´åˆã€**ã€Œç¾½ç”°ã¨ã‹ã„ã†è¨˜è€…ãŒï½ã£ã¦è¨€ã£ã¦ãŸã‘ã©â€¦ã€** ã®ã‚ˆã†ã«ã€ãã®åˆ†æã«åŒæ„ã—ãŸã‚Šã€åè«–ã—ãŸã‚Šã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’**å¿…ãš**å«ã‚ã‚‹ã“ã¨ã€‚
- **ã€è©¦åˆå‰ã®é›°å›²æ°—ã€‘**: ã‚‚ã—ã€Œãƒ‡ãƒ¼ã‚¿6ï¼šè©¦åˆå‰ã®é›°å›²æ°—ãƒ»å…¬ç´„ã€ãŒæä¾›ã•ã‚Œã¦ã„ãŸã‚‰ï¼ˆä¾‹ï¼šã€Œã‚¨ãƒ¼ã‚¹æ¸©å­˜å…¬è¨€ã€ã€Œã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³æœ€æ‚ªã€ãªã©ï¼‰ã€**ãã®ä¼ç·šãŒè©¦åˆçµæœã§ã©ã†ãªã£ãŸã‹**ã«ã¤ã„ã¦ï¼ˆä¾‹ï¼šã€ŒãªãŠå§«ã€ã€Œæ¸©å­˜ï¼ˆï¼‰ã€ã€Œã‚„ã£ã±ä½“èª¿æ‚ªã‹ã£ãŸã‚“ã‹ã€ï¼‰å¿…ãšè¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€çƒå ´ã¸ã®è¨€åŠã€‘**: ã‚‚ã—ã€Œãƒ‡ãƒ¼ã‚¿7ï¼šçƒå ´æƒ…å ±ã€ãŒã‚ã‚Šã€ã€Œåœ°ã®åˆ©ã€ãŒã©ã¡ã‚‰ã‹ã®ãƒãƒ¼ãƒ ã«ã‚ã£ãŸå ´åˆï¼ˆä¾‹ï¼šé™å²¡ãŒè‰è–™ã§è©¦åˆï¼‰ã€**ã€Œè¬ã®åŠ›ã‚­ã‚¿ãƒ¼wã€ã€Œåœ°å…ƒåˆ¤å®šã‚„ã‚ã‚ã€ã€Œã€‡ã€‡ï¼ˆçƒå ´åï¼‰ã¾ã§é å¾ã”è‹¦åŠ´ã•ã‚“ã€**ãªã©ã€çƒå ´ã«é–¢ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¿…ãšå«ã‚ã‚‹ã“ã¨ã€‚
- **ã€â˜…ä»Šå¤§ä¼šã®æˆç¸¾ (æœ€é‡è¦)ã€‘**:
    - ã€Œãƒ‡ãƒ¼ã‚¿2ã€ã«**ã€ä»Šå¤§ä¼šã®ãƒãƒ¼ãƒ æ‰“ç‡ã¯.XXXã€**ã¨ã„ã†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
    - ã“ã®æƒ…å ±ã‚’**å¿…ãšã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚**ã€ãƒãƒ¼ãƒ ã®å¥½èª¿ãƒ»ä¸æŒ¯ï¼ˆä¾‹ï¼šã€Œã€‡ã€‡ã€ä»Šå¤§ä¼šæ‰“ç‡.150ã¨ã‹ãƒã‚¸ï¼Ÿã€ã€Œæ‰“ç‡3å‰²è¶…ãˆã®æ‰“ç·šç›¸æ‰‹ã«ã‚ˆãæŠ‘ãˆãŸã‚ã€ï¼‰ã«ã‚‚è¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€æŠ•æ‰‹ã®è©³ç´°å±æ€§ã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿3ï¼ˆãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ï¼‰ã€ã«ã€Œï¼ˆå³/ã‚ªãƒ¼ãƒãƒ¼/æœ¬æ ¼æ´¾/150kmå¸¯ï¼‰ã€ã¨ã„ã£ãŸ**æŠ•æ‰‹ã®è©³ç´°å±æ€§**ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã‚Œã«ã‚‚è¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€â˜…ç›—å¡ã¸ã®è¨€åŠ (é‡è¦)ã€‘**:
    - ã€Œãƒ‡ãƒ¼ã‚¿3ï¼ˆå€‹äººæˆç¸¾ï¼‰ã€ã«**ç›—å¡(SB)**ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹é¸æ‰‹ãŒã„ãŸå ´åˆã€ãã®é¸æ‰‹ã®æ©Ÿå‹•åŠ›ï¼ˆä¾‹ï¼šã€Œã€‡ã€‡ã€è¶³ã¯ãˆãƒ¼ãªwã€ã€Œè‰¯ã„ç›—å¡ã‚„ã£ãŸã€ï¼‰ã«è¨€åŠã™ã‚‹ã“ã¨ã€‚
    - ã•ã‚‰ã«ã€ãã®é¸æ‰‹ã®**ã€Œä»Šå¤§ä¼šã®é€šç®—ç›—å¡æ•°ã€**ï¼ˆä¾‹ï¼š(ä»Šå¤§ä¼š: ... 4ç›—)ï¼‰ã‚‚å¿…ãšå‚ç…§ã—ã€**ã€Œå§«å·ã€ä»Šå¤§ä¼š4ç›—å¡ç›®ã‹ã‚ˆwã€ã€Œã“ã„ã¤æ‰“ã¡ã™ãã ã—èµ°ã‚Šã™ãã ã‚ã€**ã¨ã„ã£ãŸå…·ä½“çš„ãªæ•°å­—ã«è¨€åŠã™ã‚‹ã“ã¨ã€‚
    - **ç›—å¡ãŒ0ã§ã‚‚æ‰¹åˆ¤ã¯ä¸è¦ã§ã™ã€‚**
- **ã€â˜…é€šç®—æˆç¸¾ã¸ã®è¨€åŠ (è£é‡)ã€‘**:
    - ã€Œãƒ‡ãƒ¼ã‚¿2ã€ã«**ã€(å‚è€ƒ: ãƒãƒ¼ãƒ é€šç®—æ‰“ç‡ .XXX, é€šç®— Y ç›—å¡)ã€**ã¨ã„ã†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€å¿…è¦ã«å¿œã˜ã¦ï¼ˆä¾‹ï¼šãƒãƒ¼ãƒ ã®ä¼çµ±çš„ãªæ©Ÿå‹•åŠ›ã‚’èªã‚‹éš›ãªã©ï¼‰ã€ãã®ã€Œé€šç®—ç›—å¡ã€ã«ã‚‚è¨€åŠã™ã‚‹ã“ã¨ã€‚
    - **ç›—å¡ãŒ0ã§ã‚‚æ‰¹åˆ¤ã¯ä¸è¦ã§ã™ã€‚**
- **ã€â˜…æ³¨ç›®ã®æ‰“å¸­ï¼ˆæœ€é‡è¦ï¼‰ã€‘**:
    - ã€Œãƒ‡ãƒ¼ã‚¿4ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ã€ã«ã€Œï¼ˆâ˜…æ³¨ç›®ï¼‰ã€ãƒãƒ¼ã‚¯ãŒä»˜ã„ã¦ã„ã‚‹æ‰“å¸­ãŒã€ã“ã®è©¦åˆã®**ã‚¿ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆ**ã‚„ã€‚
    - **ã€Œã‚ã®å ´é¢ãŒå…¨ã¦ã‚„ã£ãŸãªã€ã€Œã‚ãã“ã®ï¼ˆâ˜…æ³¨ç›®ï¼‰ã€‡ã€‡ã®æ‰“å¸­ãŒãƒ‡ã‚«ã™ããŸã€**ã®ã‚ˆã†ã«ã€ãã®ã€Œâ˜…æ³¨ç›®ã€ã®æ‰“å¸­ãŒè©¦åˆã®å‹æ•—ã‚’åˆ†ã‘ãŸæ±ºå®šçš„ãªç¬é–“ã§ã‚ã£ãŸã¨è¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€ã‚³ãƒ¼ãƒ«ãƒ‰/å› ç¸ã€‘**: ã‚‚ã—è©¦åˆãŒã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ã‚„ã€Œ${matchContext.rivalryType || 'å› ç¸ã®å¯¾æ±º'}ã€ã§ã‚ã£ãŸå ´åˆã€ãã®ç‚¹ã«ã¤ã„ã¦å¿…ãšè¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´ã€‘**:ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´ãŒã‚ã£ãŸå ´åˆ(${lineupChangesText})è§¦ã‚Œãªã•ã„ã€‚
- **ã€é¸æ‰‹ã®çŠ¶æ…‹ã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿3ï¼ˆå€‹äººæˆç¸¾ï¼‰ã€ã«ã€Œ(çŠ¶æ…‹: ã€‡ã€‡)ã€ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹é¸æ‰‹ã«æ³¨ç›®ã—ã€ã€Œçµ¶å¥½èª¿ã®ã€‡ã€‡ã€ä»Šæ—¥ã‚‚æ‰“ã£ãŸãªwã€ã€Œä¸æŒ¯ã ã£ãŸâ–³â–³ã€ã¤ã„ã«ç›®è¦šã‚ãŸã‹ï¼Ÿã€ãªã©ã€**å‰å›ã®è©¦åˆã‹ã‚‰ã®é€£ç¶šæ€§**ã‚’æ„è­˜ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’ã™ã‚‹ã“ã¨ã€‚
- **ã€æ‰“çƒã®è³ªï¼ˆæ‰“è€…ãƒ»æŠ•æ‰‹ï¼‰ã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿3ï¼ˆå€‹äººæˆç¸¾ï¼‰ã€ã‚„ã€Œãƒ‡ãƒ¼ã‚¿4ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ã€ã«ã‚ã‚‹**æ‰“çƒã®è³ª**ï¼ˆã€Œé‹­ã„å½“ãŸã‚Šã€ã€Œè©°ã¾ã£ãŸå½“ãŸã‚Šã€ãªã©ï¼‰ã«ã‚‚æ³¨ç›®ã™ã‚‹ã“ã¨ã€‚
- **ã€æ‰“çƒã®è³ªï¼ˆãƒãƒ¼ãƒ å…¨ä½“ï¼‰ã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿3ï¼šãƒãƒ¼ãƒ åˆ¥ æ‰“çƒå“è³ªã€ã‚’è¦‹ã¦ã€ãƒãƒ¼ãƒ å…¨ä½“ã®èª¿å­ã«ã¤ã„ã¦è¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€æ‰“é †ã®å½¹å‰²ã€‘**: ã€Œå¸¸è­˜ã€ã¨ã—ã¦ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã•ã‚ŒãŸ**æ‰“é †ã®å½¹å‰²**ã‚’æ„è­˜ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã“ã¨ã€‚
- **ã€æŠ•æ‰“ã®å·¦å³ã®ç›¸æ€§ã€‘**:
    - ã€Œãƒ‡ãƒ¼ã‚¿2ï¼ˆå¸¸è­˜ï¼‰ã€ã¨ã€Œãƒ‡ãƒ¼ã‚¿3ï¼ˆãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ï¼‰ã€ã«ã‚ã‚‹**æŠ•æ‰“ã®å·¦å³**ã«ã‚‚æ³¨ç›®ã™ã‚‹ã“ã¨ã€‚
    - **ç‰¹ã«ã€ç›¸æ‰‹ãŒã€Œå·¦è…•ï¼ˆã‚µã‚¦ã‚¹ãƒãƒ¼ï¼‰ã€ã ã£ãŸå ´åˆ**ã‚„ã€ç›£ç£ãŒ**ã€Œãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆãƒªãƒªãƒ¼ãƒ•ã€**ã‚’ä½¿ã£ãŸå ´åˆã«ã€ãã®ç›¸æ€§ã«ã¤ã„ã¦è¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€â˜…ã‚¹ã‚¿ãƒ¡ãƒ³å¾©å¸°ã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿1ï¼šã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´ã€ã«ã€Œã€‡ã€‡ãŒã‚¹ã‚¿ãƒ¡ãƒ³å¾©å¸°ã€ã¨ã‚ã£ãŸå ´åˆã€**ã€ŒãŠãŠã€ã€‡ã€‡æˆ»ã£ã¦ããŸã‹ï¼ã€ã€Œã“ã“ã§ä½¿ã†ã®ã¯åšæ‰“ã ã‚wã€**ã®ã‚ˆã†ã«ã€ãã®é¸æ‰‹ã¸ã®æœŸå¾…ã‚„ä¸å®‰ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã‚‹ã“ã¨ã€‚
- **ã€â˜…ç™»æ¿å±¥æ­´ã¸ã®è¨€åŠ (æœ€é‡è¦)ã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿5ï¼šä»Šå¤§ä¼šã®ä¸»ãªæŠ•æ‰‹ç™»æ¿å±¥æ­´ã€ã®æƒ…å ±ã‚’å¿…ãšç¢ºèªã—ã€ä»¥ä¸‹ã®ç‚¹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã‚‹ã“ã¨ã€‚
    - **é€£æŠ•/ç™»æ¿é–“éš”**: ã€Œã€‡ã€‡ã€æ˜¨æ—¥ã‚‚æŠ•ã’ã¦ãªã‹ã£ãŸã‹ï¼Ÿã€ã€Œé€£æŠ•ãŠç–²ã‚Œæ§˜ã€ã€Œä¸­1æ—¥ã§ã“ã‚Œã¯ã‚­ãƒ„ã‚¤ã‚ã€
    - **é…·ä½¿**: ã€Œã‚¨ãƒ¼ã‚¹æŠ•ã’ã™ãã ã‚ã€ã€Œç›£ç£ã¯éˆ´æœ¨ã‚’å£Šã™æ°—ã‹ã€
    - **å¥½ä¸èª¿ã®æ³¢**: ã€Œå‰å›ç‚ä¸Šã—ãŸã®ã«ã‚ˆã†ç«‹ã¡ç›´ã£ãŸãªã€ã€Œã“ãªã„ã ã¯è‰¯ã‹ã£ãŸã®ã«ä»Šæ—¥ã¯ã‚¢ã‚«ãƒ³ã‹ã€
    - **ç›¸æ‰‹ã®è³ª**: ã€Œä»Šã¾ã§é›‘é­šç‹©ã‚Šã ã£ãŸã®ãŒãƒãƒ¬ãŸãªwã€ã€Œå¼·è±ªç›¸æ‰‹ã§ã‚‚æŠ‘ãˆã‚‹ã¨ã‹æœ¬ç‰©ã‚„ã‚“ã€
- **ã€â˜…æ‰“è€…å±¥æ­´ã¸ã®è¨€åŠ (æœ€é‡è¦)ã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿6ï¼šæ‰“è€…æˆç¸¾å±¥æ­´ã€ã‚‚å¿…ãšç¢ºèªã—ã€ä»¥ä¸‹ã®ç‚¹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã‚‹ã“ã¨ã€‚
    - **å¥½ä¸èª¿ã®æ³¢**: ã€Œã€‡ã€‡ã€ä»Šæ—¥ã§3è©¦åˆé€£ç¶šãƒ’ãƒƒãƒˆã‚„ã‚“ï¼ã€ã€Œâ–³â–³ã€10æ‰“æ•°ãƒãƒ¼ãƒ’ãƒƒãƒˆã¨ã‹ã‚‚ã†çµ‚ã‚ã‚Šã ã‚â€¦ã€
    - **å½¹å‰²**: ã€Œã“ã„ã¤ä»£æ‰“æˆåŠŸç‡100%ã˜ã‚ƒã­ï¼Ÿã€ã€Œ1ç•ªã«ä¸Šã’ãŸã‚‰æ‰“ã¡å‡ºã—ãŸãªã€
    - **ç›¸æ‰‹ã®è³ª**: ã€Œä»Šã¾ã§é›‘é­šç‹©ã‚Šã ã£ãŸã®ãŒãƒãƒ¬ãŸãªwã€ã€ŒAãƒ©ãƒ³ã‚¯æŠ•æ‰‹ã‹ã‚‰æ‰“ã¤ã¨ã‹æœ¬ç‰©ã‚„ã‚“ã€
### å‡ºåŠ›å½¢å¼ã€æœ€é‡è¦ã€‘
è§£èª¬ã‚„å‰ç½®ãã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚**å¿…ãšä»¥ä¸‹ã® JSON é…åˆ—å½¢å¼ (\`[...]\`) ã®ã¿**ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
\`\`\`json
[
  {"personality": "1: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆç”Ÿæˆã—ãŸã‚³ãƒ¡ãƒ³ãƒˆ1ï¼‰"},
  {"personality": "2: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆç”Ÿæˆã—ãŸã‚³ãƒ¡ãƒ³ãƒˆ2ï¼‰"},
  // ... (åˆè¨ˆ25ã€œ27å€‹ã®ã‚³ãƒ¡ãƒ³ãƒˆ) ...
]
\`\`\`
`; 
    
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const commentsJson = parseJsonFromText(rawText);
            if (Array.isArray(commentsJson)) {
                return commentsJson.map((c, index) => ({
                    id: crypto.randomUUID(),
                    personality: c.personality || `${index + 1}: é¢¨å¹ã‘ã°åç„¡ã—`,
                    text: c.comment,
                    timestamp: Date.now() + index * 10,
                    replies: []
                }));
            } else {
                console.warn("AIãŒäºˆæœŸã—ãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã§BBSã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿”ã—ã¾ã—ãŸã€‚ä¸­èº«ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚");
                if (commentsJson && commentsJson.comments && Array.isArray(commentsJson.comments)) {
                     return commentsJson.comments.map((c, index) => ({
                        id: crypto.randomUUID(),
                        personality: c.personality || `${index + 1}: é¢¨å¹ã‘ã°åç„¡ã—`,
                        text: c.comment,
                        timestamp: Date.now() + index * 10,
                        replies: []
                    }));
                }
            }
        }
        throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒã€æ­£ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆé…åˆ—å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    } catch (error) {
        console.error("AI game match BBS generation failed (seed-aware):", error);
        return {
            error: true,
            title: "æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼(ã‚·ãƒ¼ãƒ‰å¯¾å¿œç‰ˆ)",
            body: "AIã«ã‚ˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
            timestamp: Date.now(),
            errorId: `error-${matchId}-bbs-seed`,
            context: matchContext
        };
    }
}
// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨ã€Œæ–°è¦è¿½åŠ ã€ â–¼â–¼â–¼

// â–¼â–¼â–¼ æ—¢å­˜ã® generateUserThreadBbsComments é–¢æ•° (12015è¡Œç›®ã‚ãŸã‚Š) ã‚’ã€ä»¥ä¸‹ã§ã€Œç½®ãæ›ãˆã€ â–¼â–¼â–¼

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‹æœ¬æ–‡ï¼‰ã«å¯¾ã—ã€ãªã‚“Jé¢¨ã®æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆã‚’AIã«ç”Ÿæˆã•ã›ã‚‹
 * (â˜…è©¦åˆã®æ–‡è„ˆï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã‚’AIã«æ¸¡ã—ã¦ã€æœ¬æ ¼çš„ãªãƒ¬ã‚¹ã‚’ç”Ÿæˆã™ã‚‹ã‚ˆã†å¼·åŒ–ã—ãŸæœ€çµ‚ç‰ˆâ˜…)
 * * @param {string} title - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«
 * @param {string} firstCommentText - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸæœ¬æ–‡ (>>1)
 * @param {string} gameContext - AIã«æä¾›ã™ã‚‹è¿½åŠ ã®è©¦åˆ/é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ (formatPlayerGamelogsForPrompt ãªã©ã§ç”Ÿæˆ)
 * @returns {Promise<Array|null>} ã‚³ãƒ¡ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
 */
async function generateUserThreadBbsComments(title, firstCommentText, gameContext) {
    let personaPrompt = `ã‚ãªãŸã¯ã€æ—¥æœ¬ã®åŒ¿åæ²ç¤ºæ¿ã€Œãªã‚“ã§ã‚‚å®Ÿæ³Jï¼ˆãªã‚“Jï¼‰ã€ã®ä½æ°‘ã§ã™ã€‚ã‚ãªãŸã¯å°‘ã—çš®è‚‰å±‹ã§ã€ãƒãƒƒãƒˆã‚¹ãƒ©ãƒ³ã‚°ã‚’å¤šç”¨ã—ã€ã‚ã‚‰ã‚†ã‚‹è©±é¡Œã«çŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãè¾¼ã¿ã¾ã™ã€‚`;
    
    // â˜… gameContext ãŒæä¾›ã•ã‚Œã¦ã„ã‚Œã°ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã€ŒçŸ¥è­˜ã€ã¨ã—ã¦æŒ¿å…¥ã™ã‚‹
    const contextPrompt = gameContext 
        ? `
### å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€
${PREFECTURE_LORE}

### å‚è€ƒæƒ…å ±ï¼šã‚¹ãƒ¬ãƒƒãƒ‰ã®è©±é¡Œã«é–¢é€£ã™ã‚‹æœ€æ–°ãƒ‡ãƒ¼ã‚¿
${gameContext}
`
        : `
### å‚è€ƒæƒ…å ±
(ç‰¹ã«é–¢é€£ã™ã‚‹è©¦åˆãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¸€èˆ¬çš„ãªè©±é¡Œã¨ã—ã¦è¿”ä¿¡ã—ã¦ãã ã•ã„ã€‚)
`;

    const prompt = `${personaPrompt}

ä»¥ä¸‹ã®ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç«‹ã¦ãŸã‚¹ãƒ¬ãƒƒãƒ‰ã€‘ã«ã¤ã„ã¦ã€**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚¹ãƒ¬ãƒƒãƒ‰ãŒé€²è¡Œã—ã¦ã„ãã‹ã®ã‚ˆã†ã«**ã€è‡ªç„¶ãªæµã‚Œã§**10ã€œ15å€‹**ã®æ²ç¤ºæ¿ã®åå¿œã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«
${title}

### ã‚¹ãƒ¬ä¸»(>>1)ã®æœ¬æ–‡
${firstCommentText}

${contextPrompt}

### ã‚¹ãƒ¬ãƒƒãƒ‰é€²è¡Œã®æŒ‡ç¤º
1.  **åºç›¤ (2ã€œ5ãƒ¬ã‚¹):** ã‚¹ãƒ¬ä¸»ã®æŠ•ç¨¿(>>1)ã«å¯¾ã—ã€å³åº§ã«é£Ÿã„ã¤ãç¬¬ä¸€é™£ã®åå¿œã€‚ã€Œãƒã‚¸ã‹ã€ã€Œè‰ã€ã€Œã¾ãŸã€‡ã€‡ã‹ã€ã¨ã„ã£ãŸçŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆãŒä¸­å¿ƒã€‚
2.  **ä¸­ç›¤ (6ã€œ15ãƒ¬ã‚¹):** - ã‚¹ãƒ¬ä¸»ã®è©±é¡Œã«å¯¾ã—ã¦æ§˜ã€…ãªè§’åº¦ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’å§‹ã‚ã‚‹ã€‚è‚¯å®šã€å¦å®šã€ç…½ã‚Šã€å…¨ãé–¢ä¿‚ãªã„è„±ç·šãªã©ã‚’ç¹”ã‚Šäº¤ãœã‚‹ã€‚
    - **ã€â˜…æœ€é‡è¦ã€‘**: ã‚‚ã—ã€Œå‚è€ƒæƒ…å ±ï¼šæœ€æ–°ãƒ‡ãƒ¼ã‚¿ã€ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®**ãƒ‡ãƒ¼ã‚¿ï¼ˆGamelogã€ãƒãƒ¼ãƒ æ‰“ç‡ã€ç™»æ¿é–“éš”ãªã©ï¼‰**ã‚’**å¿…ãš**å¼•ç”¨ã—ã€ã‚¹ãƒ¬ä¸»(>>1)ã®æ„è¦‹ï¼ˆä¾‹ï¼šã€Œéˆ´æœ¨ãŒå‡„ã„ã€ï¼‰ã‚’è£œå¼·ã—ãŸã‚Šã€åè«–ã—ãŸã‚Šã—ã¦ãã ã•ã„ã€‚
    - ï¼ˆä¾‹ï¼šã€Œ>>1 ã‚ã‹ã‚‹ã€‚éˆ´æœ¨ã€ã“ã‚Œã§3è©¦åˆé€£ç¶šç„¡å¤±ç‚¹ã˜ã‚ƒã­ï¼Ÿã€ã€Œã§ã‚‚ã€‡ã€‡é«˜æ ¡ã€ãƒãƒ¼ãƒ æ‰“ç‡.180ã ãã€‚éˆ´æœ¨ãŒè‰¯ãã¦ã‚‚å‹ã¦ã‚“ã‚ã€ï¼‰
    - **ã€Œ>>1ã€ã¸ã®å®‰ä¾¡ï¼ˆã‚¢ãƒ³ã‚«ãƒ¼ï¼‰**ã‚’ä½¿ã£ã¦ã€ã‚¹ãƒ¬ä¸»ã®æ„è¦‹ã«è¿”ä¿¡ã™ã‚‹ã‚„ã‚Šå–ã‚Šã‚’å¿…ãšå«ã‚ã‚‹ã“ã¨ã€‚
3.  **çµ‚ç›¤ (16ãƒ¬ã‚¹ä»¥é™):** ã‚ã‚‹ç¨‹åº¦è­°è«–ãŒå‡ºå°½ãã—ãŸå¾Œã®ã€ã¾ã¨ã‚ã®ã‚ˆã†ãªã‚³ãƒ¡ãƒ³ãƒˆã‚„ã€é£½ãã¦ããŸä½æ°‘ã«ã‚ˆã‚‹ãŠãµã–ã‘ãŒå§‹ã¾ã‚‹ã€‚
4.ã€€**æœ€çµ‚ç›¤ (26ãƒ¬ã‚¹ä»¥é™):** ã‚¹ãƒ¬ã‚‚æ··æ²Œã¨ã—ã¦ãã¦ã€é–¢ä¿‚ãªã„è©±é¡Œã‚’æŒã£ã¦ãã‚‹è€…ã‚„ã€å‹æ‰‹ã«ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹ã‚’åˆºæ¿€ã•ã‚Œç™ºç‹‚ã™ã‚‹ã‚‚ã®ã€ãŸã ã®è’ã‚‰ã—ãªã©ãŒæ¹§ãå§‹ã‚ã€ã‚°ãƒ€ã‚°ãƒ€ã«ãªã‚Šè§£æ•£ã™ã‚‹ã€‚

### å‡ºåŠ›å½¢å¼ï¼ˆJSONé…åˆ—ï¼‰
[
    {"personality": "2: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆä½æ°‘2ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"},
    {"personality": "3: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆä½æ°‘3ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"},
    ...
]`; // ã‚¹ãƒ¬ä¸»(1:)ã¯é™¤ã

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const commentsJson = parseJsonFromText(rawText);
            if (Array.isArray(commentsJson)) {
                return commentsJson.map((c, index) => ({ // indexã‚’èª¿æ•´ (2ã‹ã‚‰å§‹ã¾ã‚‹ã‚ˆã†ã«)
                    id: crypto.randomUUID(),
                    personality: c.personality.startsWith(`${index + 2}:`) ? c.personality : `${index + 2}: ${c.personality}`, // ç•ªå·ã‚’2ã‹ã‚‰æŒ¯ã‚‹
                    text: c.comment,
                    timestamp: Date.now() + index * 10
                }));
            }
        }
        throw new Error("AI response format error.");
    } catch (error) {
        console.error("AI user thread BBS generation failed:", error);
        return null;
    }
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
/**
 * ç¾å®Ÿã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã«å¯¾ã™ã‚‹ã€ãªã‚“Jé¢¨ã®æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆã‚’AIã«ç”Ÿæˆã•ã›ã‚‹
 * @param {string} headline - ç¾å®Ÿã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®è¦‹å‡ºã—
 * @param {string} category - ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ã‚«ãƒ†ã‚´ãƒª
 * @returns {Promise<Array|null>} ã‚³ãƒ¡ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
 */
async function generateRealNewsBbsComments(headline, category) {
    let personaPrompt = `ã‚ãªãŸã¯ã€æ—¥æœ¬ã®åŒ¿åæ²ç¤ºæ¿ã€Œãªã‚“ã§ã‚‚å®Ÿæ³Jï¼ˆãªã‚“Jï¼‰ã€ã®ä½æ°‘ã§ã™ã€‚ã‚ãªãŸã¯å°‘ã—çš®è‚‰å±‹ã§ã€ãƒãƒƒãƒˆã‚¹ãƒ©ãƒ³ã‚°ã‚’å¤šç”¨ã—ã€ã‚ã‚‰ã‚†ã‚‹è©±é¡Œã«çŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãè¾¼ã¿ã¾ã™ã€‚`;
    let instructions = ``;
    switch (category) {
        case 'æ”¿æ²»': instructions = `æ”¿æ²»ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«è©³ã—ã„ä½æ°‘ã¨ã—ã¦ã€ä¸å…šã‚„é‡å…šã‚’ç…½ã£ãŸã‚Šã€å°†æ¥ã‚’æ‚²è¦³ã—ãŸã‚Šã€é”è¦³ã—ãŸã‚ˆã†ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’ã—ã¦ãã ã•ã„ã€‚`; break;
        case 'èŠ¸èƒ½': instructions = `èŠ¸èƒ½ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒå¤§å¥½ããªé‡æ¬¡é¦¬ã¨ã—ã¦ã€ã€Œã€‡ã€‡ãƒ­ã‚¹ã ã‚ã€ã€Œã©ã†ã›ã™ãåˆ¥ã‚Œã‚‹ã€ã¨ã„ã£ãŸã€ãŠç¥ã„ã¨å«‰å¦¬ãŒå…¥ã‚Šæ··ã˜ã£ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’ã—ã¦ãã ã•ã„ã€‚`; break;
        case 'å­¦æ­´': instructions = `å­¦æ­´ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹ã‚’æŒã¤ä½æ°‘ã¨ã—ã¦ã€ã€ŒFæ¬„ã®ãƒ¯ã‚¤ã€é«˜ã¿ã®è¦‹ç‰©ã€ã€Œçµå±€ã¯å­¦æ­´ã‚ˆã‚Šã‚³ãƒŸãƒ¥åŠ›ã€ã¨ã„ã£ãŸã€è‡ªè™ã‚„æŒè«–ã‚’å±•é–‹ã—ã¦ãã ã•ã„ã€‚`; break;
        default: instructions = `ä¸€èˆ¬çš„ãªä½æ°‘ã¨ã—ã¦ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«åå¿œã—ã¦ãã ã•ã„ã€‚`; break;
    }
    
    const prompt = `${personaPrompt}

ä»¥ä¸‹ã®ã€${category}ã€‘ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã«ã¤ã„ã¦ã€**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚¹ãƒ¬ãƒƒãƒ‰ãŒé€²è¡Œã—ã¦ã„ãã‹ã®ã‚ˆã†ã«**ã€è‡ªç„¶ãªæµã‚Œã§**10ã€œ15å€‹**ã®æ²ç¤ºæ¿ã®åå¿œã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³
${headline}

### ã‚¹ãƒ¬ãƒƒãƒ‰é€²è¡Œã®æŒ‡ç¤º
1.  **åºç›¤ (1ã€œ5ãƒ¬ã‚¹):** ã‚¹ãƒ¬ä¸»ã®æŠ•ç¨¿ã«å¯¾ã—ã€å³åº§ã«é£Ÿã„ã¤ãç¬¬ä¸€é™£ã®åå¿œã€‚ã€Œãƒã‚¸ã‹ã€ã€Œè‰ã€ã€Œã¾ãŸã€‡ã€‡ã‹ã€ã¨ã„ã£ãŸçŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆãŒä¸­å¿ƒã€‚
2.  **ä¸­ç›¤ (6ã€œ15ãƒ¬ã‚¹):** å°‘ã—å†·é™ã«ãªã£ãŸä½æ°‘ãŸã¡ãŒã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«å¯¾ã—ã¦æ§˜ã€…ãªè§’åº¦ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’å§‹ã‚ã‚‹ã€‚è‚¯å®šã€å¦å®šã€ç…½ã‚Šã€å…¨ãé–¢ä¿‚ãªã„è„±ç·šãªã©ã‚’ç¹”ã‚Šäº¤ãœã‚‹ã€‚**ã€Œ>>1ã€ã€Œ>>5ã€ã®ã‚ˆã†ãªå®‰ä¾¡ï¼ˆã‚¢ãƒ³ã‚«ãƒ¼ï¼‰ã‚’ä½¿ã£ã¦ã€ä»–ã®ã‚³ãƒ¡ãƒ³ãƒˆã«è¿”ä¿¡ã™ã‚‹ã‚„ã‚Šå–ã‚Šã‚’å¿…ãšå«ã‚ã‚‹ã“ã¨ã€‚**
3.  **çµ‚ç›¤ (16ãƒ¬ã‚¹ä»¥é™):** ã‚ã‚‹ç¨‹åº¦è­°è«–ãŒå‡ºå°½ãã—ãŸå¾Œã®ã€ã¾ã¨ã‚ã®ã‚ˆã†ãªã‚³ãƒ¡ãƒ³ãƒˆã‚„ã€é£½ãã¦ããŸä½æ°‘ã«ã‚ˆã‚‹ãŠãµã–ã‘ãŒå§‹ã¾ã‚‹ã€‚
4.ã€€**æœ€çµ‚ç›¤ (26ãƒ¬ã‚¹ä»¥é™):** ã‚¹ãƒ¬ã‚‚æ··æ²Œã¨ã—ã¦ãã¦ã€é–¢ä¿‚ãªã„è©±é¡Œã‚’æŒã£ã¦ãã‚‹è€…ã‚„ã€å‹æ‰‹ã«ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹ã‚’åˆºæ¿€ã•ã‚Œç™ºç‹‚ã™ã‚‹ã‚‚ã®ã€ãŸã ã®è’ã‚‰ã—ãªã©ãŒæ¹§ãå§‹ã‚ã€ã‚°ãƒ€ã‚°ãƒ€ã«ãªã‚Šè§£æ•£ã™ã‚‹ã€‚


### å‡ºåŠ›å½¢å¼ï¼ˆJSONé…åˆ—ï¼‰
[
    {"personality": "1: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆã‚¹ãƒ¬ä¸»ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"},
    {"personality": "2: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆä½æ°‘2ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"},
    {"personality": "3: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆä½æ°‘3ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"},
    ...
]`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const commentsJson = parseJsonFromText(rawText);
            if (Array.isArray(commentsJson)) {
                return commentsJson.map(c => ({
                    id: crypto.randomUUID(),
                    personality: c.personality,
                    text: c.comment,
                    timestamp: Date.now()
                }));
            }
        }
        throw new Error("AI response format error.");
    } catch (error) {
        console.error("AI real news BBS generation failed:", error);
        return null;
    }
}
// â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–²

// â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–²

/**
 * æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ãƒ ãŒæ¬¡ã«å‡ºå ´ã™ã‚‹ã€ã¾ã çµ‚ã‚ã£ã¦ã„ãªã„è©¦åˆã‚’æ¢ã™
 * @param {string} teamName - æ¢ã—ãŸã„ãƒãƒ¼ãƒ å
 * @param {object} state - ç¾åœ¨ã®tournamentState
 * @returns {object|null} - è¦‹ã¤ã‹ã£ãŸè©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã¾ãŸã¯null
 */
function findCurrentMatchForTeam(teamName, state) {
    const allMatches = { ...state.matches, ...(state.autumnData?.allMatches || {}), ...(state.springData?.allMatches || {}) };
    let earliestMatch = null;
    let minRound = Infinity;

    for (const matchId in allMatches) {
        const match = allMatches[matchId];
        if (!match.winner && (match.team1 === teamName || match.team2 === teamName)) {
            const roundNum = match.id.includes('-R') ? parseInt(match.id.split('-')[1].slice(1)) : 0;
            if (roundNum < minRound) {
                minRound = roundNum;
                earliestMatch = match;
            }
        }
    }
    return earliestMatch;
}



/**
 * [UPDATED] ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®å‹è€…ã‚’æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚ã‚‹
 * (â˜…ãƒãƒ¼ãƒ æ•°ã«å¿œã˜ã¦ã€Œæ±ºå‹æˆ¦ã€ã®åˆ¤å®šã‚’å‹•çš„ã«è¡Œã†)
 */
function advanceWinnerToNextRound(match, winnerName, state) {
    const matchId = match.id;
    const idParts = matchId.split('-');
    const side = idParts[0];

    if (side === 'F') return; // æ±ºå‹æˆ¦ãªã‚‰ä½•ã‚‚ã—ãªã„

    const roundStr = idParts[1];
    const roundNum = parseInt(roundStr.slice(1));
    
    if (state.teams && state.teams.length > 0) {
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ãƒãƒ¼ãƒ æ•°ã‹ã‚‰æœ€çµ‚ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’è¨ˆç®— â˜…â˜…â˜…
        const numTeamsInTournament = state.teams.length;
        const finalRound = Math.log2(numTeamsInTournament); // 128->7, 64->6
        // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

        if (roundNum < finalRound) {
            const matchNum = parseInt(idParts[2].slice(1));
            const nextRoundNum = roundNum + 1;
            
            // æ¬¡ãŒæœ€çµ‚ãƒ©ã‚¦ãƒ³ãƒ‰ãªã‚‰æ±ºå‹æˆ¦(F-R1-M1)ã€ãã†ã§ãªã‘ã‚Œã°æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ã¸
            let nextMatchId = (nextRoundNum === finalRound) 
                ? 'F-R1-M1' 
                : `${side}-R${nextRoundNum}-M${Math.ceil(matchNum / 2)}`;
            
            if (!state.matches[nextMatchId]) {
                state.matches[nextMatchId] = { id: nextMatchId, team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '' };
            }
            
            // æ±ºå‹æˆ¦ã®å ´åˆã¯ã€ã‚µã‚¤ãƒ‰(L/R)ã«ã‚ˆã£ã¦ã‚¹ãƒ­ãƒƒãƒˆã‚’æ±ºã‚ã‚‹
            let slot;
            if (nextRoundNum === finalRound) {
                slot = (side === 'L' ? 1 : 2);
            } else {
                slot = (matchNum % 2 !== 0 ? 1 : 2);
            }
            
            state.matches[nextMatchId][`team${slot}`] = winnerName;
        }
    }
}


/**
 * å¯†ç€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ã‚’é–‹å§‹ã—ã€åºç« ã®è¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…128ãƒãƒ¼ãƒ åˆ¶ï¼1ãƒ–ãƒ­ãƒƒã‚¯32ãƒãƒ¼ãƒ ã«å¯¾å¿œ)
 * @param {'underdog' | 'powerhouse'} type - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ã®ç¨®é¡
 * @param {string} teamName - å–æå¯¾è±¡ã®ãƒãƒ¼ãƒ å
 */
async function startDocumentary(type, teamName) {
    tournamentState.documentary = { target: teamName, type: type };
    newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒã€Œ${teamName}ã€ã®ç‰¹åˆ¥ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ç•ªçµ„ã®åˆ¶ä½œã‚’é–‹å§‹ã—ã¾ã—ãŸ...</div>`;
    
    renderTournament(tournamentState); 

    const firstMatch = Object.values(tournamentState.matches).find(m => 
        m.id.includes('-R1-') && (m.team1 === teamName || m.team2 === teamName)
    );
    
    let matchDataForArticle = { 
        opponent: 'ä¸æ˜', opponentRank: 'E', opponentRecord: 'æƒ…å ±ãªã—',
        toughestRival: 'ä¸æ˜', toughestRivalRecord: 'æƒ…å ±ãªã—'
    };

    if (firstMatch) {
        const opponentName = firstMatch.team1 === teamName ? firstMatch.team2 : firstMatch.team1;
        matchDataForArticle.opponent = opponentName;
        matchDataForArticle.opponentRank = calculateRank(opponentName, tournamentState);
        matchDataForArticle.opponentRecord = TEAM_DATA[opponentName]?.last || 'æƒ…å ±ãªã—';

        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
        const teamIndex = tournamentState.teams.indexOf(teamName);
        const blockSize = Math.floor(tournamentState.teams.length / 4); // 128 / 4 = 32
        const blockIndex = Math.floor(teamIndex / blockSize);
        const blockStart = blockIndex * blockSize;
        const blockEnd = blockStart + blockSize;
        // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…
        
        const blockTeams = tournamentState.teams.slice(blockStart, blockEnd);
        
        let toughestRivalName = null;
        let highestRankValue = -1;
        const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };

        blockTeams.forEach(rivalName => {
            if (rivalName === teamName || rivalName === '(BYE)') return; // è‡ªåˆ†ã¨ä¸æˆ¦å‹ã¯é™¤å¤–
            const rivalRank = calculateRank(rivalName, tournamentState);
            if (rankValues[rivalRank] > highestRankValue) {
                highestRankValue = rankValues[rivalRank];
                toughestRivalName = rivalName;
            }
        });
        
        if (toughestRivalName) {
            matchDataForArticle.toughestRival = toughestRivalName;
            matchDataForArticle.toughestRivalRecord = TEAM_DATA[toughestRivalName]?.last || 'æƒ…å ±ãªã—';
        }
    }
    
    const article = await generateDocumentaryArticle('intro', type, teamName, matchDataForArticle);

    if (article) {
        tournamentState.news.push(article);
    } else {
        tournamentState.news.push({
            title: "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼",
            body: `ã€Œ${teamName}ã€ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼è¨˜äº‹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚`,
            timestamp: Date.now(),
            error: true,
            context: {
                isDocumentary: true,
                type: type,
                teamName: teamName,
                matchData: matchDataForArticle
            }
        });
    }
    renderNews(tournamentState.news);
    saveState();
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²



async function generateDocumentaryArticle(phase, type, teamName, matchData = null, userFeedback = null) {
    const teamMasterData = TEAM_DATA[teamName];
    let prompt = `ã‚ãªãŸã¯ã€æƒ…ç†±çš„ã§äººé–“ãƒ‰ãƒ©ãƒã‚’æãã®ãŒå¾—æ„ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ç•ªçµ„ã®è¨˜è€…ã§ã™ã€‚ã‚ãªãŸã¯ä»Šã€é«˜æ ¡é‡çƒãƒãƒ¼ãƒ ã€Œ${teamName}ã€ã«å¯†ç€å–æã—ã¦ã„ã¾ã™ã€‚`;
    let title = "";

    let charactersPrompt = `### ä¸»ãªç™»å ´äººç‰©\n- ç›£ç£: ${teamMasterData.coach.name} (${teamMasterData.coach.style})\n`;
    if (DETAILED_TEAM_DATA[teamName]) {
        const detailedData = DETAILED_TEAM_DATA[teamName];
        const keyPlayers = detailedData.players.map(p => `- ${p.name}(${p.year}å¹´, ${p.position}): ${p.desc}`).join('\n');
        charactersPrompt += `### æ³¨ç›®é¸æ‰‹\n${keyPlayers}\n`;
    }
    
    let feedbackPrompt = '';
    if (userFeedback) {
        if (userFeedback.include && userFeedback.include.trim() !== '') {
            feedbackPrompt += `\n- **ã€æœ€é‡è¦æŒ‡ç¤ºã€‘** ä»¥ä¸‹ã®è¦ç´ ã‚’å¿…ãšè¨˜äº‹ã®ä¸­å¿ƒã«æ®ãˆã¦ã€æœ€ã‚‚ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«æå†™ã—ã¦ãã ã•ã„ï¼š\n${userFeedback.include}\n`;
        }
        if (userFeedback.exclude && userFeedback.exclude.trim() !== '') {
            feedbackPrompt += `\n- **ã€å³ç¦äº‹é …ã€‘** ä»¥ä¸‹ã®è¦ç´ ã‚„è¡¨ç¾ã¯ã€çµ¶å¯¾ã«è¨˜äº‹ã«å«ã‚ãªã„ã§ãã ã•ã„ï¼š\n${userFeedback.exclude}\n`;
        }
    }
    const finalFeedbackPrompt = `\n### ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ã‹ã‚‰ã®è¿½åŠ æŒ‡ç¤º\n${feedbackPrompt || 'ç‰¹ã«ãªã—'}`;

    // ==================================================================
    // --- 1. å¤è±ªå¾©æ´»ãƒãƒ¼ãƒ  (powerhouse_revival) ---
    // ==================================================================
    if (type === 'powerhouse_revival') {
        switch (phase) {
            case 'intro':
                title = `ã€${teamName}ã€å¾©æ´»ã¸ã®åºæ›²ã€`;
                let reactionPrompt = '';
                if (matchData && matchData.opponent) {
                    const ourRank = calculateRank(teamName, tournamentState);
                    const opponentRank = matchData.opponentRank;
                    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
                    const rankDiff = rankValues[opponentRank] - rankValues[ourRank];

                    if (rankDiff >= 1) { // æ ¼ä¸Š
                        reactionPrompt = `
5.  **ã€è©¦ç·´ã®åˆæˆ¦ã€‘**
    åˆæˆ¦ã®ç›¸æ‰‹ãŒæ ¼ä¸Šã®ã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚é¸æ‰‹ãŸã¡ãŒã€Œä¸è¶³ã¯ãªã„ç›¸æ‰‹ã€ã€Œå¾©æ´»ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã™ã‚‹ã«ã¯æœ€é«˜ã®ç›¸æ‰‹ã ã€ã¨é—˜å¿—ã‚’ç‡ƒã‚„ã™ã€‚
6.  **ã€ç›£ç£ã®ã€å»ºå‰ã€ã¨ã€æœ¬éŸ³ã€ã€‘**
    ç›£ç£ã¯**é¸æ‰‹ãŸã¡ã®å‰ã§**ã€ã€ŒæŒ‘æˆ¦è€…ã¨ã—ã¦ã€å¤±ã†ã‚‚ã®ã¯ä½•ã‚‚ãªã„ã€‚å…¨åŠ›ã§ã¶ã¤ã‹ã‚‹ãã€ã¨ã„ã†è¶£æ—¨ã§èªã‚‹ã€‚
    ã—ã‹ã—è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€ã€Œæœ¬å½“ã®å±±å ´ã¯**${matchData.toughestRival}**æˆ¦ã§ã—ã‚‡ã†ã€‚å½¼ã‚‰ã¯æ˜¨å¹´${matchData.toughestRivalRecord}ã€‚ã“ã®åˆæˆ¦ã¯ã€ãã“ã¸å‘ã‘ã¦ãƒãƒ¼ãƒ ãŒã©ã‚Œã ã‘æˆé•·ã§ãã‚‹ã‹ã®è©¦é‡‘çŸ³ã§ã™ã­ã€ã¨ã„ã†è¶£æ—¨ã§ã€å†·é™ã«å…ˆã‚’è¦‹æ®ãˆã‚‹ã€‚`;
                    } else { // åŒæ ¼ã‹æ ¼ä¸‹
                        reactionPrompt = `
5.  **ã€æ²¹æ–­ã¨ã„ã†åã®æ•µã€‘**
    åˆæˆ¦ã®ç›¸æ‰‹ãŒã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚ã€Œå‹ã¦ã‚‹ã€ã¨ã„ã†å®‰å µã®ç©ºæ°—ãŒé¸æ‰‹ãŸã¡ã®é–“ã«æµã‚Œã‚‹ã€‚
6.  **ã€ç›£ç£ã®ã€å»ºå‰ã€ã¨ã€æœ¬éŸ³ã€ã€‘**
    ãã®ç©ºæ°—ã‚’å¯Ÿã—ãŸç›£ç£ãŒ**é¸æ‰‹ãŸã¡ã®å‰ã§**ã€ã€Œæ²¹æ–­ãŒä¸€ç•ªã®æ•µã ã€‚ä¿ºãŸã¡ã¯ã¾ã ä½•ã‚‚æˆã—é‚ã’ã¦ã„ãªã„ã€ã¨ã„ã†è¶£æ—¨ã§å³ã—ãä¸€å–ã™ã‚‹ã€‚
    ã—ã‹ã—ã€è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€ã€Œæ­£ç›´ã€ãƒ›ãƒƒã¨ã—ã¾ã—ãŸã€‚**${matchData.toughestRival}**ï¼ˆå½¼ã‚‰ã¯æ˜¨å¹´${matchData.toughestRivalRecord}ï¼‰ã¨å½“ãŸã‚‹ã¾ã§ã«ã€ã„ãã¤ã‹è©¦åˆã‚’ã“ãªã—ã¦ç·´åº¦ã‚’ä¸Šã’ãŸã‹ã£ãŸã®ã§ã€ã¨ã„ã†è¶£æ—¨ã§ã€å®‰å µã®ç†ç”±ãŒæˆ¦ç•¥çš„ãªã‚‚ã®ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ã‹ã™ã€‚`;
                    }
                }
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
ã‹ã¤ã¦é»„é‡‘æ™‚ä»£ã‚’ç¯‰ã„ãŸå¤è±ªã€Œ${teamName}ã€ãŒã€å¤±ã‚ã‚ŒãŸæ „å…‰ã‚’å–ã‚Šæˆ»ã™ã¹ãæŒ‘ã‚€å¤ã‚’è¿½ã†ã€‚éå»ã€ç¾åœ¨ã€ãã—ã¦æœªæ¥ãŒäº¤éŒ¯ã™ã‚‹ç‰©èªã®åºç« ã‚’æã„ã¦ãã ã•ã„ã€‚
${charactersPrompt}
### æ§‹æˆæ¡ˆ
1.  **ã€åŸƒã‚’ã‹ã¶ã£ãŸå„ªå‹æ——ã€‘**: éƒ¨å®¤ã«çœ ã‚‹è‰²è¤ªã›ãŸå„ªå‹æ——ã‚„ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã®æå†™ã‹ã‚‰å§‹ã‚ã‚‹ã€‚éå»ã®æ „å…‰ã®é‡åœ§ã¨ã€ç¾åœ¨ã®ãƒãƒ¼ãƒ ãŒç½®ã‹ã‚ŒãŸçŠ¶æ³ï¼ˆ${teamMasterData.info}ï¼‰ã‚’å¯¾æ¯”ã•ã›ã‚‹ã€‚
2.  **ã€OBãŸã¡ã®ç†±ãçœ¼å·®ã—ã€‘**: ç·´ç¿’ã‚’å³ã—ã„ç›®ã§è¦‹ã¤ã‚ã‚‹OBä¼šé•·ã«ã€Œä¿ºãŸã¡ã®æ™‚ä»£ã¯â€¦ã€ã¨ã„ã†æ˜”èªã‚Šã¨ã€ç¾åœ¨ã®ãƒãƒ¼ãƒ ã¸ã®æ­¯ãŒã‚†ã•ã€ãã—ã¦å¿ƒã®åº•ã«ã‚ã‚‹æœŸå¾…ã‚’èªã‚‰ã›ã‚‹ã€‚
3.  **ã€é‡åœ§ã‚’èƒŒè² ã†ä¸»å°†ã€‘**: ä¸»å°†ã«ã€Œã“ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç€ã¦æˆ¦ã†ã“ã¨ã®æ„å‘³ã€ã‚’å•ã†ã€‚ä¼çµ±ã®é‡ã¿ã¨ã€ãã‚Œã‚’åŠ›ã«å¤‰ãˆã‚ˆã†ã¨ã™ã‚‹å½¼ã®è¦šæ‚Ÿã‚’æå†™ã™ã‚‹ã€‚
4.  **ã€ç›£ç£ã®ä¿¡å¿µã¨ç¾å®Ÿã€‘**: ç›£ç£ã«ã€Œå¤è±ªå¾©æ´»ã¸ã®é“ç­‹ã€ã‚’ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã€‚OBã‹ã‚‰ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã®ä¸­ã§ã€å½¼ãŒä¿¡ã˜ã‚‹ä»Šã®é¸æ‰‹ãŸã¡ã®å¯èƒ½æ€§ã¨ã€ç¾åœ¨ã®èª²é¡Œã«ã¤ã„ã¦èªã‚‰ã›ã‚‹ã€‚
${reactionPrompt}
7.  **ã€æ–°ãŸãªæ­´å²ã¸ã€‘**: ä¸»å°†ã®ã€Œä¿ºãŸã¡ã¯ä¿ºãŸã¡ã®é‡çƒã§ã€æ–°ã—ã„æ­´å²ã‚’ä½œã‚‹ã ã‘ã€ã¨ã„ã†è¨€è‘‰ã§ã€å¾©æ´»ã‚’ã‹ã‘ãŸå¤ã®å§‹ã¾ã‚Šã‚’åŠ›å¼·ãå®£è¨€ã—ã¦ç· ã‚ããã‚‹ã€‚
### æå†™ã®ãƒã‚¤ãƒ³ãƒˆ
- æ™‚é–“è»¸ã®æ„è­˜: ã€Œéå»ã®æ „å…‰ã€ã€Œç¾åœ¨ã®è‘›è—¤ã€ã€Œæœªæ¥ã¸ã®æŒ‘æˆ¦ã€ã‚’æ„è­˜ã—ã€ç‰©èªã«æ·±ã¿ã‚’ä¸ãˆã‚‹ã“ã¨ã€‚
- å»ºå‰ã¨æœ¬éŸ³: ç›£ç£ã®äºŒé¢æ€§ã‚’æãã“ã¨ã§ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ãƒªã‚¢ãƒªãƒ†ã‚£ã‚’è¿½æ±‚ã™ã‚‹ã“ã¨ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆé•·ç·¨ã®è¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
            case 'win':
                title = `ã€${teamName}ã€å¾©æ´»ã¸ã®ç¬¬ä¸€æ­©ã€`;
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
å¤è±ªã€Œ${teamName}ã€ãŒ ${matchData.opponent} ã¨ã®è©¦åˆã« ${matchData.score} ã§å‹åˆ©ã—ã¾ã—ãŸã€‚ã€Œåé–€å¾©æ´»ã¸ã®ç‹¼ç…™ã€ã¨ãªã‚‹ã“ã®ä¸€å‹ã®ä¾¡å€¤ã‚’ã€æ„Ÿå‹•çš„ã«æå†™ã—ã¦ãã ã•ã„ã€‚
### å¯¾æˆ¦ç›¸æ‰‹ã€Œ${matchData.opponent}ã€ã®èƒŒæ™¯
${matchData.opponentInfo}
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹
${matchData.summary || 'ç‰¹ã«ãªã—'}
### ã“ã®è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${matchData.highlights}
### æ§‹æˆæ¡ˆ
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€ã‚’ç‰©èªã®ä¸­å¿ƒã«æ®ãˆã€ãã®å ´é¢ã‚’æœ€ã‚‚ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«æå†™ã™ã‚‹ã€‚
2.  å¯¾æˆ¦ç›¸æ‰‹ãŒã©ã®ã‚ˆã†ãªãƒãƒ¼ãƒ ã§ã‚ã£ãŸã‹ï¼ˆã€å¯¾æˆ¦ç›¸æ‰‹ã®èƒŒæ™¯ã€‘ã‚’å‚ç…§ï¼‰ã«è§¦ã‚Œã€ã“ã®å‹åˆ©ã®ä¾¡å€¤ã‚’ã‚ˆã‚Šé«˜ã‚ã‚‹ã€‚
3.  ç›£ç£ã«ã€Œä¼çµ±ã®ç²˜ã‚Šå¼·ã•ãŒå‡ºã›ãŸã€ã¨ã„ã†è¶£æ—¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã•ã›ã‚‹ã€‚
4.  ä¸»å°†ã«ã€æ¬¡æˆ¦ã¸ã®æ„æ°—è¾¼ã¿ã¨å…±ã«ã€Œå…ˆè¼©ãŸã¡ãŒç¯‰ã„ãŸæ­´å²ã«ã€æ–°ãŸãª1ãƒšãƒ¼ã‚¸ã‚’åˆ»ã¿ãŸã„ã€ã¨èªã‚‰ã›ã‚‹ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆè¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
            case 'lose':
                title = `ã€${teamName}ã€å¤¢ã€ã¾ãŸã‚‚å±Šã‹ãšã€`;
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
å¤è±ªã€Œ${teamName}ã€ã®å¤ãŒçµ‚ã‚ã‚Šã‚’å‘Šã’ãŸã€‚å¾©æ´»ã‚’é¡˜ã£ãŸäººã€…ã®æœŸå¾…ã¨ã€ãã‚Œã«å¿œãˆã‚‰ã‚Œãªã‹ã£ãŸé¸æ‰‹ãŸã¡ã®ç„¡å¿µã•ã‚’æã„ã¦ãã ã•ã„ã€‚
### å¯¾æˆ¦ç›¸æ‰‹ã€Œ${matchData.opponent}ã€ã®èƒŒæ™¯
${matchData.opponentInfo}
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹
${matchData.summary || 'ç‰¹ã«ãªã—'}
### ã“ã®è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${matchData.highlights}
### æ§‹æˆæ¡ˆ
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€ãŒã€ã„ã‹ã«ã—ã¦ãƒãƒ¼ãƒ ã®å¤¢ã‚’æ‰“ã¡ç •ã„ãŸã‹ã‚’è©³ç´°ã«æå†™ã™ã‚‹ã€‚
2.  å¯¾æˆ¦ç›¸æ‰‹ãŒã©ã®ã‚ˆã†ãªãƒãƒ¼ãƒ ã§ã‚ã£ãŸã‹ï¼ˆã€å¯¾æˆ¦ç›¸æ‰‹ã®èƒŒæ™¯ã€‘ã‚’å‚ç…§ï¼‰ã«è§¦ã‚Œã€æ•—åŒ—ã®æ–‡è„ˆã‚’ã‚ˆã‚Šæ·±ãæå†™ã™ã‚‹ã€‚
3.  ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«æ³£ãå´©ã‚Œã‚‹é¸æ‰‹ãŸã¡ã¨ã€å½¼ã‚‰ã«ã‹ã‘ã‚‹è¨€è‘‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„ç›£ç£ã®å§¿ã€‚
4.  ã€Œå½¼ã‚‰ã®æŒ‘æˆ¦ã¯çµ‚ã‚ã£ãŸã€‚ã—ã‹ã—ã€ã€‡ã€‡ï¼ˆæ ¡åï¼‰ã®é‡çƒéƒ¨ã®ç¯ãŒæ¶ˆãˆã‚‹ã“ã¨ã¯ãªã„ã€ã¨ã€æœªæ¥ã¸ã®å¸Œæœ›ã§ç· ã‚ããã‚‹ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆè¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
        }
    } 
    // ==================================================================
    // --- 2. çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ãƒãƒ¼ãƒ  (one_man_team) ---
    // ==================================================================
    else if (type === 'one_man_team') {
        switch (phase) {
            case 'intro':
                title = `ã€${teamName}ã®ã‚¨ãƒ¼ã‚¹ã¨ã€8äººã®ä»²é–“ãŸã¡ã€`;
                let reactionPrompt = '';
                if (matchData && matchData.opponent) {
                    const ourRank = calculateRank(teamName, tournamentState);
                    const opponentRank = matchData.opponentRank;
                    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
                    const rankDiff = rankValues[opponentRank] - rankValues[ourRank];

                    if (rankDiff >= 2) { // çµ¶æœ›çš„ãªæ ¼ä¸Š
                        reactionPrompt = `
5.  **ã€è©¦ã•ã‚Œã‚‹ã€å€‹ã€ã®åŠ›ã€‘**
    åˆæˆ¦ã®ç›¸æ‰‹ãŒæ ¼ä¸Šã®å¼·è±ªã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚é‡æ‰‹ãŸã¡ãŒå‹•æºã™ã‚‹ä¸­ã€ã‚¨ãƒ¼ã‚¹ã ã‘ãŒã€Œç›¸æ‰‹ãŒèª°ã§ã‚ã‚ã†ã¨ã€ä¿ºãŒã‚¼ãƒ­ã«æŠ‘ãˆã‚‹ã ã‘ã§ã™ã€ã¨ã„ã†è¶£æ—¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã§é—˜å¿—ã‚’ç‡ƒã‚„ã™ã€‚
6.  **ã€ç›£ç£ã®ã€å»ºå‰ã€ã¨ã€æœ¬éŸ³ã€ã€‘**
    ç›£ç£ã¯**é¸æ‰‹ãŸã¡ã®å‰ã§**ã€ã€Œæœ€é«˜ã®ç›¸æ‰‹ã ã€‚æˆ‘ã€…ã«ã¯ã€‡ã€‡ï¼ˆã‚¨ãƒ¼ã‚¹åï¼‰ãŒã„ã‚‹ã€‚å½¼ã‚’ä¿¡ã˜ã‚ã€ã¨ã„ã†è¶£æ—¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã€ã‚¨ãƒ¼ã‚¹ã¸ã®çµ¶å¯¾çš„ãªä¿¡é ¼ã‚’å£ã«ã™ã‚‹ã€‚
    ã—ã‹ã—è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€ã€Œæ­£ç›´ã€æœ€æ‚ªã®ã‚¯ã‚¸ã§ã™ã€‚å½¼ï¼ˆã‚¨ãƒ¼ã‚¹ï¼‰ã®è² æ‹…ã‚’è€ƒãˆã‚Œã°ã€å‹ã¡é€²ã‚“ã å…ˆã®**${matchData.toughestRival}**ï¼ˆæ˜¨å¹´${matchData.toughestRivalRecord}ï¼‰æˆ¦ã¾ã§ã€ä»–ã®é¸æ‰‹ã«çµŒé¨“ã‚’ç©ã¾ã›ãŸã‹ã£ãŸã€ã¨ã„ã†è¶£æ—¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã€ãƒãƒ¼ãƒ å…¨ä½“ã®æˆé•·ã‚’é¡˜ã†æœ¬éŸ³ã‚’æ¼ã‚‰ã™ã€‚`;
                    } else { // åŒæ ¼ã‹æ ¼ä¸‹
                        reactionPrompt = `
5.  **ã€ã‚¨ãƒ¼ã‚¹æ¸©å­˜ã‹ã€å¦ã‹ã€‘**
    åˆæˆ¦ã®ç›¸æ‰‹ãŒã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚é¸æ‰‹ãŸã¡ã®é–“ã«ã€Œã“ã®ç›¸æ‰‹ãªã‚‰ã€ã‚¨ãƒ¼ã‚¹æŠœãã§ã‚‚å‹ã¦ã‚‹ã®ã§ã¯ï¼Ÿã€ã¨ã„ã†æ…¢å¿ƒãŒç”Ÿã¾ã‚Œã‚‹ã€‚
6.  **ã€ç›£ç£ã®ã€è³­ã‘ã€ã€‘**
    ç›£ç£ãŒ**é¸æ‰‹ãŸã¡ã®å‰ã§**ã€ã€Œåˆæˆ¦ã€ã€‡ã€‡ï¼ˆã‚¨ãƒ¼ã‚¹åï¼‰ã¯æŠ•ã’ãªã„ã€‚ãŠå‰ãŸã¡ã§å‹ã¡ä¸ŠãŒã£ã¦ã“ã„ã€ã¨ã„ã†è¶£æ—¨ã®ã€éæƒ…ã¨ã‚‚æ€ãˆã‚‹æ±ºæ–­ã‚’ä¸‹ã™ã€‚
    è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€ã€Œã“ã‚Œã¯è³­ã‘ã§ã™ã€‚ã§ã‚‚ã€**${matchData.toughestRival}**ï¼ˆæ˜¨å¹´${matchData.toughestRivalRecord}ï¼‰ã¨æˆ¦ã†ã“ã¨ã‚’è¦‹æ®ãˆã‚Œã°ã€ã“ã“ã§ä»–ã®é¸æ‰‹ãŒè¦šé†’ã—ãªã‘ã‚Œã°æœªæ¥ã¯ãªã„ã€ã¨ã„ã†è¶£æ—¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã€ã‚¨ãƒ¼ã‚¹ã®å°†æ¥ã¨ãƒãƒ¼ãƒ ã®æœªæ¥ã‚’æƒ³ã†æœ¬éŸ³ã‚’èªã‚‰ã›ã‚‹ã€‚`;
                    }
                }
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
ãƒ—ãƒ­æ³¨ç›®ã®çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ã‚’æ“ã™ã‚‹ã€Œ${teamName}ã€ã€‚å¤©æ‰ã®è‹¦æ‚©ã¨ã€å½¼ã‚’æ”¯ãˆã‚‹ã€Œãã®ä»–å¤§å‹¢ã€ã¨å‘¼ã°ã‚ŒãŸä»²é–“ãŸã¡ã®ãƒ—ãƒ©ã‚¤ãƒ‰ã‚’æãã€‚
${charactersPrompt}
### æ§‹æˆæ¡ˆ
1.  **ã€æ®ºåˆ°ã™ã‚‹å ±é“é™£ã€‘**: ç·´ç¿’ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«é›†ã¾ã‚‹ã€ã‚¨ãƒ¼ã‚¹ã ã‘ã‚’ç‹™ã†ç„¡æ•°ã®ã‚«ãƒ¡ãƒ©ã®æå†™ã‹ã‚‰å§‹ã‚ã‚‹ã€‚
2.  **ã€ã‚¨ãƒ¼ã‚¹ã®å­¤ç‹¬ãªãƒã‚¦ãƒ³ãƒ‰ã€‘**: ã‚¨ãƒ¼ã‚¹ã«ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã€‚ã€Œãƒãƒ¼ãƒ ã‚’å‹ãŸã›ã‚‹ã®ãŒè‡ªåˆ†ã®ä»•äº‹ã€ã¨èªã‚‹å½¼ã®è¨€è‘‰ã®è£ã«ã‚ã‚‹ã€é‡ã„ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‚’æå†™ã™ã‚‹ã€‚
3.  **ã€åã‚‚ãªãè„‡å½¹ãŸã¡ã®æ„åœ°ã€‘**: ãƒ¡ãƒ‡ã‚£ã‚¢ã‹ã‚‰ã¯æ³¨ç›®ã•ã‚Œãªã„ä»–ã®é‡æ‰‹ãŸã¡ã«ç„¦ç‚¹ã‚’å½“ã¦ã‚‹ã€‚ã€Œä¿ºãŸã¡ã¯ã€ã‚ã„ã¤ã®å¼•ãç«‹ã¦å½¹ã˜ã‚ƒãªã„ã€ã¨ã„ã†ã€å½¼ã‚‰ã®é™ã‹ãªãƒ—ãƒ©ã‚¤ãƒ‰ã¨è‘›è—¤ã‚’å¼•ãå‡ºã™ã€‚
4.  **ã€ç›£ç£ã®ä¿¡å¿µã€‘**: ç›£ç£ã«ã€Œå½¼ã‚‰ã¯ãƒ¯ãƒ³ãƒãƒ³ãƒãƒ¼ãƒ ã§ã™ã‹ï¼Ÿã€ã¨å•ã†ã€‚ã€Œä¸–é–“ã¯ãã†è¨€ã†ã ã‚ã†ã€‚ã ãŒã€æœ¬å½“ã®ä¸»å½¹ãŒèª°ãªã®ã‹ã‚’ç§ã ã‘ã¯çŸ¥ã£ã¦ã„ã‚‹ã€ã¨ã„ã†è¶£æ—¨ã®æ„å‘³æ·±ãªè¨€è‘‰ã‚’èªã‚‰ã›ã‚‹ã€‚
${reactionPrompt}
7.  **ã€ä¸€ã¤ã®ãƒãƒ¼ãƒ ã¨ã—ã¦ã€‘**: é‡æ‰‹ã®ä¸€äººãŒã€Œä¿ºãŸã¡ãŒã€ã‚ã„ã¤ã‚’ç”²å­åœ’ã®ãƒã‚¦ãƒ³ãƒ‰ã«é€£ã‚Œã¦è¡Œãã€ã¨åŠ›å¼·ãå®£è¨€ã—ã€ç‰©èªã‚’ç· ã‚ããã‚‹ã€‚
### å¿…ãšå«ã‚ã‚‹ã¹ãè¦ç´ 
- **ãƒãƒ¼ãƒ ãŒæŠ±ãˆã‚‹çŠ¶æ³ã‚’æå†™ã™ã‚‹ã“ã¨: ${teamMasterData.info}**
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆé•·ç·¨ã®è¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
            case 'win':
                title = `ã‚¨ãƒ¼ã‚¹å¿«æŠ•ï¼ã—ã‹ã—ã€å‹åˆ©ã®å½±ã«${teamName}ã®çµæŸã‚ã‚Š`;
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
ã€Œ${teamName}ã€ãŒå‹åˆ©ã€‚ãƒ¡ãƒ‡ã‚£ã‚¢ã¯ã‚¨ãƒ¼ã‚¹ã®å¿«æŠ•ã°ã‹ã‚Šã‚’å ±ã˜ã‚‹ã ã‚ã†ã€‚ã—ã‹ã—ã€ãã®è£ã«ã‚ã£ãŸä»²é–“ãŸã¡ã®ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚„ãƒãƒ¼ãƒ ã®çµæŸã“ããŒçœŸã®å‹å› ã ã£ãŸã“ã¨ã‚’ã€ã‚ãªãŸã®è¦–ç‚¹ã§æ·±ãæå†™ã—ã¦ãã ã•ã„ã€‚
### å¯¾æˆ¦ç›¸æ‰‹ã€Œ${matchData.opponent}ã€ã®èƒŒæ™¯
${matchData.opponentInfo}
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹
${matchData.summary || 'ç‰¹ã«ãªã—'}
### ã“ã®è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${matchData.highlights}
### æ§‹æˆæ¡ˆ
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€ãŒã€ã„ã‹ã«ãƒãƒ¼ãƒ ã®çµæŸåŠ›ã‚’è±¡å¾´ã™ã‚‹ãƒ—ãƒ¬ãƒ¼ã ã£ãŸã‹ã‚’ç‰©èªã®ä¸­å¿ƒã«æ®ãˆã‚‹ã€‚
2.  ã‚¨ãƒ¼ã‚¹ã®æŠ•çƒå†…å®¹ã‚’ç°¡æ½”ã«ç´¹ä»‹ã—ã¤ã¤ã€ã€Œã—ã‹ã—ã€ã“ã®æ—¥ã®ä¸»å½¹ã¯å½¼ã ã‘ã§ã¯ãªã‹ã£ãŸã€ã¨ç¶šã‘ã‚‹ã€‚
3.  ãã®ãƒ—ãƒ¬ãƒ¼ã‚’ã—ãŸé¸æ‰‹ã«ã€Œã‚¨ãƒ¼ã‚¹ã‚’åŠ©ã‘ã‚‹ã®ãŒä¿ºãŸã¡ã®ä»•äº‹ã§ã™ã‹ã‚‰ã€ã¨ã€èª‡ã‚‰ã—ã’ã«èªã‚‰ã›ã‚‹ã€‚
4.  ã‚¨ãƒ¼ã‚¹ã«ã€Œä»Šæ—¥ã®å‹åˆ©ã¯ã€ä¿ºä¸€äººã®åŠ›ã˜ã‚ƒãªã„ã€‚ã¿ã‚“ãªãŒå®ˆã£ã¦ãã‚ŒãŸãŠã‹ã’ã§ã™ã€ã¨ã€åˆã‚ã¦ä»²é–“ã«æ„Ÿè¬ã®è¨€è‘‰ã‚’è¿°ã¹ã•ã›ã‚‹ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆè¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
            case 'lose':
                title = `è‹±é›„ã€ã‚ã¾ã‚Šã«æ—©ã™ãã‚‹æ•—é€€ã€‚${teamName}ã®å¤ã€çµ‚ã‚ã‚‹`;
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ã‚’æ“ã—ãªãŒã‚‰ã€ã€Œ${teamName}ã€ã¯æ•—ã‚ŒãŸã€‚å¤©æ‰ã¨ä»²é–“ãŸã¡ã®ã€æ®‹é…·ã§ã€ã—ã‹ã—ç¾ã—ã„å¤ã®çµ‚ã‚ã‚Šã‚’æã„ã¦ãã ã•ã„ã€‚
### å¯¾æˆ¦ç›¸æ‰‹ã€Œ${matchData.opponent}ã€ã®èƒŒæ™¯
${matchData.opponentInfo}
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹
${matchData.summary || 'ç‰¹ã«ãªã—'}
### ã“ã®è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${matchData.highlights}
### æ§‹æˆæ¡ˆ
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€ãŒã€ã„ã‹ã«ã—ã¦çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ã‚’æ‰“ã¡å´©ã—ãŸã®ã‹ã€ãã®ä¸€ç¬ã‚’è©³ç´°ã«æå†™ã™ã‚‹ã€‚
2.  å¯¾æˆ¦ç›¸æ‰‹ãŒã©ã®ã‚ˆã†ãªãƒãƒ¼ãƒ ã§ã‚ã£ãŸã‹ï¼ˆã€å¯¾æˆ¦ç›¸æ‰‹ã®èƒŒæ™¯ã€‘ã‚’å‚ç…§ï¼‰ã«è§¦ã‚Œã‚‹ã“ã¨ã§ã€æ•—åŒ—ã®è¡æ’ƒã‚’éš›ç«‹ãŸã›ã‚‹ã€‚
3.  ãƒã‚¦ãƒ³ãƒ‰ã§å‘†ç„¶ã¨ã™ã‚‹ã‚¨ãƒ¼ã‚¹ã¨ã€å½¼ã«é§†ã‘å¯„ã‚Šã€ŒãŠå‰ã®ã›ã„ã˜ã‚ƒãªã„ã€ã¨å£°ã‚’ã‹ã‘ã‚‹ä»²é–“ãŸã¡ã®å§¿ã‚’æãã€‚
4.  ã€Œå½¼ã‚‰ã¯ãƒ¯ãƒ³ãƒãƒ³ãƒãƒ¼ãƒ ã§ã¯ãªã‹ã£ãŸã€‚å‹ã¤æ™‚ã‚‚ã€è² ã‘ã‚‹æ™‚ã‚‚ã€å½¼ã‚‰ã¯ä¸€ã¤ã®ãƒãƒ¼ãƒ ã ã£ãŸã€ã¨ç· ã‚ããã‚‹ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆè¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
        }
    } 
    // ==================================================================
    // --- 3. å¼·è±ªæ ¡ (powerhouse) ---
    // ==================================================================
    else if (type === 'powerhouse') {
        switch (phase) {
            case 'intro':
                title = `ã€${teamName}ã€ç‹è€…ã®å‘Šç™½ã€åºç« `;
                let reactionPrompt = '';
                if (matchData && matchData.opponent) {
                    const ourRank = calculateRank(teamName, tournamentState);
                    const opponentRank = matchData.opponentRank;
                    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
                    const rankDiff = rankValues[opponentRank] - rankValues[ourRank];

                    if (rankDiff >= 0) { // åŒæ ¼ã‹æ ¼ä¸Š
                        reactionPrompt = `
5.  **ã€è©¦ã•ã‚Œã‚‹ç‹å›½ã€‘**
    åˆæˆ¦ã®ç›¸æ‰‹ãŒã„ããªã‚Šå®ŸåŠ›æ ¡ã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚é¸æ‰‹ãŸã¡ã®é–“ã«èµ°ã‚‹ç·Šå¼µæ„Ÿã‚’ã€Œæ­“è¿ã™ã¹ãè©¦ç·´ã€ã¨ã—ã¦æå†™ã™ã‚‹ã€‚
6.  **ã€ç›£ç£ã®ã€å»ºå‰ã€ã¨ã€æœ¬éŸ³ã€ã€‘**
    ç›£ç£ã¯**é¸æ‰‹ãŸã¡ã®å‰ã§**ã€ã€Œåˆæˆ¦ã‹ã‚‰æœ€é«˜ã®ç›¸æ‰‹ã ã€‚æŒ‘æˆ¦è€…ã‚’å—ã‘ã‚‹è¦šæ‚Ÿã¯ã§ãã¦ã„ã‚‹ã€ã¨ã„ã†è¶£æ—¨ã§ã€ãƒãƒ¼ãƒ ã®ãƒ—ãƒ©ã‚¤ãƒ‰ã‚’ç…½ã‚‹ã€‚
    ã—ã‹ã—è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€ã€Œå³ã—ã„æˆ¦ã„ã«ãªã‚‹ã€‚ã ãŒã€ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã®æœ¬å‘½ã¯æˆ‘ã€…ã¨**${matchData.toughestRival}**ã€‚å½¼ã‚‰ã¯æ˜¨å¹´${matchData.toughestRivalRecord}ã€‚å€’ã™ãŸã‚ã«ã¯ã€ã©ã“ã‹ã§é€šã‚‰ãªã‘ã‚Œã°ã„ã‘ãªã„é“ã ã€ã¨ã„ã†è¶£æ—¨ã§ã€å³ã—ã„æœ¬éŸ³ã‚’èªã‚‰ã›ã‚‹ã€‚`;
                    } else { // æ ¼ä¸‹
                        reactionPrompt = `
5.  **ã€ç‹è€…ã®é™å¯‚ã€‘**
    åˆæˆ¦ã®ç›¸æ‰‹ãŒã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚é¸æ‰‹ãŸã¡ã¯è¡¨æƒ…ä¸€ã¤å¤‰ãˆãšã€æ·¡ã€…ã¨æ¬¡ã®ç·´ç¿’ã®æº–å‚™ã‚’å§‹ã‚ã‚‹ã€‚
6.  **ã€ç›£ç£ã®ã€å»ºå‰ã€ã¨ã€æœ¬éŸ³ã€ã€‘**
    ç›£ç£ãŒ**é¸æ‰‹ãŸã¡ã®å‰ã§**ã¯ã€Œæ²¹æ–­ã™ã‚‹ãªã€ã¨ã„ã†è¶£æ—¨ã§å¼•ãç· ã‚ã¤ã¤ã€è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€ã€Œåˆæˆ¦ã¯å•é¡Œãªã„ã€‚æœ¬å½“ã®å‹è² ã¯**${matchData.toughestRival}**æˆ¦ã€‚å½¼ã‚‰ã¯æ˜¨å¹´${matchData.toughestRivalRecord}ã®å®ŸåŠ›æ ¡ã ã€‚ãã“ãŒäº‹å®Ÿä¸Šã®æ±ºå‹æˆ¦ã«ãªã‚‹ã ã‚ã†ã€ã¨ã„ã†è¶£æ—¨ã§ã€å…ˆã‚’è¦‹æ®ãˆãŸåˆ†æã‚’èªã‚‰ã›ã‚‹ã€‚`;
                    }
                }
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
çµ¶å¯¾çš„ç‹è€…ã€Œ${teamName}ã€ã®æ „å…‰ã®è£ã«éš ã•ã‚ŒãŸè‹¦æ‚©ã¨ã€å¸¸äººã«ã¯ç†è§£ã—ãŒãŸã„ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‚’æãã€‚
${charactersPrompt}
### æ§‹æˆæ¡ˆ
1.  **ã€é™å¯‚ã®ãƒˆãƒ­ãƒ•ã‚£ãƒ¼å®¤ã€‘**: ç„¡æ•°ã«ä¸¦ã¶å„ªå‹ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ãŒæ”¾ã¤è¼ãã¨ã€ã€Œå‹ã£ã¦å½“ç„¶ã€ã¨ã„ã†é‡åœ§ã‚’æå†™ã™ã‚‹ã€‚
2.  **ã€Bã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®é™½ç‚ã€‘**: ãƒ™ãƒ³ãƒå…¥ã‚Šã§ããªã‹ã£ãŸ3å¹´ç”ŸãŒã€æœ€å¾Œã®å¤ã«ã‚‚é–¢ã‚ã‚‰ãšã€é»™ã€…ã¨å¾Œè¼©ã¸ã®ã‚µãƒãƒ¼ãƒˆã‚’å‹™ã‚ã‚‹ã€‚å½¼ã®ã€Œãƒãƒ¼ãƒ ã¸ã®æ„›ã€ã¨ã€Œè«¦ã‚ã€ã®ç‹¬ç™½ã‚’å¼•ãå‡ºã™ã€‚
3.  **ã€ç›£ç£ã®éæƒ…ãªå‹è² è«–ã€‘**: ç›£ç£ã«ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã€‚ã€Œå‹ã¤ãŸã‚ã«ã¯ã€æ™‚ã«éæƒ…ã«ãªã‚‰ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚ãã‚ŒãŒç‹è€…ã§ã‚ã‚Šç¶šã‘ã‚‹ã¨ã„ã†ã“ã¨ã ã€ã¨ã„ã†å½¼ã®å“²å­¦ã‚’èªã‚‰ã›ã‚‹ã€‚
4.  **ã€ä¸»å°†ã®å­¤ç‹¬ãªèƒŒä¸­ã€‘**: ã‚¹ã‚¿ãƒ¼é¸æ‰‹æƒã„ã®ãƒãƒ¼ãƒ ã‚’ä¸€ã¤ã«ã¾ã¨ã‚ã‚‹ã“ã¨ã®é›£ã—ã•ã¨ã€ã€Œè² ã‘ã‚‹ã“ã¨ãŒè¨±ã•ã‚Œãªã„ã€ã¨ã„ã†ç‹è€…ãªã‚‰ã§ã¯ã®å­¤ç‹¬ãªè¦šæ‚Ÿã‚’ä¸»å°†ã«èªã‚‰ã›ã‚‹ã€‚
${reactionPrompt}
7.  **ã€ç‹è€…ã€å‡ºé™£ã€‘**: ä¸»å°†ãŒã€Œä¿ºãŸã¡ã®ç›®æ¨™ã¯ã€çœŒå¤§ä¼šå„ªå‹ã˜ã‚ƒãªã„ã€‚ãã®å…ˆã«ã‚ã‚‹ã€ã¨ã€å…¨å›½ã®é ‚ç‚¹ã ã‘ã‚’è¦‹æ®ãˆã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºå”†ã—ã¦ç· ã‚ããã‚‹ã€‚
### å¿…ãšå«ã‚ã‚‹ã¹ãè¦ç´ 
- **ãƒãƒ¼ãƒ ãŒæŠ±ãˆã‚‹çŠ¶æ³ã‚’æå†™ã™ã‚‹ã“ã¨: ${teamMasterData.info}**
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆé•·ç·¨ã®è¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
            case 'win':
                title = `ã€${teamName}ã€ç‹è€…ã®å‘Šç™½ã€ç¬¬${matchData.round}ç« `;
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
ã€Œ${teamName}ã€ãŒå‹åˆ©ã€‚ã—ã‹ã—å½¼ã‚‰ã«ã¨ã£ã¦ã“ã®å‹åˆ©ã¯æ­“å–œã§ã¯ãªãã€ã€Œæ¬¡ã¸é€²ã‚€ãŸã‚ã®ç¾©å‹™ã€ã§ã—ã‹ãªã„ã€‚ãã®ç‹¬ç‰¹ã®ç©ºæ°—æ„Ÿã‚’ãƒªã‚¢ãƒ«ã«æå†™ã—ã¦ãã ã•ã„ã€‚
### å¯¾æˆ¦ç›¸æ‰‹ã€Œ${matchData.opponent}ã€ã®èƒŒæ™¯
${matchData.opponentInfo}
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹
${matchData.summary || 'ç‰¹ã«ãªã—'}
### ã“ã®è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${matchData.highlights}
### æ§‹æˆæ¡ˆ
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€ã‚’å¼•ç”¨ã—ã€ãã‚ŒãŒç‹è€…ã¨ã—ã¦ã®åŠ›ã®è¨¼æ˜ã§ã‚ã£ãŸã“ã¨ã‚’ç¤ºã™ã€‚
2.  å¯¾æˆ¦ç›¸æ‰‹ãŒã©ã®ã‚ˆã†ãªãƒãƒ¼ãƒ ã§ã‚ã£ãŸã‹ï¼ˆã€å¯¾æˆ¦ç›¸æ‰‹ã®èƒŒæ™¯ã€‘ã‚’å‚ç…§ï¼‰ã«è§¦ã‚Œã€å‹åˆ©ãŒé †å½“ã§ã‚ã£ãŸã“ã¨ã‚’æå†™ã™ã‚‹ã€‚
3.  è©¦åˆå¾Œã€å®‰å µã®è¡¨æƒ…ã‚’æµ®ã‹ã¹ã‚‹ã‚‚ã€æ±ºã—ã¦å–œã³ã‚’çˆ†ç™ºã•ã›ãªã„é¸æ‰‹ãŸã¡ã®å§¿ã€‚
4.  ç›£ç£ã«ã€Œä»Šæ—¥ã®ãƒ—ãƒ¬ãƒ¼ã§æº€è¶³ã›ãšã€æ¬¡ã‚’è¦‹æ®ãˆã¦ã„ã‚‹ã€ã¨ã„ã†è¶£æ—¨ã®ã€å†·é™ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’ã•ã›ã‚‹ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆè¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
            case 'lose':
                title = `ã€${teamName}ã€ç‹è€…ã®å‘Šç™½ã€æœ€çµ‚ç« `;
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
çµ¶å¯¾çš„ç‹è€…ã€Œ${teamName}ã€ã®å¤ãŒçµ‚ã‚ã£ãŸã€‚ç‹å›½ã®å´©å£Šã®ç¬é–“ã¨ã€é¸æ‰‹ãŸã¡ã®åˆã‚ã¦è¦‹ã›ã‚‹æ¶™ã€ãã—ã¦é‡åœ§ã‹ã‚‰ã®è§£æ”¾ã‚’æ„Ÿå‚·çš„ã«è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚
### å¯¾æˆ¦ç›¸æ‰‹ã€Œ${matchData.opponent}ã€ã®èƒŒæ™¯
${matchData.opponentInfo}
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹
${matchData.summary || 'ç‰¹ã«ãªã—'}
### ã“ã®è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${matchData.highlights}
### æ§‹æˆæ¡ˆ
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€ãŒã€ã„ã‹ã«ã—ã¦çµ¶å¯¾ç‹è€…ã®æ­¯è»Šã‚’ç‹‚ã‚ã›ãŸã®ã‹ã€ãã®ç¬é–“ã‚’å…‹æ˜ã«æå†™ã™ã‚‹ã€‚
2.  å¯¾æˆ¦ç›¸æ‰‹ãŒã©ã®ã‚ˆã†ãªãƒãƒ¼ãƒ ã§ã‚ã£ãŸã‹ï¼ˆã€å¯¾æˆ¦ç›¸æ‰‹ã®èƒŒæ™¯ã€‘ã‚’å‚ç…§ï¼‰ã«è§¦ã‚Œã€ã“ã®æ•—æˆ¦ãŒæ­´å²çš„ãªç•ªç‹‚ã‚ã›ã§ã‚ã‚‹ã“ã¨ã‚’å¼·èª¿ã™ã‚‹ã€‚
3.  è©¦åˆçµ‚äº†ã®ã‚µã‚¤ãƒ¬ãƒ³ãŒé³´ã‚ŠéŸ¿ãã€çƒå ´ã®ä¿¡ã˜ã‚‰ã‚Œãªã„ã‚ˆã†ãªé™å¯‚ã‚’æå†™ã™ã‚‹ã€‚
4.  ã“ã‚Œã¾ã§å¸¸ã«æ°—ä¸ˆã«æŒ¯ã‚‹èˆã£ã¦ããŸä¸»å°†ãŒã€åˆã‚ã¦ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«æ³£ãå´©ã‚Œã‚‹å§¿ã«ç„¦ç‚¹ã‚’å½“ã¦ã‚‹ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆè¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
        }
    } 
    // ==================================================================
    // --- 4. é€†å¢ƒãƒãƒ¼ãƒ  (underdog) ---
    // ==================================================================
    else { 
        switch (phase) {
            case 'intro':
                        // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
                        title = `ã€${teamName}ã€é­‚ã®è¨˜éŒ²ã€åºç« ï¼šãã‚Œã§ã‚‚ã€å½¼ã‚‰ã¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç«‹ã¤`;
                        let reactionPrompt = '';
                        let teamSpecificInfo = teamMasterData.info || 'ç‰¹ç­†ã™ã¹ãæƒ…å ±ãªã—';
                        let handicapFocusPrompt = ''; // å…ˆã«ç©ºã§å®šç¾©

                        // â–¼â–¼â–¼ ã€æœ€é‡è¦ã€‘ã€Œæµœæ¾ç‰¹æ”¯ã€å°‚ç”¨ã®ç‰¹åˆ¥åˆ†å² â–¼â–¼â–¼
                        if (teamName === 'æµœæ¾ç‰¹æ”¯') {
                            handicapFocusPrompt = `
3.  **ã€ç‰¹åˆ¥ãªå¤ã€ãã®æ„å‘³ã€‘**: çœŒå†…å”¯ä¸€ã®ç‰¹åˆ¥æ”¯æ´å­¦æ ¡ã®é‡çƒéƒ¨ã€æµœæ¾ç‰¹æ”¯ã€‚éƒ¨å“¡ã¯å…¨å“¡1å¹´ç”Ÿã€‚å½¼ã‚‰ã«ã¨ã£ã¦ã€ã“ã‚Œã¯åˆã‚ã¦ã®å¤ã§ã‚ã‚Šã€å…¨ã¦ãŒæŒ‘æˆ¦ã§ã‚ã‚‹ã€‚
4.  **ã€æ˜¥ã®è¨˜æ†¶ã¨å®‰å…¨ã¸ã®å£°ã€‘**: è¨˜è€…ãŒåŒ—æ‘ç›£ç£ã«è©±ã‚’èãã¨ã€å½¼ã¯æ˜¥ã®ç·´ç¿’è©¦åˆâ€”ç‹è€…ãƒ»283å­¦åœ’ã«å–«ã—ãŸã€Œ52-0ã€ã®å¤§æ•—â€”ã«ã¤ã„ã¦é‡ã„å£ã‚’é–‹ãã€‚ã€Œã‚ã®è©¦åˆã§ã€é¸æ‰‹ãŸã¡ã‹ã‚‰é‡çƒã®æ¥½ã—ã•ã‚’å¥ªã£ã¦ã—ã¾ã£ãŸã‹ã‚‚ã—ã‚Œãªã„ã€ã¨ã€‚åŒæ™‚ã«ã€å¤–éƒ¨ã‹ã‚‰å¯„ã›ã‚‰ã‚Œã‚‹ã€ŒçŸ¥çš„éšœå®³ã‚’æŒã¤å½¼ã‚‰ã«ã€ç¡¬çƒã‚’ä½¿ã£ãŸé‡çƒã¯æœ¬å½“ã«å®‰å…¨ãªã®ã‹ã€ã¨ã„ã†å³ã—ã„æ‰¹åˆ¤ã®å£°ã«ã‚‚ç›´é¢ã—ã¦ã„ã‚‹ã“ã¨ã‚’æ˜ã‹ã™ã€‚
5.  **ã€éƒ¨å®¤ã®é‡çƒãƒãƒ¼ãƒˆã€‘**: éƒ¨å®¤ä»£ã‚ã‚Šã®ç†ç§‘æº–å‚™å®¤ã«ç½®ã‹ã‚ŒãŸé‡çƒãƒãƒ¼ãƒˆã€‚ã€Œã“ã‚ã„ã€ã€ŒãŸã”(â€»ãŸã®ã—ããªã„)ã€ã€‚ãã“ã«ã¯ã€å½¼ã‚‰ã®ç´”ç²‹ãªææ€–ã¨è‹¦ã—ã¿ãŒè¨˜ã•ã‚Œã¦ã„ãŸã€‚
6.  **ã€ã‚ã‚‹é¸æ‰‹ã®æŒ‘æˆ¦ï¼ˆé«˜æ©‹ å¥å¤ªï¼‰ã€‘**: ãƒãƒ¼ãƒ ã®ä¸€äººã€é«˜æ©‹å¥å¤ªãã‚“ï¼ˆä»®åï¼‰ã«ç„¦ç‚¹ã‚’å½“ã¦ã‚‹ã€‚å½¼ã¯é‡åº¦ã®çŸ¥çš„éšœå®³ã‚’æŠ±ãˆã¦ãŠã‚Šã€ä»²é–“ã¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã€ãƒ«ãƒ¼ãƒ«ã®ç†è§£ã«ã‚‚äººä¸€å€æ™‚é–“ãŒã‹ã‹ã‚‹ã€‚ã ãŒã€ç·´ç¿’ã§å”¯ä¸€ã€Œãƒãƒƒãƒˆã«ãƒœãƒ¼ãƒ«ã‚’å½“ã¦ã‚‹ã€ã“ã¨ã ã‘ã¯èª°ã‚ˆã‚Šã‚‚å¾—æ„ã ã€‚
7.  **ã€ã‚ã‚‹æ¯è¦ªã®æ¶™ã€‘**: ç·´ç¿’ã‚’ãƒ•ã‚§ãƒ³ã‚¹è¶Šã—ã«è¦‹ã¤ã‚ã‚‹å¥å¤ªãã‚“ã®æ¯è¦ªã«ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã€‚ã€Œã‚ã®å­ãŒ...ã‚ã®å­ãŒã€ä»²é–“ã¨å£°ã‚’æ›ã‘åˆã£ã¦ãƒœãƒ¼ãƒ«ã‚’è¿½ã„ã‹ã‘ã¦ã„ã‚‹...ã€‚é‡çƒã‚’å§‹ã‚ã‚‹å‰ã¯ã€ãã‚“ãªã“ã¨æƒ³åƒã‚‚ã§ãã¾ã›ã‚“ã§ã—ãŸã€ã€‚å½¼å¥³ã¯ãã†è¨€ã†ã¨ã€æ„Ÿæ¥µã¾ã£ã¦æ¶™ã‚’æ‹­ã£ãŸã€‚ã€Œå‹ãŸãªãã¦ã„ã„ã€‚ãŸã ã€ã‚ã®å­ãŒæ¥½ã—ãã†ã«ãƒãƒƒãƒˆã‚’æŒ¯ã£ã¦ã€9å›ã¾ã§è©¦åˆãŒã§ããŸã‚‰...ãã‚Œã ã‘ã§...ã€
8.  **ã€ç›£ç£ã®è‘›è—¤ã€‘**: åŒ—æ‘ç›£ç£ã®è‘›è—¤ã‚’æå†™ã™ã‚‹ã€‚ã€Œå‹åˆ©ã€ã§ã¯ãªã„ã€‚ã€Œè©¦åˆã‚’æˆç«‹ã•ã›ã‚‹ã“ã¨ã€ã®çµ¶æœ›çš„ãªé›£ã—ã•ã€ãã—ã¦ã€Œå½¼ã‚‰ã®å®‰å…¨ã‚’å®ˆã‚ŠãªãŒã‚‰ã€ã©ã†ã‚„ã£ã¦é‡çƒã®æ¥½ã—ã•ã‚’å–ã‚Šæˆ»ã•ã›ã‚‹ã‹ã€ã¨ã„ã†ç­”ãˆã®ãªã„å•ã„ã«æ—¥ã€…å‘ãåˆã†å§¿ã‚’æ·±ãæ˜ã‚Šä¸‹ã’ã‚‹ã€‚
9.  **ã€å½¼ã‚‰ã®ç›®æ¨™ã€‘**: ä¸»å°†ã«ä»Šå¤§ä¼šã®ç›®æ¨™ã‚’èãã€‚ã€Œç”²å­åœ’ã˜ã‚ƒãªã„ã€‚9å›ã¾ã§æˆ¦ã„æŠœã„ã¦ã€ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã«...0ä»¥å¤–ã®æ•°å­—ã‚’ç¯ã—ãŸã„ã€ã€‚ãã®è¨€è‘‰ã®é‡ã¿ã‚’æå†™ã™ã‚‹ã€‚`;
                        }
                        // â–¼â–¼â–¼ ã€ã”è¦æœ›ã€‘ã€Œå»ƒæ ¡ã€ãƒãƒ¼ãƒ ã®å°‚ç”¨åˆ†å²ï¼ˆOBä¼šé•·ç™»å ´ï¼‰ â–¼â–¼â–¼
                        else if (teamSpecificInfo.includes('æœ€å¾Œã®å¤') || teamSpecificInfo.includes('é–‰æ ¡')) {
                            handicapFocusPrompt = `
3.  **ã€æœ€å¾Œã®ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã€‘**: ä»Šå¹´åº¦ã§é–‰æ ¡ã¨ãªã‚‹${teamName}ã€‚ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰è„‡ã§ã¯æ ¡èˆã®è§£ä½“ä½œæ¥­ãŒé€²ã‚€ã€‚é‡æ©Ÿã®éŸ³ãŒéŸ¿ãä¸­ã€ç·´ç¿’ã™ã‚‹ç•°æ§˜ãªæ—¥å¸¸ã‚’æå†™ã™ã‚‹ã€‚
4.  **ã€OBä¼šé•·ã®è¿½æ†¶ã€‘**: ç·´ç¿’ã‚’ãƒ•ã‚§ãƒ³ã‚¹è¶Šã—ã«è¦‹ã¤ã‚ã‚‹OBä¼šé•·ï¼ˆã¾ãŸã¯å¾Œæ´ä¼šä¼šé•·ï¼‰ã«ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã€‚å½¼ã¯ã€è§£ä½“ãŒé€²ã‚€æ¯æ ¡ã‚’è¤‡é›‘ãªé¢æŒã¡ã§è¦‹ã¤ã‚ãªãŒã‚‰ã€ã€Œæ˜”ã¯ã“ã“ã‚‚å…¨æ ¡ç”Ÿå¾’ã®å¿œæ´ã§æº¢ã‚Œã‹ãˆã£ã¦ã„ãŸã€ã€Œã¾ã•ã‹è‡ªåˆ†ãŸã¡ã®ä»£ã§æ ¡åãŒãªããªã‚‹ã¨ã¯æ€ã‚ãªã‹ã£ãŸã‚ˆâ€¦ã€ã¨ã€æ´»æ°—ãŒã‚ã£ãŸé ƒã®æ˜”ã®æ§˜å­ã‚’èªã‚Šã€å¯‚ã—ãã†ã«ç›®ã‚’ä¼ã›ã‚‹ã€‚
5.  **ã€3å¹´ç”Ÿã®æƒ³ã„ã€‘**: ã“ã®ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç€ã‚‹æœ€å¾Œã®ä¸–ä»£ã¨ãªã£ãŸ3å¹´ç”Ÿã«ç„¦ç‚¹ã‚’å½“ã¦ã‚‹ã€‚ã€Œæ¯æ ¡ã®åå‰ã‚’åˆ»ã¿ãŸã„ã€ã¨ã„ã†OBä¼šé•·ãŸã¡ã®æƒ³ã„ã‚‚èƒŒè² ã„ã€å½¼ã‚‰ã®åˆ‡å®Ÿãªè¦šæ‚Ÿã¨ã€å¾Œè¼©ãŒã„ãªã„ï¼ˆã‚ã‚‹ã„ã¯å¼•ãç¶™ã’ãªã„ï¼‰ã“ã¨ã¸ã®è¤‡é›‘ãªå¿ƒå¢ƒã‚’å¼•ãå‡ºã™ã€‚
6.  **ã€ç›£ç£ã®å‹™ã‚ã€‘**: ç›£ç£ã«ã€Œæœ€å¾Œã®å¤ã€ã«è‡¨ã‚€å¿ƒå¢ƒã‚’å•ã†ã€‚æŠ€è¡“çš„ãªæŒ‡å°ä»¥ä¸Šã«ã€å½¼ã‚‰ã«ã¨ã£ã¦ã“ã®å¤ãŒã©ã®ã‚ˆã†ãªæ„å‘³ã‚’æŒã¤ã¹ãã‹ã€æ•™è‚²è€…ã¨ã—ã¦ã®è‘›è—¤ã¨æ±ºæ„ã‚’èªã‚‰ã›ã‚‹ã€‚`;
                        }
                        // â–¼â–¼â–¼ ä»–ã®é€†å¢ƒæ ¡ã®åˆ†å² â–¼â–¼â–¼
                        else if (teamSpecificInfo.includes('éƒ¨å“¡ä¸è¶³') || teamSpecificInfo.includes('é€£åˆãƒãƒ¼ãƒ ') || teamSpecificInfo.includes('0å‹')) {
                             handicapFocusPrompt = `
3.  **ã€é›†ã¾ã‚‰ãªã„9äººã€‘**: ${teamName}ã®ç·´ç¿’é¢¨æ™¯ã‚’æå†™ã™ã‚‹ã€‚åŠ©ã£äººã®ç”Ÿå¾’ï¼ˆä»–éƒ¨æ´»ï¼‰ã¨å…±ã«ç·´ç¿’ã™ã‚‹æ§˜å­ã‚„ã€ç›£ç£è‡ªã‚‰ãŒãƒãƒƒã‚¯ã®çƒæ‹¾ã„ã‚’ã™ã‚‹å§¿ã‚’æãã€‚ï¼ˆâ€»ã‚‚ã—ã€Œ0å‹32æ•—ã€ã®ã‚ˆã†ãªæƒ…å ±ãŒã‚ã‚Œã°ã€ãã®æ­´å²çš„æ•—åŒ—ã®é‡åœ§ã«ã‚‚è§¦ã‚Œã‚‹ï¼‰
4.  **ã€ä¸»å°†ã®è‹¦åŠ´ã€‘**: è©¦åˆã«å‡ºã‚‹ã ã‘ã§ãªãã€éƒ¨å“¡ã®å‹§èª˜ã‚„ãƒãƒ¼ãƒ ã®é›°å›²æ°—ä½œã‚Šã«å¥”èµ°ã™ã‚‹ä¸»å°†ã«ç„¦ç‚¹ã‚’å½“ã¦ã‚‹ã€‚ã€Œé‡çƒãŒã§ãã‚‹ã ã‘ã§ã‚ã‚ŠãŒãŸã„ã€ã¨ã„ã†å½¼ã®è¨€è‘‰ã®é‡ã¿ã‚’æå†™ã™ã‚‹ã€‚
5.  **ã€ç›£ç£ã®ä¿¡å¿µã€‘**: ç›£ç£ã«ã€Œãªãœé‡çƒéƒ¨ã‚’ç¶šã‘ã‚‹ã®ã‹ã€ã‚’å•ã†ã€‚å‹åˆ©ä»¥å‰ã«ã€é‡çƒã‚’é€šã˜ã¦å½¼ã‚‰ã«ä½•ã‚’å­¦ã‚“ã§ã»ã—ã„ã®ã‹ã€ãã®ä¿¡å¿µã‚’èªã‚‰ã›ã‚‹ã€‚`;
                        } else if (teamSpecificInfo.includes('é›¢å³¶')) {
                             handicapFocusPrompt = `
3.  **ã€å³¶ã‚’èƒŒè² ã†ã€‘**: æœ¬åœŸã‹ã‚‰é ãé›¢ã‚ŒãŸ${teamName}ã€‚ç·´ç¿’è©¦åˆã‚‚ã¾ã¾ãªã‚‰ãšã€æƒ…å ±ã‚‚å°‘ãªã„ã¨ã„ã†çµ¶æœ›çš„ãªãƒãƒ³ãƒ‡ã‚’æå†™ã™ã‚‹ã€‚
4.  **ã€å³¶æ°‘ã®æœŸå¾…ã€‘**: å½¼ã‚‰ã®å­˜åœ¨ãŒã€å³¶ã«ã¨ã£ã¦ã©ã®ã‚ˆã†ãªå¸Œæœ›ã¨ãªã£ã¦ã„ã‚‹ã®ã‹ã€‚ç·´ç¿’ã‚’è¦‹å®ˆã‚‹åœ°å…ƒä½æ°‘ã‚„ã€æ¼ã®åˆé–“ã«æ‰‹ä¼ã†OBã®å£°ã‚’æ‹¾ã†ã€‚
5.  **ã€ç›£ç£ã®æˆ¦ç•¥ã€‘**: ç›£ç£ã«ã€Œæœ¬åœŸã®å¼·è±ªã‚’ã©ã†å€’ã™ã‹ã€ã‚’å•ã†ã€‚æƒ…å ±ãŒå°‘ãªã„ä¸­ã§ã€å½¼ã‚‰ãŒç£¨ã„ã¦ããŸã€Œå³¶ãªã‚‰ã§ã¯ã®é‡çƒã€ã¨ã¯ä½•ã‹ã‚’èªã‚‰ã›ã‚‹ã€‚`;
                        } else {
                            // ä¸Šè¨˜ä»¥å¤–ã®é€†å¢ƒæ ¡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                            handicapFocusPrompt = `
3.  **ã€ãƒãƒ¼ãƒ ã®ç¾åœ¨åœ°ã€‘**: è¨˜è€…ãŒãƒãƒ¼ãƒ ã®å…ƒã‚’è¨ªã‚Œã‚‹å ´é¢ã‹ã‚‰å§‹ã‚ã‚‹ã€‚ç›£ç£ã‚„é¸æ‰‹ã«ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã—ã€ãƒãƒ¼ãƒ ãŒæŠ±ãˆã‚‹å…·ä½“çš„ãªãƒãƒ³ãƒ‡ï¼ˆä¾‹ï¼š${teamSpecificInfo}ï¼‰ã¨ã€ãã‚Œã«å¯¾ã™ã‚‹å½¼ã‚‰ã®æƒ³ã„ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹ã€‚
4.  **ã€ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®æƒ…æ™¯ã€‘**: ç·´ç¿’é¢¨æ™¯ã‚’æå†™ã™ã‚‹ã€‚éƒ¨å“¡æ•°ã®å°‘ãªã•ï¼ˆä¾‹ï¼šç´…ç™½æˆ¦ãŒã§ããªã„ï¼‰ã€æµã¾ã‚Œãªã„ç·´ç¿’ç’°å¢ƒï¼ˆä¾‹ï¼šã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãŒä»–ã®éƒ¨ã¨å…±ç”¨ã€é“å…·ãŒå¤ã„ï¼‰ã¨ã„ã£ãŸã€å½¼ã‚‰ã®ã€Œæ—¥å¸¸ã€ã‚’å…·ä½“çš„ã«æãã€‚`;
                        }


                        if (matchData && matchData.opponent) {
                            const ourRank = calculateRank(teamName, tournamentState);
                            const opponentRank = matchData.opponentRank;
                            const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
                            const rankDiff = rankValues[opponentRank] - rankValues[ourRank];
                            
                            // æ§‹æˆæ¡ˆã®ã‚¹ãƒ†ãƒƒãƒ—æ•°ã‚’å‹•çš„ã«è¨ˆç®—
                            const handicapSteps = handicapFocusPrompt.split('\n').filter(line => line.trim().match(/^\d+\./)).length;
                            const stepOffset = 1 + 1 + handicapSteps; // (å†’é ­ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ + ç¾å®Ÿ) + ãƒãƒ³ãƒ‡æ§‹æˆæ¡ˆã®ã‚¹ãƒ†ãƒƒãƒ—æ•°

                            if (rankDiff >= 2) { // çµ¶æœ›çš„ãªæ ¼ä¸Š
                                reactionPrompt = `
${stepOffset + 1}.  **ã€æ®‹é…·ãªç¾å®Ÿã€ãã—ã¦ç›£ç£ã®ã€å»ºå‰ã€ã€‘**: åˆæˆ¦ã®ç›¸æ‰‹ãŒæ ¼ä¸Šã®å¼·è±ªã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚çµ¶æœ›ã¨æ²ˆé»™ã«åŒ…ã¾ã‚Œã‚‹é¸æ‰‹ãŸã¡ã‚’æå†™ã™ã‚‹ã€‚
${stepOffset + 2}.  **ã€ç›£ç£å®¤ã®ã€æœ¬éŸ³ã€ã€‘**: ç›£ç£ãŒ**é¸æ‰‹ãŸã¡ã®å‰ã§**ã¯ã€Œã“ã‚Œã¯è©¦ç·´ã ã€‚ã ãŒã€æ­´å²ã‚’å‰µã‚‹ãƒãƒ£ãƒ³ã‚¹ã§ã‚‚ã‚ã‚‹ã€ã¨åŠ›å¼·ãèªã‚‹ä¸€æ–¹ã€è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€Œã„ã‚„ã€æ­£ç›´ã—ã‚“ã©ã„ã§ã™ã‚ˆâ€¦ç¬‘ã£ã¡ã‚ƒã„ã¾ã—ãŸã‚‚ã‚“ã€ã¾ã•ã‹ã€‡ã€‡ï¼ˆç›¸æ‰‹æ ¡åï¼‰ã¨å½“ãŸã‚‹ãªã‚“ã¦â€¦ã€ã¨ã€äººé–“å‘³ã‚ãµã‚Œã‚‹å¼±éŸ³ã‚„æœ¬éŸ³ã‚’æ¼ã‚‰ã™ã€‚`;
                            } else if (rankDiff >= 1) { // å°‘ã—æ ¼ä¸Š
                                reactionPrompt = `
${stepOffset + 1}.  **ã€æŒ‘æˆ¦è€…ãŸã¡ã€‘**: åˆæˆ¦ã®ç›¸æ‰‹ãŒã€æ ¼ä¸Šã®ã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚é¸æ‰‹ãŸã¡ãŒã€Œä¸è¶³ã¯ãªã„ç›¸æ‰‹ã€ã€Œä¸€æ³¡å¹ã‹ã›ã¦ã‚„ã‚‹ã€ã¨é—˜å¿—ã‚’ç‡ƒã‚„ã™æ§˜å­ã‚’æå†™ã™ã‚‹ã€‚
${stepOffset + 2}.  **ã€ç›£ç£ã®æˆ¦ç•¥ã€‘**: ç›£ç£ã¯**é¸æ‰‹ãŸã¡ã®å‰ã§**ã€Œè‰¯ã„é¡”ã¤ãã«ãªã£ãŸãªã€ã¨å½¼ã‚‰ã®å£«æ°—ã‚’é«˜ã‚ã¤ã¤ã€è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€Œæ­£ç›´ã€å‹ç‡ã¯3å‰²ã‚‚ãªã„ã§ã—ã‚‡ã†ã€‚ã§ã‚‚ã€é«˜æ ¡é‡çƒã¯ä½•ãŒèµ·ã“ã‚‹ã‹åˆ†ã‹ã‚‰ãªã„ã€ã¨ã€å†·é™ãªåˆ†æã¨æœ¬éŸ³ã‚’èªã‚‹ã€‚`;
                            } else { // åŒæ ¼ã‹æ ¼ä¸‹
                                reactionPrompt = `
${stepOffset + 1}.  **ã€é‹å‘½ã®åˆæˆ¦ã€‘**: åˆæˆ¦ã®ç›¸æ‰‹ãŒå®ŸåŠ›ã®è¿‘ã„ã€Œ${matchData.opponent}ã€(æ˜¨å¹´åº¦: ${matchData.opponentRecord})ã«æ±ºå®šã€‚ã€Œå‹ã¦ã‚‹ï¼ã€ã¨å°‘ã—æµ®è¶³ç«‹ã¤é¸æ‰‹ãŸã¡ã‚’æå†™ã™ã‚‹ã€‚
${stepOffset + 2}.  **ã€ç›£ç£ã®ã€å»ºå‰ã€ã¨ã€æœ¬éŸ³ã€ã€‘**: ç›£ç£ãŒ**é¸æ‰‹ãŸã¡ã®å‰ã§**ã€Œæ²¹æ–­ãŒä¸€ç•ªã®æ•µã ã€ã¨å³ã—ãä¸€å–ã™ã‚‹ä¸€æ–¹ã€è¨˜è€…ã®å‰ã§ã¯**äºŒäººãã‚Šã§**ã€Œæœ€é«˜ã®ã‚¯ã‚¸ã‚’å¼•ãã¾ã—ãŸã€‚ã“ã“ã‚’å‹ã¦ã°ã€é–“é•ã„ãªããƒãƒ¼ãƒ ã¯æ³¢ã«ä¹—ã‚Œã‚‹ã€ã¨ã€å®‰å µã¨ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ãŒå…¥ã‚Šæ··ã˜ã£ãŸæœ¬éŸ³ã‚’èªã‚‹ã€‚`;
                            }
                        }

                        // æœ€å¾Œã®æ±ºæ„è¡¨æ˜ã®ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·ã‚‚å‹•çš„ã«
                        const finalStepNumber = (handicapFocusPrompt.split('\n').filter(line => line.trim().match(/^\d+\./)).length) + (reactionPrompt ? 2 : 0) + 3;
                        let finalPledge = 'ä¿ºãŸã¡ã¯é‡çƒãŒã—ãŸã„ã ã‘ã€‚ç›¸æ‰‹ãŒèª°ã§ã‚‚ã€å…¨åŠ›ã§æˆ¦ã†ã ã‘ã§ã™'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                        if (teamName === 'æµœæ¾ç‰¹æ”¯') finalPledge = 'æ€–ã„ã‘ã©...é€ƒã’ã¾ã›ã‚“ã€‚9å›ã¾ã§æˆ¦ã„ã¾ã™';
                        if (teamSpecificInfo.includes('æœ€å¾Œã®å¤')) finalPledge = 'ã“ã‚ŒãŒæœ€å¾Œã®å¤ã€‚ä¸€è©¦åˆã§ã‚‚é•·ãã€ã“ã®ä»²é–“ã¨ã€æ¯æ ¡ã®åå‰ã§é‡çƒãŒã—ãŸã„ã§ã™';


                        prompt += `
### å–æãƒ†ãƒ¼ãƒ
ã€Œ${teamName}ã€ãŒæŠ±ãˆã‚‹å›°é›£ãªçŠ¶æ³ã¨ã€ãã‚Œã§ã‚‚å¤¢ã‚’è«¦ã‚ãªã„å½¼ã‚‰ã®å§¿ã‚’ã€æ·±ãã€æ¿ƒãæããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼åºç« ã€‚
${charactersPrompt}
### æ§‹æˆæ¡ˆ
1.  **ã€å†’é ­ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‘**: ã€Œã€‡ã€‡ï¼ˆåœ°åï¼‰ã®ç©ºã®ä¸‹ã€ä»Šæ—¥ã‚‚å½¼ã‚‰ã®å£°ãŒéŸ¿ãã€‚${teamName === 'æµœæ¾ç‰¹æ”¯' ? 'â€”ãŸã¨ãˆã€ãã®å£°ãŒã¾ã ã€é‡çƒã¸ã®ææ€–ã«éœ‡ãˆã¦ã„ãŸã¨ã—ã¦ã‚‚ã€‚' : 'ã—ã‹ã—ã€ãã®å£°ã¯ã‚ã¾ã‚Šã«ã‚‚å°‘ãªã„ã€‚'}ã€ã¨ã„ã£ãŸã€ãƒãƒ¼ãƒ ã®çŠ¶æ³ã‚’è±¡å¾´ã™ã‚‹ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰å§‹ã‚ã‚‹ã€‚
2.  **ã€å½¼ã‚‰ã®"ç¾å®Ÿ"ã€‘**: ${teamSpecificInfo}
${handicapFocusPrompt}
${reactionPrompt}
${finalStepNumber}. **ã€æ±ºæ„è¡¨æ˜ã€‘**: æœ€å¾Œã«ã€ä¸»å°†ãŒã€Œ${finalPledge}ã€ã¨ã€å¤§ä¼šã¸å‘ã‹ã†æ±ºæ„ã‚’èªã‚Šã€ç· ã‚ããã‚‹ã€‚
### æå†™ã®ãƒã‚¤ãƒ³ãƒˆ
- **äº”æ„Ÿã‚’åˆºæ¿€ã™ã‚‹æå†™**: ç·´ç¿’é¢¨æ™¯ã§ã¯ã€åœŸã®åŒ‚ã„ã€å¤ã„é©ã®åŒ‚ã„ã€é‡‘å±ãƒãƒƒãƒˆã®ä¹¾ã„ãŸéŸ³ã€ç›£ç£ã®æ€’é³´ã‚Šå£°ãªã©ã€æƒ…æ™¯ãŒç›®ã«æµ®ã‹ã¶ã‚ˆã†ãªå…·ä½“çš„ãªæå†™ã‚’å¤šç”¨ã™ã‚‹ã“ã¨ã€‚
- **å¯¾æ¯”**: ã€Œä»–æ ¡ã®æµã¾ã‚ŒãŸç’°å¢ƒã€ã¨ã€Œå½¼ã‚‰ã®ç¾å®Ÿã€ã‚’å¯¾æ¯”ã•ã›ã‚‹ã“ã¨ã§ã€é€†å¢ƒã‚’éš›ç«‹ãŸã›ã‚‹ã“ã¨ã€‚
- **æ„Ÿæƒ…ã®æ©Ÿå¾®**: é¸æ‰‹ã®ã€Œæ‚”ã—ã•ã€ã€Œç„¦ã‚Šã€ã ã‘ã§ãªãã€ãã®ä¸­ã«ã‚ã‚‹ã€Œèª‡ã‚Šã€ã‚„ã€Œä»²é–“ã¨ã®çµ†ã€ã‚‚ä¸å¯§ã«æå†™ã™ã‚‹ã“ã¨ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆé•·ç·¨ã®è¨˜äº‹æœ¬æ–‡ï¼‰"}`;                break;
            case 'lose':
                title = `ã€${teamName}ã€é­‚ã®è¨˜éŒ²ã€æœ€çµ‚ç« `;
                prompt += `
### å–æãƒ†ãƒ¼ãƒ
ã€Œ${teamName}ã€ã®å¤ãŒçµ‚ã‚ã£ãŸã€‚å¤¢ç ´ã‚ŒãŸå½¼ã‚‰ã®å§¿ã¨ã€ãã‚Œã§ã‚‚ç¢ºã‹ã«æ®‹ã£ãŸã‚‚ã®ã‚’æããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼æœ€çµ‚ç« ã€‚
### å¯¾æˆ¦ç›¸æ‰‹ã€Œ${teamName}ã€ã®èƒŒæ™¯
${matchData.opponentInfo}
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹
${matchData.summary || 'ç‰¹ã«ãªã—'}
### ã“ã®è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${matchData.highlights}
### æ§‹æˆæ¡ˆ
1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹ã€Œè©¦åˆã®æ±ºã‚æ‰‹ã€ã«è§¦ã‚Œã€ã‚ã¨ä¸€æ­©åŠã°ãªã‹ã£ãŸå½¼ã‚‰ã®å¥®é—˜ã‚’ç§°ãˆã‚‹ã€‚
2.  å¯¾æˆ¦ç›¸æ‰‹ãŒã©ã®ã‚ˆã†ãªãƒãƒ¼ãƒ ã§ã‚ã£ãŸã‹ï¼ˆã€å¯¾æˆ¦ç›¸æ‰‹ã®èƒŒæ™¯ã€‘ã‚’å‚ç…§ï¼‰ã«è§¦ã‚Œã€ã€Œã‚ˆãã‚„ã£ãŸã€ã€Œæ‚”ã—ã„ã€ã¨ã„ã£ãŸæ„Ÿæƒ…ã‚’å¢—å¹…ã•ã›ã‚‹ã€‚
3.  è©¦åˆçµ‚äº†ã®ç¬é–“ã€æ³£ãå´©ã‚Œã‚‹ã‚‚ã€ã‚„ãŒã¦é¡”ã‚’ä¸Šã’ã€ç›¸æ‰‹ã«ã‚¨ãƒ¼ãƒ«ã‚’é€ã‚‹é¸æ‰‹ãŸã¡ã®å§¿ã‚’æå†™ã™ã‚‹ã€‚
4.  3å¹´ç”Ÿã®å¼•é€€ã¨ã€å½¼ã‚‰ã®æƒ³ã„ãŒå¾Œè¼©ãŸã¡ã¸ã¨å—ã‘ç¶™ãŒã‚Œã¦ã„ãã“ã¨ã‚’ç¤ºå”†ã—ã¦ã€ç‰©èªã‚’ç· ã‚ããã‚‹ã€‚
${finalFeedbackPrompt}
### å‡ºåŠ›å½¢å¼: JSON {"title": "${title}", "body": "ï¼ˆè¨˜äº‹æœ¬æ–‡ï¼‰"}`;
                break;
        }
    }
    
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (article) return { ...article, timestamp: Date.now() };
        }
        throw new Error("AI response format error.");
    } catch (error) {
        console.error("AI documentary article generation failed:", error);
        return null;
    }
}

// â–¼â–¼â–¼ ãƒãƒ¼ãƒ è¿½è·¡æ©Ÿèƒ½ç”¨ãƒ­ã‚¸ãƒƒã‚¯ (æ–°è¦è¿½åŠ ) â–¼â–¼â–¼

/**
 * ãƒãƒ¼ãƒ è¿½è·¡æ©Ÿèƒ½ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
 */
function setupTeamTracker() {
    const input = document.getElementById('tracker-input');
    const suggestions = document.getElementById('tracker-suggestions');
    const clearBtn = document.getElementById('tracker-clear-btn');
    
    if (!input || !suggestions) return;

    // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
    input.addEventListener('input', () => {
        const query = input.value.trim().toLowerCase();
        
        // æ¤œç´¢ã‚¯ã‚¨ãƒªãŒãªã„ã€ã¾ãŸã¯ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã¯éš ã™
        if (!query || document.getElementById('main-bracket-wrapper').classList.contains('hidden')) {
            suggestions.classList.remove('visible');
            clearBtn.classList.add('hidden');
            return;
        }
        
        clearBtn.classList.remove('hidden');

        // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨å†…ã«å­˜åœ¨ã™ã‚‹ãƒãƒ¼ãƒ ã®ã¿ã‚’æ¤œç´¢å¯¾è±¡ã«ã™ã‚‹
        // data-team-nameå±æ€§ã‚’æŒã¤è¦ç´ ã‚’æ¢ã™
        const teamElements = Array.from(document.querySelectorAll('#main-bracket-container .team-name'));
        const teamsInBracket = [...new Set(teamElements.map(el => el.dataset.teamName).filter(name => name && name !== '---' && name !== '(BYE)'))];

        const matches = teamsInBracket.filter(team => {
            const data = TEAM_DATA[team] || {};
            return (
                team.toLowerCase().includes(query) ||
                (data.name_yomi && data.name_yomi.includes(query))
            );
        }).slice(0, 8); // æœ€å¤§8ä»¶è¡¨ç¤º

        if (matches.length > 0) {
            suggestions.innerHTML = matches.map(team => `
                <li class="tracker-suggestion-item" data-team="${team}">
                    <span class="font-bold text-gray-800">${team}</span>
                    <span class="text-xs text-gray-400 ml-1">ã¸ã‚¸ãƒ£ãƒ³ãƒ— ğŸš€</span>
                </li>
            `).join('');
            suggestions.classList.add('visible');
        } else {
            suggestions.classList.remove('visible');
        }
    });

    // å€™è£œã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    suggestions.addEventListener('click', (e) => {
        const item = e.target.closest('.tracker-suggestion-item');
        if (item) {
            const teamName = item.dataset.team;
            jumpToTeamInBracket(teamName);
            input.value = teamName; // å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆ
            suggestions.classList.remove('visible');
        }
    });
    
    // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
    clearBtn.addEventListener('click', () => {
        input.value = '';
        suggestions.classList.remove('visible');
        clearBtn.classList.add('hidden');
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ¶ˆã™
        document.querySelectorAll('.tracker-highlight').forEach(el => el.classList.remove('tracker-highlight'));
    });

    // Enterã‚­ãƒ¼ã§ä¸€ç•ªä¸Šã®å€™è£œã¸ã‚¸ãƒ£ãƒ³ãƒ—
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const firstItem = suggestions.querySelector('.tracker-suggestion-item');
            if (firstItem) {
                firstItem.click();
                input.blur(); // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹
            }
        }
    });
}

/**
 * æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ãƒ ã®å ´æ‰€ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹
 */
function jumpToTeamInBracket(teamName) {
    // ä»¥å‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
    document.querySelectorAll('.tracker-highlight').forEach(el => el.classList.remove('tracker-highlight'));

    // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨å†…ã®è©²å½“ãƒãƒ¼ãƒ è¦ç´ ã‚’å…¨ã¦æ¢ã™
    const targets = Array.from(document.querySelectorAll(`#main-bracket-container .team-name[data-team-name="${teamName}"]`));
    
    if (targets.length === 0) {
        alert(`${teamName} ã¯ç¾åœ¨ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
        return;
    }

    // æœ€æ–°ã®è©¦åˆï¼ˆæœ€ã‚‚å³å´ã«ã‚ã‚‹è¦ç´ ï¼‰ã‚’å„ªå…ˆã—ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã™ã‚‹
    // bracket-half leftãªã‚‰å³ç«¯ã€rightãªã‚‰å·¦ç«¯ãŒæœ€æ–°ã ãŒã€
    // å˜ç´”ã«DOMé †ã§å¾Œã‚ã®æ–¹ï¼ˆå‹ã¡ä¸ŠãŒã‚Šå…ˆï¼‰ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã™ã‚‹ã®ãŒè‡ªç„¶
    const targetElement = targets[targets.length - 1].closest('.team-slot');

    if (targetElement) {
        // 1. ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« (ã‚¹ãƒ ãƒ¼ã‚ºã«ä¸­å¤®ã¸)
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
        
        // 2. ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¯ãƒ©ã‚¹ä»˜ä¸
        targetElement.classList.add('tracker-highlight');
        
        // 3. æ•°ç§’å¾Œã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ¶ˆã™
        setTimeout(() => {
            targetElement.classList.remove('tracker-highlight');
        }, 4000);
    }
}
// â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

/**
 * Sets the weather effect for the background.
 * @param {'none' | 'rain' | 'sun'} weatherType - The type of weather to display.
 */
function setWeather(weatherType) {
    const rainContainer = document.getElementById('rain-container');
    const sunContainer = document.getElementById('sun-container');

    // Hide all weather effects first
    rainContainer.classList.add('hidden');
    sunContainer.classList.add('hidden');
    rainContainer.innerHTML = ''; // Clear old raindrops

    if (weatherType === 'rain') {
        rainContainer.classList.remove('hidden');
        // Create 100 raindrops
        for (let i = 0; i < 100; i++) {
            const drop = document.createElement('div');
            drop.className = 'drop';
            drop.style.left = Math.random() * 100 + 'vw';
            drop.style.animationDelay = Math.random() * 0.5 + 's';
            drop.style.animationDuration = Math.random() * 0.2 + 0.3 + 's';
            rainContainer.appendChild(drop);
        }
    } else if (weatherType === 'sun') {
        sunContainer.classList.remove('hidden');
    }
}

/**
 * è©³ç´°å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã€ã¾ãŸã¯ãƒãƒ¼ãƒ åè‡ªä½“ã‚’å…¥ã‚Œæ›¿ãˆã‚‹
 * @param {string} matchId - å¯¾è±¡ã®è©¦åˆID
 */
function swapTeamDetails(matchId) {
    const match = findMatchById(matchId);
    if (!match) return;

    // 1. ãƒãƒ¼ãƒ åã¨ã€ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¹ã‚³ã‚¢ã‚’å…¥ã‚Œæ›¿ãˆã‚‹
    const tempTeam = match.team1;
    match.team1 = match.team2;
    match.team2 = tempTeam;

    const tempScore = match.score1;
    match.score1 = match.score2;
    match.score2 = tempScore;

    // 2. ã‚‚ã—è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›æ¸ˆã¿ãªã‚‰ã€ãã®ä¸­èº«ã‚‚å…¥ã‚Œæ›¿ãˆã‚‹
    if (match.details) {
        // æ‰“æ’ƒãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œæ›¿ãˆ
        const tempBatting = match.details.batting.team1;
        match.details.batting.team1 = match.details.batting.team2;
        match.details.batting.team2 = tempBatting;

        // æŠ•æ‰‹ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œæ›¿ãˆ
        const tempPitching = match.details.pitching.team1;
        match.details.pitching.team1 = match.details.pitching.team2;
        match.details.pitching.team2 = tempPitching;
        
        // ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ã‚’å…¥ã‚Œæ›¿ãˆ
        if (match.details.inningScore) {
            const tempInningScore = match.details.inningScore.team1;
            match.details.inningScore.team1 = match.details.inningScore.team2;
            match.details.inningScore.team2 = tempInningScore;
        }
    }

    // 3. å¤‰æ›´ã‚’ä¿å­˜ã—ã€ç”»é¢ã‚’æ›´æ–°ã™ã‚‹
    saveState();
    renderTournament(tournamentState); // ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚‚æ›´æ–°
    openDetailsModal(matchId); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†æç”»ã—ã¦å¤‰æ›´ã‚’åæ˜ 
}

/**
 * [æ–°æ©Ÿèƒ½] ãƒãƒ¼ãƒ ã®å…¨è©¦åˆã®ã‚¹ã‚¿ãƒ¡ãƒ³å±¥æ­´ã‚’HTMLã§ç”Ÿæˆã—ã€ã€Œè©¦åˆåˆ¥ã‚¹ã‚¿ãƒ¡ãƒ³ã€ã‚¿ãƒ–ã«è¡¨ç¤ºã™ã‚‹
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 */
function renderStartingLineupHistory(teamName) {
    const contentEl = document.getElementById('team-stats-tab-content-lineups');
    if (!contentEl) return;
    contentEl.innerHTML = '<div class="loader text-center py-16">ã‚¹ã‚¿ãƒ¡ãƒ³å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';

    const teamRecord = tournamentState.teamRecords[teamName];
    if (!teamRecord) {
        contentEl.innerHTML = '<p class="text-center text-red-500">ãƒãƒ¼ãƒ è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
    }

    // 1. å…¨è©¦åˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚­ãƒ£ãƒ³
    const allMatches = { 
        ...tournamentState.matches, 
        ...(tournamentState.autumnData?.allMatches || {}),
        ...(tournamentState.springData?.allMatches || {}) 
    };

    // 2. ãƒãƒ¼ãƒ ãŒé–¢ã‚ã‚Šã€ã‹ã¤è©³ç´°å…¥åŠ›(ã‚¹ã‚¿ãƒ¡ãƒ³)ãŒå­˜åœ¨ã™ã‚‹è©¦åˆã‚’åé›†
    const playedMatches = [];
    for (const matchId in allMatches) {
        const match = allMatches[matchId];
        
        const teamKey = match.team1 === teamName ? 'team1' : (match.team2 === teamName ? 'team2' : null);

        // æ¡ä»¶ï¼šãƒãƒ¼ãƒ ãŒé–¢ã‚ã£ã¦ã„ã‚‹ AND å‹è€…ãŒæ±ºã¾ã£ã¦ã„ã‚‹ AND è©³ç´°å…¥åŠ›ãŒã‚ã‚‹ AND æ‰“æ’ƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹
        if (teamKey && 
            match.winner && 
            match.details && 
            match.details.batting &&
            match.details.batting[teamKey] &&
            match.details.batting[teamKey].length > 0) 
        {
            // è©¦åˆIDã‹ã‚‰ãƒ©ã‚¦ãƒ³ãƒ‰ç•ªå·ã‚’ç°¡æ˜“çš„ã«æŠ½å‡º
            let roundSortKey = 0;
            if (matchId.includes('-R')) {
                // 'L-R1-M1' -> R1 -> 1
                roundSortKey = parseInt(matchId.split('-R')[1].split('-')[0]);
            }
            if (matchId.startsWith('F-')) {
                roundSortKey = 100; // æ±ºå‹ã¯æœ€å¾Œ
            }
            
            // TODO: å°†æ¥çš„ã«å¤§ä¼šãƒ»å¹´åº¦åˆ¥ã®ã‚½ãƒ¼ãƒˆã‚­ãƒ¼ã‚’è¿½åŠ ã™ã‚‹
            // ç¾çŠ¶ã¯ãƒ©ã‚¦ãƒ³ãƒ‰é †ã®ã¿ã§ã‚½ãƒ¼ãƒˆ
            playedMatches.push({ ...match, roundSortKey, teamKey });
        }
    }
    
    // ãƒ©ã‚¦ãƒ³ãƒ‰é †ã«ã‚½ãƒ¼ãƒˆ (1å›æˆ¦, 2å›æˆ¦...)
    playedMatches.sort((a, b) => a.roundSortKey - b.roundSortKey);

    if (playedMatches.length === 0) {
        contentEl.innerHTML = '<p class="text-center text-gray-500">è©³ç´°å…¥åŠ›ã•ã‚ŒãŸã‚¹ã‚¿ãƒ¡ãƒ³ã®å±¥æ­´ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
    }

    // 3. HTMLã‚’ç”Ÿæˆ (ç¾çŠ¶ã¯å¤§ä¼šåˆ¥ã§ã¯ãªãã€å…¨å±¥æ­´ã‚’ãƒ©ã‚¦ãƒ³ãƒ‰é †ã«è¡¨ç¤º)
    // TODO: å°†æ¥çš„ã« tournamentState.history ã‚’å‚ç…§ã—ã¦å¤§ä¼šåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹
    let html = `<div class="lineup-history-tournament">
        <h3 class="lineup-history-title">è©¦åˆåˆ¥ã‚¹ã‚¿ãƒ¡ãƒ³å±¥æ­´</h3>`;

    playedMatches.forEach(match => {
        const { teamKey, roundSortKey } = match;
        const opponentName = teamKey === 'team1' ? match.team2 : match.team1;
        const result = match.winner === teamName ? 'ã€‡' : 'â—';
        
        // ã‚¹ã‚³ã‚¢ã‚’æ­£ã—ãå–å¾—
        const scoreTeam = match[teamKey === 'team1' ? 'score1' : 'score2'];
        const scoreOpp = match[teamKey === 'team1' ? 'score2' : 'score1'];
        
        const roundName = getRoundNameFromMatchId(match.id);
        
        // ã‚¹ã‚¿ãƒ¡ãƒ³ã‚’æŠ½å‡º
        const battingData = match.details.batting[teamKey] || [];
        const starters = battingData
            .filter(p => p.order && !p.order.toString().includes('sub') && parseInt(p.order) >= 1 && parseInt(p.order) <= 9)
            .sort((a, b) => parseInt(a.order) - parseInt(b.order)); // æ‰“é †(1-9)ã§ã‚½ãƒ¼ãƒˆ

        if (starters.length > 0) {
            html += `
                <div class="lineup-history-match">
                    <h4 class="lineup-history-match-header">${roundName} vs ${opponentName} (${result} ${scoreTeam}-${scoreOpp})</h4>
                    <ul class="lineup-history-list">
                        ${starters.map(p => `<li>${p.order}. [${p.currentPos || p.pos || '?'}] ${p.name}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
    });

    html += `</div>`;
    contentEl.innerHTML = html;
}

// â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚’ã¾ã‚‹ã”ã¨ã€Œæ–°è¦è¿½åŠ ã€(10673è¡Œç›®ã‚ãŸã‚Šã€renderTeamStatsModal ã®ç›´å‰) â–¼â–¼â–¼

/**
 * [NEW] å€‹äººã®é€šç®—æˆç¸¾ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸­èº«ã‚’ç”Ÿæˆãƒ»è¡¨ç¤ºã™ã‚‹
 * (â˜…ã€ŒReferenceError: renderCareerStatsModal is not definedã€ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£)
 * @param {string} playerName - é¸æ‰‹å
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 */
function renderCareerStatsModal(playerName, teamName) {
    const modalBody = document.getElementById('player-stats-modal-body');
    if (!modalBody) {
        console.error("Fatal: player-stats-modal-body element not found.");
        return;
    }
    
    modalBody.innerHTML = ''; // Clear previous content
    
    const teamRecord = tournamentState.teamRecords[teamName];
    if (!teamRecord || !teamRecord.playerStats) {
        modalBody.innerHTML = `<p class="text-red-500 text-center">ã‚¨ãƒ©ãƒ¼: ${teamName} ã®ãƒãƒ¼ãƒ è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>`;
        return;
    }

    const bStats = teamRecord.playerStats.batting?.[playerName];
    const pStats = teamRecord.playerStats.pitching?.[playerName];

    if (!bStats && !pStats) {
        modalBody.innerHTML = `<p class="text-gray-500 text-center">${playerName}é¸æ‰‹ã®é€šç®—æˆç¸¾ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
        return;
    }

    let html = `
        <div class="player-stats-header">
            <h4 class="player-stats-name">${playerName}</h4>
            <p class="player-stats-team">${teamName}</p>
        </div>
    `;

    // --- 1. æ‰“æ’ƒæˆç¸¾ã®è¡¨ç¤º ---
    if (bStats && bStats.pa > 0) {
        // å¿…è¦ãªè¨ˆç®— (renderTeamStatsModalã‹ã‚‰æ‹å€Ÿ)
        const { games = 0, pa = 0, ab = 0, h = 0, hr = 0, rbi = 0, sb = 0, bb = 0, hbp = 0, sf = 0, tb = 0 } = bStats;
        const avg = (ab > 0) ? (h / ab).toFixed(3) : ".000";
        const obp_numerator = h + bb + hbp;
        const obp_denominator = ab + bb + hbp + sf;
        const obp = (obp_denominator > 0) ? (obp_numerator / obp_denominator).toFixed(3) : ".000";
        const slg = (ab > 0) ? (tb / ab).toFixed(3) : ".000";
        const ops = (parseFloat(obp) + parseFloat(slg)).toFixed(3);

        html += `
            <div>
                <h5 class="stats-section-title">é€šç®—æ‰“æ’ƒæˆç¸¾</h5>
                <div class="stats-grid">
                    <div class="stats-grid-item highlight">
                        <span class="stats-label">æ‰“ç‡</span>
                        <span class="stats-value">${avg}</span>
                    </div>
                    <div class="stats-grid-item highlight">
                        <span class="stats-label">OPS</span>
                        <span class="stats-value">${ops}</span>
                    </div>
                    <div class="stats-grid-item">
                        <span class="stats-label">æœ¬å¡æ‰“</span>
                        <span class="stats-value">${hr}</span>
                    </div>
                    <div class="stats-grid-item">
                        <span class="stats-label">æ‰“ç‚¹</span>
                        <span class="stats-value">${rbi}</span>
                    </div>
                    <div class="stats-grid-item">
                        <span class="stats-label">è©¦åˆ</span>
                        <span class="stats-value">${games}</span>
                    </div>
                    <div class="stats-grid-item">
                        <span class="stats-label">æ‰“æ•°</span>
                        <span class="stats-value">${ab}</span>
                    </div>
                    <div class="stats-grid-item">
                        <span class="stats-label">å®‰æ‰“</span>
                        <span class="stats-value">${h}</span>
                    </div>
                    <div class="stats-grid-item">
                        <span class="stats-label">ç›—å¡</span>
                        <span class="stats-value">${sb}</span>
                    </div>
                </div>
                <div class="stats-grid mt-2 grid-cols-5">
                    <div class="stats-grid-item"><span class="stats-label">æ‰“å¸­</span><span class="stats-value text-xl">${pa}</span></div>
                    <div class="stats-grid-item"><span class="stats-label">å››çƒ</span><span class="stats-value text-xl">${bb}</span></div>
                    <div class="stats-grid-item"><span class="stats-label">æ­»çƒ</span><span class="stats-value text-xl">${hbp}</span></div>
                    <div class="stats-grid-item"><span class="stats-label">å‡ºå¡ç‡</span><span class="stats-value text-xl">${obp}</span></div>
                    <div class="stats-grid-item"><span class="stats-label">é•·æ‰“ç‡</span><span class="stats-value text-xl">${slg}</span></div>
                </div>
            </div>
        `;
    }

    // --- 2. æŠ•æ‰‹æˆç¸¾ã®è¡¨ç¤º ---
    if (pStats && pStats.career && pStats.career.ip > 0) {
        const career = pStats.career;
        const { games = 0, w = 0, l = 0, ip = 0, so = 0, er = 0, h = 0, bb = 0 } = career;
        const era_val = (ip > 0) ? ((er * 9) / ip) : Infinity;
        const whip_val = (ip > 0) ? ((bb + h) / ip) : Infinity;
        const k9_val = (ip > 0) ? ((so * 9) / ip) : 0;
        
        const era = (era_val === Infinity) ? "----" : era_val.toFixed(2);
        const whip = (whip_val === Infinity) ? "----" : whip_val.toFixed(2);
        const k9 = k9_val.toFixed(2);

        html += `
            <div>
                <h5 class="stats-section-title">é€šç®—æŠ•æ‰‹æˆç¸¾</h5>
                <div class="stats-grid">
                    <div class="stats-grid-item highlight">
                        <span class="stats-label">é˜²å¾¡ç‡</span>
                        <span class="stats-value">${era}</span>
                    </div>
                    <div class="stats-grid-item highlight">
                        <span class="stats-label">WHIP</span>
                        <span class="stats-value">${whip}</span>
                    </div>
                    <div class="stats-grid-item">
                        <span class="stats-label">å‹åˆ©</span>
                        <span class="stats-value">${w}</span>
                    </div>
                    <div class="stats-grid-item">
                        <span class="stats-label">æ•—åŒ—</span>
                        <span class="stats-value">${l}</span>
                    </div>
                    <div class="stats-grid-item">
                        <span class="stats-label">ç™»æ¿</span>
                        <span class="stats-value">${games}</span>
                    </div>
                    <div class="stats-grid-item">
                        <span class="stats-label">æŠ•çƒå›</span>
                        <span class="stats-value">${ip.toFixed(1)}</span>
                    </div>
                    <div class="stats-grid-item">
                        <span class="stats-label">å¥ªä¸‰æŒ¯</span>
                        <span class="stats-value">${so}</span>
                    </div>
                    <div class="stats-grid-item">
                        <span class="stats-label">K/9</span>
                        <span class="stats-value">${k9}</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    // --- 3. è©¦åˆå±¥æ­´ (Gamelogs) ã®è¡¨ç¤º ---
    const allGamelogs = [
        ...(bStats?.gamelogs || []).map(log => ({ ...log, type: 'batting' })),
        ...(pStats?.gamelogs || []).map(log => ({ ...log, type: 'pitching' }))
    ].sort((a, b) => (parseDate(a.date) || 0) - (parseDate(b.date) || 0)); // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ

    if (allGamelogs.length > 0) {
        html += `
            <div>
                <h5 class="stats-section-title">ä»Šå¤§ä¼š è©¦åˆåˆ¥æˆç¸¾</h5>
                <div class="space-y-2 text-sm">
        `;
        
        // Gamelogã‚’è©¦åˆIDã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const gamesGrouped = allGamelogs.reduce((acc, log) => {
            if (!acc[log.matchId]) {
                acc[log.matchId] = {
                    round: log.round,
                    opponent: log.opponent,
                    opponentRank: log.opponentRank,
                    batting: null,
                    pitching: null
                };
            }
            if (log.type === 'batting') acc[log.matchId].batting = log.stats;
            if (log.type === 'pitching') acc[log.matchId].pitching = log;
            return acc;
        }, {});

        Object.values(gamesGrouped).reverse().forEach(game => { // æ–°ã—ã„è©¦åˆã‹ã‚‰è¡¨ç¤º
            let statsLine = '';
            if (game.batting) {
                const b = game.batting;
                statsLine += `æ‰“: ${b.ab}-${b.h} ${b.hr}HR ${b.rbi}ç‚¹ ${b.sb}ç›—`;
            }
            if (game.pitching) {
                const p = game.pitching;
                const resultMark = {'W': 'â—‹', 'L': 'â—', 'S': 'ï¼³', 'H': 'ï¼¨'}[p.result] || '';
                statsLine += (statsLine ? ' / ' : '') + `æŠ•: ${resultMark}${p.ip}å› ${p.so}K ${p.r}å¤±(è‡ª${p.er})`;
            }
            
            html += `
                <div class="p-2 border rounded bg-gray-50">
                    <span class="font-semibold">${game.round} vs ${game.opponent} [${game.opponentRank}]</span>
                    <span class="block text-gray-700">${statsLine}</span>
                </div>
            `;
        });

        html += `</div></div>`;
    }

    modalBody.innerHTML = html;
}

// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: parseDate (gamelogã‚½ãƒ¼ãƒˆç”¨)
const parseDate = (dateStr) => {
    if (!dateStr || !dateStr.includes('/')) return null;
    const [month, day] = dateStr.split('/').map(Number);
    // å¹´ã¯ç¾åœ¨ã®å¤§ä¼šå¹´åº¦ã‚’ä»®å®š (æœˆãŒ1-3æœˆã®å ´åˆã¯ç¿Œå¹´æ‰±ã„)
    const year = (tournamentState?.tournamentYear || new Date().getFullYear()) + (month <= 3 ? 1 : 0);
    return new Date(year, month - 1, day);
};
// â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²


// â–¼â–¼â–¼ æ—¢å­˜ã®ã€ŒrenderTeamStatsModalã€é–¢æ•° (10675è¡Œç›®ã‚ãŸã‚Š) ã‚’ã€ä»¥ä¸‹ã§ã€Œç½®ãæ›ãˆã€ â–¼â–¼â–¼

/**
 * ãƒãƒ¼ãƒ å…¨å“¡ã®é€šç®—æˆç¸¾ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸­èº«ã‚’ç”Ÿæˆãƒ»è¡¨ç¤ºã™ã‚‹
 * (â˜…ã€Œè¦å®šæ‰“å¸­ã€ã‚½ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã‚’ è©¦åˆæ•°*3 ã«å¤‰æ›´ã€æŠ•æ‰‹ã®è¦å®šã‚’æ’¤å»ƒâ˜…)
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 */
function renderTeamStatsModal(teamName) {
    const modal = document.getElementById('team-stats-modal');
    const modalTitle = document.getElementById('team-stats-modal-title');
    
    const teamRecord = tournamentState.teamRecords[teamName];

    modalTitle.textContent = `${teamName} é€šç®—æˆç¸¾`;
    
    const statsContentEl = document.getElementById('team-stats-tab-content-stats');

    if (!teamRecord || !teamRecord.playerStats) {
        statsContentEl.innerHTML = '<p class="text-center text-red-500">é¸æ‰‹ã®æˆç¸¾ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
    }

    // --- 0. ç¾åœ¨ã®ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°é¸æ‰‹åã§æ˜‡é †ï¼‰ ---
    const sortState = {
        batting: {
            key: modal.dataset.sortKeyBatting || 'name',
            dir: modal.dataset.sortDirBatting || 'asc'
        },
        pitching: {
            key: modal.dataset.sortKeyPitching || 'name',
            dir: modal.dataset.sortDirPitching || 'asc'
        }
    };
    
    // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼šã‚½ãƒ¼ãƒˆç”¨ã®çŸ¢å°(â–²â–¼)ã‚¯ãƒ©ã‚¹ã‚’ç”Ÿæˆ ---
    const getSortClass = (tableType, key) => {
        const state = sortState[tableType];
        if (state.key !== key) return '';
        return state.dir === 'asc' ? 'sort-asc' : 'sort-desc';
    };

    const { batting, pitching } = teamRecord.playerStats;
    let battingHtml = '';
    let pitchingHtml = '';

    // --- 1. æ‰“æ’ƒæˆç¸¾ã®è¨ˆç®—ã¨è¡¨ç¤º (â˜…ã‚½ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£) ---
    if (batting && Object.keys(batting).length > 0) {
        const battingArray = Object.keys(batting).map(playerName => {
            const stats = batting[playerName];
            const { games = 0, pa = 0, ab = 0, h = 0, hr = 0, rbi = 0, sb = 0, bb = 0, hbp = 0, sf = 0, tb = 0 } = stats;
            const avg = (ab > 0) ? (h / ab) : 0;
            const obp_numerator = h + bb + hbp;
            const obp_denominator = ab + bb + hbp + sf;
            const obp = (obp_denominator > 0) ? (obp_numerator / obp_denominator) : 0;
            const slg = (ab > 0) ? (tb / ab) : 0;
            const ops = obp + slg;
            return { name: playerName, ...stats, avg, obp, slg, ops };
        }).filter(p => p.pa > 0 || p.games > 0); // â˜…æ‰“å¸­0ã§ã‚‚è©¦åˆå‡ºå ´(games > 0)ãªã‚‰è¡¨ç¤º

        // --- â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜… ---
        const sortKey = sortState.batting.key;
        const sortDir = sortState.batting.dir === 'asc' ? 1 : -1;
        
        // â˜… ãƒãƒ¼ãƒ ã®ç·è©¦åˆæ•°ã‚’è¨ˆç®— (å‡ºå ´é¸æ‰‹ã®ä¸­ã§æœ€å¤§ã®è©¦åˆæ•°)
        // (ä»Šå¤§ä¼šã®è©¦åˆæ•°ã§ã¯ãªãã€å…¨å±¥æ­´ã®è©¦åˆæ•°ã‚’å‚ç…§)
        const totalGamesPlayed = Math.max(...battingArray.map(p => p.games || 0));
        // â˜… è¦å®šæ‰“å¸­ã‚’ã€Œè©¦åˆæ•° * 3ã€ã«è¨­å®š
        const MINIMUM_PA_FOR_RANKING = totalGamesPlayed * 3;
        
        // è¦å®šæ‰“å¸­ã®å¯¾è±¡ã¨ãªã‚‹ç‡ç³»ã®ã‚¹ã‚¿ãƒƒãƒ„ã‹ï¼Ÿ
        const isRankedStat = ['avg', 'obp', 'slg', 'ops'].includes(sortKey);

        battingArray.sort((a, b) => {
            let valA = a[sortKey], valB = b[sortKey];
            const paA = a.pa || 0;
            const paB = b.pa || 0;

            // 1. ç‡ç³»ã®ã‚¹ã‚¿ãƒƒãƒ„ã§ã‚½ãƒ¼ãƒˆã™ã‚‹å ´åˆ
            if (isRankedStat) {
                // â˜… è¦å®šæ‰“å¸­ã®ã—ãã„å€¤ã‚’ MINIMUM_PA_FOR_RANKING ã«å¤‰æ›´
                const aQualified = paA >= MINIMUM_PA_FOR_RANKING;
                const bQualified = paB >= MINIMUM_PA_FOR_RANKING;

                // ä¸¡æ–¹è¦å®šæ‰“å¸­æœªæº€ãªã‚‰ã€æ‰“å¸­æ•°ã®å¤šã„é †
                if (!aQualified && !bQualified) {
                    return (paB - paA); 
                }
                // Aã ã‘è¦å®šæ‰“å¸­æœªæº€ãªã‚‰ã€Aã‚’ã€Œä¸‹ã€ã«ã™ã‚‹
                if (!aQualified) {
                    return 1; // 1ã‚’è¿”ã™ã¨bãŒå…ˆ(aãŒå¾Œ)ã«ãªã‚‹
                }
                // Bã ã‘è¦å®šæ‰“å¸­æœªæº€ãªã‚‰ã€Bã‚’ã€Œä¸‹ã€ã«ã™ã‚‹
                if (!bQualified) {
                    return -1; // -1ã‚’è¿”ã™ã¨aãŒå…ˆ(bãŒå¾Œ)ã«ãªã‚‹
                }
                // ä¸¡æ–¹è¦å®šæ‰“å¸­ä»¥ä¸Šãªã‚‰ã€é€šå¸¸ã®ã‚½ãƒ¼ãƒˆã¸é€²ã‚€
            }

            // --- 2. é€šå¸¸ã®ã‚½ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯ ---
            if (sortKey === 'name') return valA.localeCompare(valB, 'ja') * sortDir;
            if (valA === undefined || valA === null) valA = 0;
            if (valB === undefined || valB === null) valB = 0;
            return (valA - valB) * sortDir;
        });
        // --- â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜… ---

        battingHtml = `
            <div>
                <h4 class="stats-section-title">é€šç®—æ‰“æ’ƒæˆç¸¾ (è¦å®šæ‰“å¸­: ${MINIMUM_PA_FOR_RANKING})</h4>
                <div class="overflow-x-auto">
                    <table class="career-stats-table" id="batting-stats-table">
                        <thead>
                            <tr>
                                <th class="player-name sortable-header ${getSortClass('batting', 'name')}" data-sort-key="name" data-table-type="batting">é¸æ‰‹å<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('batting', 'games')}" data-sort-key="games" data-table-type="batting">è©¦<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('batting', 'avg')}" data-sort-key="avg" data-table-type="batting">æ‰“ç‡<span class="sort-arrow"></span></th>
                                <th class="stat-highlight sortable-header ${getSortClass('batting', 'ops')}" data-sort-key="ops" data-table-type="batting">OPS<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('batting', 'pa')}" data-sort-key="pa" data-table-type="batting">æ‰“å¸­<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('batting', 'ab')}" data-sort-key="ab" data-table-type="batting">æ‰“æ•°<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('batting', 'h')}" data-sort-key="h" data-table-type="batting">å®‰æ‰“<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('batting', 'hr')}" data-sort-key="hr" data-table-type="batting">æœ¬<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('batting', 'rbi')}" data-sort-key="rbi" data-table-type="batting">ç‚¹<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('batting', 'sb')}" data-sort-key="sb" data-table-type="batting">ç›—<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('batting', 'bb')}" data-sort-key="bb" data-table-type="batting">å››<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('batting', 'hbp')}" data-sort-key="hbp" data-table-type="batting">æ­»<span class="sort-arrow"></span></th>
                                <th class="stat-highlight sortable-header ${getSortClass('batting', 'obp')}" data-sort-key="obp" data-table-type="batting">å‡ºå¡ç‡<span class="sort-arrow"></span></th>
                                <th class="stat-highlight sortable-header ${getSortClass('batting', 'slg')}" data-sort-key="slg" data-table-type="batting">é•·æ‰“ç‡<span class="sort-arrow"></span></th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        battingArray.forEach(stats => {
            const isQualified = stats.pa >= MINIMUM_PA_FOR_RANKING;
            const rateClass = isQualified ? 'stat-highlight' : 'text-gray-400';

            // â˜…â˜…â˜… ä¿®æ­£: ${stats.hbp} -> ${stats.hbp || 0} ã«å¤‰æ›´ â˜…â˜…â˜…
            battingHtml += `
                <tr>
                    <td class="player-name">${stats.name}</td>
                    <td>${stats.games}</td><td class="${rateClass}">${stats.avg.toFixed(3)}</td><td class="${rateClass}">${stats.ops.toFixed(3)}</td>
                    <td>${stats.pa}</td><td>${stats.ab}</td><td>${stats.h}</td><td>${stats.hr}</td>
                    <td>${stats.rbi}</td><td>${stats.sb}</td><td>${stats.bb}</td><td>${stats.hbp || 0}</td>
                    <td class="${rateClass}">${stats.obp.toFixed(3)}</td><td class="${rateClass}">${stats.slg.toFixed(3)}</td>
                </tr>
            `;
        });
        battingHtml += `</tbody></table></div></div>`;
    } else {
        battingHtml = `<div><h4 class="stats-section-title">é€šç®—æ‰“æ’ƒæˆç¸¾</h4><p class="text-sm text-gray-500">ï¼ˆé€šç®—æ‰“æ’ƒæˆç¸¾ãªã—ï¼‰</p></div>`;
    }

    // --- 2. æŠ•æ‰‹æˆç¸¾ã®è¨ˆç®—ã¨è¡¨ç¤º (â˜…è¦å®šæŠ•çƒå›ãƒ­ã‚¸ãƒƒã‚¯å‰Šé™¤) ---
    if (pitching && Object.keys(pitching).length > 0) {
        
        // 2a. ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›ã—ã€è¨ˆç®—å€¤ã‚’ä»˜ä¸
        const pitchingArray = Object.keys(pitching).map(playerName => {
            const pStats = pitching[playerName];
            const stats = pStats.career; // é€šç®—æˆç¸¾
            if (!stats) return null;
            
            const { games = 0, w = 0, l = 0, ip = 0, so = 0, er = 0, h = 0, bb = 0 } = stats;
            const era = (ip > 0) ? ((er * 9) / ip) : Infinity; 
            const whip = (ip > 0) ? ((bb + h) / ip) : Infinity; 
            const k9 = (ip > 0) ? ((so * 9) / ip) : 0; 

            return { name: playerName, ...stats, era, whip, k9, gamelogs: pStats.gamelogs || [] };
        }).filter(p => p && (p.ip > 0 || p.games > 0)); // â˜… games > 0 (ç™»æ¿ã®ã¿) ã‚‚è¨±å¯
        
        // 2b. é…åˆ—ã‚’ã‚½ãƒ¼ãƒˆ
        const sortKey = sortState.pitching.key;
        const sortDir = sortState.pitching.dir === 'asc' ? 1 : -1;
        
        // â˜… è¦å®šæŠ•çƒå›ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã€Œã¾ã‚‹ã”ã¨å‰Šé™¤ã€
        const isPitchingRankedStat = ['era', 'whip', 'k9'].includes(sortKey);

        pitchingArray.sort((a, b) => {
            let valA = a[sortKey], valB = b[sortKey];
            const ipA = a.ip || 0;
            const ipB = b.ip || 0;

            // â˜… è¦å®šæŠ•çƒå›ã® `if (isPitchingRankedStat)` ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã€Œã¾ã‚‹ã”ã¨å‰Šé™¤ã€

            // ç„¡é™å¤§(Infinity)ã®ERAã‚’ã‚½ãƒ¼ãƒˆã®ãŸã‚ã«å¤§ããªæ•°å€¤ã«å¤‰æ›
            if (isPitchingRankedStat) {
                if (valA === Infinity) valA = 999.99;
                if (valB === Infinity) valB = 999.99;
            }

            if (sortKey === 'name') return valA.localeCompare(valB, 'ja') * sortDir;
            if (valA === Infinity) valA = 999.99; 
            if (valB === Infinity) valB = 999.99;
            if (valA === undefined || valA === null) valA = 0;
            if (valB === undefined || valB === null) valB = 0;
            return (valA - valB) * sortDir;
        });

        // 2c. HTMLã‚’ç”Ÿæˆ
        pitchingHtml = `
            <div class="mt-6">
                <h4 class="stats-section-title">é€šç®—æŠ•æ‰‹æˆç¸¾</h4>
                <div class="overflow-x-auto">
                    <table class="career-stats-table" id="pitching-stats-table">
                        <thead>
                            <tr>
                                <th class="player-name sortable-header ${getSortClass('pitching', 'name')}" data-sort-key="name" data-table-type="pitching">é¸æ‰‹å<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('pitching', 'games')}" data-sort-key="games" data-table-type="pitching">ç™»<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('pitching', 'w')}" data-sort-key="w" data-table-type="pitching">å‹<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('pitching', 'l')}" data-sort-key="l" data-table-type="pitching">æ•—<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('pitching', 'ip')}" data-sort-key="ip" data-table-type="pitching">å›<span class="sort-arrow"></span></th>
                                <th class="stat-highlight sortable-header ${getSortClass('pitching', 'era')}" data-sort-key="era" data-table-type="pitching">é˜²å¾¡ç‡<span class="sort-arrow"></span></th>
                                <th class="stat-highlight sortable-header ${getSortClass('pitching', 'whip')}" data-sort-key="whip" data-table-type="pitching">WHIP<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('pitching', 'so')}" data-sort-key="so" data-table-type="pitching">æŒ¯<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('pitching', 'h')}" data-sort-key="h" data-table-type="pitching">è¢«å®‰<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('pitching', 'bb')}" data-sort-key="bb" data-table-type="pitching">ä¸å››<span class="sort-arrow"></span></th>
                                <th class="sortable-header ${getSortClass('pitching', 'er')}" data-sort-key="er" data-table-type="pitching">è‡ªè²¬<span class="sort-arrow"></span></th>
                                <th class="stat-highlight sortable-header ${getSortClass('pitching', 'k9')}" data-sort-key="k9" data-table-type="pitching">K/9<span class="sort-arrow"></span></th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        pitchingArray.forEach(stats => {
            // â˜… è¦å®šæŠ•çƒå›ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤
            const rateClass = 'stat-highlight'; // â˜… å¸¸ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            
            const gamelogHtml = stats.gamelogs.length > 0 
                ? stats.gamelogs.map(log => `(${log.round} vs ${log.opponent}: ${log.ip}å› ${log.r}å¤±ç‚¹)`).join(', ')
                : 'ç™»æ¿å±¥æ­´ãªã—';
                
            pitchingHtml += `
                <tr>
                    <td class="player-name">${stats.name}</td>
                    <td>${stats.games}</td><td>${stats.w}</td><td>${stats.l}</td>
                    <td>${stats.ip.toFixed(1)}</td><td class="${rateClass}">${stats.era === 999.99 ? '----' : stats.era.toFixed(2)}</td>
                    <td class="${rateClass}">${stats.whip === 999.99 ? '----' : stats.whip.toFixed(2)}</td>
                    <td>${stats.so}</td><td>${stats.h}</td><td>${stats.bb}</td><td>${stats.er}</td>
                    <td class="${rateClass}">${stats.k9.toFixed(2)}</td>
                </tr>
                <tr class="bg-gray-50">
                    <td colspan="12" class="text-left text-xs text-gray-600 p-2" style="white-space: normal;">
                        <strong>ç™»æ¿å±¥æ­´:</strong> ${gamelogHtml}
                    </td>
                </tr>
            `;
        });
        pitchingHtml += `</tbody></table></div></div>`;
    } else {
        pitchingHtml = `<div class="mt-6"><h4 class="stats-section-title">é€šç®—æŠ•æ‰‹æˆç¸¾</h4><p class="text-sm text-gray-500">ï¼ˆé€šç®—æŠ•æ‰‹æˆç¸¾ãªã—ï¼‰</p></div>`;
    }

    statsContentEl.innerHTML = battingHtml + pitchingHtml;
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²


/**
 * ãƒãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
 * (â˜…ã€Œä»Šå¤§ä¼šæˆç¸¾ã€æ¬„ã«ãƒãƒ¼ãƒ é˜²å¾¡ç‡ã‚’è¿½åŠ ã—ãŸä¿®æ­£ç‰ˆ)
 * @param {string} teamName - ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒãƒ¼ãƒ å
 */
function showTeamStatusModal(teamName) {
    // â–¼â–¼â–¼ è¡¨ç¤ºå‰ã«éå»æˆç¸¾ã‚’ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ« (CPUãƒãƒ¼ãƒ ç”¨) â–¼â–¼â–¼
    backfillCpuStats(teamName);
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    const teamRecord = tournamentState.teamRecords[teamName];
    if (!teamRecord) return;

    // --- 1. ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã®å–å¾— ---
    const modal = document.getElementById('team-status-modal');
    const bestEl = document.getElementById('status-modal-best');
    const historyEl = document.getElementById('status-modal-history');
    const traitsEl = document.getElementById('status-modal-traits');
    const coachEl = document.getElementById('status-modal-coach'); 
    const homepageLinkContainer = document.getElementById('status-modal-homepage-link-container');
    const homepageLink = document.getElementById('status-modal-homepage-link');
    
    // ãƒ†ã‚­ã‚¹ãƒˆæˆç¸¾ç”¨ã®Pã‚¿ã‚°
    const statsEl = document.getElementById('status-modal-team-stats');
    const careerStatsEl = document.getElementById('status-modal-career-stats'); 

    // â˜… æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Œã°å‰Šé™¤ï¼ˆå†æç”»ã®ãŸã‚ï¼‰
    const existingChart = Chart.getChart('team-radar-chart');
    if (existingChart) {
        existingChart.destroy();
    }

    // --- 2. ãƒãƒ¼ãƒ åŸºæœ¬æƒ…å ±ã®è¡¨ç¤º ---
    document.getElementById('status-modal-team-name').textContent = teamName;
    
    if (homepageLink) {
        homepageLink.removeAttribute('href');
        homepageLink.removeAttribute('target');
        homepageLink.style.cursor = 'pointer';
    }
    bestEl.textContent = teamRecord.best ? formatRecordToString(teamRecord.best) : 'ã¾ã ã‚ã‚Šã¾ã›ã‚“';
    historyEl.innerHTML = '';
    if (teamRecord.history && teamRecord.history.length > 0) {
        teamRecord.history.slice(0, 2).forEach(rec => {
            const p = document.createElement('p');
            p.textContent = formatRecordToString(rec);
            historyEl.appendChild(p);
        });
    } else {
        historyEl.innerHTML = '<p>ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';
    }
    traitsEl.innerHTML = '';
    if (teamRecord.teamTraits && teamRecord.teamTraits.length > 0) {
        teamRecord.teamTraits.forEach(traitId => {
            const trait = TITLES[traitId];
            if (trait) {
                const span = document.createElement('span');
                span.className = 'bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full';
                span.textContent = trait.name;
                traitsEl.appendChild(span);
            }
        });
    } else {
        traitsEl.innerHTML = '<p class="text-gray-500 text-sm">ãªã—</p>';
    }
    const teamMasterData = TEAM_DATA[teamName];
    if (teamMasterData && teamMasterData.coach) {
        coachEl.textContent = `${teamMasterData.coach.name} (${teamMasterData.coach.experience} / ${teamMasterData.coach.style})`;
    } else {
        coachEl.textContent = 'æƒ…å ±ãªã—';
    }
// â˜…â˜…â˜… ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â˜…â˜…â˜…
    // â–¼â–¼â–¼ è¿½åŠ : ã‚­ãƒ£ãƒ—ãƒ†ãƒ³åã®è¡¨ç¤º â–¼â–¼â–¼
    // ãƒ­ã‚¹ã‚¿ãƒ¼æƒ…å ±ã‹ã‚‰ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ã‚’æ¢ã™
    let captainDisplay = "ä¸æ˜";
    if (teamRecord.roster) {
        const captain = teamRecord.roster.find(p => p.isCaptain);
        if (captain) captainDisplay = captain.name;
    } else if (TEAM_ROSTER_MASTER[teamName]) {
        // ã¾ã è©¦åˆã‚’ã—ã¦ã„ãªã„ãŒãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
        const masterCap = TEAM_ROSTER_MASTER[teamName].find(p => p.isCaptain);
        if (masterCap) captainDisplay = masterCap.name;
    }

    // ç›£ç£è¡¨ç¤ºã®ä¸‹ã‚ãŸã‚Šã«è¿½åŠ 
    if (coachEl) {
        // æ—¢å­˜ã®ç›£ç£è¡¨ç¤ºã«ç¶šã‘ã¦ä¸»å°†ã‚‚è¡¨ç¤º
        coachEl.innerHTML += `<br><span class="text-sm font-normal text-gray-600">ä¸»å°†: </span><span class="font-bold text-gray-800">${captainDisplay}</span>`;
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
    // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    if (homepageLinkContainer && homepageLink) {
        if (teamName === "283å­¦åœ’") {
            homepageLink.setAttribute('data-target', 'homepage-modal'); 
            homepageLinkContainer.classList.remove('hidden');
        } else {
            homepageLinkContainer.classList.add('hidden'); 
        }
    }

    // --- â˜…â˜…â˜… ä»Šå¤§ä¼šã®ã€Œãƒãƒ¼ãƒ é˜²å¾¡ç‡ã€ã‚’è¨ˆç®— â˜…â˜…â˜… ---
    let tourneyIP = 0;
    let tourneyER = 0;
    const currentTournamentKey = tournamentState.currentTournament;

    if (teamRecord.playerStats && teamRecord.playerStats.pitching) {
        Object.values(teamRecord.playerStats.pitching).forEach(p => {
            if (p.gamelogs) {
                p.gamelogs.forEach(log => {
                    // ãƒ­ã‚°ãŒã€Œç¾åœ¨ã®å¤§ä¼šã€ã®ã‚‚ã®ã‹åˆ¤å®š
                    const logRound = log.round || '';
                    let isCurrent = false;
                    if (currentTournamentKey === 'summer') isCurrent = logRound.includes('å›æˆ¦') || logRound.includes('æ±ºå‹');
                    else if (currentTournamentKey === 'summer_koshien') isCurrent = true; // ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰
                    else if (currentTournamentKey === 'autumn') isCurrent = logRound.includes('åœ°åŒº') || logRound.includes('å›æˆ¦') || logRound.includes('æ±ºå‹');
                    else if (currentTournamentKey === 'spring') isCurrent = logRound.includes('åœ°åŒº') || logRound.includes('å›æˆ¦') || logRound.includes('æ±ºå‹');
                    
                    if (isCurrent) {
                        tourneyIP += parseFloat(log.ip || 0);
                        tourneyER += parseInt(log.er || 0);
                    }
                });
            }
        });
    }
    // é˜²å¾¡ç‡è¨ˆç®— (ã‚¤ãƒ‹ãƒ³ã‚°0ã®å ´åˆã¯ãƒã‚¤ãƒ•ãƒ³)
    const tourneyERA = (tourneyIP > 0) ? ((tourneyER * 9) / tourneyIP).toFixed(2) : "----";
    // --- â˜…â˜…â˜… è¨ˆç®—ã“ã“ã¾ã§ â˜…â˜…â˜… ---


    // --- 3. ãƒãƒ¼ãƒ ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã®ç”Ÿæˆ ---
    const stats = teamRecord.tournamentStats || { h: 0, ab: 0, hr: 0, rbi: 0, sb: 0, so: 0 };
    // ãƒãƒ£ãƒ¼ãƒˆç”¨ã«ã¯ã€å…ˆã»ã©è¨ˆç®—ã—ãŸä»Šå¤§ä¼šã®ERAã‚’ä½¿ç”¨
    const eraNum = (tourneyERA === "----") ? 9.00 : parseFloat(tourneyERA);

    const avg = (stats.ab > 0) ? (stats.h / stats.ab) : 0;
    const power = (stats.hr || 0) * 10;
    const speed = (stats.sb || 0) * 10;
    const defense = (eraNum < 6) ? (6 - eraNum) / 5 * 100 : (eraNum >= 6 ? 0 : 50); // é˜²å¾¡ç‡ãŒè‰¯ã„ã»ã©é«˜å¾—ç‚¹
    const so = (stats.so || 0);
    const bb = (stats.bb || 0) + (stats.hbp || 0);
    const eye = (bb > 0) ? (bb / (bb + so)) * 100 : 30;

    const normalize = (value) => Math.max(0, Math.min(100, Math.round(value)));

    const chartData = [
        normalize(avg * 500 - 100), // .200=0, .400=100
        normalize(power),
        normalize(speed),
        normalize(defense),
        normalize(eye)
    ];
    
    const ctx = document.getElementById('team-radar-chart')?.getContext('2d');
    if (ctx) {
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['æ‰“æ’ƒ (AVG)', 'é•·æ‰“ (HR)', 'æ©Ÿå‹• (SB)', 'å®ˆå‚™ (ERA)', 'é¸çƒçœ¼ (BB/K)'],
                datasets: [{
                    label: `${teamName} (ä»Šå¤§ä¼š)`,
                    data: chartData,
                    fill: true,
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    borderColor: 'rgb(59, 130, 246)',
                    pointBackgroundColor: 'rgb(59, 130, 246)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(59, 130, 246)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { color: 'rgba(0, 0, 0, 0.1)' },
                        grid: { color: 'rgba(0, 0, 0, 0.1)' },
                        pointLabels: {
                            font: { size: 12, weight: 'bold' },
                            color: '#333'
                        },
                        ticks: {
                            backdropColor: 'white',
                            color: '#777',
                            stepSize: 25,
                            font: { size: 10 }
                        },
                        min: 0,
                        max: 100
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // --- 4. ãƒ†ã‚­ã‚¹ãƒˆæˆç¸¾ã®è¡¨ç¤º (â˜…ã“ã“ã«é˜²å¾¡ç‡ã‚’è¿½åŠ ) ---
    if (statsEl) {
        if (stats && (stats.ab > 0 || stats.games > 0 || stats.sb > 0)) {
            const avgStr = (stats.ab > 0) ? (stats.h / stats.ab).toFixed(3) : ".---";
            
            // â˜… ãƒãƒ¼ãƒ OPSã®è¨ˆç®—
            const t_ab = stats.ab || 0; const t_h = stats.h || 0;
            const t_bb = (stats.bb || 0) + (stats.hbp || 0); const t_sf = stats.sf || 0;
            const t_tb = stats.tb || (t_h + (stats.hr || 0) * 3); // TBãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const t_obp = (t_ab + t_bb + t_sf) > 0 ? (t_h + t_bb) / (t_ab + t_bb + t_sf) : 0;
            const t_slg = t_ab > 0 ? t_tb / t_ab : 0;
            const t_ops = (t_obp + t_slg).toFixed(3);
            
            const sbCount = stats.sb || 0;
            
            // â˜… è¡¨ç¤ºã«OPSã‚’è¿½åŠ 
            statsEl.innerHTML = `
                æ‰“ç‡ <span class="font-bold text-xl">${avgStr}</span> 
                (OPS <span class="font-bold text-blue-700">${t_ops}</span>)<br>
                ${stats.ab}æ‰“æ•° ${stats.h}å®‰æ‰“ ${stats.hr}æœ¬å¡æ‰“ ${stats.rbi}æ‰“ç‚¹ ${sbCount}ç›—å¡<br>
                <span class="text-blue-700">é˜²å¾¡ç‡ ${tourneyERA}</span>
            `;
        } else if (stats) {
            statsEl.innerHTML = `(ä»Šå¤§ä¼š ${stats.ab}æ‰“æ•° ${stats.h}å®‰æ‰“)<br><span class="text-blue-700">é˜²å¾¡ç‡ ${tourneyERA}</span>`;
        } else {
            statsEl.textContent = 'ï¼ˆä»Šå¤§ä¼šã®é›†è¨ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰';
        }
    }    

// â–¼â–¼â–¼ è¿½åŠ ç®‡æ‰€: ã‚»ã‚¤ãƒãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹HTMLã®æ³¨å…¥ â–¼â–¼â–¼
    const saberContainer = document.getElementById('status-modal-sabermetrics');
    if (saberContainer) {
        saberContainer.innerHTML = generateSabermetricsHTML(teamName);
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// â–¼â–¼â–¼ â˜…â˜…â˜… ã“ã“ã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã—ã¦ãã ã•ã„ â˜…â˜…â˜… â–¼â–¼â–¼

    // --- [è¿½åŠ ] ãƒ©ãƒ³ã‚¯å¤‰å‹•äºˆæ¸¬ã‚’è¡¨ç¤º ---
    let predictionContainer = document.getElementById('status-modal-rank-prediction');
    if (!predictionContainer) {
        // ã‚³ãƒ³ãƒ†ãƒŠãŒãªã‘ã‚Œã°ä½œæˆã—ã¦æŒ¿å…¥
        predictionContainer = document.createElement('div');
        predictionContainer.id = 'status-modal-rank-prediction';
        predictionContainer.className = "mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm";
        
        // æŒ¿å…¥å ´æ‰€: ä»Šå¤§ä¼šæˆç¸¾(statsEl)ã®è¦ªè¦ç´ å†…ã€statsElã®ç›´å¾Œ
        if (statsEl && statsEl.parentNode) {
            statsEl.parentNode.insertBefore(predictionContainer, statsEl.nextSibling);
        }
    }
    
    // äºˆæ¸¬ã‚’å®Ÿè¡Œã—ã¦è¡¨ç¤º
    const prediction = predictRankChanges(teamName);
    predictionContainer.innerHTML = `
        <h5 class="font-bold text-gray-700 mb-2 border-b pb-1">æ¬¡å›ã®ãƒ©ãƒ³ã‚¯å¤‰å‹•äºˆæ¸¬</h5>
        <div class="space-y-2">
            <div class="flex items-start">
                <span class="text-xl mr-2">ğŸ“ˆ</span>
                <div>${prediction.up}</div>
            </div>
            <div class="flex items-start">
                <span class="text-xl mr-2">ğŸ“‰</span>
                <div>${prediction.down}</div>
            </div>
        </div>
    `;

    // â–²â–²â–² æŒ¿å…¥ã“ã“ã¾ã§ â–²â–²â–²

    // --- 5. é€šç®—æˆç¸¾ (Career) ã®è¡¨ç¤º ---
    if (careerStatsEl) {
        const careerBattingStats = teamRecord.playerStats?.batting;
        let totalCareerSb = 0, totalCareerHr = 0;
        if (careerBattingStats) {
            for (const playerName in careerBattingStats) {
                const stats = careerBattingStats[playerName];
                totalCareerSb += stats.sb || 0;
                totalCareerHr += stats.hr || 0;
            }
        }
        // é€šç®—é˜²å¾¡ç‡ã¯ã€Œå…¨æœŸé–“ã€ãªã®ã§ã€calculateTeamPitchingStats (å…¨æœŸé–“é›†è¨ˆ) ã‚’ä½¿ã†ã“ã¨ã‚‚å¯èƒ½ã ãŒã€
        // ã“ã“ã§ã¯æ‰“æ’ƒæŒ‡æ¨™ã®ã¿ã«æˆ»ã—ã¦ãŠãï¼ˆã”è¦æœ›é€šã‚Šã€ä»Šå¤§ä¼šæˆç¸¾ã®æ¬„ã«é˜²å¾¡ç‡ã‚’å‡ºã—ãŸã®ã§ï¼‰
        careerStatsEl.textContent = `é€šç®— ${totalCareerHr} æœ¬å¡æ‰“ / ${totalCareerSb} ç›—å¡`;
    }
    
    // --- 6. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º ---
    modal.classList.remove('hidden');
}

// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–² 
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
  // --- Custom Alert/Confirm ---
    function showAlert(message) {
        alert(message);
    }

    function showConfirm(message) {
        return new Promise((resolve) => {
            const confirmOk = document.getElementById('confirm-ok');
            const confirmCancel = document.getElementById('confirm-cancel');
            document.getElementById('confirm-modal-text').textContent = message;
            confirmModal.classList.remove('hidden');

            const onOk = () => {
                confirmModal.classList.add('hidden');
                cleanup();
                resolve(true);
            };

            const onCancel = () => {
                confirmModal.classList.add('hidden');
                cleanup();
                resolve(false);
            };
            
            const cleanup = () => {
                confirmOk.removeEventListener('click', onOk);
                confirmCancel.removeEventListener('click', onCancel);
            };

            confirmOk.addEventListener('click', onOk);
            confirmCancel.addEventListener('click', onCancel);
        });
    }

// --- Utility & State Functions --- ãªã©ã«è¿½åŠ 

// ç”²å­åœ’ã§ã®æˆç¸¾ã‚’å®šç¾©ï¼ˆæ•°å­—ãŒå°ã•ã„ã»ã©ä¸Šä½ï¼‰
const KOSHIEN_RESULTS = {
    CHAMPION:       { rank: -1, label: 'å…¨å›½å„ªå‹' },
    RUNNER_UP:    { rank: -2, label: 'å…¨å›½æº–å„ªå‹' },
    BEST_4:         { rank: -4, label: 'ç”²å­åœ’ãƒ™ã‚¹ãƒˆ4' },
    BEST_8:         { rank: -8, label: 'ç”²å­åœ’ãƒ™ã‚¹ãƒˆ8' },
    BEST_16:        { rank: -16, label: 'ç”²å­åœ’3å›æˆ¦æ•—é€€' }, // ãƒ™ã‚¹ãƒˆ16
    ROUND_2:        { rank: -32, label: 'ç”²å­åœ’2å›æˆ¦æ•—é€€' },
    ROUND_1:        { rank: -64, label: 'ç”²å­åœ’åˆæˆ¦æ•—é€€' },
};

// ãƒãƒ¼ãƒ ã®Aï½Eãƒ©ãƒ³ã‚¯ã”ã¨ã®ã€ç”²å­åœ’ã§ã®æˆç¸¾ç¢ºç‡ï¼ˆã‚¦ã‚§ã‚¤ãƒˆæ–¹å¼ï¼‰
const KOSHIEN_PROBABILITIES = {
    'A': [
        { result: 'CHAMPION', weight: 20 }, { result: 'RUNNER_UP', weight: 25 },
        { result: 'BEST_4', weight: 25 },   { result: 'BEST_8', weight: 15 },
        { result: 'BEST_16', weight: 10 },  { result: 'ROUND_2', weight: 4 },
        { result: 'ROUND_1', weight: 1 }
    ],
    'B': [
        { result: 'CHAMPION', weight: 5 },  { result: 'RUNNER_UP', weight: 10 },
        { result: 'BEST_4', weight: 20 },   { result: 'BEST_8', weight: 30 },
        { result: 'BEST_16', weight: 20 },  { result: 'ROUND_2', weight: 10 },
        { result: 'ROUND_1', weight: 5 }
    ],
    'C': [
        { result: 'CHAMPION', weight: 1 },  { result: 'RUNNER_UP', weight: 3 },
        { result: 'BEST_4', weight: 8 },    { result: 'BEST_8', weight: 20 },
        { result: 'BEST_16', weight: 30 },  { result: 'ROUND_2', weight: 28 },
        { result: 'ROUND_1', weight: 10 }
    ],
    'D': [
        { result: 'BEST_8', weight: 5 },    { result: 'BEST_16', weight: 15 },
        { result: 'ROUND_2', weight: 40 },  { result: 'ROUND_1', weight: 40 }
    ],
    'E': [
        { result: 'BEST_16', weight: 5 },   { result: 'ROUND_2', weight: 25 },
        { result: 'ROUND_1', weight: 70 }
    ],
};

/**
 * ãƒãƒ¼ãƒ ãƒ©ãƒ³ã‚¯ã«åŸºã¥ãã€ç”²å­åœ’ã§ã®æˆç¸¾ã‚’ç¢ºç‡ã§æ±ºå®šã™ã‚‹
 * @param {string} teamRank - 'A'ã‹ã‚‰'E'ã¾ã§ã®ãƒãƒ¼ãƒ ãƒ©ãƒ³ã‚¯
 * @returns {string} - KOSHIEN_RESULTSã®ã‚­ãƒ¼ ('CHAMPION', 'BEST_8'ãªã©)
 */
function simulateKoshien(teamRank) {
    const probabilities = KOSHIEN_PROBABILITIES[teamRank] || KOSHIEN_PROBABILITIES['E'];
    const totalWeight = probabilities.reduce((sum, p) => sum + p.weight, 0);
    let random = Math.random() * totalWeight;

    for (const prob of probabilities) {
        if (random < prob.weight) {
            return prob.result;
        }
        random -= prob.weight;
    }
    return 'ROUND_1'; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
}
   
 /**
     * è©¦åˆIDã‚’å…ƒã«ã€stateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ·±ã„éšå±¤ã‹ã‚‰è©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¤œç´¢ã—ã¦è¿”ã™
     * (â˜…å…¨å¤§ä¼š128ãƒãƒ¼ãƒ åˆ¶çµ±ä¸€ã«ä¼´ã„ã€tournamentState.matches ã®ã¿æ¤œç´¢ã™ã‚‹ã‚ˆã†ä¿®æ­£)
     */
    function findMatchById(matchId) {
        // å…¨ã¦ã®è©¦åˆã¯ tournamentState.matches ã«ä¿å­˜ã•ã‚Œã‚‹
        if (tournamentState.matches && tournamentState.matches[matchId]) {
            return tournamentState.matches[matchId];
        }
        
        // â˜… å»ƒæ­¢ã•ã‚ŒãŸ autumnData, springData ã¸ã®å‚ç…§ã‚’å‰Šé™¤ â˜…
        
        return null; // ã©ã“ã«ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆ
    }
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

// â–¼â–¼â–¼ ã‚¹ã‚«ã‚¦ãƒˆæ©Ÿèƒ½ãƒ­ã‚¸ãƒƒã‚¯ (å³æ ¼åŒ–ãƒ»äººæ•°åˆ¶é™ç‰ˆ) â–¼â–¼â–¼

// ã‚¹ã‚«ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById('show-scout-report-btn').addEventListener('click', () => {
    generateScoutReport();
    document.getElementById('scout-report-modal').classList.remove('hidden');
    document.getElementById('scout-report-modal').classList.add('flex');
});

document.getElementById('scout-report-close-btn').addEventListener('click', () => {
    document.getElementById('scout-report-modal').classList.add('hidden');
    document.getElementById('scout-report-modal').classList.remove('flex');
});

/**
 * å…¨ãƒãƒ¼ãƒ ã®é¸æ‰‹ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€æœ‰åŠ›é¸æ‰‹ã‚’å³é¸ã—ã¦è¡¨ç¤ºã™ã‚‹
 */
function generateScoutReport() {
    const container = document.getElementById('scout-report-content');
    container.innerHTML = '<div class="loader">ã‚¹ã‚«ã‚¦ãƒˆãŒæœ‰æœ›æ ªã‚’å³é¸ä¸­...</div>';

    const batterCandidates = [];
    const pitcherCandidates = [];

    // 1. å…¨ãƒãƒ¼ãƒ ã‚’èµ°æŸ»ã—ã¦å€™è£œã‚’åé›†
    Object.keys(tournamentState.teamRecords).forEach(teamName => {
        const record = tournamentState.teamRecords[teamName];
        if (!record.playerStats) return;

        // æ‰“è€…è©•ä¾¡
        if (record.playerStats.batting) {
            Object.entries(record.playerStats.batting).forEach(([name, stats]) => {
                // ã€ä¿®æ­£ã€‘æœ€ä½ãƒ©ã‚¤ãƒ³ã‚’15æ‰“æ•°ã«å¼•ãä¸Šã’
                if (stats.ab >= 15) {
                    const grade = calculateBatterGrade(stats);
                    // ã€ä¿®æ­£ã€‘Cãƒ©ãƒ³ã‚¯ä»¥ä¸‹ã¯è¶³åˆ‡ã‚Šï¼ˆBãƒ©ãƒ³ã‚¯ä»¥ä¸Šã®ã¿å€™è£œã¸ï¼‰
                    // â€»ãŸã ã—Sãƒ©ãƒ³ã‚¯ãŒå°‘ãªã™ãã‚‹å ´åˆã«å‚™ãˆã¦ã€ä¸€æ—¦å…¨å“¡è¨ˆç®—ã—ã¦å¾Œã§ã‚½ãƒ¼ãƒˆãƒ»ã‚«ãƒƒãƒˆã™ã‚‹æ–¹å¼ã«å¤‰æ›´
                    if (grade.rankValue >= 3) { 
                        batterCandidates.push({
                            type: 'batter', name: name, team: teamName,
                            rank: grade.rank, rankValue: grade.rankValue,
                            stats: stats, comment: grade.comment,
                            sortKey: calculateOps(stats) // OPSã§ã‚½ãƒ¼ãƒˆç”¨
                        });
                    }
                }
            });
        }

        // æŠ•æ‰‹è©•ä¾¡
        if (record.playerStats.pitching) {
            Object.entries(record.playerStats.pitching).forEach(([name, stats]) => {
                const career = stats.career;
                // ã€ä¿®æ­£ã€‘æœ€ä½ãƒ©ã‚¤ãƒ³ã‚’10å›ã«å¼•ãä¸Šã’
                if (career && career.ip >= 10) {
                    const grade = calculatePitcherGrade(career);
                    if (grade.rankValue >= 3) {
                        pitcherCandidates.push({
                            type: 'pitcher', name: name, team: teamName,
                            rank: grade.rank, rankValue: grade.rankValue,
                            stats: career, comment: grade.comment,
                            sortKey: ((career.er * 9) / career.ip) * -1 // é˜²å¾¡ç‡ãŒä½ã„ã»ã©å‰ã„ï¼ˆé™é †ã‚½ãƒ¼ãƒˆç”¨ã«ãƒã‚¤ãƒŠã‚¹åŒ–ï¼‰
                        });
                    }
                }
            });
        }
    });

    // 2. ã‚½ãƒ¼ãƒˆï¼ˆãƒ©ãƒ³ã‚¯ãŒé«˜ã„é † > æˆç¸¾ãŒè‰¯ã„é †ï¼‰
    batterCandidates.sort((a, b) => {
        if (b.rankValue !== a.rankValue) return b.rankValue - a.rankValue;
        return parseFloat(b.sortKey) - parseFloat(a.sortKey);
    });
    
    pitcherCandidates.sort((a, b) => {
        if (b.rankValue !== a.rankValue) return b.rankValue - a.rankValue;
        return parseFloat(b.sortKey) - parseFloat(a.sortKey);
    });

    // 3. ã€ä¿®æ­£ã€‘è¡¨ç¤ºäººæ•°ã‚’åˆ¶é™ï¼ˆå„ãƒˆãƒƒãƒ—10åã¾ã§ï¼‰
    const topBatters = batterCandidates.slice(0, 10);
    const topPitchers = pitcherCandidates.slice(0, 10);

    // 4. HTMLç”Ÿæˆ
    let html = '';
    
    if (topBatters.length === 0 && topPitchers.length === 0) {
        html = `
            <div class="text-center py-10">
                <p class="text-gray-500 text-xl">ã€Œã¾ã çœ¼é¡ã«é©ã†é¸æ‰‹ã¯ãŠã‚‰ã‚“ã‚ˆã†ã ãª...ã€</p>
                <p class="text-sm text-gray-400 mt-2">â€»è©¦åˆæ•°ãŒé€²ã‚€ã¨å€™è£œãŒç¾ã‚Œã¾ã™</p>
            </div>`;
    } else {
        // ãƒ‰ãƒ©ãƒ•ãƒˆ1ä½å€™è£œ (Sãƒ©ãƒ³ã‚¯) ãŒã„ã‚Œã°ç‰¹åˆ¥è¡¨ç¤º
        const sRankBatters = topBatters.filter(c => c.rank === 'S');
        const sRankPitchers = topPitchers.filter(c => c.rank === 'S');
        const sRanks = [...sRankBatters, ...sRankPitchers];

        if (sRanks.length > 0) {
            html += `<div class="mb-8 border-4 border-yellow-400 bg-yellow-50 p-4 rounded-lg">
                <h4 class="text-2xl font-bold text-amber-700 mb-4 text-center">ğŸ‘‘ ä»Šå¤§ä¼šã®è¶…ç›®ç‰ (ãƒ‰ãƒ©ãƒ•ãƒˆ1ä½å€™è£œ)</h4>
                ${renderCandidateList(sRanks)}
            </div>`;
        }

        // é‡æ‰‹ãƒªã‚¹ãƒˆ
        if (topBatters.length > 0) {
            html += `<h4 class="text-xl font-bold text-blue-800 mb-2 border-b-2 border-blue-800 pb-1">é‡æ‰‹ æ³¨ç›®é¸æ‰‹ (TOP ${topBatters.length})</h4>`;
            html += renderCandidateList(topBatters);
        }

        // æŠ•æ‰‹ãƒªã‚¹ãƒˆ
        if (topPitchers.length > 0) {
            html += `<h4 class="text-xl font-bold text-red-800 mb-2 mt-8 border-b-2 border-red-800 pb-1">æŠ•æ‰‹ æ³¨ç›®é¸æ‰‹ (TOP ${topPitchers.length})</h4>`;
            html += renderCandidateList(topPitchers);
        }
    }

    container.innerHTML = html;
}

/**
 * å€™è£œè€…ãƒªã‚¹ãƒˆã®HTMLã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
function renderCandidateList(list) {
    return list.map(c => {
        let statsStr = '';
        let highlightClass = '';
        
        if (c.type === 'batter') {
            const avg = (c.stats.h / c.stats.ab).toFixed(3);
            const ops = calculateOps(c.stats);
            statsStr = `æ‰“ç‡${avg} / ${c.stats.hr}æœ¬ / ${c.stats.sb}ç›— / ${c.stats.rbi}æ‰“ç‚¹ / OPS ${ops}`;
            // Sãƒ©ãƒ³ã‚¯ç´šã®æˆç¸¾ãªã‚‰æ–‡å­—è‰²ã‚’å¤‰ãˆã‚‹
            if (c.rank === 'S') highlightClass = 'text-amber-700 font-bold';
        } else {
            const era = c.stats.er > 0 ? ((c.stats.er * 9) / c.stats.ip).toFixed(2) : "0.00";
            const k9 = ((c.stats.so * 9) / c.stats.ip).toFixed(2);
            statsStr = `é˜²å¾¡ç‡${era} / ${c.stats.w}å‹ / å¥ªä¸‰æŒ¯${c.stats.so} (K/9: ${k9})`;
            if (c.rank === 'S') highlightClass = 'text-amber-700 font-bold';
        }

        return `
        <div class="scout-card rank-${c.rank} mb-2">
            <div class="flex items-center w-full">
                <div class="scout-rank-badge rank-bg-${c.rank}">${c.rank}</div>
                <div class="flex-grow">
                    <div class="flex justify-between items-baseline">
                        <div class="flex items-baseline gap-2">
                            <h5 class="text-lg font-bold text-gray-900">${c.name}</h5>
                            <span class="text-xs text-white bg-gray-500 px-2 py-0.5 rounded">${c.team}</span>
                        </div>
                    </div>
                    <div class="text-sm font-mono mt-1 ${highlightClass}">${statsStr}</div>
                    <div class="scout-comment-box text-xs mt-1">ğŸ“ ${c.comment}</div>
                </div>
            </div>
        </div>
        `;
    }).join('');
}

/**
 * æ‰“è€…ã®ãƒ©ãƒ³ã‚¯åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (å³æ ¼åŒ–)
 */
function calculateBatterGrade(stats) {
    const avg = stats.h / stats.ab;
    const ops = parseFloat(calculateOps(stats));
    let rank = 'C';
    let rankValue = 3;
    let comment = "ä¸€å®šã®åŠ›ã¯ã‚ã‚‹ã€‚å°†æ¥æ€§ã«æœŸå¾…ã€‚";

    // Sãƒ©ãƒ³ã‚¯: åœ§å€’çš„ãªæˆç¸¾ (5å‰²è¶…ãˆã€ã¾ãŸã¯æœ¬å¡æ‰“é‡ç”£)
    if (stats.hr >= 5 || (avg >= 0.600 && stats.hr >= 3) || ops >= 1.800) {
        rank = 'S'; rankValue = 6;
        comment = "ã€ãƒ‰ãƒ©1ç¢ºå®šã€‘é«˜æ ¡ç”Ÿé›¢ã‚Œã—ãŸã‚¹ã‚¤ãƒ³ã‚°ã€‚ãƒ—ãƒ­ã§ã‚‚å³ä¸­è»¸ã‚’æ‰“ã¦ã‚‹é€¸æã€‚";
    } 
    // Aãƒ©ãƒ³ã‚¯: è¶…é«˜æ ¡ç´š (4å‰²5åˆ†è¶…ãˆã€OPS 1.4ä»¥ä¸Š)
    else if (stats.hr >= 3 || avg >= 0.500 || (stats.sb >= 10 && avg >= 0.400) || ops >= 1.400) {
        rank = 'A'; rankValue = 5;
        comment = "ã€ä¸Šä½æŒ‡åã€‘èµ°æ”»å®ˆæƒã£ãŸå¥½ç´ æã€‚å³æˆ¦åŠ›ã¨ã—ã¦æœŸå¾…ã§ãã‚‹ã€‚";
    } 
    // Bãƒ©ãƒ³ã‚¯: å¼·è±ªæ ¡ã®ä¸»åŠ›ãƒ¬ãƒ™ãƒ« (4å‰²è¶…ãˆ)
    else if (avg >= 0.400 || stats.hr >= 2 || (stats.sb >= 6 && avg >= 0.300)) {
        rank = 'B'; rankValue = 4;
        comment = "ã€æ³¨ç›®ã€‘ã‚­ãƒ©ãƒªã¨å…‰ã‚‹æ­¦å™¨ãŒã‚ã‚‹ã€‚ä¸‹ä½æŒ‡åãƒªã‚¹ãƒˆã«å…¥ã‚‹ã‹ã€‚";
    } 
    
    return { rank, rankValue, comment };
}

/**
 * æŠ•æ‰‹ã®ãƒ©ãƒ³ã‚¯åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (å³æ ¼åŒ–)
 */
function calculatePitcherGrade(stats) {
    const era = (stats.er * 9) / stats.ip;
    const k9 = (stats.so * 9) / stats.ip;
    let rank = 'C';
    let rankValue = 3;
    let comment = "åˆ¶çƒåŠ›ã«èª²é¡Œã‚’æ®‹ã™ãŒã€çƒå¨ã¯ã‚ã‚‹ã€‚";

    // Sãƒ©ãƒ³ã‚¯: æ”¯é…çš„ãªæŠ•çƒ (é˜²å¾¡ç‡0ç‚¹å° & å¥ªä¸‰æŒ¯ç‡12.0ä»¥ä¸Š)
    if ((era <= 1.00 && k9 >= 12.0 && stats.ip >= 15) || (stats.so >= 50)) {
        rank = 'S'; rankValue = 6;
        comment = "ã€ãƒ‰ãƒ©1ç¢ºå®šã€‘å®Œæˆåº¦ã¯ãƒ—ãƒ­é¡”è² ã‘ã€‚ç›´çƒã®å›è»¢æ•°ãŒç´ æ™´ã‚‰ã—ãã€å³ãƒ­ãƒ¼ãƒ†å…¥ã‚Šç¢ºå®Ÿã€‚";
    } 
    // Aãƒ©ãƒ³ã‚¯: ã‚¨ãƒ¼ã‚¹ç´š (é˜²å¾¡ç‡2.00ä»¥ä¸‹ & å¥ªä¸‰æŒ¯ç‡9.0ä»¥ä¸Š)
    else if ((era <= 2.00 && k9 >= 9.0) || (stats.w >= 5)) {
        rank = 'A'; rankValue = 5;
        comment = "ã€ä¸Šä½æŒ‡åã€‘ãƒ”ãƒ³ãƒã«å‹•ã˜ãªã„ãƒã‚¦ãƒ³ãƒ‰åº¦èƒ¸ã€‚å¤‰åŒ–çƒã®ã‚­ãƒ¬ã‚‚ä¸€ç´šå“ã€‚";
    } 
    // Bãƒ©ãƒ³ã‚¯: å¥½æŠ•æ‰‹ (é˜²å¾¡ç‡3.00ä»¥ä¸‹)
    else if (era <= 3.00 || k9 >= 8.0) {
        rank = 'B'; rankValue = 4;
        comment = "ã€æ³¨ç›®ã€‘ç´ æå‹ã®æŠ•æ‰‹ã¨ã—ã¦ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã€‚ä½“ãŒå‡ºæ¥ä¸ŠãŒã‚Œã°åŒ–ã‘ã‚‹ã€‚";
    } 
    
    return { rank, rankValue, comment };
}

// OPSè¨ˆç®—ãƒ˜ãƒ«ãƒ‘ãƒ¼ (å¤‰æ›´ãªã—)
function calculateOps(stats) {
    const obp = (stats.ab + stats.bb + stats.hbp + stats.sf) > 0 ? (stats.h + stats.bb + stats.hbp) / (stats.ab + stats.bb + stats.hbp + stats.sf) : 0;
    const slg = stats.ab > 0 ? (stats.tb || stats.h) / stats.ab : 0; 
    return (obp + slg).toFixed(3);
}
// â–²â–²â–² ã‚¹ã‚«ã‚¦ãƒˆæ©Ÿèƒ½ã“ã“ã¾ã§ â–²â–²â–²

/**
 * ãƒãƒ¼ãƒ ã®ä»Šå¤§ä¼šã®å‹ã¡ä¸ŠãŒã‚Šã‚’ã€Œã€‡ã€‡å›æˆ¦ vs â–³â–³ã€ã®ã‚ˆã†ã«è¦ç´„ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 */
function getTournamentPathSummary(teamName, currentMatchId) {
    const teamRecord = tournamentState.teamRecords[teamName];
    if (!teamRecord) return "ä»Šå¤§ä¼šåˆæˆ¦ã€‚";

    const path = [];
    const currentTournamentMatchIds = Object.keys(tournamentState.matches);

    for (const matchId of currentTournamentMatchIds) {
        if (matchId === currentMatchId) continue;
        const match = tournamentState.matches[matchId];
        
        if (match.winner && (match.team1 === teamName || match.team2 === teamName)) {
            const opponent = match.team1 === teamName ? match.team2 : teamName;
            const roundName = getRoundNameFromMatchId(matchId);
            
            if (match.winner === teamName) {
                path.push(`${roundName} vs ${opponent}`);
            }
        }
    }
    
    return path.length === 0 ? "ä»Šå¤§ä¼šåˆæˆ¦ã€‚" : `ã“ã“ã¾ã§ã®å‹ã¡ä¸ŠãŒã‚Š: ${path.join(' â†’ ')}ã€‚`;
}

/**
 * [UPDATED] è©¦åˆIDã‹ã‚‰ãƒ©ã‚¦ãƒ³ãƒ‰åã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 * (â˜…ãƒãƒ¼ãƒ æ•°ã«å¿œã˜ã¦ã€Œæº–æ±ºå‹ã€ãªã©ã®ãƒ©ã‚¦ãƒ³ãƒ‰ç•ªå·ã‚’å‹•çš„ã«åˆ¤å®š)
 */
function getRoundNameFromMatchId(matchId) {
    if (!matchId) return "ä¸æ˜ãªãƒ©ã‚¦ãƒ³ãƒ‰";

    // æ±ºå‹æˆ¦
    if (matchId.startsWith('F-R1-')) {
        return "æ±ºå‹";
    }
    
    if (!matchId.includes('-R')) {
         return "ä¸æ˜ãªãƒ©ã‚¦ãƒ³ãƒ‰";
    }
    
    const roundNum = parseInt(matchId.split('-')[1].slice(1));
    
    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ãƒãƒ¼ãƒ æ•°ã‹ã‚‰ç·ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã‚’è¨ˆç®— â˜…â˜…â˜…
    const numTeams = tournamentState.teams.length; 
    const finalRound = Math.log2(numTeams); // 128ãƒãƒ¼ãƒ â†’7, 64ãƒãƒ¼ãƒ â†’6
    
    const roundNameMap = { 
        [finalRound]: 'æ±ºå‹',
        [finalRound-1]: 'æº–æ±ºå‹',   
        [finalRound-2]: 'æº–ã€…æ±ºå‹', 
        [finalRound-3]: '4å›æˆ¦'     
    };
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…
    
    return roundNameMap[roundNum] || `${roundNum}å›æˆ¦`;
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

// --- Team Rank Calculation (Reality-Adjusted Version) ---
    
/**
 * 2ãƒãƒ¼ãƒ é–“ã®å› ç¸å¯¾æ±ºã‚’åˆ¤å®šã—ã€ãƒ•ãƒ©ã‚°ã‚’è¿”ã™ï¼ˆã‚¿ã‚°æ©Ÿèƒ½ä¸è¦ç‰ˆï¼‰
 * @param {string} team1Name - ãƒãƒ¼ãƒ 1ã®åå‰
 * @param {string} team2Name - ãƒãƒ¼ãƒ 2ã®åå‰
 * @returns {string | null} - å› ç¸ã®ã‚¿ã‚¤ãƒ—ï¼ˆä¾‹: "283ç›´æ¥å¯¾æ±º"ï¼‰ã€ãªã‘ã‚Œã° null
 */
function checkRivalry(team1Name, team2Name) {
    if (!team1Name || !team2Name) return null;

    const data1 = TEAM_DATA[team1Name];
    const data2 = TEAM_DATA[team2Name];
    if (!data1 || !data2) return null;

    // 1. 283å­¦åœ’ vs 283å­¦åœ’B
    if ((team1Name === "283å­¦åœ’" && team2Name === "283å­¦åœ’B") || (team1Name === "283å­¦åœ’B" && team2Name === "283å­¦åœ’")) {
        return "283ç›´æ¥å¯¾æ±º";
    }

    // â–¼â–¼â–¼ ä¿®æ­£ç‚¹ â–¼â–¼â–¼
    // 2. ãƒŠãƒ ã‚³ç³»åˆ—ãƒ€ãƒ¼ãƒ“ãƒ¼ (ã‚¿ã‚°ã®ä»£ã‚ã‚Šã«ã€ã“ã“ã§ãƒªã‚¹ãƒˆã‚’ç›´æ¥å®šç¾©)
    const namcoSchools = ["765ç·åˆé«˜æ ¡", "283å­¦åœ’", "åˆæ˜Ÿå­¦åœ’", "ç¾åŸå­¦åœ’", "283å­¦åœ’B"];
    if (namcoSchools.includes(team1Name) && namcoSchools.includes(team2Name)) {
        return "ãƒŠãƒ ã‚³ãƒ€ãƒ¼ãƒ“ãƒ¼";
    }
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    // 3. åŒåœ°åŒºã®å¼·è±ªå¯¾æ±º (Aãƒ©ãƒ³ã‚¯ vs Aãƒ©ãƒ³ã‚¯ or Aãƒ©ãƒ³ã‚¯ vs Bãƒ©ãƒ³ã‚¯)
    if (data1.region === data2.region) {
        const rank1 = calculateRank(team1Name, tournamentState);
        const rank2 = calculateRank(team2Name, tournamentState);
        if ((rank1 === 'A' && rank2 === 'A') || (rank1 === 'A' && rank2 === 'B') || (rank1 === 'B' && rank2 === 'A')) {
            return `åŒåœ°åŒºå¼·è±ªå¯¾æ±º (${data1.region})`;
        }
    }

    return null; // ãã®ä»–ã®å› ç¸ã¯ãªã—
}

/**
 * æŒ‡å®šã•ã‚ŒãŸãƒ©ã‚¦ãƒ³ãƒ‰ã®å…¨è©¦åˆã«æ—¥ä»˜ã¨çƒå ´ã‚’å‰²ã‚Šå½“ã¦ã‚‹
 * @param {Array<string>} matchIds - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹è©¦åˆIDã®é…åˆ—
 * @param {Array<string>} dates - ä½¿ç”¨ã™ã‚‹æ—¥ä»˜ã®é…åˆ— (ä¾‹: ["7/10", "7/11"])
 * @param {Array<object>} stadiumList - ä½¿ç”¨ã™ã‚‹çƒå ´ã®ãƒªã‚¹ãƒˆ (ä¾‹: STADIUM_DATA)
 * @param {number} gamesPerDayPerStadium - 1çƒå ´ãƒ»1æ—¥ã‚ãŸã‚Šã®æœ€å¤§è©¦åˆæ•°
 */
function scheduleRoundMatches(matchIds, dates, stadiumList, gamesPerDayPerStadium) {
    if (!matchIds || matchIds.length === 0) return;

    let scheduleQueue = []; // [ { stadium, date, gameNum: 1 }, { stadium, date, gameNum: 2 }, ... ]
    
    // å…¨ã¦ã®æ—¥ä»˜ã¨çƒå ´ã§ã€é–‹å‚¬å¯èƒ½ãªå…¨ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½œæˆ
    for (const date of dates) {
        for (const stadium of stadiumList) {
            for (let i = 1; i <= gamesPerDayPerStadium; i++) {
                scheduleQueue.push({
                    date: date,
                    stadium: stadium.abbr, // ç•¥ç§°ã‚’ä¿å­˜
                    stadiumFull: stadium.name,
                    gameNum: i // è©¦åˆé † (â‘ , â‘¡, ...)
                });
            }
        }
    }

    // è©¦åˆIDã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦
    matchIds.forEach((matchId, index) => {
        const match = findMatchById(matchId);
        if (match && scheduleQueue[index]) { // ã‚¹ãƒ­ãƒƒãƒˆãŒè¶³ã‚Šã‚‹é™ã‚Šå‰²ã‚Šå½“ã¦
            const schedule = scheduleQueue[index];
            match.schedule = {
                date: schedule.date,
                stadium: schedule.stadium,
                stadiumFull: schedule.stadiumFull,
                game: schedule.gameNum
            };
        } else if (match) {
            // ã‚¹ãƒ­ãƒƒãƒˆãŒè¶³ã‚Šãªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            match.schedule = { date: dates[0], stadium: stadiumList[0].abbr, game: 1 };
        }
    });
}

/**
 * [NEW] ãƒãƒ¼ãƒ ã®ãƒ©ãƒ³ã‚¯ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã™ã‚‹ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 * @param {number} hypotheticalFinish - ä»®å®šã™ã‚‹æœ€çµ‚é †ä½ (1, 2, 4, 8, 16, 32, 64)
 * @returns {number} - ãƒ©ãƒ³ã‚¯ã‚¹ã‚³ã‚¢
 */
function calculateScore(teamName, hypotheticalFinish) {
    const teamData = TEAM_DATA[teamName];
    if (!teamData) return 0;

    let score = 0;
    
    // 1. åŸºç¤èƒ½åŠ› (åå·®å€¤)
    score += (teamData.deviation || 50) * 0.5;

    // 2. éå»ã®æœ€é«˜æˆç¸¾ãƒœãƒ¼ãƒŠã‚¹ (æ–‡å­—æƒ…å ±)
    const bestStr = teamData.best || '';
    if (bestStr.includes('å„ªå‹') && bestStr.includes('ç”²å­åœ’')) score += 40;
    else if (bestStr.includes('å„ªå‹')) score += 25;
    else if (bestStr.includes('æº–å„ªå‹')) score += 20;
    else if (bestStr.includes('ãƒ™ã‚¹ãƒˆ4')) score += 15;
    else if (bestStr.includes('å‡ºå ´')) score += 10;
    else if (bestStr.includes('ãƒ™ã‚¹ãƒˆ8')) score += 10;
    else if (bestStr.includes('ãƒ™ã‚¹ãƒˆ16')) score += 5;

    // 3. ç›´è¿‘æˆç¸¾ãƒœãƒ¼ãƒŠã‚¹ (ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤)
    // (ç”²å­åœ’æˆç¸¾ã¯ãƒã‚¤ãƒŠã‚¹å€¤ã§ã™ãŒã€ã“ã“ã§ã¯çœŒå¤§ä¼šã®æ˜‡æ ¼é™æ ¼ã«çµã£ã¦ãƒ—ãƒ©ã‚¹å€¤ã§è¨ˆç®—ã—ã¾ã™)
    if (hypotheticalFinish === 1) score += 20;       // å„ªå‹
    else if (hypotheticalFinish === 2) score += 15;  // æº–å„ªå‹
    else if (hypotheticalFinish <= 4) score += 10;   // ãƒ™ã‚¹ãƒˆ4
    else if (hypotheticalFinish <= 8) score += 5;    // ãƒ™ã‚¹ãƒˆ8
    else if (hypotheticalFinish <= 16) score += 2;   // ãƒ™ã‚¹ãƒˆ16
    else if (hypotheticalFinish >= 64) score -= 5;   // åˆæˆ¦æ•—é€€ãƒšãƒŠãƒ«ãƒ†ã‚£

    // 4. äººæ°—è£œæ­£
    if (teamData.popularity) score += 5;

    return score;
}

/**
 * [NEW] ã‚¹ã‚³ã‚¢ã‹ã‚‰ãƒ©ãƒ³ã‚¯(A~E)ã‚’åˆ¤å®šã™ã‚‹
 */
function getRankChar(score) {
    if (score >= 60) return 'A';
    if (score >= 50) return 'B';
    if (score >= 40) return 'C';
    if (score >= 30) return 'D';
    return 'E';
}

/**
 * [UPDATED] ãƒ©ãƒ³ã‚¯å¤‰å‹•äºˆæ¸¬ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…4å›æˆ¦(ãƒ™ã‚¹ãƒˆ16)ã‚’å«ã‚€ã€å…¨ãƒ©ã‚¦ãƒ³ãƒ‰ã®æ˜‡æ ¼ãƒ»é™æ ¼åˆ†å²ã‚’å®Œå…¨ç¶²ç¾…ã—ãŸä¿®æ­£ç‰ˆ)
 */
function predictRankChanges(teamName) {
    const currentRank = calculateRank(teamName, tournamentState);
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
    const currentRankVal = rankValues[currentRank];
    
    let rankUpMsg = "";
    let rankDownMsg = "";

    // --- 1. ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—æ¡ä»¶ã‚’æ¢ã™ (ä¸‹ã‹ã‚‰é †ã«ãƒã‚§ãƒƒã‚¯) ---
    // ãƒã‚§ãƒƒã‚¯é †ä½: 32(3å›æˆ¦), 16(4å›æˆ¦/ãƒ™ã‚¹ãƒˆ16), 8(æº–ã€…), 4(æº–æ±º), 2(æ±ºå‹), 1(å„ªå‹)
    if (currentRank !== 'A') {
        const upMilestones = [32, 16, 8, 4, 2, 1]; 
        let upFound = false;
        
        for (const finish of upMilestones) {
            const score = calculateScore(teamName, finish);
            const projectedRank = getRankChar(score);
            
            // ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯ã‚ˆã‚Šä¸ŠãŒã‚‹å ´åˆ
            if (rankValues[projectedRank] > currentRankVal) {
                let condition = "";
                if (finish === 1) condition = "å„ªå‹";
                else if (finish === 2) condition = "æ±ºå‹";     // æº–å„ªå‹
                else if (finish === 4) condition = "ãƒ™ã‚¹ãƒˆ4";  // æº–æ±ºå‹é€²å‡º
                else if (finish === 8) condition = "ãƒ™ã‚¹ãƒˆ8";  // æº–ã€…æ±ºå‹é€²å‡º
                else if (finish === 16) condition = "ãƒ™ã‚¹ãƒˆ16"; // 4å›æˆ¦é€²å‡º
                else if (finish === 32) condition = "3å›æˆ¦";   // 3å›æˆ¦é€²å‡º (ãƒ™ã‚¹ãƒˆ32)

                rankUpMsg = `ğŸ”¥ <strong>${condition}</strong> é€²å‡ºã§ <strong>ãƒ©ãƒ³ã‚¯${projectedRank}</strong> ã¸æ˜‡æ ¼ï¼`;
                upFound = true;
                break; // æœ€åˆã«è¦‹ã¤ã‹ã£ãŸã€Œæœ€ã‚‚ä½ã„ãƒãƒ¼ãƒ‰ãƒ«ï¼ˆæœ€çŸ­ç›®æ¨™ï¼‰ã€ã‚’è¡¨ç¤ºã—ã¦çµ‚äº†
            }
        }
        
        if (!upFound) {
            rankUpMsg = `<span class="text-gray-500">ï¼ˆå„ªå‹ã—ã¦ã‚‚æ¬¡å›ã®æ˜‡æ ¼åœå†…ã«ã¯å±Šãã¾ã›ã‚“ï¼‰</span>`;
        }
    } else {
        rankUpMsg = `<span class="text-amber-600 font-bold">ğŸ‘‘ ç¾åœ¨ æœ€é«˜ãƒ©ãƒ³ã‚¯åˆ°é”ä¸­</span>`;
    }

    // --- 2. ãƒ©ãƒ³ã‚¯ãƒ€ã‚¦ãƒ³å±é™ºæ€§ã‚’æ¢ã™ (ä¸‹ã‹ã‚‰é †ã«ãƒã‚§ãƒƒã‚¯) ---
    // ãƒã‚§ãƒƒã‚¯é †ä½ï¼ˆæ‚ªã„é †ï¼‰: 64(1/2å›æˆ¦), 32(3å›æˆ¦), 16(4å›æˆ¦), 8(æº–ã€…), 4(æº–æ±º), 2(æ±ºå‹)
    if (currentRank !== 'E') {
        const downMilestones = [64, 32, 16, 8, 4, 2];
        let downFound = false;

        for (const finish of downMilestones) {
            const score = calculateScore(teamName, finish);
            const projectedRank = getRankChar(score);
            
            // ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯ã‚ˆã‚Šä¸‹ãŒã‚‹å ´åˆ
            if (rankValues[projectedRank] < currentRankVal) {
                let lossStage = "";
                if (finish === 64) lossStage = "åˆæˆ¦(1ï½¥2å›æˆ¦)æ•—é€€";
                else if (finish === 32) lossStage = "3å›æˆ¦æ•—é€€";
                else if (finish === 16) lossStage = "4å›æˆ¦(ãƒ™ã‚¹ãƒˆ16)æ•—é€€"; // â˜…ã“ã“ã‚’è¿½åŠ ãƒ»ä¿®æ­£
                else if (finish === 8) lossStage = "æº–ã€…æ±ºå‹æ•—é€€"; // ãƒ™ã‚¹ãƒˆ8æ­¢ã¾ã‚Š
                else if (finish === 4) lossStage = "æº–æ±ºå‹æ•—é€€";   // ãƒ™ã‚¹ãƒˆ4æ­¢ã¾ã‚Š
                else if (finish === 2) lossStage = "æ±ºå‹æ•—é€€";     // æº–å„ªå‹æ­¢ã¾ã‚Š

                rankDownMsg = `âš ï¸ <strong>${lossStage}</strong> ã™ã‚‹ã¨ <strong>ãƒ©ãƒ³ã‚¯${projectedRank}</strong> ã¸é™æ ¼...`;
                downFound = true;
                break; // æœ€åˆã«è¦‹ã¤ã‹ã£ãŸã€Œæœ€ã‚‚ä½ã„ãƒãƒ¼ãƒ‰ãƒ«ï¼ˆæœ€ã‚‚æ—©ã„æ®µéšã§ã®é™æ ¼ï¼‰ã€ã‚’è¡¨ç¤ºã—ã¦çµ‚äº†
            }
        }

        if (!downFound) {
             rankDownMsg = `<span class="text-blue-600 font-bold">ğŸ›¡ï¸ ãƒ©ãƒ³ã‚¯ç¶­æŒåœå†…</span>`;
        }
    } else {
        rankDownMsg = `<span class="text-gray-400">ï¼ˆã“ã‚Œä»¥ä¸Šã®é™æ ¼ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</span>`;
    }

    return { up: rankUpMsg, down: rankDownMsg };
}
/**
 * [FIXED] ãƒãƒ¼ãƒ ãƒ©ãƒ³ã‚¯ã‚’è¨ˆç®—ã™ã‚‹
 * (â˜…ç”²å­åœ’æˆç¸¾(ãƒã‚¤ãƒŠã‚¹å€¤)ã‚’æ­£ã—ãè©•ä¾¡ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£)
 */
function calculateRank(teamName, state) {
    if (!teamName) return '';

    const teamData = TEAM_DATA[teamName];
    if (!teamData) {
        return 'E';
    }

    let score = 0;
    score += (teamData.deviation || 50) * 0.5;

    // 2. éå»ã®æœ€é«˜æˆç¸¾ãƒœãƒ¼ãƒŠã‚¹ (æ–‡å­—æƒ…å ±)
    const bestStr = teamData.best || '';
    if (bestStr.includes('å„ªå‹') && bestStr.includes('ç”²å­åœ’')) score += 40;
    else if (bestStr.includes('å„ªå‹')) score += 25;
    else if (bestStr.includes('æº–å„ªå‹')) score += 20;
    else if (bestStr.includes('ãƒ™ã‚¹ãƒˆ4')) score += 15;
    else if (bestStr.includes('å‡ºå ´')) score += 10;
    else if (bestStr.includes('ãƒ™ã‚¹ãƒˆ8')) score += 10;
    else if (bestStr.includes('ãƒ™ã‚¹ãƒˆ16')) score += 5;

    // 3. ç›´è¿‘ã®æˆç¸¾ãƒœãƒ¼ãƒŠã‚¹ (æ•°å€¤æƒ…å ±)
    if (state.teamRecords && state.teamRecords[teamName]) {
        const lastFinish = state.teamRecords[teamName].lastFinish;
        
        // â˜… ç”²å­åœ’æˆç¸¾ (ãƒã‚¤ãƒŠã‚¹å€¤: -1ãŒæœ€å¼·ã€-64ãŒæœ€å¼±)
        // -1 > -2 > -4 > -8 ... ãªã®ã§ã€å¤§ãã„æ–¹ãŒæˆç¸¾ãŒè‰¯ã„
        if (lastFinish < 0) {
            if (lastFinish === -1) score += 50;      // å…¨å›½å„ªå‹
            else if (lastFinish === -2) score += 45; // å…¨å›½æº–å„ªå‹
            else if (lastFinish >= -4) score += 40;  // ãƒ™ã‚¹ãƒˆ4
            else if (lastFinish >= -8) score += 35;  // ãƒ™ã‚¹ãƒˆ8
            else if (lastFinish >= -16) score += 30; // ãƒ™ã‚¹ãƒˆ16
            else if (lastFinish >= -32) score += 25; // 2å›æˆ¦
            else score += 20;                        // åˆæˆ¦æ•—é€€ã§ã‚‚ç”²å­åœ’å‡ºå ´ãƒœãƒ¼ãƒŠã‚¹
        }
        // â˜… çœŒå¤§ä¼šæˆç¸¾ (ãƒ—ãƒ©ã‚¹å€¤: 1ãŒæœ€å¼·ã€64ãŒæœ€å¼±)
        else {
            if (lastFinish === 1) score += 20;       // çœŒå„ªå‹
            else if (lastFinish === 2) score += 15;
            else if (lastFinish <= 4) score += 10;
            else if (lastFinish <= 8) score += 5;
            else if (lastFinish <= 16) score += 2;
            else if (lastFinish >= 64) score -= 5;   // åˆæˆ¦æ•—é€€ãƒšãƒŠãƒ«ãƒ†ã‚£
        }
    }

    if (teamData.popularity) score += 5;

    if (score >= 60) return 'A';
    if (score >= 50) return 'B';
    if (score >= 40) return 'C';
    if (score >= 30) return 'D';
    return 'E';
}



/**
 * [UPDATED] æŒ‡å®šã•ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†ç”Ÿã™ã‚‹
 * (â˜…ãƒãƒ¼ãƒ æ•°ã«å¿œã˜ã¦ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã‚’å‹•çš„ã«èª¿æ•´)
 */
async function playBlockAnimation(blockId) {
    // ã‚¿ãƒ–UIã®æ›´æ–°
    document.querySelectorAll('.analysis-block-tab-btn').forEach(btn => {
        const isActive = btn.dataset.block === blockId;
        btn.classList.toggle('bg-cyan-500', isActive);
        btn.classList.toggle('text-white', isActive);
        btn.classList.toggle('bg-gray-700', !isActive);
        btn.classList.toggle('text-gray-400', !isActive);
    });

    const stage = document.getElementById('analysis-stage');
    const narrationTextEl = document.getElementById('analysis-narration-text');
    const analysisData = tournamentState.blockAnalysisData;

    if (!analysisData || !analysisData[blockId]) {
        stage.innerHTML = `<p class="text-center text-gray-500">åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
        narrationTextEl.textContent = '';
        return;
    }
    const narration = analysisData[blockId];
    
    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ãƒ–ãƒ­ãƒƒã‚¯ã‚µã‚¤ã‚ºã¨ãƒãƒ¼ãƒ æŠ½å‡º â˜…â˜…â˜…
    const numBlocks = 4;
    const blockSize = Math.ceil(tournamentState.teams.length / numBlocks); // 128->32, 64->16
    const blockIndex = blockId.charCodeAt(0) - 65; // A=0, B=1...
    const blockTeams = tournamentState.teams.slice(
        blockIndex * blockSize, 
        (blockIndex + 1) * blockSize
    );
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    stage.innerHTML = '';
    narrationTextEl.textContent = '';
    
    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ãƒ©ã‚¦ãƒ³ãƒ‰ã‚«ãƒ©ãƒ ã®ç”Ÿæˆ â˜…â˜…â˜…
    const numRoundsInBlock = Math.log2(blockSize); // 32->5, 16->4
    
    for (let i = 1; i <= numRoundsInBlock; i++) {
        const col = document.createElement('div');
        col.id = `r${i}-col`;
        col.className = 'round-column';
        stage.appendChild(col);
    }
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    // 1å›æˆ¦ã®æç”» (ãƒãƒ¼ãƒ ãƒšã‚¢)
    const numMatchupsR1 = blockSize / 2;
    for(let i = 0; i < numMatchupsR1; i++) { 
        const matchupEl = document.createElement('div');
        matchupEl.className = 'analysis-matchup';
        // ãƒãƒ¼ãƒ åãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºã€è¶³ã‚Šãªã„å ´åˆã¯???
        const t1 = blockTeams[i*2] || '???';
        const t2 = blockTeams[i*2+1] || '???';
        
        matchupEl.innerHTML = `
            <div class="analysis-team" data-team-name="${t1}">${t1}</div>
            <div class="analysis-team" data-team-name="${t2}">${t2}</div>
            <div class="matchup-connector"></div>
        `;
        stage.querySelector('#r1-col').appendChild(matchupEl);
    }
    
    // 2å›æˆ¦ä»¥é™ã®æç”» (ç©ºã®ç®±)
    for (let r = 2; r <= numRoundsInBlock; r++) {
        const col = stage.querySelector(`#r${r}-col`);
        const numMatchups = blockSize / Math.pow(2, r);
        for(let i = 0; i < numMatchups; i++) {
            const isLast = r === numRoundsInBlock;
            col.innerHTML += `<div class="analysis-matchup"><div class="analysis-team">???</div>${isLast ? '' : '<div class="analysis-team">???</div><div class="matchup-connector"></div>'}<div class="round-connector"></div></div>`; 
        }
    }

    await new Promise(r => setTimeout(r, 100));
    document.querySelectorAll('.analysis-team').forEach((el, i) => {
        setTimeout(() => el.classList.add('show'), i * 30);
    });

    // ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼è¡¨ç¤º
    for (let i = 0; i < narration.length; i++) {
        narrationTextEl.textContent += narration[i];
        await new Promise(r => setTimeout(r, 30));
    }
    
    // æ³¨ç›®ãƒãƒ¼ãƒ ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    blockTeams.forEach(team => {
        if (narration.includes(team)) {
            document.querySelectorAll(`.analysis-team[data-team-name="${team}"]`).forEach(el => {
                el.classList.add('highlight');
            });
        }
    });
}

// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
// â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ ã—ã¦ãã ã•ã„ â–¼â–¼â–¼
/**
 * [UPDATED] AIã«å„ãƒ–ãƒ­ãƒƒã‚¯ã®å‹¢åŠ›å›³ã‚’åˆ†æã•ã›ã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŸç¨¿ã‚’ç”Ÿæˆã•ã›ã‚‹
 * (â˜…ãƒãƒ¼ãƒ æ•°ã«å¿œã˜ã¦ãƒ–ãƒ­ãƒƒã‚¯ã‚µã‚¤ã‚ºã‚’å‹•çš„ã«è¨ˆç®—)
 */
async function generateBlockAnalysisArticle(state) {
    const { teams, seeds } = state;
    const blocks = { A: [], B: [], C: [], D: [] };

    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ãƒ–ãƒ­ãƒƒã‚¯ã‚µã‚¤ã‚º â˜…â˜…â˜…
    const numBlocks = 4;
    const blockSize = Math.ceil(teams.length / numBlocks); 
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    teams.forEach((team, i) => {
        if (i < blockSize) blocks.A.push(team); 
        else if (i < blockSize * 2) blocks.B.push(team); 
        else if (i < blockSize * 3) blocks.C.push(team); 
        else blocks.D.push(team); 
    });

    // (ä»¥ä¸‹ã€æ—¢å­˜ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
    const blockAnalysisData = {};
    for (const blockId in blocks) {
        const blockTeams = blocks[blockId];
        const teamDetails = blockTeams.map(teamName => {
            const rank = calculateRank(teamName, state);
            const isSeed = seeds.some(s => s.team === teamName);
            const teamData = TEAM_DATA[teamName];
            if (isSeed || ['A', 'B'].includes(rank)) {
                const info = teamData?.info || '';
                return `${teamName}(${rank}${isSeed ? 'S' : ''}) [èƒŒæ™¯: ${info.substring(0, 40)}...]`;
            } else {
                return `${teamName}(${rank})`;
            }
        }).join(', ');
        blockAnalysisData[blockId] = teamDetails;
    }

    const prompt = `ã‚ãªãŸã¯é«˜æ ¡é‡çƒã®è§£èª¬è€…ã§ã™ã€‚ä»¥ä¸‹ã®å„ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’åˆ†æã—ã€ãã‚Œãã‚Œã®è¦‹ã©ã“ã‚ã‚’**150å­—ç¨‹åº¦**ã®ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŸç¨¿ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚

### åˆ†æå¯¾è±¡ãƒ–ãƒ­ãƒƒã‚¯ (ãƒãƒ¼ãƒ åã¨ãƒ©ãƒ³ã‚¯ã€Sã¯ã‚·ãƒ¼ãƒ‰æ ¡ã€[]å†…ã¯æ³¨ç›®æ ¡ã®èƒŒæ™¯æƒ…å ±)
- **Aãƒ–ãƒ­ãƒƒã‚¯:** ${blockAnalysisData.A}
- **Bãƒ–ãƒ­ãƒƒã‚¯:** ${blockAnalysisData.B}
- **Cãƒ–ãƒ­ãƒƒã‚¯:** ${blockAnalysisData.C}
- **Dãƒ–ãƒ­ãƒƒã‚¯:** ${blockAnalysisData.D}

### æŒ‡ç¤º
- **ç‰©èªã‚’é‡è¦–:** [èƒŒæ™¯]æƒ…å ±ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹æ³¨ç›®æ ¡ã‚’ä¸­å¿ƒã«ã€ãã®ãƒãƒ¼ãƒ ãŒæŒã¤ç‰©èªã‚„èƒŒæ™¯ã«è§¦ã‚ŒãªãŒã‚‰è§£èª¬ã—ã¦ãã ã•ã„ã€‚
- **ç°¡æ½”ã«:** å…¨ä½“ã®ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯150å­—ç¨‹åº¦ã«åã‚ã¦ãã ã•ã„ã€‚
- æœ€ã‚‚æ¿€æˆ¦åŒºã ã¨æ€ã‚ã‚Œã‚‹ã€Œæ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã€ã‚’ç‰¹å®šã—ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼ (JSON)
{
  "A": "ï¼ˆAãƒ–ãƒ­ãƒƒã‚¯ã®ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰",
  "B": "ï¼ˆBãƒ–ãƒ­ãƒƒã‚¯ã®ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰",
  "C": "ï¼ˆCãƒ–ãƒ­ãƒƒã‚¯ã®ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰",
  "D": "ï¼ˆDãƒ–ãƒ­ãƒƒã‚¯ã®ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰"
}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        return parseJsonFromText(result.candidates[0].content.parts[0].text);
    } catch (error) {
        console.error("AIãƒ–ãƒ­ãƒƒã‚¯åˆ†æè¨˜äº‹ã®ç”Ÿæˆã«å¤±æ•—:", error);
        return null;
    }
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
   

// â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚’ã€Œæ–°è¦è¿½åŠ ã€(10400è¡Œç›®ã‚ãŸã‚Šã€createNewTournament ã®ç›´å‰) â–¼â–¼â–¼

/**
 * [NEW] 128ãƒãƒ¼ãƒ åˆ¶ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®ã€Œ(BYE)ã€(ä¸æˆ¦å‹)ã‚’è‡ªå‹•å‡¦ç†ã™ã‚‹
 */
function processByes(state) {
    const r1MatchIds = Object.keys(state.matches).filter(id => id.includes('-R1-'));
    let byesProcessed = 0;

    r1MatchIds.forEach(matchId => {
        const match = state.matches[matchId];
        if (match.winner) return; // æ—¢ã«å‡¦ç†æ¸ˆã¿

        const team1 = match.team1;
        const team2 = match.team2;
        let winnerName = null;

        if (team1 === '(BYE)' && team2 !== '(BYE)') {
            winnerName = team2;
        } else if (team2 === '(BYE)' && team1 !== '(BYE)') {
            winnerName = team1;
        } else if (team1 === '(BYE)' && team2 === '(BYE)') {
            // ä¸¡æ–¹BYE (ã‚ã‚Šãˆãªã„ã¯ãšã ãŒã€å¿µã®ãŸã‚)
            match.winner = '(BYE)'; // å‹è€…ã‚‚BYE
            winnerName = '(BYE)';
        }

        if (winnerName) {
            byesProcessed++;
            match.winner = winnerName;
            match.summary = "ä¸æˆ¦å‹";
            
            // æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚ã‚‹
            const idParts = matchId.split('-');
            const side = idParts[0]; // 'L' or 'R'
            const matchNum = parseInt(idParts[2].slice(1)); // 1-32
            
            const nextRoundNum = 2; // R2
            const nextMatchId = `${side}-R${nextRoundNum}-M${Math.ceil(matchNum / 2)}`;
            const nextMatch = state.matches[nextMatchId];
            
            if (nextMatch) {
                const slot = (matchNum % 2 !== 0 ? 1 : 2); // å¥‡æ•°ãªã‚‰team1, å¶æ•°ãªã‚‰team2
                nextMatch[`team${slot}`] = winnerName;
            }
        }
    });

    if (byesProcessed > 0) {
        console.log(`${byesProcessed}ä»¶ã®ä¸æˆ¦å‹(BYE)ã‚’è‡ªå‹•å‡¦ç†ã—ã¾ã—ãŸã€‚`);
        // BYEå‡¦ç†å¾Œã«ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚’å†æç”»
        renderTournament(state);
        saveState();
    }
}
// â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

/**
 * æ–°ã—ã„ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’é–‹å§‹ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
 * (â˜…BYE 16æ å›ºå®šé…ç½®ã€â˜…R2-R4çƒå ´ã‚·ãƒ£ãƒƒãƒ•ãƒ« ã«å¯¾å¿œã—ãŸæœ€çµ‚ç‰ˆ)
 */
async function createNewTournament(isNext = false, nextTournamentType = 'summer', predeterminedTeams = null) {
    setupEl.classList.add('hidden');
    tournamentDisplayEl.classList.remove('hidden');

    if (tournamentState.teamRecords) {
        for (const teamName in tournamentState.teamRecords) {
            const record = tournamentState.teamRecords[teamName];
            record.tournamentStats = { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0, sb: 0, r: 0, so: 0 };
        }
    }
    
    autumnControls.classList.add('hidden');
    startMainTournamentBtn.classList.add('hidden');
    startRankingPlayoffsBtn.classList.add('hidden');

    if (isNext && tournamentState.teamRecords) {
        for (const teamName in tournamentState.teamRecords) {
            if (tournamentState.teamRecords.hasOwnProperty(teamName)) {
                const record = tournamentState.teamRecords[teamName];
                record.previousRank = record.lastFinish;
                record.wins = 0;
                record.losses = 0;
            }
        }
    }
    
    mainBracketWrapper.classList.remove('hidden');
    tournamentState.is16team = false;
    tournamentState.currentTournament = nextTournamentType;
    
    const numTeamsInTournament = 128;
    const finalRound = 7;

    if (isNext) { 
        if (nextTournamentType === 'summer') {
            tournamentState.tournamentYear++;
        }
    }
    
    if (!isNext) { 
        tournamentState.tournamentYear = 2025;
        tournamentState.teamRecords = {};
        const initialAiEnabled = document.getElementById('initial-ai-generation-toggle').checked;
        tournamentState.settings = { 
            enableArticleGeneration: initialAiEnabled, 
            enableBbsGeneration: initialAiEnabled 
        };
        tournamentState.homepageNews = []; 
        INITIAL_TEAM_POOL.forEach(t => {
            const historicalRank = getRankFromHistoryString(TEAM_DATA[t].last);
            tournamentState.teamRecords[t] = { 
                wins: 0, losses: 0, best: null, history: [],
                lastFinish: historicalRank, 
                previousRank: null,
                teamTraits: [], 
                previousStarters: null,
                roster: null,
                playerStats: { batting: {}, pitching: {} },
                tournamentStats: { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0, sb: 0, r: 0, so: 0 } 
            };
        });
    }
    
    let teams;
    let seeds = [];

    // (ã‚·ãƒ¼ãƒ‰æ ¡ã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
    if (isNext) { 
        const lastTournamentTeams = Object.keys(tournamentState.teamRecords)
            .map(teamName => ({ name: teamName, ...tournamentState.teamRecords[teamName] }))
            .sort((a, b) => a.lastFinish - b.lastFinish); 
        seeds = lastTournamentTeams.slice(0, 8).map((t, i) => ({ team: t.name, rank: i + 1 })); 
    } else { 
        const historicalRanks = INITIAL_TEAM_POOL.map(teamName => ({ name: teamName, rank: getRankFromHistoryString(TEAM_DATA[teamName].last) }));
        const setInitialSeedRank = (teamName) => {
            if (teamName === '283å­¦åœ’') return 1; if (teamName === 'å¸¸è‘‰èŠå·') return 2;
            if (teamName === 'é™å²¡') return 3; if (teamName === 'æ›å·è¥¿') return 4;
            const rank = historicalRanks.find(hr => hr.name === teamName)?.rank || 128;
            if (rank === 8) return 8; return rank;
        };
        const adjustedHistoricalRanks = INITIAL_TEAM_POOL.map(teamName => ({ name: teamName, rank: setInitialSeedRank(teamName) }));
        adjustedHistoricalRanks.sort((a, b) => a.rank - b.rank);
        seeds = adjustedHistoricalRanks.slice(0, 8).map((t, i) => ({ team: t.name, rank: i + 1 }));
    }
    
    // (çµ„ã¿åˆã‚ã›ã®æ±ºå®š)
    if (predeterminedTeams) {
        teams = predeterminedTeams;
    } else {
        const seedTeamsList = seeds.map(s => s.team);
        
        // â˜…â˜…â˜… [NEW] 112æ ¡é¸æŠœ + 16BYEå›ºå®šé…ç½®ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        
        // 1. å…¨ãƒãƒ¼ãƒ (112æ ¡)ã‹ã‚‰ã‚·ãƒ¼ãƒ‰(8æ ¡)ã‚’é™¤ã
        let nonSeeds = INITIAL_TEAM_POOL.filter(t => !seedTeamsList.includes(t)); // 104æ ¡
        nonSeeds = shuffleArray(nonSeeds);
        
        teams = Array(numTeamsInTournament).fill(null); // 128ã‚¹ãƒ­ãƒƒãƒˆ
        
        // 2. ã‚·ãƒ¼ãƒ‰æ ¡ï¼ˆ8æ ¡ï¼‰ã‚’å›ºå®šé…ç½® (å„16ãƒãƒ¼ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã®å…ˆé ­)
        const seedPositions = [0, 16, 32, 48, 64, 80, 96, 112]; 
        
        const seedPlacements = {};
        const rank1_4 = seeds.filter(s => s.rank <= 4).sort((a, b) => a.rank - b.rank);
        seedPlacements[seedPositions[0]] = rank1_4.find(s => s.rank === 1).team; // A (0)
        seedPlacements[seedPositions[4]] = rank1_4.find(s => s.rank === 2).team; // C (64)
        seedPlacements[seedPositions[2]] = rank1_4.find(s => s.rank === 4).team; // B (32)
        seedPlacements[seedPositions[6]] = rank1_4.find(s => s.rank === 3).team; // D (96)
        const rank5_8 = shuffleArray(seeds.filter(s => s.rank > 4));
        const remainingSeedSlots = [16, 80, 48, 112]; // æ®‹ã‚Šã®ã‚·ãƒ¼ãƒ‰æ 
        rank5_8.forEach((seed, i) => { seedPlacements[remainingSeedSlots[i]] = seed.team; });
        for (const position in seedPlacements) { teams[position] = seedPlacements[position]; }

        // 3. BYEï¼ˆ16æ ¡ï¼‰ã‚’å›ºå®šé…ç½®
        // (å„16ãƒãƒ¼ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚·ãƒ¼ãƒ‰æ ¡ãŒã„ãªã„å±±ã«2ã¤ãšã¤)
        const byePositions = [
            4, 12,  // 1ã‚·ãƒ¼ãƒ‰ (0) ã®å±±
            20, 28, // 5-8ã‚·ãƒ¼ãƒ‰ (16) ã®å±±
            36, 44, // 4ã‚·ãƒ¼ãƒ‰ (32) ã®å±±
            52, 60, // 5-8ã‚·ãƒ¼ãƒ‰ (48) ã®å±±
            68, 76, // 2ã‚·ãƒ¼ãƒ‰ (64) ã®å±±
            84, 92, // 5-8ã‚·ãƒ¼ãƒ‰ (80) ã®å±±
            100, 108, // 3ã‚·ãƒ¼ãƒ‰ (96) ã®å±±
            116, 124  // 5-8ã‚·ãƒ¼ãƒ‰ (112) ã®å±±
        ];
        byePositions.forEach(slot => { teams[slot] = '(BYE)'; });
        
        // 4. ãƒãƒ¼ã‚·ãƒ¼ãƒ‰æ ¡ï¼ˆ104æ ¡ï¼‰ã‚’ã€æ®‹ã‚Šã® 104 ã‚¹ãƒ­ãƒƒãƒˆã«é…ç½®
        const teamsToPlace = shuffleArray(nonSeeds); // 104æ ¡
        
        let nonSeedIndex = 0;
        for (let i = 0; i < numTeamsInTournament; i++) {
            if (teams[i] === null) { // ã‚¹ãƒ­ãƒƒãƒˆãŒç©ºï¼ˆã‚·ãƒ¼ãƒ‰ã§ã‚‚BYEã§ã‚‚ãªã„ï¼‰
                if(nonSeedIndex < teamsToPlace.length) {
                    teams[i] = teamsToPlace[nonSeedIndex];
                    nonSeedIndex++;
                }
            }
        }
        
        if (nonSeedIndex !== 104) {
             console.error(`æŠ½é¸ãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: 104æ ¡ã‚’é…ç½®ã™ã‚‹äºˆå®šã§ã—ãŸãŒã€${nonSeedIndex}æ ¡ã—ã‹é…ç½®ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚`);
        }
    }
    
    // (ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆstateã®åˆæœŸåŒ– ... å¤‰æ›´ãªã—)
    tournamentState.teams = teams;
    tournamentState.matches = {};
    tournamentState.news = [];
    tournamentState.documentary = { target: null, type: null };
    tournamentState.activeScandal = null;
    tournamentState.seeds = seeds; 
    tournamentState.bbsComments = [];
    tournamentState.daiyaBbsComments = [];
    tournamentState.tickerHeadlines = []; 
    tournamentState.rivalries = RIVALRIES;
    tournamentState.feuds = tournamentState.feuds || []; 
    tournamentState.namcoNews = null;
    tournamentState.preGameComments = {};
    tournamentState.matomeThreads = {}; 
    tournamentState.userThreads = [];
    tournamentState.autumnData = { regions: {} };
    tournamentState.springData = { regions: {} };

    // (R1ã®è©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ ... å¤‰æ›´ãªã—)
    const round1Setup = teams.reduce((acc, team, i) => {
        if (i % 2 === 0) acc.push({ team1: team, team2: null });
        else acc[acc.length - 1].team2 = team;
        return acc;
    }, []);
    round1Setup.forEach((match, index) => {
        const side = index < 32 ? 'L' : 'R';
        const matchNum = index < 32 ? index + 1 : index - 31;
        const matchId = `${side}-R1-M${matchNum}`;
        const rivalryType = checkRivalry(match.team1, match.team2);
        tournamentState.matches[matchId] = { id: matchId, team1: match.team1, team2: match.team2, winner: null, score1: '', score2: '', details: null, summary: '', rivalryType: rivalryType };
    });

    // (R2ã€œR6, Fã®ç©ºã®ç®±ã‚’ä½œæˆ ... å¤‰æ›´ãªã—)
    for (let r = 2; r < finalRound; r++) {
        const numMatchesInRound = numTeamsInTournament / Math.pow(2, r);
        for (let m = 1; m <= numMatchesInRound / 2; m++) {
            const matchIdL = `L-R${r}-M${m}`;
            tournamentState.matches[matchIdL] = { id: matchIdL, team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '', prevMatch1Id: `L-R${r-1}-M${(m*2)-1}`, prevMatch2Id: `L-R${r-1}-M${(m*2)}` };
            const matchIdR = `R-R${r}-M${m}`;
            tournamentState.matches[matchIdR] = { id: matchIdR, team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '', prevMatch1Id: `R-R${r-1}-M${(m*2)-1}`, prevMatch2Id: `R-R${r-1}-M${(m*2)}` };
        }
    }
    tournamentState.matches['F-R1-M1'] = { id: 'F-R1-M1', team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '', prevMatch1Id: `L-R${finalRound-1}-M1`, prevMatch2Id: `R-R${finalRound-1}-M1` };
    
    // --- 3. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ (â˜…R2-R4ã®çƒå ´ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«) ---
    let datesR1, datesR2, datesR3, datesR4, datesR5, datesR6, dateFinal;
    if (nextTournamentType === 'autumn') {
        datesR1 = ["9/10", "9/11", "9/12", "9/13"];
        datesR2 = ["9/15", "9/16"];
        datesR3 = ["9/18", "9/19"];
        datesR4 = ["9/21"];
        datesR5 = ["9/23"];
        datesR6 = ["9/25"];
        dateFinal = ["9/27"];
    } else if (nextTournamentType === 'spring') {
        datesR1 = ["4/10", "4/11", "4/12", "4/13"];
        datesR2 = ["4/15", "4/16"];
        datesR3 = ["4/18", "4/19"];
        datesR4 = ["4/21"];
        datesR5 = ["4/23"];
        datesR6 = ["4/25"];
        dateFinal = ["4/27"];
    } else {
        datesR1 = ["7/10", "7/11", "7/12", "7/13"];
        datesR2 = ["7/15", "7/16"];
        datesR3 = ["7/18", "7/19"];
        datesR4 = ["7/21"];
        datesR5 = ["7/23"];
        datesR6 = ["7/25"];
        dateFinal = ["7/27"];
    }
    
    // (R1ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ ... å¤‰æ›´ãªã—)
    const matchIdsR1 = Object.keys(tournamentState.matches).filter(id => id.includes('-R1-'));
    let fullScheduleQueueR1 = [];
    for (const date of datesR1) {
        for (const stadium of STADIUM_DATA) { 
            for (let i = 1; i <= 2; i++) { fullScheduleQueueR1.push({ date: date, stadium: stadium.abbr, stadiumFull: stadium.name, region: stadium.region, gameNum: i }); }
        }
    }
    fullScheduleQueueR1 = shuffleArray(fullScheduleQueueR1);
    const seedMatchIds = [];
    const normalMatchIds = [];
    const seedTeamsList = tournamentState.seeds.map(s => s.team); 
    matchIdsR1.forEach(matchId => {
        const match = findMatchById(matchId);
        if (match && (seedTeamsList.includes(match.team1) || seedTeamsList.includes(match.team2))) { seedMatchIds.push(matchId); } 
        else { normalMatchIds.push(matchId); }
    });
    seedMatchIds.forEach(matchId => {
        const match = findMatchById(matchId); if (!match) return;
        let targetRegion = null; let preferredStadiumAbbr = null;
        if (match.team1 === "é™å²¡" || match.team2 === "é™å²¡") { preferredStadiumAbbr = STADIUM_DATA[0].abbr; targetRegion = STADIUM_DATA[0].region; }
        else if (match.team1 === "æ›å·è¥¿" || match.team2 === "æ›å·è¥¿") { preferredStadiumAbbr = STADIUM_DATA[6].abbr; targetRegion = STADIUM_DATA[6].region; }
        else {
            const seedTeamName = seedTeamsList.includes(match.team1) ? match.team1 : match.team2;
            const seedTeamData = TEAM_DATA[seedTeamName];
            if (seedTeamData) { targetRegion = seedTeamData.region; if (targetRegion === 'ä¼Šè±†') targetRegion = 'æ±éƒ¨'; }
        }
        let schedule; let foundSlotIndex = -1;
        if (preferredStadiumAbbr) { foundSlotIndex = fullScheduleQueueR1.findIndex(s => s.stadium === preferredStadiumAbbr); }
        if (foundSlotIndex === -1 && targetRegion) { foundSlotIndex = fullScheduleQueueR1.findIndex(s => s.region === targetRegion); }
        if (foundSlotIndex === -1 && (preferredStadiumAbbr === STADIUM_DATA[0].abbr || preferredStadiumAbbr === STADIUM_DATA[6].abbr)) {
             let fallbackSlotIndex = fullScheduleQueueR1.findIndex(s => s.region === 'æ±éƒ¨');
             if (fallbackSlotIndex !== -1) { schedule = fullScheduleQueueR1.splice(fallbackSlotIndex, 1)[0]; }
             else { schedule = fullScheduleQueueR1.shift(); }
        } else if (foundSlotIndex !== -1) { schedule = fullScheduleQueueR1.splice(foundSlotIndex, 1)[0]; }
        else { schedule = fullScheduleQueueR1.shift(); }
        if (schedule) { match.schedule = { date: schedule.date, stadium: schedule.stadium, stadiumFull: schedule.stadiumFull, game: schedule.gameNum }; }
    });
    normalMatchIds.forEach(matchId => {
        const match = findMatchById(matchId); if (!match) return;
        const data1 = TEAM_DATA[match.team1]; const data2 = TEAM_DATA[match.team2];
        let targetRegion = 'ä¸­éƒ¨'; 
        if (data1 && data2) {
            const region1 = data1.region; const region2 = data2.region;
            if (region1 === region2) targetRegion = region1;
            else if ((region1 === 'æ±éƒ¨' && region2 === 'è¥¿éƒ¨') || (region1 === 'è¥¿éƒ¨' && region2 === 'æ±éƒ¨')) targetRegion = 'ä¸­éƒ¨';
            else if ((region1 === 'æ±éƒ¨' && region2 === 'ä¸­éƒ¨') || (region1 === 'ä¸­éƒ¨' && region2 === 'æ±éƒ¨')) targetRegion = 'ä¸­éƒ¨';
            else if ((region1 === 'è¥¿éƒ¨' && region2 === 'ä¸­éƒ¨') || (region1 === 'ä¸­éƒ¨' && region2 === 'è¥¿éƒ¨')) targetRegion = 'è¥¿éƒ¨';
            else if (region1 === 'ä¼Šè±†' || region2 === 'ä¼Šè±†') targetRegion = 'æ±éƒ¨';
            if (targetRegion === 'ä¼Šè±†') targetRegion = 'æ±éƒ¨';
        }
        let foundSlotIndex = fullScheduleQueueR1.findIndex(s => s.region === targetRegion);
        let schedule;
        if (foundSlotIndex === -1) { schedule = fullScheduleQueueR1.shift(); }
        else { schedule = fullScheduleQueueR1.splice(foundSlotIndex, 1)[0]; }
        if (schedule) { match.schedule = { date: schedule.date, stadium: schedule.stadium, stadiumFull: schedule.stadiumFull, game: schedule.gameNum }; }
    });
    
    // (R2ä»¥é™ã®å‰²ã‚Šå½“ã¦ ... â˜…çƒå ´ãƒªã‚¹ãƒˆã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«)
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R2-')), 
        datesR2, shuffleArray(STADIUM_DATA), 2 // R2 (32è©¦åˆ) -> å…¨10çƒå ´ (ã‚·ãƒ£ãƒƒãƒ•ãƒ«)
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R3-')), 
        datesR3, shuffleArray(ROUND_3_STADIUMS), 2 // R3 (16è©¦åˆ) -> ä¸»è¦4çƒå ´ (ã‚·ãƒ£ãƒƒãƒ•ãƒ«)
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R4-')), 
        datesR4, shuffleArray(ROUND_3_STADIUMS), 2 // R4 (8è©¦åˆ) -> ä¸»è¦4çƒå ´ (ã‚·ãƒ£ãƒƒãƒ•ãƒ«)
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R5-')), 
        datesR5, shuffleArray(QUARTER_FINAL_STADIUMS), 4 // R5 (æº–ã€… 4è©¦åˆ) -> 2çƒå ´ (ã‚·ãƒ£ãƒƒãƒ•ãƒ«)
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R6-')), 
        datesR6, FINAL_STAGE_STADIUMS, 2 // R6 (æº–æ±º 2è©¦åˆ) -> ãƒ¡ã‚¤ãƒ³çƒå ´
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.startsWith('F-R1-')), 
        dateFinal, FINAL_STAGE_STADIUMS, 1 // æ±ºå‹ (1è©¦åˆ) -> ãƒ¡ã‚¤ãƒ³çƒå ´
    );
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
    
    // 4. ç”»é¢ã¨AIã®åˆæœŸåŒ–
    renderTournament(tournamentState); 
    
    // 5. ä¸æˆ¦å‹(BYE)ã®è‡ªå‹•å‡¦ç†
    processByes(tournamentState);
    
    // 6. AIç”Ÿæˆ (å¤‰æ›´ãªã—)
    if (tournamentState.settings.enableArticleGeneration) {
        (async () => {
            const newFeuds = await generateDynamicFeuds(tournamentState);
            if (newFeuds && newFeuds.length > 0) {
                tournamentState.feuds.push(...newFeuds);
                saveState(); 
                renderTournament(tournamentState); 
                const feudTitles = newFeuds.map(f => `ã€Œ${f.teams[0]} vs ${f.teams[1]} (${f.type})ã€`).join('ã€');
                tournamentState.news.push({
                    title: "ã€é€Ÿå ±ã€‘ä»Šå¤§ä¼šã®ã€Œå› ç¸ã®å¯¾æ±ºã€ãŒæ±ºå®šï¼",
                    body: `å¤§ä¼šæœ¬éƒ¨ã¯ã€AIè§£èª¬è€…ã®åˆ†æã«åŸºã¥ãã€ä»Šå¤§ä¼šã®æ³¨ç›®ã™ã¹ãã€Œå› ç¸ã®å¯¾æ±ºã€ã‚’ç™ºè¡¨ã—ãŸã€‚\n${feudTitles}ãªã©ã€1å›æˆ¦ã‹ã‚‰ç›®ãŒé›¢ã›ãªã„æˆ¦ã„ãŒç¶šãã€‚`,
                    timestamp: Date.now()
                });
                renderNews(tournamentState.news);
            }
        })();

        saveState(); 
        renderTournament(tournamentState); 
        const currentTournamentName = tournamentNameMap[tournamentState.currentTournament];
        newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒ${currentTournamentName}ã®çµ„ã¿åˆã‚ã›ã¨å±•æœ›ã‚’åˆ†æä¸­...</div>`;
        bbsCommentsContainer.innerHTML = `<div class="loader">AIãŒçµ„ã¿åˆã‚ã›ã‚’åˆ†æä¸­...</div>`;
        namcoNewsSection.classList.remove('hidden');
        namcoNewsContent.innerHTML = `<div class="loader">ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ã‚’ç¢ºèªä¸­...</div>`;
        let analysisArticlePromise = generateBracketAnalysisNewsArticle(tournamentState);
        let bracketBbsPromise = generateBracketBbsThread(tournamentState); 
        try {
            const topicArticles = await generateTopicSchoolArticles(tournamentState); 
            if (topicArticles && topicArticles.length > 0) {
                tournamentState.news.push(...topicArticles); 
            }
        } catch (e) { console.error("è©±é¡Œæ ¡ç´¹ä»‹è¨˜äº‹ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", e); }
        const [namcoNews, analysisArticle, bracketBbsResult] = await Promise.all([
            generateNamcoNews(tournamentState, 'bracket'),
            analysisArticlePromise,
            bracketBbsPromise
        ]);
        if (analysisArticle && !analysisArticle.error) { tournamentState.news.unshift(analysisArticle); }
        else if (analysisArticle && analysisArticle.error) { tournamentState.news.unshift(analysisArticle); }
        if (bracketBbsResult && !bracketBbsResult.error) { tournamentState.bbsComments.push(bracketBbsResult); }
        else if (bracketBbsResult && bracketBbsResult.error) { tournamentState.bbsComments.push({ ...bracketBbsResult, context: { isBracketThread: true } }); }
        if (namcoNews) tournamentState.namcoNews = namcoNews;
        renderNews(tournamentState.news);
        renderBbsComments(tournamentState.bbsComments); 
        renderNamcoNews(tournamentState.namcoNews);
        saveState();
    } else {
        saveState(); 
        renderTournament(tournamentState); 
        newsContainer.innerHTML = `<p class="text-gray-500 text-center">ï¼ˆAIã«ã‚ˆã‚‹è‡ªå‹•è¨˜äº‹ç”Ÿæˆã¯ç¾åœ¨ã‚ªãƒ•ã§ã™ã€‚è¨­å®š âš™ï¸ ã‹ã‚‰ã‚ªãƒ³ã«ã§ãã¾ã™ï¼‰</p>`;
        bbsCommentsContainer.innerHTML = `<p class="text-gray-500 text-center">ï¼ˆAIã«ã‚ˆã‚‹æ²ç¤ºæ¿ç”Ÿæˆã¯ç¾åœ¨ã‚ªãƒ•ã§ã™ã€‚è¨­å®š âš™ï¸ ã‹ã‚‰ã‚ªãƒ³ã«ã§ãã¾ã™ï¼‰</p>`;
        namcoNewsSection.classList.add('hidden');
    }
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * AIã«çµ„ã¿åˆã‚ã›æŠ½é¸æ™‚ã«ã€Œè©±é¡Œæ ¡ç´¹ä»‹ã€ã®è¨˜äº‹ã‚’æ•°æœ¬ç”Ÿæˆã•ã›ã‚‹
 * (â˜…E, D, C, B, Aãƒ©ãƒ³ã‚¯ã‹ã‚‰å„1æ ¡ãšã¤ã€è¨ˆ5æ ¡ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—)
 * (â˜…â˜…AIç”Ÿæˆå¤±æ•—æ™‚ã«ã€Œã‚¨ãƒ©ãƒ¼è¨˜äº‹ã€ã¨ã—ã¦æç”»ã—ã€å†ç”Ÿæˆã‚’å¯èƒ½ã«ã™ã‚‹æœ€çµ‚ç‰ˆâ˜…â˜…)
 * @param {object} state - tournamentState
 * @returns {Promise<Array<object>>} - ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã¾ãŸã¯ã‚¨ãƒ©ãƒ¼è¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã®é…åˆ—
 */
async function generateTopicSchoolArticles(state) {
    const { teams, seeds } = state;
    if (!teams || teams.length === 0) return [];

    const articles = [];
    const getTeamRank = (teamName) => calculateRank(teamName, state);
    
    // ãƒãƒ¼ãƒ ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ« (åŒã˜ãƒ©ãƒ³ã‚¯ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶ãŸã‚)
    const shuffledTeams = shuffleArray(teams); 

    // ãƒ©ãƒ³ã‚¯åˆ¥ã«ãƒãƒ¼ãƒ ã‚’åˆ†é¡
    const teamsByRank = { 'A': [], 'B': [], 'C': [], 'D': [], 'E': [] };
    shuffledTeams.forEach(team => {
        const rank = getTeamRank(team);
        teamsByRank[rank].push(team);
    });

    // --- å„ãƒ©ãƒ³ã‚¯ã‹ã‚‰1æ ¡ãšã¤é¸ã‚“ã§è¨˜äº‹ã‚’ç”Ÿæˆ ---

    // 1. Eãƒ©ãƒ³ã‚¯æ ¡ã®è¨˜äº‹ (ãƒ†ãƒ¼ãƒ: æ‚²é¡˜ã®åˆæˆ¦çªç ´ã¸)
    const teamE = teamsByRank['E'][0];
    if (teamE) {
        const article = await createTopicArticle(teamE, getTeamRank(teamE), 'E');
        if (article) {
            articles.push(article);
        } else {
            // â–¼â–¼â–¼ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›: å¤±æ•—ã—ãŸå ´åˆã€ã‚¨ãƒ©ãƒ¼è¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ â–¼â–¼â–¼
            articles.push({
                title: `è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${teamE})`,
                body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(),
                error: true,
                isTopicArticle: true, // ã“ã‚Œã‚‚è©±é¡Œæ ¡è¨˜äº‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™
                context: { teamName: teamE, theme: 'E' } // â˜…å†ç”Ÿæˆç”¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            });
            // â–²â–²â–²
        }
    }

    // 2. Dãƒ©ãƒ³ã‚¯æ ¡ã®è¨˜äº‹ (ãƒ†ãƒ¼ãƒ: èºé€²ã®ãƒ™ã‚¹ãƒˆ8ã¸)
    const teamD = teamsByRank['D'][0];
    if (teamD) {
        const article = await createTopicArticle(teamD, getTeamRank(teamD), 'D');
        if (article) {
            articles.push(article);
        } else {
            articles.push({
                title: `è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${teamD})`,
                body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(),
                error: true,
                isTopicArticle: true, 
                context: { teamName: teamD, theme: 'D' } 
            });
        }
    }

    // 3. Cãƒ©ãƒ³ã‚¯æ ¡ã®è¨˜äº‹ (ãƒ†ãƒ¼ãƒ: ç”²å­åœ’å‡ºå ´ã¨ã„ã†æ‚²é¡˜ã¸)
    const teamC = teamsByRank['C'][0];
    if (teamC) {
        const article = await createTopicArticle(teamC, getTeamRank(teamC), 'C');
        if (article) {
            articles.push(article);
        } else {
            articles.push({
                title: `è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${teamC})`,
                body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(),
                error: true,
                isTopicArticle: true, 
                context: { teamName: teamC, theme: 'C' } 
            });
        }
    }

    // 4. Bãƒ©ãƒ³ã‚¯æ ¡ã®è¨˜äº‹ (ãƒ†ãƒ¼ãƒ: æ‰“å€’Aãƒ©ãƒ³ã‚¯ã¸)
    const teamB = teamsByRank['B'][0];
    if (teamB) {
        const article = await createTopicArticle(teamB, getTeamRank(teamB), 'B');
        if (article) {
            articles.push(article);
        } else {
            articles.push({
                title: `è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${teamB})`,
                body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(),
                error: true,
                isTopicArticle: true, 
                context: { teamName: teamB, theme: 'B' } 
            });
        }
    }

    // 5. Aãƒ©ãƒ³ã‚¯æ ¡ã®è¨˜äº‹ (ãƒ†ãƒ¼ãƒ: ç‹è€…ã®é“)
    const teamA = teamsByRank['A'][0];
    if (teamA) {
        const article = await createTopicArticle(teamA, getTeamRank(teamA), 'A');
        if (article) {
            articles.push(article);
        } else {
            articles.push({
                title: `è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${teamA})`,
                body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(),
                error: true,
                isTopicArticle: true, 
                context: { teamName: teamA, theme: 'A' } 
            });
        }
    }

    // å¤±æ•—ã—ãŸè¨˜äº‹(ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)ã‚‚ãã®ã¾ã¾è¿”ã™ãŸã‚ã€.filter(Boolean) ã¯å‰Šé™¤
    return articles;
}

/**
 * generateTopicSchoolArticles ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã€‚
 * 1æ ¡ã‚’é¸ã³ã€ãƒ©ãƒ³ã‚¯ã«å¿œã˜ãŸãƒ†ãƒ¼ãƒã§è¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹ã€‚
 * (â˜…BYEã®å ´åˆã¯ã€Œ2å›æˆ¦ã‹ã‚‰ç™»å ´ã€ã¨ç´¹ä»‹ã™ã‚‹ä¿®æ­£ç‰ˆ)
 * @param {string} teamName - é¸ã°ã‚ŒãŸãƒãƒ¼ãƒ å
 * @param {string} rank - ãƒãƒ¼ãƒ ãƒ©ãƒ³ã‚¯ (A, B, C, D, E)
 * @param {'E' | 'D' | 'C' | 'B' | 'A'} theme - è¨˜äº‹ã®ãƒ†ãƒ¼ãƒ
 * @returns {Promise<object|null>} - ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
async function createTopicArticle(teamName, rank, theme) {
    const teamData = TEAM_DATA[teamName];
    const teamRecord = tournamentState.teamRecords[teamName];
    const detailedData = DETAILED_TEAM_DATA[teamName];
    const lore = PREFECTURE_LORE; 

    // 1. ãƒ©ãƒ³ã‚¯è¨˜å·ã‚’æ—¥æœ¬èªã®èª¬æ˜ã«å¤‰æ›
    const rankDescription = getRankDescription(rank); 
    
    // 2. ã‚·ãƒ¼ãƒ‰æ ¡ã‹åˆ¤å®š
    const isSeed = tournamentState.seeds.some(s => s.team === teamName);
    const seedRankString = isSeed ? getSeedRankString(teamName, tournamentState.seeds) : '';

    // 3. åŸºæœ¬æƒ…å ±ã‚’ä½œæˆ
    let contextInfo = `
- **ãƒãƒ¼ãƒ å:** ${teamName} ${seedRankString} (${rankDescription})
- **ãƒãƒ¼ãƒ èƒŒæ™¯(info):** ${teamData.info || 'æƒ…å ±ãªã—'}
- **ç›£ç£:** ${teamData.coach.name} (${teamData.coach.style})
- **æ˜¨å¹´ã®æˆç¸¾:** ${getRankString(teamRecord.lastFinish)}
`;
    if (detailedData) {
        contextInfo += `- **æ³¨ç›®é¸æ‰‹:** ${detailedData.players.map(p => `${p.name}(${p.year}å¹´, ${p.pos}) - ${p.desc}`).join('ã€ ')}\n`;
    }

    // 4. â˜…â˜…â˜… åˆæˆ¦æƒ…å ±ã®åˆ¤å®šï¼ˆä¿®æ­£ç®‡æ‰€ï¼‰ â˜…â˜…â˜…
    const firstMatch = Object.values(tournamentState.matches).find(m => 
        m.id.includes('-R1-') && (m.team1 === teamName || m.team2 === teamName)
    );
    
    let firstMatchInfo = '';
    let isByeStart = false; // 2å›æˆ¦ã‹ã‚‰ç™»å ´ãƒ•ãƒ©ã‚°

    if (firstMatch) {
        const opponentName = firstMatch.team1 === teamName ? firstMatch.team2 : firstMatch.team1;
        
        // â–¼â–¼â–¼ BYEï¼ˆä¸æˆ¦å‹ï¼‰ã®åˆ¤å®š â–¼â–¼â–¼
        if (opponentName === '(BYE)') {
            isByeStart = true;
            firstMatchInfo = `
- **åˆæˆ¦æƒ…å ±:**
  - **å¯¾æˆ¦ç›¸æ‰‹:** (BYE) ä¸æˆ¦å‹
  - **çŠ¶æ³:** è¦å®šã«ã‚ˆã‚Š1å›æˆ¦ã¯å…é™¤ã•ã‚Œã€**ã€Œ2å›æˆ¦ã‹ã‚‰ã®ç™»å ´ã€**ã¨ãªã‚Šã¾ã™ã€‚ä»–ãƒãƒ¼ãƒ ã‚ˆã‚Šæ—¥ç¨‹ã«ä½™è£•ãŒã‚ã‚Šã€èª¿æ•´é¢ã§æœ‰åˆ©ã§ã™ã€‚
`;
        } else {
            // é€šå¸¸ã®å¯¾æˆ¦ç›¸æ‰‹
            const opponentRankDesc = getRankDescription(calculateRank(opponentName, tournamentState)); 
            const opponentSeedRank = getSeedRankString(opponentName, tournamentState.seeds);
            let scheduleInfo = 'æ—¥ç¨‹ãƒ»çƒå ´æœªå®š';
            if (firstMatch.schedule) {
                const gameNumIcon = ['â‘ ', 'â‘¡', 'â‘¢', 'â‘£'][firstMatch.schedule.game - 1] || `(ç¬¬${firstMatch.schedule.game}è©¦åˆ)`;
                scheduleInfo = `${firstMatch.schedule.date} ${firstMatch.schedule.stadiumFull} ${gameNumIcon}`;
            }
            firstMatchInfo = `
- **åˆæˆ¦æƒ…å ±:**
  - **å¯¾æˆ¦ç›¸æ‰‹:** ${opponentName} ${opponentSeedRank} (${opponentRankDesc})
  - **æ—¥ç¨‹:** ${scheduleInfo}
`;
        }
        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    }
    contextInfo += firstMatchInfo;

    // ãƒ†ãƒ¼ãƒã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
    let prompt = `ã‚ãªãŸã¯ã€Œã‚¹ãƒãƒ¼ãƒ„å ±çŸ¥ã€ã®é«˜æ ¡é‡çƒæ‹…å½“è¨˜è€…ã§ã™ã€‚
å¤ã®é™å²¡å¤§ä¼šã®çµ„ã¿åˆã‚ã›ãŒæ±ºå®šã—ã¾ã—ãŸã€‚
ã‚ãªãŸã¯ä»Šã€ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ãŸã€Œè©±é¡Œæ ¡ã€ã®ç´¹ä»‹è¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ã„ã¾ã™ã€‚
ä»¥ä¸‹ã®ã€å–æãƒ‡ãƒ¼ã‚¿ã€‘ã¨ã€åŸ·ç­†ãƒ†ãƒ¼ãƒã€‘ã«åŸºã¥ãã€æƒ…æ™¯ã‚„é¸æ‰‹ã®èƒŒæ™¯ï¼ˆç‰©èªï¼‰ãŒç›®ã«æµ®ã‹ã¶ã‚ˆã†ãªãƒªã‚¢ãƒ«ãªç´¹ä»‹è¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### å–æãƒ‡ãƒ¼ã‚¿
${contextInfo}

### é™å²¡çœŒã®å¸¸è­˜ï¼ˆã‚ãªãŸã®çŸ¥è­˜ï¼‰
${lore}

`;

    // å„ãƒ†ãƒ¼ãƒã®æŒ‡ç¤ºæ–‡
    if (theme === 'E') {
        prompt += `
### åŸ·ç­†ãƒ†ãƒ¼ãƒï¼šã€Œæ‚²é¡˜ã®åˆæˆ¦çªç ´ã¸ã€
- ã“ã®ãƒãƒ¼ãƒ ï¼ˆ${rankDescription}ï¼‰ã®ç›®æ¨™ã¯ã€ã¾ãšã€Œå¤ã«1å‹ã€ã™ã‚‹ã“ã¨ã§ã™ã€‚
- ãã®ãƒãƒ¼ãƒ ãŒæŠ±ãˆã‚‹**ç‰¹æœ‰ã®äº‹æƒ…**ï¼ˆä¾‹ï¼šæµœæ¾ç‰¹æ”¯ã®å‰µéƒ¨èƒŒæ™¯ã€æ–°å±…ã®0å‹32æ•—ã€å·æ ¹ã®æœ€å¾Œã®å¤ã€è™åºœå³¶ã®é›¢å³¶ãƒãƒ³ãƒ‡ãªã©ï¼‰ã‚’**è¨˜äº‹ã®ä¸­å¿ƒ**ã«æ®ãˆã¦ãã ã•ã„ã€‚
`;
    } else if (theme === 'D') {
        prompt += `
### åŸ·ç­†ãƒ†ãƒ¼ãƒï¼šã€Œèºé€²ã®ãƒ™ã‚¹ãƒˆ8ã‚’ç›®æŒ‡ã—ã¦ã€
- ã“ã®ãƒãƒ¼ãƒ ï¼ˆ${rankDescription}ï¼‰ã®ç›®æ¨™ã¯ã€å¼·è±ªã‚’å€’ã—ã¦ã€Œãƒ™ã‚¹ãƒˆ8ã€ã«é€²å‡ºã—ã€å¤§ä¼šã®ãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ã«ãªã‚‹ã“ã¨ã§ã™ã€‚
- ãƒãƒ¼ãƒ ã®**æ­´å²**ã‚„ã€æ³¨ç›®é¸æ‰‹ï¼ˆã„ãªã‘ã‚Œã°æ¶ç©ºã®æ³¨ç›®é¸æ‰‹ã‚’å‰µä½œï¼‰ã®**æˆé•·ç‰©èª**ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ãã ã•ã„ã€‚
- ç›£ç£ã‚„ä¸»å°†ã®ã€Œä»Šå¹´ã“ãã¯ã€ã¨ã„ã†ã€**ä¸‹å‰‹ä¸Šï¼ˆã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒªãƒ³ã‚°ï¼‰**ã«ã‹ã‘ã‚‹æ„æ°—è¾¼ã¿ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚
`;
    } else if (theme === 'C') {
        prompt += `
### åŸ·ç­†ãƒ†ãƒ¼ãƒï¼šã€Œç”²å­åœ’å‡ºå ´ã¨ã„ã†æ‚²é¡˜ã¸ã€
- ã“ã®ãƒãƒ¼ãƒ ï¼ˆ${rankDescription}ï¼‰ã®ç›®æ¨™ã¯ã€é™å²¡çœŒã®ã€Œæˆ¦å›½æ™‚ä»£ã€ã‚’å‹ã¡æŠœãã€ç”²å­åœ’ã«å‡ºå ´ã™ã‚‹ã“ã¨ã§ã™ã€‚
- ãƒãƒ¼ãƒ ã®ä¸­å¿ƒã¨ãªã‚‹**ã‚¨ãƒ¼ã‚¹ã‚„ä¸»è»¸é¸æ‰‹**ã«ç„¦ç‚¹ã‚’å½“ã¦ã€ãã®é¸æ‰‹ã®**è‹¦æ‚©ã€æˆé•·ã€ãã—ã¦æ±ºæ„**ã‚’æ·±ãæ˜ã‚Šä¸‹ã’ã¦ãã ã•ã„ã€‚
`;
    } else if (theme === 'B') {
        if (isSeed) {
            prompt += `
### åŸ·ç­†ãƒ†ãƒ¼ãƒï¼šã€Œæ‚²é¡˜ã®ç”²å­åœ’å‡ºå ´ã¸ï¼ãã—ã¦è–åœ°ï¼‘å‹ã‚’ã€
- ã“ã®ãƒãƒ¼ãƒ ï¼ˆ${rankDescription}, ${seedRankString}ï¼‰ã¯ã€å„ªå‹å€™è£œã«æ¬¡ãã€Œå¼·è±ªã‚·ãƒ¼ãƒ‰æ ¡ã€ã§ã™ã€‚æœ€å¤§ã®ç›®æ¨™ã¯ã€Aãƒ©ãƒ³ã‚¯æ ¡ã‚’å€’ã—ã€ã¾ãšã¯ã€Œç”²å­åœ’å‡ºå ´ã€ã®åˆ‡ç¬¦ã‚’æ´ã‚€ã“ã¨ã§ã™ã€‚`;
        } else {
            prompt += `
### åŸ·ç­†ãƒ†ãƒ¼ãƒï¼šã€Œãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã®å¼·è±ªã€ä¸‹å‰‹ä¸Šãªã‚‹ã‹ã€
- ã“ã®ãƒãƒ¼ãƒ ï¼ˆ${rankDescription}ï¼‰ã¯ã€Bãƒ©ãƒ³ã‚¯ã®åŠ›ã‚’æŒã¤ã«ã‚‚é–¢ã‚ã‚‰ãšã€ã€Œãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã€ã§ä»Šå¤§ä¼šã«è‡¨ã¿ã¾ã™ã€‚
- åºç›¤ã‹ã‚‰ã‚·ãƒ¼ãƒ‰æ ¡ã¨æ¿€çªã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€å¤§ä¼šã®ã€Œãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ã€ã¾ãŸã¯ã€Œæ³¢ä¹±è¦å› ã€ã¨ã—ã¦æ³¨ç›®ã•ã‚Œã¦ã„ã¾ã™ã€‚`;
        }
        prompt += `
- ãƒãƒ¼ãƒ ã®å¼·ã¿ï¼ˆä¾‹ï¼šå¼·åŠ›æ‰“ç·šï¼‰ã«ç„¦ç‚¹ã‚’å½“ã¦ã€ãã‚ŒãŒç”²å­åœ’å‡ºå ´ã«ã©ã†ç¹‹ãŒã‚‹ã‹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
- ãƒãƒ¼ãƒ ã®ã‚­ãƒ¼ãƒãƒ³ï¼ˆä¾‹ï¼š4ç•ªã€ã‚¨ãƒ¼ã‚¹ï¼‰ã‚’å–ã‚Šä¸Šã’ã€å½¼/å½¼å¥³ã®æ±ºæ„ã‚’èªã‚‰ã›ã¦ãã ã•ã„ã€‚`;
    
    } else if (theme === 'A') {
        if (isSeed) {
            prompt += `
### åŸ·ç­†ãƒ†ãƒ¼ãƒï¼šã€Œå…¨å›½åˆ¶è¦‡ã¸ã€ç‹è€…ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã€
- ã“ã®ãƒãƒ¼ãƒ ï¼ˆ${rankDescription}, ${seedRankString}ï¼‰ã¯ã€ä»Šå¤§ä¼šã®ã€Œå„ªå‹å€™è£œç­†é ­ã€ã§ã™ã€‚æœ€çµ‚ç›®æ¨™ã¯ã€Œå…¨å›½åˆ¶è¦‡ã€ã§ã™ãŒã€ãã®ãŸã‚ã«ã¯ã¾ãšã€Œç”²å­åœ’å‡ºå ´ã€ã¨ã„ã†æœ€å¤§ã®é–¢é–€ã‚’çªç ´ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚`;
        } else {
            prompt += `
### åŸ·ç­†ãƒ†ãƒ¼ãƒï¼šã€Œæœ€å¼·ã®ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã€æ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸»å½¹ã€
- ã“ã®ãƒãƒ¼ãƒ ï¼ˆ${rankDescription}ï¼‰ã¯ã€Aãƒ©ãƒ³ã‚¯ã®åŠ›ã‚’æŒã¤ã«ã‚‚é–¢ã‚ã‚‰ãšã€ã€Œãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã€ã§ä»Šå¤§ä¼šã«è‡¨ã¿ã¾ã™ã€‚
- å½¼ã‚‰ãŒå…¥ã£ãŸãƒ–ãƒ­ãƒƒã‚¯ã¯ã€è‡ªå‹•çš„ã«ã€Œæ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã€ã¨ãªã‚Šã¾ã™ã€‚å½¼ã‚‰ãŒã©ã®ã‚·ãƒ¼ãƒ‰æ ¡ã‚’å€’ã—ã¦å‹ã¡ä¸ŠãŒã£ã¦ãã‚‹ã®ã‹ã€ãã®ã€Œä¸‹å‰‹ä¸Šã€ã®è»Œè·¡ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ãã ã•ã„ã€‚`;
        }
        prompt += `
- **ã€Œå‹ã£ã¦å½“ãŸã‚Šå‰ã€ã¨ã„ã†ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼**ã¨ã©ã†æˆ¦ã£ã¦ã„ã‚‹ã‹ã€ä¸»å°†ã‚„ç›£ç£ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’é€šã˜ã¦æå†™ã—ã¦ãã ã•ã„ã€‚
- ãƒãƒ¼ãƒ ã®åœ§å€’çš„ãªæˆ¦åŠ›ï¼ˆä¾‹ï¼šãƒ—ãƒ­æ³¨ç›®é¸æ‰‹ï¼‰ã‚’ç´¹ä»‹ã—ã¦ãã ã•ã„ã€‚`;
    }

    prompt += `
### è¿½åŠ æŒ‡ç¤ºï¼šåˆæˆ¦ã®æƒ…å ±ã€æœ€é‡è¦ã€‘
- è¨˜äº‹ã®æœ€å¾Œï¼ˆç· ã‚ããã‚Šï¼‰ã«ã€**ã€å–æãƒ‡ãƒ¼ã‚¿ã€‘ã«ã‚ã‚‹ã€Œåˆæˆ¦æƒ…å ±ã€**ã«ã¤ã„ã¦å¿…ãšè¨€åŠã—ã¦ãã ã•ã„ã€‚
${isByeStart ? '- **ç‰¹ã«ã€Œ1å›æˆ¦ã¯ä¸æˆ¦å‹ã§ã‚ã‚Šã€2å›æˆ¦ã‹ã‚‰ã®ç™»å ´ã¨ãªã‚‹ã€ã“ã¨ã€ãã—ã¦ãã‚ŒãŒã€Œèª¿æ•´é¢ã§æœ‰åˆ©ï¼ˆã¾ãŸã¯è©¦åˆå‹˜ã§ä¸åˆ©ï¼‰ã€ã§ã‚ã‚‹ã“ã¨**ã«è§¦ã‚Œã€æ¬¡æˆ¦ã¸ã®æº–å‚™ä¸‡ç«¯ãªæ§˜å­ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚' : '- å¯¾æˆ¦ç›¸æ‰‹ã€æ—¥ç¨‹ã€çƒå ´ã«è§¦ã‚Œã€å¤§ä¼šã¸ã®æœŸå¾…æ„Ÿã‚’é«˜ã‚ã¦ãã ã•ã„ã€‚'}

### å‡ºåŠ›å½¢å¼ã€å³å®ˆã€‘
- **ã€æœ€é‡è¦ã€‘** ã‚ãªãŸã®å¿œç­”ã¯ã€å¿…ãšå˜ä¸€ã®JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"ã®ã¿"ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
{"title": "ï¼ˆä¾‹ï¼šã€é«˜æ ¡é‡çƒã€‘${teamName}ã€${isByeStart ? '2å›æˆ¦ã‹ã‚‰ç™»å ´ï¼ä¸‡å…¨ã®èª¿æ•´ã§å¤ã«æŒ‘ã‚€' : 'åˆæˆ¦ã¯XXã¨æ¿€çª'}ï¼‰", "body": "ï¼ˆã“ã“ã«ã‚¹ãƒãƒ¼ãƒ„å ±çŸ¥é¢¨ã®è¨˜äº‹æœ¬æ–‡ï¼‰"}
`;

    // --- AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ---
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
            const rawTextFromAi = result.candidates[0].content?.parts[0]?.text;
            const article = parseJsonFromText(rawTextFromAi);
            
            if (article && article.title && article.body) {
                article.body += "\n\nã€€ï¼ˆã‚¹ãƒãƒ¼ãƒ„å ±çŸ¥ è¨˜è€…ï¼‰"; 
                return { 
                    ...article, 
                    timestamp: Date.now(),
                    isTopicArticle: true, 
                    context: { teamName: teamName, theme: theme, isTopicArticle: true } 
                };
            } else {
                 console.error("parseJsonFromText failed for TopicArticle:", rawTextFromAi);
                 throw new Error("AI response format error after parsing (TopicArticle).");
            }
        } else {
             console.error("Unexpected AI response structure (TopicArticle):", result);
             throw new Error("AI response structure is missing expected parts (TopicArticle).");
        }
    } catch (error) {
        console.error(`è©±é¡Œæ ¡ç´¹ä»‹è¨˜äº‹ï¼ˆ${teamName}ï¼‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:`, error);
        return null; 
    }
}

/**
 * [UPDATED] AIã«çµ„ã¿åˆã‚ã›æŠ½é¸çµæœã®è©³ç´°åˆ†æã«åŸºã¥ã„ãŸå±•æœ›ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’ç”Ÿæˆã•ã›ã‚‹
 * (â˜…ãƒãƒ¼ãƒ æ•°ã«å¿œã˜ã¦ãƒ–ãƒ­ãƒƒã‚¯ã‚µã‚¤ã‚ºã‚’å‹•çš„ã«è¨ˆç®—)
 */
async function generateBracketAnalysisNewsArticle(state) {
    const { teams, seeds, currentTournament, tournamentYear } = state;
    const tournamentName = tournamentNameMap[currentTournament] || 'å¤§ä¼š';
    if (!teams || teams.length === 0) return null;

    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ãƒ–ãƒ­ãƒƒã‚¯ã‚µã‚¤ã‚ºã‚’å‹•çš„ã«è¨ˆç®— â˜…â˜…â˜…
    const numBlocks = 4;
    const blockSize = Math.ceil(teams.length / numBlocks); // 128->32, 64->16
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    let tournamentContextPrompt = "";
    let seedContext = "å‰å¤§ä¼šãƒ™ã‚¹ãƒˆ8";
    if (currentTournament === 'summer') {
        tournamentContextPrompt = "3å¹´ç”Ÿã«ã¨ã£ã¦ã¯æœ€å¾Œã®å¤ã§ã‚ã‚Šã€ç”²å­åœ’å‡ºå ´ã‚’ã‹ã‘ãŸæœ€ã‚‚ç†±ã„æˆ¦ã„ã§ã™ã€‚";
    } else if (currentTournament === 'summer_koshien') {
        tournamentContextPrompt = "å…¨å›½ã®ä»£è¡¨æ ¡ãŒé›†ã†å¤ã®ç”²å­åœ’ã€‚è² ã‘ã‚Œã°çµ‚ã‚ã‚Šã®ä¸€ç™ºå‹è² ã§ã™ã€‚";
        seedContext = "æ³¨ç›®æ ¡";
    } else if (currentTournament === 'autumn') {
        tournamentContextPrompt = "1,2å¹´ç”Ÿã«ã‚ˆã‚‹æ–°ãƒãƒ¼ãƒ ãŒå§‹å‹•ã™ã‚‹æœ€åˆã®å…¬å¼æˆ¦ã§ã™ã€‚";
    } else if (currentTournament === 'spring') {
        tournamentContextPrompt = "å¤ã®ã‚·ãƒ¼ãƒ‰æ¨©ã‚’ã‹ã‘ãŸå‰å“¨æˆ¦ã§ã™ã€‚";
    }

    const blockData = [];
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
    const getTeamRank = (teamName) => calculateRank(teamName, state);
    let crushR1 = []; 
    let goodCardsR5 = []; 
    let blockSummary = "";

    for (let i = 0; i < numBlocks; i++) {
        const blockName = String.fromCharCode(65 + i);
        const startIdx = i * blockSize;
        const endIdx = (i + 1) * blockSize;
        const blockTeams = teams.slice(startIdx, endIdx);
        if (blockTeams.length === 0) continue;
        
        const strongTeamsInBlock = blockTeams.filter(team => {
            const rank = getTeamRank(team);
            return seeds.some(s => s.team === team) || ['A', 'B'].includes(rank); 
        });
        const matchupsR1 = [];
        const potentialR5 = [];
        for (let j = 0; j < blockTeams.length; j += 2) {
            const team1 = blockTeams[j]; const team2 = blockTeams[j + 1];
            if (!team1 || !team2) continue;
            const rank1 = getTeamRank(team1); const rank2 = getTeamRank(team2);
            const matchup = { team1, rank1, team2, rank2 };
            matchupsR1.push(matchup);
            if ((seeds.some(s => s.team === team1) || ['A', 'B'].includes(rank1)) && (seeds.some(s => s.team === team2) || ['A', 'B'].includes(rank2))) {
                matchup.isCrush = true;
            }
        }
        // (ç°¡æ˜“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: R1å‹è€… -> R2å‹è€… -> R3å‹è€… -> R4é€²å‡ºè€…)
        // â€»64ãƒãƒ¼ãƒ åˆ¶ã®å ´åˆã€R4ã¯æº–ã€…æ±ºå‹ã§ã¯ãªã„ãŒã€ãƒ™ã‚¹ãƒˆ8æ±ºã‚ã®é‡è¦ãªãƒ©ã‚¦ãƒ³ãƒ‰ã¨ã—ã¦æ‰±ã†
        let winners = [];
        matchupsR1.forEach(m => { winners.push(rankValues[m.rank1] >= rankValues[m.rank2] ? m.team1 : m.team2); });
        
        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ®µæ•°ã‚’ãƒãƒ¼ãƒ æ•°ã«åˆã‚ã›ã¦èª¿æ•´ã™ã‚‹ã®ã¯è¤‡é›‘ãªã®ã§ã€
        // ã“ã“ã§ã¯ã€Œãƒ–ãƒ­ãƒƒã‚¯å†…ã®æœ‰åŠ›æ ¡åŒå£«ã®å¯¾æ±ºäºˆæƒ³ã€ã¨ã—ã¦ã€å˜ç´”ã«æœ‰åŠ›æ ¡ãƒªã‚¹ãƒˆã‚’ä½¿ã†å½¢ã«ç•™ã‚ã‚‹ã‹ã€
        // æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ãŒå‹•ãç¯„å›²ã§ã‚ˆã—ã¨ã™ã‚‹ï¼ˆæ•°åˆã‚ã›ã§å‹•ããŸã‚ï¼‰
        
        blockData.push({ name: blockName, strongTeams: strongTeamsInBlock, matchupsR1: matchupsR1, potentialR5: potentialR5 });
    }

    blockData.forEach(block => {
        const strongTeamNames = block.strongTeams.map(team => `${team} ${getSeedRankString(team, state.seeds)}`).join(', ');
        blockSummary += `- ${block.name}ãƒ–ãƒ­ãƒƒã‚¯: æœ‰åŠ›æ ¡ ${block.strongTeams.length} (${strongTeamNames || 'ãªã—'})\n`;
        block.matchupsR1.forEach(m => {
            if (m.isCrush) {
                const team1Info = `${m.team1}${getSeedRankString(m.team1, state.seeds)}(${m.rank1})`;
                const team2Info = `${m.team2}${getSeedRankString(m.team2, state.seeds)}(${m.rank2})`;
                crushR1.push(`${block.name}: ${team1Info} vs ${team2Info}`);
            }
        });
    });
    
    blockData.sort((a, b) => b.strongTeams.length - a.strongTeams.length);
    const deathBlock = blockData[0];
    const blessedBlock = blockData[blockData.length - 1];
    
    let analysisText = `å„ãƒ–ãƒ­ãƒƒã‚¯ã®æœ‰åŠ›æ ¡:\n${blockSummary}`;
    analysisText += `æ­»ã®ãƒ–ãƒ­ãƒƒã‚¯: ${deathBlock.name} (${deathBlock.strongTeams.length}æ ¡)\n`;
    analysisText += `æµã¾ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯: ${blessedBlock.name} (${blessedBlock.strongTeams.length}æ ¡)\n`;
    if (crushR1.length > 0) analysisText += `1å›æˆ¦ã§ã®æœ‰åŠ›æ ¡æ½°ã—åˆã„:\n  - ${crushR1.join('\n  - ')}\n`;

    const prompt = `ã‚ãªãŸã¯ã€æ—¥æœ¬ã®é«˜æ ¡é‡çƒã‚’æ·±ãæ„›ã™ã‚‹ã€æƒ…ç†±çš„ãªã‚¹ãƒãƒ¼ãƒ„è¨˜è€…ã§ã™ã€‚
${tournamentYear}å¹´åº¦ ${tournamentName}ã®çµ„ã¿åˆã‚ã›æŠ½é¸ä¼šãŒçµ‚äº†ã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®è©³ç´°ãªåˆ†æçµæœã«åŸºã¥ãã€èª­è€…ã®æœŸå¾…æ„Ÿã‚’é«˜ã‚ã‚‹ã‚ˆã†ãªå±•æœ›è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

### å¤§ä¼šã®æ–‡è„ˆ (æœ€é‡è¦)
${tournamentContextPrompt}

### å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰
${PREFECTURE_LORE}
---
### çµ„ã¿åˆã‚ã›åˆ†æçµæœ (â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ä»˜ã)
${analysisText}

### åŸ·ç­†æŒ‡ç¤º
- ã€å¤§ä¼šã®æ–‡è„ˆã‚’åæ˜ ã€‘: è¨˜äº‹å…¨ä½“ã§ã€${tournamentName}ãªã‚‰ã§ã¯ã®è¦–ç‚¹ï¼ˆç”²å­åœ’ãªã‚‰ã€Œå…¨å›½ã®é ‚ç‚¹ã€ãªã©ï¼‰ã‚’åæ˜ ã•ã›ã¦ãã ã•ã„ã€‚
- ã‚¿ã‚¤ãƒˆãƒ«: ã€Œ${tournamentName} çµ„ã¿åˆã‚ã›æ±ºå®šï¼${deathBlock.name}ãƒ–ãƒ­ãƒƒã‚¯ã¯æ¿€æˆ¦åŒºã‹ï¼Ÿã€ã®ã‚ˆã†ã«ã€å¤§ä¼šåã¨æŠ½é¸çµæœã®ãƒã‚¤ãƒ³ãƒˆãŒä¼ã‚ã‚‹ã‚‚ã®ã«ã—ã¦ãã ã•ã„ã€‚
- æœ¬æ–‡æ§‹æˆ:
    1. çµ„ã¿åˆã‚ã›ãŒæ±ºå®šã—ãŸã“ã¨ã‚’ä¼ãˆã‚‹å°å…¥ã€‚
    2. å„ãƒ–ãƒ­ãƒƒã‚¯ã®æœ‰åŠ›æ ¡ã«è§¦ã‚Œã¤ã¤ã€ç‰¹ã«ã€Œæ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ (${deathBlock.name})ã€ã¨ã€Œæµã¾ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ (${blessedBlock.name})ã€ã«ã¤ã„ã¦è§£èª¬ã—ã¦ãã ã•ã„ã€‚
    3. å‹ã¡ä¸ŠãŒã‚Šã‚’äºˆæƒ³ã—ã€æ³¨ç›®ã‚«ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã‚‚è§¦ã‚Œã¦ãã ã•ã„ã€‚
    4. ã€AIè¨˜è€…ã®æ³¨ç›®æ ªã€‘: ã‚ãªãŸãŒã€Œä»Šå¤§ä¼šã®ä¸€æŠ¼ã—ãƒãƒ¼ãƒ ï¼ˆæ¨ã—ï¼‰ã€ã‚’1æ ¡é¸ã³ã€ãã®ãƒãƒ¼ãƒ ã®é­…åŠ›ã‚’ç†±ãèªã‚‹ã‚³ãƒ©ãƒ æ¬„ã‚’è¨­ã‘ã¦ãã ã•ã„ã€‚
    5. æœ€å¾Œã«ã€å¤§ä¼šã¸ã®æœŸå¾…ã‚’è¿°ã¹ã¦ç· ã‚ããã£ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼
{"title": "ï¼ˆã“ã“ã«è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼‰", "body": "ï¼ˆã“ã“ã«è¨˜äº‹ã®æœ¬æ–‡ï¼‰"}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (article && article.title && article.body) {
                return { ...article, timestamp: Date.now(), context: { isBracketAnalysis: true } }; 
            }
        }
        throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒã€æ­£ã—ã„è¨˜äº‹å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    } catch (error) {
        console.error("AIçµ„ã¿åˆã‚ã›åˆ†æè¨˜äº‹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return {
            title: "çµ„ã¿åˆã‚ã›åˆ†æè¨˜äº‹ ç”Ÿæˆã‚¨ãƒ©ãƒ¼",
            body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã€è¨˜äº‹ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚",
            timestamp: Date.now(),
            error: true,
            errorId: `bracket-analysis-${Date.now()}`,
            context: { isBracketAnalysis: true }
        };
    }
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²


// --- Tournament Animation Logic ---

let currentAnimation = null; // å†ç”Ÿä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¨®é¡ (null, 'autumn', 'spring')
let currentStep = -1;       // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ç•ªå·
let animationSteps = [];    // ç¾åœ¨ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å…¨ã‚¹ãƒ†ãƒƒãƒ—é–¢æ•°

const stage = document.getElementById('animation-stage');
const narrationEl = document.getElementById('animation-narration');
const prevBtn = document.getElementById('prev-step-btn');
const nextBtn = document.getElementById('next-step-btn');
const animPlaceholder = document.getElementById('anim-placeholder');
const showAutumnBtn = document.getElementById('show-autumn-anim-btn');
const showSpringBtn = document.getElementById('show-spring-anim-btn');

/**
 * ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´ ã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
function createAnimElement(type, text, options = {}) {
    const el = document.createElement('div');
    el.className = `anim-${type}`;
    el.textContent = text;
    if (options.id) el.id = options.id;
    if (options.children) options.children.forEach(child => el.appendChild(child));
    if (options.style) Object.assign(el.style, options.style);
    return el;
}

/**
 * è¦ç´ ã‚’è¡¨ç¤ºï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼‰ã•ã›ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
async function showElement(element, delay = 50) {
    if (!element) return;
    await sleep(delay);
    element.classList.add('show');
}

/**
 * è¦ç´ ã‚’éè¡¨ç¤ºï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼‰ã•ã›ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
async function hideElement(element, delay = 0) {
    if (!element) return;
    await sleep(delay);
    element.classList.remove('show', 'anim-highlight');
    await sleep(500); // Wait for fade out
}

/**
 * è¦ç´ ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
function highlightElement(element, clearOthers = true) {
    if (clearOthers) {
        stage.querySelectorAll('.anim-highlight').forEach(el => el.classList.remove('anim-highlight'));
    }
    if (element) {
        element.classList.add('anim-highlight');
    }
}

/**
 * ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã—ã€ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼é¢¨ã«è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
async function setNarration(text) {
    narrationEl.textContent = '';
    for (const char of text) {
        narrationEl.textContent += char;
        await sleep(30); // æ–‡å­—é–“ã®ã‚¦ã‚§ã‚¤ãƒˆ
    }
}

/**
 * ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œã¨ãƒœã‚¿ãƒ³åˆ¶å¾¡
 */
async function runStep(stepIndex) {
    if (stepIndex < 0 || stepIndex >= animationSteps.length) return;
    currentStep = stepIndex;
    stage.innerHTML = ''; // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
    animPlaceholder.classList.add('hidden'); // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼éè¡¨ç¤º
    await animationSteps[currentStep](); // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—é–¢æ•°ã‚’å®Ÿè¡Œ
    updateButtons();
}

function updateButtons() {
    prevBtn.disabled = currentStep <= 0;
    nextBtn.disabled = currentStep >= animationSteps.length - 1;
}

// --- ç§‹å­£å¤§ä¼šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒƒãƒ— ---
const autumnAnimation = [
    // Step 0: Introduction
    async () => {
        await setNarration("ğŸ‚ ç§‹å­£å¤§ä¼šã¯æ–°ãƒãƒ¼ãƒ æœ€åˆã®å…¬å¼æˆ¦ï¼ã‚»ãƒ³ãƒãƒ„ç”²å­åœ’å‡ºå ´ã«ç¹‹ãŒã‚Šã¾ã™ã€‚");
        const title = createAnimElement('bracket', 'ç§‹å­£å¤§ä¼šã‚·ã‚¹ãƒ†ãƒ ', { style: { fontSize: '1.2rem', fontWeight: 'bold' } });
        stage.appendChild(title);
        await showElement(title);
    },
    // Step 1: Regional Qualifiers Overview
    async () => {
        await setNarration("ã¾ãšã€çœŒå†…ã‚’4åœ°åŒºï¼ˆæ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨ãƒ»ä¼Šè±†ï¼‰ã«åˆ†ã‘ã¦åœ°åŒºäºˆé¸ã‚’è¡Œã„ã¾ã™ã€‚");
        const regions = ['æ±éƒ¨(20)', 'ä¸­éƒ¨(20)', 'è¥¿éƒ¨(20)', 'ä¼Šè±†(4)'].map(r => createAnimElement('region', r));
        const container = createAnimElement('bracket', '', { children: regions, style: { display: 'flex', justifyContent: 'center' } });
        stage.appendChild(container);
        for (const region of regions) await showElement(region);
    },
    // Step 2: Main 3 Regions - Blocks
    async () => {
        await setNarration("æ±ãƒ»ä¸­ãƒ»è¥¿åœ°åŒºã§ã¯ã€20ãƒãƒ¼ãƒ ãŒ4ãƒ–ãƒ­ãƒƒã‚¯ã«åˆ†ã‹ã‚Œã€å„ãƒ–ãƒ­ãƒƒã‚¯å„ªå‹ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚");
        const region = createAnimElement('region', 'æ±éƒ¨åœ°åŒº (20ãƒãƒ¼ãƒ )', { id: 'main-region', style: { width: '80%' } });
        const blocks = ['A (5)', 'B (5)', 'C (5)', 'D (5)'].map(b => createAnimElement('block', `ãƒ–ãƒ­ãƒƒã‚¯ ${b}`));
        region.append(...blocks);
        stage.appendChild(region);
        await showElement(region);
        for (const block of blocks) await showElement(block, 100);
        highlightElement(region);
    },
    // Step 3: Block Winner
    async () => {
        await setNarration("å„ãƒ–ãƒ­ãƒƒã‚¯ã®å„ªå‹ãƒãƒ¼ãƒ  (è¨ˆ4ãƒãƒ¼ãƒ ) ã¯çœŒå¤§ä¼šã¸é€²å‡ºæ±ºå®šï¼ğŸ†");
        const region = document.getElementById('main-region');
        if (!region) { // è¦ç´ ãŒãªã‘ã‚Œã°å†ç”Ÿæˆ (Prevãƒœã‚¿ãƒ³å¯¾ç­–)
            await autumnAnimation[2](); // å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å†å®Ÿè¡Œ
            await sleep(500);
        }
        const blockA = stage.querySelector('.anim-block'); // ä¾‹ã¨ã—ã¦Aãƒ–ãƒ­ãƒƒã‚¯
        const winner = createAnimElement('team', 'Aå„ªå‹', { classList: ['winner'] });
        blockA.appendChild(winner);
        await showElement(winner, 200);
        highlightElement(winner);
        // TODO: çŸ¢å°ã§ã€ŒçœŒå¤§ä¼šã¸ã€ã‚’ç¤ºã™
    },
    // Step 4: Block Runner-up & Repechage
    async () => {
        await setNarration("å„ãƒ–ãƒ­ãƒƒã‚¯ã®æº–å„ªå‹ãƒãƒ¼ãƒ  (è¨ˆ4ãƒãƒ¼ãƒ ) ã¯ã€æœ€å¾Œã®1æ ã‚’è³­ã‘ãŸæ•—è€…å¾©æ´»æˆ¦ã¸ã€‚");
        await autumnAnimation[3](); // å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã®è¡¨ç¤ºã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹
        const blocks = stage.querySelectorAll('.anim-block');
        const runnersUp = [];
        blocks.forEach((block, i) => {
            const runnerUp = createAnimElement('team', `${String.fromCharCode(65 + i)}æº–å„ªå‹`, { classList: ['loser'] });
            block.appendChild(runnerUp);
            runnersUp.push(runnerUp);
        });
        for (const ru of runnersUp) await showElement(ru, 100);

        const repechage = createAnimElement('bracket', 'ç¬¬5ä»£è¡¨æ±ºå®šæˆ¦ (æ•—è€…å¾©æ´»)', { id: 'repechage', style: { marginTop: '15px' } });
        stage.appendChild(repechage);
        await showElement(repechage);
        highlightElement(repechage);
        // TODO: æº–å„ªå‹ãƒãƒ¼ãƒ ã‹ã‚‰æ•—è€…å¾©æ´»æˆ¦ã¸ã®çŸ¢å°
    },
    // Step 5: Repechage Winner
    async () => {
        await setNarration("æ•—è€…å¾©æ´»æˆ¦ã®å‹è€… (1ãƒãƒ¼ãƒ ) ã‚‚çœŒå¤§ä¼šã¸é€²å‡ºï¼ã“ã‚Œã§å„åœ°åŒº5ãƒãƒ¼ãƒ ã€‚");
        await autumnAnimation[4]();
        const repechage = document.getElementById('repechage');
        const repWinner = createAnimElement('team', 'å¾©æ´»å„ªå‹', { classList: ['winner'] });
        repechage.appendChild(repWinner);
        await showElement(repWinner, 200);
        highlightElement(repWinner);
        // TODO: çŸ¢å°ã§ã€ŒçœŒå¤§ä¼šã¸ã€ã‚’ç¤ºã™
    },
    // Step 6: Izu Region
    async () => {
        await setNarration("ä¼Šè±†åœ°åŒºã¯4ãƒãƒ¼ãƒ ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã€‚å„ªå‹ã—ãŸ1ãƒãƒ¼ãƒ ã®ã¿çœŒå¤§ä¼šã¸ã€‚");
        const region = createAnimElement('region', 'ä¼Šè±†åœ°åŒº (4ãƒãƒ¼ãƒ )', { id: 'izu-region' });
        const winner = createAnimElement('team', 'ä¼Šè±†å„ªå‹', { classList: ['winner'] });
        region.appendChild(winner);
        stage.appendChild(region);
        await showElement(region);
        await showElement(winner, 200);
        highlightElement(region);
    },
    // Step 7: Prefectural Tournament
    async () => {
        await setNarration("å…¨ä»£è¡¨16ãƒãƒ¼ãƒ  (æ±5+ä¸­5+è¥¿5+ä¼Šè±†1) ãŒé›†çµã—ã€çœŒå¤§ä¼šæœ¬æˆ¦ (ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ)ï¼");
        const bracket = createAnimElement('bracket', 'çœŒå¤§ä¼šæœ¬æˆ¦ (16ãƒãƒ¼ãƒ )', { id: 'main-bracket' });
        const teams = ['æ±1', 'ä¸­1', 'è¥¿1', 'ä¼Š1', 'æ±2', 'ä¸­2', '...', 'è¥¿5(æ•—å¾©)'].map(t => createAnimElement('team', t));
        bracket.append(...teams);
        stage.appendChild(bracket);
        await showElement(bracket);
        for (const team of teams) await showElement(team, 30);
        highlightElement(bracket);
    },
    // Step 8: Rewards
    async () => {
        await setNarration("çœŒå¤§ä¼šã®å„ªå‹ãƒ»æº–å„ªå‹ã¯ã‚»ãƒ³ãƒãƒ„æœ‰åŠ›ï¼ãƒ™ã‚¹ãƒˆ8ä»¥ä¸Šã§æ˜¥å­£å¤§ä¼šã®ã‚·ãƒ¼ãƒ‰æ¨©ç²å¾—ï¼âœ¨");
        await autumnAnimation[7]();
        const bracket = document.getElementById('main-bracket');
        const rewards = createAnimElement('bracket', 'ğŸ†å„ªå‹/æº–å„ªå‹ â†’ ã‚»ãƒ³ãƒãƒ„ã¸<br>ğŸ…ãƒ™ã‚¹ãƒˆ8 â†’ æ˜¥ã‚·ãƒ¼ãƒ‰æ¨©', { style: { marginTop: '15px', borderColor: 'gold' } });
        stage.appendChild(rewards);
        await showElement(rewards, 200);
        highlightElement(rewards);
    }
];

// --- æ˜¥å­£å¤§ä¼šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒƒãƒ— ---
const springAnimation = [
    // Step 0: Introduction
    async () => {
        await setNarration("ğŸŒ¸ æ˜¥å­£å¤§ä¼šã¯å¤ã®å¤§ä¼šã®å‰å“¨æˆ¦ï¼å¤ã®ã‚·ãƒ¼ãƒ‰æ¨©ç²å¾—ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚");
        const title = createAnimElement('bracket', 'æ˜¥å­£å¤§ä¼šã‚·ã‚¹ãƒ†ãƒ ', { style: { fontSize: '1.2rem', fontWeight: 'bold' } });
        stage.appendChild(title);
        await showElement(title);
    },
    // Step 1: Seed Teams
    async () => {
        await setNarration("ç§‹å­£å¤§ä¼šãƒ™ã‚¹ãƒˆ8ã®ãƒãƒ¼ãƒ ã¯ã‚·ãƒ¼ãƒ‰æ ¡ã¨ãªã‚Šã€çœŒå¤§ä¼š2å›æˆ¦ã‹ã‚‰ç™»å ´ã—ã¾ã™ã€‚");
        const seeds = Array.from({ length: 8 }).map((_, i) => createAnimElement('team', `ç§‹Best8-${i+1}`, { classList: ['seed'] }));
        const container = createAnimElement('bracket', 'ã‚·ãƒ¼ãƒ‰æ ¡ (8ãƒãƒ¼ãƒ )', { children: seeds, id: 'seeds', style: { borderColor: 'orange' } });
        stage.appendChild(container);
        await showElement(container);
        for (const seed of seeds) await showElement(seed, 50);
        highlightElement(container);
    },
    // Step 2: Regional Qualifiers (Non-seeds)
    async () => {
        await setNarration("ã‚·ãƒ¼ãƒ‰æ ¡ä»¥å¤–ã®ãƒãƒ¼ãƒ ã¯ã€å†ã³åœ°åŒºäºˆé¸ã¸ã€‚ç§‹ã¨åŒæ§˜ã«ä»£è¡¨æ ã‚’äº‰ã„ã¾ã™ã€‚");
        const others = createAnimElement('region', 'ã‚·ãƒ¼ãƒ‰ä»¥å¤–ã®å…¨ãƒãƒ¼ãƒ  (56ãƒãƒ¼ãƒ )', { id: 'others' });
        const qualifiers = createAnimElement('bracket', 'åœ°åŒºäºˆé¸ (ç§‹ã¨åŒã˜å½¢å¼)', { id: 'qualifiers' });
        stage.appendChild(others);
        stage.appendChild(qualifiers);
        await showElement(others);
        await showElement(qualifiers, 200);
        highlightElement(qualifiers);
        // TODO: othersã‹ã‚‰qualifiersã¸ã®çŸ¢å°
    },
    // Step 3: Qualifier Winners
    async () => {
        await setNarration("åœ°åŒºäºˆé¸ã‚’çªç ´ã—ãŸ16ãƒãƒ¼ãƒ ãŒçœŒå¤§ä¼š1å›æˆ¦ã¸é€²å‡ºã—ã¾ã™ã€‚");
        await springAnimation[2](); // å‰ã®ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º
        const qualifiers = document.getElementById('qualifiers');
        const winners = Array.from({ length: 16 }).map((_, i) => createAnimElement('team', `äºˆé¸çªç ´-${i+1}`, { classList: ['winner'] }));
        const winnerContainer = createAnimElement('bracket', 'äºˆé¸çªç ´ (16ãƒãƒ¼ãƒ )', { children: winners, id: 'q-winners' });
        qualifiers.appendChild(winnerContainer);
        await showElement(winnerContainer, 200);
        highlightElement(winnerContainer);
    },
    // Step 4: Prefectural Round 1
    async () => {
        await setNarration("çœŒå¤§ä¼š1å›æˆ¦ã¯ã€äºˆé¸çªç ´æ ¡åŒå£«ã®å¯¾æ±ºã§ã™ã€‚");
        await springAnimation[3]();
        const qWinners = document.getElementById('q-winners');
        const r1Bracket = createAnimElement('bracket', 'çœŒå¤§ä¼š1å›æˆ¦ (8è©¦åˆ)', { id: 'r1-bracket', style: { marginTop: '15px' } });
        // ä»£è¡¨ã¨ã—ã¦4ãƒãƒ¼ãƒ è¡¨ç¤º
        const teamsR1 = ['äºˆé¸A', 'äºˆé¸B', 'äºˆé¸C', 'äºˆé¸D'].map(t => createAnimElement('team', t));
        r1Bracket.append(...teamsR1);
        stage.appendChild(r1Bracket);
        await showElement(r1Bracket, 200);
        highlightElement(r1Bracket);
        // TODO: q-winnersã‹ã‚‰r1-bracketã¸ã®çŸ¢å°
    },
    // Step 5: Prefectural Round 2 (Seeds Join)
    async () => {
        await setNarration("1å›æˆ¦ã®å‹è€…8ãƒãƒ¼ãƒ ãŒã€ã‚·ãƒ¼ãƒ‰æ ¡8ãƒãƒ¼ãƒ ã¨2å›æˆ¦ã§æ¿€çªï¼ã“ã“ã‹ã‚‰æœ¬æˆ¦ï¼");
        const seeds = Array.from({ length: 8 }).map((_, i) => createAnimElement('team', `ç§‹Best8-${i+1}`, { classList: ['seed'] }));
        const seedContainer = createAnimElement('bracket', 'ã‚·ãƒ¼ãƒ‰æ ¡ (8ãƒãƒ¼ãƒ )', { children: seeds, id: 'seeds', style: { borderColor: 'orange' } });

        const r1Winners = Array.from({ length: 8 }).map((_, i) => createAnimElement('team', `1å›æˆ¦å‹è€…-${i+1}`, { classList: ['winner'] }));
        const r1WinnerContainer = createAnimElement('bracket', '1å›æˆ¦å‹è€… (8ãƒãƒ¼ãƒ )', { children: r1Winners, id: 'r1-winners' });

        const r2Bracket = createAnimElement('bracket', 'çœŒå¤§ä¼š2å›æˆ¦ (16ãƒãƒ¼ãƒ )', { id: 'r2-bracket', style: { borderColor: 'red' } });

        stage.append(seedContainer, r1WinnerContainer, r2Bracket);
        await showElement(seedContainer);
        await showElement(r1WinnerContainer);
        await showElement(r2Bracket, 200);
        highlightElement(r2Bracket);
        // TODO: seedContainerã¨r1WinnerContainerã‹ã‚‰r2Bracketã¸ã®çŸ¢å°
    },
    // Step 6: Reward (Summer Seed)
    async () => {
        await setNarration("ã“ã®å¤§ä¼šã§ãƒ™ã‚¹ãƒˆ8ä»¥ä¸Šã«å…¥ã‚‹ã¨ã€å¤ã®é¸æ‰‹æ¨©å¤§ä¼šã®ã‚·ãƒ¼ãƒ‰æ¨©ç²å¾—ï¼ğŸ”¥");
        await springAnimation[5]();
        const r2Bracket = document.getElementById('r2-bracket');
        const reward = createAnimElement('bracket', 'ğŸ…ãƒ™ã‚¹ãƒˆ8 â†’ å¤ã®ã‚·ãƒ¼ãƒ‰æ¨©', { style: { marginTop: '15px', borderColor: 'gold' } });
        stage.appendChild(reward);
        await showElement(reward, 200);
        highlightElement(reward);
    }
];

// --- Event Listeners for Animation Control ---

showAutumnBtn.addEventListener('click', () => {
    currentAnimation = 'autumn';
    animationSteps = autumnAnimation;
    runStep(0);
});

showSpringBtn.addEventListener('click', () => {
    currentAnimation = 'spring';
    animationSteps = springAnimation;
    runStep(0);
});

prevBtn.addEventListener('click', () => {
    if (currentStep > 0) {
        runStep(currentStep - 1);
    }
});

nextBtn.addEventListener('click', () => {
    if (currentStep < animationSteps.length - 1) {
        runStep(currentStep + 1);
    }
});

// Helper for delays
// function sleep(ms) { // æ—¢å­˜ã®sleepé–¢æ•°ãŒã‚ã‚Œã°ä¸è¦
//     return new Promise(resolve => setTimeout(resolve, ms));
// }

/**
 * [UPDATED] AIã«çµ„ã¿åˆã‚ã›æŠ½é¸çµæœã«åŸºã¥ã„ãŸã€ãªã‚“Jé¢¨ã®æ²ç¤ºæ¿ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç”Ÿæˆã•ã›ã‚‹
 * (â˜…Cãƒ©ãƒ³ã‚¯æ ¡ã¸ã®ã€Œãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ã€åå¿œã‚’å¼·åŒ–ã—ãŸä¿®æ­£ç‰ˆ)
 */
async function generateBracketBbsThread(state) {
    const { teams, seeds, currentTournament, tournamentYear } = state;
    const tournamentName = tournamentNameMap[currentTournament] || 'å¤§ä¼š';
    if (!teams || teams.length === 0) return null; 

    // ãƒ–ãƒ­ãƒƒã‚¯ã‚µã‚¤ã‚ºè¨ˆç®—
    const numBlocks = 4;
    const blockSize = Math.ceil(teams.length / numBlocks); 

    const blockData = [];
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 }; 
    const getTeamRank = (teamName) => calculateRank(teamName, state); 
    
    let nicheMatchups = []; // â˜…Cãƒ©ãƒ³ã‚¯ç­‰ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰
    let crushR1 = [];       // æ½°ã—åˆã„
    let blockSummary = "";
    
    for (let i = 0; i < numBlocks; i++) {
        const blockName = String.fromCharCode(65 + i);
        const startIdx = i * blockSize; const endIdx = (i + 1) * blockSize;
        const blockTeams = teams.slice(startIdx, endIdx); if (blockTeams.length === 0) continue;
        const strongTeamsInBlock = blockTeams.filter(team => { const rank = getTeamRank(team); return seeds.some(s => s.team === team) || ['A', 'B'].includes(rank); });
        const matchupsR1 = [];
        
        for (let j = 0; j < blockTeams.length; j += 2) {
            const team1 = blockTeams[j]; const team2 = blockTeams[j + 1];
            if (!team1 || !team2) continue;
            const rank1 = getTeamRank(team1); const rank2 = getTeamRank(team2);
            const matchup = { team1, rank1, team2, rank2 }; 
            matchupsR1.push(matchup);
            
            // å¼·è±ªåŒå£«ã®æ½°ã—åˆã„åˆ¤å®š
            if ((seeds.some(s => s.team === team1) || ['A', 'B'].includes(rank1)) && (seeds.some(s => s.team === team2) || ['A', 'B'].includes(rank2))) { 
                matchup.isCrush = true; 
            }

            // â˜…â˜…â˜… Cãƒ©ãƒ³ã‚¯(ä¸­å …) vs A/Bãƒ©ãƒ³ã‚¯(å¼·è±ª) ã®ã€Œã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒªãƒ³ã‚°äºˆå‚™è»ã€ã‚’æŠ½å‡º â˜…â˜…â˜…
            // æ¡ä»¶: ã¾ã æ³¨ç›®ã‚«ãƒ¼ãƒ‰æ (5ã¤)ã«ç©ºããŒã‚ã‚Šã€æ½°ã—åˆã„ã§ã¯ãªãã€ç‰‡æ–¹ãŒå¼·è±ªãƒ»ç‰‡æ–¹ãŒCãƒ©ãƒ³ã‚¯ã®å ´åˆ
            if (nicheMatchups.length < 5 && !matchup.isCrush) {
                 // å¼·è±ª(4ä»¥ä¸Š) vs C(3)
                 if ((rankValues[rank1] >= 4 && rankValues[rank2] === 3) || (rankValues[rank1] === 3 && rankValues[rank2] >= 4)) {
                    const cRankTeam = rankValues[rank1] === 3 ? team1 : team2;
                    const strongTeam = rankValues[rank1] === 3 ? team2 : team1;
                    nicheMatchups.push({ 
                        block: blockName, 
                        match: `${strongTeam}(${getTeamRank(strongTeam)}) vs ${cRankTeam}(C)`, 
                        reason: `â˜…æ³¢ä¹±ã®äºˆæ„Ÿâ˜… Cãƒ©ãƒ³ã‚¯ã®ä¸æ°—å‘³ãªå­˜åœ¨ãƒ»${cRankTeam}ãŒå¼·è±ªã«æŒ‘ã‚€` 
                    });
                 } 
                 // Cãƒ©ãƒ³ã‚¯åŒå£«ã®å¥½ã‚«ãƒ¼ãƒ‰
                 else if (rank1 === 'C' && rank2 === 'C') {
                    nicheMatchups.push({ 
                        block: blockName, 
                        match: `${team1}(C) vs ${team2}(C)`, 
                        reason: `å®ŸåŠ›ä¼¯ä»²ï¼Cãƒ©ãƒ³ã‚¯åŒå£«ã®ç„äººå¥½ã¿ãªå¥½ã‚«ãƒ¼ãƒ‰` 
                    });
                 }
            }
        }
        blockData.push({ name: blockName, strongTeams: strongTeamsInBlock, matchupsR1: matchupsR1 });
    }
    
    blockData.forEach(block => {
        const strongTeamNames = block.strongTeams.map(team => `${team} ${getSeedRankString(team, state.seeds)}`).join(', ');
        blockSummary += `- ${block.name}ãƒ–ãƒ­ãƒƒã‚¯: æœ‰åŠ›æ ¡ ${block.strongTeams.length} (${strongTeamNames || 'ãªã—'})\n`;
        block.matchupsR1.forEach(m => {
            if (m.isCrush) {
                crushR1.push(`${block.name}: ${m.team1}(${m.rank1}) vs ${m.team2}(${m.rank2})`);
            }
        });
    });
    blockData.sort((a, b) => b.strongTeams.length - a.strongTeams.length);
    const deathBlock = blockData[0]; 
    const blessedBlock = blockData[blockData.length - 1]; 
    
    let analysisText = `å„ãƒ–ãƒ­ãƒƒã‚¯ã®æœ‰åŠ›æ ¡:\n${blockSummary}`;
    analysisText += `æ­»ã®ãƒ–ãƒ­ãƒƒã‚¯: ${deathBlock.name}\n`;
    analysisText += `æµã¾ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯: ${blessedBlock.name}\n`;
    if (crushR1.length > 0) analysisText += `1å›æˆ¦ã§ã®æœ‰åŠ›æ ¡æ½°ã—åˆã„:\n  - ${crushR1.join('\n  - ')}\n`;
    // â˜…ãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹æƒ…å ±ã‚’è¿½åŠ 
    if (nicheMatchups.length > 0) analysisText += `ãã®ä»–ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰ï¼ˆãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ãƒ»æ³¢ä¹±æ ï¼‰:\n${nicheMatchups.map(nm => `  - ${nm.block}ãƒ–ãƒ­ãƒƒã‚¯: ${nm.match} (${nm.reason})`).join('\n')}\n`;

    let tournamentContextPrompt = "";
    if (currentTournament === 'summer') {
        tournamentContextPrompt = "3å¹´ç”Ÿã«ã¨ã£ã¦ã¯ã‚¬ãƒã§æœ€å¾Œã®å¤ã‚„ã€‚";
    } else if (currentTournament === 'summer_koshien') {
        tournamentContextPrompt = "å…¨å›½ã®çŒ›è€…ãŒé›†ã†ç”²å­åœ’ã‚„ã€‚è² ã‘ãŸã‚‰çµ‚ã‚ã‚Šã€‚";
    } else if (currentTournament === 'autumn') {
        tournamentContextPrompt = "æ–°ãƒãƒ¼ãƒ ã®åˆé™£ã‚„ãªã€‚";
    } else if (currentTournament === 'spring') {
        tournamentContextPrompt = "å¤ã®ã‚·ãƒ¼ãƒ‰æ¨©ãŒã‹ã‹ã£ãŸå‰å“¨æˆ¦ã‚„ã€‚";
    }

    // â˜…â˜…â˜… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã€ŒCãƒ©ãƒ³ã‚¯ã¸ã®åå¿œã€ã‚’å…·ä½“çš„ã«è¿½åŠ  â˜…â˜…â˜…
    const prompt = `ã‚ãªãŸã¯ã€åŒ¿åæ²ç¤ºæ¿ã€Œãªã‚“ã§ã‚‚å®Ÿæ³Jï¼ˆãªã‚“Jï¼‰ã€ã®ä½æ°‘ã§ã™ã€‚
${tournamentYear}å¹´åº¦ ${tournamentName}ã®çµ„ã¿åˆã‚ã›æŠ½é¸ä¼šãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚
ä»¥ä¸‹ã®è©³ç´°ãªåˆ†æçµæœã‚’åŸºã«ã€**ãªã‚“Jã‚‰ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«**ã¨ã€ãã®ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã§ã®**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªåå¿œã‚³ãƒ¡ãƒ³ãƒˆã‚’20ã€œ25å€‹**ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### å¤§ä¼šã®æ–‡è„ˆ
${tournamentContextPrompt}

### çµ„ã¿åˆã‚ã›åˆ†æçµæœ
${analysisText}

### ã‚³ãƒ¡ãƒ³ãƒˆã®æ–¹å‘æ€§ (é‡è¦)
- **å…¨ä½“æ„Ÿ:** ã€Œæ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã€ã‚„ã€Œæµã¾ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã€ã®æ ¼å·®ã«ãƒ„ãƒƒã‚³ãƒŸã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚
- **å¼·è±ª:** ã€Œ1å›æˆ¦ã®æ½°ã—åˆã„ã€ã«ã¯ã€ã€Œã‚‚ã£ãŸã„ãªã„ã€ã€Œã„ããªã‚Šã‚¯ãƒ©ã‚¤ãƒãƒƒã‚¯ã‚¹ã€ã¨å˜†ã„ã¦ãã ã•ã„ã€‚
- **ã€â˜…æœ€é‡è¦ï¼šCãƒ©ãƒ³ã‚¯(ä¸­å …æ ¡)ã¸ã®åå¿œã€‘:** - ã€Œãã®ä»–ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰ã€ã«å«ã¾ã‚Œã‚‹**Cãƒ©ãƒ³ã‚¯ãƒãƒ¼ãƒ **ã«å¯¾ã—ã¦ã¯ã€å˜ãªã‚‹å¼±å°æ‰±ã„ã§ã¯ãªãã€**ã€Œã“ã„ã¤ã‚‰åœ°å‘³ã«å¼·ã„ãã€ã€Œã‚·ãƒ¼ãƒ‰æ ¡ã‚‚æ²¹æ–­ã—ãŸã‚‰å–°ã‚ã‚Œã‚‹ã€ã€Œä»Šå¹´ã®ãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹æ ã€**ã¨ã„ã£ãŸã€**ä¸æ°—å‘³ã•ã‚„æ³¢ä¹±ã‚’æœŸå¾…ã™ã‚‹ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³**ã‚’å¿…ãšè¤‡æ•°å«ã‚ã¦ãã ã•ã„ã€‚
  - ã€ŒCãƒ©ãƒ³ã‚¯ã‚’ãƒŠãƒ¡ã¦ã‚‹ã¨ç—›ã„ç›®è¦‹ã‚‹ã§ã€ã€Œã€‡ã€‡ï¼ˆCãƒ©ãƒ³ã‚¯ï¼‰ã¯ãƒ¯ãƒ³ãƒãƒ£ãƒ³ã‚ã‚‹ã€ã¨ã„ã£ãŸã€é€šå¥½ã¿ã®ç„äººã‚³ãƒ¡ãƒ³ãƒˆã‚’æ··ãœã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼ (JSON)
{
  "threadTitle": "ï¼ˆ${tournamentName}çµ„ã¿åˆã‚ã›æ±ºå®šwww æ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯ã€‡ã€‡ï¼ï¼‰",
  "comments": [
    {"personality": "1: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆã‚¹ãƒ¬ä¸»ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"},
    {"personality": "2: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆä½æ°‘2ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"}
    // ... (åˆè¨ˆ20ã€œ25å€‹ã®ã‚³ãƒ¡ãƒ³ãƒˆ) ...
  ]
}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const bbsJson = parseJsonFromText(rawText);
            
            if (bbsJson && bbsJson.threadTitle && Array.isArray(bbsJson.comments)) {
                return {
                    id: `bracket-thread-${Date.now()}`, 
                    title: bbsJson.threadTitle,
                    matchId: 'bracket', 
                    comments: bbsJson.comments.map((c, index) => ({ 
                        id: crypto.randomUUID(),
                        personality: c.personality || `${index + 1}: é¢¨å¹ã‘ã°åç„¡ã—`, 
                        text: c.comment,
                        timestamp: Date.now() + index * 10, 
                        replies: [] 
                    })),
                    timestamp: Date.now() 
                };
            }
        }
        throw new Error("AI response format error.");
    } catch (error) {
        console.error("AIçµ„ã¿åˆã‚ã›åå¿œã‚¹ãƒ¬ãƒƒãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return {
            error: true,
            title: "çµ„ã¿åˆã‚ã›ã‚¹ãƒ¬ãƒƒãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼",
            body: "AIã«ã‚ˆã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 
            timestamp: Date.now(),
            errorId: `bracket-thread-error-${Date.now()}` 
        };
    }
}// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

// â–¼â–¼â–¼ ã€æ–°è¦è¿½åŠ ã€‘CPUãƒãƒ¼ãƒ ã®æ¶ç©ºæˆç¸¾è‡ªå‹•ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ  â–¼â–¼â–¼

/**
 * [FIXED] ãƒãƒ¼ãƒ ã«ãƒ­ã‚¹ã‚¿ãƒ¼ï¼ˆé¸æ‰‹åç°¿ï¼‰ãŒãªã‘ã‚Œã°ç”Ÿæˆã™ã‚‹
 * (â˜…ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆãƒãƒ¼ãƒ ã«ã‚‚ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ã‚’å‰²ã‚Šå½“ã¦ã‚‹ä¿®æ­£ç‰ˆ)
 */
function ensureCpuRoster(teamName) {
    const record = tournamentState.teamRecords[teamName];
    if (!record) return null;

    // æ—¢ã«ãƒ­ã‚¹ã‚¿ãƒ¼ãŒå­˜åœ¨ã™ã‚Œã°ã€ãã‚Œã‚’è¿”ã™
    if (record.roster && record.roster.length > 0) {
        return record.roster;
    }

    let newRoster = [];

    // --- ãƒ‘ã‚¿ãƒ¼ãƒ³A: ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ (283å­¦åœ’ãªã©) ---
    if (TEAM_ROSTER_MASTER[teamName]) {
        const master = TEAM_ROSTER_MASTER[teamName];
        
        newRoster = master.map((p, index) => {
            const order = (index < 9) ? (index + 1).toString() : null;
            
            let posShort = p.position ? p.position.charAt(0) : 'æ§';
            if (p.position && p.position.includes("å¤–")) posShort = "ä¸­";
            if (p.position && p.position.includes("å³")) posShort = "å³";
            if (p.position && p.position.includes("å·¦")) posShort = "å·¦";
            if (p.position && p.position.includes("ä¸­")) posShort = "ä¸­";

            return {
                order: order,
                name: p.name,
                number: p.number,
                pos: posShort,
                throwBat: p.throwBat || 'R/R',
                sub_type: null,
                isCaptain: p.isCaptain || false // ãƒã‚¹ã‚¿æŒ‡å®šã®ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ã‚’åæ˜ 
            };
        });
        
    } 
    // --- ãƒ‘ã‚¿ãƒ¼ãƒ³B: ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ (CPUãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ) ---
    else {
        // 1. å®ˆå‚™ä½ç½®ã¨èƒŒç•ªå·ã®ãƒšã‚¢ã‚’ä½œæˆ
        const positionSlots = [
            { pos: 'æŠ•', num: 1 }, { pos: 'æ•', num: 2 }, { pos: 'ä¸€', num: 3 },
            { pos: 'äºŒ', num: 4 }, { pos: 'ä¸‰', num: 5 }, { pos: 'éŠ', num: 6 },
            { pos: 'å·¦', num: 7 }, { pos: 'ä¸­', num: 8 }, { pos: 'å³', num: 9 }
        ];

        // 2. æ‰“é †ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®š
        const shuffledSlots = shuffleArray([...positionSlots]);

        // 3. å›ºå®šé¸æ‰‹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        const detailedData = DETAILED_TEAM_DATA[teamName];
        let predefinedPlayers = [];
        if (detailedData && detailedData.players) {
            predefinedPlayers = [...detailedData.players];
        }

        // 4. ã‚¹ã‚¿ãƒ¡ãƒ³ç”Ÿæˆ
        for (let i = 1; i <= 9; i++) {
            let assignedSlot = null;
            let playerEntry;
            
            if (predefinedPlayers.length > 0) {
                const p = predefinedPlayers.shift();
                let posShort = p.position ? p.position.charAt(0) : 'æ§';
                if (p.position && p.position.includes("å¤–")) posShort = "ä¸­";
                
                const slotIndex = shuffledSlots.findIndex(s => s.pos === posShort);
                if (slotIndex !== -1) {
                    assignedSlot = shuffledSlots.splice(slotIndex, 1)[0];
                } else {
                    assignedSlot = shuffledSlots.shift();
                }

                playerEntry = {
                    order: i.toString(),
                    name: p.name,
                    number: assignedSlot ? assignedSlot.num : i, 
                    pos: posShort,
                    throwBat: 'R/R',
                    sub_type: null,
                    isCaptain: false // å¾Œã§è¨­å®š
                };
            } else {
                assignedSlot = shuffledSlots.shift();
                playerEntry = {
                    order: i.toString(),
                    name: JAPANESE_SURNAMES[Math.floor(Math.random() * JAPANESE_SURNAMES.length)],
                    number: assignedSlot.num,
                    pos: assignedSlot.pos,
                    throwBat: Math.random() > 0.3 ? 'R/R' : 'L/L',
                    sub_type: null,
                    isCaptain: false // å¾Œã§è¨­å®š
                };
            }
            newRoster.push(playerEntry);
        }
        
        // 5. æ§ãˆé¸æ‰‹ç”Ÿæˆ
        const benchPositions = [
            { pos: 'æŠ•', num: 10 }, { pos: 'æŠ•', num: 11 }, { pos: 'æ•', num: 12 },
            { pos: 'ä¸€', num: 13 }, { pos: 'äºŒ', num: 14 }, { pos: 'ä¸‰', num: 15 },
            { pos: 'éŠ', num: 16 }, { pos: 'å·¦', num: 17 }, { pos: 'ä¸­', num: 18 }
        ];

        for (const benchSlot of benchPositions) {
            let playerEntry;
            if (predefinedPlayers.length > 0) {
                const p = predefinedPlayers.shift();
                playerEntry = { 
                    order: null, name: p.name, number: benchSlot.num, pos: benchSlot.pos, 
                    throwBat: 'R/R', sub_type: null, isCaptain: false 
                };
            } else {
                playerEntry = { 
                    order: null, 
                    name: JAPANESE_SURNAMES[Math.floor(Math.random() * JAPANESE_SURNAMES.length)], 
                    number: benchSlot.num, pos: benchSlot.pos, 
                    throwBat: 'R/R', sub_type: null, isCaptain: false 
                };
            }
            newRoster.push(playerEntry);
        }

        // â˜…â˜…â˜… è¿½åŠ : ã‚¹ã‚¿ãƒ¡ãƒ³ã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1äººã‚’ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ã«ä»»å‘½ â˜…â˜…â˜…
        // (0ã€œ8ç•ªç›®ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ = æ‰“é †1ã€œ9ç•ª)
        const captainIndex = Math.floor(Math.random() * 9);
        if (newRoster[captainIndex]) {
            newRoster[captainIndex].isCaptain = true;
        }
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    }

    // ä¿å­˜ã—ã¦è¿”ã™
    record.roster = newRoster;
    return newRoster;
}
/**
 * ã€ä¿®æ­£ç‰ˆã€‘ãƒãƒ¼ãƒ ã®éå»è©¦åˆï¼ˆã‚¹ã‚­ãƒƒãƒ—å«ã‚€ï¼‰ã®æˆç¸¾ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹
 * â˜…å››çƒ(bb)ã‚„å¡æ‰“æ•°(tb)ã‚‚ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã€åˆ†æã‚°ãƒ©ãƒ•ã‚’é¢ç™½ãã™ã‚‹
 */
function backfillCpuStats(teamName) {
    const record = tournamentState.teamRecords[teamName];
    if (!record) return;

    // ãƒ­ã‚¹ã‚¿ãƒ¼å–å¾—ï¼ˆãªã‘ã‚Œã°ç”Ÿæˆï¼‰
    const roster = ensureCpuRoster(teamName);
    
    // ã‚¨ãƒ¼ã‚¹ç‰¹å®š
    let acePitcher = roster.find(p => p.number === 1) || roster.find(p => p.pos === 'æŠ•') || roster[0];

    const allMatches = { 
        ...tournamentState.matches, 
        ...(tournamentState.autumnData?.allMatches || {}),
        ...(tournamentState.springData?.allMatches || {}) 
    };

    Object.keys(allMatches).forEach(matchId => {
        const match = allMatches[matchId];
        
        // ã“ã®ãƒãƒ¼ãƒ ãŒé–¢ã‚ã£ã¦ã„ã¦ã€ã‹ã¤å‹æ•—ãŒæ±ºã¾ã£ã¦ã„ã‚‹è©¦åˆã®ã¿
        if (match.winner && (match.team1 === teamName || match.team2 === teamName)) {

            // â˜…äºŒé‡è¨ˆä¸Šé˜²æ­¢ï¼ˆè©³ç´°å…¥åŠ›ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
            if (match.details && (match.details.batting?.team1?.length > 0 || match.details.batting?.team2?.length > 0)) {
                return; 
            }

            // â˜…äºŒé‡è¨ˆä¸Šé˜²æ­¢ï¼ˆæ—¢ã«ãƒ­ã‚°ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
            let alreadyHasStats = false;
            if (record.playerStats?.batting) {
                for (const pName in record.playerStats.batting) {
                    if (record.playerStats.batting[pName].gamelogs?.some(l => l.matchId === matchId)) {
                        alreadyHasStats = true; break;
                    }
                }
            }
            if (alreadyHasStats) return;

            // --- è‡ªå‹•ç”Ÿæˆé–‹å§‹ ---
            if (!record.playerStats) record.playerStats = { batting: {}, pitching: {} };
            if (!record.tournamentStats) {
                record.tournamentStats = { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0, sb: 0, bb: 0, hbp: 0, sf: 0, tb: 0, r: 0, so: 0 };
            }
            
            // æŠ•æ‰‹ç”¨ã‚³ãƒ³ãƒ†ãƒŠåˆæœŸåŒ–
            if (!record.playerStats.pitching[acePitcher.name]) {
                record.playerStats.pitching[acePitcher.name] = { 
                    career: { games:0, w:0, l:0, ip:0, so:0, er:0, h:0, bb:0 }, 
                    gamelogs: [], narrative_flag: 'normal' 
                };
            }

            const isWin = match.winner === teamName;
            const oppScore = parseInt(match.team1 === teamName ? match.score2 : match.score1) || 0;
            const myScore = parseInt(match.team1 === teamName ? match.score1 : match.score2) || 0;
            const opponentName = match.team1 === teamName ? match.team2 : match.team1;
            const roundName = getRoundNameFromMatchId(matchId);

            // A. æŠ•æ‰‹æˆç¸¾ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            const ip = 9;
            const er = Math.max(0, oppScore - Math.floor(Math.random() * 2)); // è‡ªè²¬ç‚¹ã¯å¤±ç‚¹ã‚ˆã‚Šå°‘ã—å°‘ãªã„
            const hitsAllowed = Math.max(3, oppScore * 2 + Math.floor(Math.random() * 4));
            const so = Math.floor(Math.random() * 8) + 2;
            const bbAllowed = Math.floor(Math.random() * 5);
            
            const pLog = {
                matchId: matchId, date: match.schedule?.date || 'æ—¥ä»˜ä¸æ˜', round: roundName,
                opponent: opponentName, opponentRank: calculateRank(opponentName, tournamentState),
                result: isWin ? 'W' : 'L', ip: ip, h: hitsAllowed, bb: bbAllowed, so: so, r: oppScore, er: er
            };
            
            record.playerStats.pitching[acePitcher.name].gamelogs.push(pLog);
            const pCareer = record.playerStats.pitching[acePitcher.name].career;
            pCareer.games = (pCareer.games || 0) + 1;
            if (isWin) pCareer.w++; else pCareer.l++;
            pCareer.ip = (pCareer.ip || 0) + ip;
            pCareer.er = (pCareer.er || 0) + er;
            pCareer.so = (pCareer.so || 0) + so;
            pCareer.h = (pCareer.h || 0) + hitsAllowed;
            pCareer.bb = (pCareer.bb || 0) + bbAllowed;

            // B. æ‰“æ’ƒæˆç¸¾ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (â˜…ã“ã“ã‚’å¼·åŒ–)
            roster.forEach(batter => {
                if (batter.pos === 'æŠ•') return; // æŠ•æ‰‹ã¯çœç•¥(ç°¡æ˜“åŒ–)
                
                if (!record.playerStats.batting[batter.name]) {
                    record.playerStats.batting[batter.name] = { games:0, pa:0, ab:0, h:0, hr:0, rbi:0, sb:0, bb:0, tb:0, gamelogs: [] };
                }
                
                const orderNum = parseInt(batter.order);
                const isCleanup = orderNum >= 3 && orderNum <= 5;
                const isLeadOff = orderNum === 1;

                // æ‰“ç‡è¨­å®š (å‹åˆ©ãƒãƒ¼ãƒ ã‚„ã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—ã¯æ‰“ã¤)
                let hitProb = isWin ? 0.30 : 0.20;
                if (isCleanup) hitProb += 0.05;

                // â˜…å››çƒç‡è¨­å®š
                let walkProb = 0.08; 
                if (isLeadOff || isCleanup) walkProb += 0.05; // 1ç•ªã¨ã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—ã¯é¸ã¶

                const pa = Math.floor(Math.random() * 2) + 3; // 3~5æ‰“å¸­
                let h = 0, bb = 0, hr = 0, tb = 0, rbi = 0, sb = 0;

                for(let k=0; k < pa; k++) {
                    const rand = Math.random();
                    if (rand < hitProb) {
                        // ãƒ’ãƒƒãƒˆã®å†…è¨³æŠ½é¸ (å˜æ‰“:70%, äºŒå¡æ‰“:20%, ä¸‰å¡æ‰“:2%, æœ¬å¡æ‰“:8%)
                        h++;
                        const hitType = Math.random();
                        if (hitType < 0.70) { tb += 1; } // Single
                        else if (hitType < 0.90) { tb += 2; } // Double
                        else if (hitType < 0.92) { tb += 3; } // Triple
                        else { tb += 4; hr++; } // HR
                    } else if (rand < hitProb + walkProb) {
                        bb++; // å››çƒ
                    }
                }
                
                // æ‰“ç‚¹ (HRãªã‚‰å¿…ãšå…¥ã‚‹ + ãƒ©ãƒ³ãƒ€ãƒ )
                if (hr > 0) rbi += hr + Math.floor(Math.random() * 2);
                else if (h > 0 && isCleanup && myScore > 0) rbi += Math.floor(Math.random() * 2);

                // ç›—å¡ (1ç•ªãƒ»2ç•ªã¯èµ°ã‚Šã‚„ã™ã„)
                if ((h > 0 || bb > 0) && (orderNum <= 2 || Math.random() < 0.1)) {
                    if (Math.random() < 0.3) sb++;
                }

                const ab = pa - bb; // æ‰“æ•° = æ‰“å¸­ - å››çƒ

                const bLog = {
                    matchId: matchId, date: match.schedule?.date || 'æ—¥ä»˜ä¸æ˜', round: roundName,
                    opponent: opponentName, opponentRank: calculateRank(opponentName, tournamentState),
                    order: batter.order, 
                    stats: { ab, h, hr, rbi, sb, bb, tb } // â˜…è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                };

                record.playerStats.batting[batter.name].gamelogs.push(bLog);
                
                const bCareer = record.playerStats.batting[batter.name];
                bCareer.games = (bCareer.games || 0) + 1;
                bCareer.pa = (bCareer.pa || 0) + pa;
                bCareer.ab = (bCareer.ab || 0) + ab;
                bCareer.h += h;
                bCareer.hr += hr;
                bCareer.rbi += rbi;
                bCareer.sb += sb;
                bCareer.bb = (bCareer.bb || 0) + bb; // â˜…å››çƒã‚’åŠ ç®—
                bCareer.tb = (bCareer.tb || 0) + tb; // â˜…å¡æ‰“ã‚’åŠ ç®—

                // ãƒãƒ¼ãƒ åˆè¨ˆã«ã‚‚åŠ ç®—
                record.tournamentStats.pa += pa;
                record.tournamentStats.ab += ab;
                record.tournamentStats.h += h;
                record.tournamentStats.hr += hr;
                record.tournamentStats.rbi += rbi;
                record.tournamentStats.sb += sb;
                record.tournamentStats.bb += bb;
                record.tournamentStats.tb += tb;
            });
        }
    });
}

/**
 * [UPDATED] å¤§ä¼šçµ‚äº†æ™‚ã«ã€å…¨ãƒãƒ¼ãƒ ã®æœ€çµ‚é †ä½ã‚’è¨˜éŒ²ã™ã‚‹
 * (â˜…ç”²å­åœ’ã®å ´åˆã¯ãƒã‚¤ãƒŠã‚¹ã®å€¤ã‚’è¨˜éŒ²ã—ã¦åŒºåˆ¥ã™ã‚‹)
 */
function updateTournamentFinishRecords() {
    const { matches, teams, currentTournament } = tournamentState;
    if (!teams || teams.length === 0) return;

    const numTeams = teams.length; 
    const finalRound = Math.log2(numTeams);
    
    // â˜… ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹åˆ¤å®š
    const isKoshien = (currentTournament === 'summer_koshien');

    // æ•—è€…ã‚’ç‰¹å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
    const getRoundLosers = (round, side) => {
        const losers = [];
        const numMatches = (numTeams / 2) / Math.pow(2, round - 1); 
        for (let m = 1; m <= numMatches; m++) {
            const match = matches[`${side}-R${round}-M${m}`];
            if (match && match.winner) {
                const loser = match.winner === match.team1 ? match.team2 : match.team1;
                if (loser && loser !== '(BYE)') losers.push(loser);
            }
        }
        return losers;
    };

    const finalMatch = matches['F-R1-M1'];
    if (finalMatch && finalMatch.winner) {
        const winner = finalMatch.winner;
        const runnerUp = finalMatch.winner === finalMatch.team1 ? finalMatch.team2 : finalMatch.team1;
        
        // â˜… ç”²å­åœ’ãªã‚‰ -1(å„ªå‹), -2(æº–å„ªå‹)ã€‚é€šå¸¸ãªã‚‰ 1, 2
        if (winner && tournamentState.teamRecords[winner]) {
            tournamentState.teamRecords[winner].lastFinish = isKoshien ? -1 : 1;
        }
        if (runnerUp && tournamentState.teamRecords[runnerUp]) {
            tournamentState.teamRecords[runnerUp].lastFinish = isKoshien ? -2 : 2;
        }
    }

    // æº–æ±ºå‹ä»¥å‰ã®æ•—é€€é †ä½ã‚’è¨˜éŒ²
    for (let r = finalRound - 1; r >= 1; r--) { 
        const finishRank = Math.pow(2, finalRound - r); // 4, 8, 16...
        
        // â˜… ç”²å­åœ’ãªã‚‰ãƒã‚¤ãƒŠã‚¹ã«ã™ã‚‹ (ä¾‹: -4, -8, -16...)
        const recordRank = isKoshien ? -finishRank : finishRank;
        
        getRoundLosers(r, 'L').concat(getRoundLosers(r, 'R')).forEach(t => {
            if (t && tournamentState.teamRecords[t]) {
                tournamentState.teamRecords[t].lastFinish = recordRank;
            }
        });
    }

    // å±¥æ­´(history)ã¨æœ€é«˜æˆç¸¾(best)ã®æ›´æ–°
    Object.keys(tournamentState.teamRecords).forEach(team => {
        const record = tournamentState.teamRecords[team];
        if(!record.lastFinish) return;

        const newHistoryRecord = {
            year: tournamentState.tournamentYear,
            tournament: currentTournament,
            rank: record.lastFinish
        };

        if (!record.history) record.history = [];
        record.history.unshift(newHistoryRecord);

        // æœ€é«˜æˆç¸¾ã®æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ (ãƒã‚¤ãƒŠã‚¹ã®æ–¹ãŒå¼·ã„)
        if (!record.best) {
            record.best = newHistoryRecord;
        } else {
            const currentBestIsKoshien = record.best.rank < 0;
            const newIsKoshien = newHistoryRecord.rank < 0;

            if (newIsKoshien) {
                // ä»Šå›ãŒç”²å­åœ’è¨˜éŒ²ã®å ´åˆ
                if (!currentBestIsKoshien) {
                    // éå»ãŒçœŒå¤§ä¼šè¨˜éŒ²ãªã‚‰ã€å•ç­”ç„¡ç”¨ã§æ›´æ–° (ç”²å­åœ’ > çœŒå¤§ä¼š)
                    record.best = newHistoryRecord;
                } else {
                    // éå»ã‚‚ç”²å­åœ’ãªã‚‰ã€æ•°å­—ãŒå¤§ãã„æ–¹ï¼ˆçµ¶å¯¾å€¤ãŒå°ã•ã„æ–¹ï¼‰ãŒä¸Š (-1 > -8)
                    if (newHistoryRecord.rank > record.best.rank) {
                        record.best = newHistoryRecord;
                    }
                }
            } else {
                // ä»Šå›ãŒçœŒå¤§ä¼šè¨˜éŒ²ã®å ´åˆ
                if (!currentBestIsKoshien) {
                    // éå»ã‚‚çœŒå¤§ä¼šãªã‚‰ã€æ•°å­—ãŒå°ã•ã„æ–¹ãŒä¸Š (1 < 8)
                    if (newHistoryRecord.rank < record.best.rank) {
                        record.best = newHistoryRecord;
                    }
                }
                // éå»ãŒç”²å­åœ’ãªã‚‰æ›´æ–°ã—ãªã„
            }
        }
    });
}

/**
 * [NEW] ãƒ©ãƒ³ã‚¯åˆ†å¸ƒãƒ”ãƒ©ãƒŸãƒƒãƒ‰ã‚’æç”»ã™ã‚‹é–¢æ•°
 * ãƒãƒ¼ãƒ æ•°ã«å¿œã˜ã¦å¹…ãŒå¤‰ã‚ã‚‹ã€ŒãŠè…¹ã®å‡ºãŸãƒ”ãƒ©ãƒŸãƒƒãƒ‰ã€ã‚’ç”Ÿæˆã—ã¾ã™
 */
function renderRankPyramid() {
    const container = document.getElementById('rank-pyramid-container');
    if (!container) {
        console.warn("Rank pyramid container not found.");
        return;
    }

    // 1. å…¨ãƒãƒ¼ãƒ ã®ãƒ©ãƒ³ã‚¯ã‚’é›†è¨ˆ
    const counts = { A: 0, B: 0, C: 0, D: 0, E: 0 };
    // TEAM_DATA ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¾ã™
    const allTeams = Object.keys(TEAM_DATA);
    
    allTeams.forEach(teamName => {
        // ç¾åœ¨ã®ãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ©ãƒ³ã‚¯ã‚’åˆ¤å®š (tournamentStateãŒå¿…è¦)
        const rank = calculateRank(teamName, tournamentState);
        if (counts[rank] !== undefined) {
            counts[rank]++;
        } else {
            // ä¸‡ãŒä¸€æƒ³å®šå¤–ã®ãƒ©ãƒ³ã‚¯ãŒè¿”ã£ã¦ããŸå ´åˆ
            if (!counts['E']) counts['E'] = 0;
            counts['E']++; 
        }
    });

    // 2. æœ€å¤§æ•°ã‚’å–å¾—ï¼ˆã‚°ãƒ©ãƒ•ã®æ¨ªå¹…100%ã®åŸºæº–ã«ã™ã‚‹ãŸã‚ï¼‰
    const maxCount = Math.max(...Object.values(counts));

    // 3. HTMLç”Ÿæˆ
    const ranks = ['A', 'B', 'C', 'D', 'E'];
    const labels = {
        A: 'A:åé–€', B: 'B:å¼·è±ª', C: 'C:ä¸­å …', D: 'D:ç™ºå±•', E: 'E:æŒ‘æˆ¦'
    };
    // Tailwind CSSã®è‰²ã‚¯ãƒ©ã‚¹
    const colors = {
        A: 'bg-red-500',     // èµ¤
        B: 'bg-orange-400',  // ã‚ªãƒ¬ãƒ³ã‚¸
        C: 'bg-yellow-400',  // é»„è‰²
        D: 'bg-blue-400',    // é’
        E: 'bg-gray-400'     // ã‚°ãƒ¬ãƒ¼
    };

    let html = '<div class="flex flex-col items-center w-full space-y-2">';

    ranks.forEach(rank => {
        const count = counts[rank];
        // æ¨ªå¹…ã®è¨ˆç®— (æœ€å¤§å€¤ã‚’100%ã¨ã—ã€æœ€ä½ã§ã‚‚10%ã¯ç¢ºä¿ã—ã¦è¦‹ã‚„ã™ãã™ã‚‹)
        // countãŒ0ã®å ´åˆã¯å¹…0ã«ã™ã‚‹
        const widthPct = count > 0 ? Math.max(10, (count / maxCount) * 100) : 0;
        
        html += `
            <div class="w-full flex items-center justify-center text-xs group">
                <div class="w-16 text-right mr-2 font-semibold text-gray-600">${labels[rank]}</div>
                
                <div class="flex-grow flex justify-center h-6">
                    <div class="${colors[rank]} text-white font-bold rounded-sm flex items-center justify-center shadow-sm transition-all duration-500 relative" 
                         style="width: ${widthPct}%; height: 100%;">
                        ${count > 0 ? count : ''}
                        
                        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-black text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10">
                            ${count}ãƒãƒ¼ãƒ 
                        </span>
                    </div>
                </div>
                
                <div class="w-16 ml-2"></div>
            </div>
        `;
    });

    html += '</div>';
    
    // åˆè¨ˆãƒãƒ¼ãƒ æ•°
    html += `<div class="text-center text-xs text-gray-400 mt-3 border-t pt-2">ç·ãƒãƒ¼ãƒ æ•°: ${allTeams.length}æ ¡</div>`;

    container.innerHTML = html;
}

// â–¼â–¼â–¼ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å­¦æ ¡æ¤œç´¢æ©Ÿèƒ½ (ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ) - å†æ•´ç†ç‰ˆ â–¼â–¼â–¼

const searchInput = document.getElementById('school-search-input');
const suggestionsList = document.getElementById('search-suggestions');

// 1. æ–‡å­—å…¥åŠ›æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢)
searchInput.addEventListener('input', () => {
    const query = searchInput.value.trim().toLowerCase();
    
    if (!query) {
        suggestionsList.classList.add('hidden');
        suggestionsList.innerHTML = '';
        return;
    }

    const allTeams = [...new Set([...INITIAL_TEAM_POOL, ...Object.keys(TEAM_DATA)])];

    const matches = allTeams.filter(teamName => {
        const data = TEAM_DATA[teamName] || {};
        // æ—¢å­˜ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯
        return (
            teamName.includes(query) || 
            (data.name_yomi && data.name_yomi.includes(query)) ||
            (data.region && data.region.includes(query)) ||
            (data.coach && data.coach.name && data.coach.name.includes(query)) 
        );
    }).slice(0, 10);

    // ãƒªã‚¹ãƒˆã®æç”» (ã“ã®é–¢æ•°ãŒãƒ¡ã‚¤ãƒ³æ¤œç´¢ã®è¡¨ç¤ºå°‚ç”¨ã¨ãªã‚Šã¾ã™)
    renderSchoolSearchSuggestions(matches, query);
});

// 2. ã€ãƒ¡ã‚¤ãƒ³æ¤œç´¢å°‚ç”¨ã€‘å€™è£œãƒªã‚¹ãƒˆã‚’æç”»ã™ã‚‹é–¢æ•°
function renderSchoolSearchSuggestions(teams, query) {
    suggestionsList.innerHTML = '';

    if (teams.length === 0) {
        suggestionsList.classList.add('hidden');
        return;
    }

    teams.forEach(teamName => {
        const data = TEAM_DATA[teamName] || {};
        const region = data.region || 'ä¸æ˜';
        const coach = data.coach ? data.coach.name : '';
        
        const li = document.createElement('li');
        li.className = 'suggestion-item';
        li.innerHTML = `
            <div>
                <span class="text-gray-800 font-medium">${highlightMatch(teamName, query)}</span>
                <span class="text-xs text-gray-500 ml-2">(${region})</span>
            </div>
            <div class="suggestion-meta">
                ${coach ? `ç›£ç£: ${coach}` : ''}
            </div>
        `;

        // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‹•ä½œ (â˜…ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‹•ä½œã«å›ºå®š)
        li.addEventListener('click', () => {
            searchInput.value = teamName;
            suggestionsList.classList.add('hidden');
            renderSchoolArchiveModal(teamName); 
        });

        suggestionsList.appendChild(li);
    });

    suggestionsList.classList.remove('hidden');
}


// 3. æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ (å®šç¾©ãŒé‡è¤‡ã—ãªã„ã‚ˆã†ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«æ®‹ã™)

// 4. å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹
document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !suggestionsList.contains(e.target)) {
        suggestionsList.classList.add('hidden');
    }
});

// 5. (æ—¢å­˜) æ¤œç´¢ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‹•ä½œ (ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã‚’å‘¼ã³å‡ºã™)
document.getElementById('school-search-btn').addEventListener('click', () => {
    const query = searchInput.value.trim();
    if (!query) return;
    
    // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™
    searchInput.dispatchEvent(new Event('input'));

    // å®Œå…¨ä¸€è‡´ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆ (æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç°¡ç•¥åŒ–)
    const allTeams = [...new Set([...INITIAL_TEAM_POOL, ...Object.keys(TEAM_DATA)])];
    const match = allTeams.find(t => t === query); 
    if (match) {
         renderSchoolArchiveModal(match);
         suggestionsList.classList.add('hidden');
    }
});
// â–²â–²â–² ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆæ©Ÿèƒ½ ã“ã“ã¾ã§ â–²â–²â–²



/**
 * æ¤œç´¢çµæœãŒè¤‡æ•°ã®å ´åˆã«ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
 */
function showSearchResultsList(teams, query) {
    const contentEl = document.getElementById('school-archive-content');
    const modal = document.getElementById('school-archive-modal');
    
    let html = `
        <div class="archive-header">
            <span class="archive-school-name">æ¤œç´¢çµæœ: "${query}"</span>
            <span class="archive-pref">${teams.length}ä»¶ ãƒ’ãƒƒãƒˆ</span>
        </div>
        <div class="mt-4">
            <ul class="search-result-list">
    `;

    teams.forEach(teamName => {
        const data = TEAM_DATA[teamName];
        const region = data.region || 'ä¸æ˜';
        const rank = calculateRank(teamName, tournamentState);
        const coach = data.coach ? data.coach.name : 'ä¸æ˜';

        // ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®å­¦æ ¡ã®è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        // (onclickå±æ€§ã§é–¢æ•°ã‚’å‘¼ã¶å½¢ã«ã—ã¾ã™)
        html += `
            <li class="search-result-item" onclick="document.getElementById('school-search-input').value='${teamName}'; document.getElementById('school-search-btn').click();">
                <div>
                    <span class="search-result-name">${teamName}</span>
                    <span class="search-result-tag">${region}</span>
                    <span class="search-result-tag bg-gray-100 text-gray-800">ãƒ©ãƒ³ã‚¯${rank}</span>
                </div>
                <div class="search-result-info">
                    ç›£ç£: ${coach} / æœ€é«˜æˆç¸¾: ${data.best || '-'}
                </div>
            </li>
        `;
    });

    html += `
            </ul>
        </div>
    `;

    contentEl.innerHTML = html;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}
// â–²â–²â–² å­¦æ ¡æ¤œç´¢æ©Ÿèƒ½ã“ã“ã¾ã§ â–²â–²â–²

/**
 * [FIXED] ãƒãƒ¼ãƒ ã®éå»ã®è©¦åˆçµæœã‹ã‚‰ã€Œå‹ã¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã¨ã€Œãƒãƒ¼ãƒ ã‚«ãƒ©ãƒ¼ã€ã‚’åˆ†æã™ã‚‹
 * (â˜…æ‰“ç‡ã¨OPSã®ä¸¡æ–¹ã‚’è©•ä¾¡æŒ‡æ¨™ã¨ã—ã¦è¨ˆç®—ã™ã‚‹ä¿®æ­£ç‰ˆ)
 */
function analyzeTeamColor(teamName) {
    const record = tournamentState.teamRecords[teamName];
    if (!record || record.wins + (record.losses || 0) === 0) {
        return { primary: 'ä¸æ˜', secondary: 'ä¸æ˜', comment: 'è©¦åˆçµŒé¨“ä¸è¶³ã®ãŸã‚åˆ†æã§ãã¾ã›ã‚“ã€‚' };
    }
    
    const analysis = {
        totalWins: record.wins || 0,
        comebackWins: 0,
        wireToWireWins: 0,
        totalTeamIP: 0,
        aceIP: 0,
        topRCShare: 0,
        offenseScore: 0,
        pitchingScore: 0,
        teamOPS: 0,
        teamAvg: 0 // â˜…è¿½åŠ 
    };
    
    // --- 1. ä¾å­˜åº¦åˆ†æ (RCã‚·ã‚§ã‚¢) ã®è¨ˆç®— ---
    const aceName = record.roster?.find(p => p.number === 1)?.name || 'ã‚¨ãƒ¼ã‚¹';
    let teamTotalRC = 0;
    
    const players = Object.keys(record.playerStats?.batting || {}).map(name => {
        const s = record.playerStats.batting[name];
        const h = s.h || 0; const bb = (s.bb || 0) + (s.hbp || 0);
        const ab = s.ab || 0; const hr = s.hr || 0;
        const tb = (s.tb || h) + (hr * 3);
        const times = ab + bb;
        let rc = times > 0 ? ((h + bb) * tb) / times : 0;
        rc = isNaN(rc) ? 0 : rc;
        teamTotalRC += rc;
        return { name, rc };
    }).sort((a, b) => b.rc - a.rc);

    if (players.length > 0 && teamTotalRC > 0) {
        analysis.topRCShare = (players[0].rc / teamTotalRC) * 100;
    }
    
    // æŠ•æ‰‹ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆ
    const pitchingStats = record.playerStats?.pitching || {};
    for (const name in pitchingStats) {
        const pStats = pitchingStats[name].career;
        if (pStats) {
            analysis.totalTeamIP += pStats.ip || 0;
            if (name === aceName) {
                analysis.aceIP = pStats.ip || 0;
            }
        }
    }
    
    // --- 2. è©¦åˆãƒ•ãƒ­ãƒ¼åˆ†æ (å¤‰æ›´ãªã—) ---
    const allMatches = { ...tournamentState.matches, ...(tournamentState.autumnData?.allMatches || {}), ...(tournamentState.springData?.allMatches || {}) };
    Object.values(allMatches).forEach(match => {
        if (match.winner === teamName && match.details?.inningScore) {
            const inningScores = match.details.inningScore;
            const teamKey = match.team1 === teamName ? 'team1' : 'team2';
            const oppKey = teamKey === 'team1' ? 'team2' : 'team1';
            let scoreSelf = 0; let scoreOpp = 0;
            const inningsToCheck = Math.min(5, inningScores[teamKey].length);
            for (let i = 0; i < inningsToCheck; i++) {
                scoreSelf += parseInt(inningScores[teamKey][i] || 0);
                scoreOpp += parseInt(inningScores[oppKey][i] || 0);
            }
            if (scoreSelf < scoreOpp) analysis.comebackWins++;
            else if (scoreSelf > scoreOpp || inningsToCheck === 0) analysis.wireToWireWins++;
        }
    });

    // --- 3. ãƒ‰ãƒŸãƒŠãƒ³ã‚¹åˆ†æ (æ‰“ç‡ã¨OPSã®è¨ˆç®—) ---
    const ts = record.tournamentStats || {};
    const tab = ts.ab || 0;
    const th = ts.h || 0; 
    const tbb = (ts.bb || 0) + (ts.hbp || 0); 
    const tsf = ts.sf || 0;
    
    // æ‰“ç‡
    analysis.teamAvg = tab > 0 ? th / tab : 0;

    // OPS
    const tpa = tab + tbb + tsf;
    const tobp = tpa > 0 ? (th + tbb) / tpa : 0;
    const safeTB = ts.tb || (th + (ts.hr || 0) * 3);
    const safeSLG = tab > 0 ? safeTB / tab : 0;
    analysis.teamOPS = tobp + safeSLG;

    const teamERA = calculateTeamPitchingStats(teamName).era === "----" ? 9.99 : parseFloat(calculateTeamPitchingStats(teamName).era);
    
    // æ”»æ’ƒã‚¹ã‚³ã‚¢ (OPSã¨æ‰“ç‡ã®ä¸¡æ–¹ã‚’åŠ å‘³)
    analysis.offenseScore = (analysis.teamOPS * 70) + (analysis.teamAvg * 30); 
    analysis.pitchingScore = (10 - teamERA) * 10; 

    // 4. åˆ†é¡ã¨ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
    let color = { primary: '', secondary: '' };
    let narrative = { primary: '', secondary: '' };
    
    if (analysis.pitchingScore > 70 && analysis.teamOPS < 0.700) {
        color.primary = 'å®ˆå‚™å‹åˆ©å‹';
        narrative.primary = `é˜²å¾¡ç‡${teamERA.toFixed(2)}ã‚’èª‡ã‚‹æŠ•æ‰‹åŠ›ã‚’è»¸ã«ã€å°‘ãªã„å¾—ç‚¹ã‚’å®ˆã‚Šåˆ‡ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã§ã™ã€‚`;
    } else if (analysis.teamOPS >= 0.850) {
        color.primary = 'ç ´å£Šçš„æ‰“æ’ƒå‹';
        narrative.primary = `ãƒãƒ¼ãƒ OPS ${analysis.teamOPS.toFixed(3)} ã¨ã„ã†åœ§å€’çš„ãªç ´å£ŠåŠ›ã‚’æŒã¡ã€é•·æ‰“ã§ç›¸æ‰‹ã‚’ç²‰ç •ã—ã¾ã™ã€‚`;
    } else if (analysis.teamAvg >= 0.350) { // â˜…é«˜æ‰“ç‡ãƒãƒ¼ãƒ ã®åˆ¤å®šã‚’è¿½åŠ 
        color.primary = 'å®‰æ‰“è£½é€ æ©Ÿå‹';
        narrative.primary = `ãƒãƒ¼ãƒ æ‰“ç‡ ${analysis.teamAvg.toFixed(3)} ã¨ã„ã†é«˜ç¢ºç‡ãªã‚³ãƒ³ã‚¿ã‚¯ãƒˆèƒ½åŠ›ã§ã€é€£æ‰“ã‚’é‡ã­ã¦å¾—ç‚¹ã—ã¾ã™ã€‚`;
    } else if (analysis.aceIP / analysis.totalTeamIP >= 0.70 && analysis.totalTeamIP > 5) {
        color.primary = 'ã‚¨ãƒ¼ã‚¹ä¾å­˜å‹';
        narrative.primary = `ã‚¨ãƒ¼ã‚¹ã®æŠ•çƒå›ãŒå…¨ä½“ã®7å‰²ä»¥ä¸Šã‚’å ã‚ã¦ã„ã¾ã™ã€‚`;
    } else {
        color.primary = 'ç·åˆåŠ›å‹';
        narrative.primary = `æŠ•æ‰“ã«å¤§ããªåã‚ŠãŒãªãã€ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸãƒãƒ¼ãƒ ã§ã™ã€‚`;
    }
    
    // (Secondary Colorã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ãã®ã¾ã¾)
    const comebackPct = analysis.comebackWins / analysis.totalWins;
    if (analysis.totalWins === 0) { color.secondary = 'ä¸æ˜'; narrative.secondary = 'ã¾ã å‹åˆ©çµŒé¨“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'; }
    else if (comebackPct >= 0.30) { color.secondary = 'çµ‚ç›¤è¿½ã„ä¸Šã’å‹'; narrative.secondary = `å‹åˆ©ã®ç´„${Math.round(comebackPct * 100)}%ãŒé€†è»¢åŠ‡ã€‚ç²˜ã‚Šå¼·ã•ãŒå¼·ã¿ã§ã™ã€‚`; }
    else if (analysis.wireToWireWins / analysis.totalWins >= 0.70) { color.secondary = 'å…ˆè¡Œé€ƒã’åˆ‡ã‚Šå‹'; narrative.secondary = `å‹åˆ©ã®7å‰²ãŒå…ˆè¡Œé€ƒã’åˆ‡ã‚Šã€‚åºç›¤ã®ãƒªãƒ¼ãƒ‰ã‚’å®ˆã‚Šåˆ‡ã‚‹å±•é–‹ãŒå¾—æ„ã§ã™ã€‚`; }
    else { color.secondary = 'è©¦åˆå±•é–‹ä¸å®š'; narrative.secondary = `å¯¾æˆ¦ç›¸æ‰‹ã«ã‚ˆã£ã¦æŸ”è»Ÿã«è©¦åˆå±•é–‹ã‚’å¤‰ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚`; }
    
    return {
        id: teamName,
        classification: color,
        stats: { ops: analysis.teamOPS, avg: analysis.teamAvg, era: teamERA }, // â˜…ä¸¡æ–¹è¿”ã™
        narrative: {
            primary: narrative.primary,
            secondary: narrative.secondary,
            comment: `ã€ãƒãƒ¼ãƒ ã‚«ãƒ©ãƒ¼ã€‘: ä¸»ã«ã€Œ${color.primary}ã€ã§ã‚ã‚Šã€ã€Œ${color.secondary}ã€ã®å‹ã¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŒã¡ã¾ã™ã€‚`
        }
    };
}

/**
 * [UPDUPDATED] å­¦æ ¡ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æç”»ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•° (AIåˆ†æå®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’è¿½åŠ )
 */
async function renderSchoolArchiveModal(teamName) {
    const contentEl = document.getElementById('school-archive-content');
    const teamData = TEAM_DATA[teamName];
    const teamRecord = tournamentState.teamRecords[teamName];
    
    if (!teamData || !teamRecord) return;

    // --- HTMLåˆæœŸæ§‹ç¯‰ ---
    let html = `
        <div class="archive-header">
            <span class="archive-school-name">${teamName}</span>
            <span class="archive-pref">(${teamData.region}åœ°åŒº)</span>
        </div>

        <div class="archive-section-title">æ¦‚è¦</div>
        <div class="result-summary-box">
            <div class="result-summary-row">
                <dt class="result-summary-dt">æœ€é«˜æˆç¸¾</dt>
                <dd class="result-summary-dd">${teamRecord.best ? formatRecordToString(teamRecord.best) : "ãªã—"}</dd>
            </div>
            <div class="result-summary-row">
                <dt class="result-summary-dt">é€šç®—å‹æ•—</dt>
                <dd class="result-summary-dd">${teamRecord.wins || 0}å‹ ${teamRecord.losses || 0}æ•—</dd>
            </div>
            <div class="result-summary-row">
                <dt class="result-summary-dt">ãƒãƒ¼ãƒ ç‰¹å¾´</dt>
                <dd class="result-summary-dd">${teamData.info || 'æƒ…å ±ãªã—'}</dd>
            </div>
            <div class="result-summary-row">
                <dt class="result-summary-dt">ç›£ç£</dt>
                <dd class="result-summary-dd">${teamData.coach?.name || 'ä¸æ˜'} (${teamData.coach?.style || ''})</dd>
            </div>
        </div>

        <div class="archive-section-title">ä»Šå¤§ä¼šã®ãƒãƒ¼ãƒ åˆ†æ</div>
        <div id="archive-ai-analysis-container" class="p-3 border rounded-lg bg-gray-50 text-gray-700 leading-relaxed">
            <div id="archive-ai-analysis" class="text-sm">
                <p class="text-center text-gray-500">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€æœ€æ–°ã®æˆ¦æ³ã‚’AIã«åˆ†æã•ã›ã¾ã™ã€‚</p>
            </div>
            <button id="run-archive-analysis-btn" 
                    data-team-name="${teamName}"
                    class="mt-2 w-full bg-blue-600 text-white font-bold py-1 px-3 rounded text-sm hover:bg-blue-700">
                AIåˆ†æã‚’å®Ÿè¡Œ
            </button>
        </div>
        <div class="archive-section-title">ç›´è¿‘3å¤§ä¼šã®æˆç¸¾</div>
        <ul class="history-list">
            ${(teamRecord.history || []).slice(0, 3).map(h => `
                <li class="history-item">
                    <span class="history-year">${h.year}å¹´ ${tournamentNameMap[h.tournament] || h.tournament}</span>
                    <span class="history-rank">${getRankString(h.rank)}</span>
                </li>
            `).join('')}
        </ul>

        <div class="archive-section-title">å…¨è©¦åˆçµæœä¸€è¦§</div>
        <div class="archive-sub-title">
            <h3>æœ€æ–°ã®è©¦åˆçµæœ</h3>
            <ul class="flex space-x-4 text-sm font-normal ml-4 mt-1">
                <li><span class="text-red-600 font-bold">ğŸ”´</span> å‹ã¡</li>
                <li><span class="text-blue-600 font-bold">ğŸ”µ</span> è² ã‘</li>
            </ul>
        </div>

        <div class="overflow-x-auto">
            <table class="record-table">
                <thead>
                    <tr>
                        <th>å¹´</th>
                        <th>å¤§ä¼š</th>
                        <th>å›æˆ¦</th>
                        <th>å¯¾æˆ¦æ ¡</th>
                        <th>ã‚¹ã‚³ã‚¢</th>
                        <th>å‹æ•—</th>
                    </tr>
                </thead>
                <tbody>
    `;

    // è©¦åˆå±¥æ­´ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®ç”Ÿæˆ
    const allMatches = getRecentMatchesForTeam(teamName, 1000); 
    if (allMatches.length > 0) {
        allMatches.forEach(match => {
            const resultClass = match.isWin ? 'result-win' : 'result-lose';
            const resultText = match.isWin ? 'å‹ã¡' : 'è² ã‘';
            const resultIcon = match.isWin ? 'ğŸ”´' : 'ğŸ”µ'; 

            html += `
                <tr>
                    <td>${match.year}</td>
                    <td>${match.tournamentName}</td>
                    <td>${match.roundName}</td>
                    <td class="opponent-cell clickable-team-name cursor-pointer text-blue-600 hover:underline" data-team-name="${match.opponent}">
                        ${match.opponent}
                    </td>
                    <td class="score-cell">${match.scoreResult}</td>
                    <td class="${resultClass}">${resultIcon} ${resultText}</td>
                </tr>
            `;
        });
    } else {
        html += `<tr><td colspan="6" class="text-gray-500">è©¦åˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`;
    }

    html += `
                </tbody>
            </table>
        </div>
    `;

    contentEl.innerHTML = html;
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    const modal = document.getElementById('school-archive-modal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}
    // â˜…â˜…â˜… ã€é‡è¦ä¿®æ­£ã€‘ãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²ã¯ã€DOMã«è¦ç´ ãŒè¿½åŠ ã•ã‚ŒãŸå¾Œã€setTimeoutã®å¤–ã§è¡Œã† â˜…â˜…â˜…
    
    
    
/**
 * [NEW] AIåˆ†æã‚’å®Ÿéš›ã«å®Ÿè¡Œã—ã€çµæœã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æŒ¿å…¥ã™ã‚‹é–¢æ•°
 */
async function runArchiveAnalysis(teamName) {
    const container = document.getElementById('archive-ai-analysis-container');
    const analysisEl = document.getElementById('archive-ai-analysis');
    const runBtn = document.getElementById('run-archive-analysis-btn');

    if (!analysisEl || !runBtn || !container) return;
    
    analysisEl.innerHTML = '<div class="loader">AIãŒä»Šå¤§ä¼šã®çŠ¶æ³ã‚’åˆ†æä¸­...</div>';
    container.classList.remove('bg-gray-50', 'bg-red-100');
    container.classList.add('bg-white'); 
    runBtn.disabled = true;

    try {
        const analysisResult = await generateArchiveAnalysis(teamName);

        if (analysisResult.includes('AIã«ã‚ˆã‚‹åˆ†æã«å¤±æ•—') || analysisResult.includes('ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ãŒä¸è¶³')) {
             analysisEl.innerHTML = `
                <p class="text-red-700 font-bold">åˆ†æå¤±æ•—: ãƒ‡ãƒ¼ã‚¿ä¸è¶³</p>
                <p class="text-sm text-gray-700 mt-2">ç†ç”±ï¼š**æ³¨ç›®é¸æ‰‹ãŒä¸è¶³**ã—ã¦ã„ã¾ã™ã€‚åˆ†æã«ã¯**æœ€ä½10æ‰“å¸­ä»¥ä¸Š**ã®æ‰“è€…ãŒå¿…è¦ã§ã™ã€‚</p>
                <p class="text-xs text-gray-600 mt-2">ğŸ’¡ æ•°è©¦åˆã‚¹ã‚­ãƒƒãƒ—ã—ãŸå¾Œã€æ‰‹å‹•ã§**ã€Œè©³ç´°å…¥åŠ›ï¼ˆğŸ²ï¼‰ã€**ã‚’ä½¿ã„ã€é¸æ‰‹ã®æ‰“å¸­æ•°ã‚’å¢—ã‚„ã—ã¦ã‹ã‚‰å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
                `;
             container.classList.remove('bg-white');
             container.classList.add('bg-red-100');
        } else {
            analysisEl.innerHTML = analysisResult.replace(/\n/g, '<br>'); // æ”¹è¡Œã‚’åæ˜ 
             container.classList.remove('bg-white');
             container.classList.add('bg-green-50');
        }
    } catch (error) {
        console.error("Archive Analysis Runtime Error:", error);
        analysisEl.innerHTML = `<p class="text-red-700">åˆ†æä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`;
        container.classList.remove('bg-white');
        container.classList.add('bg-red-100');
    } finally {
        runBtn.disabled = false;
    }
}
/**
 * [FIXED] AIãŒç¾åœ¨ã®ãƒãƒ¼ãƒ ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆçŠ¶æ³ã‚’åˆ†æã—ã€æ¬¡æˆ¦ã®å‹æ•—äºˆæƒ³ã‚’å«ã‚ãŸãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…è‡ªãƒãƒ¼ãƒ ã¨æ•µãƒãƒ¼ãƒ ã®ã€Œ5å¤§æŒ‡æ¨™ï¼ˆæ‰“ç‡ãƒ»HRãƒ»æ‰“ç‚¹ãƒ»ç›—å¡ãƒ»OPSï¼‰ã€ã¨æ‰“é †ã‚’ç¶²ç¾…ã—ã¦æ¯”è¼ƒã™ã‚‹å®Œå…¨ç‰ˆ)
 */
async function generateArchiveAnalysis(teamName) {
    const record = tournamentState.teamRecords[teamName];
    // ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
    if (!record || !record.tournamentStats || (record.tournamentStats.pa || 0) < 1) {
        return 'ãƒãƒ¼ãƒ ã®æˆç¸¾ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ï¼ˆè©¦åˆæ•°ãŒå°‘ãªã„ã‹ã€è©³ç´°å…¥åŠ›ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰';
    }
    
    // â˜…â˜…â˜… é‡è¦ï¼šteamDataã®å®šç¾© â˜…â˜…â˜…
    const teamData = TEAM_DATA[teamName];
    if (!teamData) return 'ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';

    // --- 1. ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼šãƒãƒ¼ãƒ ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã™ã‚‹é–¢æ•° ---
    const getDetailedTeamInfo = (targetName) => {
        const tr = tournamentState.teamRecords[targetName];
        if (!tr || !tr.tournamentStats) return null;
        const td = TEAM_DATA[targetName];

        // (A) ãƒãƒ¼ãƒ æ”»æ’ƒåŠ› (5å¤§æŒ‡æ¨™)
        const ts = tr.tournamentStats;
        const tab = ts.ab || 0;
        const tavg = tab > 0 ? (ts.h / tab).toFixed(3) : '.000';
        
        const t_h = ts.h || 0; const t_bb = (ts.bb || 0) + (ts.hbp || 0); const t_sf = ts.sf || 0;
        const t_tb = ts.tb || (t_h + (ts.hr || 0) * 3);
        const tpa = tab + t_bb + t_sf;
        const tobp = tpa > 0 ? (t_h + t_bb) / tpa : 0;
        const tslg = tab > 0 ? t_tb / tab : 0;
        const tops = (tobp + tslg).toFixed(3);
        
        const t_hr = ts.hr || 0;
        const t_rbi = ts.rbi || 0;
        const t_sb = ts.sb || 0;

        // ARC/G (ç›¸æ‰‹ãƒ©ãƒ³ã‚¯è£œæ­£ä»˜ãå¾—ç‚¹åŠ›)
        let totalRC = 0;
        let players = []; // ã‚¹ã‚¿ãƒ¡ãƒ³å€™è£œãƒªã‚¹ãƒˆ

        if (tr.playerStats?.batting) {
            Object.entries(tr.playerStats.batting).forEach(([name, s]) => {
                // ã‚¹ã‚¿ãƒ¡ãƒ³å›æ•°é›†è¨ˆ
                let startCount = 0;
                let typicalOrder = 99;
                if (s.gamelogs) {
                    const orderCounts = {};
                    s.gamelogs.forEach(log => {
                        if (log.order && !log.order.toString().includes('sub')) {
                            const ord = parseInt(log.order);
                            if (!isNaN(ord)) { orderCounts[ord] = (orderCounts[ord] || 0) + 1; startCount++; }
                        }
                    });
                    let maxCount = -1;
                    for (const [ord, count] of Object.entries(orderCounts)) {
                        if (count > maxCount) { maxCount = count; typicalOrder = parseInt(ord); }
                    }
                }

                // ã‚¹ã‚¿ãƒ¡ãƒ³çµŒé¨“ã‚ã‚Š or 1æ‰“å¸­ä»¥ä¸Š
                if (startCount > 0 || (s.pa || 0) >= 1) {
                    const p_h = s.h||0; const p_bb=(s.bb||0)+(s.hbp||0); const p_ab=s.ab||0;
                    const p_tb = (s.tb||p_h) + (s.hr||0)*3;
                    const p_times = p_ab + p_bb;
                    let p_rc = p_times > 0 ? ((p_h + p_bb) * p_tb) / p_times : 0;
                    p_rc = isNaN(p_rc) ? 0 : p_rc;
                    totalRC += p_rc;
                    
                    // â˜… å€‹äººæˆç¸¾ãƒªã‚¹ãƒˆä½œæˆ (5å¤§æŒ‡æ¨™ã‚’å«ã‚€)
                    players.push({ 
                        name, typicalOrder,
                        ops: parseFloat(calculateOps(s)), 
                        rc: p_rc, 
                        hr: s.hr || 0, 
                        rbi: s.rbi || 0, 
                        sb: s.sb || 0, 
                        avg: (s.ab > 0 ? s.h/s.ab : 0).toFixed(3) 
                    });
                }
            });
        }
        
        const totalGames = players.length > 0 ? Math.max(1, tr.wins + tr.losses) : 1;
        const rawRCG = totalGames > 0 ? totalRC / totalGames : 0;
        const arcg = calculateAdjustedRCG(targetName, rawRCG).toFixed(2);

        // (B) æŠ•æ‰‹åŠ›
        const tp = calculateTeamPitchingStats(targetName);

        // (C) ãƒãƒ¼ãƒ ã‚«ãƒ©ãƒ¼
        const tc = analyzeTeamColor(targetName);
        
        // (D) æ‰“é †ãƒªã‚¹ãƒˆç”Ÿæˆ (æ‰“é †é †ã«ã‚½ãƒ¼ãƒˆ)
        players.sort((a, b) => a.typicalOrder - b.typicalOrder);
        
        // â˜… æ‰“é †ä»˜ãã®è©³ç´°ãƒªã‚¹ãƒˆ (ä¸Šä½ã ã‘ã§ãªãã‚¹ã‚¿ãƒ¡ãƒ³å…¨å“¡åˆ†)
        const lineupList = players.filter(p => p.typicalOrder <= 9).map(p => 
            `- ã€${p.typicalOrder}ç•ªã€‘${p.name}: æ‰“ç‡${p.avg}, ${p.hr}æœ¬, ${p.rbi}æ‰“ç‚¹, ${p.sb}ç›—å¡, OPS${p.ops.toFixed(3)}`
        ).join('\n  ') || "ï¼ˆã‚¹ã‚¿ãƒ¡ãƒ³ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰";
        
        // æ§‹é€ åˆ†æ
        const topBatter = players.reduce((prev, cur) => (prev.rc > cur.rc) ? prev : cur, {rc: 0, name: 'ãªã—'});
        const share = (topBatter.rc > 0 && totalRC > 0) ? (topBatter.rc / totalRC) * 100 : 0;
        let structure = share >= 35 ? `ãƒ¯ãƒ³ãƒãƒ³å‹(${topBatter.name}ä¾å­˜${share.toFixed(0)}%)` : `åˆ†æ•£å‹(ãƒˆãƒƒãƒ—ä¾å­˜${share.toFixed(0)}%)`;

        // (E) æŠ•æ‰‹é™£è©³ç´°
        let pDetails = [];
        if (tr.playerStats?.pitching) {
            Object.entries(tr.playerStats.pitching).forEach(([name, ps]) => {
                const logs = ps.gamelogs || [];
                if(logs.length > 0) {
                    const stats = logs.reduce((a, l) => { 
                        a.ip += parseFloat(l.ip||0); a.er+=parseInt(l.er||0); a.so+=parseInt(l.so||0); 
                        if(l.result === 'W') a.wins++; if(l.result === 'L') a.losses++;
                        return a; 
                    }, {ip:0, er:0, so:0, wins:0, losses:0});
                    if(stats.ip >= 5) { // 5å›ä»¥ä¸Š
                        const era = stats.ip>0 ? ((stats.er*9)/stats.ip).toFixed(2) : "0.00";
                        const k9 = stats.ip>0 ? ((stats.so*9)/stats.ip).toFixed(2) : "0.00";
                        pDetails.push({ name, ...stats, era, k9 });
                    }
                }
            });
        }
        pDetails.sort((a, b) => b.ip - a.ip);
        const pDetailsText = pDetails.map(p => 
            `- ${p.name}: é˜²å¾¡ç‡${p.era}, ${p.wins}å‹${p.losses}æ•—, ${p.ip.toFixed(1)}å›, ${p.so}å¥ªä¸‰æŒ¯ (K/9 ${p.k9})`
        ).join('\n  ') || "ï¼ˆè©³ç´°ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰";

        // (F) è»Œè·¡
        const journey = getCurrentTournamentPerformance(targetName, 'analysis') || 'åˆæˆ¦';

        return {
            name: targetName,
            rank: calculateRank(targetName, tournamentState),
            style: td?.coach?.style || 'ä¸æ˜',
            avg: tavg, ops: tops, arcg: arcg, 
            hr: t_hr, rbi: t_rbi, sb: t_sb, // â˜… ãƒãƒ¼ãƒ åˆè¨ˆå€¤
            era: tp.era,
            color: `${tc.classification.primary}`,
            structure: structure,
            lineup: lineupList, // â˜… æ‰“é †ãƒªã‚¹ãƒˆ (5å¤§æŒ‡æ¨™ä»˜ã)
            pitchers: pDetailsText,
            journey: journey
        };
    };

    // --- 2. è‡ªãƒãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿å–å¾— ---
    const myData = getDetailedTeamInfo(teamName);

    // --- 3. å¯¾æˆ¦ç›¸æ‰‹ã®ç‰¹å®šã¨ãƒ‡ãƒ¼ã‚¿å–å¾— ---
    let targetMatchId = null;
    let nextOpponentName = null;
    
    const allMatches = { ...tournamentState.matches, ...(tournamentState.autumnData?.allMatches || {}), ...(tournamentState.springData?.allMatches || {}) };
    // æœªæ¶ˆåŒ–ã®è©¦åˆã‚’æ¢ã™
    const nextMatch = Object.values(allMatches).find(m => !m.winner && (m.team1 === teamName || m.team2 === teamName));

    if (nextMatch) {
        targetMatchId = nextMatch.id;
        nextOpponentName = (nextMatch.team1 === teamName) ? nextMatch.team2 : nextMatch.team1;
    }

    let opponentData = null;
    let isMatchDecided = false;
    let opponentName = nextOpponentName;

    // ç›¸æ‰‹ãŒæ±ºã¾ã£ã¦ã„ã¦ã€ã‹ã¤ãƒ€ãƒŸãƒ¼ã§ãªã„å ´åˆ
    if (opponentName && opponentName !== 'ï¼ˆæœªå®šï¼‰' && opponentName !== '(BYE)' && opponentName !== 'å„ªå‹' && opponentName !== 'å¤§ä¼šçµ‚äº†') {
        // ç›¸æ‰‹ãƒãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯è‡ªå‹•ç”Ÿæˆã—ã¦åŸ‹ã‚ã‚‹
        backfillCpuStats(opponentName);
        opponentData = getDetailedTeamInfo(opponentName);
        isMatchDecided = true;
    }

    // --- 4. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä½œæˆ ---
    let prompt = `ã‚ãªãŸã¯é«˜æ ¡é‡çƒã®ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚
ãƒãƒ¼ãƒ ã€Œ${teamName}ã€ã®ç¾çŠ¶åˆ†æ${isMatchDecided ? `ã¨ã€æ¬¡æˆ¦ã®ç›¸æ‰‹ã€Œ${opponentName}ã€ã¨ã®å¾¹åº•çš„ãªæˆ¦åŠ›æ¯”è¼ƒ` : ''}ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

### ã€è‡ªãƒãƒ¼ãƒ ã€‘${myData.name} (${myData.rank}ãƒ©ãƒ³ã‚¯)
- **ãƒãƒ¼ãƒ æ”»æ’ƒåŠ›**: æ‰“ç‡${myData.avg}, æœ¬å¡æ‰“${myData.hr}, æ‰“ç‚¹${myData.rbi}, ç›—å¡${myData.sb}, OPS${myData.ops}, ARC/G(è£œæ­£å¾—ç‚¹åŠ›)${myData.arcg}
- **ãƒãƒ¼ãƒ å®ˆå‚™åŠ›**: é˜²å¾¡ç‡${myData.era}
- **ãƒãƒ¼ãƒ ã‚«ãƒ©ãƒ¼**: ${myData.color} (${myData.structure})
- **è»Œè·¡**: ${myData.journey}
#### ã‚¹ã‚¿ãƒ¡ãƒ³æ‰“é †ãƒ‡ãƒ¼ã‚¿ (5å¤§æŒ‡æ¨™)
  ${myData.lineup}
#### æŠ•æ‰‹é™£è©³ç´°
  ${myData.pitchers}
`;

    if (isMatchDecided && opponentData) {
        prompt += `
### ã€æ¬¡æˆ¦ã®ç›¸æ‰‹ã€‘${opponentData.name} (${opponentData.rank}ãƒ©ãƒ³ã‚¯)
- **ãƒãƒ¼ãƒ æ”»æ’ƒåŠ›**: æ‰“ç‡${opponentData.avg}, æœ¬å¡æ‰“${opponentData.hr}, æ‰“ç‚¹${opponentData.rbi}, ç›—å¡${opponentData.sb}, OPS${opponentData.ops}, ARC/G(è£œæ­£å¾—ç‚¹åŠ›)${opponentData.arcg}
- **ãƒãƒ¼ãƒ å®ˆå‚™åŠ›**: é˜²å¾¡ç‡${opponentData.era}
- **ãƒãƒ¼ãƒ ã‚«ãƒ©ãƒ¼**: ${opponentData.color} (${opponentData.structure})
- **è»Œè·¡**: ${opponentData.journey}
#### ã‚¹ã‚¿ãƒ¡ãƒ³æ‰“é †ãƒ‡ãƒ¼ã‚¿ (5å¤§æŒ‡æ¨™)
  ${opponentData.lineup}
#### æŠ•æ‰‹é™£è©³ç´°
  ${opponentData.pitchers}
`;
    } else {
        prompt += `\n### æ¬¡æˆ¦ã®ç›¸æ‰‹\nã¾ã æ±ºå®šã—ã¦ã„ã¾ã›ã‚“ï¼ˆ${opponentName || 'æœªå®š'}ï¼‰ã€‚\n`;
    }

    prompt += `
### æŒ‡ç¤º
1.  **ç¾çŠ¶åˆ†æ**: è‡ªãƒãƒ¼ãƒ ã®ã€Œ5å¤§æŒ‡æ¨™ï¼ˆæ‰“ç‡ãƒ»æœ¬å¡æ‰“ãƒ»æ‰“ç‚¹ãƒ»ç›—å¡ãƒ»OPSï¼‰ã€ã«åŸºã¥ãã€æ”»æ’ƒã®ç‰¹è‰²ï¼ˆé•·æ‰“åŠ›é‡è¦–ã‹ã€æ©Ÿå‹•åŠ›é‡è¦–ã‹ãªã©ï¼‰ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚æ‰“é †ã”ã¨ã®å½¹å‰²æ©Ÿèƒ½ï¼ˆ1ç•ªã®å‡ºå¡ã€ã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—ã®æ±ºå®šåŠ›ï¼‰ã«ã‚‚è§¦ã‚Œã¦ãã ã•ã„ã€‚
`;

    if (isMatchDecided) {
        prompt += `2.  **ã€æœ€é‡è¦ã€‘æˆ¦åŠ›æ¯”è¼ƒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**:
    - **æ‰“ç·š vs æŠ•æ‰‹**: ã€Œ${myData.name}æ‰“ç·š vs ${opponentData.name}æŠ•æ‰‹é™£ã€ã®ç›¸æ€§ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚ç›¸æ‰‹ã‚¨ãƒ¼ã‚¹ã®æ”»ç•¥é›£æ˜“åº¦ã¯ï¼Ÿ
    - **æ‰“é †æ¯”è¼ƒ**: ä¸¡ãƒãƒ¼ãƒ ã®ã€Œ1ç•ªæ‰“è€…ã€ã‚„ã€Œ4ç•ªæ‰“è€…ã€ã‚„å…¨ä½“çš„ãªæ‰“ç·šã®æˆç¸¾ï¼ˆOPS, æ‰“ç‚¹ãªã©ï¼‰ã‚’æ¯”è¼ƒã—ã€ã©ã¡ã‚‰ãŒæ”»æ’ƒã®èµ·ç‚¹ãƒ»æ±ºå®šã¨ã—ã¦å„ªç§€ã‹è«–ã˜ã¦ãã ã•ã„ã€‚
    - **æ”»ç•¥æ³•**: ç›¸æ‰‹ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆé˜²å¾¡ç‡ã€æ‰“é †ã®ç©´ã€ç›—å¡æ•°ãªã©ï¼‰ã«åŸºã¥ãã€å…·ä½“çš„ãªæ”»ç•¥ãƒ—ãƒ©ãƒ³ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
3.  **ã€å‹æ•—äºˆæƒ³ã€‘**:
    - ã‚ºãƒãƒªã€**${teamName}ã®å‹ç‡ï¼ˆï¼…ï¼‰**ã‚’äºˆæƒ³ã—ã€ãã®æ ¹æ‹ ã‚’è¿°ã¹ã¦ãã ã•ã„ã€‚
    - ã€Œæœ‰åˆ©ï¼ˆ60%ä»¥ä¸Šï¼‰ã€ã€Œäº”åˆ†ï¼ˆ45-55%ï¼‰ã€ã€ŒåŠ£å‹¢ï¼ˆ40%ä»¥ä¸‹ï¼‰ã€ã®ã„ãšã‚Œã‹ã‚’æ˜è¨€ã—ã¦ãã ã•ã„ã€‚
`;
    } else {
        const currentRank = calculateRank(teamName, tournamentState);
        let goalQuestion = "ä¸Šä½é€²å‡º";
        if(currentRank === 'A') goalQuestion = "å…¨å›½åˆ¶è¦‡";
        else if(currentRank === 'B') goalQuestion = "çœŒåˆ¶è¦‡";
        else if(currentRank === 'C') goalQuestion = "ãƒ™ã‚¹ãƒˆ8";
        else goalQuestion = "ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆå‹ã¡ä¸ŠãŒã‚Š";
        
        prompt += `2.  **ç›®æ¨™é”æˆåº¦**: ãƒ©ãƒ³ã‚¯(${currentRank})ã«åŸºã¥ãã€ç¾åœ¨ã®ãƒãƒ¼ãƒ çŠ¶æ³ã§ã€Œ${goalQuestion}ã€ãŒå¯èƒ½ã‹è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚\n`;
    }

    prompt += `### å‡ºåŠ›å½¢å¼: JSON {"body": "ï¼ˆåˆ†æã‚³ãƒ©ãƒ æœ¬æ–‡ï¼‰"}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        const aiData = parseJsonFromText(result.candidates[0].content.parts[0].text);
        
        return aiData?.body || 'AIã«ã‚ˆã‚‹åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
    } catch (error) {
        console.error("AI archive analysis failed:", error);
        return 'åˆ†æã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
    }
}

/**
 * [NEW] ãƒãƒ¼ãƒ ã®ã‚»ã‚¤ãƒãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹æŒ‡æ¨™ã‚’è¨ˆç®—ã—ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰HTMLã‚’ç”Ÿæˆã™ã‚‹
 */
function generateSabermetricsHTML(teamName) {
    const record = tournamentState.teamRecords[teamName];
    if (!record || !record.playerStats) return '<p class="text-xs text-center text-gray-400">ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã®ãŸã‚åˆ†æã§ãã¾ã›ã‚“</p>';

    // --- 1. ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ ---
    let totalAB = 0, totalTB = 0, totalH = 0, totalBB_Bat = 0, totalSO_Bat = 0; // æ‰“æ’ƒ
    let totalIP = 0, totalH_Pit = 0, totalBB_Pit = 0, totalRunsAllowed = 0; // æŠ•æ‰‹
    let totalRunsScored = record.tournamentStats?.r || 0; // å¾—ç‚¹ã¯tournamentStatsã‹ã‚‰å–å¾— (ç°¡æ˜“)

    // æ‰“æ’ƒé›†è¨ˆ (IsoP, BB/Kç”¨)
    if (record.playerStats.batting) {
        Object.values(record.playerStats.batting).forEach(s => {
            totalAB += s.ab || 0;
            totalH += s.h || 0;
            const hr = s.hr || 0;
            // TB(å¡æ‰“)ãŒãªã„å ´åˆã¯ç°¡æ˜“è¨ˆç®—
            totalTB += (s.tb || (s.h + hr * 3)); 
            totalBB_Bat += (s.bb || 0) + (s.hbp || 0);
            totalSO_Bat += s.so || 0;
            // ã‚‚ã—tournamentStatsã®å¾—ç‚¹ãŒ0ãªã‚‰ã€å€‹äººã®æ‰“ç‚¹åˆè¨ˆã§ä»£ç”¨ï¼ˆç°¡æ˜“ï¼‰
            if(totalRunsScored === 0) totalRunsScored += (s.rbi || 0);
        });
    }

    // æŠ•æ‰‹é›†è¨ˆ (WHIP, Pythagenpatç”¨)
    if (record.playerStats.pitching) {
        Object.values(record.playerStats.pitching).forEach(s => {
            if (s.career) {
                totalIP += s.career.ip || 0;
                totalH_Pit += s.career.h || 0;
                totalBB_Pit += s.career.bb || 0;
                totalRunsAllowed += s.career.r || s.career.er || 0; // å¤±ç‚¹
            }
        });
    }

    // --- 2. æŒ‡æ¨™è¨ˆç®— ---

    // A. IsoP (Isolated Power) = é•·æ‰“ç‡ - æ‰“ç‡
    // ã€Œç´”ç²‹ãªé•·æ‰“åŠ›ã€ã‚’ç¤ºã™ã€‚0.200è¶…ãˆã‚Œã°å„ªç§€ã€‚
    const avg = totalAB > 0 ? totalH / totalAB : 0;
    const slg = totalAB > 0 ? totalTB / totalAB : 0;
    const isoP = slg - avg;

    // B. BB/K (Walks per Strikeout) = å››çƒ / ä¸‰æŒ¯
    // ã€Œé¸çƒçœ¼ã¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã€ã‚’ç¤ºã™ã€‚1.00è¶…ãˆã‚Œã°å„ªç§€ã€‚
    const bbK = totalSO_Bat > 0 ? totalBB_Bat / totalSO_Bat : 0;

    // C. WHIP (Walks plus Hits per Inning Pitched) = (è¢«å®‰æ‰“ + ä¸å››çƒ) / æŠ•çƒå›
    // ã€ŒæŠ•æ‰‹ã®å®‰å®šæ„Ÿã€ã‚’ç¤ºã™ã€‚1.20æœªæº€ãªã‚‰å„ªç§€ã€‚
    const whip = totalIP > 0 ? (totalH_Pit + totalBB_Pit) / totalIP : 0;

    // D. Pythagorean Expectation (ãƒ”ã‚¿ã‚´ãƒ©ã‚¹å‹ç‡) = å¾—ç‚¹^2 / (å¾—ç‚¹^2 + å¤±ç‚¹^2)
    // ã€Œå¾—å¤±ç‚¹å·®ã‹ã‚‰è¦‹ãŸæœ¬æ¥ã®å®ŸåŠ›ã€ã€‚å®Ÿéš›ã®å‹ç‡ã‚ˆã‚Šé«˜ã‘ã‚Œã°ã€Œä¸é‹ã€ã€ä½ã‘ã‚Œã°ã€Œå¹¸é‹ã€ã€‚
    // â€»é«˜æ ¡é‡çƒç”¨ã«æŒ‡æ•°ã‚’1.83ã§ã¯ãªã2.0ï¼ˆå¤å…¸çš„ï¼‰ã¾ãŸã¯å°‘ã—èª¿æ•´ã—ã¦è¨ˆç®—
    const exponent = 1.83; 
    const pythWinPct = (totalRunsScored === 0 && totalRunsAllowed === 0) ? 0 
        : (Math.pow(totalRunsScored, exponent)) / (Math.pow(totalRunsScored, exponent) + Math.pow(totalRunsAllowed, exponent));
    
    // å®Ÿéš›ã®å‹ç‡
    const totalGames = (record.wins + record.losses) || 1;
    const actualWinPct = record.wins / totalGames;
    const luckDiff = actualWinPct - pythWinPct; // æ­£ãªã‚‰é‹ãŒè‰¯ã„ã€è² ãªã‚‰å®ŸåŠ›ä»¥ä¸‹

    // --- 3. è¡¨ç¤ºç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
    const getColor = (val, type) => {
        if (type === 'isop') return val >= 0.2 ? 'val-excellent' : val >= 0.15 ? 'val-good' : 'val-poor';
        if (type === 'bbk') return val >= 1.0 ? 'val-excellent' : val >= 0.7 ? 'val-good' : 'val-poor';
        if (type === 'whip') return val > 0 && val < 1.10 ? 'val-excellent' : val < 1.30 ? 'val-good' : 'val-poor';
        if (type === 'pyth') return Math.abs(val) >= 0.2 ? 'val-excellent' : 'val-poor'; // ä¹–é›¢ãŒå¤§ãã„ã‹ã©ã†ã‹
        return 'val-poor';
    };

    // HTMLç”Ÿæˆ
    return `
        <div class="saber-grid">
            <div class="saber-card">
                <div class="saber-title">IsoP (ç´”ç²‹é•·æ‰“åŠ›)</div>
                <div class="saber-value ${getColor(isoP, 'isop')}">${isoP.toFixed(3)}</div>
                <div class="saber-desc">æ‰“ç‡ã‚’é™¤ã„ãŸé•·æ‰“ã®å‰²åˆã€‚<br>0.200è¶…ã§ã‚¹ãƒ©ãƒƒã‚¬ãƒ¼ç´šã€‚</div>
            </div>
            
            <div class="saber-card">
                <div class="saber-title">BB/K (é¸çƒçœ¼)</div>
                <div class="saber-value ${getColor(bbK, 'bbk')}">${bbK.toFixed(2)}</div>
                <div class="saber-desc">å››çƒÃ·ä¸‰æŒ¯ã€‚<br>1.00è¶…ã§æ¥µã‚ã¦å„ªç§€ã€‚</div>
            </div>
            
            <div class="saber-card">
                <div class="saber-title">WHIP (æŠ•æ‰‹å®‰å®šæ„Ÿ)</div>
                <div class="saber-value ${getColor(whip, 'whip')}">${whip.toFixed(2)}</div>
                <div class="saber-desc">1å›ã‚ãŸã‚Šã«å‡ºã™èµ°è€…æ•°ã€‚<br>1.20æœªæº€ã§ã‚¨ãƒ¼ã‚¹ç´šã€‚</div>
            </div>
            
            <div class="saber-card">
                <div class="saber-title">ãƒ”ã‚¿ã‚´ãƒ©ã‚¹å‹ç‡</div>
                <div class="saber-value">${(pythWinPct * 100).toFixed(1)}%</div>
                <div class="saber-desc" style="color: ${luckDiff > 0 ? '#f59e0b' : '#3b82f6'};">
                    å®Ÿéš›å‹ç‡: ${(actualWinPct*100).toFixed(1)}%<br>
                    (${luckDiff > 0 ? 'é‹ã§å‹åˆ© +' : 'å®ŸåŠ›ä»¥ä¸‹ '}${(Math.abs(luckDiff)*100).toFixed(1)}%)
                </div>
            </div>
        </div>
        <div class="text-right mt-1">
            <span class="text-xs text-gray-400">â€»å¾—å¤±ç‚¹: ${totalRunsScored}å¾—ç‚¹ / ${totalRunsAllowed}å¤±ç‚¹</span>
        </div>
    `;
}

/**
 * ãƒãƒ¼ãƒ ã®ç›´è¿‘Nè©¦åˆã®å±¥æ­´ã‚’å–å¾—ã™ã‚‹
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 * @param {number} limit - å–å¾—æ•° (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5, ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–è¡¨ç¤ºæ™‚ã¯å¤§ããè¨­å®š)
 * @returns {Array} - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ã®è©¦åˆãƒ‡ãƒ¼ã‚¿é…åˆ—
 */
function getRecentMatchesForTeam(teamName, limit = 5) {
    const history = [];
    const state = tournamentState;
    const currentYear = state.tournamentYear;

    // 1. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®å®šç¾© (å„ªå…ˆåº¦é †: ç¾åœ¨ > æ˜¥ > ç§‹)
    // â€»å®Ÿéš›ã®æ™‚ç³»åˆ—ã¯ ç§‹(å‰å¹´) -> æ˜¥ -> å¤ ã§ã™ãŒã€è¡¨ç¤ºä¸Šã¯æ–°ã—ã„é †ã«ä¸¦ã¹ãŸã„ã®ã§ã“ã®é †åºã§èµ°æŸ»ã—ã¾ã™
    const sources = [
        { label: tournamentNameMap[state.currentTournament], year: currentYear, matches: state.matches, weight: 300 },
        { label: 'æ˜¥å­£å¤§ä¼š', year: currentYear, matches: state.springData?.allMatches, weight: 200 },
        { label: 'ç§‹å­£å¤§ä¼š', year: currentYear - 1, matches: state.autumnData?.allMatches, weight: 100 }
    ];

    sources.forEach(source => {
        if (!source.matches) return;
        
        Object.values(source.matches).forEach(match => {
            // å‹æ•—ãŒæ±ºã¾ã£ã¦ãŠã‚Šã€ã‹ã¤å¯¾è±¡ãƒãƒ¼ãƒ ãŒé–¢ã‚ã£ã¦ã„ã‚‹è©¦åˆ
            if (match.winner && (match.team1 === teamName || match.team2 === teamName)) {
                
                // BYE(ä¸æˆ¦å‹)ã¯é™¤å¤–ã™ã‚‹
                if (match.team1 === '(BYE)' || match.team2 === '(BYE)') return;

                const isTeam1 = match.team1 === teamName;
                const opponent = isTeam1 ? match.team2 : match.team1;
                const myScore = isTeam1 ? match.score1 : match.score2;
                const oppScore = isTeam1 ? match.score2 : match.score1;
                const isWin = match.winner === teamName;
                
                // ãƒ©ã‚¦ãƒ³ãƒ‰åã®æ•°å€¤åŒ– (ã‚½ãƒ¼ãƒˆç”¨)
                let roundVal = 0;
                if (match.id.startsWith('F-')) roundVal = 100; // æ±ºå‹
                else if (match.id.includes('-R')) {
                    roundVal = parseInt(match.id.split('-R')[1].split('-')[0]);
                }

                // è©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                history.push({
                    matchId: match.id,
                    tournamentName: source.label,
                    year: source.year,
                    roundName: getRoundNameFromMatchId(match.id),
                    opponent: opponent,
                    scoreResult: `${myScore}-${oppScore}`,
                    result: isWin ? 'â—‹' : 'â—',
                    isWin: isWin,
                    // ã‚½ãƒ¼ãƒˆç”¨ã‚¹ã‚³ã‚¢: (å¤§ä¼šã®é‡ã¿ * 1000) + ãƒ©ã‚¦ãƒ³ãƒ‰ç•ªå·
                    sortKey: (source.weight * 1000) + roundVal
                });
            }
        });
    });

    // 2. ã‚½ãƒ¼ãƒˆ (æ–°ã—ã„é † = sortKeyã®é™é †)
    history.sort((a, b) => b.sortKey - a.sortKey);

    // 3. æœ€æ–°Nä»¶ã‚’è¿”ã™
    return history.slice(0, limit);
}

// â–¼â–¼â–¼ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ â–¼â–¼â–¼

// 1. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
document.getElementById('school-archive-close-btn').addEventListener('click', () => {
    document.getElementById('school-archive-modal').classList.add('hidden');
    document.getElementById('school-archive-modal').classList.remove('flex');
});

// 2. ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å†…ã®å¯¾æˆ¦æ ¡ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç†ï¼ˆå†å¸°çš„ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æ›´æ–°ï¼‰
document.getElementById('school-archive-content').addEventListener('click', (e) => {
    if (e.target.classList.contains('clickable-team-name')) {
        const teamName = e.target.dataset.teamName;
        renderSchoolArchiveModal(teamName);
    }
});


// â–¼â–¼â–¼ ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚­ãƒƒãƒ—æ–°èç”Ÿæˆç”¨ã®é–¢æ•°ç¾¤ (ã“ã“ã‹ã‚‰è¿½åŠ ) â–¼â–¼â–¼

/**
 * [UPDATED] ã‚¹ã‚­ãƒƒãƒ—ã—ãŸãƒ©ã‚¦ãƒ³ãƒ‰ã®çµæœã‚’åŸºã«ã€æ–°èãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ç”Ÿæˆãƒ»è¡¨ç¤ºãƒ»ä¿å­˜ã™ã‚‹
 * (â˜…ãƒãƒ¼ãƒ æ•°ã«å¿œã˜ã¦ãƒ©ã‚¦ãƒ³ãƒ‰åã‚’å‹•çš„ã«åˆ¤å®š)
 */
async function generateSkipRoundNewspaper(roundNumber, results) {
    const modal = document.getElementById('skip-newspaper-modal');
    const bodyEl = document.getElementById('skip-newspaper-body');
    const dateEl = document.getElementById('skip-newspaper-date');
    const topTitleEl = document.getElementById('skip-newspaper-top-title');
    const resultsTitleEl = document.getElementById('skip-newspaper-results-title');
    
    if (!modal || !bodyEl || !dateEl || !topTitleEl || !resultsTitleEl) return;

    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ãƒ©ã‚¦ãƒ³ãƒ‰åã®å‹•çš„ãƒãƒƒãƒ”ãƒ³ã‚° â˜…â˜…â˜…
    const numTeams = tournamentState.teams.length; 
    const finalRound = Math.log2(numTeams); // 128->7, 64->6
    
    const roundNameMap = { 
        [finalRound]: 'æ±ºå‹', 
        [finalRound-1]: 'æº–æ±ºå‹', 
        [finalRound-2]: 'æº–ã€…æ±ºå‹', 
        [finalRound-3]: '4å›æˆ¦' 
    };
    const roundName = roundNameMap[roundNumber] || `${roundNumber}å›æˆ¦`;
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…
    
    let today;
    if (results.length > 0) {
        const lastMatchId = results[results.length - 1].matchId;
        const lastMatch = findMatchById(lastMatchId);
        if (lastMatch?.schedule?.date) today = lastMatch.schedule.date;
    }
    if (!today) {
        const d = new Date();
        today = `${d.getMonth() + 1}/${d.getDate()}`;
    }
    
    const dateString = `${tournamentState.tournamentYear}å¹´ ${today} ç™ºè¡Œ`;
    dateEl.textContent = dateString;
    topTitleEl.textContent = `ç†±æˆ¦ã®${roundName}ã€${tournamentState.currentTournament === 'summer_koshien' ? 'ç”²å­åœ’' : 'é™å²¡'}ã‚’å¸­å·»`;
    resultsTitleEl.textContent = `${roundName} å…¨è©¦åˆçµæœ`;

    // AIã«è¨˜äº‹ç”Ÿæˆã‚’ä¾é ¼
    bodyEl.querySelector('.skip-newspaper-main-headline').textContent = 'å–æä¸­...';
    bodyEl.querySelector('.skip-newspaper-main-body').innerHTML = '<p>AIè¨˜è€…ãŒè¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ã„ã¾ã™...</p>';
    const articleData = await generateSkipRoundArticleContent(roundName, results);

    let resultsBoxHtml = '';
    results.forEach(match => {
        resultsBoxHtml += `
            <div class="skip-newspaper-match">
                <div><span class="winner">${match.winnerName}</span></div>
                <div><span class="score">${match.winnerScore}</span>-<span class="score">${match.loserScore}</span></div>
                <div><span class="loser">${match.loserName}</span></div>
            </div>
        `;
    });

    bodyEl.innerHTML = `
        <div class="skip-newspaper-main-headline">${articleData.mainHeadline}</div>
        <div class="skip-newspaper-main-article">
            <div class="skip-newspaper-main-image">å†™çœŸï¼š${articleData.mainImageCaption}</div>
            <p class="skip-newspaper-image-caption">${articleData.mainImageCaption}</p>
            <div class="skip-newspaper-main-body">
                <h4>${articleData.mainArticleSubHeadline}</h4>
                <p>${articleData.mainArticleBody.replace(/\n/g, '<br><br>')}</p>
            </div>
        </div>
        <div class="skip-newspaper-side-article right">
            <h3 class="skip-newspaper-side-headline">${articleData.sideArticle1Headline}</h3>
            <div class="skip-newspaper-side-body"><p>${articleData.sideArticle1Body.replace(/\n/g, '<br><br>')}</p></div>
        </div>
        <div class="skip-newspaper-side-article left">
            <h3 class="skip-newspaper-side-headline">${articleData.sideArticle2Headline}</h3>
            <div class="skip-newspaper-side-body"><p>${articleData.sideArticle2Body.replace(/\n/g, '<br><br>')}</p></div>
        </div>
        <div class="skip-newspaper-results-section">
            <h2 id="skip-newspaper-results-title">${roundName} å…¨è©¦åˆçµæœ</h2>
            <div id="skip-newspaper-match-grid" class="skip-newspaper-match-grid">${resultsBoxHtml}</div>
        </div>
    `;

    // ãƒ‹ãƒ¥ãƒ¼ã‚¹æ¬„ã«ä¿å­˜
    const articleObject = {
        title: `ã€ç†±é—˜æ–°èã€‘${roundName}ç‰¹é›†å·ï¼ˆã‚¹ã‚­ãƒƒãƒ—ç™ºè¡Œï¼‰`,
        body: articleData.mainArticleSubHeadline,
        timestamp: Date.now(),
        isSkipNewspaper: true,
        roundNumber: roundNumber,
        articleData: articleData,
        resultsBoxHtml: resultsBoxHtml,
        dateString: dateString,
        context: { isSkipNewspaper: true, roundNumber: roundNumber, results: results }
    };
    tournamentState.news.push(articleObject);
    renderNews(tournamentState.news);
    saveState();

    modal.classList.remove('hidden');
}

/**
 * [NEW] æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ "MM/DD" å½¢å¼ã®æ–‡å­—åˆ—ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
function formatDate(date) {
    if (!date) return "æ—¥ä»˜ä¸æ˜";
    return `${date.getMonth() + 1}/${date.getDate()}`;
}

/**
 * [ä¿®æ­£ç‰ˆ] ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚­ãƒƒãƒ—æ–°èã‚’é–‰ã˜ã‚‹
 */
function closeSkipNewspaper() {
    document.getElementById('skip-newspaper-modal').classList.add('hidden');
}

/**
 * [ä¿®æ­£ç‰ˆ] AIã«ã‚¹ã‚­ãƒƒãƒ—ã—ãŸãƒ©ã‚¦ãƒ³ãƒ‰ã®è¨˜äº‹å†…å®¹ã‚’ç”Ÿæˆã•ã›ã‚‹ï¼ˆæ–°èç”¨ï¼‰
 */
async function generateSkipRoundArticleContent(roundName, results) {
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
    
    // 1. æœ€å¤§ã®ç•ªç‹‚ã‚ã›ã‚’ç‰¹å®š
    // rankDiffãŒæœ€ã‚‚å°ã•ã„ï¼ˆãƒã‚¤ãƒŠã‚¹ãŒå¤§ãã„ï¼‰ã‚‚ã®ãŒç•ªç‹‚ã‚ã›
    const biggestUpset = [...results].sort((a, b) => a.rankDiff - b.rankDiff)[0];

    let upsetText = null;
    let mainHeadlineCandidate = `ç™½ç†±ã®${roundName}`;
    let mainImageCaptionCandidate = `ç†±æˆ¦ã®ç¬é–“`;

    if (biggestUpset && biggestUpset.rankDiff <= -2) { // ãƒ©ãƒ³ã‚¯å·®2ä»¥ä¸Šã‚’å¤§ããªç•ªç‹‚ã‚ã›ã¨ã™ã‚‹
        upsetText = `æœ€å¤§ã®æ³¢ä¹±ã¯ã€${biggestUpset.winnerRank}ãƒ©ãƒ³ã‚¯ã®ã€Œ${biggestUpset.winnerName}ã€ãŒã€${biggestUpset.loserRank}ãƒ©ãƒ³ã‚¯ã®å¼·è±ªã€Œ${biggestUpset.loserName}ã€ã‚’ ${biggestUpset.winnerScore}-${biggestUpset.loserScore} ã§ç ´ã£ãŸä¸€æˆ¦ã ã€‚`;
        mainHeadlineCandidate = `ã¾ã•ã‹ï¼ ${biggestUpset.loserName}æ•£ã‚‹`;
        mainImageCaptionCandidate = `${biggestUpset.winnerName}ã®æ­“å–œ`;
    } else if (biggestUpset && biggestUpset.rankDiff < 0) { // å°ã•ãªç•ªç‹‚ã‚ã›
        upsetText = `ä¸€ç­‹ç¸„ã§ã¯ã„ã‹ãªã„è©¦åˆã‚‚ã€‚${biggestUpset.winnerRank}ãƒ©ãƒ³ã‚¯ã®ã€Œ${biggestUpset.winnerName}ã€ãŒã€${biggestUpset.loserRank}ãƒ©ãƒ³ã‚¯ã®ã€Œ${biggestUpset.loserName}ã€ã‚’ ${biggestUpset.winnerScore}-${biggestUpset.loserScore} ã§ç ´ã‚‹ç•ªç‹‚ã‚ã›ãŒã‚ã£ãŸã€‚`;
    }

    // 2. ã‚·ãƒ¼ãƒ‰æ ¡ã®å‹•å‘ã‚’åˆ†æ
    const seeds = tournamentState.seeds.map(s => s.team);
    let seedSurvivedCount = 0;
    let seedEliminated = [];
    let seedEliminatedDetails = []; // ã©ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã§èª°ã«æ•—ã‚ŒãŸã‹
    
    for (const r of results) {
        if (seeds.includes(r.winnerName)) {
            seedSurvivedCount++;
        }
        if (seeds.includes(r.loserName)) { // ã‚·ãƒ¼ãƒ‰æ ¡ãŒæ•—é€€ã—ãŸå ´åˆ
            seedEliminated.push(r.loserName);
            seedEliminatedDetails.push(`ã‚·ãƒ¼ãƒ‰æ ¡ã€Œ${r.loserName}ã€ãŒã€Œ${r.winnerName}ã€ã«æ•—ã‚Œã€${roundName}ã§å§¿ã‚’æ¶ˆã—ãŸã€‚`);
            mainHeadlineCandidate = `${r.loserName}ã¾ã•ã‹ã®æ•—é€€`;
            mainImageCaptionCandidate = `${r.winnerName}ã€é‡‘æ˜Ÿ`;
        }
    }
    
    let seedStatusText;
    if (seedEliminated.length > 0) {
        seedStatusText = `ã‚·ãƒ¼ãƒ‰æ ¡ã®å‹•å‘ã«ã‚‚æ³¨ç›®ãŒé›†ã¾ã£ãŸ${roundName}ã§ã¯ã€${seedEliminated.join('ã€')}ãŒæ•—é€€ã€‚${seedEliminatedDetails.join('')}`;
        if (!upsetText) mainHeadlineCandidate = `å¼·è±ªã€æ¶™ã‚’é£²ã‚€`;
    } else {
        seedStatusText = 'ã‚·ãƒ¼ãƒ‰æ ¡ã¯é †å½“ã«å‹ã¡é€²ã¿ã€ãã®å®ŸåŠ›ã‚’è¦‹ã›ã¤ã‘ãŸã€‚';
        if (!upsetText) mainHeadlineCandidate = `å¼·è±ªã€ç›¤çŸ³ã®æˆ¦ã„`;
    }

    // æ±ºå‹æˆ¦ã®ç‰¹åˆ¥ãªæå†™
    if (roundName === 'æ±ºå‹') {
        const finalMatch = results[0];
        mainHeadlineCandidate = `${finalMatch.winnerName}ã€æ „å† ï¼`;
        mainImageCaptionCandidate = `${finalMatch.winnerName}ã€æ­“å–œã®èƒ´ä¸Šã’`;
        
        // æ±ºå‹å°‚ç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        const finalPrompt = `ã‚ãªãŸã¯ã€Œé™å²¡ ç†±é—˜æ–°èã€ã®ç·¨é›†é•·ã§ã™ã€‚
é«˜æ ¡é‡çƒ ${tournamentNameMap[tournamentState.currentTournament]}ã®ã€Œæ±ºå‹æˆ¦ã€ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®åˆ†æãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€æ–°èã®ä¸€é¢ã‚’é£¾ã‚‹ã€Œç¸¦æ›¸ãã®å¤§è¦‹å‡ºã—ã€ã€Œãƒ¡ã‚¤ãƒ³è¨˜äº‹ã®å°è¦‹å‡ºã—ã€ã€Œãƒ¡ã‚¤ãƒ³è¨˜äº‹æœ¬æ–‡ã€ã€Œã‚µã‚¤ãƒ‰è¨˜äº‹1ã®è¦‹å‡ºã—ã€ã€Œã‚µã‚¤ãƒ‰è¨˜äº‹1æœ¬æ–‡ã€ã€Œã‚µã‚¤ãƒ‰è¨˜äº‹2ã®è¦‹å‡ºã—ã€ã€Œã‚µã‚¤ãƒ‰è¨˜äº‹2æœ¬æ–‡ã€ã€Œãƒ¡ã‚¤ãƒ³ç”»åƒã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã€ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### æ±ºå‹æˆ¦ åˆ†æãƒ‡ãƒ¼ã‚¿
- **å„ªå‹æ ¡:** ${finalMatch.winnerName}
- **æº–å„ªå‹æ ¡:** ${finalMatch.loserName}
- **è©¦åˆçµæœ:** ${finalMatch.winnerScore}-${finalMatch.loserScore}
- **å„ªå‹æ ¡ã®ãƒ©ãƒ³ã‚¯:** ${finalMatch.winnerRank}
- **æº–å„ªå‹æ ¡ã®ãƒ©ãƒ³ã‚¯:** ${finalMatch.loserRank}

### æŒ‡ç¤º
1.  **mainHeadline (ç¸¦æ›¸ãã®å¤§è¦‹å‡ºã—):**
    - 5ï½8æ–‡å­—ç¨‹åº¦ã§ã€å„ªå‹æ ¡ã¨æ„Ÿå‹•ã‚’ä¼ãˆã‚‹ã€‚
    - ä¾‹ï¼šã€Œã€‡ã€‡å„ªå‹ï¼ã€ã€Œæ­“å–œã®åˆVã€
2.  **mainArticleSubHeadline (ãƒ¡ã‚¤ãƒ³è¨˜äº‹ã®å°è¦‹å‡ºã—):**
    - 20ï½30æ–‡å­—ç¨‹åº¦ã§ã€æ±ºå‹æˆ¦ã®ãƒ‰ãƒ©ãƒã‚’è¡¨ç¾ã™ã‚‹ã€‚
    - ä¾‹ï¼šã€Œæ¿€é—˜ã®æœ«ã€ã€‡ã€‡ãŒæ‚²é¡˜é”æˆï¼ç²˜ã‚Šã®é‡çƒã§é ‚ç‚¹ã¸ã€
3.  **mainArticleBody (ãƒ¡ã‚¤ãƒ³è¨˜äº‹æœ¬æ–‡):**
    - 150ï½200æ–‡å­—ç¨‹åº¦ã§ã€æ±ºå‹æˆ¦ã®å±•é–‹ã€ä¸¡ãƒãƒ¼ãƒ ã®å¥®é—˜ã€å‹åˆ©ã®æ„Ÿå‹•ã‚’è©³ç´°ã«æå†™ã™ã‚‹ã€‚
    - å„ªå‹æ ¡ã®å¼·ã•ã‚„ã€æº–å„ªå‹æ ¡ã®å¥é—˜ã‚‚ç§°ãˆã‚‹ã“ã¨ã€‚
4.  **sideArticle1Headline (ã‚µã‚¤ãƒ‰è¨˜äº‹1ã®è¦‹å‡ºã—):**
    - 15æ–‡å­—ç¨‹åº¦ã§ã€å„ªå‹æ ¡ã®ç›£ç£ã‚„é¸æ‰‹ã®ã‚³ãƒ¡ãƒ³ãƒˆãªã©ã€‚
    - ä¾‹ï¼šã€Œç›£ç£ã€å¤¢ã®ã‚ˆã†ã ã€ã€ã€Œã‚¨ãƒ¼ã‚¹ã€æ”¯ãˆã«æ„Ÿè¬ã€
5.  **sideArticle1Body (ã‚µã‚¤ãƒ‰è¨˜äº‹1æœ¬æ–‡):**
    - 80ï½120æ–‡å­—ç¨‹åº¦ã§ã€ä¸Šè¨˜ã®è¦‹å‡ºã—ã«é–¢é€£ã™ã‚‹å†…å®¹ã€‚
6.  **sideArticle2Headline (ã‚µã‚¤ãƒ‰è¨˜äº‹2ã®è¦‹å‡ºã—):**
    - 15æ–‡å­—ç¨‹åº¦ã§ã€æº–å„ªå‹æ ¡ã®å¥é—˜ã‚„ã€å¤§ä¼šå…¨ä½“ã®ç·æ‹¬ãªã©ã€‚
    - ä¾‹ï¼šã€Œæº–Vã‚‚èƒ¸å¼µã‚‹ã€ã€Œå¤ã‚’å½©ã‚‹ç†±æˆ¦ã€
7.  **sideArticle2Body (ã‚µã‚¤ãƒ‰è¨˜äº‹2æœ¬æ–‡):**
    - 80ï½120æ–‡å­—ç¨‹åº¦ã§ã€ä¸Šè¨˜ã®è¦‹å‡ºã—ã«é–¢é€£ã™ã‚‹å†…å®¹ã€‚
8.  **mainImageCaption (ãƒ¡ã‚¤ãƒ³ç”»åƒã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³):**
    - 10ï½20æ–‡å­—ç¨‹åº¦ã§ã€ãƒ¡ã‚¤ãƒ³ç”»åƒã®çŠ¶æ³ã‚’èª¬æ˜ã€‚
    - ä¾‹ï¼šã€Œæ­“å–œã®èƒ´ä¸Šã’ã€ã€Œæ¸¾èº«ã®ä¸€çƒã€

### å‡ºåŠ›å½¢å¼ (JSON)
{"mainHeadline": "...", "mainArticleSubHeadline": "...", "mainArticleBody": "...", "sideArticle1Headline": "...", "sideArticle1Body": "...", "sideArticle2Headline": "...", "sideArticle2Body": "...", "mainImageCaption": "..."}`;
        
        try {
            const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: finalPrompt }] }] });
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
                if (article && article.mainHeadline && article.mainArticleSubHeadline && article.mainArticleBody) {
                    return article;
                }
            }
            throw new Error("AI final article response format error.");
        } catch (error) {
            console.error("AI final article generation failed:", error);
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã®è¨˜äº‹ã‚’è¿”ã™
            return {
                mainHeadline: "æ¿€é—˜ã®æœ«",
                mainArticleSubHeadline: `${finalMatch.winnerName}ã€æ „å† ï¼ ç²˜ã‚Šã®é‡çƒã§æ‚²é¡˜é”æˆ`,
                mainArticleBody: `æœ¬æ—¥è¡Œã‚ã‚ŒãŸæ±ºå‹æˆ¦ã¯ã€ä¸¡ãƒãƒ¼ãƒ ä¸€æ­©ã‚‚è­²ã‚‰ãªã„ç™½ç†±ã®å±•é–‹ã¨ãªã£ãŸã€‚${finalMatch.winnerName}ã¯å¾—æ„ã®é›†ä¸­æ‰“ã§ãƒãƒ£ãƒ³ã‚¹ã‚’ã‚‚ã®ã«ã—ã€${finalMatch.loserName}ã¯å …ã„å®ˆå‚™ã§å¿œæˆ¦ã€‚æœ€çµ‚ç›¤ã¾ã§ã‚‚ã¤ã‚Œè¾¼ã‚€å¤§æ¥æˆ¦ã¨ãªã£ãŸãŒã€${finalMatch.winnerName}ãŒæŒã¡å‰ã®å‹è² å¼·ã•ã‚’ç™ºæ®ã—ã€${finalMatch.winnerScore}-${finalMatch.loserScore}ã§å‹åˆ©ã‚’ã‚‚ãå–ã£ãŸã€‚æ‚²é¡˜ã®å„ªå‹ã«é¸æ‰‹ãŸã¡ã¯æ­“å–œã®æ¶™ã‚’æµã—ã€ã‚¹ã‚¿ãƒ³ãƒ‰ã‹ã‚‰ã¯æƒœã—ã¿ãªã„æ‹æ‰‹ãŒé€ã‚‰ã‚ŒãŸã€‚æ•—ã‚ŒãŸ${finalMatch.loserName}ã‚‚ã€ãã®å ‚ã€…ãŸã‚‹æˆ¦ã„ã¶ã‚Šã¯å¤šãã®æ„Ÿå‹•ã‚’å‘¼ã‚“ã ã€‚`,
                sideArticle1Headline: `ç›£ç£ã€Œå¤¢ã®èˆå°ã€`,
                sideArticle1Body: `å„ªå‹ç›£ç£ã¯ã€Œé¸æ‰‹ãŸã¡ãŒæœ¬å½“ã«ã‚ˆãé ‘å¼µã£ã¦ãã‚ŒãŸã€‚å¤¢ã®èˆå°ã§æœ€é«˜ã®é‡çƒãŒã§ããŸã€ã¨ã€æ„Ÿæ¥µã¾ã£ãŸæ§˜å­ã§èªã£ãŸã€‚ã‚¨ãƒ¼ã‚¹ã‚‚ã€Œä»²é–“ã‚’ä¿¡ã˜ã¦æŠ•ã’ãŸã€ã¨èƒ¸ã‚’å¼µã£ãŸã€‚`,
                sideArticle2Headline: `æº–Vã‚‚èƒ¸å¼µã‚‹`,
                sideArticle2Body: `æƒœã—ãã‚‚æº–å„ªå‹ã«çµ‚ã‚ã£ãŸ${finalMatch.loserName}ã®é¸æ‰‹ãŸã¡ã¯ã€Œæ‚”ã—ã„ãŒã€å…¨åŠ›ã‚’å°½ãã›ãŸã€ã¨ã€ã™ãŒã™ãŒã—ã„è¡¨æƒ…ã§çƒå ´ã‚’å¾Œã«ã—ãŸã€‚å¤ã‚’å½©ã‚‹ç†±æˆ¦ã«æ„Ÿè¬ã®æ„ã‚’è¡¨ã—ãŸã€‚`,
                mainImageCaption: `${finalMatch.winnerName}ã€æ­“å–œã®ç¬é–“`
            };
        }
    }


    // é€šå¸¸ãƒ©ã‚¦ãƒ³ãƒ‰ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    const prompt = `ã‚ãªãŸã¯ã€Œé™å²¡ ç†±é—˜æ–°èã€ã®ç·¨é›†é•·ã§ã™ã€‚
é«˜æ ¡é‡çƒ ${tournamentNameMap[tournamentState.currentTournament]}ã®ã€Œ${roundName}ã€ãŒå…¨è©¦åˆçµ‚äº†ã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®åˆ†æãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€æ–°èã®ä¸€é¢ã‚’é£¾ã‚‹ã€Œç¸¦æ›¸ãã®å¤§è¦‹å‡ºã—ã€ã€Œãƒ¡ã‚¤ãƒ³è¨˜äº‹ã®å°è¦‹å‡ºã—ã€ã€Œãƒ¡ã‚¤ãƒ³è¨˜äº‹æœ¬æ–‡ã€ã€Œã‚µã‚¤ãƒ‰è¨˜äº‹1ã®è¦‹å‡ºã—ã€ã€Œã‚µã‚¤ãƒ‰è¨˜äº‹1æœ¬æ–‡ã€ã€Œã‚µã‚¤ãƒ‰è¨˜äº‹2ã®è¦‹å‡ºã—ã€ã€Œã‚µã‚¤ãƒ‰è¨˜äº‹2æœ¬æ–‡ã€ã€Œãƒ¡ã‚¤ãƒ³ç”»åƒã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã€ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### ${roundName} åˆ†æãƒ‡ãƒ¼ã‚¿
- **è©¦åˆæ•°:** ${results.length}è©¦åˆ
- **æœ€å¤§ã®æ³¢ä¹±:** ${upsetText || 'ç‰¹ã«å¤§ããªæ³¢ä¹±ã¯ãªã‹ã£ãŸã€‚'}
- **ã‚·ãƒ¼ãƒ‰æ ¡ã®å‹•å‘:** ${seedStatusText}
- **æ³¨ç›®ãƒãƒ¼ãƒ :** å¼·è±ªæ ¡ã®åå‰ã‚’ã„ãã¤ã‹æŒ™ã’ã‚‹ã“ã¨ã‚‚å¯èƒ½ã€‚

### æŒ‡ç¤º
1.  **mainHeadline (ç¸¦æ›¸ãã®å¤§è¦‹å‡ºã—):**
    - 5ï½8æ–‡å­—ç¨‹åº¦ã§ã€æœ€ã‚‚è¡æ’ƒçš„ã¾ãŸã¯é‡è¦ãªäº‹å®Ÿã‚’ä¼ãˆã‚‹ã€‚
    - ä¾‹ï¼šã€Œã‚·ãƒ¼ãƒ‰æ•£ã‚‹ã€ã€Œå¤§æ³¢ä¹±ã®ã€‡å›æˆ¦ã€ã€Œå¼·è±ªã€é †å½“å‹ã¡ã€
2.  **mainArticleSubHeadline (ãƒ¡ã‚¤ãƒ³è¨˜äº‹ã®å°è¦‹å‡ºã—):**
    - 20ï½30æ–‡å­—ç¨‹åº¦ã§ã€å¤§è¦‹å‡ºã—ã‚’è£œè¶³ã—ã€ãƒ©ã‚¦ãƒ³ãƒ‰å…¨ä½“ã®æ¦‚æ³ã‚’è¡¨ç¾ã™ã‚‹ã€‚
    - ä¾‹ï¼šã€Œæ¿€æˆ¦ã‚’åˆ¶ã—ã€æ¬¡ãªã‚‹èˆå°ã¸ï¼æ³¢ä¹±å«ã¿ã®å±•é–‹ã«ç†±æ°—ã€
3.  **mainArticleBody (ãƒ¡ã‚¤ãƒ³è¨˜äº‹æœ¬æ–‡):**
    - 150ï½200æ–‡å­—ç¨‹åº¦ã§ã€${roundName}å…¨ä½“ã‚’ç·æ‹¬ã™ã‚‹ã€‚
    - å¿…ãšã€Œæœ€å¤§ã®æ³¢ä¹±ã€ã¨ã€Œã‚·ãƒ¼ãƒ‰æ ¡ã®å‹•å‘ã€ã«è§¦ã‚Œã‚‹ã“ã¨ã€‚
    - èª­è€…ã®æœŸå¾…ã‚’ç…½ã‚‹ã‚ˆã†ãªã€ç†±æ„ã®ã‚ã‚‹æ–‡ä½“ã§æ›¸ãã“ã¨ã€‚
    - 2æ®µè½ä»¥ä¸Šã«åˆ†ã‘ã‚‹ã“ã¨ã€‚
4.  **sideArticle1Headline (ã‚µã‚¤ãƒ‰è¨˜äº‹1ã®è¦‹å‡ºã—):**
    - 15æ–‡å­—ç¨‹åº¦ã§ã€ç•ªç‹‚ã‚ã›ã‚’èµ·ã“ã—ãŸãƒãƒ¼ãƒ ã‚„é¸æ‰‹ã®æ´»èºãªã©ã€ç‰¹å®šã®ãƒˆãƒ”ãƒƒã‚¯ã‚’åˆ‡ã‚Šå–ã‚‹ã€‚
    - ä¾‹ï¼šã€Œã€‡ã€‡é«˜æ ¡ã€é‡‘æ˜Ÿï¼ã€ã€Œè‹¥ãã‚¨ãƒ¼ã‚¹ã®èºå‹•ã€
5.  **sideArticle1Body (ã‚µã‚¤ãƒ‰è¨˜äº‹1æœ¬æ–‡):**
    - 80ï½120æ–‡å­—ç¨‹åº¦ã§ã€ä¸Šè¨˜ã®è¦‹å‡ºã—ã«é–¢é€£ã™ã‚‹å†…å®¹ã€‚
6.  **sideArticle2Headline (ã‚µã‚¤ãƒ‰è¨˜äº‹2ã®è¦‹å‡ºã—):**
    - 15æ–‡å­—ç¨‹åº¦ã§ã€æƒœæ•—ã—ãŸãƒãƒ¼ãƒ ã®å¥é—˜ã‚„ã€æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸ã®å±•æœ›ãªã©ã€‚
    - ä¾‹ï¼šã€Œå¼·è±ªã€æ¶™ã‚’é£²ã‚€ã€ã€Œãƒ™ã‚¹ãƒˆ8å‡ºæƒã†ã€
7.  **sideArticle2Body (ã‚µã‚¤ãƒ‰è¨˜äº‹2æœ¬æ–‡):**
    - 80ï½120æ–‡å­—ç¨‹åº¦ã§ã€ä¸Šè¨˜ã®è¦‹å‡ºã—ã«é–¢é€£ã™ã‚‹å†…å®¹ã€‚
8.  **mainImageCaption (ãƒ¡ã‚¤ãƒ³ç”»åƒã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³):**
    - 10ï½20æ–‡å­—ç¨‹åº¦ã§ã€ãƒ¡ã‚¤ãƒ³ç”»åƒã®çŠ¶æ³ã‚’èª¬æ˜ã€‚
    - ä¾‹ï¼šã€Œç†±æˆ¦ã®ç¬é–“ã€ã€Œæ¸¾èº«ã®æŠ•çƒã€

### å‡ºåŠ›å½¢å¼ (JSON)
{"mainHeadline": "...", "mainArticleSubHeadline": "...", "mainArticleBody": "...", "sideArticle1Headline": "...", "sideArticle1Body": "...", "sideArticle2Headline": "...", "sideArticle2Body": "...", "mainImageCaption": "..."}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (article && article.mainHeadline && article.mainArticleSubHeadline && article.mainArticleBody) {
                return article;
            }
        }
        throw new Error("AI article response format error.");
    } catch (error) {
        console.error("AI skip round article generation failed:", error);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã®è¨˜äº‹ã‚’è¿”ã™
        return {
            mainHeadline: mainHeadlineCandidate,
            mainArticleSubHeadline: "æ¿€æˆ¦ã‚’åˆ¶ã—ã€æ¬¡ãªã‚‹èˆå°ã¸",
            mainArticleBody: `æœ¬æ—¥è¡Œã‚ã‚ŒãŸ${roundName}ã§ã¯ã€å„åœ°ã§æ‰‹ã«æ±—æ¡ã‚‹æ¿€æˆ¦ãŒç¹°ã‚Šåºƒã’ã‚‰ã‚ŒãŸã€‚${upsetText || seedStatusText} é¸æ‰‹ãŸã¡ã®ç†±ã„æ€ã„ãŒè©°ã¾ã£ãŸãƒ—ãƒ¬ãƒ¼ã«ã€è¦³è¡†ã¯æƒœã—ã¿ãªã„æ‹æ‰‹ã‚’é€ã£ãŸã€‚\n\nã“ã®çµæœã€æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ã¸ã®é€²å‡ºã‚’æ±ºã‚ãŸãƒãƒ¼ãƒ ã¯ã€ã•ã‚‰ãªã‚‹é«˜ã¿ã‚’ç›®æŒ‡ã™ã“ã¨ã«ãªã‚‹ã€‚æ•—ã‚ŒãŸãƒãƒ¼ãƒ ã‚‚ã¾ãŸã€ãã®å¥é—˜ã‚’ç§°ãˆã‚‰ã‚Œã€æ¥å¹´ã¸ã®é›ªè¾±ã‚’èª“ã£ãŸã€‚å¤ã®ç”²å­åœ’ã‚’ç›®æŒ‡ã™æˆ¦ã„ã¯ã€ã¾ã™ã¾ã™ç†±æ°—ã‚’å¸¯ã³ã¦ãã¦ã„ã‚‹ã€‚`,
            sideArticle1Headline: `æ³¨ç›®æ ¡ã®æˆ¦ã„`,
            sideArticle1Body: `ã€‡ã€‡é«˜æ ¡ã®ã‚¨ãƒ¼ã‚¹ã€ç”°ä¸­é¸æ‰‹ã¯æœ¬æ—¥ã‚‚åœ§å·»ã®ãƒ”ãƒƒãƒãƒ³ã‚°ã‚’æŠ«éœ²ã€‚ç²˜ã‚‹ç›¸æ‰‹æ‰“ç·šã‚’å®Œç’§ã«æŠ‘ãˆè¾¼ã¿ã€ãƒãƒ¼ãƒ ã‚’å‹åˆ©ã«å°ã„ãŸã€‚`,
            sideArticle2Headline: `æ•—è€…ã®å¼`,
            sideArticle2Body: `æƒœã—ãã‚‚æ•—ã‚ŒãŸâ–³â–³é«˜æ ¡ã®ä¸»å°†ã¯ã€Œæ‚”ã—ã„ãŒã€å…¨åŠ›ã‚’å°½ãã›ãŸã€‚ã“ã®çµŒé¨“ã‚’ãƒãƒã«ã—ãŸã„ã€ã¨æ¶™ã‚’ã“ã‚‰ãˆãªãŒã‚‰èªã£ãŸã€‚`,
            mainImageCaption: mainImageCaptionCandidate
        };
    }
}


// ... (æ—¢å­˜ã® initializeApp(); ã®å‘¼ã³å‡ºã—) ...

 /**
     * ç¾åœ¨ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆçŠ¶æ…‹ã«åŸºã¥ã„ã¦UIå…¨ä½“ã‚’å†æç”»ã™ã‚‹
     * (â˜…å¤ãƒ»ç§‹ãƒ»æ˜¥ ã™ã¹ã¦128ãƒãƒ¼ãƒ åˆ¶ã®ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ã‚±ãƒƒãƒˆã‚’æç”»ã™ã‚‹ã‚ˆã†çµ±ä¸€)
     */
    function renderTournament(data) {
        let tournamentNameString = tournamentNameMap[data.currentTournament] || 'å¤§ä¼š';

        // UIè¦ç´ ã‚’ä¸€åº¦ã™ã¹ã¦éè¡¨ç¤ºã«åˆæœŸåŒ–
        mainBracketWrapper.classList.add('hidden');
        autumnRegionalContainer.classList.add('hidden');
        autumnRankingContainer.classList.add('hidden');
        autumnControls.classList.add('hidden');
        [skipAutumnBlocksBtn, skipAutumnRankingBtn, skipAutumnMainBtn, skipSpringQualifiersBtn, skipSpringRound1Btn, skipSpringMainBtn, startRankingPlayoffsBtn, startMainTournamentBtn].forEach(btn => btn?.classList.add('hidden'));
        
        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒæ–°ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        // å¤§ä¼šã®ç¨®é¡ã«é–¢ã‚ã‚‰ãšã€å¸¸ã«ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ã‚±ãƒƒãƒˆã‚’æç”»
        mainBracketWrapper.classList.remove('hidden');
        renderMainBracket(data);
        // â˜…â˜…â˜… æ–°ãƒ­ã‚¸ãƒƒã‚¯ã“ã“ã¾ã§ â˜…â˜…â˜…

        // --- å…±é€šã®æç”»å‡¦ç† (å¤‰æ›´ãªã—) ---
        tournamentYearDisplay.textContent = `${data.tournamentYear}å¹´åº¦ ${tournamentNameString}`;
        renderRegionMap(data);
        renderNews(data.news || []);
        renderBbsComments(data.bbsComments || []);
        renderDaiyaBbsComments(data.daiyaBbsComments || []);
        renderNamcoNews(data.namcoNews);
        checkTournamentProgress(); // å¤ãƒ»ç§‹ãƒ»æ˜¥ å…±é€šã®ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¶å¾¡
        updateTicker();
    }
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * [ç§‹å­£å¤§ä¼š] åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
 */
async function skipAutumnRegionalBlocks() {
    skipAutumnBlocksBtn.disabled = true;
    skipAutumnBlocksBtn.textContent = 'é€²è¡Œä¸­...';

    // å…¨ã¦ã®åœ°åŒºã®å…¨ãƒ–ãƒ­ãƒƒã‚¯ã®è©¦åˆã‚’å‡¦ç†
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨', 'ä¼Šè±†']) {
        const regionData = tournamentState.autumnData.regions[region];
        
        const blocks = regionData.izuBracket ? [regionData.izuBracket] : regionData.blocks;

        for (const block of blocks) {
            // ãƒ–ãƒ­ãƒƒã‚¯å†…ã®å…¨è©¦åˆIDã‚’å–å¾—
            const matchIds = Object.keys(block.matches);
            for (const matchId of matchIds) {
                const match = block.matches[matchId];
                // ãƒãƒ¼ãƒ ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¦ã€ã¾ã å‹è€…ãŒæ±ºã¾ã£ã¦ã„ãªã„è©¦åˆã‚’å‡¦ç†
                if (match.team1 && match.team2 && !match.winner) {
                    const { team1, team2 } = match;
                    const rank1 = calculateRank(team1, tournamentState);
                    const rank2 = calculateRank(team2, tournamentState);
                    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
                    
                    const winnerName = (rankValues[rank1] >= rankValues[rank2]) ? team1 : team2;
                    const loserName = winnerName === team1 ? team2 : team1;

                    const [winnerScore, loserScore] = generateAutoScore(rank1, rank2);
                    match.score1 = (match.team1 === winnerName) ? winnerScore : loserScore;
                    match.score2 = (match.team2 === winnerName) ? winnerScore : loserScore;
                    
                    // processMatchWinã‚’å‘¼ã³å‡ºã—ã¦å‹è€…ã‚’æ¬¡ã«é€²ã‚ã‚‹
                    await processMatchWin(matchId, winnerName);
                }
            }
        }
    }
    
    // å…¨ã¦çµ‚ã‚ã£ãŸã‚‰ã€è‡ªå‹•ã§æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸
    await setupAutumnRankingTournaments();
    skipAutumnBlocksBtn.disabled = false;
    skipAutumnBlocksBtn.textContent = 'åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸ã‚’ã‚¹ã‚­ãƒƒãƒ—';
}

/**
 * [ç§‹å­£å¤§ä¼š] åœ°åŒºé †ä½æ±ºå®šæˆ¦ï¼ˆæ•—è€…å¾©æ´»æˆ¦ï¼‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
 */
async function skipAutumnRankingTournaments() {
    skipAutumnRankingBtn.disabled = true;
    skipAutumnRankingBtn.textContent = 'é€²è¡Œä¸­...';

    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const repBracket = tournamentState.autumnData.regions[region].repechageBracket;
        if (!repBracket) continue;
        
        const matchIds = Object.keys(repBracket.matches);
        for (const matchId of matchIds) {
            const match = repBracket.matches[matchId];
            if (match.team1 && match.team2 && !match.winner) {
                const { team1, team2 } = match;
                const rank1 = calculateRank(team1, tournamentState);
                const rank2 = calculateRank(team2, tournamentState);
                const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
                
                const winnerName = (rankValues[rank1] >= rankValues[rank2]) ? team1 : team2;
                
                const [winnerScore, loserScore] = generateAutoScore(rank1, rank2);
                match.score1 = (match.team1 === winnerName) ? winnerScore : loserScore;
                match.score2 = (match.team2 === winnerName) ? winnerScore : loserScore;

                await processMatchWin(matchId, winnerName);
            }
        }
    }

    // è‡ªå‹•ã§çœŒå¤§ä¼šæœ¬æˆ¦ã¸
    await setupAutumnMainTournament();
    skipAutumnRankingBtn.disabled = false;
    skipAutumnRankingBtn.textContent = 'åœ°åŒºé †ä½æ±ºå®šæˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—';
}

/**
 * [ç§‹å­£å¤§ä¼š] çœŒå¤§ä¼šæœ¬æˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
 */
async function skipAutumnMainTournament() {
    skipAutumnMainBtn.disabled = true;
    skipAutumnMainBtn.textContent = 'é€²è¡Œä¸­...';

    // ç§‹å­£çœŒå¤§ä¼šã¯16ãƒãƒ¼ãƒ ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆï¼ˆ4ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
    await skipRound(1); // 1å›æˆ¦ (ãƒ™ã‚¹ãƒˆ8æ±ºå®š)
    await skipRound(2); // æº–ã€…æ±ºå‹ (ãƒ™ã‚¹ãƒˆ4æ±ºå®š)
    await skipRound(3); // æº–æ±ºå‹ (æ±ºå‹é€²å‡ºæ±ºå®š)
    await skipFinal();  // æ±ºå‹

    skipAutumnMainBtn.disabled = false;
    skipAutumnMainBtn.textContent = 'çœŒå¤§ä¼šæœ¬æˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—';
}

/**
 * [æ˜¥å­£å¤§ä¼š] åœ°åŒºäºˆé¸ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
 */
async function skipSpringQualifiers() {
    skipSpringQualifiersBtn.disabled = true;
    skipSpringQualifiersBtn.textContent = 'é€²è¡Œä¸­...';

    const allQualifierMatches = Object.values(tournamentState.springData.allMatches);

    // äºˆé¸ã®å…¨è©¦åˆã‚’ãƒ«ãƒ¼ãƒ—å‡¦ç†
    for (const match of allQualifierMatches) {
        // ãƒãƒ¼ãƒ ãŒã¾ã ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ãªã„è©¦åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (!match.team1 || !match.team2 || match.winner) continue;
        
        const { team1, team2 } = match;
        const rank1 = calculateRank(team1, tournamentState);
        const rank2 = calculateRank(team2, tournamentState);
        const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
        
        const winnerName = (rankValues[rank1] >= rankValues[rank2]) ? team1 : team2;
        
        const [winnerScore, loserScore] = generateAutoScore(rank1, rank2);
        match.score1 = (match.team1 === winnerName) ? winnerScore : loserScore;
        match.score2 = (match.team2 === winnerName) ? winnerScore : loserScore;

        await processMatchWin(match.id, winnerName);
    }

    // è‡ªå‹•ã§çœŒå¤§ä¼š1å›æˆ¦ã¸
    await setupSpringMainTournament_Round1();
    skipSpringQualifiersBtn.disabled = false;
    skipSpringQualifiersBtn.textContent = 'æ˜¥å­£åœ°åŒºäºˆé¸ã‚’ã‚¹ã‚­ãƒƒãƒ—';
}

/**
 * [æ˜¥å­£å¤§ä¼š] çœŒå¤§ä¼š1å›æˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
 */
async function skipSpringMainRound1() {
    skipSpringRound1Btn.disabled = true;
    skipSpringRound1Btn.textContent = 'é€²è¡Œä¸­...';

    // 1å›æˆ¦ã¯8è©¦åˆ
    await skipRound(1); 
    
    // è‡ªå‹•ã§çœŒå¤§ä¼š2å›æˆ¦ã¸
    await setupSpringMainTournament_Round2();
    skipSpringRound1Btn.disabled = false;
    skipSpringRound1Btn.textContent = 'æ˜¥å­£çœŒå¤§ä¼š1å›æˆ¦ã‚’ã‚¹ã‚­ãƒƒãƒ—';
}

/**
 * [æ˜¥å­£å¤§ä¼š] çœŒå¤§ä¼š2å›æˆ¦ä»¥é™ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
 */
async function skipSpringMainTournament() {
    skipSpringMainBtn.disabled = true;
    skipSpringMainBtn.textContent = 'é€²è¡Œä¸­...';

    // 2å›æˆ¦ä»¥é™ã¯ãƒ™ã‚¹ãƒˆ16ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã¨åŒã˜
    await skipRound(1); // 2å›æˆ¦ (ãƒ™ã‚¹ãƒˆ8æ±ºå®š)
    await skipRound(2); // æº–ã€…æ±ºå‹ (ãƒ™ã‚¹ãƒˆ4æ±ºå®š)
    await skipRound(3); // æº–æ±ºå‹ (æ±ºå‹é€²å‡ºæ±ºå®š)
    await skipFinal();  // æ±ºå‹

    skipSpringMainBtn.disabled = false;
    skipSpringMainBtn.textContent = 'æ˜¥å­£çœŒå¤§ä¼š2å›æˆ¦ä»¥é™ã‚’ã‚¹ã‚­ãƒƒãƒ—';
}

   /**
     * ãƒ¡ã‚¤ãƒ³ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ï¼ˆ128, 32, 16ãƒãƒ¼ãƒ åˆ¶ã«å¯¾å¿œï¼‰ã‚’æç”»ã™ã‚‹
     * (â˜…32ãƒãƒ¼ãƒ åˆ¶ï¼å·¦å³8è©¦åˆãšã¤ã«æŒ¯ã‚Šåˆ†ã‘ã‚‹ã‚ˆã†ä¿®æ­£)
     */
    function renderMainBracket(data) {
        if (!data.teams || data.teams.length === 0) {
             mainBracketContainer.innerHTML = '';
             return;
        };

        const { matches, teams, seeds } = data;
        const numTeams = teams.length; // 128 (å¤), 32 (ç§‹), 16 (æ˜¥)

        const bracketContentWrapper = document.createElement('div');
        bracketContentWrapper.className = 'flex flex-row';

        const leftBracketEl = document.createElement('div');
        leftBracketEl.className = 'bracket-half left';

        const rightBracketEl = document.createElement('div');
        rightBracketEl.className = 'bracket-half right';
        
        const finalRound = Math.log2(numTeams); // 128->7, 32->5, 16->4
        const semiFinalRound = finalRound - 1; // æº–æ±ºå‹ã®ãƒ©ã‚¦ãƒ³ãƒ‰ç•ªå· (R6, R4, R3)
        
        const leftChampion = data.matches[`L-R${semiFinalRound}-M1`]?.winner ?? null;
        const rightChampion = data.matches[`R-R${semiFinalRound}-M1`]?.winner ?? null;
        
        const finalMatch = data.matches['F-R1-M1'] || {};
        const finalTeam1 = finalMatch.team1 ?? leftChampion;
        const finalTeam2 = finalMatch.team2 ?? rightChampion;

        const finalEl = document.createElement('div');
        finalEl.className = 'bracket-final';
        finalEl.innerHTML = `<div class="final-title">æ±ºå‹</div><div class="final-matchup" data-match-id="F-R1-M1">${createMatchHTML('F-R1-M1', finalTeam1, finalTeam2, finalMatch, seeds)}</div><div class="winner-box" id="tournament-winner">${finalMatch.winner ? `ğŸ† ${finalMatch.winner} ğŸ†` : 'ğŸ†'}</div>`;

        // 1å›æˆ¦ã®å…¨è©¦åˆã‚’ç”Ÿæˆ (128->64è©¦åˆ, 32->16è©¦åˆ, 16->8è©¦åˆ)
        const round1Setup = teams.reduce((acc, team, i) => {
            if (i % 2 === 0) acc.push({ team1: team, team2: null });
            else acc[acc.length - 1].team2 = team;
            return acc;
        }, []);
        
        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ (å…¨è©¦åˆã‚’åŠåˆ†ã«åˆ†å‰²) â˜…â˜…â˜…
        const halfMatches = round1Setup.length / 2; // 64->32, 16->8, 8->4
        
        const leftHalfSetup = round1Setup.slice(0, halfMatches);
        const rightHalfSetup = round1Setup.slice(halfMatches);
        // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

        generateHalf(leftBracketEl, leftHalfSetup, 'L', matches, seeds);
        generateHalf(rightBracketEl, rightHalfSetup, 'R', matches, seeds);

        mainBracketContainer.innerHTML = '';
        bracketContentWrapper.append(leftBracketEl, finalEl, rightBracketEl);
        mainBracketContainer.appendChild(bracketContentWrapper);

        if (finalMatch.winner) {
            nextTournamentBtn.classList.remove('hidden');
        } else {
            nextTournamentBtn.classList.add('hidden');
        }
    }
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

   /**
     * ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®ç‰‡å´ï¼ˆãƒ¬ãƒ•ãƒˆã¾ãŸã¯ãƒ©ã‚¤ãƒˆï¼‰ã‚’æç”»ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
     * (â˜…128ãƒãƒ¼ãƒ åˆ¶ï¼7ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¶ã®ãƒ©ã‚¦ãƒ³ãƒ‰åã«å›ºå®š)
     */
    function generateHalf(containerEl, setup, side, allMatches, seeds) {
        containerEl.innerHTML = '';
        const numMatchesInFirstRound = setup.length; // 32
        const numTeamsOnSide = numMatchesInFirstRound * 2; // 64
        const numRounds = Math.log2(numTeamsOnSide); // 6 (R1...R6)

        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ (128ãƒãƒ¼ãƒ åˆ¶ã®ãƒ©ã‚¦ãƒ³ãƒ‰åã«å›ºå®š) â˜…â˜…â˜…
        const roundNameMap = { 1: "1å›æˆ¦", 2: "2å›æˆ¦", 3: "3å›æˆ¦", 4: "4å›æˆ¦", 5: "æº–ã€…æ±ºå‹", 6: "æº–æ±ºå‹" };
        // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

        const roundElements = [];
        for (let i = 0; i < numRounds; i++) {
            const roundEl = document.createElement('div');
            roundEl.className = 'round';
            if (i > 0) roundEl.classList.add('subsequent-round');

            const roundTitle = document.createElement('h3');
            roundTitle.className = 'text-center font-bold mb-2';
            roundTitle.textContent = roundNameMap[i + 1] || `${i + 1}å›æˆ¦`;
            roundEl.appendChild(roundTitle);

            containerEl.appendChild(roundEl);
            roundElements.push(roundEl);
        }

        // (ä»¥é™ã®æç”»ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
        setup.forEach((matchSetup, index) => {
            const matchId = `${side}-R1-M${index + 1}`;
            let dbMatch = allMatches[matchId] || {};
            const team1 = dbMatch.team1 || matchSetup.team1;
            const team2 = dbMatch.team2 || matchSetup.team2;
            roundElements[0].insertAdjacentHTML('beforeend', createMatchHTML(matchId, team1, team2, dbMatch, seeds));
        });
        
        for (let r = 2; r <= numRounds; r++) {
            const numMatchesInRound = numMatchesInFirstRound / Math.pow(2, r - 1);
            for (let m = 1; m <= numMatchesInRound; m++) {
                const matchId = `${side}-R${r}-M${m}`;
                const dbMatch = allMatches[matchId] || {};
                const prevMatch1Id = `${side}-R${r - 1}-M${(m * 2) - 1}`;
                const prevMatch2Id = `${side}-R${r - 1}-M${m * 2}`;
                const prevWinner1 = allMatches[prevMatch1Id]?.winner || null;
                const prevWinner2 = allMatches[prevMatch2Id]?.winner || null;
                const team1 = dbMatch.team1 || prevWinner1;
                const team2 = dbMatch.team2 || prevWinner2;
                roundElements[r - 1].insertAdjacentHTML('beforeend', createMatchHTML(matchId, team1, team2, dbMatch, seeds));
            }
        }
    }
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * ç†±ç‹‚åº¦ã‚°ãƒ©ãƒ•ã‚’æç”»ã™ã‚‹
 */
function renderExcitementChart(ctx, dataObj) {
    // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Œã°ç ´æ£„
    const existingChart = Chart.getChart(ctx);
    if (existingChart) existingChart.destroy();

    // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ (èµ¤ããªã‚‹ã»ã©ç†±ã„)
    const gradient = ctx.createLinearGradient(0, 200, 0, 0);
    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)'); // é’ (å†·)
    gradient.addColorStop(1, 'rgba(239, 68, 68, 0.6)');  // èµ¤ (ç†±)

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dataObj.labels,
            datasets: [{
                label: 'è©¦åˆç†±ç‹‚åº¦ (Excitement)',
                data: dataObj.dataPoints,
                borderColor: '#f59e0b', // Amber
                backgroundColor: gradient,
                borderWidth: 3,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#f59e0b',
                pointRadius: 4,
                tension: 0.4, // æ»‘ã‚‰ã‹ãªæ›²ç·š
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'ç››ã‚Šä¸ŠãŒã‚Šåº¦' },
                    suggestedMax: 50
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (ctx) => `ç†±ç‹‚åº¦: ${ctx.raw.toFixed(1)}`
                    }
                },
                annotation: {
                    annotations: {
                        line1: {
                            type: 'line', yMin: 20, yMax: 20, borderColor: 'red', borderDash: [2, 2], 
                            label: { content: 'æ¿€ç†±ã‚¾ãƒ¼ãƒ³', enabled: true, position: 'end', color: 'red', font: {size: 10} }
                        }
                    }
                }
            }
        }
    });
}
// â–²â–²â–² ç†±ç‹‚åº¦ã‚°ãƒ©ãƒ•æ©Ÿèƒ½ ã“ã“ã¾ã§ â–²â–²â–²

/**
 * [UPDATED] è©¦åˆã®ã€Œç†±ç‹‚åº¦ã€æ¨ç§»ãƒ‡ãƒ¼ã‚¿ã‚’è¨ˆç®—ã™ã‚‹
 * (â˜…ãƒ©ãƒ³ã‚¯å·®ã«ã‚ˆã‚‹ã€Œç•ªç‹‚ã‚ã›è£œæ­£ã€ã‚’è¿½åŠ ã—ãŸä¿®æ­£ç‰ˆ)
 */
function calculateExcitementData(dbMatch) {
    if (!dbMatch || !dbMatch.details) return null;

    // â˜… 1. ãƒ©ãƒ³ã‚¯æƒ…å ±ã®å–å¾—ã¨å·®åˆ†ã®è¨ˆç®—
    const rank1 = calculateRank(dbMatch.team1, tournamentState);
    const rank2 = calculateRank(dbMatch.team2, tournamentState);
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
    const val1 = rankValues[rank1] || 3;
    const val2 = rankValues[rank2] || 3;
    
    const rankDiff = val1 - val2; 

    const inningScores1 = dbMatch.details.inningScore.team1 || [];
    const inningScores2 = dbMatch.details.inningScore.team2 || [];
    
    // â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ãªã‚‰ã€ãã®å›æ•°ã‚’ä¸Šé™ã«ã™ã‚‹ â–¼â–¼â–¼
    let numInnings = Math.max(inningScores1.length, inningScores2.length);
    if (dbMatch.calledGame && dbMatch.calledInning) {
        numInnings = dbMatch.calledInning;
    }
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    let dataPoints = [];
    let labels = [];
    let totalExcitement = 0;

    let currentScore1 = 0;
    let currentScore2 = 0;

    for (let i = 0; i < numInnings; i++) {
        const inningNum = i + 1;
        
        const runsTop = parseInt(inningScores1[i] || 0);
        const prevScore1 = currentScore1;
        currentScore1 += runsTop;
        
        const runsBottom = parseInt(inningScores2[i] || 0);
        const prevScore2 = currentScore2;
        currentScore2 += runsBottom;

        // --- ç†±ç‹‚åº¦è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
        const scoreDiff = currentScore1 - currentScore2;
        const absDiff = Math.abs(scoreDiff);

        let scoreFactor = 1.0;
        if (absDiff === 0) scoreFactor = 3.0;
        else if (absDiff === 1) scoreFactor = 2.0;
        else if (absDiff <= 3) scoreFactor = 1.2;
        else scoreFactor = 0.5;

        let upsetFactor = 1.0;
        if (rankDiff > 0 && scoreDiff <= 0) {
            upsetFactor = 1.0 + (rankDiff * 0.2); 
            if (scoreDiff < 0) upsetFactor += 0.5; 
        }
        else if (rankDiff < 0 && scoreDiff >= 0) {
            upsetFactor = 1.0 + (Math.abs(rankDiff) * 0.2);
            if (scoreDiff > 0) upsetFactor += 0.5;
        }
        else if ((rankDiff > 0 && scoreDiff >= 5) || (rankDiff < 0 && scoreDiff <= -5)) {
            upsetFactor = 0.6;
        }

        let inningFactor = 1.0;
        if (inningNum >= 9) inningFactor = 2.5; 
        else if (inningNum >= 7) inningFactor = 1.5;

        let eventBonus = 0;
        const wasLeading1 = prevScore1 > prevScore2;
        const isLeading1 = currentScore1 > currentScore2;
        const wasTied = prevScore1 === prevScore2;
        
        if (wasLeading1 !== isLeading1 && !wasTied && absDiff !== 0) eventBonus += 5.0 * upsetFactor;
        if (!wasTied && absDiff === 0) eventBonus += 3.0 * upsetFactor;
        
        if (i === numInnings - 1 && dbMatch.winner === dbMatch.team2 && runsBottom > 0 && prevScore2 <= currentScore1) {
            eventBonus += 20.0; 
            scoreFactor = 5.0;
        }

        const runsFactor = (runsTop + runsBottom) * 0.5;
        let excitement = (10 * scoreFactor * inningFactor * upsetFactor) + (runsFactor * 2) + eventBonus;
        
        dataPoints.push(excitement);
        labels.push(`${inningNum}å›`);
        totalExcitement += excitement;
    }

    let rank = 'C';
    const avgExcitement = numInnings > 0 ? totalExcitement / numInnings : 0; // 0é™¤ç®—å¯¾ç­–
    
    if (avgExcitement >= 35) rank = 'S (ä¼èª¬ã®åå‹è² )';
    else if (avgExcitement >= 25) rank = 'A (æ¿€ç†±)';
    else if (avgExcitement >= 15) rank = 'B (å¥½ã‚²ãƒ¼ãƒ )';
    else rank = 'C (å‡¡æˆ¦ãƒ»ä¸€æ–¹çš„)';

    return { labels, dataPoints, rank, totalExcitement };
}

 // â–¼â–¼â–¼ æ—¢å­˜ã®ã€ŒcreateMatchHTMLã€é–¢æ•° (12489è¡Œç›®ã‚ãŸã‚Š) ã‚’ã€ä»¥ä¸‹ã§ã€Œç½®ãæ›ãˆã€ â–¼â–¼â–¼

/**
 * 1è©¦åˆåˆ†ã®HTMLã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…é¸æ‰‹ã®ã€Œèª¿å­ã€ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºã‚’è¿½åŠ ã—ãŸæœ€çµ‚ç‰ˆ)
 */
function createMatchHTML(matchId, team1, team2, dbMatch, seeds = []) {
    // --- (å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° createSpecialButtons ã¯å¤‰æ›´ãªã—) ---
    const createSpecialButtons = (teamName) => {
        if (!teamName || (tournamentState.documentary && tournamentState.documentary.target)) return '';
        let buttonHTML = '';
        if (UNDERDOG_TEAMS.includes(teamName)) {
            buttonHTML += `<button class="underdog-doc-btn text-lg ml-2" data-team-name="${teamName}" title="${teamName}ã®é€†å¢ƒã«å¯†ç€å–æã™ã‚‹">ğŸ“¹</button>`;
        }
        if (POWERHOUSE_TEAMS.includes(teamName)) {
            buttonHTML += `<button class="powerhouse-doc-btn text-lg ml-2" data-team-name="${teamName}" title="${teamName}ã®ç‹è€…ã®è‹¦æ‚©ã«å¯†ç€å–æã™ã‚‹">ğŸ‘‘</button>`;
        }
        if (POWERHOUSE_REVIVAL_TEAMS.includes(teamName)) {
            buttonHTML += `<button class="powerhouse-revival-doc-btn text-lg ml-2" data-team-name="${teamName}" title="${teamName}ã®å¤è±ªå¾©æ´»ã«å¯†ç€å–æã™ã‚‹">ğŸ°</button>`;
        }
        if (ONE_MAN_TEAMS.includes(teamName)) {
            buttonHTML += `<button class="one-man-team-doc-btn text-lg ml-2" data-team-name="${teamName}" title="çµ¶å¯¾çš„ã‚¨ãƒ¼ã‚¹ã¨ãã®ä»²é–“ãŸã¡ã«å¯†ç€å–æã™ã‚‹">ğŸŒŸ</button>`;
        }
        return buttonHTML;
    };
    
    const t1Empty = !team1;
    const t2Empty = !team2;

    let specialMatchClass = '';
    if (dbMatch.rivalryType) {
        specialMatchClass = 'rivalry-match';
    } 
    else if (!t1Empty && !t2Empty) {
        const feud = tournamentState.feuds?.find(f => f.teams.includes(team1) && f.teams.includes(team2));
        if (feud) {
            specialMatchClass = 'feud-match';
        } else {
            const rivalry = tournamentState.rivalries?.find(r => r.teams.includes(team1) && r.teams.includes(team2));
            if (rivalry) {
                specialMatchClass = 'rivalry-match';
            }
        }
    }
    const rank1 = calculateRank(team1, tournamentState);
    const rank2 = calculateRank(team2, tournamentState);
    const rankColor = (rank) => {
        switch (rank) {
            case 'A': return 'rank-A'; case 'B': return 'rank-B'; case 'C': return 'rank-C';
            case 'D': return 'rank-D'; case 'E': return 'rank-E'; default: return '';
        }
    };

    const seedInfo1 = seeds.find(s => s.team === team1);
    const seedInfo2 = seeds.find(s => s.team === team2);
    const isSeed1 = !!seedInfo1;
    const isSeed2 = !!seedInfo2;

    const showInputs = !t1Empty && !t2Empty;

    let atmosphereInputs = '';
    if (showInputs) {
        atmosphereInputs = `
        <div class="team-atmosphere-container mt-1">
            <input type-="text" class="team-atmosphere-input w-full text-xs p-1 border rounded-t" data-match-id="${matchId}" data-team-key="team1" placeholder="[${team1}] è©¦åˆå‰ã®é›°å›²æ°—/å…¬ç´„ (ä»»æ„)" value="${dbMatch.atmosphere_team1 || ''}">
            <input type-="text" class="team-atmosphere-input w-full text-xs p-1 border rounded-b border-t-0" data-match-id="${matchId}" data-team-key="team2" placeholder="[${team2}] è©¦åˆå‰ã®é›°å›²æ°—/å…¬ç´„ (ä»»æ„)" value="${dbMatch.atmosphere_team2 || ''}">
        </div>
        `;
    }

    let scheduleInfo = '';
    if (dbMatch.schedule) { 
        const gameNumIcon = ['â‘ ', 'â‘¡', 'â‘¢', 'â‘£'][dbMatch.schedule.game - 1] || `(${dbMatch.schedule.game})`;
        scheduleInfo = `
        <div class="match-schedule" title="${dbMatch.schedule.stadiumFull}çƒå ´ ${dbMatch.schedule.date} ç¬¬${dbMatch.schedule.game}è©¦åˆ">
            ${dbMatch.schedule.date}ãƒ»${dbMatch.schedule.stadium}${gameNumIcon}
        </div>
        `;
    }

    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
    // é¸æ‰‹ã®èª¿å­ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
    const getConditionIconForTeam = (teamName) => {
        // (æ³¨: ã“ã®é–¢æ•°ã¯ã€Œè©¦åˆå‰ã€ã«æç”»ã•ã‚Œã¾ã™ã€‚ã‚¢ã‚¤ã‚³ãƒ³ã¯ã€Œå‰ã®è©¦åˆã€ã®çµæœã§ã™)
        if (!teamName) return ""; 
        
        const teamRecord = tournamentState.teamRecords[teamName];
        if (!teamRecord || !teamRecord.playerStats) return "";

        let icons = [];

        // 1. æ‰“è€…ã®èª¿å­
        if (teamRecord.playerStats.batting) {
            for (const playerName in teamRecord.playerStats.batting) {
                const flag = teamRecord.playerStats.batting[playerName].narrative_flag;
                const icon = getPlayerConditionIcon(flag);
                if (icon) icons.push(icon);
            }
        }
        // 2. æŠ•æ‰‹ã®èª¿å­
        if (teamRecord.playerStats.pitching) {
            for (const playerName in teamRecord.playerStats.pitching) {
                const flag = teamRecord.playerStats.pitching[playerName].narrative_flag;
                const icon = getPlayerConditionIcon(flag);
                if (icon) icons.push(icon);
            }
        }
        
        // é‡è¤‡ã‚’é™¤å»ã—ã¦è¿”ã™ (ä¾‹: å§«å·ãŒæ‰“è€…/æŠ•æ‰‹ä¸¡æ–¹ã§ğŸ”¥ã§ã‚‚1ã¤ã ã‘è¡¨ç¤º)
        return [...new Set(icons)].join('');
    };

    const team1ConditionIcons = getConditionIconForTeam(team1);
    const team2ConditionIcons = getConditionIconForTeam(team2);
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    // â–¼â–¼â–¼ ãƒãƒ¼ãƒ ã‚¹ãƒ­ãƒƒãƒˆã®HTMLã‚’å·®ã—æ›¿ãˆ â–¼â–¼â–¼
    const content = `
        <div class="team-slot ${t1Empty ? 'empty' : ''} ${dbMatch.winner === team1 && !t1Empty ? 'winner' : ''} ${dbMatch.winner && dbMatch.winner !== team1 && dbMatch.winner !== null ? 'loser' : ''}" data-team-name="${team1 || ''}">
            <span class="team-name clickable-team-name ${isSeed1 ? 'seed' : ''}" title="${team1 || ''}" data-team-name="${team1 || ''}">
                ${team1 ? `<span class="rank ${rankColor(rank1)}">[${rank1}]</span>` : ''}
                ${isSeed1 ? `[${seedInfo1.rank}] ` : ''}${team1 || '---'}
                ${team1ConditionIcons}
            </span>
            ${createSpecialButtons(team1)} 
            ${!t1Empty ? `<button class="show-team-stats-btn text-lg p-1 text-blue-600 hover:bg-blue-100 rounded" data-team-name="${team1}" title="${team1} ã®é€šç®—æˆç¸¾ã‚’è¦‹ã‚‹">ğŸ“Š</button>` : ''}
            
            <input type="text" class="score-input ${showInputs ? '' : 'hidden'}" value="${dbMatch.score1 ?? ''}" data-team-pos="1">
            <button class="win-btn ${showInputs ? '' : 'hidden'}">â–¶</button>
            ${!showInputs ? `<span class="score-input font-bold">${dbMatch.score1 ?? ''}</span>` : ''}
        </div>
        
        <div class="team-slot ${t2Empty ? 'empty' : ''} ${dbMatch.winner === team2 && !t2Empty ? 'winner' : ''} ${dbMatch.winner && dbMatch.winner !== team2 && dbMatch.winner !== null ? 'loser' : ''}" data-team-name="${team2 || ''}">
            <span class="team-name clickable-team-name ${isSeed2 ? 'seed' : ''}" title="${team2 || ''}" data-team-name="${team2 || ''}">
                ${team2 ? `<span class="rank ${rankColor(rank2)}">[${rank2}]</span>` : ''}
                ${isSeed2 ? `[${seedInfo2.rank}] ` : ''}${team2 || '---'}
                ${team2ConditionIcons}
            </span>
            ${createSpecialButtons(team2)}
            ${!t2Empty ? `<button class="show-team-stats-btn text-lg p-1 text-blue-600 hover:bg-blue-100 rounded" data-team-name="${team2}" title="${team2} ã®é€šç®—æˆç¸¾ã‚’è¦‹ã‚‹">ğŸ“Š</button>` : ''}
            
            <input type="text" class="score-input ${showInputs ? '' : 'hidden'}" value="${dbMatch.score2 ?? ''}" data-team-pos="2">
            <button class="win-btn ${showInputs ? '' : 'hidden'}">â–¶</button>
            ${!showInputs ? `<span class="score-input font-bold">${dbMatch.score2 ?? ''}</span>` : ''}
        </div>
        ${scheduleInfo} 
        ${atmosphereInputs}
        <div class="match-summary-container ${showInputs ? '' : 'hidden'}">
            <textarea class="match-summary-input w-full text-xs p-1 mt-1 border rounded" data-match-id="${matchId}" placeholder="è©¦åˆã®æ±ºã‚æ‰‹ï¼ˆä»»æ„ï¼‰">${dbMatch.summary || ''}</textarea>
        </div>
    `;

    // â–²â–²â–² å·®ã—æ›¿ãˆã“ã“ã¾ã§ â–²â–²â–²

    let calledGameInfo = '';
    if (dbMatch.calledGame) {
        calledGameInfo = `<div class="text-center text-xs text-red-600 font-bold mt-1">(${dbMatch.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰)</div>`;
    }

    let footer = '';
    if (dbMatch.winner && dbMatch.boxScoreHtml) {
        footer = `<div class="matchup-footer">
                    <button class="boxscore-btn text-sm bg-blue-600 text-white font-bold px-4 py-1 rounded hover:bg-blue-700" data-match-id="${matchId}">
                        ä¸€çƒé€Ÿå ±
                    </button>
                    <button class="details-btn text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600" data-match-id="${matchId}" title="è©³ç´°å…¥åŠ›ï¼ˆä¿®æ­£ï¼‰">
                        è©³ç´°
                    </button>
                  </div>`;
    }
     else if (!t1Empty && !t2Empty && !dbMatch.winner) {
        footer = `<div class="matchup-footer">
                    <button class="details-btn" data-match-id="${matchId}">è©³ç´°å…¥åŠ›</button>
                    <button class="scorecard-open-btn text-sm bg-green-600 text-white font-bold px-3 py-1 rounded hover:bg-green-700" data-match-id="${matchId}">
                        ğŸ® ç°¡æ˜“å…¥åŠ›
                    </button>
                    <button class="quick-sim-btn text-lg" data-match-id="${matchId}" title="ã“ã®ã‚¹ã‚³ã‚¢ã§ãŠã¾ã‹ã›å…¥åŠ›">ğŸ²</button>
                    <button class="pre-game-cheer-btn text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600" data-match-id="${matchId}">å¿œæ´</button>
                  </div>`;
    }
        
    return `<div class="matchup ${specialMatchClass}" data-match-id="${matchId}">
                ${content}
                ${calledGameInfo} 
                ${footer}
            </div>`;
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

 // â–¼â–¼â–¼ ã€æ”¹ä¿®ç‰ˆã€‘é«˜æ©Ÿèƒ½ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ‰ â–¼â–¼â–¼

let currentNewsFilter = 'all'; // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹

/**
 * ãƒ‹ãƒ¥ãƒ¼ã‚¹ä¸€è¦§ã‚’æç”»ã™ã‚‹ (ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¯¾å¿œç‰ˆ)
 */
function renderNews(news) {
    const container = document.getElementById('news-articles');
    if (!news || news.length === 0) {
        container.innerHTML = `<div class="text-center py-10 text-gray-400">ã¾ã ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
        return;
    }
    container.innerHTML = '';
    
    // æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ã‚³ãƒ”ãƒ¼
    const sortedNews = news.slice().reverse();

    sortedNews.forEach((article, reversedIndex) => {
        const originalIndex = news.length - 1 - reversedIndex;
        
        // 1. è¨˜äº‹ã‚¿ã‚¤ãƒ—ã¨ã‚«ãƒ†ã‚´ãƒªã®åˆ¤å®š
        let type = 'normal';
        let categoryLabel = 'é€Ÿå ±';
        let badgeClass = 'badge-score';
        let cardClass = 'type-score';
        let icon = 'âš¾';

        if (article.isScandalRumor || article.isAccident) {
            type = 'scandal'; categoryLabel = 'ç‰¹å ±'; badgeClass = 'badge-scandal'; cardClass = 'type-scandal'; icon = 'âš¡';
        } else if (article.title.includes('å·å¤–') || article.title.includes('å„ªå‹') || article.title.includes('æ±ºå®š')) {
            type = 'gogai'; categoryLabel = 'å·å¤–'; badgeClass = 'badge-gogai'; cardClass = 'type-gogai'; icon = 'ğŸ“£';
        } else if (article.isHadaReport || article.isScoutReport || article.isTopicArticle || article.summaryType === 'best8') {
            type = 'column'; categoryLabel = 'ã‚³ãƒ©ãƒ '; badgeClass = 'badge-column'; cardClass = 'type-column'; icon = 'ğŸ“';
        } else if (article.isNewspaper || article.isSkipNewspaper) {
             type = 'column'; categoryLabel = 'æ–°è'; badgeClass = 'badge-gogai'; cardClass = 'type-gogai'; icon = 'ğŸ“°';
        }

        // 2. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Ÿè¡Œ
        if (currentNewsFilter !== 'all') {
            if (currentNewsFilter === 'score' && type !== 'normal') return;
            if (currentNewsFilter === 'column' && type !== 'column') return;
            if (currentNewsFilter === 'gogai' && (type !== 'gogai' && type !== 'scandal')) return;
        }

        // 3. ã‚«ãƒ¼ãƒ‰HTMLç”Ÿæˆ
        const timeStr = new Date(article.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        const snippet = article.body.replace(/<br>/g, ' ').substring(0, 60) + '...';

        const card = document.createElement('div');
        card.className = `news-card ${cardClass}`;
        
        // è¨˜äº‹ã®ç¨®é¡ã«å¿œã˜ãŸã‚¯ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
        if (article.isNewspaper || article.isSkipNewspaper) {
             // æ–°èã®å ´åˆ
             card.innerHTML = `
                <div class="news-thumbnail bg-red-100 text-red-500">${icon}</div>
                <div class="flex-grow">
                    <div class="news-meta">
                        <span class="news-category-badge ${badgeClass}">${categoryLabel}</span>
                        <span>${timeStr}</span>
                    </div>
                    <div class="news-headline">${article.title}</div>
                    <div class="news-snippet">${snippet}</div>
                    <div class="mt-2 text-right">
                         <button class="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded newspaper-view-btn" data-index="${originalIndex}">ç´™é¢ã‚’èª­ã‚€</button>
                         ${article.isSkipNewspaper ? `<button class="text-xs bg-gray-700 text-white hover:bg-gray-800 px-2 py-1 rounded ml-1 skip-newspaper-view-btn" data-index="${originalIndex}">æ‹¡å¤§</button>` : ''}
                    </div>
                </div>
             `;
        } 
        else if (article.isScoutReport) {
             // ã‚¹ã‚«ã‚¦ãƒ†ã‚£ãƒ³ã‚°ãƒ¬ãƒãƒ¼ãƒˆ
             card.innerHTML = `
                <div class="news-thumbnail bg-green-100 text-green-600">${icon}</div>
                <div class="flex-grow">
                    <div class="news-meta">
                        <span class="news-category-badge ${badgeClass}">${categoryLabel}</span>
                        <span>${timeStr}</span>
                    </div>
                    <div class="news-headline">${article.title}</div>
                    <div class="news-snippet">${snippet}</div>
                    <div class="mt-2 text-right">
                         <button class="text-xs bg-green-600 text-white hover:bg-green-700 px-2 py-1 rounded scout-view-btn" data-index="${originalIndex}">ãƒ¬ãƒãƒ¼ãƒˆè©³ç´°</button>
                    </div>
                </div>
             `;
        }
        else {
            // é€šå¸¸è¨˜äº‹ / ã‚³ãƒ©ãƒ  / é€Ÿå ±
            const regenBtn = article.context ? `<button class="text-xs bg-yellow-100 text-yellow-700 hover:bg-yellow-200 px-2 py-1 rounded ml-1 regenerate-btn" data-index="${originalIndex}">å†å–æ</button>` : '';
            
            card.innerHTML = `
                <div class="news-thumbnail">${icon}</div>
                <div class="flex-grow">
                    <div class="news-meta">
                        <span class="news-category-badge ${badgeClass}">${categoryLabel}</span>
                        <span>${timeStr}</span>
                    </div>
                    <div class="news-headline">${article.title}</div>
                    <div class="news-snippet">${snippet}</div>
                    <div class="mt-2 text-right">
                        <button class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-600 px-3 py-1 rounded news-article-btn" data-index="${originalIndex}">æœ¬æ–‡ã‚’èª­ã‚€</button>
                        ${regenBtn}
                    </div>
                </div>
            `;
        }

        container.appendChild(card);
    });
}

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('news-filter-btn')) {
        // ã‚¿ãƒ–ã®è¦‹ãŸç›®åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.news-filter-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ã—ã¦å†æç”»
        currentNewsFilter = e.target.dataset.filter;
        renderNews(tournamentState.news);
    }
});



/**
 * æ²ç¤ºæ¿ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰å½¢å¼ã¨å€‹åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆå½¢å¼ã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰ã‚’æç”»ã™ã‚‹
 */
function renderBbsComments(items) { // å¼•æ•°åã‚’ items ã«å¤‰æ›´
    if (!items || items.length === 0) {
        bbsCommentsContainer.innerHTML = `<p class="text-gray-500 text-center">ã¾ã åå¿œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
        return;
    }
    bbsCommentsContainer.innerHTML = ''; // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢

    // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«é€†é †ã§å‡¦ç†
    items.slice().reverse().forEach((item, reversedIndex) => {
        const originalIndex = items.length - 1 - reversedIndex;

        // A. ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
        if (item.error && item.title) {
            const errorEl = document.createElement('div');
            errorEl.className = 'article-error mb-4'; // ãƒãƒ¼ã‚¸ãƒ³è¿½åŠ , ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã®ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æµç”¨
            // â˜…â˜…â˜… å†ç”Ÿæˆãƒœã‚¿ãƒ³ã®dataå±æ€§ã‚’ä¿®æ­£ â˜…â˜…â˜…
            const regenerateButtonHTML = item.context ? `<button class="retry-bbs-btn bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700" data-index="${originalIndex}" data-type="${item.context.isBracketThread ? 'bracket-thread' : 'match-comments'}">å†ç”Ÿæˆ</button>` : '';
            errorEl.innerHTML = `<span>${item.title}</span>${regenerateButtonHTML}`;
            bbsCommentsContainer.appendChild(errorEl);
        }
        // B. ã‚¹ãƒ¬ãƒƒãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ (çµ„ã¿åˆã‚ã›æ±ºå®šã‚¹ãƒ¬ãªã© title ã¨ comments ã‚’æŒã¤)
        else if (item.comments && Array.isArray(item.comments) && item.title) {
            const threadWrapper = document.createElement('div');
            threadWrapper.className = 'mb-6 p-4 border rounded-lg bg-white shadow';

            const titleEl = document.createElement('h3');
            titleEl.className = 'text-lg font-bold text-gray-800 mb-3 border-b pb-2';
            titleEl.textContent = `ã€${item.matchId === 'bracket' ? 'çµ„ã¿åˆã‚ã›æ±ºå®š' : 'è©¦åˆçµæœ'}ã€‘${item.title}`;
            threadWrapper.appendChild(titleEl);

            const commentsContainer = document.createElement('div');
            commentsContainer.className = 'space-y-3';

            // ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æç”»
            item.comments.forEach(comment => {
                renderCommentThread(comment, commentsContainer, 'general');
            });

            threadWrapper.appendChild(commentsContainer);
            bbsCommentsContainer.appendChild(threadWrapper);
        }
        // C. å€‹åˆ¥ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ (è©¦åˆå¾Œã®åå¿œãªã© personality ã¨ text ã‚’æŒã¤)
        else if (item.personality && item.text) {
            // å€‹åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚¹ãƒ¬ãƒƒãƒ‰æ ãªã—ã§ç›´æ¥æç”»
            renderCommentThread(item, bbsCommentsContainer, 'general');
            // å€‹åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆé–“ã«åŒºåˆ‡ã‚Šç·šãªã©ã‚’å…¥ã‚Œã¦ã‚‚è‰¯ã„ã‹ã‚‚
            const hr = document.createElement('hr');
            hr.className = 'my-3 border-gray-200';
            bbsCommentsContainer.appendChild(hr);
        }
        // D. ãã®ä»–ã®äºˆæœŸã›ã¬ãƒ‡ãƒ¼ã‚¿
        else {
             console.warn("Unknown item type in bbsComments:", item);
             const unknownEl = document.createElement('div');
             unknownEl.className = 'text-red-500 text-sm my-2';
             unknownEl.textContent = '[ä¸æ˜ãªæ²ç¤ºæ¿ãƒ‡ãƒ¼ã‚¿]';
             bbsCommentsContainer.appendChild(unknownEl);
        }
    });

     // æœ€å¾Œã®åŒºåˆ‡ã‚Šç·šã‚’å‰Šé™¤ (å€‹åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆãŒæœ€å¾Œã ã£ãŸå ´åˆ)
     const lastElement = bbsCommentsContainer.lastElementChild;
     if (lastElement && lastElement.tagName === 'HR') {
         bbsCommentsContainer.removeChild(lastElement);
     }
}

// renderCommentThread é–¢æ•°ã¯å€‹åˆ¥ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æç”»ã™ã‚‹ãŸã‚ã€åŸºæœ¬å¤‰æ›´ä¸è¦
// function renderCommentThread(comment, container, bbsType) { ... }

    function renderDaiyaBbsComments(comments) {
        if (!comments || comments.length === 0) {
            daiyaBbsCommentsContainer.innerHTML = `<p class="text-gray-500 text-center">ã¾ã åå¿œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
            return;
        }
        daiyaBbsCommentsContainer.innerHTML = '';
        comments.slice().reverse().forEach(comment => {
            renderCommentThread(comment, daiyaBbsCommentsContainer, 'daiya');
        });
    }

    function renderNamcoNews(news) {
        if (!news) {
            namcoNewsSection.classList.add('hidden');
            return;
        }
        namcoNewsSection.classList.remove('hidden');
        namcoNewsContent.innerHTML = '';
        const newsItem = document.createElement('div');
        newsItem.className = 'namco-news-item p-2 hover:bg-orange-50 rounded';
        newsItem.innerHTML = `<p class="font-semibold text-gray-700">${news.title}<span class="namco-news-tag">é‡çƒéƒ¨</span></p>`;
        newsItem.addEventListener('click', () => {
            document.getElementById('modal-title').textContent = news.title;
            document.getElementById('modal-body').textContent = news.body;
            document.getElementById('modal-meta').innerHTML = `<p>${new Date(news.timestamp).toLocaleDateString('ja-JP')}</p><p class="font-bold text-gray-500">é‡çƒéƒ¨</p>`;
            newsModal.classList.remove('hidden');
            newsModal.classList.add('flex');
        });
        namcoNewsContent.appendChild(newsItem);
    }

    function renderCommentThread(comment, container, bbsType) {
        const threadContainer = document.createElement('div');
        if (container.id === `replies-to-${comment.id}` || (container.id.includes('bbs-comments') && container.children.length > 0)) {
            threadContainer.className = 'ml-4 border-l-2 pl-4 mt-2';
        } else {
            threadContainer.className = 'mt-2';
        }

        const personalityClass = comment.personality === 'ã‚ãªãŸ' ? 'text-blue-600 font-bold' : 'text-gray-600';
        const commentEl = document.createElement('div');
        commentEl.className = 'bbs-comment';
        commentEl.innerHTML = `
            <div class="flex justify-between items-center">
                <p class="font-semibold ${personalityClass} text-sm">${comment.personality || 'åç„¡ã—ã•ã‚“'}</p>
                <button class="reply-btn text-xs text-blue-500 hover:underline" data-comment-id="${comment.id}" data-bbs-type="${bbsType}">è¿”ä¿¡ã™ã‚‹</button>
            </div>
            <p class="text-gray-800 my-1 whitespace-pre-wrap">${comment.text}</p>
            <p class="text-xs text-gray-400 text-right">${new Date(comment.timestamp).toLocaleString('ja-JP')}</p>
            <div id="reply-form-container-${comment.id}" class="hidden mt-2">
                <form class="reply-form" data-comment-id="${comment.id}" data-bbs-type="${bbsType}">
                    <textarea class="w-full p-2 border rounded text-sm" placeholder="è¿”ä¿¡ã‚’å…¥åŠ›..." required></textarea>
                    <button type="submit" class="mt-1 bg-blue-500 text-white px-3 py-1 text-xs rounded hover:bg-blue-600">é€ä¿¡</button>
                </form>
            </div>
        `;
        threadContainer.appendChild(commentEl);

        const repliesContainer = document.createElement('div');
        repliesContainer.id = `replies-to-${comment.id}`;
        threadContainer.appendChild(repliesContainer);

        container.appendChild(threadContainer);

        if (comment.replies && comment.replies.length > 0) {
            comment.replies.slice().reverse().forEach(reply => {
                renderCommentThread(reply, repliesContainer, bbsType);
            });
        }
    }

   // â–¼â–¼â–¼ æ—¢å­˜ã®ã€ŒrenderRegionMapã€é–¢æ•° (8459è¡Œç›®ã‚ãŸã‚Š) ã‚’ã€ä»¥ä¸‹ã§ã€Œç½®ãæ›ãˆã€ â–¼â–¼â–¼

/**
 * [UPDATED] åœ°åŸŸåˆ¥å‹ã¡æ®‹ã‚ŠçŠ¶æ³ã‚’æç”»ã™ã‚‹
 * (â˜…å‚åŠ ãƒãƒ¼ãƒ ã®åœ°åŸŸ(region)ã‚’å‹•çš„ã«åé›†ã—ã¦è¡¨ç¤ºã™ã‚‹æ±ç”¨ç‰ˆ)
 */
function renderRegionMap(data) {
    const regionMapSection = document.getElementById('region-map-section');
    const finalMatch = data.matches['F-R1-M1'];
    
    // è©¦åˆãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯éè¡¨ç¤º
    if ((!data.matches || Object.keys(data.matches).length === 0) && !finalMatch) {
        regionMapSection.classList.add('hidden');
        return;
    }
    regionMapSection.classList.remove('hidden');

    const container = document.getElementById('region-map-container');
    
    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: åœ°åŸŸã‚’å‹•çš„ã«åé›† â˜…â˜…â˜…
    const teamsByRegion = {};
    const targetTeams = data.teams || INITIAL_TEAM_POOL; // ç¾åœ¨ã®å¤§ä¼šå‚åŠ ãƒãƒ¼ãƒ ã€ãªã‘ã‚Œã°å…¨ãƒãƒ¼ãƒ 

    targetTeams.forEach(teamName => {
        if (teamName === '(BYE)') return;
        const region = TEAM_DATA[teamName]?.region || 'ãã®ä»–';
        if (!teamsByRegion[region]) {
            teamsByRegion[region] = [];
        }
        teamsByRegion[region].push(teamName);
    });
    
    // è¡¨ç¤ºé †åºã‚’å®šç¾© (ç”²å­åœ’ç”¨ã¨çœŒå¤§ä¼šç”¨)
    let regionOrder = [];
    if (data.currentTournament === 'summer_koshien') {
        regionOrder = ['åŒ—æµ·é“', 'æ±åŒ—', 'é–¢æ±', 'åŒ—ä¿¡è¶Š', 'æ±æµ·', 'è¿‘ç•¿', 'ä¸­å›½', 'å››å›½', 'ä¹å·', 'å…¨å›½', 'ãã®ä»–'];
    } else {
        regionOrder = ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨', 'ä¼Šè±†', 'ãã®ä»–'];
    }
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    const eliminatedTeams = new Set();
    const allMatches = data.matches; 

    Object.values(allMatches).filter(match => match.winner).forEach(match => {
        const loser = match.team1 === match.winner ? match.team2 : match.team1;
        if (loser && loser !== '(BYE)') eliminatedTeams.add(loser); 
    });

    if (finalMatch?.winner) {
        const tournamentWinner = finalMatch.winner;
        // å„ªå‹ãƒãƒ¼ãƒ ã¯æ•—é€€ãƒªã‚¹ãƒˆã‹ã‚‰é™¤å¤–ï¼ˆå¿µã®ãŸã‚ï¼‰
        if (eliminatedTeams.has(tournamentWinner)) eliminatedTeams.delete(tournamentWinner);
    }
    
    let html = '<div class="region-map-scroll-container">';
    
    // å®šç¾©é †ã«ä¸¦ã¹æ›¿ãˆã€å®šç¾©ã«ãªã„åœ°åŸŸã¯æœ«å°¾ã«è¿½åŠ 
    const sortedRegions = Object.keys(teamsByRegion).sort((a, b) => {
        const indexA = regionOrder.indexOf(a);
        const indexB = regionOrder.indexOf(b);
        if (indexA !== -1 && indexB !== -1) return indexA - indexB;
        if (indexA !== -1) return -1;
        if (indexB !== -1) return 1;
        return a.localeCompare(b, 'ja');
    });

    for (const region of sortedRegions) {
        const teams = teamsByRegion[region];
        if (!teams || teams.length === 0) continue;
        
        const survivingCount = teams.filter(team => !eliminatedTeams.has(team)).length;

        html += `
        <div class="region-column">
            <div class="region-header">
                <h3 class="region-title">${region}</h3>
                <p class="region-stats">${survivingCount} / ${teams.length} æ ¡ç”Ÿå­˜</p>
            </div>
            <ul class="region-team-list">
                ${teams.sort((a, b) => {
                    const aElim = eliminatedTeams.has(a);
                    const bElim = eliminatedTeams.has(b);
                    if (aElim === bElim) return a.localeCompare(b, 'ja');
                    return aElim ? 1 : -1;
                }).map(team => `
                    <li class="region-team ${eliminatedTeams.has(team) ? 'team-eliminated' : 'team-surviving'}">
                        ${team}
                    </li>
                `).join('')}
            </ul>
        </div>
        `;
    }
    html += '</div>';
    container.innerHTML = html;
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
    
    /**
     * ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’åˆ¶å¾¡ã™ã‚‹
     * (â˜…å¤‰æ•°å®£è¨€ã‚’å‰Šé™¤ã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ä¿®æ­£)
     */
    function checkTournamentProgress() {
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ (const ã‚’ã™ã¹ã¦å‰Šé™¤) â˜…â˜…â˜…
        skipR1Btn = document.getElementById('skip-r1-btn');
        skipR2Btn = document.getElementById('skip-r2-btn');
        skipR3Btn = document.getElementById('skip-r3-btn');
        skipR4Btn = document.getElementById('skip-r4-btn');
        skipR5Btn = document.getElementById('skip-r5-btn');
        skipR6Btn = document.getElementById('skip-r6-btn'); 
        skipFinalBtn = document.getElementById('skip-final-btn');
        generateSummaryBtn = document.getElementById('generate-summary-btn');
        // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…
        
        const allSkipButtons = [skipR1Btn, skipR2Btn, skipR3Btn, skipR4Btn, skipR5Btn, skipR6Btn, skipFinalBtn, generateSummaryBtn];

        if (!tournamentState.matches || Object.keys(tournamentState.matches).length === 0) {
            allSkipButtons.forEach(btn => btn?.classList.add('hidden'));
            return;
        }

        const matchIds = Object.keys(tournamentState.matches);
        const numTeams = tournamentState.teams.length; // 128
        const finalRound = Math.log2(numTeams); // 7

        const getRoundStatus = (roundNumber) => {
            const played = matchIds.filter(id => id.includes(`-R${roundNumber}-M`) && tournamentState.matches[id]?.winner).length;
            const total = numTeams / Math.pow(2, roundNumber); // R1=64, R2=32...
            return { total, played };
        };
        
        const r1_status = getRoundStatus(1);
        const r2_status = getRoundStatus(2);
        const r3_status = getRoundStatus(3);
        const r4_status = getRoundStatus(4);
        const r5_status = getRoundStatus(5);
        const r6_status = getRoundStatus(6);
        const finalMatch = tournamentState.matches['F-R1-M1'];

        skipR1Btn.classList.toggle('hidden', r1_status.played === r1_status.total);
        skipR2Btn.classList.toggle('hidden', !(r1_status.played === r1_status.total && r2_status.played !== r2_status.total));
        skipR3Btn.classList.toggle('hidden', !(r2_status.played === r2_status.total && r3_status.played !== r3_status.total));
        skipR4Btn.classList.toggle('hidden', !(r3_status.played === r3_status.total && r4_status.played !== r4_status.total));
        skipR5Btn.classList.toggle('hidden', !(r4_status.played === r4_status.total && r5_status.played !== r5_status.total));
        skipR6Btn.classList.toggle('hidden', !(r5_status.played === r5_status.total && r6_status.played !== r6_status.total));
        skipFinalBtn.classList.toggle('hidden', !(r6_status.played === r6_status.total && (!finalMatch || !finalMatch.winner)));
        
        const summaryGenerated = tournamentState.news.some(n => n.summaryType === 'best8');
        generateSummaryBtn.classList.toggle('hidden', !(r4_status.played === r4_status.total && r5_status.played === 0 && !summaryGenerated));
    }
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
     * ã€ä¿®æ­£ç‰ˆã€‘æ±ºå‹æˆ¦ã‚’è‡ªå‹•ã§ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
     * (â˜…æ–°èç”Ÿæˆãƒ•ãƒƒã‚¯ã‚’è¿½åŠ )
     */
    async function skipFinal() {
        const finalMatch = tournamentState.matches['F-R1-M1'];
        if (!finalMatch || !finalMatch.team1 || !finalMatch.team2 || finalMatch.winner) return;

        const btn = document.getElementById('skip-final-btn');
        if(btn) btn.disabled = true;
        
        const { team1, team2 } = finalMatch;
        const rank1 = calculateRank(team1, tournamentState);
        const rank2 = calculateRank(team2, tournamentState);
        const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
        
        let winnerName, loserName;
        // ãƒ©ãƒ³ã‚¯å·®ãŒ2ä»¥ä¸Šã‚ã‚‹å ´åˆã€95%ã®ç¢ºç‡ã§ãƒ©ãƒ³ã‚¯ä¸Šä½ãŒå‹åˆ©
        const upsetChance = Math.abs(rankValues[rank1] - rankValues[rank2]) >= 2 ? 0.05 : 0.45;

        if (Math.random() < upsetChance) { // ç•ªç‹‚ã‚ã›
            winnerName = rankValues[rank1] < rankValues[rank2] ? team1 : team2;
        } else { // é †å½“
            winnerName = rankValues[rank1] >= rankValues[rank2] ? team1 : team2;
        }
        loserName = winnerName === team1 ? team2 : team1;

        const winnerRank = calculateRank(winnerName, tournamentState);
        const loserRank = calculateRank(loserName, tournamentState);
        const [winnerScore, loserScore] = generateAutoScore(winnerRank, loserRank);

        finalMatch.score1 = (finalMatch.team1 === winnerName) ? winnerScore : loserScore;
        finalMatch.score2 = (finalMatch.team2 === winnerName) ? winnerScore : loserScore;

        // â˜… çµæœã‚’åé›† (æ±ºå‹ã¯1è©¦åˆã®ã¿)
        const roundResults = [{
            matchId: 'F-R1-M1', winnerName, loserName, winnerScore, loserScore,
            winnerRank, loserRank, rankDiff: rankValues[winnerRank] - rankValues[loserRank]
        }];

        await processMatchWin('F-R1-M1', winnerName);

        // â˜…â˜…â˜… ã‚¹ãƒ†ãƒƒãƒ—2ï¼šæ–°èã‚’ç”Ÿæˆãƒ»è¡¨ç¤º â˜…â˜…â˜…
        const finalRoundNum = Math.log2(tournamentState.teams.length); // 128ãƒãƒ¼ãƒ ãªã‚‰ 7
        await generateSkipRoundNewspaper(finalRoundNum, roundResults);
        // â˜…â˜…â˜… æ–°èç”Ÿæˆãƒ•ãƒƒã‚¯ã“ã“ã¾ã§ â˜…â˜…â˜…

        if(btn) btn.classList.add('hidden');
    }

    function checkBest8Decided(){} // checkTournamentProgressã«çµ±åˆ
// --- è©¦åˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®é–¢æ•°ï¼ˆé«˜æ©Ÿèƒ½ç‰ˆï¼‰ ---

   /**
 * [ä¿®æ­£ç‰ˆ] ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ã®ãƒ†ãƒ¼ãƒ–ãƒ«HTMLã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…ã‚³ãƒ¼ãƒ«ãƒ‰å›æ•°ã‚„å®Ÿéš›ã®ã‚¤ãƒ‹ãƒ³ã‚°æ•°ã«åˆã‚ã›ã¦åˆ—æ•°ã‚’èª¿æ•´)
 */
function createInningScoreTable(team1Name, team2Name, details, isCalledGame, calledInning) {
    const inningData = details.inningScore || { team1: [], team2: [] };
    
    // è¡¨ç¤ºã™ã‚‹ã‚¤ãƒ‹ãƒ³ã‚°æ•°ã‚’æ±ºå®š
    // ãƒ‡ãƒ¼ã‚¿ä¸Šã®æœ€å¤§ã‚¤ãƒ‹ãƒ³ã‚°ã€ã‚³ãƒ¼ãƒ«ãƒ‰å›ã€ã¾ãŸã¯æœ€ä½9å›
    const maxDataLen = Math.max(inningData.team1.length, inningData.team2.length);
    let numInnings = Math.max(9, maxDataLen);

    // ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ã®å ´åˆã¯ã€æŒ‡å®šã•ã‚ŒãŸå›æ•°ã§åˆ‡ã‚‹
    if (isCalledGame && calledInning) {
        numInnings = calledInning;
    }

    let header = '';
    for (let i = 1; i <= numInnings; i++) {
        header += `<th class="col-inning-score">${i}</th>`;
    }

    const createRow = (teamKey, teamName) => {
        let cells = '';
        for (let i = 0; i < numInnings; i++) {
            const scoreValue = inningData[teamKey]?.[i] ?? ''; 
            cells += `<td class="col-inning-score"><input type="number" value="${scoreValue}"></td>`;
        }
        return `<tr>
                    <th class="col-team text-left font-semibold pl-2">${teamName}</th>
                    ${cells}
                    <td class="total-score col-total"></td>
                </tr>`;
    };

    return `
        <div class="mb-6 overflow-x-auto">
            <h4 class="font-bold mb-2">ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢</h4>
            <table class="details-table" id="inning-score-table">
                <thead>
                    <tr>
                        <th class="col-team">ãƒãƒ¼ãƒ </th>${header}<th class="col-total">è¨ˆ</th><th class="col-add-inning"><button id="add-inning-score-btn" class="text-xs font-bold">+</button></th>
                    </tr>
                </thead>
                <tbody>${createRow('team1', team1Name)}${createRow('team2', team2Name)}</tbody>
            </table>
        </div>`;
}


// â–¼â–¼â–¼ æ—¢å­˜ã®ã€ŒopenDetailsModalã€é–¢æ•° (10563è¡Œç›®ã‚ãŸã‚Š) ã‚’ã€ä»¥ä¸‹ã§ã€Œç½®ãæ›ãˆã€ â–¼â–¼â–¼

/**
 * æ–°ã—ã„è©¦åˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã€å„ç¨®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…åˆæˆ¦ã§ã‚‚ä½œæˆ¦ãƒœãƒ¼ãƒ‰ãŒé–‹ã‘ã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ãŸå®Œå…¨ç‰ˆ)
 */
function openDetailsModal(matchId) {
    currentMatchIdForDetails = matchId;
    const match = findMatchById(matchId);
    if (!match) {
        console.error(`[openDetailsModal] ã‚¨ãƒ©ãƒ¼: ID ${matchId} ã®è©¦åˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
        return;
    }

    // 1. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã€ã¾ãŸã¯åˆæœŸåŒ–
    let details = JSON.parse(JSON.stringify(match.details || {}));

    // --- å‰å›ã®ãƒ­ã‚¹ã‚¿ãƒ¼æƒ…å ±ã‚’å¼•ãç¶™ãå‡¦ç† ---
    if ((!details.batting || !details.batting.team1 || details.batting.team1.length === 0)) {
        // battingã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãªã„å ´åˆã¯åˆæœŸåŒ–
        details.batting = details.batting || { team1: [], team2: [] };

        for (const teamKey of ['team1', 'team2']) {
            const teamName = match[teamKey];
            const teamRecord = tournamentState.teamRecords[teamName];
            
            // ãƒ‘ã‚¿ãƒ¼ãƒ³A: ä¿å­˜ã•ã‚ŒãŸãƒ­ã‚¹ã‚¿ãƒ¼ãŒã‚ã‚‹å ´åˆ (2å›æˆ¦ä»¥é™)
            if (teamRecord && teamRecord.roster && teamRecord.roster.length > 0) {
                details.batting[teamKey] = teamRecord.roster
                    .filter(playerData => playerData.order && !playerData.order.toString().includes('sub'))
                    .map(playerData => ({
                        ...playerData, 
                        sub_type: null,
                        results: []     
                    }));
            }
            // ãƒ‘ã‚¿ãƒ¼ãƒ³B: éå»ã®ã‚¹ã‚¿ãƒ¡ãƒ³å±¥æ­´ãŒã‚ã‚‹å ´åˆ (æ—§ãƒ‡ãƒ¼ã‚¿äº’æ›æ€§)
            else if (teamRecord && teamRecord.previousStarters && teamRecord.previousStarters.length > 0) {
                 details.batting[teamKey] = teamRecord.previousStarters.map(playerData => ({
                    ...playerData,
                    results: [] 
                }));
            }
            // ãƒ‘ã‚¿ãƒ¼ãƒ³C: ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ (1å›æˆ¦ãƒ»åˆå›)
            else if (TEAM_ROSTER_MASTER[teamName]) {
                 const masterRoster = TEAM_ROSTER_MASTER[teamName];
                 details.batting[teamKey] = masterRoster.map((p, index) => {
                     const order = (index < 9) ? (index + 1).toString() : null;
                     const posShort = p.position ? p.position.charAt(0) : '';
                     return {
                         order: order,
                         name: p.name,
                         number: p.number,
                         pos: posShort,
                         throwBat: p.throwBat,
                         isCaptain: p.isCaptain || false, 
                         sub_type: null,
                         results: [] 
                     };
                 });
            }
        }
    }

    // ã‚¤ãƒ‹ãƒ³ã‚°æ•°ã®è¨ˆç®— (ã‚³ãƒ¼ãƒ«ãƒ‰åˆ¤å®šå«ã‚€)
    let numInnings = 9;
    const currentMaxLen = Math.max(
        details.inningScore?.team1?.length || 0,
        details.inningScore?.team2?.length || 0,
        details.batting?.team1?.[0]?.results?.length || 0
    );
    
    if (match.calledGame && match.calledInning) {
        numInnings = match.calledInning;
    } else {
        numInnings = Math.max(9, currentMaxLen);
    }

    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å®Œå…¨åˆæœŸåŒ–
    details.inningScore = details.inningScore || { team1: [], team2: [] };
    details.batting = details.batting || { team1: [], team2: [] };
    details.pitching = details.pitching || { team1: [], team2: [] };
    details.fielding = details.fielding || { team1: [], team2: [] };
    details.inningEvents = details.inningEvents || { team1: [], team2: [] };
    details.positionChanges = details.positionChanges || [];
    details.playerGameStats = details.playerGameStats || { team1: {}, team2: {} };

    // å®ˆå‚™äº¤ä»£å±¥æ­´ç”Ÿæˆã®ãŸã‚ã®ã‚½ãƒ¼ãƒˆ
    const sortedChanges = (details.positionChanges || []).sort((a, b) => {
        const inningA = parseInt(a.inning) || 0;
        const inningB = parseInt(b.inning) || 0;
        if (inningA !== inningB) return inningA - inningB;
        return (a.topBottom === 'è£' ? 1 : 0) - (b.topBottom === 'è£' ? 1 : 0);
    });

    // é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ã®è£œå®Œ (ã‚¤ãƒ‹ãƒ³ã‚°é…åˆ—ãªã©)
    for (const teamKey of ['team1', 'team2']) {
        // é…åˆ—ã®é•·ã•ã‚’æƒãˆã‚‹
        while (details.inningScore[teamKey].length < numInnings) details.inningScore[teamKey].push('');
        while (details.inningEvents[teamKey].length < numInnings) details.inningEvents[teamKey].push('');
        
        // æ‰“è€…ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆãªã©)
        const teamName = match[teamKey];
        const teamRecord = tournamentState.teamRecords[teamName];
        if (details.batting[teamKey].length === 0 && teamRecord && teamRecord.roster) {
            details.batting[teamKey] = teamRecord.roster.map(p => ({ ...p, results: Array(numInnings).fill('') }));
        }

        // å®ˆå‚™ä½ç½®å±¥æ­´ã®ä½œæˆ
        details.batting[teamKey].forEach(player => {
            if (!player.results) player.results = Array(numInnings).fill('');
            else while (player.results.length < numInnings) player.results.push('');

            if (!player.name) {
                player.posHistoryDisplay = ''; 
                player.currentPos = ''; 
                return;
            }
            let history = [];
            if (player.pos) {
                let initialTiming = "ã‚¹ã‚¿ãƒ¡ãƒ³";
                if (player.order && player.order.toString().includes('sub')) {
                    if (player.sub_type === 'PH') initialTiming = "ä»£æ‰“å‡ºå ´";
                    else if (player.sub_type === 'PR') initialTiming = "ä»£èµ°å‡ºå ´";
                    else initialTiming = "é€”ä¸­å‡ºå ´";
                }
                history.push({ pos: player.pos, timing: initialTiming });
            }
            sortedChanges.forEach(change => {
                if (change.teamKey === teamKey && change.playerName === player.name) {
                    let timingStr = `${change.inning || '?'}å›${change.topBottom || ''}`;
                    if (change.timing === 'mid') timingStr += ` ${change.outs || '0'}æ­»`;
                    else timingStr += ` 0æ­»`;
                    history.push({ pos: change.newPos, timing: timingStr });
                }
            });
            const uniqueHistory = history.filter((entry, index) => {
                return entry.pos && (index === 0 || entry.pos !== history[index - 1].pos);
            });
            if (uniqueHistory.length > 1) {
                player.posHistoryDisplay = uniqueHistory.map((entry, index) => {
                    if (index === 0) return entry.pos;
                    return `â†’ (${entry.timing}) ${entry.pos}`;
                }).join(' ');
                player.currentPos = uniqueHistory[uniqueHistory.length - 1].pos;
            } else {
                player.posHistoryDisplay = '';
                player.currentPos = player.pos || '';
            }
        });
    }
    
    const playersTeam1 = details.batting.team1.filter(p => p.name).map(p => ({name: p.name}));
    const playersTeam2 = details.batting.team2.filter(p => p.name).map(p => ({name: p.name}));

    // HTMLç”Ÿæˆ
    const detailsBody = document.getElementById('details-modal-body');
    detailsBody.innerHTML = `
        <div class="space-y-4">
            ${createInningScoreTable(match.team1, match.team2, details, match.calledGame, match.calledInning)}
            
            <div class="flex items-center justify-center space-x-4 bg-gray-100 p-2 rounded border border-gray-300">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="called-game-checkbox" class="form-checkbox h-5 w-5 text-blue-600" ${match.calledGame ? 'checked' : ''}>
                    <span class="ml-2 text-gray-700 font-bold">ã“ã®è©¦åˆã‚’ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ã¨ã—ã¦è¨˜éŒ²ã™ã‚‹</span>
                </label>
            </div>
            
            <div class="text-center py-2 border-t border-b flex justify-center gap-2 bg-gray-50">
                <button id="swap-teams-btn" data-match-id="${matchId}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-4 rounded text-sm">
                    â‡… å…ˆæ”»ãƒ»å¾Œæ”»å…¥æ›¿
                </button>
                <button id="auto-complete-innings-btn" data-match-id="${matchId}" class="bg-orange-100 hover:bg-orange-200 text-orange-800 font-bold py-1 px-4 rounded text-sm border border-orange-300">
                    â© æ®‹ã‚Šã‚¤ãƒ‹ãƒ³ã‚°è‡ªå‹•æ¶ˆåŒ–
                </button>
                <button id="auto-generate-summary-btn" data-match-id="${matchId}" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-bold py-1 px-4 rounded text-sm border border-indigo-300">
                    ğŸ¤– AIæˆ¦è©•ç”Ÿæˆ
                </button>
            </div>
            
            <div class="space-y-4">
                <h4 class="font-bold text-lg">${match.team1} æ‰“æ’ƒæˆç¸¾</h4>
                ${createPlayerBattingTable(match.team1, 'team1', details)}
                
                <h4 class="font-bold text-lg mt-4">${match.team2} æ‰“æ’ƒæˆç¸¾</h4>
                ${createPlayerBattingTable(match.team2, 'team2', details)}
            </div>
            
            <div class="space-y-4 mt-4">
                <h4 class="font-bold text-lg flex justify-between items-center">
                    <span>${match.team1} æŠ•æ‰‹æˆç¸¾</span>
                    <button class="calc-pitcher-stats-btn text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200 ml-2"
                            data-pitching-team="team1" data-batting-team="team2">
                        ${match.team2}ã®æ‰“æ’ƒã‹ã‚‰è‡ªå‹•è¨ˆç®—
                    </button>
                    <button class="copy-pitchers-from-batting-btn text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 ml-2" data-team-key="team1">
                        æ‰“é †ã‹ã‚‰ã‚³ãƒ”ãƒ¼
                    </button>
                </h4>
                <div class="overflow-x-auto border rounded-lg bg-white">${createPitchingStatsTable('team1', details)}</div>
                
                <h4 class="font-bold text-lg flex justify-between items-center mt-4">
                    <span>${match.team2} æŠ•æ‰‹æˆç¸¾</span>
                    <button class="calc-pitcher-stats-btn text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200 ml-2"
                            data-pitching-team="team2" data-batting-team="team1">
                        ${match.team1}ã®æ‰“æ’ƒã‹ã‚‰è‡ªå‹•è¨ˆç®—
                    </button>
                    <button class="copy-pitchers-from-batting-btn text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 ml-2" data-team-key="team2">
                        æ‰“é †ã‹ã‚‰ã‚³ãƒ”ãƒ¼
                    </button>
                </h4>
                <div class="overflow-x-auto border rounded-lg bg-white">${createPitchingStatsTable('team2', details)}</div>
            </div>

            <div class="space-y-4 mt-4">
                <h4 class="font-bold text-lg">${match.team1} å®ˆå‚™ãƒã‚¤ãƒ©ã‚¤ãƒˆ</h4>
                <div class="overflow-x-auto border rounded-lg bg-white">
                    ${createFieldingTable('team1', details, playersTeam1)}
                </div>
                 <h4 class="font-bold text-lg mt-4">${match.team2} å®ˆå‚™ãƒã‚¤ãƒ©ã‚¤ãƒˆ</h4>
                <div class="overflow-x-auto border rounded-lg bg-white">
                    ${createFieldingTable('team2', details, playersTeam2)}
                </div>
            </div>
        </div>
    `;

    // 283å­¦åœ’ç”¨ datalist (å¤‰æ›´ãªã—)
    const roster283 = TEAM_ROSTER_MASTER["283å­¦åœ’"];
    if (roster283) {
        const rosterOptionsHTML = roster283.map(p => `<option value="${p.name}"></option>`).join('');
        if (match.team1 === "283å­¦åœ’") {
            const datalistId = "roster-datalist-team1";
            const datalist = document.createElement('datalist');
            datalist.id = datalistId;
            datalist.innerHTML = rosterOptionsHTML;
            detailsBody.appendChild(datalist);
            document.querySelectorAll('#batting-table-team1 .player-name').forEach(input => input.setAttribute('list', datalistId));
        }
        if (match.team2 === "283å­¦åœ’") {
            const datalistId = "roster-datalist-team2";
            const datalist = document.createElement('datalist');
            datalist.id = datalistId;
            datalist.innerHTML = rosterOptionsHTML;
            detailsBody.appendChild(datalist);
            document.querySelectorAll('#batting-table-team2 .player-name').forEach(input => input.setAttribute('list', datalistId));
        }
    }

    // â–¼â–¼â–¼ ã€é‡è¦ä¿®æ­£ã€‘ã“ã“ã§ãƒ‡ãƒ¼ã‚¿ã‚’è©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒªãƒ³ã‚¯ã•ã›ã‚‹ â–¼â–¼â–¼
    // ã“ã‚Œã‚’è¡Œã‚ãªã„ã¨ã€ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¾ã§ã€Œä½œæˆ¦ãƒœãƒ¼ãƒ‰ã€ãªã©ã®æ©Ÿèƒ½ãŒãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œãªã„
    match.details = details; 
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    detailsModal.classList.remove('hidden');
    updateTotalScores();
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–² 

/**
 * æŠ•æ‰‹æˆç¸¾ã®ãƒ†ãƒ¼ãƒ–ãƒ«HTMLã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…å…¨ã‚¯ãƒ©ã‚¹åã‚’ä»˜ä¸ã—ãŸæœ€çµ‚ä¿®æ­£ç‰ˆâ˜…)
 * @param {string} teamKey - 'team1' ã¾ãŸã¯ 'team2'
 * @param {object} details - è©¦åˆã®è©³ç´°ãƒ‡ãƒ¼ã‚¿
 * @returns {string} - ç”Ÿæˆã•ã‚ŒãŸHTML
 */
function createPitchingStatsTable(teamKey, details) {
    const pitchingData = details.pitching[teamKey] || [];
    
    // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠè‚¢ã®å®šç¾© (å¤‰æ›´ãªã—)
    const throwStyleOptions = [
        { val: "over", label: "ã‚ªãƒ¼ãƒãƒ¼" }, { val: "three_quarter", label: "ã‚¹ãƒªãƒ¼ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼" },
        { val: "side", label: "ã‚µã‚¤ãƒ‰" }, { val: "under", label: "ã‚¢ãƒ³ãƒ€ãƒ¼" }
    ];
    const pitcherTypeOptions = [
        { val: "honkaku", label: "æœ¬æ ¼æ´¾" }, { val: "sokkyu", label: "é€Ÿçƒæ´¾" },
        { val: "giko", label: "æŠ€å·§æ´¾" }, { val: "nanto", label: "è»ŸæŠ•æ´¾" }
    ];
    const velocityOptions = [];
    for (let v = 120; v <= 165; v += 5) {
        velocityOptions.push({ val: `${v}km`, label: `${v}kmå¸¯` });
    }
    const throwBatOptions = [
        { val: "R/R", label: "å³/å³" }, { val: "R/L", label: "å³/å·¦" }, { val: "R/S", label: "å³/ä¸¡" },
        { val: "L/L", label: "å·¦/å·¦" }, { val: "L/R", label: "å·¦/å³" }, { val: "L/S", label: "å·¦/ä¸¡" }
    ];

    let bodyRows = pitchingData.map((player, index) => {
        const tbOptionsHtml = throwBatOptions.map(opt => `<option value="${opt.val}" ${player.throwBat === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('');
        const styleOptionsHtml = throwStyleOptions.map(opt => `<option value="${opt.val}" ${player.throwStyle === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('');
        const typeOptionsHtml = pitcherTypeOptions.map(opt => `<option value="${opt.val}" ${player.pitcherType === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('');
        const velocityOptionsHtml = velocityOptions.map(opt => `<option value="${opt.val}" ${player.velocity === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('');

        // â–¼â–¼â–¼ ã“ã®è¡Œå…¨ä½“ã‚’ä¿®æ­£ï¼ˆå…¨è¦ç´ ã«ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ï¼‰ â–¼â–¼â–¼
        return `
        <tr data-pitcher-index="${index}">
            <td class="col-pitcher-result">
                <select class="pitcher-result"> 
                    <option value="" ${!player.result ? 'selected' : ''}>-</option>
                    <option value="W" ${player.result === 'W' ? 'selected' : ''}>â—‹</option>
                    <option value="L" ${player.result === 'L' ? 'selected' : ''}>â—</option>
                    <option value="S" ${player.result === 'S' ? 'selected' : ''}>S</option>
                    <option value="H" ${player.result === 'H' ? 'selected' : ''}>H</option>
                </select>
            </td>
            <td class="col-pitcher-name"><input type="text" class="pitcher-name" value="${player.name || ''}"></td> 
            <td class="col-pitcher-throw-bat"><select class="pitcher-throw-bat w-full bg-transparent"><option value="">-æŠ•/æ‰“-</option>${tbOptionsHtml}</select></td>
            <td class="col-pitcher-style"><select class="pitcher-throw-style w-full bg-transparent"><option value="">-æŠ•ã’æ–¹-</option>${styleOptionsHtml}</select></td>
            <td class="col-pitcher-type"><select class="pitcher-type w-full bg-transparent"><option value="">-ã‚¿ã‚¤ãƒ—-</option>${typeOptionsHtml}</select></td>
            <td class="col-pitcher-velocity"><select class="pitcher-velocity w-full bg-transparent"><option value="">-çƒé€Ÿå¸¯-</option>${velocityOptionsHtml}</select></td>
            <td class="col-stat"><input type="text" class="pitcher-innings" value="${player.innings || ''}"></td> 
            <td class="col-stat"><input type="number" class="pitcher-batters" value="${player.battersFaced || ''}"></td> 
            <td class="col-stat"><input type="number" class="pitcher-pitches" value="${player.pitches || ''}"></td> 
            <td class="col-stat"><input type="number" class="pitcher-hits" value="${player.hits || ''}"></td> 
            <td class="col-stat"><input type="number" class="pitcher-so" value="${player.strikeouts || ''}"></td> 
            <td class="col-stat"><input type="number" class="pitcher-walks" value="${player.walks || ''}"></td> 
            <td class="col-stat"><input type="number" class="pitcher-runs" value="${player.runs || ''}"></td> 
            <td class="col-stat"><input type="number" class="pitcher-er" value="${player.earnedRuns || ''}"></td> 
        </tr>
        `;
        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    }).join('');

    // ã‚‚ã—æŠ•æ‰‹ãŒä¸€äººã‚‚ã„ãªã‘ã‚Œã°ã€ç©ºã®è¡Œã‚’1ã¤è¿½åŠ ã—ã¦ãŠã
    if (pitchingData.length === 0) {
        const tbOptionsHtml = throwBatOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        const styleOptionsHtml = throwStyleOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        const typeOptionsHtml = pitcherTypeOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        const velocityOptionsHtml = velocityOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        // â–¼â–¼â–¼ ç©ºè¡Œã«ã‚‚å…¨ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ  â–¼â–¼â–¼
        bodyRows = `
            <tr data-pitcher-index="0">
                <td class="col-pitcher-result"><select class="pitcher-result"><option value="" selected>-</option><option value="W">â—‹</option><option value="L">â—</option><option value="S">S</option><option value="H">H</option></select></td>
                <td class="col-pitcher-name"><input type="text" class="pitcher-name" value=""></td>
                <td class="col-pitcher-throw-bat"><select class="pitcher-throw-bat w-full bg-transparent"><option value="">-æŠ•/æ‰“-</option>${tbOptionsHtml}</select></td>
                <td class="col-pitcher-style"><select class="pitcher-throw-style w-full bg-transparent"><option value="">-æŠ•ã’æ–¹-</option>${styleOptionsHtml}</select></td>
                <td class="col-pitcher-type"><select class="pitcher-type w-full bg-transparent"><option value="">-ã‚¿ã‚¤ãƒ—-</option>${typeOptionsHtml}</select></td>
                <td class="col-pitcher-velocity"><select class="pitcher-velocity w-full bg-transparent"><option value="">-çƒé€Ÿå¸¯-</option>${velocityOptionsHtml}</select></td>
                <td class="col-stat"><input type="text" class="pitcher-innings" value=""></td>
                <td class="col-stat"><input type="number" class="pitcher-batters" value=""></td>
                <td class="col-stat"><input type="number" class="pitcher-pitches" value=""></td>
                <td class="col-stat"><input type="number" class="pitcher-hits" value=""></td>
                <td class="col-stat"><input type="number" class="pitcher-so" value=""></td>
                <td class="col-stat"><input type="number" class="pitcher-walks" value=""></td>
                <td class="col-stat"><input type="number" class="pitcher-runs" value=""></td>
                <td class="col-stat"><input type="number" class="pitcher-er" value=""></td>
            </tr>
        `;
        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    }

    return `
        <div class="overflow-x-auto">
            <table class="details-table" id="pitching-table-${teamKey}">
                <thead>
                    <tr>
                        <th class="col-pitcher-result">å‹æ•—</th>
                        <th class="col-pitcher-name">é¸æ‰‹å</th>
                        <th class="col-pitcher-throw-bat">æŠ•/æ‰“</th>
                        <th class="col-pitcher-style">æŠ•ã’æ–¹</th>
                        <th class="col-pitcher-type">ã‚¿ã‚¤ãƒ—</th>
                        <th class="col-pitcher-velocity">çƒé€Ÿå¸¯</th>
                        <th class="col-stat">å›æ•°</th>
                        <th class="col-stat">æ‰“è€…</th><th class="col-stat">çƒæ•°</th><th class="col-stat">è¢«å®‰æ‰“</th>
                        <th class="col-stat">å¥ªä¸‰æŒ¯</th><th class="col-stat">ä¸å››çƒ</th><th class="col-stat">å¤±ç‚¹</th>
                        <th class="col-stat">è‡ªè²¬ç‚¹</th>
                    </tr>
                </thead>
                <tbody>${bodyRows}</tbody>
            </table>
            <button class="add-row-btn text-xs mt-2" data-table-id="pitching-table-${teamKey}">+ æŠ•æ‰‹ã‚’è¿½åŠ </button>
        </div>
    `;
}

function createFieldingTable(teamKey, details, playersOnField) {
    const fieldingData = details.fielding?.[teamKey] || [];
    
    // é¸æ‰‹åã‚’é¸æŠã™ã‚‹ãŸã‚ã® <option> ã‚¿ã‚°ã‚’ç”Ÿæˆ
    const playerOptions = playersOnField.map(p => `<option value="${p.name}">${p.name}</option>`).join('');

    let bodyRows = fieldingData.map((play, index) => `
        <tr data-fielding-index="${index}">
            <td class="w-16"><input type="number" class="fielding-inning" value="${play.inning || ''}" min="1"></td>
            <td>
                <select class="player-name w-full">
                    <option value="">- é¸æ‰‹ -</option>
                    ${playersOnField.map(p => `<option value="${p.name}" ${p.name === play.player ? 'selected' : ''}>${p.name}</option>`).join('')}
                </select>
            </td>
            <td><input type="text" class="fielding-play" value="${play.play || ''}" placeholder="ä¾‹: ãƒ€ã‚¤ãƒ“ãƒ³ã‚°ã‚­ãƒ£ãƒƒãƒã€ãƒ¬ãƒ¼ã‚¶ãƒ¼ãƒ“ãƒ¼ãƒ ã§è£œæ®º"></td>
            <td class="w-12 text-center">
                <button class="remove-fielding-play-btn text-red-500 hover:text-red-700 font-bold text-lg leading-none p-1">Ã—</button>
            </td>
        </tr>
    `).join('');
    
    return `
        <div class="overflow-x-auto">
            <table class="details-table" id="fielding-table-${teamKey}">
                <thead>
                    <tr>
                        <th class="w-16">ã‚¤ãƒ‹ãƒ³ã‚°</th>
                        <th>é¸æ‰‹å</th>
                        <th>ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã®å†…å®¹</th>
                        <th class="w-12">å‰Šé™¤</th>
                    </tr>
                </thead>
                <tbody>${bodyRows}</tbody>
            </table>
            <button class="add-fielding-play-btn text-xs mt-2" data-team-key="${teamKey}">+ ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚’è¿½åŠ </button>
        </div>
    `;
}

// â–¼â–¼â–¼ æ•´ç†æ¸ˆã¿ï¼šè²¢çŒ®åº¦ãƒ»æ‰“é †åˆ†ææ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç† (æœ€çµ‚ç‰ˆ) â–¼â–¼â–¼

// --- 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®å†å–å¾— ---
const contribInput = document.getElementById('contribution-team-input');
const contribList = document.getElementById('contribution-suggestions');
// â€» activeAnalysisMode ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§å®šç¾©æ¸ˆã¿ã¨ã—ã¾ã™


// --- 2. æ±ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (å¤‰æ›´ãªã—) ---

/**
 * è²¢çŒ®åº¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã®åˆæœŸåŒ–å‡¦ç†
 */
function initContributionModal() {
    // ç”»é¢ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('contribution-content').classList.add('hidden');
    
    // å…¥åŠ›æ¬„ã¨ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
    contribInput.value = '';
    contribList.classList.add('hidden');
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    document.getElementById('contribution-modal').classList.remove('hidden');
    document.getElementById('contribution-modal').classList.add('flex');
}

/**
 * æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ (ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–)
 */
function highlightMatch(text, query) {
    // å˜ç´”ãªç½®æ›ã ã¨HTMLãŒå£Šã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å‡¦ç†
    if (!query) return text;
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<span class="suggestion-match">$1</span>');
}


// --- 3. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å®šç¾© ---

// A. ã€ãƒœã‚¿ãƒ³ã€‘è²¢çŒ®åº¦ãƒ»å¤©ä½“è¦³æ¸¬ (ãƒ•ãƒ©ã‚°è¨­å®š)
document.getElementById('show-contribution-btn').addEventListener('click', () => {
    initContributionModal();
    activeAnalysisMode = 'CONTRIBUTION'; 
    document.getElementById('contribution-modal').querySelector('h3').textContent = "ğŸŒŒ ãƒãƒ¼ãƒ è²¢çŒ®åº¦ã‚·ã‚§ã‚¢ & å¤©ä½“è¦³æ¸¬";
    contribInput.placeholder = "åˆ†æã™ã‚‹ãƒãƒ¼ãƒ åã‚’å…¥åŠ›...";
});

// B. ã€ãƒœã‚¿ãƒ³ã€‘é©æ­£æ‰“é †åˆ†æ (ãƒ•ãƒ©ã‚°è¨­å®š)
document.getElementById('show-lineup-analysis-btn').addEventListener('click', () => {
    initContributionModal();
    activeAnalysisMode = 'LINEUP_ANALYSIS'; 
    document.getElementById('contribution-modal').querySelector('h3').textContent = "âš¾ é©æ­£æ‰“é †ãƒ»å½¹å‰²åˆ†æ";
    contribInput.placeholder = "åˆ†æã—ãŸã„ãƒãƒ¼ãƒ åã‚’å…¥åŠ›...";
});

// C. ã€å…¥åŠ›æ™‚ã€‘ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ (å…±é€šãƒ­ã‚¸ãƒƒã‚¯)
contribInput.addEventListener('input', () => {
    const query = contribInput.value.trim().toLowerCase();
    
    if (!query) {
        contribList.classList.add('hidden');
        return;
    }

    // æˆç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ãƒãƒ¼ãƒ ã®ã¿ã‚’æ¤œç´¢å¯¾è±¡ã«ã™ã‚‹
    const validTeams = Object.keys(tournamentState.teamRecords).filter(t => {
        const r = tournamentState.teamRecords[t];
        return r.wins > 0 || r.losses > 0; // 1è©¦åˆä»¥ä¸Šã—ãŸãƒãƒ¼ãƒ 
    });

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const matches = validTeams.filter(teamName => {
        const data = TEAM_DATA[teamName] || {};
        return (
            teamName.includes(query) || 
            (data.name_yomi && data.name_yomi.includes(query)) ||
            (data.region && data.region.includes(query))
        );
    }).slice(0, 10);

    renderContribSuggestions(matches, query);
});

// D. ã€ã‚¯ãƒªãƒƒã‚¯/Enterã€‘å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ (ãƒ•ãƒ©ã‚°ã«å¾“ã£ã¦å®Ÿè¡Œ)
function executeAnalysis(teamName) {
    if (activeAnalysisMode === 'LINEUP_ANALYSIS') {
        const optimalLineup = generateOptimalLineup(teamName);
        if (optimalLineup) {
            renderOptimalLineupModal(teamName, optimalLineup);
        } else {
            alert(`ã€Œ${teamName}ã€ã¯ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã®ãŸã‚ã€æ‰“é †ã‚’çµ„ã‚ã¾ã›ã‚“ã€‚æœ€ä½5æ‰“å¸­ä»¥ä¸Šã®é¸æ‰‹ãŒ9äººå¿…è¦ã§ã™ã€‚`);
        }
    } else {
        // CONTRIBUTION ãƒ¢ãƒ¼ãƒ‰
        renderContributionAnalysis(teamName);
    }
    document.getElementById('contribution-content').classList.remove('hidden');
}

// E. ã€å€™è£œãƒªã‚¹ãƒˆã€‘ã®æç”» (ã‚¯ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å«ã‚€)
function renderContribSuggestions(teams, query) {
    contribList.innerHTML = '';
    if (teams.length === 0) {
        contribList.classList.add('hidden');
        return;
    }

    teams.forEach(teamName => {
        const data = TEAM_DATA[teamName] || {};
        const region = data.region || 'ä¸æ˜';
        
        const li = document.createElement('li');
        li.className = 'suggestion-item';
        li.innerHTML = `
            <div>
                <span class="text-gray-800 font-medium">${highlightMatch(teamName, query)}</span>
                <span class="text-xs text-gray-500 ml-2">(${region})</span>
            </div>
        `;

        // â˜…â˜…â˜… ã€é‡è¦ä¿®æ­£ã€‘ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‹•ä½œã‚’ executeAnalysis ã«ä¸€æœ¬åŒ– â˜…â˜…â˜…
        li.addEventListener('click', () => {
            contribInput.value = teamName;
            contribList.classList.add('hidden');
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ãƒ©ã‚°ã‚’å‚ç…§ã—ã¦ã€é©åˆ‡ãªåˆ†æã‚’å®Ÿè¡Œ
            executeAnalysis(teamName); 
        });

        contribList.appendChild(li);
    });

    contribList.classList.remove('hidden');
}

// F. ã€Enterã‚­ãƒ¼ã€‘å®Ÿè¡Œãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ  (ã‚·ãƒ³ãƒ—ãƒ«ãªå‡¦ç†ã«æˆ»ã™)
contribInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        const teamName = contribInput.value.trim();
        // å€™è£œãƒªã‚¹ãƒˆã‚’éš ã—ã€ãã®ã¾ã¾å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™
        contribList.classList.add('hidden');
        if (teamName) {
            executeAnalysis(teamName);
        }
    }
});


// G. ã€å¤–å´ã‚¯ãƒªãƒƒã‚¯ã€‘ã§ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹ (å¤‰æ›´ãªã—)
document.addEventListener('click', (e) => {
    if (!contribInput.contains(e.target) && !contribList.contains(e.target)) {
        contribList.classList.add('hidden');
    }
});

// â–²â–²â–² æ•´ç†æ¸ˆã¿ã‚³ãƒ¼ãƒ‰ã“ã“ã¾ã§ â–²â–²â–²
/**
 * RCè²¢çŒ®åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ£’ã‚°ãƒ©ãƒ•ã§æç”»ã™ã‚‹ (Chart.js)
 * â˜… RC/G (è©¦åˆã‚ãŸã‚Šè²¢çŒ®åº¦) ã«å¤‰æ›´
 */
function renderRcBarChart(ctx, players) {
    const existingChart = Chart.getChart(ctx);
    if (existingChart) existingChart.destroy();

    // 1. RC/Gã®å€¤ã‚’è¨ˆç®—ã—ã¦æ ¼ç´
    const playersWithRCG = players.map(p => {
        // gamesãŒæœªå®šç¾©ã®å ´åˆãŒã‚ã‚‹ãŸã‚ã€0ã‚’ä»£å…¥
        const games = p.games || 0; 
        return {
            ...p,
            // RC/Gã‚’è¨ˆç®—: RCåˆè¨ˆ / è©¦åˆæ•° (games)
            rcg: games > 0 ? p.rc / games : 0
        };
    }).filter(p => p.rcg > 0); // RC/GãŒ0ã‚ˆã‚Šå¤§ãã„é¸æ‰‹ã®ã¿è¡¨ç¤º

    // ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°æç”»ã—ãªã„
    if (playersWithRCG.length === 0) {
        // Canvasã‚’ç©ºã«ã™ã‚‹å‡¦ç†ï¼ˆä»Šå›ã¯Canvasè‡ªä½“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ›¸ã‹ãªã„ï¼‰
        return; 
    }

    // 2. RC/GãŒé«˜ã„é †ã«ã‚½ãƒ¼ãƒˆï¼ˆãƒˆãƒƒãƒ—10ã«åˆ¶é™ï¼‰
    const sortedPlayers = playersWithRCG.sort((a, b) => b.rcg - a.rcg).slice(0, 10);

    const labels = sortedPlayers.map(p => p.name);
    const data = sortedPlayers.map(p => p.rcg);
    const colors = sortedPlayers.map(p => p.color);

    // 3. Chart.jsã«ã‚ˆã‚‹æç”»
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Runs Created per Game (RC/G)',
                data: data,
                backgroundColor: colors,
                // æ ç·šã‚’å°‘ã—æ¿ƒã (colorsé…åˆ—ãŒç©ºã§ãªã„ã“ã¨ã‚’å‰æ)
                borderColor: colors.map(c => c.replace('0.8', '1')), 
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y', // æ¨ªæ£’ã‚°ãƒ©ãƒ•
            scales: {
                x: {
                    title: { display: true, text: 'Runs Created per Game (RC/G)' }, 
                    beginAtZero: true
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            // å°æ•°ç‚¹ç¬¬2ä½ã¾ã§è¡¨ç¤º
                            return `${context.label}: ${context.raw.toFixed(2)}ç‚¹/è©¦åˆ`;
                        }
                    }
                }
            }
        }
    });
}

/**
 * [NEW] ãƒãƒ¼ãƒ ã®å¯¾æˆ¦ç›¸æ‰‹ãƒ©ãƒ³ã‚¯ã‚’è€ƒæ…®ã—ãŸè£œæ­£æ¸ˆã¿ RC/G (ARC/G) ã‚’è¨ˆç®—ã™ã‚‹
 */
function calculateAdjustedRCG(teamName, teamAvgRCG) {
    if (teamAvgRCG === 0) return 0;
    
    const record = tournamentState.teamRecords[teamName];
    if (!record || !record.playerStats) return teamAvgRCG;

    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
    let totalOpponentRankScore = 0;
    let totalGames = 0;

    // å…¨ã¦ã®æ‰“è€…ã®Gamelogã‚’èµ°æŸ»ã—ã€è©¦åˆã”ã¨ã®å¯¾æˆ¦ç›¸æ‰‹ãƒ©ãƒ³ã‚¯ã‚’åé›†
    const processedMatchIds = new Set();
    
    // ãƒãƒ¼ãƒ å…¨å“¡ã®æ‰“æ’ƒGamelogsã‚’çµ±åˆã—ã¦å‡¦ç†
    for (const playerName in record.playerStats.batting) {
        const stats = record.playerStats.batting[playerName];
        if (stats.gamelogs) {
            stats.gamelogs.forEach(log => {
                // è©¦åˆIDãŒæœªå‡¦ç†ã€ã‹ã¤ç›¸æ‰‹ãƒ©ãƒ³ã‚¯æƒ…å ±ãŒã‚ã‚‹è©¦åˆã®ã¿
                if (!processedMatchIds.has(log.matchId) && log.opponentRank) {
                    totalOpponentRankScore += rankValues[log.opponentRank] || 3; // ãƒ©ãƒ³ã‚¯å€¤ã‚’åŠ ç®—
                    totalGames++;
                    processedMatchIds.add(log.matchId);
                }
            });
        }
    }
    
    if (totalGames === 0) return teamAvgRCG;

    // è£œæ­£ä¿‚æ•°ã®è¨ˆç®—
    const averageOpponentRankValue = totalOpponentRankScore / totalGames;
    const neutralRank = 3.0; // Cãƒ©ãƒ³ã‚¯ã‚’ä¸­ç«‹ç‚¹ã¨ã™ã‚‹
    
    // è£œæ­£ä¿‚æ•°: å¹³å‡ãƒ©ãƒ³ã‚¯ãŒä¸­ç«‹ç‚¹ã‚ˆã‚Šé«˜ã‘ã‚Œã°ãƒ–ãƒ¼ã‚¹ãƒˆã€ä½ã‘ã‚Œã°æ¸›è¡°
    const adjustmentFactor = averageOpponentRankValue / neutralRank;
    
    // ARC/G = RC/G * è£œæ­£ä¿‚æ•°
    const arcg = teamAvgRCG * adjustmentFactor;

    return arcg;
}

// â–¼â–¼â–¼ renderContributionAnalysis é–¢æ•°å…¨ä½“ï¼ˆARC/G æŒ¿å…¥ãƒ­ã‚¸ãƒƒã‚¯åˆ†é›¢ç‰ˆï¼‰â–¼â–¼â–¼
/**
 * é¸æŠã•ã‚ŒãŸãƒãƒ¼ãƒ ã®åˆ†æã‚’æç”»
 */
function renderContributionAnalysis(teamName) {
    const record = tournamentState.teamRecords[teamName];
    if (!record || !record.playerStats || !record.playerStats.batting) return;

    // --- 0. Canvasè¦ç´ ã®å¾©å…ƒã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å®šç¾© ---
    const contentArea = document.getElementById('contribution-content'); 
    if (!contentArea) return;

    // Canvasè¦ç´ ãŒãªã„å ´åˆã«å†ä½œæˆã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ±åˆ (æ‰“é †åˆ†æã‹ã‚‰æˆ»ã£ãŸå ´åˆ)
    if (!document.getElementById('rc-pie-chart')) {
        // â˜…â˜…â˜… HTMLå†æ§‹ç¯‰å‡¦ç† â˜…â˜…â˜…
        contentArea.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-gray-400">
                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <span class="text-xl mr-2">ğŸ’¡</span> æŒ‡æ¨™ã®ç›®å®‰ã¨è©•ä¾¡åŸºæº–
                </h4>
                <div id="rc-guidelines" class="space-y-3"></div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-purple-500">
                <h4 class="text-lg font-bold text-gray-800 mb-4">ğŸ“Š å¾—ç‚¹å‰µå‡ºã‚·ã‚§ã‚¢ (Runs Created Share)</h4>
                <div class="flex flex-col md:flex-row items-center gap-8">
                    <div class="w-full md:w-1/2 h-64">
                        <canvas id="rc-pie-chart"></canvas>
                    </div>
                    <div class="w-full md:w-1/2">
                        <p class="text-sm text-gray-600 mb-2">
                            â€» <strong>RC (Runs Created)</strong>: ãã®é¸æ‰‹ãŒã€Œä¸€äººã§ä½•ç‚¹ç”Ÿã¿å‡ºã—ãŸã‹ã€ã‚’æ¨å®šã™ã‚‹æŒ‡æ¨™ã€‚
                        </p>
                        <div id="rc-analysis-text" class="text-md font-bold text-purple-800 p-3 bg-purple-50 rounded"></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-yellow-500">
                    <h4 class="text-lg font-bold text-gray-800 mb-4">æ£’ã‚°ãƒ©ãƒ•ï¼šRC/Gï¼ˆè©¦åˆã‚ãŸã‚Šè²¢çŒ®åº¦ï¼‰ãƒ©ãƒ³ã‚­ãƒ³ã‚° (Top 10)</h4>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="rc-bar-chart"></canvas>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-indigo-500">
                    <h4 class="text-lg font-bold text-gray-800 mb-4">âš¾ æ‰“è€…ã‚¿ã‚¤ãƒ—ãƒ»ãƒãƒƒãƒ— (OPSåˆ†æ)</h4>
                    <div style="height: 400px; width: 100%;">
                        <canvas id="stellar-scatter-chart"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-center">
                        <div class="p-2 bg-red-50 border border-red-200 rounded"><span class="text-lg">ğŸ’£ çˆ†ç™ºå‹</span><br>é•·æ‰“åŠ›ç‰¹åŒ– (OPSé«˜)</div>
                        <div class="p-2 bg-blue-50 border border-blue-200 rounded"><span class="text-lg">ğŸ¯ ç†æƒ³å‹</span><br>æ‰“ç‡ã¨OPSã®ãƒãƒ©ãƒ³ã‚¹å‹</div>
                        <div class="p-2 bg-orange-50 border border-orange-200 rounded"><span class="text-lg">ğŸ¹ è·äººå‹</span><br>é«˜æ‰“ç‡ãƒ»ç¢ºå®Ÿæ€§å‹ (AVGé«˜)</div>
                        <div class="p-2 bg-gray-100 border border-gray-300 rounded"><span class="text-lg">ğŸ“ˆ æˆé•·æ ª</span><br>è¦å®šæ‰“å¸­æœªåˆ°é”/è‚²æˆæ </div>
                    </div>
                </div>
            `;
        // ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã‚’å†è¡¨ç¤º
        const graphAreas = contentArea.querySelectorAll('.bg-white.p-6.rounded-lg.shadow-md');
        graphAreas.forEach(el => el.classList.remove('hidden'));

        // æ‰“é †è¡¨ã‚’éè¡¨ç¤ºã«ã™ã‚‹ï¼ˆæ‰“é †åˆ†æã‹ã‚‰æˆ»ã£ã¦ããŸå ´åˆï¼‰
        const lineupTable = document.getElementById('optimal-lineup-table');
        if (lineupTable) {
            lineupTable.remove(); // å®Œå…¨ã«DOMã‹ã‚‰å‰Šé™¤
            contentArea.querySelector('.archive-header')?.remove(); 
        }
    } else {
         // ã‚°ãƒ©ãƒ•è¦ç´ ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã¯ã€å˜ã«éè¡¨ç¤ºã‚¯ãƒ©ã‚¹ã‚’è§£é™¤ã™ã‚‹
        const graphAreas = contentArea.querySelectorAll('.bg-white.p-6.rounded-lg.shadow-md');
        graphAreas.forEach(el => el.classList.remove('hidden'));
    }

    const players = [];
    let teamTotalRC = 0;

    // 1. ãƒ‡ãƒ¼ã‚¿è¨ˆç®—
    // ... (ãƒ‡ãƒ¼ã‚¿è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ...
    Object.entries(record.playerStats.batting).forEach(([name, s]) => {
        if ((s.pa || 0) > 0) { 
            const h = s.h || 0;
            const bb = (s.bb || 0) + (s.hbp || 0);
            const ab = s.ab || 0;
            const hr = s.hr || 0;
            const tb = (s.tb || h) + (hr * 3); 

            const ob = h + bb; 
            const times = ab + bb; 
            
            let rc = times > 0 ? ((ob * tb) / times) : 0;
            rc = parseFloat(rc.toFixed(2));
            
            if (isNaN(rc)) { rc = 0; }
            
            const ops = parseFloat(calculateOps(s));
            const avg = ab > 0 ? h / ab : 0;
            
            // å¤©ä½“åˆ†é¡
            let stellarType = 'åŸå§‹æ˜Ÿ'; 
            let color = '#94a3b8'; 

            if (ops >= 1.200 || hr >= 3) {
                stellarType = 'è¶…æ–°æ˜Ÿ'; 
                color = '#ef4444'; 
            } else if (ops >= 0.850) {
                stellarType = 'ä¸»ç³»åˆ—æ˜Ÿ'; 
                color = '#facc15'; 
            } else if (s.games >= 3 && ops >= 0.700) {
                stellarType = 'èµ¤è‰²å·¨æ˜Ÿ'; 
                color = '#f97316'; 
            }

            players.push({ name, rc, ops, avg: avg, hr: hr, type: stellarType, color, games: s.games });
            teamTotalRC += rc;
        }
    });

    // --- 1.5. ã€æ–°è¦ã€‘ARC/Gã®è¨ˆç®— ---
    const totalGamesPlayed = players.reduce((max, p) => Math.max(max, p.games || 0), 0) || 1;
    const teamAvgRCG = teamTotalRC / totalGamesPlayed;
    const teamArcg = calculateAdjustedRCG(teamName, teamAvgRCG);

    // â˜…â˜…â˜… ã€ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆã€‘ARC/Gè¡¨ç¤ºã‚’ contentAreaã®ç›´ä¸‹ã«æŒ¿å…¥ â˜…â˜…â˜…
    const isPowerful = teamArcg >= 7.0;
    
    // ARC/Gã®HTMLã‚’ç”Ÿæˆ
    const arcgHtml = `
        <div id="arcg-score-box" class="mt-4 p-3 rounded-lg ${isPowerful ? 'bg-red-50 border-red-200' : 'bg-blue-50 border-blue-200'}">
            <p class="font-bold text-sm text-gray-800">ğŸ¯ ãƒãƒ¼ãƒ å¹³å‡ ARC/G <span class="text-gray-500">(å¯¾æˆ¦ç›¸æ‰‹è£œæ­£æ¸ˆ)</span></p>
            <p class="text-xl font-extrabold ${isPowerful ? 'text-red-600' : 'text-blue-600'}">${teamArcg.toFixed(2)}</p>
            <p class="text-xs text-gray-600">â€»è©¦åˆã‚ãŸã‚Šç´„ ${teamArcg.toFixed(1)} ç‚¹ã®è²¢çŒ®ãƒšãƒ¼ã‚¹ (è£œæ­£å‰RC/G: ${teamAvgRCG.toFixed(2)})</p>
        </div>
    `;

    // æ—¢å­˜ã® ARC/G ãƒœãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
    const oldArcgBox = document.getElementById('arcg-score-box');
    if (oldArcgBox) oldArcgBox.remove();
    
    // contentAreaã®ç›´ä¸‹ï¼ˆä¸€ç•ªæœ€åˆã®è¦ç´ ã®å‰ï¼‰ã«æŒ¿å…¥
    contentArea.insertAdjacentHTML('afterbegin', arcgHtml);
    // â˜…â˜…â˜… ä¿®æ­£å®Œäº† â˜…â˜…â˜…


    // 2. å††ã‚°ãƒ©ãƒ• (RCã‚·ã‚§ã‚¢) æç”»
    players.sort((a, b) => b.rc - a.rc); // RCé«˜ã„é †
    const topPlayers = players.slice(0, 6); // ä¸Šä½6å
    const othersRC = players.slice(6).reduce((sum, p) => sum + p.rc, 0);
    
    const pieLabels = topPlayers.map(p => p.name);
    const pieData = topPlayers.map(p => p.rc);
    const pieColors = topPlayers.map(p => p.color);
    
    if (othersRC > 0) {
        pieLabels.push("ãã®ä»–");
        pieData.push(othersRC);
        pieColors.push("#cbd5e1");
    }

    // ãƒ†ã‚­ã‚¹ãƒˆåˆ†æ
    const analysisEl = document.getElementById('rc-analysis-text');
    // ... (æ—¢å­˜ã®ãƒ†ã‚­ã‚¹ãƒˆåˆ†æãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ...
    if (players.length > 0 && teamTotalRC > 0 && analysisEl) {
        const topShare = (players[0].rc / teamTotalRC) * 100;
        
        let analysisText = ""; 
        if (topShare >= 50) {
            analysisText = `ğŸš¨ **ç‹¬è£å‹ï¼ˆè¶…ä¾å­˜ãƒªã‚¹ã‚¯ï¼‰**ï¼šãƒˆãƒƒãƒ—é¸æ‰‹ã®è²¢çŒ®åº¦ãŒ${topShare.toFixed(1)}%ã¨æ¥µç«¯ã«é«˜ãã€æ©Ÿèƒ½åœæ­¢ã®ãƒªã‚¹ã‚¯ãŒæœ€å¤§ã§ã™ã€‚å½¼ãŒæŠ‘ãˆã‚‰ã‚Œã‚‹ã¨ãƒãƒ¼ãƒ ã¯å´©å£Šã—ã¾ã™ã€‚`;
        } else if (topShare >= 35) {
            analysisText = `âš ï¸ **ãƒ¯ãƒ³ãƒãƒ³å‹ï¼ˆé«˜ãƒªã‚¹ã‚¯ï¼‰**ï¼šä¾å­˜åº¦ãŒé«˜ãã€ç‰¹å®šã®ä¸»è»¸ï¼ˆä¾‹ï¼š4ç•ªï¼‰ãŒæŠ‘ãˆã‚‰ã‚Œã‚‹ã¨ã€ãƒãƒ¼ãƒ å…¨ä½“ã®ç”Ÿç”£åŠ›ãŒæ€¥è½ã™ã‚‹é«˜ãƒªã‚¹ã‚¯ãªæ§‹é€ ã§ã™ã€‚`;
        } else if (topShare >= 25) {
            analysisText = `âš–ï¸ **ä¸»è»¸é›†ä¸­å‹ï¼ˆæ¨™æº–ï¼‰**ï¼šä¸Šä½æ‰“ç·šã«ç”Ÿç”£åŠ›ãŒé›†ä¸­ã—ã¦ãŠã‚Šã€å¥å…¨ãªä¸»è»¸æ§‹é€ ã‚’ä¿ã£ã¦ã„ã¾ã™ã€‚æ‰“ç·šã®ãƒãƒ©ãƒ³ã‚¹ã¯è‰¯å¥½ã§ã™ã€‚`;
        } else if (topShare >= 15) {
            analysisText = `âœ¨ **åˆ†æ•£å‹ï¼ˆç†æƒ³ï¼‰**ï¼šè²¢çŒ®åº¦ãŒãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼å…¨ä½“ã«åºƒãåˆ†æ•£ã—ã¦ãŠã‚Šã€åˆ‡ã‚Œç›®ã®ãªã„æ‰“ç·šã¨ã—ã¦æ©Ÿèƒ½ã—ã¦ã„ã¾ã™ã€‚èª°ã‹ã‚‰ã§ã‚‚å¾—ç‚¹ãŒç”Ÿã¾ã‚Œã¾ã™ã€‚`;
        } else {
            analysisText = `ğŸ“‰ **è¶…å‡ç­‰å‹ï¼ˆä½ç«åŠ›ãƒªã‚¹ã‚¯ï¼‰**ï¼šå…¨å“¡ã®è²¢çŒ®åº¦ãŒéå¸¸ã«å‡ç­‰ã§ã™ã€‚å®‰å®šæ€§ã¯é«˜ã„åé¢ã€è©¦åˆã‚’æ±ºã‚ã‚‹ä¸€æ‰“ã‚„çµ¶å¯¾çš„ãªç ´å£ŠåŠ›ãŒä¸è¶³ã™ã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚`;
        }
        
        analysisEl.innerHTML = analysisText; 
    } else if (analysisEl) {
        analysisEl.textContent = "ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã®ãŸã‚åˆ†æã§ãã¾ã›ã‚“ã€‚";
    }

    // Chart.jsã§å††ã‚°ãƒ©ãƒ•æç”»
    const pieCanvas = document.getElementById('rc-pie-chart');
    if (pieCanvas) {
        const pieCtx = pieCanvas.getContext('2d');
        const existingPie = Chart.getChart(pieCtx);
        if (existingPie) existingPie.destroy();
        
        new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieData,
                    backgroundColor: pieColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'right' 
                    },
                    title: { 
                        display: true, 
                        text: 'å¾—ç‚¹å‰µå‡ºã‚·ã‚§ã‚¢ (Runs Created Score)' 
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const label = context.label || '';
                                const rcValue = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = (rcValue / total * 100).toFixed(1);
                                
                                return `${label}: ${rcValue.toFixed(2)}ç‚¹åˆ†ã®è²¢çŒ® (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // 3. æ•£å¸ƒå›³ (æ‰“è€…ã‚¿ã‚¤ãƒ—ãƒ»ãƒãƒƒãƒ—) æç”»
    const scatterCanvas = document.getElementById('stellar-scatter-chart');
    if (scatterCanvas) {
        // æç”»å‰ã«ã€ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ãªã„ã‹ã€ã¾ãŸã¯å…¨ã¦ãŒç„¡åŠ¹ã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        if (players.length === 0) {
            if (Chart.getChart(scatterCanvas)) Chart.getChart(scatterCanvas).destroy();
            return; // ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°æç”»ã—ãªã„
        }
        
        const scatterCtx = scatterCanvas.getContext('2d');
        const existingScatter = Chart.getChart(scatterCtx);
        if (existingScatter) existingScatter.destroy();

        // --- å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿æ•´å½¢ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
        const getSafeValue = (value, fallback = 0) => {
            const v = parseFloat(value);
            if (isNaN(v) || !isFinite(v)) return fallback;
            return v;
        };

        // ã‚°ãƒ©ãƒ•ã®å‡¡ä¾‹ãƒ‡ãƒ¼ã‚¿ã‚’å†å®šç¾©
        const datasets = [{
            label: 'é¸æ‰‹åˆ†å¸ƒ',
            data: players.map(p => ({ 
                x: getSafeValue(p.avg, 0), 
                y: getSafeValue(p.ops, 0.3)
            })),
            backgroundColor: players.map(p => {
                const ops = getSafeValue(p.ops);
                const avg = getSafeValue(p.avg);
                // OPSãŒé«˜ã„é¸æ‰‹ã¯èµ¤ç³»ã€æ‰“ç‡ãŒé«˜ã„é¸æ‰‹ã¯é»„ç³»ã§è‰²åˆ†ã‘
                if (ops >= 1.000) return '#ef4444'; // è¶…æ”»æ’ƒå‹
                if (avg >= 0.400) return '#f97316'; // é«˜æ‰“ç‡å‹
                if (ops >= 0.750) return '#3b82f6'; // ãƒãƒ©ãƒ³ã‚¹å‹
                return '#9ca3af'; // ãã®ä»–
            }),
            pointRadius: players.map(p => Math.max(5, (p.hr || 0) * 2 + 4)), // HRãŒ null ã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            pointHoverRadius: 10
        }];

        new Chart(scatterCtx, {
            type: 'scatter',
            data: {
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { 
                        title: { display: true, text: 'ç¢ºå®Ÿæ€§ (æ‰“ç‡ AVG)' }, 
                        min: 0.200, 
                        max: 0.500, // ç¯„å›²ä¿®æ­£: 0.500ã§ååˆ†
                        ticks: { callback: (v) => getSafeValue(v).toFixed(3) }
                    },
                    y: { 
                        title: { display: true, text: 'ç ´å£ŠåŠ› (OPS)' }, 
                        min: 0.300, 
                        max: 1.500, // ç¯„å›²ã‚’1.500ã¾ã§åºƒã’ã€è¶…æ”»æ’ƒå‹ã‚‚æç”»å¯èƒ½ã«
                        ticks: { callback: (v) => getSafeValue(v).toFixed(3) }
                    }
                },
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'æ‰“è€…ã‚¿ã‚¤ãƒ—ãƒ»ãƒãƒƒãƒ— (OPS vs AVG)' },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const p = players[context.dataIndex];
                                
                                const type = (() => {
                                    if (p.type === 'è¶…æ–°æ˜Ÿ') return 'ğŸ’£ çˆ†ç™ºå‹';
                                    if (p.type === 'ä¸»ç³»åˆ—æ˜Ÿ') return 'ğŸ¯ ç†æƒ³å‹';
                                    if (p.type === 'èµ¤è‰²å·¨æ˜Ÿ') return 'ğŸ¹ è·äººå‹';
                                    return 'ğŸ“ˆ è‚²æˆæ ';
                                })();
                                
                                // â˜…â˜…â˜… ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºã®å®‰å…¨åŒ– â˜…â˜…â˜…
                                const safeOps = getSafeValue(p.ops).toFixed(3);
                                const safeAvg = getSafeValue(p.avg).toFixed(3);
                                
                                return `${p.name} (${type}): OPS ${safeOps}, æ‰“ç‡ ${safeAvg}, HR ${p.hr || 0}`;
                            }
                        }
                    }
                },
                annotation: {
                    annotations: {
                        opsLine: { type: 'line', scaleID: 'y', value: 0.850, borderColor: '#facc15', borderWidth: 1, borderDash: [5, 5], label: { content: 'ä¸»è»¸ãƒ¬ãƒ™ãƒ«', enabled: true, position: 'start' } },
                        avgLine: { type: 'line', scaleID: 'x', value: 0.350, borderColor: '#3b82f6', borderWidth: 1, borderDash: [5, 5], label: { content: 'é«˜æ‰“ç‡ãƒ¬ãƒ™ãƒ«', enabled: true, position: 'end' } }
                    }
                }
            }
        });
    }

    // 2.5. æ£’ã‚°ãƒ©ãƒ• (RCãƒ©ãƒ³ã‚­ãƒ³ã‚°) ã®æç”»
    const barCtx = document.getElementById('rc-bar-chart');
    if (barCtx) {
        renderRcBarChart(barCtx.getContext('2d'), players);
    }

    const guidelinesEl = document.getElementById('rc-guidelines');
    if (guidelinesEl) {
        // RC/Gãªã©ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’æŒ¿å…¥
        guidelinesEl.innerHTML = getGuidelineText(teamTotalRC, players, teamName);
    }
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * ã€FIXEDã€‘é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€æœ€é©ãªæ‰“é †ï¼ˆ1ç•ªã€œ9ç•ªï¼‰ã‚’æ¨å¥¨ã™ã‚‹
 * (OPSã€å‡ºå¡ç‡ã€é•·æ‰“åŠ›ã€è²¢çŒ®åº¦(RC/G)ã‚’å½¹å‰²åˆ¥ã«è©•ä¾¡)
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 * @returns {Array<object> | null} - æœ€é©ãªæ‰“é † (1ç•ªã‹ã‚‰9ç•ª) ã®é¸æ‰‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
 */
function generateOptimalLineup(teamName) {
    const record = tournamentState.teamRecords[teamName];
    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã€ã¾ãŸã¯æ‰“è€…ãŒ3äººæœªæº€ã®å ´åˆã¯å‡¦ç†ã—ãªã„
    if (!record || !record.playerStats || !record.playerStats.batting || Object.keys(record.playerStats.batting).length < 3) {
        return null;
    }

    const MIN_PA_FOR_RANKING = 5; // æœ€ä½æ‰“å¸­æ•°

    // 1. é¸æ‰‹ã®ãƒ‡ãƒ¼ã‚¿ã¨è©•ä¾¡æŒ‡æ¨™ã‚’è¨ˆç®—
    const allPlayers = Object.keys(record.playerStats.batting).map(playerName => {
        const stats = record.playerStats.batting[playerName];
        const { ab = 0, h = 0, hr = 0, rbi = 0, pa = 0, games = 0, tb = 0, bb = 0, hbp = 0, sf = 0 } = stats;
        
        // è¦å®šæ‰“å¸­æœªæº€ã€ã¾ãŸã¯æ‰“å¸­æ©Ÿä¼šãŒãªã‘ã‚Œã°é™¤å¤–
        if (pa < MIN_PA_FOR_RANKING) return null;

        const obp_den = ab + bb + hbp + sf;
        const obp = obp_den > 0 ? (h + bb + hbp) / obp_den : 0;
        const slg = ab > 0 ? tb / ab : 0;
        const ops = obp + slg;
        
        // --- â˜…â˜…â˜… RC/G è¨ˆç®—ã®å®‰å…¨åŒ– â˜…â˜…â˜… ---
        const rcCalc = (obp * tb) / (ab + bb);
        const safeRc = isNaN(rcCalc) ? 0 : rcCalc; // RCã®NaNãƒã‚§ãƒƒã‚¯
        const rcg = games > 0 ? safeRc / games : 0; 
        
        // å½¹å‰²ã‚¹ã‚³ã‚¢ã®è¨ˆç®—
        return {
            name: playerName,
            rcg: rcg, // â˜… RC/Gã‚’ãƒ‡ãƒ¼ã‚¿ã«å«ã‚ã‚‹
            // 1ç•ªã‚¹ã‚³ã‚¢ (å‡ºå¡ç‡ + ç›—å¡é‡è¦–)
            leadOff: (obp * 2.0) + (stats.sb * 0.2) + (rcg * 0.5), 
            // 2ç•ªã‚¹ã‚³ã‚¢ (RC/G + å®‰å®šæ€§)
            rcgScore: (rcg * 2.5) + (obp * 1.0),
            // 3ç•ªã‚¹ã‚³ã‚¢ (OPS + ç¢ºå®Ÿæ€§)
            consistency: (ops * 1.5) + (obp * 1.0),
            // 4/5ç•ªã‚¹ã‚³ã‚¢ (é•·æ‰“ + æ‰“ç‚¹é‡è¦–)
            power: (slg * 1.5) + (rbi * 0.2) + (hr * 0.5) + (ops * 0.5),
            // ä¿Šè¶³ (ç›—å¡ãŒå¤šã„ã‹)
            isFast: stats.sb >= 3,
            // é•·æ‰“åŠ› (OPSãŒé«˜ã„ã‹)
            isSlugger: ops >= 1.000,
            // ç¢ºå®Ÿæ€§ (æ‰“ç‡ãŒé«˜ã„ã‹)
            isHighAvg: (ab > 0 && h / ab >= 0.400)
        };
    }).filter(p => p !== null).sort((a, b) => b.power - a.power); // åˆæœŸã¯ãƒ‘ãƒ¯ãƒ¼é †ã«ã‚½ãƒ¼ãƒˆ

    if (allPlayers.length < 9) {
        console.warn(`[Lineup] ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚è¦å®šæ‰“å¸­ (${MIN_PA_FOR_RANKING}) ã‚’æº€ãŸã™é¸æ‰‹ãŒ9äººæœªæº€ã§ã™ã€‚`);
        return null;
    }

    let remainingPlayers = [...allPlayers];
    const lineup = Array(9).fill(null);

    // 2. å½¹å‰²åˆ¥å‰²ã‚Šå½“ã¦ (é«˜æ ¡é‡çƒ/ã‚»ã‚¤ãƒãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç†è«–ã«åŸºã¥ã)
    
    // A. 4ç•ª (çµ¶å¯¾çš„ãƒ‘ãƒ¯ãƒ¼ãƒ’ãƒƒã‚¿ãƒ¼) - Powerã‚¹ã‚³ã‚¢æœ€é«˜
    const p4 = remainingPlayers.shift();
    lineup[3] = p4;

    // B. 3ç•ª (ç¢ºå®Ÿæ€§ + OPS) - 4ç•ªã®æ¬¡ã«é«˜ã„Consistencyã‚’æŒã¤é¸æ‰‹
    const p3 = remainingPlayers.sort((a, b) => b.consistency - a.consistency).shift();
    lineup[2] = p3;

    // C. 1ç•ª (å‡ºå¡ + ä¿Šè¶³) - LeadOffã‚¹ã‚³ã‚¢æœ€é«˜
    remainingPlayers.sort((a, b) => b.leadOff - a.leadOff);
    const p1 = remainingPlayers.shift();
    lineup[0] = p1;

    // D. 2ç•ª (RC/G + å®‰å®šæ€§) - 1ç•ªã¨3ç•ªã‚’ã¤ãªãæœ€ã‚‚åŠ¹ç‡çš„ãªæ‰“è€…
    remainingPlayers.sort((a, b) => b.rcgScore - a.rcgScore);
    const p2 = remainingPlayers.shift();
    lineup[1] = p2;

    // E. 5ç•ª (å¾Œç¶šã®æ‰“ç‚¹å½¹) - 4ç•ªã®æ¬¡ã«é«˜ã„Powerã‚¹ã‚³ã‚¢ (æ®‹ã‚Šã®é¸æ‰‹ã‚’ã‚½ãƒ¼ãƒˆ)
    remainingPlayers.sort((a, b) => b.power - a.power);
    const p5 = remainingPlayers.shift();
    lineup[4] = p5;
    
    // F. 6ç•ª (æ®‹ã‚Šã®ä¸­ã§æœ€ã‚‚PowerãŒé«˜ã„é¸æ‰‹)
    remainingPlayers.sort((a, b) => b.power - a.power);
    lineup[5] = remainingPlayers.shift();
    
    // G. 9ç•ª (ä¸‹ä½ã®ãƒªãƒ¼ãƒ‰ã‚ªãƒ•) - æ®‹ã‚Šã®ä¸­ã§ObpãŒé«˜ã„é¸æ‰‹
    remainingPlayers.sort((a, b) => b.leadOff - a.leadOff);
    lineup[8] = remainingPlayers.shift();
    
    // H. 7ç•ª/8ç•ª (æ®‹ã‚Šã‚’RC/Gé †ã«å‰²ã‚Šå½“ã¦)
    remainingPlayers.sort((a, b) => b.rcgScore - a.rcgScore);
    lineup[6] = remainingPlayers.shift(); // 7ç•ª
    lineup[7] = remainingPlayers.shift(); // 8ç•ª

    // 3. æ‰“é †ç•ªå·ã‚’ä»˜ä¸ã—ã¦è¿”ã™
    return lineup.map((p, i) => ({
        ...p,
        order: i + 1,
        recommendation: i + 1
    }));
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * [FIXED] RCã€OPSãªã©ã®è©•ä¾¡åŸºæº–ã¨ã€ãƒˆãƒƒãƒ—è²¢çŒ®è€…ã‚’åˆ†æã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
 * (â˜…ã‚°ãƒ©ãƒ•ã®èª­ã¿æ–¹è§£èª¬ã‚’è¿½åŠ )
 * @param {number} teamTotalRC - ãƒãƒ¼ãƒ ã®ç· Runs Created
 * @param {Array} players - é¸æ‰‹ã®RCãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆ
 * @param {string} teamName - åˆ†æå¯¾è±¡ã®ãƒãƒ¼ãƒ å (é€šç®—è©¦åˆæ•°å–å¾—ç”¨)
 */
function getGuidelineText(teamTotalRC, players, teamName) {
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ãªã„ã€ã¾ãŸã¯ç·RCãŒã‚¼ãƒ­ãªã‚‰åˆ†æã—ãªã„
    if (players.length === 0 || teamTotalRC === 0) {
        return "<p class='text-gray-500'>ã¾ã æ‰“è€…ã®æˆç¸¾ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚</p>";
    }
    
    const sortedPlayers = [...players].sort((a, b) => b.rc - a.rc);
    const topRcPlayer = sortedPlayers[0];
    const teamRecord = tournamentState.teamRecords[teamName];

    let html = '';

    // --- 0. ã‚°ãƒ©ãƒ•ã®èª­ã¿æ–¹è§£èª¬ (æ–°è¦è¿½åŠ ) ---
    html += `
        <div class="border-b pb-2">
            <p class="font-bold text-base text-gray-800">ğŸ“Š æ‰“è€…ã‚¿ã‚¤ãƒ—ãƒ»ãƒãƒƒãƒ—ã®èª­ã¿æ–¹</p>
            <ul class="list-disc list-inside ml-4 text-sm text-gray-700 space-y-1">
                <li><strong>OPSï¼ˆç¸¦è»¸: ç ´å£ŠåŠ›ï¼‰:</strong> é«˜ã„ã»ã©é•·æ‰“åŠ›ã¨å‡ºå¡èƒ½åŠ›ãŒã‚ã‚‹ã€‚</li>
                <li><strong>æ‰“ç‡ï¼ˆæ¨ªè»¸: ç¢ºå®Ÿæ€§ï¼‰:</strong> é«˜ã„ã»ã©ãƒœãƒ¼ãƒ«ã«ãƒãƒƒãƒˆãŒå½“ãŸã‚‹å®‰å®šæ€§ãŒã‚ã‚‹ã€‚</li>
                <li><strong>ãƒãƒ–ãƒ«ã®å¤§ãã•:</strong> ãã®é¸æ‰‹ã®**æœ¬å¡æ‰“æ•°**ã«æ¯”ä¾‹ã—ã¾ã™ã€‚</li>
            </ul>
        </div>`;
        
    // --- 1. è©•ä¾¡åŸºæº–ã¨ã‚°ãƒ©ãƒ•ã®ä½ç½®ã«ã‚ˆã‚‹åˆ†é¡ ---
    if (topRcPlayer) {
        // RC/Gã®è¨ˆç®—
        const gamesPlayed = topRcPlayer.games || 1;
        const rcPerGame = topRcPlayer.rc / gamesPlayed;
        const topShare = (topRcPlayer.rc / teamTotalRC) * 100;

        html += `
            <div class="border-b pb-2">
                <p class="font-bold text-base text-indigo-700">è©•ä¾¡åŸºæº–ã¨é¸æ‰‹ã®å½¹å‰²</p>
                <ul class="list-disc list-inside ml-4 text-sm text-gray-700 space-y-1">
                    <li><strong>OPS 1.000ä»¥ä¸Š:</strong> æ€ªç‰©ç´šã€‚ãƒ—ãƒ­æ³¨ç›®ã€‚</li>
                    <li><strong class="text-red-600">OPS 0.850ä»¥ä¸Š:</strong> å¼·è±ªæ ¡ã®ä¸»è»¸ã¨ã—ã¦éå¸¸ã«å„ªç§€ãªæ°´æº–ã€‚</li>
                    <li><strong>æ‰“ç‡ .400ä»¥ä¸Š:</strong> é©šç•°çš„ã€‚</li>
                </ul>
                <div class="mt-3 p-2 bg-yellow-50 rounded">
                    <p class="font-bold text-xs">ã‚°ãƒ©ãƒ•ä½ç½®ã«ã‚ˆã‚‹åˆ†é¡:</p>
                    <ul class="list-none ml-2 text-xs">
                        <li>- **å³ä¸Šã®é¸æ‰‹ (ç†æƒ³):** æ‰“ç‡ã‚‚OPSã‚‚é«˜ã„ã€æœ€ã‚‚å„ªç§€ãªæ‰“è€…ã€‚</li>
                        <li>- **å·¦ä¸Šã®é¸æ‰‹ (ç ´å£Šè€…):** OPSã¯é«˜ã„ãŒæ‰“ç‡ãŒä½ã„é•·è·é›¢ç ²ã€‚</li>
                        <li>- **å³ä¸‹ã®é¸æ‰‹ (è·äºº):** æ‰“ç‡ã¯é«˜ã„ãŒé•·æ‰“åŠ›ã¯ä½ã„ã‚¢ãƒ™ãƒ¬ãƒ¼ã‚¸ãƒ’ãƒƒã‚¿ãƒ¼ã€‚</li>
                    </ul>
                </div>
            </div>`;
            
        // --- 2. ãƒˆãƒƒãƒ—è²¢çŒ®è€…ã®æƒ…å ± (RC/Gã®çµ¶å¯¾å€¤ã‚’å«ã‚€) ---
        html += `
            <div class="p-2 bg-gray-50 rounded">
                <p class="font-bold text-sm text-gray-800">ğŸ”¥ ç¾åœ¨ã®æœ€é«˜è²¢çŒ®è€…</p>
                <p class="text-lg font-extrabold text-red-600">${topRcPlayer.name}</p>
                <p class="text-sm text-gray-700">RC/è©¦åˆ (RC/G): <strong>${rcPerGame.toFixed(2)}</strong></p>
                <p class="text-xs text-gray-600">RC/G 2.0ä»¥ä¸Šã§ã€Œã‚¨ãƒ¼ã‚¹ç´šã€ã®ãƒšãƒ¼ã‚¹ã§ã™ã€‚</p>
            </div>`;
    }
    
    return html;
}


/**
 * å€‹äººåˆ¥æ‰“å¸­çµæœã®ãƒ†ãƒ¼ãƒ–ãƒ«HTMLã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…ä½œæˆ¦ãƒœãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ãŸä¿®æ­£ç‰ˆ)
 */
function createPlayerBattingTable(teamName, teamKey, details) {
    const battingData = details.batting[teamKey] || [];
    const numInnings = details.inningScore?.[teamKey]?.length || 9;
    
    // é¸æ‰‹ãƒªã‚¹ãƒˆï¼ˆä»£èµ°/å®ˆå‚™å›ºã‚ã‚‚å«ã‚€ï¼‰
    const playersOnField = battingData.filter(p => p.name).map(p => ({name: p.name}));

    // ã€ŒæŠ•/æ‰“ã€ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”¨ã®é¸æŠè‚¢
    const throwBatOptionsList = [
        { val: "R/R", label: "å³/å³" }, { val: "R/L", label: "å³/å·¦" }, { val: "R/S", label: "å³/ä¸¡" },
        { val: "L/L", label: "å·¦/å·¦" }, { val: "L/R", label: "å·¦/å³" }, { val: "L/S", label: "å·¦/ä¸¡" }
    ];
    const createThrowBatOptions = (selectedVal) => {
        return throwBatOptionsList.map(opt => 
            `<option value="${opt.val}" ${selectedVal === opt.val ? 'selected' : ''}>${opt.label}</option>`
        ).join('');
    };

    // èƒŒç•ªå·ã¨å®ˆå‚™ä½ç½®ã®é¸æŠè‚¢
    let numberOptions = '<option value=""></option>';
    for (let i = 1; i <= 20; i++) { numberOptions += `<option value="${i}">${i}</option>`; }
    const posOptions = ['æŠ•', 'æ•', 'ä¸€', 'äºŒ', 'ä¸‰', 'éŠ', 'å·¦', 'ä¸­', 'å³'].map(p => `<option value="${p}">${p}</option>`).join('');
    
    // ã‚¤ãƒ‹ãƒ³ã‚°ãƒ˜ãƒƒãƒ€ãƒ¼
    let inningsHeader = '';
    for (let i = 1; i <= numInnings; i++) {
        inningsHeader += `<th class="col-inning">${i}</th>`;
    }

    let bodyRows = '';
    const teamRecord = tournamentState.teamRecords[teamName]; // â˜…èª¿å­å–å¾—ç”¨

    // â–¼â–¼â–¼ ã€ã“ã“ãŒè¿½åŠ ãƒ»å¤‰æ›´ç®‡æ‰€ã€‘ â–¼â–¼â–¼
    // 283å­¦åœ’ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒãƒ¼ãƒ ï¼‰ã‹ã©ã†ã‹ã‚’åˆ¤å®š
    const isMyTeam = teamName.includes("283") || teamName.includes("ï¼—ï¼–ï¼•") || teamName.includes("ãƒŠãƒ ã‚³");
    
    // 283å­¦åœ’ãªã‚‰ã€Œä½œæˆ¦ãƒœãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã®HTMLã‚’ä½œæˆã€ãã†ã§ãªã‘ã‚Œã°ç©ºæ–‡å­—
    const strategyBtnHtml = isMyTeam ? `
        <button class="open-lineup-manager-btn bg-indigo-600 text-white text-xs px-3 py-1 rounded hover:bg-indigo-700 shadow ml-2 flex items-center" 
                data-match-id="${currentMatchIdForDetails}" data-team-key="${teamKey}">
            <span class="mr-1">âš”ï¸</span> ä½œæˆ¦ãƒœãƒ¼ãƒ‰
        </button>
    ` : '';
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    // --- 1. ã‚¹ã‚¿ãƒ¡ãƒ³ (1ã€œ9ç•ª) ã®è¡Œã‚’ç”Ÿæˆ ---
    for (let i = 1; i <= 9; i++) {
        let starterData = battingData.find(p => p.order && parseInt(p.order) === i) || { order: i, results: Array(numInnings).fill('') };
        if (!starterData.results) starterData.results = Array(numInnings).fill('');
        const pName = starterData.name || ''; 
const isCaptain = starterData.isCaptain ? 'active' : '';

        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
        let conditionIcon = '';
        if (pName && teamRecord?.playerStats?.batting[pName]) {
            const flag = teamRecord.playerStats.batting[pName].narrative_flag;
            conditionIcon = getPlayerConditionIcon(flag);
        }
        // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

        const starterNumberSelect = `<select class="player-number w-full bg-transparent">${numberOptions.replace(`value="${starterData.number}"`, `value="${starterData.number}" selected`)}</select>`;
        const starterThrowBatSelect = `<select class="player-throw-bat w-full bg-transparent"><option value="">-æŠ•/æ‰“-</option>${createThrowBatOptions(starterData.throwBat)}</select>`;
        const starterPosSelect = `<select class="player-pos w-full bg-transparent"><option value=""></option>${posOptions.replace(`value="${starterData.currentPos || starterData.pos}"`, `value="${starterData.currentPos || starterData.pos}" selected`)}</select>`;
        const posHistoryHtml = `<span class="text-xs text-gray-500 truncate" title="${starterData.posHistoryDisplay || ''}">${starterData.posHistoryDisplay || ''}</span>`;
        
        let resultInputs = '';
        for (let j = 0; j < numInnings; j++) {
            const resultString = starterData.results[j] || '';
            const atBats = (resultString && resultString.split('ã€').length > 0) ? resultString.split('ã€') : [''];
            const atBatBlocksHTML = atBats.map(atBatString => createBattingResultDropdowns(playersOnField, atBatString)).join('');
            
            const changeBtnHTML = `
                <button class="inning-add-sub-btn text-xs mt-1 bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 w-auto font-semibold" 
                        data-team-key="${teamKey}" 
                        data-order="${starterData.order}"
                        data-inning="${j}" 
                        title="${j + 1}å›ã«ä»£æ‰“ã‚’é€ã‚‹">
                    ä»£æ‰“
                </button>`;

            resultInputs += `
                <td class="col-inning batting-result-cell align-top p-1">
                    ${atBatBlocksHTML}
                    <div class="flex justify-between items-center mt-1 pt-1 border-t">
                        <button class="add-at-bat-btn text-xs bg-blue-100 px-2 py-1 rounded hover:bg-blue-200 font-semibold">ï¼‹ 2æ‰“å¸­</button>
                        ${changeBtnHTML}
                    </div>
                 </td>`;
        }
        
       bodyRows += `
            <tr data-order="${starterData.order}">
                <td class="col-order">${i}</td>
                <td class="col-number">${starterNumberSelect}</td>
                <td class="col-throw-bat">${starterThrowBatSelect}</td>
                <td class="col-player">
                    <div class="flex items-center gap-1">
                        <input type="text" class="player-name w-full" value="${pName}" list="roster-datalist-${teamKey}">
                        
                        <button class="captain-btn ${isCaptain}" title="ä¸»å°†ã«è¨­å®š">C</button>
                        ${conditionIcon} 
                        <button class="show-player-stats-btn text-lg p-1 text-blue-600 hover:bg-blue-100 rounded" 
                                data-team-name="${teamName}" 
                                data-player-order-key="${starterData.order}" 
                                title="é€šç®—æˆç¸¾ã‚’è¡¨ç¤º">ğŸ“Š</button>
                    </div>
                </td>
                <td class="col-pos">
                    <div class="flex items-center justify-between">${starterPosSelect}<button class="text-xs bg-gray-200 px-1 ml-1 rounded pos-change-btn" data-team-key="${teamKey}">å¤‰æ›´</button></div>
                    ${posHistoryHtml}
                </td>
                <td class="col-sub-type align-middle">
                    <button class="add-sub-row-btn text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 w-full" data-order="${starterData.order}" data-team-key="${teamKey}">
                        + äº¤ä»£
                    </button>
                </td>
                ${resultInputs}
            </tr>
        `;
        
        // --- 2. äº¤ä»£é¸æ‰‹ (ã‚¹ã‚¿ãƒ¡ãƒ³ã®ç›´ä¸‹) ã®è¡Œã‚’ç”Ÿæˆ ---
        const substitutes = battingData.filter(p => p.order && p.order.toString().startsWith(`${i}-sub`));
        substitutes.forEach(subData => {
            if (!subData.results) subData.results = Array(numInnings).fill('');
            const subName = subData.name || '';

            // ã‚­ãƒ£ãƒ—ãƒ†ãƒ³çŠ¶æ…‹
            const isSubCaptain = subData.isCaptain ? 'active' : '';

            // èª¿å­ã‚¢ã‚¤ã‚³ãƒ³
            let subConditionIcon = '';
            if (subName && teamRecord?.playerStats?.batting[subName]) {
                const flag = teamRecord.playerStats.batting[subName].narrative_flag;
                subConditionIcon = getPlayerConditionIcon(flag);
            }

            // å„ç¨®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®HTMLç”Ÿæˆ
            const subNumberSelect = `<select class="player-number w-full bg-transparent">${numberOptions.replace(`value="${subData.number}"`, `value="${subData.number}" selected`)}</select>`;
            const subThrowBatSelect = `<select class="player-throw-bat w-full bg-transparent"><option value="">-æŠ•/æ‰“-</option>${createThrowBatOptions(subData.throwBat)}</select>`;
            const subPosSelect = `<select class="player-pos w-full bg-transparent"><option value=""></option>${posOptions.replace(`value="${subData.currentPos || subData.pos}"`, `value="${subData.currentPos || subData.pos}" selected`)}</select>`;
            const subPosHistoryHtml = `<span class="text-xs text-gray-500 truncate" title="${subData.posHistoryDisplay || ''}">${subData.posHistoryDisplay || ''}</span>`;

            // ã‚¤ãƒ‹ãƒ³ã‚°å…¥åŠ›æ¬„ã®ç”Ÿæˆ
            let subResultInputs = '';
            for (let j = 0; j < numInnings; j++) {
                const resultString = subData.results[j] || '';
                const atBats = (resultString && resultString.split('ã€').length > 0) ? resultString.split('ã€') : [''];
                const atBatBlocksHTML = atBats.map(atBatString => createBattingResultDropdowns(playersOnField, atBatString)).join('');

                const changeBtnHTML = `
                    <button class="inning-add-sub-btn text-xs mt-1 bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 w-auto font-semibold" 
                            data-team-key="${teamKey}" 
                            data-order="${subData.order}"
                            data-inning="${j}"
                            title="${j + 1}å›ã«ä»£æ‰“ã‚’é€ã‚‹">
                        ä»£æ‰“
                    </button>`;
                
                subResultInputs += `
                    <td class="col-inning batting-result-cell align-top p-1">
                        ${atBatBlocksHTML}
                        <div class="flex justify-between items-center mt-1 pt-1 border-t">
                            <button class="add-at-bat-btn text-xs bg-blue-100 px-2 py-1 rounded hover:bg-blue-200 font-semibold">ï¼‹ 2æ‰“å¸­</button>
                            ${changeBtnHTML}
                        </div>
                     </td>`;
            }
            
            // â–¼â–¼â–¼ ä¿®æ­£: ã“ã“ã§è¶³ã‚Šãªã‹ã£ãŸæœ€åˆã®3åˆ—ã‚’å¾©æ´»ã•ã›ã¾ã—ãŸ â–¼â–¼â–¼
            bodyRows += `
                <tr data-order="${subData.order}">
                    <td class="col-order"></td> <td class="col-number">${subNumberSelect}</td> <td class="col-throw-bat">${subThrowBatSelect}</td> <td class="col-player pl-4"> <div class="flex items-center gap-1">
                            <input type="text" class="player-name w-full" value="${subName}" list="roster-datalist-${teamKey}">
                            
                            <button class="captain-btn ${isSubCaptain}" title="ä¸»å°†ã«è¨­å®š">C</button>

                            ${subConditionIcon} 
                            <button class="show-player-stats-btn text-lg p-1 text-blue-600 hover:bg-blue-100 rounded" 
                                    data-team-name="${teamName}" 
                                    data-player-order-key="${subData.order}" 
                                    title="é€šç®—æˆç¸¾ã‚’è¡¨ç¤º">ğŸ“Š</button>
                        </div>
                    </td>
                    <td class="col-pos"> <div class="flex items-center justify-between">${subPosSelect}<button class="text-xs bg-gray-200 px-1 ml-1 rounded pos-change-btn" data-team-key="${teamKey}">å¤‰æ›´</button></div>
                        ${subPosHistoryHtml}
                    </td>
                    <td class="col-sub-type align-top"> <select class="sub-type-select w-full bg-transparent mb-1">
                            <option value="" ${!subData.sub_type ? 'selected' : ''}>-</option>
                            <option value="PH" ${subData.sub_type === 'PH' ? 'selected' : ''}>ä»£æ‰“</option>
                            <option value="PR" ${subData.sub_type === 'PR' ? 'selected' : ''}>ä»£èµ°</option>
                            <option value="DEF" ${subData.sub_type === 'DEF' ? 'selected' : ''}>å®ˆå‚™</option>
                            <option value="PITCHER" ${subData.sub_type === 'PITCHER' ? 'selected' : ''}>æŠ•æ‰‹</option>
                        </select>
                        <button class="add-sub-row-btn text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 w-full" data-order="${subData.order}" data-team-key="${teamKey}">
                            + äº¤ä»£
                        </button>
                    </td>
                    ${subResultInputs} </tr>
            `;
        });
    }

    return `
        <div class="overflow-x-auto border rounded-lg bg-white mt-2">
            <div class="flex justify-between items-center p-2 bg-gray-50 border-b">
                <h4 class="font-bold text-lg flex items-center">
                    ${teamName} æ‰“æ’ƒæˆç¸¾
                    ${strategyBtnHtml} </h4>
                <div class="text-xs">
                    <button class="load-lineup-btn bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300 mr-1" data-team-key="${teamKey}">ğŸ“‚ èª­è¾¼</button>
                    <button class="save-lineup-btn bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200" data-team-key="${teamKey}">ğŸ’¾ ä¿å­˜</button>
                </div>
            </div>
            <table class="details-table batting-table" id="batting-table-${teamKey}">
                <thead>
                    <tr>
                        <th class="col-order">æ‰“é †</th>
                        <th class="col-number">#</th>
                        <th class="col-throw-bat">æŠ•/æ‰“</th>
                        <th class="col-player">é¸æ‰‹å</th>
                        <th class="col-pos">å®ˆå‚™</th>
                        <th class="col-sub-type">å‡ºå ´</th>
                        ${inningsHeader}
                        <th class="w-10"><button class="add-inning-btn text-xs" data-team-key="${teamKey}">+ å›</button></th>
                    </tr>
                </thead>
                <tbody>${bodyRows}</tbody>
            </table>
        </div>
    `;
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
}


/**
 * [ä¿®æ­£ãƒ»å®Œå…¨ç‰ˆ] è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã€é€šç®—æˆç¸¾ã‚’æ›´æ–°ã™ã‚‹
 * (â˜…ã‚³ãƒ¼ãƒ«ãƒ‰å‡¦ç†å¾Œã«è‡ªå‹•ã§0åŸ‹ã‚ã‚’è¡Œã†ãŒã€Xã«ãªã‚‹ã¹ãç®‡æ‰€ã¯ç©ºæ¬„ã®ã¾ã¾ã«ã™ã‚‹ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ä»˜ã)
 */
function saveDetailedStats() {
    if (!currentMatchIdForDetails) return;
    const match = findMatchById(currentMatchIdForDetails);
    if (!match) return;

    // --- èµ·ç”¨ãƒ–ãƒ­ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
    let injuredPlayerFound = null;
    for (const teamKey of ['team1', 'team2']) {
        const teamName = match[teamKey];
        const teamRecord = tournamentState.teamRecords[teamName];
        if (!teamRecord || !teamRecord.playerStats) continue;
        const battingTable = document.getElementById(`batting-table-${teamKey}`);
        if (battingTable) {
            battingTable.querySelectorAll('tbody tr').forEach(row => {
                const nameInput = row.querySelector('.player-name');
                if (nameInput && nameInput.value.trim() !== '') {
                    const playerName = nameInput.value.trim();
                    const bStats = teamRecord.playerStats.batting[playerName];
                    if (bStats && (bStats.narrative_flag === 'injured' || bStats.narrative_flag === 'sick' || bStats.narrative_flag === 'minor_injury')) {
                        injuredPlayerFound = playerName;
                    }
                }
            });
        }
        if (injuredPlayerFound) break;
        const pitchingTable = document.getElementById(`pitching-table-${teamKey}`);
        if (pitchingTable) {
            pitchingTable.querySelectorAll('tbody tr').forEach(row => {
                const nameInput = row.querySelector('.pitcher-name');
                if (nameInput && nameInput.value.trim() !== '') {
                    const playerName = nameInput.value.trim();
                    const pStats = teamRecord.playerStats.pitching[playerName];
                    if (pStats && (pStats.narrative_flag === 'injured' || pStats.narrative_flag === 'sick' || pStats.narrative_flag === 'minor_injury')) {
                        injuredPlayerFound = playerName;
                    }
                }
            });
        }
        if (injuredPlayerFound) break;
    }
    if (injuredPlayerFound) {
        alert(`[èµ·ç”¨ä¸å¯] é¸æ‰‹ãŒèµ·ç”¨ã§ãã¾ã›ã‚“ã€‚\n\né¸æ‰‹å: ${injuredPlayerFound}\nç†ç”±: æ•…éšœ(ğŸ¥)ãƒ»è»½å‚·(ğŸ©¹)ãƒ»ä½“èª¿ä¸è‰¯ã®ãŸã‚ã€è©¦åˆã«å‡ºå ´ã•ã›ã‚‰ã‚Œã¾ã›ã‚“ã€‚`);
        return;
    }
    // --- èµ·ç”¨ãƒ–ãƒ­ãƒƒã‚¯ã“ã“ã¾ã§ ---

    // --- 1. æˆç¸¾ãƒªã‚»ãƒƒãƒˆå‡¦ç† (æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®ã¾ã¾) ---
    if (match.details && match.details.playerGameStats) {
        for (const teamKey of ['team1', 'team2']) {
            const teamName = match[teamKey];
            const teamRecord = tournamentState.teamRecords[teamName];
            if (!teamRecord || !teamRecord.playerStats) continue;
            const previousBattingStats = match.details.playerGameStats[teamKey];
            if (previousBattingStats) {
                for (const playerName in previousBattingStats) {
                    const careerStats = teamRecord.playerStats.batting[playerName];
                    const prevGameStats = previousBattingStats[playerName]; 
                    if (careerStats && prevGameStats) {
                        if(prevGameStats.played) careerStats.games = (careerStats.games || 1) - 1;
                        for (const key of ['pa', 'ab', 'h', 'hr', 'rbi', 'sb', 'bb', 'hbp', 'sf', 'tb', 'r', 'so']) {
                            careerStats[key] = (careerStats[key] || 0) - (prevGameStats[key] || 0);
                        }
                        careerStats.narrative_flag = null;
                    }
                } 
            } 
            const previousBattingData = match.details.batting?.[teamKey];
            if (previousBattingData) {
                previousBattingData.forEach(prevPlayerData => {
                    const playerName = prevPlayerData.name;
                    if (!playerName || !teamRecord.playerStats.batting[playerName]) return;
                    const bStats = teamRecord.playerStats.batting[playerName];
                    if (bStats.gamelogs) {
                        bStats.gamelogs = bStats.gamelogs.filter(log => log.matchId !== currentMatchIdForDetails);
                    }
                });
            }
            if (teamRecord.tournamentStats && previousBattingStats) {
                let totals = { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0, sb: 0, bb: 0, hbp: 0, sf: 0, tb: 0, r: 0, so: 0 };
                for (const playerName in previousBattingStats) {
                    const prevGameStats = previousBattingStats[playerName]; 
                    if (prevGameStats) {
                        for (const key in totals) { totals[key] += prevGameStats[key] || 0; }
                    }
                }
                for (const key in totals) {
                     teamRecord.tournamentStats[key] = (teamRecord.tournamentStats[key] || 0) - totals[key];
                }
            } 
            const previousPitchingStats = match.details.pitching?.[teamKey];
            if (previousPitchingStats) {
                previousPitchingStats.forEach(prevGameStats => { 
                    const playerName = prevGameStats.name;
                    if (!playerName || !teamRecord.playerStats.pitching[playerName]) return;
                    const pStats = teamRecord.playerStats.pitching[playerName];
                    const careerStats = pStats.career;
                    if (careerStats && prevGameStats) {
                        careerStats.games = (careerStats.games || 1) - 1;
                        if (parseInt(prevGameStats.battersFaced || 0) > 0) {
                            if (prevGameStats.result === 'W') careerStats.w--;
                            if (prevGameStats.result === 'L') careerStats.l--;
                            careerStats.ip -= parseFloat(prevGameStats.innings || 0);
                            careerStats.so -= parseInt(prevGameStats.strikeouts || 0);
                            careerStats.er -= parseInt(prevGameStats.earnedRuns || 0);
                            careerStats.h = (careerStats.h || 0) - parseInt(prevGameStats.hits || 0);
                            careerStats.bb = (careerStats.bb || 0) - parseInt(prevGameStats.walks || 0);
                        }
                    }
                    if (pStats.gamelogs) {
                        pStats.gamelogs = pStats.gamelogs.filter(log => log.matchId !== currentMatchIdForDetails);
                    }
                    pStats.narrative_flag = null;
                });
            }
        }
    }

    // --- 2. æ–°ã—ã„è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ ---
    const details = { 
        inningScore: { team1: [], team2: [] }, 
        batting: { team1: [], team2: [] }, 
        pitching: { team1: [], team2: [] }, 
        fielding: { team1: [], team2: [] },
        playerGameStats: { team1: {}, team2: {} },
        positionChanges: match.details?.positionChanges || []
    };

    // --- â˜…â˜…â˜… ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢èª­ã¿å–ã‚Šå‡¦ç† (0åŸ‹ã‚å‰ã®ç”Ÿãƒ‡ãƒ¼ã‚¿å–å¾—) â˜…â˜…â˜… ---
    const scoreTable = document.getElementById('inning-score-table');
    let lastInningWithScore = 0;

    if (scoreTable) {
        const rows = scoreTable.querySelectorAll('tbody tr');
        
        // team1 (å…ˆæ”»)
        const team1Row = Array.from(rows).find(row => row.querySelector('th')?.textContent.trim() === match.team1);
        if (team1Row) {
            const inputs = Array.from(team1Row.querySelectorAll('input'));
            details.inningScore.team1 = inputs.map((input, index) => {
                const val = input.value;
                if (val !== '') {
                    lastInningWithScore = Math.max(lastInningWithScore, index + 1);
                    return parseInt(val);
                }
                return null; // â˜…ç©ºæ¬„ã¯nullã®ã¾ã¾ä¿æŒ
            });
        }

        // team2 (å¾Œæ”»)
        const team2Row = Array.from(rows).find(row => row.querySelector('th')?.textContent.trim() === match.team2);
        if (team2Row) {
            const inputs = Array.from(team2Row.querySelectorAll('input'));
            details.inningScore.team2 = inputs.map((input, index) => {
                const val = input.value;
                if (val !== '') {
                    lastInningWithScore = Math.max(lastInningWithScore, index + 1);
                    return parseInt(val);
                }
                return null; // â˜…ç©ºæ¬„ã¯nullã®ã¾ã¾ä¿æŒ
            });
        }
    }
    
    // --- â˜…â˜…â˜… ã‚³ãƒ¼ãƒ«ãƒ‰è¨­å®šã¨ã‚¤ãƒ‹ãƒ³ã‚°æ•°ã®ç¢ºå®š â˜…â˜…â˜… ---
    const calledGameCheckbox = document.getElementById('called-game-checkbox');
    let finalGameLength = 9; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯9å›
    
    if (calledGameCheckbox) {
        match.calledGame = calledGameCheckbox.checked;
        if (match.calledGame) {
            // ãƒã‚§ãƒƒã‚¯ã‚ã‚Šï¼šå…¥åŠ›ãŒã‚ã‚‹æœ€çµ‚å›ã¾ã§ã§åˆ‡ã‚‹ (æœ€ä½5å›)
            finalGameLength = Math.max(lastInningWithScore, 5);
            match.calledInning = finalGameLength;
        } else {
            // ãƒã‚§ãƒƒã‚¯ãªã—ï¼šé€šå¸¸ (9å›ã¾ãŸã¯ãã‚Œä»¥ä¸Š)
            finalGameLength = Math.max(lastInningWithScore, 9);
            match.calledInning = null;
        }
    }

    // --- â˜…â˜…â˜… ã‚¹ãƒãƒ¼ãƒˆ0åŸ‹ã‚å‡¦ç† â˜…â˜…â˜… ---
    // ç¢ºå®šã—ãŸã‚¤ãƒ‹ãƒ³ã‚°æ•°ã¾ã§ã®ç¯„å›²ã§ã€nullã‚’0ã«å¤‰æ›ã™ã‚‹ã€‚
    // ãŸã ã—ã€ã€Œå¾Œæ”»ãŒãƒªãƒ¼ãƒ‰ã—ã¦ã„ã‚‹æœ€çµ‚å›è£ã€ã¯ null (X) ã®ã¾ã¾ã«ã™ã‚‹ã€‚

    // ã‚¤ãƒ‹ãƒ³ã‚°é…åˆ—ã‚’ finalGameLength ã®é•·ã•ã«èª¿æ•´ï¼ˆåˆ‡ã‚Šè©°ã‚ or æ‹¡å¼µï¼‰
    // (æ‹¡å¼µéƒ¨åˆ†ã¯ undefined ã«ãªã‚‹ã®ã§ã€mapå‡¦ç†å†…ã§å¯¾å¿œ)
    for (const teamKey of ['team1', 'team2']) {
        // æŒ‡å®šé•·ã•ã«ã‚¹ãƒ©ã‚¤ã‚¹ï¼ˆè¶³ã‚Šãªã„å ´åˆã¯ç¶­æŒã€ã‚ã¨ã§ãƒ«ãƒ¼ãƒ—å‡¦ç†ï¼‰
        details.inningScore[teamKey] = details.inningScore[teamKey].slice(0, finalGameLength);
    }

    let currentScore1 = 0;
    let currentScore2 = 0;

    for (let i = 0; i < finalGameLength; i++) {
        // å…ˆæ”»: å¸¸ã«0åŸ‹ã‚
        if (details.inningScore.team1[i] == null) {
            details.inningScore.team1[i] = 0;
        }
        currentScore1 += details.inningScore.team1[i];

        // å¾Œæ”»: çŠ¶æ³åˆ¤æ–­
        if (details.inningScore.team2[i] != null) {
            // å…¥åŠ›ãŒã‚ã‚Œã°ãã‚Œã‚’åŠ ç®—
            currentScore2 += details.inningScore.team2[i];
        } else {
            // å…¥åŠ›ãŒãªã„(null)å ´åˆ
            if (i === finalGameLength - 1 && currentScore2 > currentScore1) {
                // æœ€çµ‚å›ã‹ã¤å¾Œæ”»ãƒªãƒ¼ãƒ‰ä¸­ãªã‚‰ã€nullã®ã¾ã¾ (Xæ‰±ã„)
                details.inningScore.team2[i] = null;
            } else {
                // ãã‚Œä»¥å¤–ã¯0åŸ‹ã‚
                details.inningScore.team2[i] = 0;
                currentScore2 += 0;
            }
        }
    }

    // åˆè¨ˆã‚¹ã‚³ã‚¢è¨ˆç®— (nullã¯0ã¨ã—ã¦è¨ˆç®—)
    match.score1 = details.inningScore.team1.reduce((sum, score) => sum + (score || 0), 0);
    match.score2 = details.inningScore.team2.reduce((sum, score) => sum + (score || 0), 0);


    for (const teamKey of ['team1', 'team2']) {
        const teamName = match[teamKey];
        const teamRecord = tournamentState.teamRecords[teamName];
        if (!teamRecord) continue;
        if (!teamRecord.playerStats) teamRecord.playerStats = { batting: {}, pitching: {} };
        if (!teamRecord.tournamentStats) teamRecord.tournamentStats = { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0, sb: 0, bb: 0, hbp: 0, sf: 0, tb: 0, r: 0, so: 0 }; 
        const playersAppearedThisGame = new Set();
        const battingTable = document.getElementById(`batting-table-${teamKey}`);
        if (battingTable) {
            battingTable.querySelectorAll('tbody tr').forEach(row => {
                const nameInput = row.querySelector('.player-name');
                if (nameInput && nameInput.value.trim() !== '') {
                    const playerName = nameInput.value.trim();
                    const resultCells = Array.from(row.querySelectorAll('td.col-inning'));
                    const results = resultCells.map(cell => {
                        const atBatBlocks = Array.from(cell.querySelectorAll('.at-bat-block'));
                        const atBatsString = atBatBlocks.map(block => {
                            const container = block.querySelector('.batting-result-container');
                            if (!container) return ''; 
                            const batterPlay = [
                                (block.querySelector('.mark-at-bat-btn')?.dataset.marked === 'true') ? 'â˜…:' : '',
                                container.querySelector('.result-strength').value,
                                container.querySelector('.result-direction').value,
                                container.querySelector('.result-type').value,
                                container.querySelector('.result-rbi').value,
                                container.querySelector('.result-runner-play').value
                            ].filter(Boolean).join('');
                            const runnerPlays = Array.from(block.querySelectorAll('.runner-play-input')).map(rpContainer => {
                                const name = rpContainer.querySelector('.runner-name').value;
                                const play = rpContainer.querySelector('.runner-play').value;
                                const base = rpContainer.querySelector('.runner-base').value;
                                if (!name || !play) return '';
                                return [name, play, base].filter(Boolean).join(' ');
                            }).filter(Boolean).join(','); 
                            return [batterPlay, runnerPlays].filter(Boolean).join(';');
                        }).join('ã€');
                        return atBatsString;
                    });
                    const playerData = {
                        order: row.dataset.order, name: playerName,
                        number: row.querySelector('.player-number').value,
                        throwBat: row.querySelector('.player-throw-bat')?.value,
                        pos: row.querySelector('.player-pos').value,
                        currentPos: row.querySelector('.player-pos').value, // â˜… currentPos ã‚’ä¿å­˜
                        posHistoryDisplay: row.querySelector('.text-xs.text-gray-500')?.title || '', // â˜… å±¥æ­´è¡¨ç¤ºã‚’ä¿å­˜
                        sub_type: row.querySelector('.sub-type-select') ? row.querySelector('.sub-type-select').value : null,
isCaptain: row.querySelector('.captain-btn')?.classList.contains('active') || false,
                        results: results
                    };
                    details.batting[teamKey].push(playerData);
                    if (!teamRecord.playerStats.batting[playerName]) {
                        teamRecord.playerStats.batting[playerName] = { games: 0, pa: 0, ab: 0, h: 0, hr: 0, rbi: 0, sb: 0, bb: 0, hbp: 0, sf: 0, tb: 0, r: 0, so: 0 };
                    }
                    const careerStats = teamRecord.playerStats.batting[playerName];
                    const isNonBattingSub = playerData.sub_type === 'DEF' || playerData.sub_type === 'PR';
                    const gameStats = { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0, sb: 0, bb: 0, hbp: 0, sf: 0, tb: 0, r: 0, so: 0, played: false, strongHits: 0, weakHits: 0, strongOuts: 0, weakOuts: 0 };
                    playerData.results.forEach(inningResultString => {
                        (inningResultString || '').split('ã€').forEach(atBatString => {
                            if (!atBatString) return;
                            const [batterPlay, runnerPlaysString] = atBatString.split(';');
                            if (batterPlay && batterPlay.trim() !== '') {
                                let cleanBatterPlay = batterPlay.trim().replace(/^â˜…:/, '');
                                const isHit = BATTING_RESULTS.hits.some(h => cleanBatterPlay.includes(h));
                                const isOut = BATTING_RESULTS.outs.some(o => cleanBatterPlay.includes(o)) || BATTING_RESULTS.sacrifices.some(s => cleanBatterPlay.includes(s));
                                if (cleanBatterPlay.startsWith('S:')) {
                                    if (isHit) gameStats.strongHits++; if (isOut) gameStats.strongOuts++;
                                    cleanBatterPlay = cleanBatterPlay.substring(2);
                                } else if (cleanBatterPlay.startsWith('W:')) {
                                    if (isHit) gameStats.weakHits++; if (isOut) gameStats.weakOuts++;
                                    cleanBatterPlay = cleanBatterPlay.substring(2);
                                }
                                gameStats.played = true; gameStats.pa++;
                                const isWalk = ['å››çƒ', 'æ­»çƒ', 'æ•¬é '].some(w => cleanBatterPlay.includes(w));
                                const isSac = ['çŠ é£›', 'çŠ æ‰“', 'çŠ å¤±'].some(w => cleanBatterPlay.includes(w));
                                if (!isWalk && !isSac && !cleanBatterPlay.includes('å¦¨å®³')) { gameStats.ab++; }
                                if (cleanBatterPlay.includes('å››çƒ') || cleanBatterPlay.includes('æ•¬é ')) gameStats.bb++;
                                if (cleanBatterPlay.includes('æ­»çƒ')) gameStats.hbp++;
                                if (cleanBatterPlay.includes('çŠ é£›')) gameStats.sf++;
                                if (cleanBatterPlay.includes('æœ¬å¡æ‰“')) { gameStats.h++; gameStats.tb += 4; gameStats.hr++; }
                                else if (cleanBatterPlay.includes('ä¸‰å¡æ‰“')) { gameStats.h++; gameStats.tb += 3; }
                                else if (cleanBatterPlay.includes('äºŒå¡æ‰“')) { gameStats.h++; gameStats.tb += 2; }
                                else if (cleanBatterPlay.includes('å®‰')) { gameStats.h++; gameStats.tb += 1; }
                                if (cleanBatterPlay.includes('ç‚¹')) { 
                                    const rbiValue = (cleanBatterPlay.match(/(\d+)ç‚¹/) || [0, 0])[1];
                                    gameStats.rbi += parseInt(rbiValue, 10);
                                }
                                if (cleanBatterPlay.includes('ä¸‰æŒ¯')) gameStats.so++;
                            }
                            (runnerPlaysString || '').split(',').forEach(runnerPlay => {
                                const parts = runnerPlay.split(' ');
                                if (parts[0] === playerName && parts[1] === 'ç›—å¡') { gameStats.sb++; }
                                if (parts[0] === playerName && (parts[1] === 'ç”Ÿé‚„' || (parts[1] === 'é€²å¡' && parts[2] === 'æœ¬å¡ã¸(ç”Ÿé‚„)'))) {
                                    gameStats.r++;
                                }
                            });
                        });
                    });
                    if((gameStats.played || isNonBattingSub) && !playersAppearedThisGame.has(playerName)) { 
                        careerStats.games++; 
                        playersAppearedThisGame.add(playerName);
                    }
                    for (const key of ['pa', 'ab', 'h', 'hr', 'rbi', 'sb', 'bb', 'hbp', 'sf', 'tb', 'r', 'so']) {
                        careerStats[key] = (careerStats[key] || 0) + gameStats[key];
                        if (teamRecord.tournamentStats) {
                            teamRecord.tournamentStats[key] = (teamRecord.tournamentStats[key] || 0) + gameStats[key];
                        }
                    }
                    details.playerGameStats[teamKey][playerName] = gameStats;
                    if (!careerStats.gamelogs) careerStats.gamelogs = [];
                    const opponentName = teamKey === 'team1' ? match.team2 : match.team1;
                    const opponentRank = opponentName ? calculateRank(opponentName, tournamentState) : 'E';
                    careerStats.gamelogs.push({
                        matchId: currentMatchIdForDetails,
                        date: match.schedule?.date || 'ä¸æ˜',
                        round: getRoundNameFromMatchId(currentMatchIdForDetails),
                        opponent: opponentName,
                        opponentRank: opponentRank,
                        order: playerData.order, 
                        sub_type: playerData.sub_type,
                        stats: gameStats 
                    });
                }
            });
        }
        const pitchingTable = document.getElementById(`pitching-table-${teamKey}`);
        if (pitchingTable) {
            pitchingTable.querySelectorAll('tbody tr').forEach(row => {
                const pitcherName = row.querySelector('.pitcher-name')?.value.trim(); 
                if (pitcherName && pitcherName !== '') {
                    const pitcherData = {
                        result: row.querySelector('.pitcher-result').value,
                        name: pitcherName, 
                        throwBat: row.querySelector('.pitcher-throw-bat').value,
                        throwStyle: row.querySelector('.pitcher-throw-style').value,
                        pitcherType: row.querySelector('.pitcher-type').value,
                        velocity: row.querySelector('.pitcher-velocity').value,
                        innings: row.querySelector('.pitcher-innings').value,
                        battersFaced: row.querySelector('.pitcher-batters').value,
                        pitches: row.querySelector('.pitcher-pitches').value,
                        hits: row.querySelector('.pitcher-hits').value, 
                        strikeouts: row.querySelector('.pitcher-so').value,
                        walks: row.querySelector('.pitcher-walks').value, 
                        runs: row.querySelector('.pitcher-runs').value,
                        earnedRuns: row.querySelector('.pitcher-er').value,
                    };
                    details.pitching[teamKey].push(pitcherData);
                    if (!teamRecord.playerStats.pitching[pitcherName]) {
                        teamRecord.playerStats.pitching[pitcherName] = { 
                            career: { games: 0, w: 0, l: 0, ip: 0, so: 0, er: 0, h: 0, bb: 0 },
                            gamelogs: []
                        };
                    }
                    const pStats = teamRecord.playerStats.pitching[pitcherName];
                    const careerStats = pStats.career;
                    if (pitcherData.name && !playersAppearedThisGame.has(pitcherName)) {
                        careerStats.games = (careerStats.games || 0) + 1;
                        playersAppearedThisGame.add(pitcherName);
                    }
                    if (pitcherData.battersFaced && parseInt(pitcherData.battersFaced) > 0) {
                        if (pitcherData.result === 'W') careerStats.w++;
                        if (pitcherData.result === 'L') careerStats.l--;
                        careerStats.ip += parseFloat(pitcherData.innings) || 0;
                        careerStats.so += parseInt(pitcherData.strikeouts) || 0;
                        careerStats.er += parseInt(pitcherData.earnedRuns) || 0;
                        careerStats.h = (careerStats.h || 0) + parseInt(pitcherData.hits || 0);
                        careerStats.bb = (careerStats.bb || 0) + parseInt(pitcherData.walks || 0);
                        const opponentName = teamKey === 'team1' ? match.team2 : match.team1;
                        const opponentRank = opponentName ? calculateRank(opponentName, tournamentState) : 'E';
                        pStats.gamelogs.push({
                            matchId: currentMatchIdForDetails,
                            date: match.schedule?.date || 'ä¸æ˜', 
                            round: getRoundNameFromMatchId(currentMatchIdForDetails),
                            opponent: opponentName,
                            opponentRank: opponentRank, 
                            result: pitcherData.result,
                            ip: pitcherData.innings,
                            h: pitcherData.hits,
                            bb: pitcherData.walks,
                            so: pitcherData.strikeouts,
                            r: pitcherData.runs,
                            er: pitcherData.earnedRuns
                        });
                    }
                }
            });
        }
    }
    for (const teamKey of ['team1', 'team2']) {
        const fieldingTable = document.getElementById(`fielding-table-${teamKey}`);
        if (fieldingTable) {
            fieldingTable.querySelectorAll('tbody tr').forEach(row => {
                const inning = row.querySelector('.fielding-inning')?.value;
                const player = row.querySelector('.player-name')?.value;
                const play = row.querySelector('.fielding-play')?.value;
                if (player && play) { 
                    details.fielding[teamKey].push({
                        inning: inning ? parseInt(inning) : null,
                        player: player,
                        play: play
                    });
                }
            });
        }
    }

    match.details = details;
    saveState();
    detailsModal.classList.add('hidden');
    renderTournament(tournamentState);
    alert('è©³ç´°ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * [UPDATED] æº–ã€…æ±ºå‹é€²å‡ºã®8ãƒãƒ¼ãƒ ã‚’åˆ†æã—ã€å±•æœ›è¨˜äº‹ã‚’AIã«ç”Ÿæˆã•ã›ã‚‹
 * (â˜…ãƒãƒ¼ãƒ æ•°ã«å¿œã˜ã¦å¯¾è±¡ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å‹•çš„ã«å¤‰æ›´)
 */
async function generateBest16PreviewArticle() {
    const state = tournamentState;
    if (!state.matches) return null;

    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: æº–ã€…æ±ºå‹ã®ãƒ©ã‚¦ãƒ³ãƒ‰ç•ªå·ã‚’è¨ˆç®— â˜…â˜…â˜…
    const numTeams = state.teams.length;
    const finalRound = Math.log2(numTeams); // 128->7, 64->6
    const roundNum = finalRound - 2; // æº–ã€…æ±ºå‹ (7-2=5, 6-2=4)
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    const matchIdsInRound = Object.keys(state.matches).filter(id => 
        id.includes(`-R${roundNum}-M`)
    );
    
    if (matchIdsInRound.length === 0) return null;

    let matchupsText = "";
    let cinderellaTeams = [];
    
    // (ä»¥ä¸‹ã€æ—¢å­˜ã®åˆ†æãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
    for (const matchId of matchIdsInRound) {
        const match = state.matches[matchId];
        if (!match.team1 || !match.team2) continue;

        const team1 = match.team1;
        const team2 = match.team2;
        const rank1 = calculateRank(team1, state);
        const rank2 = calculateRank(team2, state);
        
        matchupsText += `\n### ${getRoundNameFromMatchId(matchId)} ã‚«ãƒ¼ãƒ‰: ${team1} vs ${team2}\n`;
        
        [team1, team2].forEach(teamName => {
            const teamRecord = state.teamRecords[teamName];
            if (!teamRecord) return;
            
            const rank = calculateRank(teamName, state);
            const journey = getCurrentTournamentPerformance(teamName, matchId);
            const dynamicInfo = generateDynamicTeamInfo(teamName, TEAM_DATA[teamName], teamRecord);
            
            matchupsText += `- **${teamName}** (${rank}ãƒ©ãƒ³ã‚¯)\n`;
            matchupsText += `  - å‹ã¡ä¸ŠãŒã‚Š: ${journey}\n`;
            matchupsText += `  - ãƒãƒ¼ãƒ çŠ¶æ³: ${dynamicInfo}\n`;
            
            if (rank === 'C' || rank === 'D' || rank === 'E') {
                cinderellaTeams.push(`${teamName}(${rank})`);
            }
            
            let conditions = [];
            if (teamRecord.playerStats?.batting) {
                Object.values(teamRecord.playerStats.batting).forEach(p => {
                    if (p.narrative_flag && p.narrative_flag !== 'normal') {
                        conditions.push(`${p.name} (${getPlayerConditionIcon(p.narrative_flag)})`);
                    }
                });
            }
            if (teamRecord.playerStats?.pitching) {
                Object.values(teamRecord.playerStats.pitching).forEach(p => {
                    if (p.narrative_flag && p.narrative_flag !== 'normal') {
                        conditions.push(`${p.name} (${getPlayerConditionIcon(p.narrative_flag)})`);
                    }
                });
            }
            if (conditions.length > 0) {
                matchupsText += `  - ä¸»ãªé¸æ‰‹ã®èª¿å­: ${[...new Set(conditions)].join(', ')}\n`;
            }
        });
    }

    const prompt = `ã‚ãªãŸã¯ã€Œé™å²¡ ç†±é—˜ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ã€ã®ãƒ™ãƒ†ãƒ©ãƒ³è§£èª¬AIã§ã™ã€‚
${state.tournamentYear}å¹´åº¦ ${tournamentNameMap[state.currentTournament] || 'å¤§ä¼š'}ã¯ãƒ™ã‚¹ãƒˆ8ãŒæ±ºå®šã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®ã€æº–ã€…æ±ºå‹ã€‘ã®çµ„ã¿åˆã‚ã›ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€å…¨4è©¦åˆã®è¦‹ã©ã“ã‚ã‚’è§£èª¬ã™ã‚‹ã€ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãªã€Œå±•æœ›è¨˜äº‹ã€ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚

### å‚è€ƒï¼šå‹¢åŠ›å›³
${PREFECTURE_LORE}

### æº–ã€…æ±ºå‹ å…¨4è©¦åˆã®å¯¾æˆ¦ãƒ‡ãƒ¼ã‚¿
${matchupsText}

### åŸ·ç­†æŒ‡ç¤º
1.  **ã‚¿ã‚¤ãƒˆãƒ«:** ã€Œãƒ™ã‚¹ãƒˆ8æ¿€çªï¼æº–ã€…æ±ºå‹ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰ã‚’AIãŒå¾¹åº•åˆ†æï¼ã€ã®ã‚ˆã†ãªã€æœŸå¾…æ„Ÿã‚’ç…½ã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã«ã—ã¦ãã ã•ã„ã€‚
2.  **å°å…¥:** ãƒ™ã‚¹ãƒˆ8ãŒæ±ºå®šã—ãŸã“ã¨ã¸ã®èˆˆå¥®ã¨ã€ã“ã“ã‹ã‚‰ãŒæœ¬å½“ã®æˆ¦ã„ã§ã‚ã‚‹ã“ã¨ã‚’å®£è¨€ã—ã¦ãã ã•ã„ã€‚
3.  **ã€å¿«é€²æ’ƒã¸ã®è¨€åŠã€‘:**
    - ã‚‚ã— ${cinderellaTeams.length > 0 ? `å¿«é€²æ’ƒã‚’ç¶šã‘ã‚‹ãƒãƒ¼ãƒ ï¼ˆ${cinderellaTeams.join(', ')}ï¼‰` : 'å¿«é€²æ’ƒã®ãƒãƒ¼ãƒ '} ãŒã„ã‚‹å ´åˆã€å½¼ã‚‰ã®å¥é—˜ã‚’ã€Œä»Šå¤§ä¼šæœ€å¤§ã®ã‚µãƒ—ãƒ©ã‚¤ã‚ºã€ã¨ã—ã¦**å¿…ãš**ç§°è³›ã—ã¦ãã ã•ã„ã€‚
4.  **å„ã‚«ãƒ¼ãƒ‰åˆ†æ:**
    - å…¨4è©¦åˆã®è¦‹ã©ã“ã‚ã‚’è§£èª¬ã—ã¦ãã ã•ã„ã€‚
    - **ãƒ‡ãƒ¼ã‚¿æ´»ç”¨:** å„ãƒãƒ¼ãƒ ã®ã€Œä»Šå¤§ä¼šã®ãƒãƒ¼ãƒ æ‰“ç‡ã€ã‚„ã€Œé¸æ‰‹ã®èª¿å­ï¼ˆğŸ”¥, â„ï¸ï¼‰ã€ã‚’åˆ†æãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å¼•ç”¨ã—ã¦ãã ã•ã„ã€‚
5.  **ç· ã‚ããã‚Š:** æº–æ±ºå‹ã«é€²ã‚€ã®ã¯ã©ã®ãƒãƒ¼ãƒ ã‹ã€èª­è€…ã«å•ã„ã‹ã‘ã‚‹å½¢ã§è¨˜äº‹ã‚’ç· ã‚ããã£ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼ (JSON)
{"title": "ï¼ˆã“ã“ã«è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼‰", "body": "ï¼ˆã“ã“ã«è¨˜äº‹ã®æœ¬æ–‡ï¼‰"}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (article) {
                return { 
                    ...article, 
                    timestamp: Date.now(),
                    summaryType: 'best8',
                    context: { isBracketAnalysis: true }
                };
            }
        }
        throw new Error("AI best8 preview response format error.");
    } catch (error) {
        console.error(`AIæº–ã€…æ±ºå‹å±•æœ›è¨˜äº‹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:`, error);
        return { 
            title: "æº–ã€…æ±ºå‹ å±•æœ›è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼", body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 
            timestamp: Date.now(), error: true, errorId: `best8-preview-${Date.now()}`,
            summaryType: 'best8',
            context: { isBracketAnalysis: true }
        };
    }
}

/**
 * [ä¿®æ­£ç‰ˆ] ç›¸æ‰‹ãƒãƒ¼ãƒ ã®æ‰“æ’ƒæˆç¸¾ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€
 * å‘³æ–¹ãƒãƒ¼ãƒ ã®æŠ•æ‰‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã€Œã‚¤ãƒ‹ãƒ³ã‚°æ•°ã€ã«åŸºã¥ãã€æˆç¸¾ã‚’è‡ªå‹•ã§æŒ¯ã‚Šåˆ†ã‘ã‚‹
 * (â˜…è¢«å®‰æ‰“ãƒ»ä¸å››æ­»çƒãŒã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œãªã„ãƒã‚°ã‚’ä¿®æ­£)
 */
async function fillPitcherStatsFromBatting(pitchingTeamKey, battingTeamKey) {
    const battingTable = document.getElementById(`batting-table-${battingTeamKey}`);
    const pitchingTable = document.getElementById(`pitching-table-${pitchingTeamKey}`);
    const pitchingTableBody = pitchingTable?.querySelector('tbody');
    
    if (!battingTable || !pitchingTableBody) {
        alert("ã‚¨ãƒ©ãƒ¼: å¿…è¦ãªãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
        return;
    }

    // --- 1. æŠ•æ‰‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã€Œå…¨æŠ•æ‰‹ã€ã®ã€Œã‚¤ãƒ‹ãƒ³ã‚°æ•°ã€ã‚’å–å¾— ---
    const pitcherRows = Array.from(pitchingTableBody.querySelectorAll('tr'));
    const pitchersData = pitcherRows.map(row => {
        const name = row.querySelector('.pitcher-name')?.value.trim();
        const inningsStr = row.querySelector('.pitcher-innings')?.value.trim();
        const innings = parseFloat(inningsStr) || 0;
        
        // 6.1å› -> 19ã‚¢ã‚¦ãƒˆ, 6.2å› -> 20ã‚¢ã‚¦ãƒˆ, 6.0å› -> 18ã‚¢ã‚¦ãƒˆ
        const totalOuts = Math.floor(innings) * 3 + (innings % 1) * 10;
        
        return { rowElement: row, name, innings, totalOuts, stats: { bf: 0, h: 0, so: 0, walks: 0, r: 0 } };
    }).filter(p => p.name && p.innings); 

    if (pitchersData.length === 0) {
        alert("å…ˆã«æŠ•æ‰‹ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã€Œé¸æ‰‹åã€ã¨ã€Œå›æ•°ã€ï¼ˆä¾‹: 6.1 ã‚„ 9ï¼‰ã‚’æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    let cumulativeOuts = 0;
    pitchersData.forEach(p => {
        cumulativeOuts += p.totalOuts;
        p.cumulativeOuts = cumulativeOuts;
    });

    // --- 2. ç›¸æ‰‹æ‰“æ’ƒãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨æ‰“å¸­ã‚’ã€Œæ™‚ç³»åˆ—é †ã€ã«ä¸¦ã¹æ›¿ãˆã‚‹ ---
    const tempBattingData = [];
    battingTable.querySelectorAll('tbody tr').forEach(row => {
        const nameInput = row.querySelector('.player-name');
        if (nameInput && nameInput.value.trim() !== '') {
            tempBattingData.push({
                order: row.dataset.order,
                name: nameInput.value.trim(),
                results: Array.from(row.querySelectorAll('td.col-inning')).map(cell => {
                    return Array.from(cell.querySelectorAll('.at-bat-block')).map(block => {
                        const container = block.querySelector('.batting-result-container');
                        if (!container) return '';
                        return [
                            (block.querySelector('.mark-at-bat-btn')?.dataset.marked === 'true') ? 'â˜…:' : '',
                            container.querySelector('.result-strength').value,
                            container.querySelector('.result-direction').value,
                            container.querySelector('.result-type').value,
                            container.querySelector('.result-rbi').value,
                            container.querySelector('.result-runner-play').value
                        ].filter(Boolean).join('');
                    }).filter(Boolean).join('ã€');
                })
            });
        }
    });

    const sortedBattingOrder = tempBattingData.sort((a,b) => parseFloat(a.order.replace('-sub','.')) - parseFloat(b.order.replace('-sub','.')));
    const numInnings = battingTable.querySelector('thead tr').children.length - 7;
    let batterIndices = {}; 
    const allChronologicalPlays = []; 
    
    sortedBattingOrder.forEach((player, index) => {
        batterIndices[player.order] = index;
    });

    for (let i = 0; i < numInnings; i++) { 
        const startingBatterIndex = batterIndices[battingTeamKey] || 0;
        let currentBatterIndex = startingBatterIndex;
        let outsThisInning = 0;

        const playsInHalfInning = [];
        sortedBattingOrder.forEach(player => {
            const resultString = player.results?.[i];
            if (resultString) {
                resultString.split('ã€').forEach(atBat => {
                    if(atBat) playsInHalfInning.push({ player, atBat });
                });
            }
        });
        if (playsInHalfInning.length === 0) continue;

        const orderedPlays = [];
        let playsCount = 0;
        const atBatsTempCount = {};
        const processedFlags = new Array(playsInHalfInning.length).fill(false);
        while (orderedPlays.length < playsInHalfInning.length && playsCount < playsInHalfInning.length * 2) {
             const currentPlayer = sortedBattingOrder[currentBatterIndex];
             const playerOrderKey = currentPlayer.order;
             const currentAtBatOrdinal = atBatsTempCount[playerOrderKey] || 0;
             let foundPlayIndex = -1;
             let searchCount = 0;
             for(let k=0; k < playsInHalfInning.length; k++){
                 if(playsInHalfInning[k].player.order === playerOrderKey && !processedFlags[k]) {
                     if(searchCount === currentAtBatOrdinal) {
                         foundPlayIndex = k;
                         break;
                     }
                     searchCount++;
                 }
             }
             if (foundPlayIndex !== -1) {
                 orderedPlays.push(playsInHalfInning[foundPlayIndex]);
                 processedFlags[foundPlayIndex] = true;
                 atBatsTempCount[playerOrderKey] = currentAtBatOrdinal + 1;
                 currentBatterIndex = (currentBatterIndex + 1) % sortedBattingOrder.length;
             } else {
                 currentBatterIndex = (currentBatterIndex + 1) % sortedBattingOrder.length;
             }
             playsCount++;
        }
        const finalOrderedPlays = orderedPlays.length === playsInHalfInning.length ? orderedPlays : playsInHalfInning;
        
        finalOrderedPlays.forEach(play => {
            allChronologicalPlays.push(play);
            const [batterPlay] = play.atBat.split(';');
            const result = translatePlay(batterPlay);
            if (result.out) outsThisInning++;
            if (result.type === 'dp') outsThisInning++;
        });

        if (outsThisInning < 3 && finalOrderedPlays.length > 0) {
            const lastPlayer = finalOrderedPlays[finalOrderedPlays.length - 1].player;
            const lastBatterIndexInLineup = sortedBattingOrder.findIndex(p => p.order === lastPlayer.order);
            if (lastBatterIndexInLineup !== -1) {
                batterIndices[battingTeamKey] = (lastBatterIndexInLineup + 1) % sortedBattingOrder.length;
            }
        } else {
             batterIndices[battingTeamKey] = currentBatterIndex; 
        }
    }

    // --- 3. æ™‚ç³»åˆ—ãƒªã‚¹ãƒˆã‚’å‡¦ç†ã—ã€æˆç¸¾ã‚’æŒ¯ã‚Šåˆ†ã‘ã‚‹ ---
    let currentOuts = 0;
    
    allChronologicalPlays.forEach(play => {
        const [batterPlay, runnerPlaysString] = play.atBat.split(';');
        
        // (A) ã“ã®æ‰“å¸­ã‚’æ‹…å½“ã—ãŸæŠ•æ‰‹ã‚’è¦‹ã¤ã‘ã‚‹
        let currentPitcher = pitchersData.find(p => currentOuts < p.cumulativeOuts);
        if (!currentPitcher) {
            currentPitcher = pitchersData[pitchersData.length - 1]; 
        }
        
        const stats = currentPitcher.stats;
        stats.bf++; // æ‰“è€… +1
        
        if (batterPlay && batterPlay.trim() !== '') {
            let cleanBatterPlay = batterPlay.trim().replace(/^â˜…:/, '').replace(/^[SW]:/, '');
            
            // ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
            const result = translatePlay(batterPlay);
            if (result.out) currentOuts++;
            if (result.type === 'dp') currentOuts++;

            // â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘ è¢«å®‰æ‰“ãƒ»ä¸å››æ­»çƒã®ã‚«ã‚¦ãƒ³ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ â–¼â–¼â–¼
            // translatePlayã®çµæœ(è‹±èªã‚¿ã‚¤ãƒ—)ã§ã¯ãªãã€æ—¥æœ¬èªæ–‡å­—åˆ—(cleanBatterPlay)ã‚’ç›´æ¥ãƒã‚§ãƒƒã‚¯ã™ã‚‹
            
            // è¢«å®‰æ‰“
            const isHit = BATTING_RESULTS.hits.some(h => cleanBatterPlay.includes(h));
            if (isHit) stats.h++;

            // ä¸å››æ­»çƒ
            const isWalk = BATTING_RESULTS.walks.some(w => cleanBatterPlay.includes(w));
            if (isWalk) stats.walks++;
            
            // å¥ªä¸‰æŒ¯ (translatePlayã®çµæœã‚’ä½¿ç”¨)
            if (result.type === 'so') stats.so++;
            
            // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

            // å¤±ç‚¹ (æ‰“ç‚¹ã‹ã‚‰)
            if (cleanBatterPlay.includes('ç‚¹')) {
                const rbiValue = (cleanBatterPlay.match(/(\d+)ç‚¹/) || [0, 0])[1];
                stats.r += parseInt(rbiValue, 10);
            }
        }
        
        // å¤±ç‚¹ (èµ°å¡ãƒ—ãƒ¬ãƒ¼ã‹ã‚‰)
        (runnerPlaysString || '').split(',').forEach(runnerPlay => {
            const parts = runnerPlay.split(' ');
            if (parts.length < 2) return;
            const playType = parts[1];
            const base = parts[2] || '';
            
            if (playType === 'ç”Ÿé‚„' || (playType === 'é€²å¡' && base === 'æœ¬å¡ã¸(ç”Ÿé‚„)')) {
                if (!batterPlay.includes('ç‚¹') && !batterPlay.includes('æœ¬å¡æ‰“') && !batterPlay.includes('çŠ é£›')) {
                    stats.r++;
                }
            }
        });
    });

    // --- 4. ç¢ºèªã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º ---
    let confirmMessage = "ä»¥ä¸‹ã®å†…å®¹ã§æŠ•æ‰‹æˆç¸¾ã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã™ã‹ï¼Ÿ\n\n";
    pitchersData.forEach(p => {
        confirmMessage += 
            `â–¼ ${p.name} (${p.innings}å›)\n` +
            `  æ‰“è€…: ${p.stats.bf}äºº\n` +
            `  è¢«å®‰æ‰“: ${p.stats.h}æœ¬\n` +
            `  å¥ªä¸‰æŒ¯: ${p.stats.so}å€‹\n` +
            `  ä¸å››æ­»çƒ: ${p.stats.walks}å€‹\n` +
            `  å¤±ç‚¹: ${p.stats.r}ç‚¹\n\n`;
    });
    confirmMessage += "ï¼ˆæ³¨ï¼šè‡ªè²¬ç‚¹(ER)ã¨çƒæ•°ã¯æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰";

    const confirmed = confirm(confirmMessage);

    // --- 5. æŠ•æ‰‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¥åŠ›æ¬„ã«å€¤ã‚’è¨­å®š ---
    if (confirmed) {
        pitchersData.forEach(p => {
            const row = p.rowElement;
            row.querySelector('.pitcher-batters').value = p.stats.bf;
            row.querySelector('.pitcher-hits').value = p.stats.h;
            row.querySelector('.pitcher-so').value = p.stats.so;
            row.querySelector('.pitcher-walks').value = p.stats.walks;
            row.querySelector('.pitcher-runs').value = p.stats.r;
            row.querySelector('.pitcher-er').value = p.stats.r; 
        });
        
        alert("æŠ•æ‰‹æˆç¸¾ã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã—ãŸã€‚\nè‡ªè²¬ç‚¹(ER)ã¨çƒæ•°ã¯æ‰‹å‹•ã§ç¢ºèªãƒ»å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    }
}

/**
 * [ä¿®æ­£ç‰ˆ] è©³ç´°å…¥åŠ›ã®æ‰“å¸­çµæœæ–‡å­—åˆ—ã‚’ã€ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ç”¨ã®çŸ­ã„æ–‡å­—åˆ—ã«ç¿»è¨³ã™ã‚‹
 * (â˜…æ–‡å­—æ•°é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ã€ŒçŠ é£›ã€ãŒã€Œé£›ã€ã«èª¤åˆ¤å®šã•ã‚Œã‚‹ã®ã‚’é˜²ã)
 */
function translateResultForBoxScore(atBatString) {
    if (!atBatString) return "-";
    let tempRes = atBatString.trim();
    
    // 1. æ³¨ç›®ãƒ•ãƒ©ã‚°ã¨å‹¢ã„ãƒ•ãƒ©ã‚°ã‚’é™¤å»
    if (tempRes.startsWith('â˜…:')) tempRes = tempRes.substring(3);
    if (tempRes.startsWith('S:')) tempRes = tempRes.substring(2);
    if (tempRes.startsWith('W:')) tempRes = tempRes.substring(2);

    // 2. æ‰“ç‚¹ã¨èµ°å¡ãƒ—ãƒ¬ãƒ¼ã‚’é™¤å»
    tempRes = tempRes.replace(/(\d+ç‚¹)/, '');
    tempRes = tempRes.replace('å¥½èµ°å¡', '');
    
    // 3. æ–¹å‘+çµæœ (ä¾‹: ä¸­å®‰, éŠã‚´) ã‚’æŠ½å‡º
    // â˜…â˜…â˜… ä¿®æ­£: æ–‡å­—æ•°ã®å¤šã„é † (.sort((a, b) => b.length - a.length)) ã«ä¸¦ã¹æ›¿ãˆã¦ã‹ã‚‰åˆ¤å®šã™ã‚‹
    const allResultTypes = [ 
        ...BATTING_RESULTS.hits, 
        ...BATTING_RESULTS.outs, 
        ...BATTING_RESULTS.walks, 
        ...BATTING_RESULTS.sacrifices, 
        ...BATTING_RESULTS.other, 
        'æŒ¯ã‚Šé€ƒã’', 'æ‰“æ’ƒå¦¨å®³' 
    ].sort((a, b) => b.length - a.length);

    let foundResult = null;
    let foundDirection = '';

    for (const type of allResultTypes) {
        if (tempRes.includes(type)) {
            foundResult = type;
            tempRes = tempRes.replace(type, '').trim();
            break;
        }
    }
    
    if (tempRes.length > 0 && DIRECTIONS.includes(tempRes)) {
        foundDirection = tempRes;
    }

    if (foundResult) {
        if(foundResult === "å®‰") foundResult = "å®‰";
        return (foundDirection + foundResult).trim();
    }
    
    return "-";
}

// â–¼â–¼â–¼ å‹ç‡å¤‰å‹•ã‚°ãƒ©ãƒ•æ©Ÿèƒ½ â–¼â–¼â–¼

/**
 * å‹ç‡å¤‰å‹•ãƒ‡ãƒ¼ã‚¿ã‚’è¨ˆç®—ã™ã‚‹
 * @param {string} team1 - ãƒãƒ¼ãƒ 1ã®åå‰
 * @param {string} team2 - ãƒãƒ¼ãƒ 2ã®åå‰
 * @param {Array} scores1 - ãƒãƒ¼ãƒ 1ã®ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢é…åˆ—
 * @param {Array} scores2 - ãƒãƒ¼ãƒ 2ã®ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢é…åˆ—
 * @param {object} state - tournamentState
 */
function calculateWinProbData(team1, team2, scores1, scores2, state, dbMatch) {
    const rank1 = calculateRank(team1, state);
    const rank2 = calculateRank(team2, state);
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
    
    const rankDiff = rankValues[rank1] - rankValues[rank2];
    let initialProb = 0.5 + (rankDiff * 0.05);
    initialProb = Math.max(0.2, Math.min(0.8, initialProb));

    const dataPoints = [initialProb];
    const labels = ['é–‹å§‹'];

    let currentScore1 = 0;
    let currentScore2 = 0;

    // â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘ã‚³ãƒ¼ãƒ«ãƒ‰å›ãŒã‚ã‚Œã°ãã“ã¾ã§ã€ãªã‘ã‚Œã°æœ€ä½9å› â–¼â–¼â–¼
    let totalInnings = Math.max(scores1.length, scores2.length, 9);
    if (dbMatch && dbMatch.calledGame && dbMatch.calledInning) {
        totalInnings = dbMatch.calledInning;
    }
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    for (let i = 0; i < totalInnings; i++) {
        currentScore1 += parseInt(scores1[i] || 0);
        currentScore2 += parseInt(scores2[i] || 0);

        const scoreDiff = currentScore1 - currentScore2;
        
        // æ®‹ã‚Šã‚¤ãƒ‹ãƒ³ã‚°è¨ˆç®— (ã‚³ãƒ¼ãƒ«ãƒ‰ã®å ´åˆã¯æ®‹ã‚Š0ã«è¿‘ã¥ãã‚ˆã†ã«èª¿æ•´ã—ã¦ã‚‚è‰¯ã„ãŒã€ç°¡æ˜“çš„ã«9å›ãƒ™ãƒ¼ã‚¹ã§æ¸›è¡°ã•ã›ã‚‹)
        const inningsLeft = Math.max(0, 9 - (i + 1));
        
        let timeDecay = 1 + ((9 - inningsLeft) * 0.3); 
        let probChange = (scoreDiff * 0.1 * timeDecay);
        
        let currentProb = initialProb + probChange;
        
        // æœ€çµ‚å›ï¼ˆ9å›è£ã€ã¾ãŸã¯ã‚³ãƒ¼ãƒ«ãƒ‰æˆç«‹å›ï¼‰çµ‚äº†æ™‚ã¯ 0.0 or 1.0 ã«åæŸ
        if (i === totalInnings - 1) {
            currentProb = currentScore1 > currentScore2 ? 1.0 : 0.0;
        }

        currentProb = Math.max(0.0, Math.min(1.0, currentProb));
        
        dataPoints.push(currentProb);
        labels.push(`${i + 1}å›`);
    }

    return { labels, dataPoints };
}
/**
 * ã‚°ãƒ©ãƒ•ã‚’æç”»ã™ã‚‹ (Chart.jsã‚’ä½¿ç”¨)
 */
function renderWinProbChart(ctx, team1, team2, labels, dataPoints) {
    // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Œã°ç ´æ£„
    const existingChart = Chart.getChart(ctx);
    if (existingChart) existingChart.destroy();

    // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ä½œæˆ (50%ã‚’åŸºæº–ã«ä¸Šä¸‹ã•ã›ã‚‹)
    const team1Data = dataPoints.map(p => p * 100); // ãƒãƒ¼ãƒ 1ã®å‹ç‡%

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: `${team1}ã®å‹ç‡`,
                data: team1Data,
                borderColor: '#1d4ed8', // Blue
                backgroundColor: 'rgba(29, 78, 216, 0.1)',
                borderWidth: 2,
                pointRadius: 3,
                tension: 0.3, // æ›²ç·šã«ã™ã‚‹
                fill: {
                    target: 'origin',
                    above: 'rgba(29, 78, 216, 0.1)',   // ãƒãƒ¼ãƒ 1å„ªå‹¢ã‚¨ãƒªã‚¢
                    below: 'rgba(220, 38, 38, 0.1)'    // ãƒãƒ¼ãƒ 2å„ªå‹¢ã‚¨ãƒªã‚¢ (èµ¤)
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    grid: { color: (context) => context.tick.value === 50 ? '#000' : '#e5e7eb', lineWidth: (context) => context.tick.value === 50 ? 2 : 1 },
                    ticks: { callback: (v) => `${v}%` }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const val = context.raw;
                            const t1Win = val.toFixed(1);
                            const t2Win = (100 - val).toFixed(1);
                            return `${team1} ${t1Win}% - ${team2} ${t2Win}%`;
                        }
                    }
                },
                annotation: { // 50%ãƒ©ã‚¤ãƒ³
                    annotations: {
                        line1: {
                            type: 'line', yMin: 50, yMax: 50, borderColor: 'gray', borderWidth: 1, borderDash: [5, 5]
                        }
                    }
                }
            }
        }
    });
}
// â–²â–²â–² å‹ç‡ã‚°ãƒ©ãƒ•æ©Ÿèƒ½ ã“ã“ã¾ã§ â–²â–²â–²

/**
 * [ä¿®æ­£ãƒ»å®Œå…¨ç‰ˆ] è©¦åˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€Œä¸€çƒé€Ÿå ±ã€é¢¨ã®HTMLãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹
 * (â˜…ç†±ç‹‚åº¦ã®ç”¨é€”ã¨ç›®å®‰ã®è§£èª¬ã‚’è¿½åŠ )
 */
function generateBoxScoreHTML(dbMatch) {
    if (!dbMatch || !dbMatch.details) return "<p>è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
    
    const { details } = dbMatch;
    const team1Name = dbMatch.team1;
    const team2Name = dbMatch.team2;
    const score1 = parseInt(dbMatch.score1) || 0;
    const score2 = parseInt(dbMatch.score2) || 0;

    // --- 1. ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ ---
    let totalHits1 = 0;
    let totalHits2 = 0;
    if (details.playerGameStats) {
        Object.values(details.playerGameStats.team1 || {}).forEach(stats => totalHits1 += (stats.h || 0));
        Object.values(details.playerGameStats.team2 || {}).forEach(stats => totalHits2 += (stats.h || 0));
    }
    const totalErrors1 = 0; 
    const totalErrors2 = 0;

    const inningScores1 = details.inningScore?.team1 || [];
    const inningScores2 = details.inningScore?.team2 || [];
    
    let numInnings = Math.max(9, inningScores1.length, inningScores2.length);
    if (dbMatch.calledGame && dbMatch.calledInning) {
        numInnings = dbMatch.calledInning;
    }

    // --- 2. ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ç”Ÿæˆ ---
    let inningHeaders = '';
    let inningRow1 = '';
    let inningRow2 = '';
    
    let currentS1 = 0;
    let currentS2 = 0;
    let team1LeadOnce = false;
    let team2LeadOnce = false;
    let bigInningTeam1 = false;
    let bigInningTeam2 = false;

    for (let i = 1; i <= numInnings; i++) {
        inningHeaders += `<th>${i}</th>`;
        
        const s1_val = parseInt(inningScores1[i-1] || 0);
        const score1_display = (i <= inningScores1.length && inningScores1[i-1] !== '' && inningScores1[i-1] !== null) ? s1_val : '';
        
        currentS1 += (score1_display !== '' ? s1_val : 0);
        if (s1_val >= 4) bigInningTeam1 = true;
        if (currentS1 > currentS2) team1LeadOnce = true;

        let score2_display = '';
        let s2_val = 0;
        const rawS2 = inningScores2[i-1];
        const hasBottomData = (rawS2 !== '' && rawS2 !== null && rawS2 !== undefined);

        if (hasBottomData) {
            s2_val = parseInt(rawS2);
            currentS2 += s2_val;
        }
        
        if (s2_val >= 4) bigInningTeam2 = true;
        if (currentS2 > currentS1) team2LeadOnce = true;

        if (i === numInnings) {
            if (score2 > score1) {
                if (!hasBottomData) {
                    score2_display = 'X';
                } else {
                    score2_display = `${s2_val}x`;
                }
            } else {
                score2_display = hasBottomData ? s2_val : '';
            }
        } else {
            score2_display = hasBottomData ? s2_val : '';
        }
        
        inningRow1 += `<td class="score-cell">${score1_display}</td>`;
        inningRow2 += `<td class="score-cell">${score2_display}</td>`;
    }

    const scoreBoardHtml = `
        <table class="boxscore-table">
            <thead class="inning-header">
                <tr><th></th>${inningHeaders}<th>è¨ˆ</th><th>H</th><th>E</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td class="team-name">${team1Name}</td>
                    ${inningRow1}
                    <td class="total-score">${score1}</td>
                    <td class="total-score">${totalHits1}</td>
                    <td class="total-score">${totalErrors1}</td>
                </tr>
                <tr>
                    <td class="team-name">${team2Name}</td>
                    ${inningRow2}
                    <td class="total-score">${score2}</td>
                    <td class="total-score">${totalHits2}</td>
                    <td class="total-score">${totalErrors2}</td>
                </tr>
            </tbody>
        </table>
    `;

    // --- 3. ã‚¹ã‚¿ãƒƒãƒ„ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ ---
    const generateStatsTables = (teamKey) => {
        const teamName = dbMatch[teamKey];
        const battingData = details.batting?.[teamKey] || [];
        const gameStats = details.playerGameStats?.[teamKey] || {};
        const pitchingData = details.pitching?.[teamKey] || [];

        const sortedBatters = battingData.sort((a, b) => {
            const orderA = parseFloat(a.order.replace('-sub', '.'));
            const orderB = parseFloat(b.order.replace('-sub', '.'));
            return orderA - orderB;
        });

        let battingRows = '';
        let totalAB = 0, totalR = 0, totalH = 0, totalRBI = 0, totalSO = 0, totalBB = 0;
        
        sortedBatters.forEach(player => {
            if (!player.name) return;
            const stats = gameStats[player.name];
            if (!stats || (!stats.played && (stats.sb || 0) === 0 && player.sub_type !== 'DEF' && player.sub_type !== 'PR')) return;

            const isSub = player.order.includes('sub');
            const rowClass = isSub ? 'sub-player' : '';
            const playerName = player.name;
            const playerPos = player.currentPos || player.pos || '?';
            
            const ab = stats.ab || 0; const r = stats.r || 0; const h = stats.h || 0;
            const rbi = stats.rbi || 0; const so = stats.so || 0;
            const bb = (stats.bb || 0) + (stats.hbp || 0);
            
            totalAB += ab; totalR += r; totalH += h; totalRBI += rbi; totalSO += so; totalBB += bb;

            const resultsText = player.results.map(inningResults => 
                inningResults.split('ã€').map(atBat => translateResultForBoxScore(atBat)).filter(res => res !== '-')
            ).flat().join(', ');

            let orderDisplay = isSub ? (player.sub_type === 'PH' ? 'æ‰“' : (player.sub_type === 'PR' ? 'èµ°' : 'å®ˆ')) : player.order;

            battingRows += `
                <tr class="${rowClass}">
                    <td class="pos">${orderDisplay} ${playerPos}</td>
                    <td class="player">${playerName}</td>
                    <td class="at-bat">${ab}</td><td class="runs">${r}</td><td class="hits">${h}</td><td class="rbi">${rbi}</td>
                    <td class="so">${so}</td><td class="walks">${bb}</td><td class="results">${resultsText || '-'}</td>
                </tr>`;
        });
        
        const battingTableHtml = `
            <h3 class="text-xl font-bold mt-6 mb-2 text-gray-800">${teamName}</h3>
            <table class="batting-stats-table">
                <thead>
                    <tr>
                        <th class="pos"></th><th class="player">é¸æ‰‹å</th>
                        <th class="at-bat">æ‰“</th><th class="runs">å¾—</th><th class="hits">å®‰</th><th class="rbi">ç‚¹</th>
                        <th class="so">ä¸‰</th><th class="walks">å››</th><th class="results">æ‰“å¸­çµæœ</th>
                    </tr>
                </thead>
                <tbody>
                    ${battingRows}
                    <tr class="team-totals">
                        <td class="player" colspan="2">åˆè¨ˆ</td>
                        <td class="at-bat">${totalAB}</td><td class="runs">${totalR}</td><td class="hits">${totalH}</td><td class="rbi">${totalRBI}</td>
                        <td class="so">${totalSO}</td><td class="walks">${totalBB}</td><td class="results"></td>
                    </tr>
                </tbody>
            </table>
        `;

        let pitchingRows = '';
        if (pitchingData.length > 0) {
            pitchingData.forEach(p => {
                if (!p.name || !p.innings) return;
                const ip = parseFloat(p.innings) || 0;
                const er = parseInt(p.earnedRuns) || 0;
                const era = (ip > 0) ? ((er * 9) / ip).toFixed(2) : "0.00";
                const resultMark = {'W': 'â—‹', 'L': 'â—', 'S': 'ï¼³', 'H': 'ï¼¨'}[p.result] || '';
                
                pitchingRows += `
                    <tr>
                        <td class="result">${resultMark}</td>
                        <td class="player">${p.name}</td>
                        <td class="ip">${p.innings}</td>
                        <td class="bf">${p.battersFaced || '-'}</td>
                        <td class="hits">${p.hits || '0'}</td>
                        <td class="so">${p.strikeouts || '0'}</td>
                        <td class="walks">${p.walks || '0'}</td>
                        <td class="runs">${p.runs || '0'}</td>
                        <td class="er">${p.earnedRuns || '0'}</td>
                        <td class="era">${era}</td>
                    </tr>`;
            });
        }
        
        const pitchingTableHtml = `
            <table class="pitching-stats-table">
                <thead><tr><th class="result"></th><th class="player">æŠ•æ‰‹å</th><th class="ip">å›</th><th class="bf">æ‰“è€…</th><th class="hits">å®‰</th><th class="so">ä¸‰</th><th class="walks">å››</th><th class="runs">å¤±</th><th class="er">è‡ª</th><th class="era">é˜²å¾¡ç‡</th></tr></thead>
                <tbody>${pitchingRows}</tbody>
            </table>
        `;
        return battingTableHtml + pitchingTableHtml;
    };

    // --- 4. ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ (â˜…è§£èª¬ã‚’è¿½åŠ ) ---
    const chartHtml = `
        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-4 bg-white border rounded-lg shadow-sm">
                <h3 class="text-lg font-bold text-blue-700 mb-2">ğŸ“‰ å‹ç‡å¤‰å‹• (Win Probability)</h3>
                <div style="height: 200px; width: 100%;">
                    <canvas id="win-prob-chart"></canvas>
                </div>
                <p class="text-xs text-gray-500 mt-2">â€»ç‚¹å·®ã€æ®‹ã‚Šã‚¤ãƒ‹ãƒ³ã‚°ã€æˆ¦åŠ›å·®ã‹ã‚‰ç®—å‡ºã—ãŸå‹åˆ©ç¢ºç‡ã®æ¨ç§»ã€‚</p>
            </div>
            <div class="p-4 bg-white border rounded-lg shadow-sm">
                <h3 class="text-lg font-bold text-orange-600 mb-2 flex justify-between">
                    <span>ğŸ”¥ ç†±ç‹‚åº¦æ¨ç§» (Excitement)</span>
                    <span id="excitement-rank-badge" class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded">é›†è¨ˆä¸­...</span>
                </h3>
                <div style="height: 200px; width: 100%;">
                    <canvas id="excitement-chart"></canvas>
                </div>
                
                <div class="mt-3 p-2 bg-orange-50 rounded border border-orange-100 text-xs text-gray-700">
                    <p class="font-bold mb-1 text-orange-800">ğŸ“Š ç†±ç‹‚åº¦ã¨ã¯ï¼Ÿ</p>
                    <p class="mb-2">è©¦åˆã®ã€Œé¢ç™½ã•ã€ã‚„ã€Œãƒ‰ãƒ©ãƒæ€§ã€ã‚’æ•°å€¤åŒ–ã—ãŸæŒ‡æ¨™ã§ã™ã€‚ç‚¹å·®ãŒç¸®ã¾ã‚‹ã€é€†è»¢ã€æ ¼ä¸‹ã®å–„æˆ¦ãªã©ã§æ•°å€¤ãŒä¸Šæ˜‡ã—ã¾ã™ã€‚</p>
                    <div class="grid grid-cols-2 gap-1">
                        <div><span class="font-bold text-red-600">S (35~):</span> ä¼èª¬ã®åå‹è² ãƒ»å¥‡è·¡</div>
                        <div><span class="font-bold text-orange-600">A (25~):</span> æ¿€ç†±ãƒ»ã‚·ãƒ¼ã‚½ãƒ¼ã‚²ãƒ¼ãƒ </div>
                        <div><span class="font-bold text-blue-600">B (15~):</span> å¥½ã‚²ãƒ¼ãƒ ãƒ»æ¥æˆ¦</div>
                        <div><span class="font-bold text-gray-500">C (~15):</span> å‡¡æˆ¦ãƒ»ãƒ¯ãƒ³ã‚µã‚¤ãƒ‰</div>
                    </div>
                </div>
                </div>
        </div>
    `;

    // --- 5. AIæˆ¦è©• (æ—¢å­˜ã®ã¾ã¾) ---
    const winner = dbMatch.winner || "ä¸æ˜";
    const loser = dbMatch.team1 === winner ? dbMatch.team2 : dbMatch.team1;
    const wScore = parseInt(dbMatch.team1 === winner ? score1 : score2);
    const lScore = parseInt(dbMatch.team1 === winner ? score2 : score1);
    const diff = wScore - lScore;
    const totalHits = totalHits1 + totalHits2;
    const isWinnerTeam1 = (winner === team1Name);
    const wHits = isWinnerTeam1 ? totalHits1 : totalHits2;
    const lHits = isWinnerTeam1 ? totalHits2 : totalHits1;
    const isComeback = (isWinnerTeam1 && team2LeadOnce) || (!isWinnerTeam1 && team1LeadOnce);

    let commentTitle = "è©¦åˆç·æ‹¬";
    let commentBody = "";
    let badgeColor = "bg-gray-100 text-gray-800";

    // æˆ¦è©•ã®æ¡ä»¶åˆ†å²
    if (numInnings >= 9 && isWinnerTeam1 === false && parseInt(inningScores2[numInnings-1]) > 0 && (score2 - parseInt(inningScores2[numInnings-1]) <= score1)) {
        commentTitle = "åŠ‡çš„ã‚µãƒ¨ãƒŠãƒ©";
        badgeColor = "bg-pink-100 text-pink-800 border border-pink-300";
        commentBody = `åŠ‡çš„ãªå¹•åˆ‡ã‚Œï¼ ${winner}ãŒåœŸå£‡å ´ã§å‹è² å¼·ã•ã‚’ç™ºæ®ã—ã€${loser}ã¨ã®ç†±æˆ¦ã«ã‚µãƒ¨ãƒŠãƒ©ã§çµ‚æ­¢ç¬¦ã‚’æ‰“ã£ãŸã€‚`;
    } else if (lScore === 0) {
        commentTitle = "å®Œå°å‹åˆ©";
        badgeColor = "bg-blue-100 text-blue-800 border border-blue-300";
        commentBody = `${winner}æŠ•æ‰‹é™£ãŒ${loser}æ‰“ç·šã‚’æ•£ç™º${lHits}å®‰æ‰“ã«æŠ‘ãˆè¾¼ã¿ã€è¦‹äº‹ãªå®Œå°ãƒªãƒ¬ãƒ¼ã‚’å®Œæˆã•ã›ãŸã€‚`;
    } else if (diff >= 7) {
        commentTitle = "åœ§å€’";
        badgeColor = "bg-red-100 text-red-800 border border-red-300";
        const attackType = (bigInningTeam1 || bigInningTeam2) ? "ãƒ“ãƒƒã‚°ã‚¤ãƒ‹ãƒ³ã‚°ã‚’ä½œã‚‹ãªã©æ‰“ç·šãŒçˆ†ç™ºã€‚" : "ç€å®Ÿã«åŠ ç‚¹ã—ã€";
        commentBody = `${winner}ãŒæŠ•æ‰“ã«${loser}ã‚’åœ§å€’ã€‚${attackType}ç›¸æ‰‹ã«ä»˜ã‘å…¥ã‚‹éš™ã‚’ä¸ãˆãªã‹ã£ãŸã€‚`;
    } else if (isComeback) {
        commentTitle = "é€†è»¢å‹åˆ©";
        badgeColor = "bg-green-100 text-green-800 border border-green-300";
        commentBody = `å…ˆåˆ¶ã‚’è¨±ã™è‹¦ã—ã„å±•é–‹ã ã£ãŸãŒã€${winner}ãŒç²˜ã‚Šå¼·ãåæ’ƒã€‚ä¸­ç›¤ä»¥é™ã«è©¦åˆã‚’ã²ã£ãã‚Šè¿”ã—ã€è¦‹äº‹ãªé€†è»¢å‹åˆ©ã‚’åã‚ãŸã€‚`;
    } else if (totalHits >= 20 || (wScore + lScore) >= 13) {
        commentTitle = "ä¹±æ‰“æˆ¦";
        badgeColor = "bg-purple-100 text-purple-800 border border-purple-300";
        commentBody = `ä¸¡ãƒãƒ¼ãƒ åˆã‚ã›ã¦${totalHits}å®‰æ‰“ãŒé£›ã³äº¤ã†æ¿€ã—ã„æ‰“ã¡åˆã„ã¨ãªã£ãŸã€‚å–ã‚‰ã‚ŒãŸã‚‰å–ã‚Šè¿”ã™ã‚·ãƒ¼ã‚½ãƒ¼ã‚²ãƒ¼ãƒ ã‚’åˆ¶ã—ãŸã®ã¯${winner}ã€‚`;
    } else if ((wScore + lScore) <= 5 && totalHits <= 12) {
        commentTitle = "æŠ•æ‰‹æˆ¦";
        badgeColor = "bg-gray-100 text-gray-800 border border-gray-400";
        commentBody = `äº’ã„ã®æŠ•æ‰‹ãŒæŒã¡å‘³ã‚’ç™ºæ®ã—ã€ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã«0ãŒä¸¦ã¶ç·Šè¿«ã—ãŸæŠ•æ‰‹æˆ¦ã¨ãªã£ãŸã€‚æ•°å°‘ãªã„ãƒãƒ£ãƒ³ã‚¹ã‚’ç¢ºå®Ÿã«ã‚‚ã®ã«ã—ãŸ${winner}ãŒå‹åˆ©ã€‚`;
    } else if (lHits > wHits) {
        commentTitle = "å‹è² å¼·ã•";
        badgeColor = "bg-yellow-100 text-yellow-800 border border-yellow-300";
        commentBody = `${loser}ã¯${winner}ã‚’ä¸Šå›ã‚‹${lHits}å®‰æ‰“ã‚’æ”¾ã¡ãªãŒã‚‰ã‚‚ã€è¦æ‰€ã§ã®ä¸€æœ¬ãŒå‡ºãšæ®‹å¡ã®å±±ã‚’ç¯‰ã„ãŸã€‚å¯¾ã™ã‚‹${winner}ã¯å°‘ãªã„å¥½æ©Ÿã‚’æ´»ã‹ã—ãŸã€‚`;
    } else if (diff <= 2) {
        commentTitle = "å¤§æ¥æˆ¦";
        badgeColor = "bg-orange-100 text-orange-800 border border-orange-300";
        commentBody = `æœ€å¾Œã¾ã§ã©ã¡ã‚‰ãŒå‹ã¤ã‹åˆ†ã‹ã‚‰ãªã„å¥½ã‚²ãƒ¼ãƒ ã€‚${winner}ãŒ${loser}ã®çŒ›è¿½ã‚’ã‚ãšã‹ãªå·®ã§æŒ¯ã‚Šåˆ‡ã£ãŸã€‚`;
    } else {
        commentTitle = "å¿«å‹";
        badgeColor = "bg-blue-50 text-blue-600 border border-blue-200";
        commentBody = `${winner}ãŒçµ‚å§‹è©¦åˆã®ä¸»å°æ¨©ã‚’æ¡ã‚Šã€${loser}ã«å‹åˆ©ã—ãŸã€‚æŠ•æ‰“ã®ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ãã€å±ãªã’ãªã„è©¦åˆé‹ã³ã‚’è¦‹ã›ãŸã€‚`;
    }

    if (dbMatch.summary) {
        commentBody += `<br><span class="text-xs text-gray-500 mt-3 block border-t pt-2">ğŸ“ <strong>ç›£ç£ãƒ¡ãƒ¢:</strong> ${dbMatch.summary}</span>`;
    }

    const aiCommentHtml = `
        <div class="mt-6 bg-white border border-gray-200 rounded-lg p-4 shadow-sm border-l-4 border-indigo-500">
            <div class="flex items-center mb-2">
                <span class="text-2xl mr-2">ğŸ¤–</span>
                <h3 class="font-bold text-gray-800">AIæˆ¦è©•: <span class="text-sm px-2 py-0.5 rounded ${badgeColor} ml-1">${commentTitle}</span></h3>
            </div>
            <p class="text-sm text-gray-700 leading-relaxed">${commentBody}</p>
        </div>
    `;

    return scoreBoardHtml + generateStatsTables('team1') + generateStatsTables('team2') + chartHtml + aiCommentHtml;
}


/**
 * [æ–°æ©Ÿèƒ½] ã‚ã‚‹ãƒãƒ¼ãƒ ã®ã€æŒ‡å®šã•ã‚ŒãŸè©¦åˆIDã€Œä»¥å‰ã€ã®
 * å…¨è©¦åˆã®ã‚¹ã‚¿ãƒ¡ãƒ³å±¥æ­´ã‚’æ™‚ç³»åˆ—ã§å–å¾—ã™ã‚‹
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 * @param {string} currentMatchId - ç¾åœ¨ã®è©¦åˆID (ã“ã‚Œã‚ˆã‚Šå‰ã®å±¥æ­´ã‚’å–å¾—ã™ã‚‹)
 * @returns {Array<object>} - [{ matchId, roundName, starters: [...] }, ...]
 */
function getStarterHistory(teamName, currentMatchId) {
    const history = [];
    
    // 1. å…¨è©¦åˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚­ãƒ£ãƒ³
    const allMatches = { 
        ...tournamentState.matches, 
        ...(tournamentState.autumnData?.allMatches || {}),
        ...(tournamentState.springData?.allMatches || {}) 
    };
    
    const targetMatch = allMatches[currentMatchId];
    // ç¾åœ¨ã®è©¦åˆã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚­ãƒ¼ã‚’å–å¾— (ä¾‹: 1, 2, 100)
    const currentRoundSortKey = targetMatch?.roundSortKey || getRoundSortKey(currentMatchId);

    // 2. ãƒãƒ¼ãƒ ãŒé–¢ã‚ã‚Šã€ã‹ã¤ã€Œç¾åœ¨ã‚ˆã‚Šå‰ã€ã®è©¦åˆã‚’åé›†
    for (const matchId in allMatches) {
        // ç¾åœ¨ã®è©¦åˆè‡ªä½“ã¯é™¤å¤–
        if (matchId === currentMatchId) continue;
        
        const match = allMatches[matchId];
        const teamKey = match.team1 === teamName ? 'team1' : (match.team2 === teamName ? 'team2' : null);
        
        // æ¡ä»¶ï¼šãƒãƒ¼ãƒ ãŒé–¢ã‚ã£ã¦ã„ã‚‹ AND å‹è€…ãŒæ±ºã¾ã£ã¦ã„ã‚‹ AND è©³ç´°å…¥åŠ›ãŒã‚ã‚‹
        if (teamKey && match.winner && match.details && match.details.batting && match.details.batting[teamKey]) {
            
            const matchRoundSortKey = getRoundSortKey(matchId);
            
            // â˜…ç¾åœ¨ã®è©¦åˆã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚­ãƒ¼ã‚ˆã‚Šã€Œå°ã•ã„ã€è©¦åˆã®ã¿ã‚’å±¥æ­´ã«è¿½åŠ 
            if (matchRoundSortKey < currentRoundSortKey) {
                const starters = match.details.batting[teamKey]
                    .filter(p => p.order && !p.order.toString().includes('sub') && parseInt(p.order) >= 1 && parseInt(p.order) <= 9)
                    .map(p => p.name); // åå‰ã ã‘ã®é…åˆ—ã«ã™ã‚‹
                
                history.push({
                    matchId: matchId,
                    roundSortKey: matchRoundSortKey,
                    roundName: getRoundNameFromMatchId(matchId),
                    starters: starters
                });
            }
        }
    }
    
    // 3. ãƒ©ã‚¦ãƒ³ãƒ‰é †ã«ã‚½ãƒ¼ãƒˆã—ã¦è¿”ã™
    history.sort((a, b) => a.roundSortKey - b.roundSortKey);
    return history;
}

/**
 * è©¦åˆIDã‹ã‚‰ã‚½ãƒ¼ãƒˆç”¨ã®æ•°å€¤ã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹ (getStarterHistoryã®ãƒ˜ãƒ«ãƒ‘ãƒ¼)
 */
function getRoundSortKey(matchId) {
    if (!matchId) return 999;
    if (matchId.includes('-R')) {
        // 'L-R1-M1' -> 1
        return parseInt(matchId.split('-R')[1].split('-')[0]);
    }
    if (matchId.startsWith('F-')) {
        return 100; // æ±ºå‹
    }
    if (matchId.includes('-SB') || matchId.includes('-SREP') || matchId.includes('-SIZU') || matchId.includes('AUTUMN')) {
        return -1; // åœ°åŒºäºˆé¸ã¯æœ¬æˆ¦ã‚ˆã‚Šå‰
    }
    return 999;
}
// â–²â–²â–² è²¼ã‚Šä»˜ã‘ã“ã“ã¾ã§ â–²â–²â–²

/**
     * ã€ä¿®æ­£ç‰ˆã€‘ã‚¹ã‚­ãƒƒãƒ—æ©Ÿèƒ½é–¢é€£
     */
    function generateAutoScore(rankWinner, rankLoser) {
        const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
        const diff = rankValues[rankWinner] - rankValues[rankLoser];
        let winnerScore, loserScore;

        if (diff >= 3) { // å¤§å·®
            winnerScore = 7 + Math.floor(Math.random() * 4);
            loserScore = Math.floor(Math.random() * 3);
        } else if (diff >= 2) { // ä¸­å·®
            winnerScore = 5 + Math.floor(Math.random() * 3);
            loserScore = Math.max(0, winnerScore - (3 + Math.floor(Math.random() * 2)));
        } else if (diff >= 1) { // å°å·®
            winnerScore = 3 + Math.floor(Math.random() * 4);
            loserScore = Math.max(0, winnerScore - (1 + Math.floor(Math.random() * 2)));
        } else { // åŒãƒ©ãƒ³ã‚¯
            winnerScore = 2 + Math.floor(Math.random() * 5);
            loserScore = winnerScore - 1;
        }
        return [winnerScore, loserScore];
    }

   /**
     * ã€ä¿®æ­£ç‰ˆã€‘ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’è‡ªå‹•ã§ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
     * (â˜…æ–°èç”Ÿæˆãƒ•ãƒƒã‚¯ã€çµæœåé›†æ©Ÿèƒ½ã€ç”²å­åœ’ãƒœã‚¹å¿…å‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ±åˆ)
     */
    async function skipRound(roundNumber) {
        const btnId = `skip-r${roundNumber}-btn`;
        const btn = document.getElementById(btnId);
        if (btn) {
            btn.disabled = true;
            btn.textContent = `é€²è¡Œä¸­...(${roundNumber}å›æˆ¦)`;
        }
        skipLoader.classList.remove('hidden');

        // â˜… 128ãƒãƒ¼ãƒ åˆ¶ã«å¯¾å¿œ
        const numTeams = tournamentState.teams.length;
        const numMatchesInRoundSide = (numTeams / 2) / Math.pow(2, roundNumber - 1); // R1=32, R2=16...

        const matchIds = [];
        ['L', 'R'].forEach(side => {
            for (let i = 1; i <= numMatchesInRoundSide; i++) {
                matchIds.push(`${side}-R${roundNumber}-M${i}`);
            }
        });

        // â˜…â˜…â˜… ã‚¹ã‚­ãƒƒãƒ—ã—ãŸè©¦åˆã®çµæœã‚’åé›†ã™ã‚‹é…åˆ— â˜…â˜…â˜…
        const roundResults = [];

        // --- ã‚¹ãƒ†ãƒƒãƒ—1ï¼šãƒ©ã‚¦ãƒ³ãƒ‰ã®å…¨è©¦åˆã®å‹æ•—ã‚’æ±ºå®š ---
        for (const matchId of matchIds) {
            const match = tournamentState.matches[matchId];
            
            if (!match || match.winner || !match.team1 || !match.team2) {
                continue;
            }

            // â˜…â˜…â˜… BYE(ä¸æˆ¦å‹)ã®å‡¦ç† â˜…â˜…â˜…
            if (match.team1 === '(BYE)') {
                await processMatchWin(matchId, match.team2); // team2ã®ä¸æˆ¦å‹
                continue;
            }
            if (match.team2 === '(BYE)') {
                await processMatchWin(matchId, match.team1); // team1ã®ä¸æˆ¦å‹
                continue;
            }
            // â˜…â˜…â˜… BYEå‡¦ç†ã“ã“ã¾ã§ â˜…â˜…â˜…

            const { team1, team2 } = match;
            const rank1 = calculateRank(team1, tournamentState);
            const rank2 = calculateRank(team2, tournamentState);
            const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
            let winnerName;

            // â˜…â˜…â˜… ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰ï¼šãƒœã‚¹ãƒãƒ¼ãƒ å¼·åˆ¶å‹åˆ©ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
            const bossTeams = ["èŠ±å·»æ±", "æ¨ªæµœ", "å ±å¾³å­¦åœ’", "æµ¦å’Œå­¦é™¢", "å¤§é˜ªæ¡è”­", "æ—¥å¤§ä¸‰"];
            const isKoshien = tournamentState.currentTournament === 'summer_koshien';
            const playerTeam = tournamentState.teams[0]; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯Index 0ã«ã„ã‚‹å‰æ

            if (isKoshien) {
                // ã©ã¡ã‚‰ã‹ãŒãƒœã‚¹ã§ã€ã‚‚ã†ç‰‡æ–¹ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼(283å­¦åœ’)ã§ãªã„å ´åˆã€ãƒœã‚¹ã‚’å‹ãŸã›ã‚‹
                if (bossTeams.includes(team1) && team2 !== playerTeam) {
                    winnerName = team1; // ãƒœã‚¹1ã®å‹ã¡
                } else if (bossTeams.includes(team2) && team1 !== playerTeam) {
                    winnerName = team2; // ãƒœã‚¹2ã®å‹ã¡
                } 
                // ãƒœã‚¹åŒå£«ã®å¯¾æ±ºã€ã‚ã‚‹ã„ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¯¾ãƒœã‚¹ã®å ´åˆã¯é€šå¸¸ãƒ­ã‚¸ãƒƒã‚¯ã¸ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯è‡ªåŠ›ã§å‹ã¤å¿…è¦ãŒã‚ã‚‹ãŸã‚ï¼‰
            }
            // â˜…â˜…â˜… ã“ã“ã¾ã§ â˜…â˜…â˜…
            
            // ã¾ã å‹è€…ãŒæ±ºã¾ã£ã¦ã„ãªã„å ´åˆï¼ˆé€šå¸¸ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
            if (!winnerName) {
                const upsetChance = 0.15 - (Math.abs(rankValues[rank1] - rankValues[rank2]) * 0.03);
                
                if (Math.random() < upsetChance) { // ç•ªç‹‚ã‚ã›
                    winnerName = rankValues[rank1] < rankValues[rank2] ? team1 : team2;
                } else { // é †å½“
                    winnerName = rankValues[rank1] >= rankValues[rank2] ? team1 : team2;
                }
            }

            const loserName = winnerName === team1 ? team2 : team1;
            
            const winnerRank = calculateRank(winnerName, tournamentState);
            const loserRank = calculateRank(loserName, tournamentState);

            const [winnerScore, loserScore] = generateAutoScore(winnerRank, loserRank);

            match.score1 = (match.team1 === winnerName) ? winnerScore : loserScore;
            match.score2 = (match.team2 === winnerName) ? winnerScore : loserScore;
            
            // â˜… çµæœã‚’åé›†
            roundResults.push({
                matchId, winnerName, loserName, winnerScore, loserScore,
                winnerRank, loserRank, rankDiff: rankValues[winnerRank] - rankValues[loserRank]
            });

            await processMatchWin(matchId, winnerName);
        }
        
        renderTournament(tournamentState);
        renderNews(tournamentState.news); 
        
        // â˜…â˜…â˜… ã‚¹ãƒ†ãƒƒãƒ—2ï¼šæ–°èã‚’ç”Ÿæˆãƒ»è¡¨ç¤º (è¨­å®šOFFã§ã‚‚ã‚¹ã‚­ãƒƒãƒ—æ–°èã¯è¡¨ç¤º) â˜…â˜…â˜…
        if (roundResults.length > 0) {
            await generateSkipRoundNewspaper(roundNumber, roundResults);
        }
        // â˜…â˜…â˜… æ–°èç”Ÿæˆãƒ•ãƒƒã‚¯ã“ã“ã¾ã§ â˜…â˜…â˜…

        saveState();
        
        if (btn) {
            btn.classList.add('hidden');
            btn.disabled = false;
            btn.textContent = `${roundNumber}å›æˆ¦ã‚¹ã‚­ãƒƒãƒ—`;
        }
        skipLoader.classList.add('hidden');
    }
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

// --- NEW Autumn Tournament System ---

 /**
 * [ç§‹å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸1] åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸ã‚’é–‹å§‹ã™ã‚‹
 * (â˜…æ–°ä»•æ§˜: 3åœ°åŒº å¤§è¦æ¨¡ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ + æ•—è€…å¾©æ´»æˆ¦ æ–¹å¼)
 */
async function setupAutumnRegionalBlocks() {
    tournamentState.autumnPhase = 'regional_blocks';
    
    // 1. å…¨ãƒãƒ¼ãƒ ã‚’åœ°åŒºåˆ¥ã«æŒ¯ã‚Šåˆ†ã‘
    const teamsByRegion = { 'æ±éƒ¨': [], 'ä¸­éƒ¨': [], 'è¥¿éƒ¨': [], 'ä¼Šè±†': [] };
    INITIAL_TEAM_POOL.forEach(teamName => {
        const region = TEAM_DATA[teamName]?.region;
        if (region && teamsByRegion[region]) {
            teamsByRegion[region].push(teamName);
        }
    });

    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒæ–°ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
    // 2. ã€Œæ±éƒ¨ãƒ»ä¼Šè±†ã€ã‚’ã€Œæ±éƒ¨ã€ã«çµ±åˆ
    teamsByRegion['æ±éƒ¨'] = teamsByRegion['æ±éƒ¨'].concat(teamsByRegion['ä¼Šè±†']);
    delete teamsByRegion['ä¼Šè±†']; // æ—§ä¼Šè±†åœ°åŒºã‚’å‰Šé™¤
    tournamentState.autumnData.regions['ä¼Šè±†'] = { blocks: [], finalReps: [] }; // äº’æ›æ€§ã®ãŸã‚ç©ºã§æ®‹ã™

    // 3. ä¸»è¦3åœ°åŒºï¼ˆæ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨ï¼‰ã®å¤§è¦æ¨¡ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        let regionalTeams = shuffleArray(teamsByRegion[region]);
        if (regionalTeams.length === 0) continue;

        // (A) ãƒ¡ã‚¤ãƒ³ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ (ä¾‹: 43ãƒãƒ¼ãƒ  -> 64æ ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ)
        const mainBracketId = `${region}-MAIN`;
        const mainMatches = createDynamicBracketMatches(mainBracketId, regionalTeams);
        
        // (B) æ•—è€…å¾©æ´»ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ (8æ )
        const repechageBracketId = `${region}-REP`;
        const repechageMatches = createDynamicBracketMatches(repechageBracketId, Array(8).fill(null)); // 8ãƒãƒ¼ãƒ ç”¨ã®ç©ºã®ç®±
        
        // (C) å·ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜
        tournamentState.autumnData.regions[region] = {
            blocks: [], // æ—§ãƒ–ãƒ­ãƒƒã‚¯ã¯å»ƒæ­¢
            mainBracket: { // â˜…æ–°è¨­
                id: mainBracketId,
                teams: regionalTeams,
                matches: mainMatches,
                size: Math.pow(2, Math.ceil(Math.log2(regionalTeams.length))) // 64, 64, 64
            },
            repechageBracket: { // â˜…æ–°è¨­
                id: repechageBracketId,
                teams: Array(8).fill(null), // 8æ 
                matches: repechageMatches
            },
            finalReps: [], // æœ€çµ‚çš„ãªä»£è¡¨ (12æ )
            best8: [], // ãƒ™ã‚¹ãƒˆ8 (8æ )
            repechageTeams: [] // æ•—è€…å¾©æ´»ã«é€²ã‚€ãƒãƒ¼ãƒ  (8æ )
        };
        
        // (D) å…¨è©¦åˆã‚’ãƒã‚¹ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã«è¿½åŠ 
        if (!tournamentState.autumnData.allMatches) tournamentState.autumnData.allMatches = {};
        Object.assign(tournamentState.autumnData.allMatches, mainMatches, repechageMatches);
    }
    // â˜…â˜…â˜… æ–°ãƒ­ã‚¸ãƒƒã‚¯ã“ã“ã¾ã§ â˜…â˜…â˜…

    renderTournament(tournamentState);
    saveState();
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * [NEW HELPER] ä»»æ„ã®ãƒãƒ¼ãƒ æ•°ã§ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®è©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹
 * (â˜…prevMatchId (å­è©¦åˆID) ã‚’ä¿å­˜ã—ã€æç”»ã¨é€²è¡Œã‚’å¯èƒ½ã«ã™ã‚‹ä¿®æ­£ç‰ˆ)
 * @param {string} bracketId - 'æ±éƒ¨-B1' ã‚„ 'ä¼Šè±†-AUTUMN' ãªã©ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
 * @param {Array<string>} teams - ãã®ãƒ–ãƒ­ãƒƒã‚¯ã«å‚åŠ ã™ã‚‹å…¨ãƒãƒ¼ãƒ ã®é…åˆ—
 * @returns {object} - å…¨è©¦åˆã® matches ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function createDynamicBracketMatches(bracketId, teams) {
    const numTeams = teams.length;
    if (numTeams === 0) return {};
    if (numTeams === 1) return {};

    const matches = {};
    const rounds = [];
    
    const tournamentSize = Math.pow(2, Math.ceil(Math.log2(numTeams)));
    const numRounds = Math.log2(tournamentSize);
    const numByes = tournamentSize - numTeams;
    const numFirstRoundTeams = numTeams - numByes;
    
    let teamsInNextRound = [];
    let teamIndex = 0;

    // --- 4. 1å›æˆ¦ (R1) ã‚’ç”Ÿæˆ ---
    if (numFirstRoundTeams > 0) {
        const round1Matches = [];
        const numMatchesR1 = numFirstRoundTeams / 2;
        for (let i = 0; i < numMatchesR1; i++) {
            const matchId = `${bracketId}-R1-M${i + 1}`;
            const team1 = teams[teamIndex++];
            const team2 = teams[teamIndex++];
            matches[matchId] = { 
                id: matchId, team1: team1, team2: team2, winner: null, score1: '', score2: '',
                prevMatch1Id: null, prevMatch2Id: null, nextMatchId: null // R1ã¯å­ãªã—
            };
            round1Matches.push(matchId);
            teamsInNextRound.push(`winner_of_${matchId}`);
        }
        rounds.push(round1Matches);
    }
    
    // --- 5. 1å›æˆ¦å…é™¤(ã‚·ãƒ¼ãƒ‰)ã®ãƒãƒ¼ãƒ ã‚’æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ã«è¿½åŠ  ---
    for (let i = 0; i < numByes; i++) {
        teamsInNextRound.push(teams[teamIndex++]);
    }

    // --- 6. 2å›æˆ¦ (R2) ã‹ã‚‰æ±ºå‹ (Final) ã¾ã§ã‚’è‡ªå‹•ç”Ÿæˆ ---
    for (let r = 2; r <= numRounds; r++) {
        const roundMatches = [];
        const teamsInThisRound = shuffleArray(teamsInNextRound);
        teamsInNextRound = [];
        
        const numMatchesInRound = teamsInThisRound.length / 2;
        for (let i = 0; i < numMatchesInRound; i++) {
            const matchId = `${bracketId}-R${r}-M${i + 1}`;
            const team1_str = teamsInThisRound[i * 2];
            const team2_str = teamsInThisRound[i * 2 + 1];
            
            const resolvedTeam1 = team1_str.startsWith('winner_of_') ? null : team1_str;
            const resolvedTeam2 = team2_str.startsWith('winner_of_') ? null : team2_str;
            
            // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
            // ã“ã®è©¦åˆ (R2) ã«é€²å‡ºã™ã‚‹ã€å‰ã®è©¦åˆ (R1) ã®IDã‚’ä¿å­˜ã™ã‚‹
            const prevMatch1Id = team1_str.startsWith('winner_of_') ? team1_str.replace('winner_of_', '') : null;
            const prevMatch2Id = team2_str.startsWith('winner_of_') ? team2_str.replace('winner_of_', '') : null;

            matches[matchId] = { 
                id: matchId, 
                team1: resolvedTeam1, 
                team2: resolvedTeam2, 
                winner: null, score1: '', score2: '', 
                prevMatch1Id: prevMatch1Id, // â˜… å·¦ã®å­ (team1å´) ã®ID
                prevMatch2Id: prevMatch2Id, // â˜… å³ã®å­ (team2å´) ã®ID
                nextMatchId: null // â˜… ã“ã®æ™‚ç‚¹ã§ã¯ã€Œæ¬¡ã€ã¯ä¸æ˜
            };
            // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

            roundMatches.push(matchId);
            teamsInNextRound.push(`winner_of_${matchId}`);
            
            // â˜… å‰ã®è©¦åˆã®ã€ŒnextMatchIdã€ã«ã€ä»Šä½œã£ãŸè©¦åˆIDã‚’ãƒªãƒ³ã‚¯ã™ã‚‹
            if (prevMatch1Id) matches[prevMatch1Id].nextMatchId = matchId;
            if (prevMatch2Id) matches[prevMatch2Id].nextMatchId = matchId;
        }
        rounds.push(roundMatches);
    }
    
    return matches;
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * [ç§‹å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸1 UI] åœ°åŒºäºˆé¸ã‚’æç”»ã™ã‚‹
 * (â˜…æ–°ä»•æ§˜: 3åœ°åŒº å¤§è¦æ¨¡T + æ•—è€…å¾©æ´»T æ–¹å¼)
 */
function renderAutumnRegionalBlocks() {
    let html = `<h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ç§‹å­£å¤§ä¼š åœ°åŒºäºˆé¸</h2>`;
    html += '<div class="space-y-8">';

    // æ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.autumnData.regions[region];
        if (!regionData.mainBracket) continue;

        const quota = 12; // å„åœ°åŒº12æ 

        html += `
            <div class="p-4 border-2 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2 text-purple-700">${region}åœ°åŒº (${quota}æ )</h3>
                
                <h4 class="font-bold text-center text-lg mb-2">çœŒå¤§ä¼šå‡ºå ´æ±ºå®šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ (ãƒ™ã‚¹ãƒˆ8ãŒæ±ºå®š)</h4>
                <p class="text-sm text-center text-gray-600 mb-2">
                    ${regionData.mainBracket.teams.length}ãƒãƒ¼ãƒ ã«ã‚ˆã‚‹ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã€‚ãƒ™ã‚¹ãƒˆ8 (æº–ã€…æ±ºå‹) ã«é€²å‡ºã—ãŸ8æ ¡ãŒçœŒå¤§ä¼šå‡ºå ´æ±ºå®šï¼<br>
                    ãƒ™ã‚¹ãƒˆ16ã§æ•—é€€ã—ãŸ8æ ¡ã¯ã€ä¸‹ã®ã€Œæ•—è€…å¾©æ´»ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã€ã«é€²ã¿ã¾ã™ã€‚
                </p>
                <div class="p-3 border rounded-lg bg-gray-50 overflow-x-auto">
                    <div class="flex items-center justify-start space-x-2 text-xs" style="min-width: ${regionData.mainBracket.size * 50}px;">
                        ${createDynamicBracketHTML(regionData.mainBracket.id, regionData.mainBracket.matches)}
                    </div>
                </div>

                <h4 class="font-bold text-center text-lg mb-2 mt-8">æ•—è€…å¾©æ´»ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ (æ®‹ã‚Š4æ )</h4>
                <p class="text-sm text-center text-gray-600 mb-2">
                    ä¸Šè¨˜ã®ãƒ™ã‚¹ãƒˆ16ã§æ•—é€€ã—ãŸ8æ ¡ãŒã€æ®‹ã‚Š4æ ã‚’ã‹ã‘ã¦æˆ¦ã„ã¾ã™ã€‚
                </p>
                <div class="p-3 border rounded-lg bg-gray-50 overflow-x-auto">
                    <div class="flex items-center justify-center space-x-2 text-xs">
                        ${createDynamicBracketHTML(regionData.repechageBracket.id, regionData.repechageBracket.matches)}
                    </div>
                </div>
            </div>
        `;
    }
    // (ä¼Šè±†åœ°åŒºã¯æ±éƒ¨ã«çµ±åˆã•ã‚ŒãŸãŸã‚æç”»ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤)

    html += '</div>';
    autumnRegionalContainer.innerHTML = html;
    checkAutumnRegionalBlocksComplete();
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

  
    /**
     * [ç§‹å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸2] åœ°åŒºå†…é †ä½æ±ºå®šæˆ¦ã‚’é–‹å§‹ã™ã‚‹
     */
    async function setupAutumnRankingTournaments() {
    tournamentState.autumnPhase = 'regional_ranking';

    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.autumnData.regions[region];
        
        // é‡è¦ãªå¤‰æ›´ï¼šä¸Šä½æ ¡ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã¯å»ƒæ­¢ã—ã€æ•—è€…å¾©æ´»æˆ¦ã®ã¿ã‚’è¡Œã†
        regionData.champBracket = null; // ä¸è¦ã«ãªã£ãŸã®ã§ã‚¯ãƒªã‚¢

        // ãƒ–ãƒ­ãƒƒã‚¯æº–å„ªå‹ã—ãŸãƒãƒ¼ãƒ ã§ã€ç¬¬5ä»£è¡¨æ±ºå®šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’çµ„ã‚€
        const repechageBracketId = `${region}-REP`;
        const repTeams = shuffleArray(regionData.blockRunnersUp);
        regionData.repechageBracket = {
            id: repechageBracketId,
            teams: repTeams,
            matches: {
                [`${repechageBracketId}-R1-M1`]: { id: `${repechageBracketId}-R1-M1`, team1: repTeams[0], team2: repTeams[1], winner: null, score1: '', score2: '', summary: '' },
                [`${repechageBracketId}-R1-M2`]: { id: `${repechageBracketId}-R1-M2`, team1: repTeams[2], team2: repTeams[3], winner: null, score1: '', score2: '', summary: '' },
                [`${repechageBracketId}-R2-M1`]: { id: `${repechageBracketId}-R2-M1`, team1: null, team2: null, winner: null, score1: '', score2: '', summary: '' } // 5ä½æ±ºå®šæˆ¦
            }
        };
    }
    
    renderTournament(tournamentState);
    saveState();
}
    /**
     * [ç§‹å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸2 UI] åœ°åŒºå†…é †ä½æ±ºå®šæˆ¦ã‚’æç”»ã™ã‚‹
     */
   // ã€ä¿®æ­£å¯¾è±¡3ã€‘
function renderAutumnRankingTournaments() {
    let html = `<h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ç§‹å­£å¤§ä¼š åœ°åŒº ç¬¬5ä»£è¡¨æ±ºå®šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ</h2>`;
    html += '<div class="space-y-8">';
    
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.autumnData.regions[region];
        if (!regionData.repechageBracket) continue;

        const rep = regionData.repechageBracket;
        
        const repSemi1 = rep.matches[`${rep.id}-R1-M1`];
        const repSemi2 = rep.matches[`${rep.id}-R1-M2`];
        rep.matches[`${rep.id}-R2-M1`].team1 = repSemi1.winner;
        rep.matches[`${rep.id}-R2-M1`].team2 = repSemi2.winner;
        
        html += `
            <div class="p-4 border-2 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2 text-purple-700">${region}åœ°åŒº</h3>
                <div class="flex items-center justify-center space-x-4">
                    <div class="space-y-4">
                        ${createMatchHTML(repSemi1.id, repSemi1.team1, repSemi1.team2, repSemi1, [])}
                        
                        ${createMatchHTML(repSemi2.id, repSemi2.team1, repSemi2.team2, repSemi2, [])}
                        </div>
                    <div>
                        <p class="text-center font-semibold">ä»£è¡¨æ±ºå®šæˆ¦</p>
                        ${createMatchHTML(rep.matches[`${rep.id}-R2-M1`].id, rep.matches[`${rep.id}-R2-M1`].team1, rep.matches[`${rep.id}-R2-M1`].team2, rep.matches[`${rep.id}-R2-M1`], [])}
                    </div>
                </div>
            </div>
        `;
    }
    html += '</div>';
    autumnRankingContainer.innerHTML = html;
    checkAutumnRankingTournamentsComplete();
}
    

/**
 * [ç§‹å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸3] çœŒå¤§ä¼šæœ¬æˆ¦ã‚’é–‹å§‹ã™ã‚‹
 * (â˜…æ–°ä»•æ§˜: 36ãƒãƒ¼ãƒ åˆ¶ (24 BYE + 12 R1) ã«å¯¾å¿œ)
 */
async function setupAutumnMainTournament() {
    tournamentState.autumnPhase = 'main';
    tournamentState.is16team = false; // 16ãƒãƒ¼ãƒ åˆ¶ã§ã¯ãªã„

    // --- 1. ä»£è¡¨ãƒãƒ¼ãƒ ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ (36ãƒãƒ¼ãƒ ) ---
    const best8_winners = []; // 24æ ¡ (2å›æˆ¦ã‹ã‚‰)
    const repechage_winners = []; // 12æ ¡ (1å›æˆ¦ã‹ã‚‰)

    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.autumnData.regions[region];
        
        // (A) ãƒ¡ã‚¤ãƒ³ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®ãƒ™ã‚¹ãƒˆ8 (8æ ¡) ã‚’é›†è¨ˆ
        const mainMatches = regionData.mainBracket.matches;
        const mainSize = regionData.mainBracket.size; // 64, 64, 64
        const quarterFinalRound = Math.log2(mainSize) - 1; // æº–ã€…æ±ºå‹ (R5)
        
        const quarterFinalIds = Object.keys(mainMatches).filter(id => id.includes(`-R${quarterFinalRound}-M`)); // R5ã®è©¦åˆ
        quarterFinalIds.forEach(matchId => {
            const match = mainMatches[matchId];
            if (match.team1) best8_winners.push(match.team1);
            if (match.team2) best8_winners.push(match.team2);
        });

        // (B) æ•—è€…å¾©æ´»ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®ãƒ™ã‚¹ãƒˆ4 (4æ ¡) ã‚’é›†è¨ˆ
        const repMatches = regionData.repechageBracket.matches;
        const repSemiFinalRound = Math.log2(8) - 1; // æº–æ±ºå‹ (R2)
        
        const repSemiFinalIds = Object.keys(repMatches).filter(id => id.includes(`-R${repSemiFinalRound}-M`)); // R2ã®è©¦åˆ
        repSemiFinalIds.forEach(matchId => {
            const match = repMatches[matchId];
            if (match.team1) repechage_winners.push(match.team1);
            if (match.team2) repechage_winners.push(match.team2);
        });
    }

    // --- 2. äºˆé¸æ•—é€€ãƒãƒ¼ãƒ ã®æˆç¸¾ã‚’è¨˜éŒ² ---
    const repTeamNames = [...best8_winners, ...repechage_winners];
    INITIAL_TEAM_POOL.forEach(teamName => {
        if (TEAM_DATA[teamName]?.region && !repTeamNames.includes(teamName)) {
            if(tournamentState.teamRecords[teamName]) tournamentState.teamRecords[teamName].lastFinish = 64;
        }
    });

    // --- 3. 64ãƒãƒ¼ãƒ åˆ¶ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ (36æ ¡ + 28 BYE) ---
    const numTeamsInTournament = 64;
    const finalRound = 6;
    tournamentState.teams = Array(numTeamsInTournament).fill(null);
    tournamentState.matches = {};
    tournamentState.seeds = []; // ç§‹å­£çœŒå¤§ä¼šã¯ã‚·ãƒ¼ãƒ‰ãªã—

    const shuffledRepechageTeams = shuffleArray(repechage_winners); // 12æ ¡
    const shuffledBest8Teams = shuffleArray(best8_winners); // 24æ ¡
    const byes = Array(28).fill('(BYE)'); // 28æ 
    
    let teamsForR1 = []; // 1å›æˆ¦ã‚’æˆ¦ã†ãƒãƒ¼ãƒ  (36ãƒãƒ¼ãƒ )
    
    // (A) æ•—è€…å¾©æ´»12æ ¡ã‚’ã€1å›æˆ¦ã®6è©¦åˆã«é…ç½®
    for (let i = 0; i < 12; i++) {
        teamsForR1.push(shuffledRepechageTeams[i]);
    }
    
    // (B) ãƒ™ã‚¹ãƒˆ8ã®24æ ¡ã¨ã€BYEã®28æ ã‚’ãƒšã‚¢ãƒªãƒ³ã‚°
    // 24æ ¡ + 28BYE = 52ãƒãƒ¼ãƒ  -> 26è©¦åˆ
    // ã“ã®ã†ã¡ã€(28-24)=4ã¤ã®BYEãŒBYEåŒå£«ã§å½“ãŸã‚‹ (2è©¦åˆ)
    const combinedRest = shuffleArray([...shuffledBest8Teams, ...byes]);
    for (let i = 0; i < 52; i++) {
        teamsForR1.push(combinedRest[i]);
    }
    
    // (C) 1å›æˆ¦ã®æ  (36ãƒãƒ¼ãƒ ) ãŒã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚Œã¦ã„ãªã„ã®ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    teamsForR1 = shuffleArray(teamsForR1);
    
    // (D) æœ€çµ‚çš„ãª 64ã‚¹ãƒ­ãƒƒãƒˆã‚’ç”Ÿæˆ
    let r1Index = 0;
    let byeIndex = 0;
    const finalTeamsArray = [];
    
    // 12æ ¡(æ•—è€…å¾©æ´»)ãŒ6è©¦åˆ = 12ã‚¹ãƒ­ãƒƒãƒˆ
    for(let i=0; i<12; i++) {
        finalTeamsArray.push(shuffledRepechageTeams[i]);
    }
    // 24æ ¡(ãƒ™ã‚¹ãƒˆ8) + 28BYE = 52ã‚¹ãƒ­ãƒƒãƒˆ
    const rest = shuffleArray([...shuffledBest8Teams, ...byes]);
    finalTeamsArray.push(...rest);
    
    tournamentState.teams = finalTeamsArray; // 64æ ã«ã‚»ãƒƒãƒˆ

    // --- 4. R1 (32è©¦åˆ) ã®è©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ ---
    const round1Setup = tournamentState.teams.reduce((acc, team, i) => {
        if (i % 2 === 0) acc.push({ team1: team, team2: null });
        else acc[acc.length - 1].team2 = team;
        return acc;
    }, []);

    round1Setup.forEach((match, index) => {
        const side = index < 16 ? 'L' : 'R'; // 32è©¦åˆ / 2 = 16
        const matchNum = index < 16 ? index + 1 : index - 15;
        const matchId = `${side}-R1-M${matchNum}`;
        tournamentState.matches[matchId] = { id: matchId, team1: match.team1, team2: match.team2, winner: null, score1: '', score2: '', details: null, summary: '' };
    });

    // --- 5. R2, R3, R4, R5, F ã®ã€Œç©ºã®ç®±ã€ã‚’ä½œæˆ ---
    for (let r = 2; r < finalRound; r++) { // R2, R3, R4, R5
        const numMatchesInRound = numTeamsInTournament / Math.pow(2, r); // 16, 8, 4, 2
        for (let m = 1; m <= numMatchesInRound / 2; m++) {
            const matchIdL = `L-R${r}-M${m}`;
            tournamentState.matches[matchIdL] = { id: matchIdL, team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '' };
            const matchIdR = `R-R${r}-M${m}`;
            tournamentState.matches[matchIdR] = { id: matchIdR, team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '' };
        }
    }
    tournamentState.matches['F-R1-M1'] = { id: 'F-R1-M1', team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '' };
    
    // --- 6. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ (64ãƒãƒ¼ãƒ ãƒ»6ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¶) ---
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R1-')), 
        ["9/15", "9/16", "9/17"], STADIUM_DATA, 2 // R1(32è©¦åˆ) -> 10çƒå ´*3æ—¥*2è©¦åˆ=60ã‚¹ãƒ­ãƒƒãƒˆ (ååˆ†)
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R2-')), 
        ["9/19", "9/20"], ROUND_3_STADIUMS, 2 // R2(16è©¦åˆ) -> 4çƒå ´*2æ—¥*2è©¦åˆ=16ã‚¹ãƒ­ãƒƒãƒˆ
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R3-')), 
        ["9/22"], ROUND_3_STADIUMS, 2 // R3(8è©¦åˆ) -> 4çƒå ´*1æ—¥*2è©¦åˆ=8ã‚¹ãƒ­ãƒƒãƒˆ
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R4-')), 
        ["9/24"], FINAL_STAGE_STADIUMS, 4 // R4(æº–ã€… 4è©¦åˆ) -> 1çƒå ´*1æ—¥*4è©¦åˆ
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R5-')), 
        ["9/26"], FINAL_STAGE_STADIUMS, 2 // R5(æº–æ±º 2è©¦åˆ) -> 1çƒå ´*1æ—¥*2è©¦åˆ
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('F-R1-')), 
        ["9/28"], FINAL_STAGE_STADIUMS, 1 // æ±ºå‹ (1è©¦åˆ)
    );
    
    renderTournament(tournamentState);
    saveState();
    
    // --- 7. ä¸æˆ¦å‹(BYE)ã®è‡ªå‹•å‡¦ç† ---
    processByes(tournamentState);

    // --- 8. è¨˜äº‹ç”Ÿæˆ ---
    const currentTournamentName = "ç§‹å­£çœŒå¤§ä¼šæœ¬æˆ¦";
    newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒ${currentTournamentName}ã®å±•æœ›è¨˜äº‹ã‚’åŸ·ç­†ä¸­...</div>`;
    bbsCommentsContainer.innerHTML = `<div class="loader">AIãŒçµ„ã¿åˆã‚ã›ã‚’åˆ†æä¸­...</div>`;

    const [previewArticle, bracketBbsResult] = await Promise.all([
        generateBracketAnalysisNewsArticle(tournamentState), // 64ãƒãƒ¼ãƒ åˆ¶ã®åˆ†æã‚’å‘¼ã¶
        generateBracketBbsThread(tournamentState) // 64ãƒãƒ¼ãƒ åˆ¶ã®BBSã‚’å‘¼ã¶
    ]);

    if (previewArticle && !previewArticle.error) {
         tournamentState.news.unshift(previewArticle);
    } else if (previewArticle && previewArticle.error) {
        tournamentState.news.unshift(previewArticle);
    }
    if (bracketBbsResult && !bracketBbsResult.error) {
        tournamentState.bbsComments.push(bracketBbsResult); 
    } else if (bracketBbsResult && bracketBbsResult.error) {
        tournamentState.bbsComments.push({ ...bracketBbsResult, context: { isBracketThread: true } });
    }
    
    renderNews(tournamentState.news);
    renderBbsComments(tournamentState.bbsComments);
    saveState();
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²


/**
     * ç§‹å­£åœ°åŒºãƒ–ãƒ­ãƒƒã‚¯äºˆé¸ãŒã™ã¹ã¦çµ‚äº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
     * (â˜…æ–°ä»•æ§˜: 3åœ°åŒº å¤§è¦æ¨¡T + æ•—è€…å¾©æ´»T ã®çµ‚äº†ã‚’ç›£è¦–)
     */
    function checkAutumnRegionalBlocksComplete() {
    let allFinished = true;
    
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.autumnData.regions[region];
        if (!regionData || !regionData.mainBracket || !regionData.repechageBracket) {
            allFinished = false; break;
        }
        
        // 1. ãƒ¡ã‚¤ãƒ³ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®æ±ºå‹æˆ¦ (å„ªå‹æ±ºå®š)
        const mainMatches = regionData.mainBracket.matches;
        const mainFinalId = Object.keys(mainMatches).find(id => !mainMatches[id].nextMatchId);
        if (!mainFinalId || !mainMatches[mainFinalId].winner) {
            allFinished = false; break;
        }

        // 2. æ•—è€…å¾©æ´»ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®æ±ºå‹æˆ¦ (4è©¦åˆ)
        const repMatches = regionData.repechageBracket.matches;
const semi1 = repMatches[`${regionData.repechageBracket.id}-R2-M1`];
        const semi2 = repMatches[`${regionData.repechageBracket.id}-R2-M2`];
        
        if (!semi1 || !semi2 || !semi1.team1 || !semi1.team2 || !semi2.team1 || !semi2.team2) {
             allFinished = false; break;
        }
        // (æ•—è€…å¾©æ´»æˆ¦ã¯æº–æ±ºå‹ã¾ã§é€²ã‚ã°OKã€‚æ±ºå‹(R3-M1)ã¾ã§ã‚„ã‚‹å¿…è¦ã¯ãªã„)
        // â˜…â˜…â˜… æ–°ãƒ­ã‚¸ãƒƒã‚¯ã“ã“ã¾ã§ â˜…â˜…â˜…
    }

    if (allFinished) {
        autumnControls.classList.remove('hidden');
        startRankingPlayoffsBtn.classList.add('hidden');
        startMainTournamentBtn.classList.remove('hidden'); // â˜… çœŒå¤§ä¼šæœ¬æˆ¦ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        skipAutumnBlocksBtn.classList.add('hidden');
    } else {
        autumnControls.classList.add('hidden');
        startRankingPlayoffsBtn.classList.add('hidden');
        startMainTournamentBtn.classList.add('hidden');
    }
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
 
   /**
     * ç§‹å­£åœ°åŒºå†…é †ä½æ±ºå®šæˆ¦ãŒã™ã¹ã¦çµ‚äº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
     */
    /**
     * ã€ä¿®æ­£ç‰ˆã€‘ç§‹å­£åœ°åŒºå†…é †ä½æ±ºå®šæˆ¦ãŒã™ã¹ã¦çµ‚äº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
     */
    function checkAutumnRankingTournamentsComplete() {
    let allRankingsFinished = true;
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.autumnData.regions[region];
        if (!regionData.repechageBracket) {
            allRankingsFinished = false;
            break;
        }

        const repechageFinal = regionData.repechageBracket.matches[`${region}-REP-R2-M1`]; // 5ä½æ±ºå®šæˆ¦

        // æ•—è€…å¾©æ´»æˆ¦ã®æ±ºå‹ãŒã™ã¹ã¦çµ‚ã‚ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (!repechageFinal.winner) {
            allRankingsFinished = false;
            break;
        }
    }
    
    if (allRankingsFinished) {
        autumnControls.classList.remove('hidden');
        startRankingPlayoffsBtn.classList.add('hidden');
        startMainTournamentBtn.classList.remove('hidden');
    } else {
        autumnControls.classList.add('hidden');
        startMainTournamentBtn.classList.add('hidden');
    }
}
// --- NEW Spring Tournament System ---

/**
 * [æ˜¥å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸1] åœ°åŒºäºˆé¸ã‚’é–‹å§‹ã™ã‚‹ï¼ˆ3æ ¡ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆå¯¾å¿œãƒ»æœ€çµ‚ç‰ˆï¼‰
 */
async function setupSpringRegionalQualifiers() {
    tournamentState.springPhase = 'regional_qualifiers';
    const { qualifierTeams } = tournamentState.springData;

    const teamsByRegion = { 'æ±éƒ¨': [], 'ä¸­éƒ¨': [], 'è¥¿éƒ¨': [], 'ä¼Šè±†': [] };
    qualifierTeams.forEach(teamName => {
        const region = TEAM_DATA[teamName]?.region;
        if (region && teamsByRegion[region]) {
            teamsByRegion[region].push(teamName);
        }
    });
    
    // æ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨åœ°åŒºã®äºˆé¸è¨­å®š
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        let regionalTeams = shuffleArray(teamsByRegion[region]);
        const blockCount = 4;
        const regionBlocks = [];
        
        for (let i = 0; i < blockCount; i++) {
            const blockTeams = regionalTeams.splice(0, Math.ceil(regionalTeams.length / (blockCount - i)));
            if(blockTeams.length === 0) continue;
            
            const blockId = `${region}-SB${i+1}`; // Spring Block
            const blockMatches = {};
            
            // ãƒãƒ¼ãƒ æ•°ã«å¿œã˜ã¦ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆå½¢å¼ã‚’æ±ºå®š
            if (blockTeams.length <= 4) { // 4ãƒãƒ¼ãƒ ä»¥ä¸‹
                const semi1Id = `${blockId}-R1-M1`;
                const semi2Id = `${blockId}-R1-M2`;
                const finalId = `${blockId}-R2-M1`;
                Object.assign(blockMatches, {
                    [semi1Id]: { id: semi1Id, team1: blockTeams[0], team2: blockTeams[1], winner: null, score1: '', score2: '' },
                    [semi2Id]: { id: semi2Id, team1: blockTeams[2] || null, team2: blockTeams[3] || null, winner: null, score1: '', score2: '' },
                    [finalId]: { id: finalId, team1: null, team2: null, winner: null, score1: '', score2: '' }
                });
            } else { // 5ãƒãƒ¼ãƒ 
                 const playInMatchId = `${blockId}-R0-M1`;
                 const semi1Id = `${blockId}-R1-M1`;
                 const semi2Id = `${blockId}-R1-M2`;
                 const finalId = `${blockId}-R2-M1`;
                 Object.assign(blockMatches, {
                    [playInMatchId]: { id: playInMatchId, team1: blockTeams[0], team2: blockTeams[1], winner: null, score1: '', score2: '' },
                    [semi1Id]: { id: semi1Id, team1: null, team2: blockTeams[2], winner: null, score1: '', score2: '' },
                    [semi2Id]: { id: semi2Id, team1: blockTeams[3], team2: blockTeams[4], winner: null, score1: '', score2: '' },
                    [finalId]: { id: finalId, team1: null, team2: null, winner: null, score1: '', score2: '' }
                 });
            }
            regionBlocks.push({ id: blockId, teams: blockTeams, matches: blockMatches });
            Object.assign(tournamentState.springData.allMatches, blockMatches);
        }
        tournamentState.springData.regions[region].blocks = regionBlocks;

        // ç¬¬5ä»£è¡¨æ±ºå®šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®å™¨ã‚’æº–å‚™
        const repBracketId = `${region}-SREP`;
        tournamentState.springData.regions[region].repechageBracket = {
            id: repBracketId,
            teams: [], // ãƒ–ãƒ­ãƒƒã‚¯æº–å„ªå‹æ ¡ãŒã“ã“ã«å…¥ã‚‹
            matches: {
                [`${repBracketId}-R1-M1`]: { id: `${repBracketId}-R1-M1`, team1: null, team2: null, winner: null, score1: '', score2: '' },
                [`${repBracketId}-R1-M2`]: { id: `${repBracketId}-R1-M2`, team1: null, team2: null, winner: null, score1: '', score2: '' },
                [`${repBracketId}-R2-M1`]: { id: `${repBracketId}-R2-M1`, team1: null, team2: null, winner: null, score1: '', score2: '' }
            }
        };
        Object.assign(tournamentState.springData.allMatches, tournamentState.springData.regions[region].repechageBracket.matches);
    }
    
    // ä¼Šè±†åœ°åŒºã®äºˆé¸è¨­å®š
    const izuTeams = shuffleArray(teamsByRegion['ä¼Šè±†']);
    const izuBracketId = 'ä¼Šè±†-SIZU'; // IDã‚’'SIZU'ã«å¤‰æ›´
    const izuBracket = { id: izuBracketId, teams: izuTeams, matches: {} };

    if (izuTeams.length === 3) {
        // --- 3æ ¡ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®å ´åˆ ---
        const semiId = `${izuBracketId}-R1-M1`;
        const finalId = `${izuBracketId}-R2-M1`;
        // 1ãƒãƒ¼ãƒ ãŒä¸æˆ¦å‹ï¼ˆbyeï¼‰ã§æ±ºå‹ã¸
        Object.assign(izuBracket.matches, {
            [semiId]: { id: semiId, team1: izuTeams[0], team2: izuTeams[1], winner: null, score1: '', score2: '' },
            [finalId]: { id: finalId, team1: null, team2: izuTeams[2], winner: null, score1: '', score2: '' }
        });
    } else if (izuTeams.length >= 2) {
        // --- 4æ ¡ï¼ˆã¾ãŸã¯2æ ¡ï¼‰ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®å ´åˆ ---
        const semi1Id = `${izuBracketId}-R1-M1`;
        const semi2Id = `${izuBracketId}-R1-M2`;
        const finalId = `${izuBracketId}-R2-M1`;
        Object.assign(izuBracket.matches, {
            [semi1Id]: { id: semi1Id, team1: izuTeams[0], team2: izuTeams[1], winner: null, score1: '', score2: '' },
            [semi2Id]: { id: semi2Id, team1: izuTeams[2] || null, team2: izuTeams[3] || null, winner: null, score1: '', score2: '' },
            [finalId]: { id: finalId, team1: null, team2: null, winner: null, score1: '', score2: '' }
        });
    }
    tournamentState.springData.regions['ä¼Šè±†'].izuBracket = izuBracket;
    Object.assign(tournamentState.springData.allMatches, izuBracket.matches);

    renderTournament(tournamentState);
    saveState();
}

/**
 * [æ˜¥å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸1 UI] åœ°åŒºäºˆé¸ã‚’æç”»ã™ã‚‹
 */
function renderSpringRegionalQualifiers() {
    let html = `<h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">æ˜¥å­£å¤§ä¼š åœ°åŒºäºˆé¸</h2>`;
    html += '<div class="space-y-8">';

    // æ±éƒ¨ãƒ»ä¸­éƒ¨ãƒ»è¥¿éƒ¨
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.springData.regions[region];
        if (!regionData.blocks) continue;

        html += `
            <div class="p-4 border-2 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2 text-green-700">${region}åœ°åŒº (5æ )</h3>
                <h4 class="font-bold text-center text-lg mb-2">ä»£è¡¨æ±ºå®šãƒ–ãƒ­ãƒƒã‚¯</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    ${regionData.blocks.map(block => `
                        <div class="p-3 border rounded-lg bg-gray-50">
                            <h4 class="font-bold text-center mb-2">ãƒ–ãƒ­ãƒƒã‚¯ ${block.id.split('-')[1].slice(1)}</h4>
                            ${block.teams.length <= 4 ? create4TeamBlockHTML(block) : create5TeamBlockHTML(block)}
                        </div>
                    `).join('')}
                </div>
                <h4 class="font-bold text-center text-lg mb-2">ç¬¬5ä»£è¡¨æ±ºå®šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ</h4>
                <div class="flex justify-center">
                   ${create4TeamBlockHTML(regionData.repechageBracket, true)}
                </div>
            </div>
        `;
    }

    // ä¼Šè±†
    const izuData = tournamentState.springData.regions['ä¼Šè±†'];
    if (izuData.izuBracket) {
        html += `
            <div class="p-4 border-2 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2 text-green-700">ä¼Šè±†åœ°åŒº (1æ )</h3>
                <div class="flex justify-center">
                    ${create4TeamBlockHTML(izuData.izuBracket)}
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    autumnRegionalContainer.innerHTML = html; // ç§‹ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’æµç”¨
    checkSpringQualifiersComplete();
}

/**
 * [NEW HELPER] matchesã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®HTMLã‚’å†å¸°çš„ã«ç”Ÿæˆã™ã‚‹
 * (â˜…ã€ŒprevMatchIdã€ã‚’æ­£ã—ãè¾¿ã£ã¦æç”»ã™ã‚‹ä¿®æ­£ç‰ˆ)
 * @param {string} bracketId - 'æ±éƒ¨-B1' ãªã©
 * @param {object} matches - ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã®å…¨è©¦åˆ matches ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {string} - ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®HTML
 */
function createDynamicBracketHTML(bracketId, matches) {
    const finalMatchId = Object.keys(matches).find(id => !matches[id].nextMatchId);
    if (!finalMatchId) return "ï¼ˆè©¦åˆãªã—ï¼‰";

    // å†å¸°çš„ã«HTMLã‚’æ§‹ç¯‰ã™ã‚‹å†…éƒ¨é–¢æ•°
    function buildMatchHTML(matchId) {
        const match = matches[matchId];
        if (!match) return "ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰";

        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
        // 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚ŒãŸå­IDã‚’ç›´æ¥å‚ç…§
        const prevMatch1Id = match.prevMatch1Id;
        const prevMatch2Id = match.prevMatch2Id;
        
        // 2. ï¼ˆå·¦å´ï¼‰å‰ã®è©¦åˆãŒã‚ã‚‹å ´åˆã¯ã€å†å¸°çš„ã«å‘¼ã³å‡ºã™
        const leftHtml = prevMatch1Id ? buildMatchHTML(prevMatch1Id) : '';
        // 3. ï¼ˆå³å´ï¼‰å‰ã®è©¦åˆãŒã‚ã‚‹å ´åˆã¯ã€å†å¸°çš„ã«å‘¼ã³å‡ºã™
        const rightHtml = prevMatch2Id ? buildMatchHTML(prevMatch2Id) : '';

        // 4. ãƒãƒ¼ãƒ åã‚’è§£æ±º
        // (processMatchWinãŒå‹è€…åã‚’ team1/team2 ã«å…¥ã‚Œã‚‹ãŸã‚ã€
        //  R1ä»¥å¤–ã¯ prevMatch.winner ã‚’è¦‹ã‚‹å¿…è¦ãŒãªããªã£ãŸ)
        const team1 = match.team1 || (prevMatch1Id ? (matches[prevMatch1Id]?.winner || '---') : '---');
        const team2 = match.team2 || (prevMatch2Id ? (matches[prevMatch2Id]?.winner || '---') : '---');
        // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…
        
        // 5. ã“ã®è©¦åˆè‡ªèº«ã®HTMLã‚’ç”Ÿæˆ
        const currentMatchHtml = createMatchHTML(matchId, team1, team2, match, []);

        if (leftHtml || rightHtml) {
            // å‰ã®è©¦åˆ(å­)ãŒã‚ã‚‹å ´åˆ (2å›æˆ¦ä»¥é™)
            return `
                <div class="flex items-center justify-center space-x-2">
                    <div class="flex flex-col justify-around space-y-4">
                        ${leftHtml}
                        ${rightHtml}
                    </div>
                    <div class="w-40">${currentMatchHtml}</div>
                </div>
            `;
        } else {
            // ã“ã‚ŒãŒ1å›æˆ¦ã®å ´åˆ (å­ãŒãªã„)
            return `<div class="w-40">${currentMatchHtml}</div>`;
        }
    }

    return buildMatchHTML(finalMatchId);
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * æ˜¥å­£åœ°åŒºäºˆé¸ãŒã™ã¹ã¦çµ‚äº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
 */
function checkSpringQualifiersComplete() {
    let allFinished = true;
    for (const match of Object.values(tournamentState.springData.allMatches)) {
        // ãƒãƒ¼ãƒ ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¦ã€ã¾ã å‹è€…ãŒæ±ºã¾ã£ã¦ã„ãªã„è©¦åˆãŒã‚ã‚‹ã‹
        if (match.team1 && match.team2 && !match.winner) {
            allFinished = false;
            break;
        }
    }

    if (allFinished) {
        autumnControls.classList.remove('hidden');
        startMainTournamentBtn.classList.remove('hidden'); // çœŒå¤§ä¼šã¸é€²ã‚€ãƒœã‚¿ãƒ³
        startRankingPlayoffsBtn.classList.add('hidden');
    } else {
        autumnControls.classList.add('hidden');
        startMainTournamentBtn.classList.add('hidden');
    }
}/**
 * [æ˜¥å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸2-1] çœŒå¤§ä¼šæœ¬æˆ¦1å›æˆ¦ã‚’é–‹å§‹ã™ã‚‹
 */
async function setupSpringMainTournament_Round1() {
    tournamentState.springPhase = 'main_round1';
    
    // å„åœ°åŒºã®ä»£è¡¨æ ¡ã‚’finalRepsã‹ã‚‰é›†è¨ˆ
    for (const region of ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']) {
        const regionData = tournamentState.springData.regions[region];
        // ãƒ–ãƒ­ãƒƒã‚¯å„ªå‹æ ¡
        regionData.blocks.forEach(block => {
            const finalMatch = block.matches[`${block.id}-R2-M1`] || block.matches[`${block.id}-R1-M1`]; // 2,3ãƒãƒ¼ãƒ ãƒ–ãƒ­ãƒƒã‚¯å¯¾å¿œ
            if(finalMatch && finalMatch.winner) regionData.finalReps.push(finalMatch.winner);
        });
        // ç¬¬5ä»£è¡¨
        const repFinal = regionData.repechageBracket.matches[`${regionData.repechageBracket.id}-R2-M1`];
        if (repFinal.winner) regionData.finalReps.push(repFinal.winner);
    }
    const izuFinal = tournamentState.springData.regions['ä¼Šè±†'].izuBracket.matches[`ä¼Šè±†-SIZU-R2-M1`];
    if (izuFinal.winner) tournamentState.springData.regions['ä¼Šè±†'].finalReps.push(izuFinal.winner);

    const qualifiedTeams = Object.values(tournamentState.springData.regions).flatMap(r => r.finalReps);
    
    // äºˆé¸æ•—é€€ãƒãƒ¼ãƒ ã®æˆç¸¾ã‚’è¨˜éŒ²
    tournamentState.springData.qualifierTeams.forEach(team => {
        if (!qualifiedTeams.includes(team)) {
            tournamentState.teamRecords[team].lastFinish = 64; // äºˆé¸æ•—é€€
        }
    });

    tournamentState.teams = shuffleArray(qualifiedTeams); // äºˆé¸çªç ´16æ ¡ã§1å›æˆ¦
    tournamentState.matches = {};
    tournamentState.is16team = true; // 16ãƒãƒ¼ãƒ ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã¨ã—ã¦æç”»
    tournamentState.seeds = []; // 1å›æˆ¦ã¯ã‚·ãƒ¼ãƒ‰ãªã—

    const round1Setup = tournamentState.teams.reduce((acc, team, i) => {
        if (i % 2 === 0) acc.push({ team1: team, team2: null });
        else acc[acc.length - 1].team2 = team;
        return acc;
    }, []);

    round1Setup.forEach((match, index) => {
        const side = index < 4 ? 'L' : 'R';
        const matchNum = index < 4 ? index + 1 : index - 3;
        const matchId = `${side}-R1-M${matchNum}`;
        tournamentState.matches[matchId] = { id: matchId, team1: match.team1, team2: match.team2, winner: null, score1: '', score2: '', details: null, summary: '' };
    });

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    // --- 1å›æˆ¦ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ (16ãƒãƒ¼ãƒ ) ---
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R1-')), 
        ["4/10", "4/11"], MAJOR_STADIUMS, 2 // 1å›æˆ¦ (8è©¦åˆ) -> 4çƒå ´*2æ—¥*2è©¦åˆ=16ã‚¹ãƒ­ãƒƒãƒˆ
    );
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    renderTournament(tournamentState);
    saveState();
    
    // å±•æœ›è¨˜äº‹ãªã©ã‚’ç”Ÿæˆ...
    newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒçœŒå¤§ä¼š1å›æˆ¦ã®å±•æœ›è¨˜äº‹ã‚’åŸ·ç­†ä¸­...</div>`;
    // â˜…å±•æœ›è¨˜äº‹ç”¨ã®ç°¡æ˜“contextã‚’ä½œæˆã—ã¦æ¸¡ã™
    const previewContext = { matchId: 'preview' };
    const previewArticle = await generateNewsArticle(previewContext);
    if (previewArticle) tournamentState.news.unshift(previewArticle);

    renderNews(tournamentState.news);
    saveState();
}

/**
 * [æ˜¥å­£å¤§ä¼š ã‚¹ãƒ†ãƒ¼ã‚¸2-2] çœŒå¤§ä¼šæœ¬æˆ¦2å›æˆ¦ã‚’é–‹å§‹ã™ã‚‹
 */
async function setupSpringMainTournament_Round2() {
    tournamentState.springPhase = 'main_round2_onwards';
    
    const round1Winners = [];
    Object.values(tournamentState.matches).forEach(match => {
        if(match.id.includes('-R1-') && match.winner) {
            round1Winners.push(match.winner);
        }
    });

    const seedTeams = tournamentState.springData.seedTeams;
    const shuffledSeeds = shuffleArray(seedTeams);
    const shuffledWinners = shuffleArray(round1Winners);

    // 2å›æˆ¦ã®çµ„ã¿åˆã‚ã›ã‚’ä½œæˆ (ã‚·ãƒ¼ãƒ‰ vs 1å›æˆ¦å‹è€…)
    let newTeamsForRound2 = [];
    for (let i = 0; i < 8; i++) {
        newTeamsForRound2.push(shuffledSeeds[i]);
        newTeamsForRound2.push(shuffledWinners[i]);
    }
    newTeamsForRound2 = shuffleArray(newTeamsForRound2); // çµ„ã¿åˆã‚ã›ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«

    tournamentState.teams = newTeamsForRound2;
    tournamentState.matches = {};
    tournamentState.is16team = true;
    tournamentState.seeds = seedTeams; // 2å›æˆ¦ã‹ã‚‰ã‚·ãƒ¼ãƒ‰æ ¡ã¨ã—ã¦è¡¨ç¤º

    const round2Setup = tournamentState.teams.reduce((acc, team, i) => {
        if (i % 2 === 0) acc.push({ team1: team, team2: null });
        else acc[acc.length - 1].team2 = team;
        return acc;
    }, []);

    // R1ã¨ã—ã¦è©¦åˆIDã‚’ç”Ÿæˆã™ã‚‹ãŒã€ã“ã‚Œã¯å¤§ä¼šã®ã€Œ2å›æˆ¦ã€ã«ã‚ãŸã‚‹
    round2Setup.forEach((match, index) => {
        const side = index < 4 ? 'L' : 'R';
        const matchNum = index < 4 ? index + 1 : index - 3;
        const matchId = `${side}-R1-M${matchNum}`;
        tournamentState.matches[matchId] = { id: matchId, team1: match.team1, team2: match.team2, winner: null, score1: '', score2: '', details: null, summary: '' };
    });
    
    // æ•—é€€ãƒãƒ¼ãƒ ã®æˆç¸¾ã‚’è¨˜éŒ²
    Object.values(tournamentState.teamRecords).forEach(record => {
        if (record.lastFinish > 16 && record.lastFinish <=32) record.lastFinish = 32; // 1å›æˆ¦æ•—é€€ã¯ãƒ™ã‚¹ãƒˆ32æ‰±ã„
    });
    
// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆ â–¼â–¼â–¼
    // --- 2å›æˆ¦ä»¥é™ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ (16ãƒãƒ¼ãƒ ãƒ»æ–°ãƒ«ãƒ¼ãƒ«ç‰ˆ) ---
    const finalRoundSpring = 4;
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R1-')), // (R1 = 2å›æˆ¦)
        ["4/15", "4/16"], ROUND_3_STADIUMS, 2 // 2å›æˆ¦ (ä¸»è¦4çƒå ´) â€»3å›æˆ¦ç”¨çƒå ´ã‚’æµç”¨
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R2-')), 
        ["4/18"], FINAL_STAGE_STADIUMS, 4 // æº–ã€…æ±ºå‹ (è‰è–™ã§4è©¦åˆ)
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('-R3-')), 
        ["4/21"], FINAL_STAGE_STADIUMS, 2 // æº–æ±ºå‹ (è‰è–™ã§2è©¦åˆ)
    );
    scheduleRoundMatches(
        Object.keys(tournamentState.matches).filter(id => id.includes('F-R1-')), 
        ["4/23"], FINAL_STAGE_STADIUMS, 1 // æ±ºå‹ (è‰è–™ã§1è©¦åˆ)
    );
    // â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
    renderTournament(tournamentState);
    saveState();

    // 2å›æˆ¦ã®å±•æœ›è¨˜äº‹ã‚’ç”Ÿæˆ
    newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒçœŒå¤§ä¼š2å›æˆ¦ã®å±•æœ›è¨˜äº‹ã‚’åŸ·ç­†ä¸­...</div>`;
    // â˜…å±•æœ›è¨˜äº‹ç”¨ã®ç°¡æ˜“contextã‚’ä½œæˆã—ã¦æ¸¡ã™
    const previewContext = { matchId: 'preview' };
    const previewArticle = await generateNewsArticle(previewContext);
    if (previewArticle) tournamentState.news.unshift(previewArticle);
    if(previewArticle) 
        tournamentState.news.unshift(previewArticle);
    

    renderNews(tournamentState.news);
    saveState();
}


// --- AI Content Generation & Helpers (Part A: Main Generators) ---

/**
 * [NEW HELPER] æ—¥ä»˜æ–‡å­—åˆ—é–“ã®ã€Œä¸­næ—¥ã€ã‚’æ­£ç¢ºã«è¨ˆç®—ã—ã¦æ–‡å­—åˆ—ã‚’è¿”ã™
 * @param {string} currentDateStr - ä»Šæ—¥ã®æ—¥ä»˜ (ä¾‹: "7/15")
 * @param {string} prevDateStr - å‰å›ã®æ—¥ä»˜ (ä¾‹: "7/10")
 * @param {number} baseYear - å¤§ä¼šã®å¹´åº¦
 * @returns {string} - " (é€£æŠ•)", " (ä¸­1æ—¥)", " (ä¸­4æ—¥)" ãªã©
 */
function getRestDaysString(currentDateStr, prevDateStr, baseYear) {
    if (!currentDateStr || !prevDateStr) return "";
    if (currentDateStr === 'æ—¥ä»˜ä¸æ˜' || prevDateStr === 'æ—¥ä»˜ä¸æ˜') return "";
    
    const parse = (dStr) => {
        if (!dStr || !dStr.includes('/')) return null;
        const [m, d] = dStr.split('/').map(Number);
        // 1~3æœˆã¯ç¿Œå¹´æ‰±ã„ (å¹´åº¦ã¾ãŸãå¯¾å¿œ)
        const y = (m <= 3) ? baseYear + 1 : baseYear; 
        return new Date(y, m - 1, d);
    };

    const curr = parse(currentDateStr);
    const prev = parse(prevDateStr);
    
    if (!curr || !prev) return "";

    // ãƒŸãƒªç§’å·®åˆ†ã‚’æ—¥æ•°ã«å¤‰æ› (Math.roundã§å¾®ç´°ãªã‚ºãƒ¬ã‚’å¸å)
    const diffTime = curr - prev;
    const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays <= 0) return " (ãƒ€ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼)"; // åŒæ—¥ã¾ãŸã¯éå»
    if (diffDays === 1) return " (é€£æŠ•)"; // ç¿Œæ—¥ (å·®ãŒ1æ—¥ -> ä¸­0æ—¥)
    return ` (ä¸­${diffDays - 1}æ—¥)`; // 2æ—¥ä»¥ä¸Š (å·®ãŒ2æ—¥ -> ä¸­1æ—¥)
}

/**
 * è©¦åˆã®å…¨æƒ…å ±ã‚’é›†ç´„ã—ãŸã€ŒmatchContextã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã™ã‚‹å¸ä»¤å¡”
 * (â˜…ç™»æ¿é–“éš”ã®è¨ˆç®—ã‚’ä¿®æ­£ã—ãŸæœ€çµ‚ç‰ˆ)
 */
function createMatchContext(matchId, winnerName, team1QualityText, team2QualityText) {
    const dbMatch = findMatchById(matchId);
    if (!dbMatch) return null;

    // å¯¾æˆ¦ç›¸æ‰‹ã®éå»æˆç¸¾ãŒãªã„å ´åˆã€è‡ªå‹•ç”Ÿæˆã—ã¦åŸ‹ã‚ã‚‹
    backfillCpuStats(winnerName);
    backfillCpuStats(dbMatch.team1 === winnerName ? dbMatch.team2 : dbMatch.team1);

    const loserName = dbMatch.team1 === winnerName ? dbMatch.team2 : dbMatch.team1;
    const nextOpponentInfo = findNextOpponent(winnerName, matchId);
    let nextOpponentJourney = null;
    if (nextOpponentInfo && nextOpponentInfo.opponentName && !['ï¼ˆæœªå®šï¼‰', 'å„ªå‹'].includes(nextOpponentInfo.opponentName)) {
        nextOpponentJourney = getCurrentTournamentPerformance(nextOpponentInfo.opponentName, matchId);
    }

    const { highlights, keyPlayerNames } = createHighlightsText(dbMatch, winnerName);
    
    // --- Gamelogåé›† (ç™»æ¿é–“éš”ã®ä¿®æ­£é©ç”¨) ---
    let pitcherGamelogInfo = "\n### å‚è€ƒæƒ…å ±ï¼šä»Šå¤§ä¼šã®ä¸»ãªæŠ•æ‰‹ç™»æ¿å±¥æ­´ (ã“ã®è©¦åˆã‚ˆã‚Šå‰)\n";
    let relevantLogsFound = false;
    
    // â˜… ã“ã®è©¦åˆã®æ—¥ä»˜ã‚’å–å¾— (ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
    const todayStr = dbMatch.schedule?.date || "7/15";

    if (dbMatch.details && dbMatch.details.pitching) {
        for (const teamKey of ['team1', 'team2']) {
            const pitchingData = dbMatch.details.pitching[teamKey] || [];
            pitchingData.forEach(pitcher => {
                const playerName = pitcher.name;
                if (!playerName) return;
                const teamRecord = tournamentState.teamRecords[dbMatch[teamKey]];
                const pStats = teamRecord?.playerStats?.pitching[playerName];
                
                if (pStats && pStats.gamelogs && pStats.gamelogs.length > 0) {
                    const currentTournamentKey = tournamentState.currentTournament;
                    const previousLogs = pStats.gamelogs.filter(log => {
                        if (log.matchId === matchId) return false;
                        const logRound = log.round || '';
                        // å¤§ä¼šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                        if (currentTournamentKey === 'summer') return logRound.includes('å›æˆ¦') || logRound.includes('æ±ºå‹');
                        if (currentTournamentKey === 'autumn') return logRound.includes('åœ°åŒº') || logRound.includes('å›æˆ¦') || logRound.includes('æ±ºå‹');
                        if (currentTournamentKey === 'spring') return logRound.includes('åœ°åŒº') || logRound.includes('å›æˆ¦') || logRound.includes('æ±ºå‹');
                        return false;
                    });

                    if (previousLogs.length > 0) {
                        relevantLogsFound = true;
                        pitcherGamelogInfo += `- ${playerName} (${dbMatch[teamKey]}):\n`;
                        
                        // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ (ç°¡æ˜“ãƒ˜ãƒ«ãƒ‘ãƒ¼)
                        const parseForSort = (dStr) => {
                            if(!dStr || !dStr.includes('/')) return 0;
                            const [m, d] = dStr.split('/').map(Number);
                            return m * 100 + d;
                        };
                        previousLogs.sort((a, b) => parseForSort(a.date) - parseForSort(b.date));

                        previousLogs.forEach(log => {
                            // â˜… ã“ã“ã§æ–°ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½¿ç”¨ (æ­£ç¢ºã«è¨ˆç®—)
                            const intervalInfo = getRestDaysString(todayStr, log.date, tournamentState.tournamentYear);
                            const dateInfo = log.date + intervalInfo;
                            
                            const opponentRank = log.opponentRank || 'E';
                            const resultMark = {'W': 'â—‹', 'L': 'â—', 'S': 'ï¼³', 'H': 'ï¼¨'}[log.result] || '';
                            pitcherGamelogInfo += `  - ${log.round} (${dateInfo}) (å¯¾ ${log.opponent} [${opponentRank}]): ${resultMark}${log.ip}å› ${log.h}è¢«å®‰æ‰“ ${log.bb}å››çƒ ${log.so}å¥ªä¸‰æŒ¯ ${log.r}å¤±ç‚¹(è‡ªè²¬${log.er})\n`;
                        });
                    }
                }
            });
        }
    }
    if (!relevantLogsFound) {
        pitcherGamelogInfo = "\n### å‚è€ƒæƒ…å ±ï¼šä»Šå¤§ä¼šã®ä¸»ãªæŠ•æ‰‹ç™»æ¿å±¥æ­´\n- ã“ã®è©¦åˆã«å‡ºå ´ã—ãŸæŠ•æ‰‹ã¯ã€å…¨å“¡ä»Šå¤§ä¼šã“ã‚ŒãŒåˆç™»æ¿ã§ã™ã€‚\n";
    }

    // --- æ‰“è€…æˆç¸¾å±¥æ­´ ---
    let batterGamelogInfo = "\n### å‚è€ƒæƒ…å ±ï¼šä»Šå¤§ä¼šã®ä¸»ãªæ‰“è€…æˆç¸¾å±¥æ­´ (ã“ã®è©¦åˆã‚ˆã‚Šå‰)\n";
    let relevantBatterLogsFound = false;
    
    if (dbMatch.details && dbMatch.details.batting) {
        for (const teamKey of ['team1', 'team2']) {
            const battingData = dbMatch.details.batting[teamKey] || [];
            battingData.forEach(batter => {
                const playerName = batter.name;
                if (!playerName) return;
                const teamRecord = tournamentState.teamRecords[dbMatch[teamKey]];
                const bStats = teamRecord?.playerStats?.batting[playerName];
                if (bStats && bStats.gamelogs && bStats.gamelogs.length > 0) {
                    const currentTournamentKey = tournamentState.currentTournament;
                    const previousLogs = bStats.gamelogs.filter(log => {
                        if (log.matchId === matchId) return false;
                        const logRound = log.round || '';
                        if (currentTournamentKey === 'summer') return logRound.includes('å›æˆ¦') || logRound.includes('æ±ºå‹');
                        if (currentTournamentKey === 'autumn') return logRound.includes('åœ°åŒº') || logRound.includes('å›æˆ¦') || logRound.includes('æ±ºå‹');
                        if (currentTournamentKey === 'spring') return logRound.includes('åœ°åŒº') || logRound.includes('å›æˆ¦') || logRound.includes('æ±ºå‹');
                        return false;
                    });
                    if (previousLogs.length > 0) {
                        relevantBatterLogsFound = true;
                        batterGamelogInfo += `- ${playerName} (${dbMatch[teamKey]}):\n`;
                        
                        const parseForSort = (dStr) => {
                            if(!dStr || !dStr.includes('/')) return 0;
                            const [m, d] = dStr.split('/').map(Number);
                            return m * 100 + d;
                        };
                        previousLogs.sort((a, b) => parseForSort(a.date) - parseForSort(b.date));

                        previousLogs.forEach(log => {
                            // æ‰“è€…ã®å ´åˆã€ç™»æ¿é–“éš”ã¯ä¸è¦ãªã®ã§æ—¥ä»˜ã®ã¿
                            const dateInfo = log.date || 'æ—¥ä»˜ä¸æ˜';
                            const opponentRank = log.opponentRank || 'E';
                            const stats = log.stats || { ab: 0, h: 0, hr: 0, rbi: 0, sb: 0 };
                            let role = "";
                            if (log.sub_type === 'PH') role = "ä»£æ‰“";
                            else if (log.order && log.order.includes('sub')) role = "é€”ä¸­å‡ºå ´";
                            else if (log.order) role = `${log.order}ç•ª`;
                            else role = "å‡ºå ´";
                            const statsLine = `${stats.ab}æ‰“æ•°${stats.h}å®‰æ‰“ ${stats.hr}HR ${stats.rbi}æ‰“ç‚¹ ${stats.sb}ç›—å¡`;
                            batterGamelogInfo += `  - ${log.round} (${dateInfo}) (å¯¾ ${log.opponent} [${opponentRank}]) (${role}): ${statsLine}\n`;
                        });
                    }
                }
            });
        }
    }
    if (!relevantBatterLogsFound) {
        batterGamelogInfo = "\n### å‚è€ƒæƒ…å ±ï¼šä»Šå¤§ä¼šã®ä¸»ãªæ‰“è€…æˆç¸¾å±¥æ­´\n- ã“ã®è©¦åˆã«å‡ºå ´ã—ãŸæ‰“è€…ã¯ã€å…¨å“¡ä»Šå¤§ä¼šã“ã‚ŒãŒåˆå‡ºå ´ã§ã™ã€‚\n";
    }

    // çœŒå¤§ä¼šæˆç¸¾
    let prefecturalStatsText = "";
    if (tournamentState.currentTournament === 'summer_koshien') {
        const pStats = tournamentState.teamRecords[winnerName]?.prefecturalStats;
        if (pStats) {
            const avg = pStats.ab > 0 ? (pStats.h / pStats.ab).toFixed(3) : '.---';
            prefecturalStatsText += `- **${winnerName} (é™å²¡å¤§ä¼š)**: æ‰“ç‡${avg}, æœ¬å¡æ‰“${pStats.hr}, ç›—å¡${pStats.sb}, ç·å¾—ç‚¹${pStats.r}\n`;
        }
    }

    // æ•…éšœè€…ãƒªã‚¹ãƒˆ
    let injuryReportText = "\n### å‚è€ƒæƒ…å ±ï¼šä¸»ãªæ¬ å ´è€…ãƒ»æ€ªæˆ‘äººãƒªã‚¹ãƒˆ\n";
    let injuriesFound = false;
    for (const teamName of [winnerName, loserName]) {
        const teamRecord = tournamentState.teamRecords[teamName];
        if (!teamRecord || !teamRecord.playerStats) continue;
        const staticRoster = TEAM_ROSTER_MASTER[teamName]; 
        let checkList = [];
        if (staticRoster) {
            checkList = staticRoster.map(p => p.name);
        } else if (teamRecord.playerStats.batting) {
            checkList = Object.keys(teamRecord.playerStats.batting);
        }
        let injuredPlayers = []; 
        checkList.forEach(playerName => {
            const bFlag = teamRecord.playerStats.batting?.[playerName]?.narrative_flag;
            const pFlag = teamRecord.playerStats.pitching?.[playerName]?.narrative_flag;
            const flag = (bFlag === 'injured' || bFlag === 'sick' || bFlag === 'minor_injury') ? bFlag :
                         (pFlag === 'injured' || pFlag === 'sick' || pFlag === 'minor_injury') ? pFlag : null;
            if (flag) {
                const teamKey = dbMatch.team1 === teamName ? 'team1' : 'team2';
                const playedBatting = dbMatch.details?.batting?.[teamKey]?.some(p => p.name === playerName);
                const playedPitching = dbMatch.details?.pitching?.[teamKey]?.some(p => p.name === playerName);
                const isAbsent = !playedBatting && !playedPitching;
                let importance = 'Hikae';
                const staticData = staticRoster?.find(p => p.name === playerName);
                if (staticData && (staticData.number == 1 || staticData.isCaptain || staticData.position.includes('æ•'))) {
                    importance = 'Shuryoku_Static';
                } else {
                     const tourneyStats = calculateCurrentTournamentStats(
                        teamRecord.playerStats.batting?.[playerName]?.gamelogs, 
                        teamRecord.playerStats.pitching?.[playerName]?.gamelogs, 
                        matchId
                    );
                    if ((tourneyStats.AVG > 0.400 && tourneyStats.AB >= 5) || (tourneyStats.IP >= 5.0 && tourneyStats.ERA < 2.00)) {
                        importance = 'Shuryoku_Dynamic';
                    } else if (tourneyStats.AB >= 10 || tourneyStats.IP >= 10) {
                        importance = 'Regular_Dynamic';
                    }
                }
                injuredPlayers.push({ name: playerName, flag: flag, importance: importance, isAbsent: isAbsent });
            }
        });
        if (injuredPlayers.length > 0) {
            const playerStates = injuredPlayers.map(p => {
                let importanceLabel = 'æ§ãˆ';
                if (p.importance.startsWith('Shuryoku')) importanceLabel = 'ä¸»åŠ›';
                else if (p.importance.startsWith('Regular')) importanceLabel = 'ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼';
                let flagIcon = 'ğŸ©¹(è»½å‚·)'; 
                if (p.flag === 'injured') flagIcon = 'ğŸ¥(æ•…éšœ)';
                if (p.flag === 'sick') flagIcon = 'ğŸ˜·(ä½“èª¿ä¸è‰¯)';
                const status = p.isAbsent ? "**æ¬ å ´**" : "å¼·è¡Œå‡ºå ´";
                return `${p.name} ${flagIcon} [${importanceLabel}] -> ${status}`;
            });
            injuryReportText += `- **${teamName}**: ${playerStates.join(', ')}\n`;
            injuriesFound = true;
        }
    }
    if (!injuriesFound) {
        injuryReportText += "ç‰¹ç­†ã™ã¹ãæ•…éšœè€…ãƒ»æ¬ å ´è€…ã¯è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n";
    }

    const context = {
        winnerName,
        loserName,
        dbMatch,
        matchId,
        winnerData: TEAM_DATA[winnerName],
        loserData: TEAM_DATA[loserName],
        winnerDetailedData: DETAILED_TEAM_DATA[winnerName],
        loserDetailedData: DETAILED_TEAM_DATA[loserName],
        playerStatsText: dbMatch.details ? formatPlayerStatsForPrompt(dbMatch) : null,
        winnerJourney: getCurrentTournamentPerformance(winnerName, matchId),
        loserJourney: getCurrentTournamentPerformance(loserName, matchId),
        winnerLineupChanges: dbMatch.details ? analyzeLineupChanges(winnerName, dbMatch) : "æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ãªã—",
        loserLineupChanges: dbMatch.details ? analyzeLineupChanges(loserName, dbMatch) : "æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ãªã—",
        nextOpponent: nextOpponentInfo,
        nextOpponentJourney: nextOpponentJourney,
        highlights: highlights,
        keyPlayerNames: keyPlayerNames,
        calledGame: dbMatch.calledGame,
        calledInning: dbMatch.calledInning,
        rivalryType: dbMatch.rivalryType || null,
        atmosphere_team1: dbMatch.atmosphere_team1 || null,
        atmosphere_team2: dbMatch.atmosphere_team2 || null,
        schedule: dbMatch.schedule || null,
        team1BallQuality: team1QualityText || "ï¼ˆæ‰“çƒå“è³ªãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰",
        team2BallQuality: team2QualityText || "ï¼ˆæ‰“çƒå“è³ªãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰",
        pitcherGamelogInfo: pitcherGamelogInfo,
        batterGamelogInfo: batterGamelogInfo,
        injuryReport: injuryReportText,
        prefecturalStatsText: prefecturalStatsText
    };
    return context;
}

/**
 * [æˆç¸¾é€£å‹•ãƒ»å¼·åŒ–ç‰ˆ] ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´ã‚„æ‰“é †å…¥ã‚Œæ›¿ãˆã‚’ã€éå»ã®æˆç¸¾ã‚„ç›´è¿‘ã®æ´»èºã‚’æ ¹æ‹ ã«è©³ç´°ã«åˆ†æã™ã‚‹
 * @param {string} teamName - åˆ†æå¯¾è±¡ã®ãƒãƒ¼ãƒ å
 * @param {object} dbMatch - ç¾åœ¨ã®è©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {string} - å¤‰æ›´ç‚¹ã‚’ã¾ã¨ã‚ãŸãƒ†ã‚­ã‚¹ãƒˆ
 */
function analyzeLineupChanges(teamName, dbMatch) {
    const teamKey = dbMatch.team1 === teamName ? 'team1' : 'team2';
    if (!dbMatch.details || !dbMatch.details.batting || !dbMatch.details.batting[teamKey]) {
        return "æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ãªã—";
    }

    // 1. ç¾åœ¨ã®ã‚¹ã‚¿ãƒ¡ãƒ³æƒ…å ±ã‚’å–å¾—
    const currentStartersMap = {};
    dbMatch.details.batting[teamKey].forEach(p => {
        if (p.name && p.order && !p.order.toString().includes('sub')) {
            currentStartersMap[p.name] = parseInt(p.order);
        }
    });
    const currentStartersNames = Object.keys(currentStartersMap);

    // 2. éå»ã®å…¨è©¦åˆãƒ‡ãƒ¼ã‚¿ã‚’èµ°æŸ»ã—ã¦ã€Œæ–‡è„ˆã€ã‚’æ§‹ç¯‰
    const allMatches = { 
        ...tournamentState.matches, 
        ...(tournamentState.autumnData?.allMatches || {}),
        ...(tournamentState.springData?.allMatches || {}) 
    };

    const currentRoundSortKey = getRoundSortKey(dbMatch.id);
    const playerHistory = {};
    
    // éå»ã®è©¦åˆã‚’æŠ½å‡º
    const pastMatches = Object.values(allMatches).filter(m => {
        if (!m.winner || !m.details || !m.details.batting) return false;
        const tKey = m.team1 === teamName ? 'team1' : (m.team2 === teamName ? 'team2' : null);
        if (!tKey || !m.details.batting[tKey]) return false;
        const mSortKey = getRoundSortKey(m.id);
        return mSortKey < currentRoundSortKey;
    }).sort((a, b) => getRoundSortKey(a.id) - getRoundSortKey(b.id));

    if (pastMatches.length === 0) {
        return "ä»Šå¤§ä¼šåˆã‚¹ã‚¿ãƒ¡ãƒ³ã€‚";
    }

    // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®è“„ç©
    pastMatches.forEach((m, index) => {
        const tKey = m.team1 === teamName ? 'team1' : 'team2';
        const isLastMatch = (index === pastMatches.length - 1);
        
        m.details.batting[tKey].forEach(p => {
            if (p.name && p.order && !p.order.toString().includes('sub')) {
                const ord = parseInt(p.order);
                if (!playerHistory[p.name]) {
                    playerHistory[p.name] = { orderCounts: {}, lastOrder: null, totalStarts: 0 };
                }
                playerHistory[p.name].orderCounts[ord] = (playerHistory[p.name].orderCounts[ord] || 0) + 1;
                playerHistory[p.name].totalStarts++;
                if (isLastMatch) playerHistory[p.name].lastOrder = ord;
            }
        });
    });

    // --- 3. åˆ†æã¨æ–‡ç« ç”Ÿæˆ ---
    const topics = [];

    // ãƒ˜ãƒ«ãƒ‘ãƒ¼: æœ€å¤šæ‰“é †ã‚’å–å¾—
    const getMainOrder = (name) => {
        const history = playerHistory[name];
        if (!history) return null;
        let mainOrd = null, maxCount = -1;
        for (const [ord, count] of Object.entries(history.orderCounts)) {
            if (count > maxCount) { maxCount = count; mainOrd = parseInt(ord); }
        }
        return { order: mainOrd, count: maxCount, total: history.totalStarts };
    };

    // A. ã‚¹ã‚¿ãƒ¡ãƒ³ã€Œå…¥ã‚Šã€ã€Œè½ã¡ã€
    const lastMatchStarters = Object.keys(playerHistory).filter(name => playerHistory[name].lastOrder !== null);
    
    currentStartersNames.forEach(name => {
        if (!playerHistory[name] || playerHistory[name].lastOrder === null) {
            // å¾©å¸°ãƒ»åˆã‚¹ã‚¿ãƒ¡ãƒ³
            const narrative = getPlayerPreMatchNarrative(name, teamName, dbMatch.id);
            if (playerHistory[name] && playerHistory[name].totalStarts > 0) {
                topics.push(`${narrative}${name}ãŒã‚¹ã‚¿ãƒ¡ãƒ³å¾©å¸°`);
            } else {
                topics.push(`${name}ãŒä»Šå¤§ä¼šåˆã‚¹ã‚¿ãƒ¡ãƒ³`);
            }
        }
    });

    lastMatchStarters.forEach(name => {
        if (!currentStartersMap[name]) {
            // ã‚¹ã‚¿ãƒ¡ãƒ³è½ã¡
            const narrative = getPlayerPreMatchNarrative(name, teamName, dbMatch.id, true); // true=ä¸æŒ¯å¼·èª¿
            topics.push(`${narrative}${name}ãŒã‚¹ã‚¿ãƒ¡ãƒ³å¤–ã‚Œã‚‹`);
        }
    });

    // B. æ‰“é †å¤‰æ›´ï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒˆï¼‰
    currentStartersNames.forEach(name => {
        const currentOrd = currentStartersMap[name];
        const history = playerHistory[name];
        
        if (history && history.lastOrder !== null) {
            const prevOrd = history.lastOrder;
            const main = getMainOrder(name);
            const mainOrd = main.order;

            if (currentOrd !== prevOrd) {
                // æˆç¸¾ã«åŸºã¥ãæ•è©ã‚’å–å¾—
                // æ˜‡æ ¼ãªã‚‰ãƒã‚¸ãƒ†ã‚£ãƒ–ã€é™æ ¼ãªã‚‰ãƒã‚¬ãƒ†ã‚£ãƒ–ãªæƒ…å ±ã‚’å„ªå…ˆ
                const isPromotion = (currentOrd < prevOrd) || (currentOrd === 4);
                const narrative = getPlayerPreMatchNarrative(name, teamName, dbMatch.id, !isPromotion);

                if (prevOrd === 4 && currentOrd !== 4) {
                    topics.push(`${narrative}4ç•ªã ã£ãŸ${name}ã‚’${currentOrd}ç•ªã«é…ç½®è»¢æ›`);
                } else if (prevOrd !== 4 && currentOrd === 4) {
                    topics.push(`${narrative}${name}ã‚’æ–°4ç•ªã«æŠœæ“¢`);
                } else if (currentOrd === 1 && mainOrd >= 3) {
                    topics.push(`${narrative}ä¸­è»¸ã®${name}ã‚’1ç•ªã«ç½®ãæ”»æ’ƒçš„ã‚ªãƒ¼ãƒ€ãƒ¼`);
                } else if (prevOrd >= 6 && currentOrd <= 5) {
                    topics.push(`${narrative}${name}ã‚’${currentOrd}ç•ªã«æ˜‡æ ¼`);
                } else if (prevOrd <= 5 && currentOrd >= 6) {
                    topics.push(`${narrative}${name}ã‚’${currentOrd}ç•ªã«ä¸‹ã’ã‚‹ãƒ†ã‚³å…¥ã‚Œ`);
                } else {
                    topics.push(`${narrative}${name}(${prevOrd}â†’${currentOrd}ç•ª)`);
                }
            }
        }
    });

    if (topics.length === 0) return "ä¸å‹•ã®ã‚ªãƒ¼ãƒ€ãƒ¼ã€‚";

    // å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆï¼ˆ4ç•ªã€æŠœæ“¢ã€å¥½èª¿ãªé¸æ‰‹ã‚’å…ˆã«ï¼‰
    const priorityKeywords = ['4ç•ª', 'æŠœæ“¢', 'æ˜‡æ ¼', 'æ”»æ’ƒçš„', 'æ‰“ç‡', 'æœ¬å¡æ‰“', 'å¾©å¸°'];
    topics.sort((a, b) => {
        const scoreA = priorityKeywords.some(k => a.includes(k)) ? 1 : 0;
        const scoreB = priorityKeywords.some(k => b.includes(k)) ? 1 : 0;
        return scoreB - scoreA;
    });

    if (topics.length >= 5) {
        return `æ‰“é †ã‚’å¤§å¹…ã«çµ„ã¿æ›¿ãˆã€‚${topics.slice(0, 3).join('ã€')}ãªã©ã€‚`;
    }
    return `ä¸»ãªå¤‰æ›´ç‚¹: ${topics.join('ã€')}ã€‚`;
}

/**
 * [NEW] é¸æ‰‹ã®è©¦åˆå‰ã¾ã§ã®æˆç¸¾ã‚’é›†è¨ˆã—ã€æ‰“é †å¤‰æ›´ã®ç†ç”±ã¨ãªã‚Šãã†ãªã€Œèªã‚Šï¼ˆãƒŠãƒ©ãƒ†ã‚£ãƒ–ï¼‰ã€ã‚’ç”Ÿæˆã™ã‚‹
 * @param {string} playerName - é¸æ‰‹å
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 * @param {string} currentMatchId - ç¾åœ¨ã®è©¦åˆIDï¼ˆã“ã‚Œä»¥å‰ã®æˆç¸¾ã‚’è¦‹ã‚‹ï¼‰
 * @param {boolean} focusOnNegative - ä¸æŒ¯æƒ…å ±ã‚’å„ªå…ˆã™ã‚‹ã‹ã©ã†ã‹ï¼ˆé™æ ¼æ™‚ãªã©ï¼‰
 * @returns {string} - ã€Œä»Šå¤§ä¼šæ‰“ç‡.450ã®ã€ã€Œå‰æˆ¦2ç™ºã®ã€ã¨ã„ã£ãŸæ•è©
 */
function getPlayerPreMatchNarrative(playerName, teamName, currentMatchId, focusOnNegative = false) {
    const teamRecord = tournamentState.teamRecords[teamName];
    if (!teamRecord || !teamRecord.playerStats || !teamRecord.playerStats.batting[playerName]) {
        return "";
    }

    const pStats = teamRecord.playerStats.batting[playerName];
    if (!pStats.gamelogs || pStats.gamelogs.length === 0) return "";

    // ç¾åœ¨ã®è©¦åˆã‚ˆã‚Šå‰ã®ãƒ­ã‚°ã®ã¿æŠ½å‡º
    const currentRoundSortKey = getRoundSortKey(currentMatchId);
    const validLogs = pStats.gamelogs.filter(log => {
        return getRoundSortKey(log.matchId) < currentRoundSortKey;
    }).sort((a, b) => getRoundSortKey(b.matchId) - getRoundSortKey(a.matchId)); // æ–°ã—ã„é †

    if (validLogs.length === 0) return "";

    // é›†è¨ˆ
    let ab = 0, h = 0, hr = 0, rbi = 0;
    validLogs.forEach(log => {
        ab += log.stats.ab || 0;
        h += log.stats.h || 0;
        hr += log.stats.hr || 0;
        rbi += log.stats.rbi || 0;
    });

    const avg = ab > 0 ? h / ab : 0;
    const lastGame = validLogs[0]; // ç›´è¿‘ã®è©¦åˆ
    const lastStats = lastGame.stats || {};

    // --- æ–‡ç« ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---
    
    // 1. ç›´è¿‘ã®ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆçµ¶å¤§ï¼ˆå‰æˆ¦HRãªã©ï¼‰
    if (!focusOnNegative) {
        if (lastStats.hr >= 2) return `å‰æˆ¦${lastGame.round}ã§2ç™ºã‚’æ”¾ã£ãŸ`;
        if (lastStats.hr >= 1) return `å‰æˆ¦ã§æœ¬å¡æ‰“ã‚’æ”¾ã£ãŸ`;
        if (lastStats.h >= 3) return `å‰æˆ¦${lastStats.h}å®‰æ‰“ã¨å½“ãŸã£ã¦ã„ã‚‹`;
        if (lastStats.rbi >= 3) return `å‰æˆ¦${lastStats.rbi}æ‰“ç‚¹ã‚’æŒ™ã’ãŸ`;
    }

    // 2. å¤§ä¼šé€šç®—æˆç¸¾ãŒå‡„ã¾ã˜ã„
    if (!focusOnNegative) {
        if (hr >= 2) return `ä»Šå¤§ä¼š${hr}æœ¬å¡æ‰“${rbi > 5 ? `ãƒ»${rbi}æ‰“ç‚¹` : ''}ã®`;
        if (avg >= 0.500 && ab >= 5) return `ä»Šå¤§ä¼šæ‰“ç‡${avg.toFixed(3).substring(1)}ã¨çµ¶å¥½èª¿ã®`;
        if (avg >= 0.400 && ab >= 5) return `æ‰“ç‡4å‰²è¶…ãˆã®`;
        if (rbi >= 5) return `ä»Šå¤§ä¼š${rbi}æ‰“ç‚¹ã®å‹è² å¼·ã•ã‚’æŒã¤`;
        if (pStats.sb >= 3) return `ä»Šå¤§ä¼š${pStats.sb}ç›—å¡ã¨è¶³ã®ä½¿ãˆã‚‹`;
    }

    // 3. ä¸æŒ¯ï¼ˆé™æ ¼ãƒ»ã‚¹ã‚¿ãƒ¡ãƒ³è½ã¡ç”¨ï¼‰
    if (focusOnNegative) {
        if (ab >= 5 && avg <= 0.100) return `ä»Šå¤§ä¼šæ‰“ç‡${avg.toFixed(3).substring(1)}ã¨ä¸æŒ¯ã®`;
        if (ab >= 10 && h === 0) return `ä»Šå¤§ä¼šãƒãƒ¼ãƒ’ãƒƒãƒˆã®`;
        if (lastStats.ab >= 3 && lastStats.h === 0) return `å‰æˆ¦ç„¡å®‰æ‰“ã«çµ‚ã‚ã£ãŸ`;
    }

    // 4. ç‰¹ã«ãªã—
    return "";
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
/**
 * æ‰“å¸­çµæœã®æ–‡å­—åˆ—ã‚’ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ãˆã‚‹æ—¥æœ¬èªã¨ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ã™ã‚‹
 */
function translatePlay(atBatString) {
    if (!atBatString) return { description: "è¨˜éŒ²ãªã—", type: "none", out: false, base: 0 };
    
    const s = atBatString;
    if (s.includes('æœ¬å¡æ‰“')) return { description: `ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³`, type: "hr", out: false, base: 4 };
    if (s.includes('ä¸‰å¡æ‰“')) return { description: `ä¸‰å¡æ‰“`, type: "triple", out: false, base: 3 };
    if (s.includes('äºŒå¡æ‰“')) return { description: `äºŒå¡æ‰“`, type: "double", out: false, base: 2 };
    if (s.includes('å®‰')) return { description: `ãƒ’ãƒƒãƒˆ`, type: "single", out: false, base: 1 };
    
    if (s.includes('å››çƒ') || s.includes('æ­»çƒ') || s.includes('æ•¬é ')) return { description: `å››æ­»çƒ`, type: "walk", out: false, base: 1 };
    if (s.includes('ã‚¨ãƒ©ãƒ¼') || s.includes('é‡é¸') || s.includes('çŠ å¤±')) return { description: `ã‚¨ãƒ©ãƒ¼/é‡é¸`, type: "error", out: false, base: 1 };

    if (s.includes('çŠ é£›')) return { description: `çŠ ç‰²ãƒ•ãƒ©ã‚¤`, type: "sac_fly", out: true, base: 0 };
    if (s.includes('çŠ æ‰“')) return { description: `çŠ ç‰²ãƒãƒ³ãƒˆ`, type: "sac_bunt", out: true, base: 0 };
    if (s.includes('ä½µæ®º')) return { description: `ä½µæ®ºæ‰“`, type: "dp", out: true, base: 0 }; // 2ã‚¢ã‚¦ãƒˆã¯åˆ¥é€”å‡¦ç†

    if (s.includes('ä¸‰æŒ¯')) return { description: `ä¸‰æŒ¯`, type: "so", out: true, base: 0 };

// â–¼â–¼â–¼ ã“ã® if ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    if (s.includes('é‚ª')) return { description: `ãƒ•ã‚¡ã‚¦ãƒ«ãƒ•ãƒ©ã‚¤`, type: "ff", out: true, base: 0 };
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    if (s.includes('ã‚´ãƒ­')) return { description: `ã‚´ãƒ­`, type: "go", out: true, base: 0 };
    if (s.includes('é£›')) return { description: `ãƒ•ãƒ©ã‚¤`, type: "fo", out: true, base: 0 };
    if (s.includes('ç›´')) return { description: `ãƒ©ã‚¤ãƒŠãƒ¼`, type: "lo", out: true, base: 0 };
    
    return { description: `ãã®ä»–`, type: "other", out: false, base: 0 };
}

/**
 * 1ã‚¤ãƒ‹ãƒ³ã‚°åˆ†ã®è©¦åˆçµŒéã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹
 */
function processHalfInning(dbMatch, teamKey, inningIndex, batterIndices) {
    let halfInningText = "";
    let outs = 0;
    let bases = [null, null, null]; // [1B, 2B, 3B]
    
    const battingOrder = dbMatch.details.batting[teamKey].filter(p => p.name).sort((a,b) => a.order - b.order);
    if (battingOrder.length === 0) return "";
    
    let batterIndex = batterIndices[teamKey];
    let atBatsInInning = 0;

    while (outs < 3) {
        const batter = battingOrder[batterIndex];
        const resultString = batter.results[inningIndex] || "";
        const atBatsForPlayer = resultString.split('ã€');

        // ã“ã®ã‚¤ãƒ‹ãƒ³ã‚°ã§ã“ã®æ‰“è€…ãŒã¾ã æ‰“å¸­ã«ç«‹ã£ã¦ã„ãªã„å ´åˆã¯ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
        if (atBatsForPlayer.length <= atBatsInInning) break; 
        
        const currentAtBatString = atBatsForPlayer[atBatsInInning];
        if(!currentAtBatString) break;

        const play = translatePlay(currentAtBatString);
        
        // 1. æ‰“å¸­çµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ 
        halfInningText += `${batter.order}ç•ª ${batter.name} (${batter.pos}): ${play.description}\n`;

        // 2. ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
        if(play.out) outs++;
        if(play.type === 'dp') outs++; // ä½µæ®ºæ‰“

        if (outs >= 3) {
            halfInningText += `  â†’ ${outs}ã‚¢ã‚¦ãƒˆ\n`;
            batterIndex = (batterIndex + 1) % battingOrder.length;
            break;
        }
        
        // 3. ãƒ©ãƒ³ãƒŠãƒ¼ã‚’é€²å¡ã•ã›ã‚‹ï¼ˆç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        const newBases = [null, null, null];
        let batterOnBase = false;

        // ã¾ãšãƒ©ãƒ³ãƒŠãƒ¼ã‚’é€²ã‚ã‚‹ (3å¡ã‹ã‚‰)
        if (bases[2]) { // 3å¡ãƒ©ãƒ³ãƒŠãƒ¼
            if (play.base >= 1 || play.type === 'sac_fly' || play.type === 'walk') newBases[2] = null; // ç”Ÿé‚„
            else newBases[2] = bases[2];
        }
        if (bases[1]) { // 2å¡ãƒ©ãƒ³ãƒŠãƒ¼
            if (play.base >= 2) newBases[1] = null; // ç”Ÿé‚„
            else if (play.base === 1 || play.type === 'sac_bunt') newBases[2] = bases[1];
            else newBases[1] = bases[1];
        }
        if (bases[0]) { // 1å¡ãƒ©ãƒ³ãƒŠãƒ¼
            if (play.base >= 3) newBases[0] = null; // ç”Ÿé‚„
            else if (play.base === 2) newBases[2] = bases[0];
            else if (play.base === 1 || play.type === 'sac_bunt' || play.type === 'walk') newBases[1] = bases[0];
            else newBases[0] = bases[0];
        }
        
        // æ‰“è€…èµ°è€…ã‚’å¡ã«å‡ºã™
        if (!play.out && play.base > 0) {
            newBases[play.base - 1] = batter.name;
        }

        bases = newBases;
        
        // 4. ç¾åœ¨ã®çŠ¶æ³ã‚’ãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ 
        const runners = [];
        if(bases[0]) runners.push("1å¡");
        if(bases[1]) runners.push("2å¡");
        if(bases[2]) runners.push("3å¡");
        const runnerText = runners.length > 0 ? `ãƒ©ãƒ³ãƒŠãƒ¼${runners.join(', ')}` : "ãƒ©ãƒ³ãƒŠãƒ¼ãªã—";
        halfInningText += `  â†’ ${outs}ã‚¢ã‚¦ãƒˆ, ${runnerText}\n`;
        
        batterIndex = (batterIndex + 1) % battingOrder.length;
        atBatsInInning++;
    }

    batterIndices[teamKey] = batterIndex; // æ¬¡ã®ã‚¤ãƒ‹ãƒ³ã‚°ã®å…ˆé ­æ‰“è€…ã‚’è¨˜æ†¶
    
    if (outs < 3) {
      halfInningText += `(${outs}ã‚¢ã‚¦ãƒˆã§ã‚¤ãƒ‹ãƒ³ã‚°çµ‚äº†)\n`;
    }
    
    halfInningText += "ãƒã‚§ãƒ³ã‚¸\n";
    return halfInningText;
}

/**
 * å…¨ã‚¤ãƒ‹ãƒ³ã‚°ã®è©¦åˆçµŒéãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹ãƒã‚¹ã‚¿ãƒ¼é–¢æ•°
 */
function generatePlayByPlayText(dbMatch) {
    if (!dbMatch || !dbMatch.details) return "è©³ç´°ãªè©¦åˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";

    let playByPlay = "";
    const numInnings = dbMatch.details.inningScore?.team1?.length || 9;
    // å„ãƒãƒ¼ãƒ ã®æ¬¡ã®å…ˆé ­æ‰“è€…ã‚’è¨˜éŒ²ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    let batterIndices = { team1: 0, team2: 0 };

    for (let i = 0; i < numInnings; i++) {
        // è¡¨ã®æ”»æ’ƒ
        playByPlay += `\nã€${i + 1}å›è¡¨ã€‘${dbMatch.team1}ã®æ”»æ’ƒ\n`;
        playByPlay += processHalfInning(dbMatch, 'team1', i, batterIndices);
        
        // ã‚µãƒ¨ãƒŠãƒ©ã‚²ãƒ¼ãƒ ã®åˆ¤å®š
        if (i >= 8) { // 9å›è¡¨ä»¥é™
            const score1 = (dbMatch.details.inningScore.team1 || []).slice(0, i + 1).reduce((a, b) => a + (b || 0), 0);
            const score2 = (dbMatch.details.inningScore.team2 || []).slice(0, i + 1).reduce((a, b) => a + (b || 0), 0);
            if (dbMatch.team2 === dbMatch.winner && score2 > score1) {
                 break;
            }
        }

        // è£ã®æ”»æ’ƒ
        playByPlay += `\nã€${i + 1}å›è£ã€‘${dbMatch.team2}ã®æ”»æ’ƒ\n`;
        playByPlay += processHalfInning(dbMatch, 'team2', i, batterIndices);
    }

    playByPlay += "\n--- è©¦åˆçµ‚äº† ---\n";
    return playByPlay;
}

/**
 * Finds a specific team's final result in the tournament.
 */
function getTeamFateSummary(teamName) {
    const allMatches = { 
        ...tournamentState.matches, 
        ...(tournamentState.autumnData?.allMatches || {}),
        ...(tournamentState.springData?.allMatches || {}) 
    };

    for (const matchId in allMatches) {
        const match = allMatches[matchId];
        if (match.winner && (match.team1 === teamName || match.team2 === teamName)) {
            if (match.winner !== teamName) {
                const opponent = match.winner;
                const score1 = match.team1 === teamName ? match.score1 : match.score2;
                const score2 = match.team1 === teamName ? match.score2 : match.score1;
                const roundNum = match.id.includes('-R') ? parseInt(match.id.split('-')[1].slice(1)) : 1;
                return `${roundNum}å›æˆ¦ã§${opponent}ã«${score1}-${score2}ã§æ•—é€€ã—ãŸã€‚`;
            }
        }
    }
    
    // Check if the team is still in the tournament
    const isStillIn = Object.values(allMatches).some(match => !match.winner && (match.team1 === teamName || match.team2 === teamName));
    if(isStillIn) {
        return "ã¾ã å‹ã¡æ®‹ã£ã¦ã„ã‚‹ã€‚";
    }

    return "ï¼ˆä»Šå¤§ä¼šã«ã¯å‡ºå ´ã—ã¦ã„ãªã„ã‹ã€æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰";
}
   



/**
     * ãƒãƒ¼ãƒ ã®ç´¹ä»‹æ–‡ã‚’å‹•çš„ã«ç”Ÿæˆã™ã‚‹æœ€çµ‚é€²åŒ–ç‰ˆã€‚
     * TEAM_DATAã®å›ºå®šæƒ…å ±ã«ã€æœ€æ–°ã®æˆç¸¾æƒ…å ±ã‚’ä»˜ã‘åŠ ãˆã‚‹ã€‚
     * (â˜… ãƒãƒ¼ãƒ ã®ã€Œé€šç®—ã€æ‰“ç‡ãƒ»ç›—å¡æ•°ã®é›†è¨ˆã‚’è¿½åŠ  â˜…)
     * @param {string} teamName - ãƒãƒ¼ãƒ å
     * @param {object} teamData - TEAM_DATAã‹ã‚‰å–å¾—ã—ãŸãã®ãƒãƒ¼ãƒ ã®åŸºæœ¬æƒ…å ±
     * @param {object} teamRecord - tournamentState.teamRecordsã‹ã‚‰å–å¾—ã—ãŸãã®ãƒãƒ¼ãƒ ã®æˆç¸¾è¨˜éŒ²
     * @returns {string} - ç”Ÿæˆã•ã‚ŒãŸæœ€æ–°ã®ç´¹ä»‹æ–‡
     */
    function generateDynamicTeamInfo(teamName, teamData, teamRecord) {
        if (!teamData) {
            console.error(`TEAM_DATAã«ãƒãƒ¼ãƒ ã€Œ${teamName}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åå‰ã®ã‚¿ã‚¤ãƒ—ãƒŸã‚¹ãŒãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            return `${teamName}ã®ãƒãƒ¼ãƒ æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`;
        }
        
        const baseInfo = teamData.info || `${teamName}ã®æƒ…å ±ã¯ä¸æ˜ã§ã™ã€‚`;

        // ãƒãƒ¼ãƒ ã®æˆç¸¾è¨˜éŒ²ãŒã¾ã ãªã„ï¼ˆï¼1å¹´ç›®ã®é€”ä¸­ãªã©ï¼‰å ´åˆã¯ã€åŸºæœ¬æƒ…å ±ã ã‘ã‚’è¿”ã™
        if (!teamRecord || !teamRecord.history || teamRecord.history.length === 0) {
            return baseInfo;
        }

        const history = teamRecord.history;

        // --- ã“ã“ã‹ã‚‰ãŒè¿½åŠ æƒ…å ±ã®ç”Ÿæˆ ---
        let additionalNarrative = []; // è¿½åŠ æƒ…å ±ã‚’å…¥ã‚Œã‚‹é…åˆ—

        // å‰µéƒ¨å¹´æ•°ã‚’è¨ˆç®— (2å¹´ç›®ä»¥é™ã«æ„å‘³ã‚’æŒã¤æƒ…å ±)
        if (history.length > 0) {
            const establishedYear = history[history.length - 1].year;
            const yearsPassed = tournamentState.tournamentYear - establishedYear + 1;
            if (yearsPassed > 1) {
                additionalNarrative.push(`å‰µéƒ¨${yearsPassed}å¹´ç›®ã€‚`);
            }
        }
        
        // ç›´è¿‘ã®å¤§ä¼šã®æˆç¸¾
        const prevRankLabel = teamRecord.previousRank ? getRankString(teamRecord.previousRank) : null;
        if (prevRankLabel && prevRankLabel !== 'ãªã—') {
            additionalNarrative.push(`å‰å¤§ä¼šã¯${prevRankLabel}ã€‚`);
        }

        // éå»æœ€é«˜æˆç¸¾
        const bestFinishLabel = teamRecord.best?.rank ? getRankString(teamRecord.best.rank) : null;
        if (bestFinishLabel && bestFinishLabel !== 'ãªã—') {
            additionalNarrative.push(`éå»æœ€é«˜ã¯${bestFinishLabel}ã€‚`);
        }

        // ç§°å·ï¼ˆTraitsï¼‰
        if (teamRecord.teamTraits && teamRecord.teamTraits.length > 0) {
            teamRecord.teamTraits.forEach(traitId => {
                const trait = Object.values(TITLES).find(t => t.id === traitId);
                if (trait) {
                    additionalNarrative.push(`ã€Œ${trait.name}ã€ã€‚`);
                }
            });
        }

        // ä»Šå¤§ä¼šã®ãƒãƒ¼ãƒ æ‰“ç‡ã‚’è¿½åŠ 
        const tourneyStats = teamRecord.tournamentStats;
        if (tourneyStats && tourneyStats.ab > 5) { 
            const avg = (tourneyStats.h / tourneyStats.ab).toFixed(3);
            additionalNarrative.push(`ä»Šå¤§ä¼šã®ãƒãƒ¼ãƒ æ‰“ç‡ã¯${avg}ã€‚`);
        }

        // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
        // (ä»Šå¤§ä¼šã¨ã¯åˆ¥ã«)ã€Œé€šç®—ã€ã®ãƒãƒ¼ãƒ æˆç¸¾ã‚‚é›†è¨ˆ
        const careerBattingStats = teamRecord.playerStats?.batting;
        if (careerBattingStats) {
            let totalCareerAb = 0;
            let totalCareerH = 0;
            let totalCareerSb = 0;
            
            for (const playerName in careerBattingStats) {
                const stats = careerBattingStats[playerName];
                totalCareerAb += stats.ab || 0;
                totalCareerH += stats.h || 0;
                totalCareerSb += stats.sb || 0; // â˜…é€šç®—ç›—å¡ã‚’é›†è¨ˆ
            }

            if (totalCareerAb > 10) { // ãƒãƒ¼ãƒ é€šç®—æ‰“æ•°ãŒã‚ã‚‹ç¨‹åº¦ã‚ã‚‹å ´åˆ
                const careerAvg = (totalCareerH / totalCareerAb).toFixed(3);
                // â˜…é€šç®—ç›—å¡ã‚‚æƒ…å ±ã«è¿½åŠ 
                additionalNarrative.push(`(å‚è€ƒ: ãƒãƒ¼ãƒ é€šç®—æ‰“ç‡ ${careerAvg}, é€šç®— ${totalCareerSb} ç›—å¡)`); 
            }
        }
        // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

        // --- æœ€çµ‚çš„ãªç´¹ä»‹æ–‡ã®çµ„ã¿ç«‹ã¦ ---
        if (additionalNarrative.length > 0) {
            return `${baseInfo} ${additionalNarrative.join(' ')}`;
        } 
        else {
            return baseInfo;
        }
    }
 
/**
 * é¸æ‰‹ã®å‡ºå ´å½¢å¼ã‚³ãƒ¼ãƒ‰ã‚’ã€è¨˜äº‹ã§ä½¿ãˆã‚‹è‡ªç„¶ãªæ—¥æœ¬èªã«å¤‰æ›ã™ã‚‹ï¼ˆç¿»è¨³æ©Ÿï¼‰
 * @param {object} player - é¸æ‰‹ã®ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {string} - å‡ºå ´å½¢å¼ã‚’èª¬æ˜ã™ã‚‹æ–‡ç« 
 */
function getSubstitutionDescription(player) {
    // äº¤ä»£é¸æ‰‹ã§ãªã„ï¼ˆã‚¹ã‚¿ãƒ¡ãƒ³ï¼‰å ´åˆã¯ "ã‚¹ã‚¿ãƒ¡ãƒ³å‡ºå ´" ã¨ã™ã‚‹
    if (!player.sub_type) {
        return 'ã‚¹ã‚¿ãƒ¡ãƒ³å‡ºå ´';
    }

    // sub_typeã®å€¤ã«å¿œã˜ã¦ã€è¿”ã™æ–‡ç« ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
    switch (player.sub_type) {
        case 'PH':
            return 'ä»£æ‰“ã§å‡ºå ´';
        case 'PR':
            return 'ä»£èµ°ã§å‡ºå ´';
        case 'DEF':
            return 'å®ˆå‚™å›ºã‚ã§å‡ºå ´';
        // â–¼â–¼â–¼ ADD THIS CASE â–¼â–¼â–¼
        case 'PITCHER': return 'ãƒªãƒªãƒ¼ãƒ•ã¨ã—ã¦ç™»æ¿';
        // â–²â–²â–² END OF ADDITION â–²â–²â–²
        default:
            return 'é€”ä¸­å‡ºå ´'; // ä½•ã‚‰ã‹ã®ç†ç”±ã§sub_typeãŒä¸Šè¨˜ä»¥å¤–ã®å ´åˆ
    }
}

/**
 * è©¦åˆã®å€‹äººæˆç¸¾ã‚’AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹
 * (â˜…é¸æ‰‹ã®ã€Œä»Šå¤§ä¼šã®é€šç®—æˆç¸¾ã€ã‚µãƒãƒªãƒ¼ã‚’è¿½åŠ ã—ãŸæœ€çµ‚ç‰ˆ)
 * @param {object} dbMatch - è©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {string} - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ
 */
function formatPlayerStatsForPrompt(dbMatch) {
    if (!dbMatch || !dbMatch.details || !dbMatch.details.playerGameStats) {
        return 'è©³ç´°ãªå€‹äººæˆç¸¾ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
    }

    const { details, winner } = dbMatch;

    const formatTeamStats = (teamKey) => {
        const teamName = dbMatch[teamKey];
        const teamRecord = tournamentState.teamRecords[teamName]; 
        const isWinner = teamName === winner;
        const battingOrder = details.batting?.[teamKey] || [];
        const gameStats = details.playerGameStats?.[teamKey] || {};
        const pitchingData = details.pitching?.[teamKey] || [];

        let output = `\n**${teamName} (${isWinner ? 'å‹è€…' : 'æ•—è€…'})**\n`;

        const sortedBatters = battingOrder.sort((a, b) => {
            const orderA = parseFloat(a.order.replace('-sub', '.'));
            const orderB = parseFloat(b.order.replace('-sub', '.'));
            return orderA - orderB;
        });

        sortedBatters.forEach(player => {
            if (!player.name) return;
            const stats = gameStats[player.name]; // ã“ã®è©¦åˆã®æˆç¸¾
            
            // â˜… (stats.played=true) ã ã‘ã§ãªãã€ç›—å¡(sb>0)ã‚„å®ˆå‚™äº¤ä»£(DEF)ãªã©ã‚‚å«ã‚ã‚‹
            const isNonBattingSub = player.sub_type === 'DEF' || player.sub_type === 'PR';
            if (!stats || (!stats.played && (stats.sb || 0) === 0 && !isNonBattingSub)) return; 

            const careerStats = teamRecord?.playerStats?.batting[player.name]; // é€šç®—/Gamelogä¿æŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            let statusText = "";
            if (careerStats && careerStats.narrative_flag) {
                const flagMap = {
                    "hot_streak": "çµ¶å¥½èª¿", "powered_up": "ä¸€ç™ºè­¦æˆ’",
                    "clutch_hitter": "å‹è² å¼·ã•â—", "slumping": "ä¸æŒ¯"
                };
                statusText = ` (çŠ¶æ…‹: ${flagMap[careerStats.narrative_flag] || careerStats.narrative_flag})`;
            }

            let batHandText = "";
            if (player.throwBat) {
                if (player.throwBat.endsWith('/R')) batHandText = "ï¼ˆå³æ‰“ï¼‰";
                else if (player.throwBat.endsWith('/L')) batHandText = "ï¼ˆå·¦æ‰“ï¼‰";
                else if (player.throwBat.endsWith('/S')) batHandText = "ï¼ˆä¸¡æ‰“ï¼‰";
            }            

            // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
            // é¸æ‰‹ã®ã€Œä»Šå¤§ä¼šã€ã®é€šç®—æˆç¸¾ã‚’ Gamelog ã‹ã‚‰é›†è¨ˆã™ã‚‹
            let tournamentTotalStatsText = "";
            if (careerStats && careerStats.gamelogs && careerStats.gamelogs.length > 0) {
                let tourneyStats = { sb: 0, hr: 0, h: 0, ab: 0 };
                const currentTournamentKey = tournamentState.currentTournament;
                
                careerStats.gamelogs.forEach(log => {
                    // ã“ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®Gamelogã ã‘ã‚’æŠ½å‡º (ã“ã®è©¦åˆ(dbMatch.id)ã¯é™¤ã)
                    const logRound = log.round || '';
                    let isInThisTournament = false;
                    if (currentTournamentKey === 'summer') isInThisTournament = logRound.includes('å›æˆ¦') || logRound.includes('æ±ºå‹');
                    else if (currentTournamentKey === 'autumn') isInThisTournament = logRound.includes('åœ°åŒº') || logRound.includes('å›æˆ¦') || logRound.includes('æ±ºå‹');
                    else if (currentTournamentKey === 'spring') isInThisTournament = logRound.includes('åœ°åŒº') || logRound.includes('å›æˆ¦') || logRound.includes('æ±ºå‹');
                    
                    if (isInThisTournament && log.matchId !== dbMatch.id) { // ã“ã®è©¦åˆã‚ˆã‚Šã€Œå‰ã€ã®æˆç¸¾
                        tourneyStats.sb += log.stats?.sb || 0;
                        tourneyStats.hr += log.stats?.hr || 0;
                        tourneyStats.h += log.stats?.h || 0;
                        tourneyStats.ab += log.stats?.ab || 0;
                    }
                });
                
                // ã€Œã“ã®è©¦åˆã€ã®æˆç¸¾(stats)ã‚’åŠ ç®—
                const thisGameSB = stats.sb || 0;
                const thisGameHR = stats.hr || 0;
                
                const finalTourneySB = tourneyStats.sb + thisGameSB;
                const finalTourneyHR = tourneyStats.hr + thisGameHR;
                const finalTourneyH = tourneyStats.h + (stats.h || 0);
                const finalTourneyAB = tourneyStats.ab + (stats.ab || 0);
                const finalTourneyAvg = finalTourneyAB > 0 ? (finalTourneyH / finalTourneyAB).toFixed(3) : ".---";

                // AIã«æ¸¡ã™ãŸã‚ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
                tournamentTotalStatsText = ` (ä»Šå¤§ä¼š: ${finalTourneyAvg}, ${finalTourneyHR}æœ¬, ${finalTourneySB}ç›—)`;
            }
            // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

            const orderDisplay = player.order.includes('sub') ? `  - ${player.sub_type || 'ä»£'}` : `${player.order}.`;
            const playerIdentifier = `[#${player.number}] ${player.name}`; 
            
            const statsLine = `${stats.ab}æ‰“æ•°${stats.h}å®‰æ‰“ ${stats.rbi}æ‰“ç‚¹` + 
                              (stats.hr > 0 ? ` ${stats.hr}æœ¬å¡æ‰“` : '') + 
                              (stats.sb > 0 ? ` ${stats.sb}ç›—å¡` : '');
            
            // â˜… tournamentTotalStatsText ã‚’æœ«å°¾ã«è¿½åŠ 
            output += `${orderDisplay} ${playerIdentifier}${batHandText}${statusText}: ${statsLine}${tournamentTotalStatsText}\n`; 
        });
        
        pitchingData.forEach(pitcher => {
            // (æŠ•æ‰‹æˆç¸¾ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯å¤‰æ›´ãªã—)
            if (!pitcher.name || !pitcher.innings) return;
            let statusText = "";
            const careerStats = teamRecord?.playerStats?.pitching[pitcher.name];
            if (careerStats && careerStats.narrative_flag) {
                 const flagMap = { "dominant": "åœ§å·»", "seeking_redemption": "è¦ä¿®æ­£", "tough_loss": "ä¸é‹", "crafty_pitcher": "æŠ€å·§æ´¾", "unlucky": "ä¸é‹" };
                statusText = ` (çŠ¶æ…‹: ${flagMap[careerStats.narrative_flag] || careerStats.narrative_flag})`;
            }
            let pitcherDesc = "";
            if (pitcher.throwBat) {
                if (pitcher.throwBat.startsWith('R')) pitcherDesc += "å³";
                if (pitcher.throwBat.startsWith('L')) pitcherDesc += "å·¦";
            }
            if (pitcher.throwStyle) {
                const styleMap = { "over": "ã‚ªãƒ¼ãƒãƒ¼", "three_quarter": "ã‚¹ãƒªãƒ¼ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼", "side": "ã‚µã‚¤ãƒ‰", "under": "ã‚¢ãƒ³ãƒ€ãƒ¼" };
                pitcherDesc += `/${styleMap[pitcher.throwStyle] || pitcher.throwStyle}`;
            }
            if (pitcher.pitcherType) {
                const typeMap = { "honkaku": "æœ¬æ ¼æ´¾", "sokkyu": "é€Ÿçƒæ´¾", "giko": "æŠ€å·§æ´¾", "nanto": "è»ŸæŠ•æ´¾" };
                pitcherDesc += `/${typeMap[pitcher.pitcherType] || pitcher.pitcherType}`;
            }
            if (pitcher.velocity) { pitcherDesc += `/${pitcher.velocity}`; }
            if (pitcherDesc) pitcherDesc = `ï¼ˆ${pitcherDesc}ï¼‰`;
            const pitcherData = sortedBatters.find(b => b.name === pitcher.name);
            const pitcherIdentifier = pitcherData ? `[#${pitcherData.number}] ${pitcher.name}` : pitcher.name;
            output += `- æŠ•æ‰‹: ${pitcherIdentifier}${pitcherDesc}${statusText} (${pitcher.innings}å› ${pitcher.runs}å¤±ç‚¹ ${pitcher.strikeouts}å¥ªä¸‰æŒ¯ ${pitcher.walks}å››æ­»çƒ)\n`;
        });

        return output;
    };

    return formatTeamStats('team1') + formatTeamStats('team2');
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * è©¦åˆã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã®å€‹äººæˆç¸¾ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ç”Ÿæˆã™ã‚‹ï¼ˆâ˜…æŠ•æ‰‹åˆ†æå¼·åŒ–ç‰ˆï¼‰
 * @param {object} dbMatch - è©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {string} - "å‹è€…ãƒ»ã€‡ã€‡: éˆ´æœ¨(4å®‰æ‰“), æŠ•æ‰‹ãƒ»ç”°ä¸­(9å›1å¤±ç‚¹, HQSé”æˆ). // æ•—è€…ãƒ»â–³â–³: ..."
 */
function extractKeyPerformances(dbMatch) {
    if (!dbMatch || !dbMatch.details || !dbMatch.details.playerGameStats) {
        return 'è©³ç´°ãªå€‹äººæˆç¸¾ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
    }

    const { details, winner } = dbMatch;
    const winnerName = winner;
    const loserName = dbMatch.team1 === winner ? dbMatch.team2 : dbMatch.team1;

    const winnerKey = dbMatch.team1 === winnerName ? 'team1' : 'team2';
    const loserKey = dbMatch.team1 === loserName ? 'team1' : 'team2';

    const formatTeamPerformances = (teamKey) => {
        const teamName = dbMatch[teamKey];
        const performances = [];
        
        // æ‰“æ’ƒæˆç¸¾ã®åˆ†æ (å¤‰æ›´ãªã—)
        const battingStats = details.playerGameStats?.[teamKey] || {};
        for (const playerName in battingStats) {
            const stats = battingStats[playerName];
            const playerHighlights = [];
            if (stats.h >= 3) playerHighlights.push(`${stats.h}å®‰æ‰“`);
            if (stats.hr > 0) playerHighlights.push(`${stats.hr}æœ¬å¡æ‰“`);
            if (stats.rbi >= 3) playerHighlights.push(`${stats.rbi}æ‰“ç‚¹`);

            if (playerHighlights.length > 0) {
                const battingData = details.batting[teamKey].find(p => p.name === playerName);
                const order = battingData ? `${battingData.order}ç•ª` : '';
                performances.push(`${order}${playerName}(${playerHighlights.join(', ')})`);
            }
        }

        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒå¼·åŒ–ã•ã‚ŒãŸæŠ•æ‰‹åˆ†æãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        const pitchingData = details.pitching?.[teamKey] || [];
        const opponentTeamKey = teamKey === 'team1' ? 'team2' : 'team1';
        const opponentBattingData = details.batting?.[opponentTeamKey] || [];

        pitchingData.forEach(pitcher => {
            if (!pitcher.name) return;
            const pitcherHighlights = [];

            // 1. åŸºæœ¬çš„ãªæŠ•çƒçµæœã‚’åˆ†æ
            const innings = parseFloat(pitcher.innings || 0);
            const runs = parseInt(pitcher.runs || 0);
            const earnedRuns = parseInt(pitcher.earnedRuns || 0);
            const strikeouts = parseInt(pitcher.strikeouts || 0);
            const walks = parseInt(pitcher.walks || 0);
            const pitches = parseInt(pitcher.pitches || 0);

            // å¾“æ¥ã®åˆ†æ
            if (pitcher.result === 'W') {
                 if (innings >= 9 && earnedRuns === 0) pitcherHighlights.push('å®Œå°å‹åˆ©');
                 else if (innings >= 9) pitcherHighlights.push('å®ŒæŠ•å‹åˆ©');
            }
            if (strikeouts >= 10) pitcherHighlights.push(`${strikeouts}å¥ªä¸‰æŒ¯`);
            if (pitcher.result === 'L' && runs >= 5) pitcherHighlights.push(`${runs}å¤±ç‚¹ç‚ä¸Š`);

            // 2. æ–°ã—ã„è©³ç´°åˆ†æ
            if (pitches > 120) pitcherHighlights.push(`${pitches}çƒã®ç†±æŠ•`);
            if (walks >= 5) pitcherHighlights.push(`ä¸å››çƒ${walks}ã¨åˆ¶çƒé›£`);

            // 3. ã‚¤ãƒ‹ãƒ³ã‚°ã”ã¨ã®å†…å®¹åˆ†æï¼ˆä¸»ã«å…ˆç™ºæŠ•æ‰‹ã‚’å¯¾è±¡ï¼‰
            if (innings >= 6 && opponentBattingData.length > 0) {
                let walksByInning = Array(9).fill(0);
                for (let i = 0; i < 9; i++) {
                    opponentBattingData.forEach(batter => {
                        const result = batter.results[i] || '';
                        if (result.includes('å››çƒ') || result.includes('æ­»çƒ')) {
                            walksByInning[i]++;
                        }
                    });
                }

                const earlyInningWalks = walksByInning.slice(0, 5).reduce((a, b) => a + b, 0);
                const lateInningWalks = walksByInning.slice(5, 9).reduce((a, b) => a + b, 0);

                if (lateInningWalks > earlyInningWalks && lateInningWalks >= 3) {
                    pitcherHighlights.push('çµ‚ç›¤ã«åˆ¶çƒã‚’ä¹±ã—ãŸ');
                } else if (innings >= 7 && earnedRuns <= 2 && pitcher.result !== 'L') {
                    // è‰¯ã„å†…å®¹ã ã£ãŸå ´åˆã®è©•ä¾¡
                    pitcherHighlights.push('è©¦åˆã‚’ä½œã£ãŸ'); 
                }
            }
            
            if (pitcherHighlights.length > 0) {
                performances.push(`æŠ•æ‰‹ãƒ»${pitcher.name}(${pitcherHighlights.join(', ')})`);
            }
        });
        // â˜…â˜…â˜… æŠ•æ‰‹åˆ†æãƒ­ã‚¸ãƒƒã‚¯ã¯ã“ã“ã¾ã§ â˜…â˜…â˜…

        return performances.length > 0 ? `${teamName}: ${performances.join(', ')}` : '';
    };

    const winnerPerf = formatTeamPerformances(winnerKey);
    const loserPerf = formatTeamPerformances(loserKey);

    return [winnerPerf, loserPerf].filter(Boolean).join(' // ');
}
/**
 * å¯†ç€å–æå‹è¨˜è€…ã€Œç¾½ç”° é›„å¹³ã€ã®ã‚³ãƒ©ãƒ è¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯èªè­˜ æœ€çµ‚ç‰ˆ)
 * (â˜…â˜… æ•…éšœè€…ãƒªã‚¹ãƒˆ(injuryReport)ã¨ã€Œé‡è¦åº¦ã€ã¸ã®è¨€åŠã‚’AIã«æŒ‡ç¤ºã™ã‚‹ã‚ˆã†ä¿®æ­£ â˜…â˜…)
 */
async function generateHadaReport(matchContext) {
    // --- 1. contextã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’å–ã‚Šå‡ºã™ ---
    const { 
        winnerName, loserName, dbMatch, matchId, 
        playerStatsText, highlights, nextOpponent,
        injuryReport // â˜… æ•…éšœè€…ãƒªã‚¹ãƒˆ
    } = matchContext;

    const winnerScore = Math.max(parseInt(dbMatch.score1) || 0, parseInt(dbMatch.score2) || 0);
    const loserScore = Math.min(parseInt(dbMatch.score1) || 0, parseInt(dbMatch.score2) || 0);
    const winnerData = TEAM_DATA[winnerName];
    const loserData = TEAM_DATA[loserName];
    const winnerRank = calculateRank(winnerName, tournamentState);
    const loserRank = calculateRank(loserName, tournamentState);

    const winnerSeedRank = getSeedRankString(winnerName, tournamentState.seeds);
    const loserSeedRank = getSeedRankString(loserName, tournamentState.seeds);
    
    let roundName = getRoundNameFromMatchId(matchId);

    let nextOpponentText = 'æ¬¡æˆ¦ã®ç›¸æ‰‹ã¯ã¾ã æ±ºã¾ã£ã¦ã„ã¾ã›ã‚“ã€‚';
    if (nextOpponent) {
        if (nextOpponent.opponentName === 'å„ªå‹') {
            nextOpponentText = (tournamentState.currentTournament === 'summer')
                ? 'å¤ã®ç”²å­åœ’å‡ºå ´ãŒæ±ºå®šã—ã¾ã—ãŸã€‚'
                : 'ä»Šå¤§ä¼šã€è¦‹äº‹å„ªå‹ã‚’æœãŸã—ã¾ã—ãŸã€‚';
        }
        else if (nextOpponent.opponentName && nextOpponent.opponentName !== 'ï¼ˆæœªå®šï¼‰') {
            const nextOpponentSeed = getSeedRankString(nextOpponent.opponentName, tournamentState.seeds);
            const rankText = nextOpponent.opponentRank ? `(${nextOpponent.opponentRank}ãƒ©ãƒ³ã‚¯)` : '';
            nextOpponentText = `æ¬¡æˆ¦ã¯${nextOpponent.roundName}ã€${nextOpponent.opponentName}${nextOpponentSeed}${rankText}ã¨å¯¾æˆ¦ã—ã¾ã™ã€‚`;
        }
        else if (nextOpponent.decidingMatch) {
            const dm = nextOpponent.decidingMatch;
            nextOpponentText = `æ¬¡æˆ¦ã¯${nextOpponent.roundName}ã€${dm.team1}ã¨${dm.team2}ã®å‹è€…ã¨å¯¾æˆ¦ã—ã¾ã™ã€‚`;
        }
    }
    
    const highlightsText = highlights.map(fact => `- ${fact.inning || ''}å› ${fact.team || ''} ${fact.player || ''}: ${fact.description}`).join('\n');

    let scheduleText = '';
    let scheduleInstruction = '';
    if (matchContext.schedule) {
        const sched = matchContext.schedule;
        const team1Region = TEAM_DATA[dbMatch.team1]?.region || 'ä¸æ˜';
        const team2Region = TEAM_DATA[dbMatch.team2]?.region || 'ä¸æ˜';
        
        scheduleText = `\n- **è©¦åˆä¼šå ´:** ${sched.stadiumFull} (${sched.region}åœ°åŒº)\n`;
        
        if (sched.region === team1Region && sched.region !== team2Region) {
            scheduleText += `- **åœ°ã®åˆ©:** ${dbMatch.team1}ã«ã¨ã£ã¦åœ°å…ƒçƒå ´ã§ã®è©¦åˆã€‚`;
            scheduleInstruction = `**ã€åœ°ã®åˆ©ã®åˆ†æã€‘**: ${dbMatch.team1}ã«ã¨ã£ã¦ã€Œåœ°å…ƒçƒå ´ã€ã§ã‚ã£ãŸã“ã¨ãŒã€è©¦åˆã«ã©ã†å½±éŸ¿ã—ãŸã‹ï¼ˆä¾‹ï¼šå¤§å¿œæ´å›£ã®å¾ŒæŠ¼ã—ã€æ…£ã‚ŒãŸãƒã‚¦ãƒ³ãƒ‰ãªã©ï¼‰ã‚’ã€ã‚ãªãŸã®è¦–ç‚¹ã§åˆ†æã—ã¦ãã ã•ã„ã€‚`;
        } else if (sched.region !== team1Region && sched.region === team2Region) {
            scheduleText += `- **åœ°ã®åˆ©:** ${dbMatch.team2}ã«ã¨ã£ã¦åœ°å…ƒçƒå ´ã§ã®è©¦åˆã€‚`;
            scheduleInstruction = `**ã€åœ°ã®åˆ©ã®åˆ†æã€‘**: ${dbMatch.team2}ã«ã¨ã£ã¦ã€Œåœ°å…ƒçƒå ´ã€ã§ã‚ã£ãŸã“ã¨ãŒã€è©¦åˆã«ã©ã†å½±éŸ¿ã—ãŸã‹ï¼ˆä¾‹ï¼šå¤§å¿œæ´å›£ã®å¾ŒæŠ¼ã—ã€æ…£ã‚ŒãŸãƒã‚¦ãƒ³ãƒ‰ãªã©ï¼‰ã‚’ã€ã‚ãªãŸã®è¦–ç‚¹ã§åˆ†æã—ã¦ãã ã•ã„ã€‚`;
        }
    }
    let ballQualityText = '';
    if (matchContext.team1BallQuality && matchContext.team2BallQuality) {
        ballQualityText = `\n### ãƒ‡ãƒ¼ã‚¿5ï¼šãƒãƒ¼ãƒ åˆ¥ æ‰“çƒå“è³ªãƒ¬ãƒãƒ¼ãƒˆ\n- ${matchContext.team1BallQuality}\n- ${matchContext.team2BallQuality}\n`;
    }

    // â–¼â–¼â–¼ 4. AIã¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæŒ‡ç¤ºæ›¸ï¼‰ã‚’ä¿®æ­£ â–¼â–¼â–¼
    const prompt = `ã‚ãªãŸã¯ã€Œæ±æµ·ã‚¹ãƒãƒ¼ãƒ„ã€æ‰€å±ã®ã‚¹ãƒãƒ¼ãƒ„ãƒ©ã‚¤ã‚¿ãƒ¼ã€Œç¾½ç”° é›„å¹³ã€ã§ã™ã€‚
ã‚ãªãŸã¯ä»Šã€${roundName}ã€Œ${winnerName} vs ${loserName}ã€ã®è©¦åˆã‚’å–æã—çµ‚ãˆã€èˆˆå¥®å†·ã‚ã‚„ã‚‰ã¬ã¾ã¾ç½²åå…¥ã‚Šã®ã‚³ãƒ©ãƒ è¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ã„ã¾ã™ã€‚
ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€ã‚ãªãŸã®ä¸»è¦³ã¨åˆ†æã‚’äº¤ãˆãŸã€Œç¾½ç”° é›„å¹³ã‚¹ã‚¿ã‚¤ãƒ«ã€ã®ãƒŠãƒ©ãƒ†ã‚£ãƒ–ãªè¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰
${PREFECTURE_LORE}
---
### ç¾½ç”° é›„å¹³ã®å–æãƒ¡ãƒ¢
- **å¤§ä¼š:** ${tournamentState.tournamentYear}å¹´åº¦ ${tournamentNameMap[tournamentState.currentTournament]} ${roundName}
- **å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰:** ${winnerName} ${winnerSeedRank} (ãƒ©ãƒ³ã‚¯: ${winnerRank}) vs ${loserName} ${loserSeedRank} (ãƒ©ãƒ³ã‚¯: ${loserRank})
- **çµæœ:** ${winnerScore} - ${loserScore} ã§ ${winnerName} ãŒå‹åˆ©ã€‚
${scheduleText} 
- **${winnerName}ã®èƒŒæ™¯:** ${winnerData.info}
- **${loserName}ã®èƒŒæ™¯:** ${loserData.info}
- **è©¦åˆã®æ±ºã‚æ‰‹(ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›):** ${dbMatch.summary || 'ç‰¹ã«ãªã—'}
- **æ¬¡ã®è©¦åˆ:** ${nextOpponentText}
${injuryReport || ''}

### ãƒ‡ãƒ¼ã‚¿1ï¼šè©¦åˆã®ä¸»ãªå‡ºæ¥äº‹ (ãƒã‚¤ãƒ©ã‚¤ãƒˆ)
${highlightsText}

### ãƒ‡ãƒ¼ã‚¿2ï¼šä¸»ãªé¸æ‰‹ã®å€‹äººæˆç¸¾ (ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢)
${playerStatsText} 

### ãƒ‡ãƒ¼ã‚¿3ï¼šä»Šå¤§ä¼šã®ä¸»ãªæŠ•æ‰‹ç™»æ¿å±¥æ­´ (ã“ã®è©¦åˆã‚ˆã‚Šå‰)
${matchContext.pitcherGamelogInfo || 'ä»Šå¤§ä¼šã€ã“ã‚ŒãŒåˆç™»æ¿ã§ã™ã€‚'}

### ãƒ‡ãƒ¼ã‚¿4ï¼šä»Šå¤§ä¼šã®ä¸»ãªæ‰“è€…æˆç¸¾å±¥æ­´ (ã“ã®è©¦åˆã‚ˆã‚Šå‰)
${matchContext.batterGamelogInfo || 'æ‰“è€…ã®è©¦åˆå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}
${ballQualityText}

### åŸ·ç­†æŒ‡ç¤º
1.  **ä¸€äººç§°ã§æ›¸ã:** å¿…ãšã€Œç§ã€ã‚’ä¸»èªã«ã—ã€å€‹äººçš„ãªæ„Ÿæƒ³ï¼ˆï½é©šãã¾ã—ãŸã€ï½ã§ã—ã‚‡ã†ã­ï¼‰ã‚’äº¤ãˆã¦ãã ã•ã„ã€‚
2.  **ç¾å ´ã®ç©ºæ°—æ„Ÿ:** è©¦åˆå½“æ—¥ã®çƒå ´ã®é›°å›²æ°—ï¼ˆè¦³å®¢ã®å¤šã•ã€å¤©å€™ãªã©ï¼‰ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚
    ${scheduleInstruction}
3.  **ä¸¡ãƒãƒ¼ãƒ ã®ç´¹ä»‹:** ä¸¡ãƒãƒ¼ãƒ ã®èƒŒæ™¯ï¼ˆã€Œç‹è€…ã€ã€Œé€²å­¦æ ¡ã€ãªã©ï¼‰ã‚’ç´¹ä»‹ã—ã€è©¦åˆã®ä½ç½®ã¥ã‘ã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚
4.  **ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘**: **ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã®ã€‡ã€‡ã€**ã‚„**ã€Œã‚·ãƒ¼ãƒ‰æ ¡ã®â–³â–³ãŒè‹¦æˆ¦ã€**ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚å…·ä½“çš„ã«è¨€åŠã—ã€è©¦åˆã®æ–‡è„ˆã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚
5.  **ã€â˜…â˜… æ¬ å ´è€…ã¸ã®è¨€åŠ (æœ€é‡è¦) â˜…â˜…ã€‘**: å–æãƒ¡ãƒ¢ã®ã€Œä¸»ãªæ¬ å ´è€…ã€(${injuryReport})ã«é¸æ‰‹åï¼ˆä¾‹ï¼šã€‡ã€‡ [ğŸ¥] (ä¸»åŠ›), â–³â–³ [ğŸ©¹] (æ§ãˆ)ï¼‰ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®é¸æ‰‹ã®**é‡è¦åº¦ï¼ˆä¸»åŠ›ã‹æ§ãˆã‹ï¼‰**ã«å¿œã˜ã¦ã€ã‚ãªãŸã®åˆ†æï¼ˆæ·±åˆ»åº¦ï¼‰ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€ã‚„ã¯ã‚Šã‚¨ãƒ¼ã‚¹å§«å·(ä¸»åŠ›)ã®ä¸åœ¨ãŒéŸ¿ã„ãŸã€ã€ã€‡ã€‡(æ§ãˆ)ãŒä¸‡å…¨ã®çŠ¶æ…‹ãªã‚‰...ã€ï¼‰
6.  **ã€å›²ã¿å–æã€‘**: è¨˜äº‹ã®æœ¬æ–‡ä¸­ã«ã€ã‚ãªãŸãŒè©¦åˆå¾Œã«ç›´æ¥å–æã—ãŸé¸æ‰‹ï¼ˆä¾‹ï¼šãƒ’ãƒ¼ãƒ­ãƒ¼ã¨ãªã£ãŸã€‡ã€‡ãã‚“ã‚„ã€æ•—ã‚ŒãŸâ–³â–³ãã‚“ï¼‰ã®**ã€Œç”Ÿã€…ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã€**ã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ã€‚
7.  **ã‚¿ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆã®ç‰¹å®š:** è©¦åˆãŒå‹•ã„ãŸã‚¤ãƒ‹ãƒ³ã‚°ï¼ˆä¾‹ï¼š3å›ï¼‰ã‚„ãƒ—ãƒ¬ãƒ¼ã‚’ç‰¹å®šã—ã€ãã“ã‚’è©³ç´°ã«æå†™ã—ã¦ãã ã•ã„ã€‚
8.  **é¸æ‰‹ã¸ã®è¨€åŠ**: ã€Œãƒ‡ãƒ¼ã‚¿2ã€ã®é¸æ‰‹åã‚’å¼•ç”¨ã—ã€ã€Œã€‡ã€‡ãã‚“ã€ã¨å‘¼ç§°ã—ã¦ãã ã•ã„ã€‚**ã‚‚ã—ãã®é¸æ‰‹ã®èƒŒç•ªå·ï¼ˆ[#X]ï¼‰ãŒæˆ¦è¡“ã‚„ç‰©èªã®ä¸Šã§é‡è¦ã ã¨ã‚ãªãŸãŒåˆ¤æ–­ã—ãŸå ´åˆ**ã€ãã®èƒŒç•ªå·ã«ã‚‚è§¦ã‚Œã¦ãã ã•ã„ã€‚#ã¯èƒŒç•ªå·ã¨è¨€ã„æ›ãˆã¦ãã ã•ã„ã€‚(ä¾‹S1â†’èƒŒç•ªå·1)
9.  **ã€æŠ•æ‰‹ã®è©³ç´°åˆ†æã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿2ï¼ˆãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ï¼‰ã€ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹**æŠ•æ‰‹ã®è©³ç´°å±æ€§ï¼ˆä¾‹ï¼šå³/ã‚ªãƒ¼ãƒãƒ¼/æœ¬æ ¼æ´¾/150kmå¸¯ï¼‰**ã«ã‚‚æ³¨ç›®ã—ã€ãã®æŠ•æ‰‹ã®ã‚¿ã‚¤ãƒ—ãŒè©¦åˆã«ã©ã†å½±éŸ¿ã—ãŸã‹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
10. **è©¦åˆå¾Œã®æƒ…å ±:** è©¦åˆå¾Œã®é¸æ‰‹ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä¾‹ï¼šã€Œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’é‡è¦–ã—ãŸã€ï¼‰ã‚’ï¼ˆæ¶ç©ºã§ï¼‰æŒ¿å…¥ã—ã¦ãã ã•ã„ã€‚
11. **æ¬¡æˆ¦ã¸ã®è¨€åŠ:** è¨˜äº‹ã®æœ€å¾Œã«ã€æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ï¼ˆ${nextOpponentText}ï¼‰ã«è§¦ã‚Œã¦ç· ã‚ãã£ã¦ãã ã•ã„ã€‚
12. **ã€é¸æ‰‹ã®èƒŒæ™¯å‰µä½œã€‘**: ã‚‚ã—è©³ç´°ãªé¸æ‰‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒãªã„ç„¡åã®é¸æ‰‹ã«ã¤ã„ã¦æ›¸ãå ´åˆã€ã‚ãªãŸãŒé•·å¹´ã®å–æã§ãã®é¸æ‰‹ã‚’çŸ¥ã£ã¦ã„ã‚‹ã¨ã„ã†è¨˜è€…è¦–ç‚¹ã§ã€**ãã‚Œã‚‰ã—ã„æ¶ç©ºã®çµŒæ­´ã‚„ç‰¹å¾´ã‚’è‡ªç”±ã«ä»˜ã‘åŠ ãˆã¦ãã ã•ã„ã€‚**
13. **ã€å¸¸è­˜ã®åæ˜ ã€‘**: ã‚ãªãŸãŒç†ŸçŸ¥ã—ã¦ã„ã‚‹ã€Œå¸¸è­˜ã€ï¼ˆä¾‹ï¼šãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã®å°é ­ã€å…¬ç«‹ã®ç ¦ãƒ»é™å²¡ã®è‹¦æˆ¦ï¼‰ã‚’ã€ç›®ã®å‰ã®è©¦åˆçµæœã¨é–¢é€£ä»˜ã‘ã¦åˆ†æã—ã¦ãã ã•ã„ã€‚
14. **ã€æ‰“çƒã®è³ªã®åˆ†æã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿1ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ã€ã‚„ã€Œãƒ‡ãƒ¼ã‚¿2ï¼ˆãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ï¼‰ã€ã€ã€Œãƒ‡ãƒ¼ã‚¿5ï¼ˆæ‰“çƒå“è³ªãƒ¬ãƒãƒ¼ãƒˆï¼‰ã€ã«ã‚ã‚‹**æ‰“çƒã®è³ª**ï¼ˆã€Œé‹­ã„å½“ãŸã‚Šã€ã€Œè©°ã¾ã£ãŸå½“ãŸã‚Šã€ãªã©ï¼‰ã‚’é‡è¦–ã—ã€çµæœã¨å†…å®¹ãŒä¸€è‡´ã—ãªã„ï¼ˆä¾‹ï¼š4ã‚¿ã‚³ã ãŒå…¨éƒ¨é‹­ã„å½“ãŸã‚Šï¼‰é¸æ‰‹ã®è©•ä¾¡ã«ã‚‚è¨€åŠã—ã¦ãã ã•ã„ã€‚
15. **ã€æ‰“é †ã®å½¹å‰²ã€‘**: **æ‰“é †ã®å½¹å‰²**ã‚‚é‡è¦–ã—ã¦ãã ã•ã„ã€‚4ç•ªãŒ4ç•ªã®ä»•äº‹ã‚’ã—ãŸã®ã‹ã€ã‚ã‚‹ã„ã¯9ç•ªãŒæ„å¤–ãªæ´»èºã§ãƒ©ãƒƒã‚­ãƒ¼ãƒœãƒ¼ã‚¤ã¨ãªã£ãŸã®ã‹ã€ã¨ã„ã£ãŸæˆ¦è¡“çš„ãªåˆ†æã‚’ã‚³ãƒ©ãƒ ã«å«ã‚ã¦ãã ã•ã„ã€‚
16. **ã€æŠ•æ‰‹ã®å·¦å³ã€‘**: ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ã«ã€Œï¼ˆå³è…•ï¼‰ã€ã€Œï¼ˆå·¦è…•ï¼‰ã€ã®è¡¨è¨˜ãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚’è¨˜äº‹ã«åæ˜ ã•ã›ã‚‹ã“ã¨ã€‚
17. **ã€â˜…æ³¨ç›®ã®æ‰“å¸­ï¼ˆæœ€é‡è¦ï¼‰ã€‘**:
        - ã€Œãƒ‡ãƒ¼ã‚¿1ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ã€ã«ã€Œï¼ˆâ˜…æ³¨ç›®ï¼‰ã€ã¨ã„ã†ãƒãƒ¼ã‚¯ãŒä»˜ã„ã¦ã„ã‚‹æ‰“å¸­ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯**ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆç›£ç£ï¼‰ãŒã€è©¦åˆã®åˆ†æ°´å¶ºã€ã ã¨åˆ¤æ–­ã—ãŸ**ã€æœ€ã‚‚é‡è¦ãªæ‰“å¸­ã§ã™ã€‚
        - ã‚ãªãŸã®ã‚³ãƒ©ãƒ ã§ã¯ã€**ã“ã®è¨˜äº‹ã®ä¸­å¿ƒçš„ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ**ã¨ã—ã¦ã€ã“ã®ã€Œâ˜…æ³¨ç›®ã€ã®æ‰“å¸­ã®å‰å¾Œã‚’ã€æœ€ã‚‚ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«æå†™ã—ã¦ãã ã•ã„ã€‚
18. **ã€â˜…ç›—å¡ã¸ã®è¨€åŠ (é‡è¦)ã€‘**:
    - ã€Œãƒ‡ãƒ¼ã‚¿2ï¼ˆãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ï¼‰ã€ã«**ç›—å¡(SB)**ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹é¸æ‰‹ãŒã„ãŸå ´åˆã€ãã®é¸æ‰‹ã®æ©Ÿå‹•åŠ›ï¼ˆä¾‹ï¼šã€Œã€‡ã€‡ãŒè¶³ã§ãƒãƒ£ãƒ³ã‚¹ã‚’åºƒã’ã€ï¼‰ã«è¨€åŠã—ã¦ãã ã•ã„ã€‚
    - ã•ã‚‰ã«ã€ãã®é¸æ‰‹ã®**ã€Œä»Šå¤§ä¼šã®é€šç®—ç›—å¡æ•°ã€**ï¼ˆä¾‹ï¼š(ä»Šå¤§ä¼š: ... 4ç›—)ï¼‰ã‚‚å¿…ãšå‚ç…§ã—ã€**ã€Œã€‡ã€‡ã¯ã“ã‚Œã§ä»Šå¤§ä¼š4å€‹ç›®ã®ç›—å¡ã€‚å½¼ã®è¶³ã¯æœ¬ç‰©ã ã€**ã¨ã„ã£ãŸå…·ä½“çš„ãªæ•°å­—ã‚’è¨˜äº‹ã«å«ã‚ã¦ãã ã•ã„ã€‚
    - **ç›—å¡ãŒ0ã ã£ãŸå ´åˆã€ãã‚Œã«ã¤ã„ã¦æ‰¹åˆ¤çš„ãªè¨€åŠï¼ˆä¾‹ï¼šã€Œãªãœèµ°ã‚‰ãªã„ã€ï¼‰ã¯ä¸è¦ã§ã™ã€‚**
19.  **ã€â˜…ã‚¹ã‚¿ãƒ¡ãƒ³å¾©å¸°ã€‘**: ã€Œã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´ã€æƒ…å ±ï¼ˆå–æãƒ¡ãƒ¢å¤–ã®åˆ¥ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æä¾›ï¼‰ã«ã€Œã€‡ã€‡ãŒã‚¹ã‚¿ãƒ¡ãƒ³å¾©å¸°ã€ã¨ã‚ã£ãŸå ´åˆã€**ã€Œç›£ç£ã®è³­ã‘ãŒå½“ãŸã£ãŸã€**ã¨ã„ã†è¦–ç‚¹ã§ã€ãã®é¸æ‰‹ã®æ´»èºï¼ˆã‚ã‚‹ã„ã¯ä¸æŒ¯ï¼‰ã‚’ã‚ãªãŸã®ä¸»è¦³ã§åˆ†æã—ã¦ãã ã•ã„ã€‚
20. **ã€é€£æŠ•ãƒ»é…·ä½¿ã®åˆ†æã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿3ï¼šç™»æ¿å±¥æ­´ã€ã‚’è¦‹ã¦ã€ã‚‚ã—æŠ•æ‰‹ãŒã€Œé€£æŠ•ã€ã‚„ã€Œä¸­1æ—¥ã€ã§ã‚ã£ãŸã‚Šã€ä»Šå¤§ä¼šã§ã€ŒæŠ•ã’ã™ãï¼ˆé…·ä½¿ï¼‰ã€ã®çŠ¶æ…‹ã§ã‚ã£ãŸã‚Šã—ãŸå ´åˆã€ãã‚ŒãŒä»Šæ—¥ã®æŠ•çƒã«ã©ã†å½±éŸ¿ã—ãŸã‹ã€ã‚ãªãŸã®é‹­ã„è¦–ç‚¹ã§åˆ†æã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€Œæ˜¨æ—¥120çƒã‚’æŠ•ã’ãŸè…•ã§ã€ä»Šæ—¥ã‚‚140km/hã‚’è¨ˆæ¸¬ã™ã‚‹ã¨ã¯â€¦å½¼ã®è‚©ã¯ä¸€ä½“ã©ã†ãªã£ã¦ã„ã‚‹ã‚“ã ã€ï¼‰
21. **ã€é›ªè¾±ã¨çœŸä¾¡ã€‘**: ã‚‚ã—æŠ•æ‰‹ãŒã€Œç™»æ¿å±¥æ­´ã€ã§ã€Œå‰å›ç‚ä¸Šã€ã—ã¦ã„ãŸå ´åˆã€ä»Šæ—¥ã®æŠ•çƒãŒã€Œé›ªè¾±ã€ã®ãƒã‚¦ãƒ³ãƒ‰ã§ã‚ã£ãŸã“ã¨ã«è§¦ã‚Œã¦ãã ã•ã„ã€‚é€†ã«ã€ã“ã‚Œã¾ã§ã€Œæ ¼ä¸‹ç›¸æ‰‹ã€ã«ã—ã‹æŠ•ã’ã¦ã„ãªã‹ã£ãŸå ´åˆã€ä»Šæ—¥ã®è©¦åˆãŒã€ŒçœŸä¾¡ã‚’å•ã†ãƒã‚¦ãƒ³ãƒ‰ã€ã§ã‚ã£ãŸã¨åˆ†æã—ã¦ãã ã•ã„ã€‚
22. **ã€â˜…æ‰“è€…ã®å¥½ä¸èª¿ã®æ³¢ã€‘**: ã€Œãƒ‡ãƒ¼ã‚¿4ï¼šæ‰“è€…æˆç¸¾å±¥æ­´ã€ã‚’ç†Ÿèª­ã—ã€é¸æ‰‹ã®**é€£ç¶šãƒ’ãƒƒãƒˆ**ã‚„**é€£ç¶šç„¡å®‰æ‰“**ã®ã€Œæ³¢ã€ã«è¨€åŠã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€Œ1å›æˆ¦ã§4ã‚¿ã‚³ã ã£ãŸã€‡ã€‡ãã‚“ãŒã€ä»Šæ—¥ã¯ã¾ã‚‹ã§åˆ¥äººã®ã‚ˆã†ã ã£ãŸã€ã€Œâ–³â–³ãã‚“ã¯ã“ã‚Œã§3è©¦åˆé€£ç¶šãƒ’ãƒƒãƒˆã€‚å®Œå…¨ã«æ´ã‚“ã ã‚ˆã†ã ã­ã€ï¼‰
23. **ã€â˜…æ‰“è€…ã®å½¹å‰²åˆ†æã€‘**: ã‚‚ã—é¸æ‰‹ãŒ**ã€Œä»£æ‰“ã€**ã§çµæœã‚’å‡ºã—ç¶šã‘ã¦ã„ãŸã‚Šã€**ã€Œæ‰“é †å¤‰æ›´ã€**ã§èª¿å­ã‚’ä¸Šã’ã¦ã„ãŸã‚Šã™ã‚‹å ´åˆã€ãã®é‡‡é…ã¨é¸æ‰‹ã®é©å¿œåŠ›ã‚’ã‚ãªãŸã®è¦–ç‚¹ã§åˆ†æã—ã¦ãã ã•ã„ã€‚
### å‡ºåŠ›å½¢å¼ã€å³å®ˆã€‘
- **ã€æœ€é‡è¦ã€‘** ã‚ãªãŸã®å¿œç­”ã¯ã€å¿…ãšå˜ä¸€ã®JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"ã®ã¿"ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
- **çµ¶å¯¾ã«**ã€JSONã®å‰å¾Œã«ã€Œã¯ã„ã€è¨˜äº‹ã§ã™ã€ã‚„ã€Œ\`\`\`jsonã€ãªã©ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä»˜ã‘åŠ ãˆã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚
{"title": "ï¼ˆä¾‹ï¼šç‹è€…283å­¦åœ’ã€åœ§å·»ã®ã‚³ãƒ¼ãƒ«ãƒ‰ç™ºé€²ï¼ ç¾½ç”°é›„å¹³ãŒè¦‹ãŸã€æ ¼ã®é•ã„ã€ï¼‰", "body": "ï¼ˆã“ã“ã«ç¾½ç”° é›„å¹³ã‚¹ã‚¿ã‚¤ãƒ«ã®è¨˜äº‹æœ¬æ–‡ï¼‰"}
`;

    // --- 5. AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ---
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
            const rawTextFromAi = result.candidates[0].content.parts[0].text;
            const article = parseJsonFromText(rawTextFromAi);
            
            if (article && article.title && article.body) {
                article.body += "\n\nã€€æ±æµ·ã‚¹ãƒãƒ¼ãƒ„ã€€ç¾½ç”°é›„å¹³";
                return { 
                    ...article, 
                    timestamp: Date.now(), 
                    context: matchContext, 
                    isHadaReport: true 
                };
            } else {
                 console.error("parseJsonFromText failed for HadaReport:", rawTextFromAi);
                 throw new Error("AI response format error after parsing (HadaReport).");
            }
        } else {
             console.error("Unexpected AI response structure (HadaReport):", result);
             throw new Error("AI response structure is missing expected parts (HadaReport).");
        }
    } catch (error) {
        console.error("ç¾½ç”°ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return { 
            title: "ç¾½ç”°ã‚³ãƒ©ãƒ  ç”Ÿæˆã‚¨ãƒ©ãƒ¼", body: "ç¾½ç”°è¨˜è€…ãŒå–æä¸­ã«è² å‚·ã—ãŸãŸã‚ã€è¨˜äº‹ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚", 
            timestamp: Date.now(), error: true, errorId: `hada-${matchId}`,
            context: matchContext 
        };
    }
}

// â–¼â–¼â–¼ å› ç¸ç›¸é–¢å›³ ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (AIè§£èª¬æ©Ÿèƒ½ä»˜ããƒ»æ”¹) â–¼â–¼â–¼

document.getElementById('show-rivalry-map-btn').addEventListener('click', async () => {
    document.getElementById('rivalry-map-modal').classList.remove('hidden');
    document.getElementById('rivalry-map-modal').classList.add('flex');
    await generateRivalryMap(); // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«ç”Ÿæˆé–‹å§‹
});

document.getElementById('rivalry-map-close-btn').addEventListener('click', () => {
    document.getElementById('rivalry-map-modal').classList.add('hidden');
    document.getElementById('rivalry-map-modal').classList.remove('flex');
});

/**
 * ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã€å¸¸è­˜ã€ãã—ã¦ã€Œåå·®å€¤ã€ã‚„ã€Œç³»åˆ—ã€ã‹ã‚‰ç›¸é–¢å›³ã‚’ç”Ÿæˆã™ã‚‹
 */
async function generateRivalryMap() {
    const container = document.getElementById('mermaid-container');
    const analysisContainer = document.getElementById('rivalry-analysis-content');
    
    container.innerHTML = '<div class="loader">çœŒå†…ã®å‹¢åŠ›å›³ã‚’åºƒåŸŸã‚¹ã‚­ãƒ£ãƒ³ä¸­...</div>';
    analysisContainer.innerHTML = '<div class="loader">AIè¨˜è€…ãŒå‹¢åŠ›å›³ã‚’åˆ†æä¸­...</div>';

    // --- 1. Mermaidè¨˜æ³•ã®ãƒ˜ãƒƒãƒ€ãƒ¼ ---
    let graphDef = "graph TD\n";
    
    // ã‚¯ãƒ©ã‚¹å®šç¾© (è‰²åˆ†ã‘)
    graphDef += "classDef rankA fill:#fee2e2,stroke:#ef4444,stroke-width:3px,color:#000;\n"; // èµ¤ (Aãƒ©ãƒ³ã‚¯)
    graphDef += "classDef rankB fill:#e0f2fe,stroke:#3b82f6,stroke-width:2px,color:#000;\n"; // é’ (Bãƒ©ãƒ³ã‚¯)
    graphDef += "classDef rankC fill:#fef9c3,stroke:#eab308,stroke-width:2px,color:#000;\n"; // é»„ (Cãƒ©ãƒ³ã‚¯)
    graphDef += "classDef namco fill:#f3e8ff,stroke:#9333ea,stroke-width:2px,color:#000;\n"; // ç´« (ãƒŠãƒ ã‚³ç³»åˆ—)
    graphDef += "classDef normal fill:#fff,stroke:#9ca3af,stroke-width:1px,color:#000;\n";   // ç™½ (ãã®ä»–)

    // --- 2. ãƒãƒ¼ãƒ‰ã¨ã‚¨ãƒƒã‚¸ã®åé›† ---
    const nodes = new Set();
    const edges = [];
    const namcoSchools = ["283å­¦åœ’", "765ç·åˆé«˜æ ¡", "åˆæ˜Ÿå­¦åœ’", "ç¾åŸå­¦åœ’", "283å­¦åœ’B"];

    // Helper: ã‚¨ãƒƒã‚¸è¿½åŠ  (é‡è¤‡é˜²æ­¢ã¯Mermaidå´ã§å‡¦ç†ã•ã‚Œã‚‹ãŒå¿µã®ãŸã‚)
    const addEdge = (t1, t2, label, style = '---') => {
        if (t1 === t2) return;
        nodes.add(t1); nodes.add(t2);
        edges.push(`${t1} ${style}|${label}| ${t2}`);
    };

    // (A) å›ºå®šãƒ©ã‚¤ãƒãƒ«é–¢ä¿‚ (RIVALRIES)
    tournamentState.rivalries.forEach(r => {
        if (r.teams.length >= 2) addEdge(r.teams[0], r.teams[1], r.type, '<-->');
    });

    // (B) å‹•çš„å› ç¸ (feuds)
    if (tournamentState.feuds) {
        tournamentState.feuds.forEach(f => {
            if (f.teams.length >= 2) addEdge(f.teams[0], f.teams[1], f.type, '-.->');
        });
    }

    // (C) ç›´è¿‘ã®ã€Œç•ªç‹‚ã‚ã›ã€ã‚„ã€Œå¤©æ•µã€é–¢ä¿‚
    const strongTeams = Object.keys(tournamentState.teamRecords).filter(t => ['A', 'B'].includes(calculateRank(t, tournamentState)));
    strongTeams.forEach(teamA => {
        const history = getRecentMatchesForTeam(teamA, 10);
        history.forEach(match => {
            if (!match.isWin && ['C', 'D', 'E'].includes(calculateRank(match.opponent, tournamentState))) {
                addEdge(match.opponent, teamA, 'é‡‘æ˜Ÿ', '==>');
            }
        });
    });

    // --- â˜…ã“ã“ã‹ã‚‰æ‹¡å¼µ: ã¾ã å¯¾æˆ¦ã—ã¦ã„ãªãã¦ã‚‚è¡¨ç¤ºã™ã‚‹ ---

    // (D) ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã®çµæŸ
    // 283å­¦åœ’ã‚’ä¸­å¿ƒã«ã€ä»–ã®ç³»åˆ—æ ¡ã‚’ã¤ãªã
    const mainNamco = "283å­¦åœ’";
    namcoSchools.forEach(school => {
        if (school !== mainNamco && tournamentState.teamRecords[school]) { // å­˜åœ¨ç¢ºèª
            addEdge(mainNamco, school, 'ç³»åˆ—', '-.-');
        }
    });

    // (E) å„åœ°åŒºã®ã€Œ3å¼·ã€ã‚’å¼·åˆ¶çš„ã«è¡¨ç¤ºã—ã€ãƒ©ã‚¤ãƒãƒ«ç·šã§çµã¶
    const regions = ['æ±éƒ¨', 'ä¸­éƒ¨', 'è¥¿éƒ¨']; // ä¼Šè±†ã¯æ±éƒ¨ã«å«ã‚€å ´åˆãŒå¤šã„ãŒã€ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã£ã¦ã¯ç‹¬ç«‹
    const teamsByRegion = { 'æ±éƒ¨': [], 'ä¸­éƒ¨': [], 'è¥¿éƒ¨': [], 'ä¼Šè±†': [] };

    // å…¨ãƒãƒ¼ãƒ ã‚’åœ°åŒºåˆ†ã‘ã—ã¦ã‚½ãƒ¼ãƒˆ
    Object.keys(TEAM_DATA).forEach(teamName => {
        const data = TEAM_DATA[teamName];
        if (data.region && teamsByRegion[data.region]) {
            // ã‚½ãƒ¼ãƒˆç”¨ã‚¹ã‚³ã‚¢: ãƒ©ãƒ³ã‚¯ãŒé«˜ã„é † > åå·®å€¤ãŒé«˜ã„é †
            const rank = calculateRank(teamName, tournamentState);
            const rankVal = {'A':5, 'B':4, 'C':3, 'D':2, 'E':1}[rank] || 0;
            const score = rankVal * 100 + (data.deviation || 50);
            
            teamsByRegion[data.region].push({ name: teamName, score: score });
        }
    });

    // å„åœ°åŒºã®ä¸Šä½3æ ¡ã‚’æŠ½å‡ºã—ã€1ä½vs2ä½ã€2ä½vs3ä½ã‚’ã¤ãªã
    Object.keys(teamsByRegion).forEach(region => {
        // ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆ
        const sortedTeams = teamsByRegion[region].sort((a, b) => b.score - a.score);
        const top3 = sortedTeams.slice(0, 3).map(t => t.name);

        if (top3.length >= 2) {
            addEdge(top3[0], top3[1], `${region}ã®è¦‡æ¨©`, '---');
        }
        if (top3.length >= 3) {
            addEdge(top3[1], top3[2], `ä¸Šä½äº‰ã„`, '---');
        }
        // ãƒãƒ¼ãƒ‰ã¨ã—ã¦è¿½åŠ ï¼ˆç·šãŒãªãã¦ã‚‚é‡è¦æ ¡ã¯è¡¨ç¤ºï¼‰
        top3.forEach(t => nodes.add(t));
    });

    // (F) Aãƒ©ãƒ³ã‚¯æ ¡ã¯ç„¡æ¡ä»¶ã§å…¨å“¡è¡¨ç¤ºï¼ˆå­¤ç«‹ã—ã¦ã„ã¦ã‚‚OKï¼‰
    Object.keys(tournamentState.teamRecords).forEach(teamName => {
        if (calculateRank(teamName, tournamentState) === 'A') {
            nodes.add(teamName);
        }
    });

    // --- 3. ãƒãƒ¼ãƒ‰å®šç¾© (ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨) ---
    nodes.forEach(team => {
        const rank = calculateRank(team, tournamentState);
        let styleClass = "normal";
        
        if (namcoSchools.includes(team)) styleClass = "namco";
        else if (rank === 'A') styleClass = "rankA";
        else if (rank === 'B') styleClass = "rankB";
        else if (rank === 'C') styleClass = "rankC";
        
        graphDef += `${team}((${team})):::${styleClass}\n`;
    });

    // --- 4. ã‚¨ãƒƒã‚¸å®šç¾© ---
    // é‡è¤‡ã‚¨ãƒƒã‚¸ã‚’å‰Šé™¤ã™ã‚‹ãŸã‚ã«Setã‚’ä½¿ã†
    const uniqueEdges = [...new Set(edges)];
    uniqueEdges.forEach(edge => { graphDef += `${edge}\n`; });

    if (uniqueEdges.length === 0 && nodes.size === 0) {
        container.innerHTML = "<p class='text-gray-500'>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        analysisContainer.innerHTML = "";
        return;
    }

    // --- 5. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Ÿè¡Œ ---
    try {
        container.innerHTML = `<div class="mermaid">${graphDef}</div>`;
        await mermaid.run({ nodes: container.querySelectorAll('.mermaid') });
    } catch (e) {
        console.error("Mermaid rendering failed:", e);
        container.innerHTML = "<p class='text-red-500'>å›³ã®æç”»ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
    }

    // --- 6. AIã«ã‚ˆã‚‹åˆ†æãƒ¬ãƒãƒ¼ãƒˆ ---
    const displayedTeams = Array.from(nodes);
    const prompt = `ã‚ãªãŸã¯é«˜æ ¡é‡çƒã®äº‹æƒ…é€šè¨˜è€…ã§ã™ã€‚
çœŒå†…ã®æœ‰åŠ›æ ¡ã‚„ãƒ©ã‚¤ãƒãƒ«é–¢ä¿‚ã‚’ã¾ã¨ã‚ãŸã€Œå‹¢åŠ›å›³ï¼ˆç›¸é–¢å›³ï¼‰ã€ãŒå®Œæˆã—ã¾ã—ãŸã€‚
ã“ã®å›³ã«ç™»å ´ã™ã‚‹ä¸»ãªãƒãƒ¼ãƒ ï¼ˆ${displayedTeams.slice(0, 10).join(', ')}ãªã©ï¼‰ã‚’è¦‹ã¦ã€
**ã€Œç¾åœ¨ã®çœŒå†…ã®ãƒ‘ãƒ¯ãƒ¼ãƒãƒ©ãƒ³ã‚¹ã€**ã‚„**ã€Œæ³¨ç›®ã™ã¹ãå¯¾ç«‹æ§‹å›³ã€**ã«ã¤ã„ã¦ã€300æ–‡å­—ç¨‹åº¦ã®ã‚³ãƒ©ãƒ ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚
ç‰¹ã«ã€åœ°åŒºã”ã¨ã®è¦‡æ¨©äº‰ã„ã‚„ã€ãƒŠãƒ ã‚³ç³»åˆ—æ ¡ã®å­˜åœ¨æ„Ÿã«ã¤ã„ã¦è§¦ã‚Œã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼ (JSON)
{"body": "ï¼ˆã‚³ãƒ©ãƒ æœ¬æ–‡ï¼‰"}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const aiData = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (aiData && aiData.body) {
                analysisContainer.innerHTML = `<p>${aiData.body.replace(/\n/g, '<br>')}</p>`;
            }
        }
    } catch (error) {
        console.error("AIå‹¢åŠ›å›³åˆ†æã‚¨ãƒ©ãƒ¼:", error);
        analysisContainer.innerHTML = "<p class='text-red-500'>AIåˆ†æã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
    }
}
// â–²â–²â–² å› ç¸ç›¸é–¢å›³ ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (æ‹¡å¼µç‰ˆ) ã“ã“ã¾ã§ â–²â–²â–²

async function generateKuriyamaReport(matchContext) {
    const { winnerName, loserName, dbMatch, matchId, nextOpponent } = matchContext;

    const myTeam = "283å­¦åœ’";
    const isWin = (winnerName === myTeam);
    
    // â–¼â–¼â–¼ ä¿®æ­£: å‹è€…ã®ã‚¹ã‚³ã‚¢ã‚’åˆ¤å®šã—ã¦å…ˆã«è¡¨ç¤ºã™ã‚‹ â–¼â–¼â–¼
    const score1 = parseInt(dbMatch.score1) || 0;
    const score2 = parseInt(dbMatch.score2) || 0;
    const winnerScore = (dbMatch.team1 === winnerName) ? score1 : score2;
    const loserScore = (dbMatch.team1 === winnerName) ? score2 : score1;
    
    const scoreString = `${winnerScore}-${loserScore}`;
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    const roundName = getRoundNameFromMatchId(matchId);

    const winnerInfo = TEAM_DATA[winnerName]?.info || "";
    const loserInfo = TEAM_DATA[loserName]?.info || "";
    
    let nextGameText = "";
    if (isWin && nextOpponent) {
        if (nextOpponent.opponentName === 'å„ªå‹') nextGameText = "å„ªå‹";
        else if (nextOpponent.opponentName) nextGameText = `æ¬¡æˆ¦ã®ç›¸æ‰‹ã¯${nextOpponent.opponentName}`;
    }

    // é¸æ‰‹æƒ…å ±ã‚’è©³ç´°ã«æŠ½å‡ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
    const getPlayerInfoDetailed = (teamName, teamKey) => {
        const gameStats = dbMatch.details?.playerGameStats?.[teamKey] || {};
        const battingDetails = dbMatch.details?.batting?.[teamKey] || [];
        const roster = TEAM_ROSTER_MASTER[teamName] || []; 
        let infoList = [];

        for (const [name, stats] of Object.entries(gameStats)) {
            if ((stats.pa && stats.pa > 0) || (stats.ip && parseFloat(stats.innings) > 0)) {
                const bDetail = battingDetails.find(p => p.name === name);
                const order = bDetail ? bDetail.order : "-";
                const pos = bDetail ? (bDetail.currentPos || bDetail.pos) : "-";
                
                const staticData = roster.find(p => p.name === name);
                const origin = staticData?.origin ? `(${staticData.origin})` : "";

                let perf = "";
                if (stats.h > 0) perf += `${stats.h}å®‰æ‰“ `;
                if (stats.hr > 0) perf += `${stats.hr}HR `;
                if (stats.rbi > 0) perf += `${stats.rbi}æ‰“ç‚¹ `;
                if (stats.ip) perf += `æŠ•${stats.innings}å›${stats.earnedRuns}è‡ªè²¬ `;
                
                let role = "è„‡å½¹";
                if (pos === "æŠ•" || (order.match(/^[345]$/))) role = "ä¸»åŠ›";
                
                infoList.push(`- ${name}${origin} [${role}/æ‰“é †${order}/å®ˆå‚™${pos}]: ${perf}`);
            }
        }
        return infoList.join("\n");
    };

    const teamKey283 = (dbMatch.team1 === "283å­¦åœ’") ? 'team1' : 'team2';
    const teamKeyOpp = (teamKey283 === 'team1') ? 'team2' : 'team1';
    const opponentTeamName = (dbMatch.team1 === "283å­¦åœ’") ? dbMatch.team2 : dbMatch.team1;

    const data283 = getPlayerInfoDetailed("283å­¦åœ’", teamKey283);
    const dataOpp = getPlayerInfoDetailed(opponentTeamName, teamKeyOpp);

    const prompt = `ã‚ãªãŸã¯é«˜æ ¡é‡çƒé›‘èªŒã€Œé™å²¡é«˜æ ¡é‡çƒã€ã®ç·¨é›†éƒ¨å“¡ãƒ»æ —å±±ã§ã™ã€‚
ä»Šæ—¥è¡Œã‚ã‚ŒãŸ${roundName}ã€Œ${winnerName} å¯¾ ${loserName}ã€ã®å–æãƒ¡ãƒ¢ã‚’å…ƒã«ã€**ã‚ãªãŸç‹¬ç‰¹ã®æ–‡ä½“ï¼ˆæ —å±±ç¯€ï¼‰**ã§ã€ãƒãƒ‹ã‚¢ãƒƒã‚¯ãªè¦–ç‚¹ã®ã€Œã‚¹ã‚«ã‚¦ãƒ†ã‚£ãƒ³ã‚°ãƒ¬ãƒãƒ¼ãƒˆï¼ˆãƒ–ãƒ­ã‚°è¨˜äº‹ï¼‰ã€ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚

### è©¦åˆæ¦‚è¦
- çµæœ: **${winnerName}ã®å‹åˆ© (${scoreString})**
- ãƒãƒ¼ãƒ èƒŒæ™¯: [å‹]${winnerInfo} / [è² ]${loserInfo}
- ${nextGameText}

### é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ï¼ˆå–æãƒ¡ãƒ¢ï¼‰
**ã€283å­¦åœ’ã€‘**
${data283}

**ã€${opponentTeamName}ã€‘**
${dataOpp}

### åŸ·ç­†æŒ‡ç¤ºï¼ˆä»¥ä¸‹ã®3ç‚¹ã‚’å¿…ãšç››ã‚Šè¾¼ã‚€ã“ã¨ï¼‰
1.  **ä¸»åŠ›ã§æ°—ã«ãªã£ãŸé¸æ‰‹ï¼ˆ283å­¦åœ’ï¼‰**: 
    - ãƒãƒ¼ãƒ ã®ä¸­å¿ƒé¸æ‰‹ï¼ˆæŠ•æ‰‹ã‚„ã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—ï¼‰ã‹ã‚‰1åé¸ã³ã€ãã®æ´»èºã‚„æˆé•·ã¶ã‚Šã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
    - ã€Œã€‡ã€‡ã‚·ãƒ‹ã‚¢æ™‚ä»£ã‹ã‚‰ã®æˆé•·ã€ã‚„ã€Œãƒœãƒ¼ãƒ«ã®æŠ¼ã—è¾¼ã¿ãŒå¼·ããªã£ãŸã€ãªã©ã€ç¶™ç¶šã—ã¦è¦‹ã¦ã„ã‚‹è¨˜è€…ã‚‰ã—ã„è¡¨ç¾ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
2.  **è„‡å½¹ã ãŒè¼ã„ã¦ã„ãŸé¸æ‰‹ï¼ˆ283å­¦åœ’ï¼‰**: 
    - **ä¸‹ä½æ‰“ç·šã€å®ˆå‚™è·äººã€æ§ãˆé¸æ‰‹**ãªã©ã‹ã‚‰ã€ã€Œã„ã¶ã—éŠ€ã€ã®æ´»èºã‚’ã—ãŸé¸æ‰‹ã‚’1åè¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚
    - æ´¾æ‰‹ãªæˆç¸¾ã§ãªãã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚ã€Œä½“ã®è»¸ãŒãƒ–ãƒ¬ãªã„ã€ã€Œå®ˆå‚™ã®ä¸€æ­©ç›®ãŒé€Ÿã„ã€ã€Œã‚¹ã‚¤ãƒ³ã‚°ã®è»Œé“ãŒè‰¯ã„ã€ãªã©ã€**ç„äººå¥½ã¿ã®ãƒã‚¤ãƒ³ãƒˆ**ã‚’çµ¶è³›ã—ã¦ãã ã•ã„ã€‚
3.  **ç›¸æ‰‹ãƒãƒ¼ãƒ ã®å¥½é¸æ‰‹**: 
    - ç›¸æ‰‹ãƒãƒ¼ãƒ ï¼ˆ${opponentTeamName}ï¼‰ã‹ã‚‰ã€å°†æ¥æ€§ã‚’æ„Ÿã˜ãŸé¸æ‰‹ã‚’1åæŒ™ã’ã¦ãã ã•ã„ã€‚
    - è² ã‘ãŸãƒãƒ¼ãƒ ã§ã‚ã£ã¦ã‚‚ã€ã€Œç´ æã¯ä¸€ç´šå“ã€ã€Œã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã®è³ªãŒè‰¯ã‹ã£ãŸã€ã€Œä½“ãŒã§ãã¦ãã‚Œã°é¢ç™½ã„ã€ã¨ã€ãƒªã‚¹ãƒšã‚¯ãƒˆã‚’è¾¼ã‚ã¦è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚ç›¸æ‰‹ã®å‡ºèº«ä¸­å­¦ãªã©ã¯**æ¶ç©ºã§å‰µä½œ**ã—ã¦è£œå®Œã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€Œã€‡ã€‡ä¸­å­¦æ™‚ä»£ã¯è»Ÿå¼ã§...ã€ï¼‰ã€‚

### æ —å±±æ°ã®æ–‡ä½“
- ã€Œï½ã‚’è¦‹ã¦ãã¾ã—ãŸã€‚ã€ã€Œï½ãŒæ°—ã«ãªã‚Šã¾ã—ãŸã€‚ã€ã€Œï½ã ã¨æ€ã„ã¾ã—ãŸã€‚ã€ã¨ã„ã†ã€ä¸å¯§ã ãŒç†±é‡ã®ã‚ã‚‹èªã‚Šå£ã€‚
- é¸æ‰‹ã‚’ãƒ•ãƒ«ãƒãƒ¼ãƒ ï¼ˆã¾ãŸã¯è‹—å­—ï¼‰ã§å‘¼ã³ã€æŠ€è¡“çš„ãªãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«ï¼ˆãƒ’ã‚¸ã®ä½¿ã„ã€ä¸‹åŠèº«ã®ç²˜ã‚Šç­‰ï¼‰ã«è¨€åŠã™ã‚‹ã€‚
- æœ€å¾Œã¯ã€Œï¼ˆç·¨é›†éƒ¨ãƒ»æ —å±±ï¼‰ã€ã§ç· ã‚ã‚‹ã€‚

### å‡ºåŠ›å½¢å¼ (JSON)
{"title": "ã€ç·¨é›†éƒ¨ãƒ»æ —å±±ã€‘${roundName}å–æè¨˜ï¼š${winnerName}å¯¾${loserName}", "body": "ï¼ˆè¨˜äº‹æœ¬æ–‡ï¼‰"}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (article) {
                return { 
                    ...article, 
                    timestamp: Date.now(),
                    isScoutReport: true,
                    context: matchContext
                };
            }
        }
        return null;
    } catch (error) {
        console.error("ã‚¹ã‚«ã‚¦ãƒ†ã‚£ãƒ³ã‚°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
        return null;
    }
}

/**
 * AIè¨˜è€…ã«ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’åŸ·ç­†ã•ã›ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
 * (â˜…ã€ŒisNewspaperWorthyã€ã®ãƒã‚°ã‚’ä¿®æ­£ã—ã€R4ä»¥é™ã®ã¿æ–°èãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º)
 * (â˜…â˜… æ•…éšœè€…ãƒªã‚¹ãƒˆ(injuryReport)ã¸ã®è¨€åŠã‚’AIã«æŒ‡ç¤ºã™ã‚‹ã‚ˆã†ä¿®æ­£)
 * (â˜…â˜…â˜… è»½å‚·(ğŸ©¹)é¸æ‰‹ã¨ã€Œé‡è¦åº¦ã€ã¸ã®è¨€åŠã‚’æŒ‡ç¤ºã™ã‚‹ã‚ˆã†ä¿®æ­£ â˜…â˜…â˜…)
 */
async function generateNewsArticle(matchContext, userFeedback = null) {
    const {
        winnerName, loserName, dbMatch, matchId,
        winnerData, loserData, winnerDetailedData, loserDetailedData,
        winnerLineupChanges, loserLineupChanges,
        winnerJourney, loserJourney,
        nextOpponent, pitcherGamelogInfo, batterGamelogInfo,
        injuryReport // â˜… æ•…éšœè€…ãƒªã‚¹ãƒˆ
    } = matchContext || {};
    

// â–¼â–¼â–¼ è¿½åŠ : ä¸¡ãƒãƒ¼ãƒ ã®ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ã‚’ç‰¹å®šã™ã‚‹ â–¼â–¼â–¼
    const getCaptainName = (teamName) => {
        const record = tournamentState.teamRecords[teamName];
        if (!record || !record.roster) return "ä¸»å°†";
        const captain = record.roster.find(p => p.isCaptain);
        return captain ? captain.name : "ä¸»å°†";
    };

    const winnerCaptainName = getCaptainName(winnerName);
    const loserCaptainName = getCaptainName(loserName);
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    let prompt = '';
    
    const tournamentName = tournamentNameMap[tournamentState.currentTournament] || 'å¤§ä¼š';
    const tournamentYear = tournamentState.tournamentYear;
    let tournamentContextPrompt = "";
    let seedContext = "å‰å¤§ä¼šãƒ™ã‚¹ãƒˆ8";
    if (tournamentState.currentTournament === 'summer') {
        tournamentContextPrompt = "3å¹´ç”Ÿã«ã¨ã£ã¦ã¯æœ€å¾Œã®å¤ã§ã‚ã‚Šã€ç”²å­åœ’å‡ºå ´ã‚’ã‹ã‘ãŸæœ€ã‚‚ç†±ã„æˆ¦ã„ã§ã™ã€‚";
    } else if (tournamentState.currentTournament === 'autumn') {
        tournamentContextPrompt = "1,2å¹´ç”Ÿã«ã‚ˆã‚‹æ–°ãƒãƒ¼ãƒ ãŒå§‹å‹•ã™ã‚‹æœ€åˆã®å…¬å¼æˆ¦ã§ã‚ã‚Šã€æ¥æ˜¥ã®ã‚»ãƒ³ãƒãƒ„å‡ºå ´æ ¡é¸è€ƒã«ã‚‚å½±éŸ¿ã™ã‚‹é‡è¦ãªå¤§ä¼šã§ã™ã€‚";
    } else if (tournamentState.currentTournament === 'spring') {
        tournamentContextPrompt = "æ˜¥ã®ã‚»ãƒ³ãƒãƒ„ï¼ˆé¸æŠœï¼‰å‡ºå ´æ ¡ã‚‚æ±ºã¾ã‚Šã€å¤ã®å¤§ä¼šã®ã‚·ãƒ¼ãƒ‰æ¨©ã‚’ã‹ã‘ãŸå‰å“¨æˆ¦ã§ã™ã€‚";
        seedContext = "å‰å›ã®ç§‹å­£å¤§ä¼šãƒ™ã‚¹ãƒˆ8";
    }

    // --- 1. å¤§ä¼šå±•æœ›è¨˜äº‹ã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---
    if (matchId === 'preview') {
        // (å±•æœ›è¨˜äº‹ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
        const { seeds, teams } = tournamentState;
        const blockAnalyses = [];
        const numBlocks = 4; const blockSize = 32;
        const getTeamRank = (teamName) => calculateRank(teamName, tournamentState);
        for (let i = 0; i < numBlocks; i++) {
            const blockName = String.fromCharCode(65 + i);
            const start = i * blockSize; const end = (i + 1) * blockSize;
            const blockTeams = teams.slice(start, end);
            if (blockTeams.length === 0) continue;
            const promisingInBlock = blockTeams.filter(team => {
                const rank = getTeamRank(team);
                return seeds.some(s => s.team === team) || ['A', 'B'].includes(rank);
            }).map(team => `${team} ${getSeedRankString(team, seeds)}`);
            blockAnalyses.push(`- ${blockName}ãƒ–ãƒ­ãƒƒã‚¯ (${blockTeams.length}æ ¡): ${promisingInBlock.join(', ')}`);
        }
        const blockAnalysis = blockAnalyses.join('\n');
        let notablePlayersText = '';
        const promisingSchools = teams.filter(team => {
            const rank = getTeamRank(team);
            return seeds.some(s => s.team === team) || ['A', 'B'].includes(rank);
        });
        const notablePlayers = promisingSchools.filter(team => DETAILED_TEAM_DATA[team]);
        if (notablePlayers.length > 0) {
            notablePlayersText += '### ä»Šå¤§ä¼šã®æ³¨ç›®é¸æ‰‹\n';
            notablePlayers.forEach(team => {
                const players = DETAILED_TEAM_DATA[team]?.players.slice(0, 2) || [];
                notablePlayersText += `- **${team}**: ${players.map(p => `${p.name}(${p.year}å¹´)`).join(', ')}\n`;
            });
        }
        const seedText = seeds.map(s => `${s.team}(ç¬¬${s.rank}ã‚·ãƒ¼ãƒ‰)`).join(', ');
        prompt = `ã‚ãªãŸã¯ã€æ—¥æœ¬ã®é«˜æ ¡é‡çƒã‚’æ·±ãæ„›ã™ã‚‹ã€æƒ…ç†±çš„ãªã‚¹ãƒãƒ¼ãƒ„è¨˜è€…ã§ã™ã€‚
é–“ã‚‚ãªãé–‹å¹•ã™ã‚‹ã€Œ${tournamentYear}å¹´åº¦ ${tournamentName}ã€ã®å±•æœ›è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
### å¤§ä¼šã®æ–‡è„ˆ (æœ€é‡è¦)
${tournamentContextPrompt}
ã‚·ãƒ¼ãƒ‰æ ¡ã¯ã€Œ${seedContext}ã€ã®8æ ¡ã§ã™ã€‚
### å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰
${PREFECTURE_LORE}
---
### ã‚·ãƒ¼ãƒ‰æ ¡ (å‰å¤§ä¼šãƒ™ã‚¹ãƒˆ8)
${seedText}
### å„ãƒ–ãƒ­ãƒƒã‚¯ã®æœ‰åŠ›æ ¡
${blockAnalysis}
${notablePlayersText}
### åŸ·ç­†æŒ‡ç¤º
- ã€â˜…å¤§ä¼šã®æ–‡è„ˆã‚’åæ˜ ã€‘: è¨˜äº‹å…¨ä½“ã§ã€${tournamentName}ãªã‚‰ã§ã¯ã®è¦–ç‚¹ï¼ˆä¾‹ï¼šå¤ã®3å¹´ç”Ÿã®æƒ³ã„ã€ç§‹ã®æ–°ãƒãƒ¼ãƒ ã®è©¦é‡‘çŸ³ã€æ˜¥ã®ã‚·ãƒ¼ãƒ‰æ¨©äº‰ã„ï¼‰ã‚’å¿…ãšåæ˜ ã•ã›ã¦ãã ã•ã„ã€‚
- ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘: ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã®ã€‡ã€‡ã€ã‚„ã€Œå‰å¤§ä¼šãƒ™ã‚¹ãƒˆ8ã®â–³â–³ã€ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚è§¦ã‚Œã¦åˆ†æã—ã¦ãã ã•ã„ã€‚
- ã©ã®ã‚·ãƒ¼ãƒ‰æ ¡ãŒæœ€ã‚‚å³ã—ã„ãƒ–ãƒ­ãƒƒã‚¯ã«å…¥ã£ãŸã‹ã€é€†ã«æœ€ã‚‚æ¥½ãªãƒ–ãƒ­ãƒƒã‚¯ã¯ã©ã“ã‹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
- ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã®å®ŸåŠ›æ ¡ã®ä¸­ã‹ã‚‰ã€å¤§ä¼šã®ã€Œãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ã€ã¨ãªã‚Šãã†ãªãƒãƒ¼ãƒ ã‚’æŒ™ã’ã¦ã¿ã¦ãã ã•ã„ã€‚
- è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
### å‡ºåŠ›å½¢å¼
{"title": "ï¼ˆã“ã“ã«è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼‰", "body": "ï¼ˆã“ã“ã«è¨˜äº‹ã®æœ¬æ–‡ï¼‰"}`;
        try {
            const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
                if (article) return { ...article, timestamp: Date.now() };
            }
            throw new Error("AI preview response format error.");
        } catch (error) {
            console.error("AI preview article generation failed:", error);
            return { title: "å±•æœ›è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼", body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", timestamp: Date.now(), error: true, errorId: `preview-${Date.now()}` };
        }
    }

    // --- 2. è©¦åˆå¾Œè¨˜äº‹ã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---
    const winnerScore = Math.max(parseInt(dbMatch.score1) || 0, parseInt(dbMatch.score2) || 0);
    const loserScore = Math.min(parseInt(dbMatch.score1) || 0, parseInt(dbMatch.score2) || 0);
    const winnerRankDesc = getRankDescription(calculateRank(winnerName, tournamentState));
    const loserRank = calculateRank(loserName, tournamentState);
    const loserRankDesc = getRankDescription(loserRank);
    const winnerSeedRank = getSeedRankString(winnerName, tournamentState.seeds);
    const loserSeedRank = getSeedRankString(loserName, tournamentState.seeds);
    const winnerRecord = tournamentState.teamRecords[winnerName];
    const loserRecord = tournamentState.teamRecords[loserName];
    const winnerDynamicInfo = generateDynamicTeamInfo(winnerName, winnerData, winnerRecord);
    const loserDynamicInfo = generateDynamicTeamInfo(loserName, loserData, loserRecord);
    const winnerCoach = winnerData.coach;
    const loserCoach = loserData.coach;
    const roundName = getRoundNameFromMatchId(matchId); 
    
    let nextOpponentText = 'æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã¯æœªå®šã€‚'; 
    if (nextOpponent) {
        if (nextOpponent.opponentName === 'å„ªå‹') {
            nextOpponentText = (tournamentState.currentTournament === 'summer')
                ? 'å¤ã®ç”²å­åœ’å‡ºå ´ãŒæ±ºå®šã—ãŸã€‚'
                : (tournamentState.currentTournament === 'autumn' ? 'ã‚»ãƒ³ãƒãƒ„å‡ºå ´ãŒæœ‰åŠ›ã¨ãªã£ãŸã€‚' : 'ä»Šå¤§ä¼šã€è¦‹äº‹å„ªå‹ã‚’æœãŸã—ãŸã€‚');
        }
        else if (nextOpponent.opponentName && nextOpponent.opponentName !== 'ï¼ˆæœªå®šï¼‰') {
            const nextOpponentSeed = getSeedRankString(nextOpponent.opponentName, tournamentState.seeds);
            const rankText = nextOpponent.opponentRank ? `(${nextOpponent.opponentRank}ãƒ©ãƒ³ã‚¯)` : '';
            nextOpponentText = `æ¬¡ã®${nextOpponent.roundName}ã§ã¯ã€${nextOpponent.opponentName}${nextOpponentSeed}${rankText}ã¨å¯¾æˆ¦ã™ã‚‹ã€‚`;
        } 
        else if (nextOpponent.decidingMatch) {
            const dm = nextOpponent.decidingMatch;
            const team1Seed = getSeedRankString(dm.team1, tournamentState.seeds);
            const team2Seed = getSeedRankString(dm.team2, tournamentState.seeds);
            nextOpponentText = `æ¬¡ã®${nextOpponent.roundName}ã§ã¯ã€${dm.team1}${team1Seed}(${dm.rank1}ãƒ©ãƒ³ã‚¯)ã¨${dm.team2}${team2Seed}(${dm.rank2}ãƒ©ãƒ³ã‚¯)ã®å‹è€…ã¨å¯¾æˆ¦ã™ã‚‹ã€‚`;
        }
    }
    const calledGameText = matchContext.calledGame ? `\n- **ã€é‡è¦ã€‘** ã“ã®è©¦åˆã¯ ${matchContext.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰ (${winnerScore}-${loserScore}) ã§ ${winnerName} ãŒå‹åˆ©ã—ã¾ã—ãŸã€‚` : '';
    const rivalryText = matchContext.rivalryType ? `\n- **ã€æœ€é‡è¦ã€‘** ã“ã®è©¦åˆã¯ã€Œ${matchContext.rivalryType}ã€ã¨ã„ã†ç‰¹åˆ¥ãªå› ç¸ã®å¯¾æ±ºã§ã—ãŸã€‚` : '';
    let scheduleText = '';
    if (matchContext.schedule) {
        const sched = matchContext.schedule;
        const team1Region = TEAM_DATA[dbMatch.team1]?.region || 'ä¸æ˜';
        const team2Region = TEAM_DATA[dbMatch.team2]?.region || 'ä¸æ˜';
        scheduleText = `\n- **è©¦åˆä¼šå ´:** ${sched.stadiumFull} (${sched.region}åœ°åŒº)\n`;
        if (sched.region === team1Region && sched.region !== team2Region) { scheduleText += `- **åœ°ã®åˆ©:** ${dbMatch.team1}ã«ã¨ã£ã¦åœ°å…ƒçƒå ´ã§ã®è©¦åˆã¨ãªã£ãŸã€‚\n`; }
        else if (sched.region !== team1Region && sched.region === team2Region) { scheduleText += `- **åœ°ã®åˆ©:** ${dbMatch.team2}ã«ã¨ã£ã¦åœ°å…ƒçƒå ´ã§ã®è©¦åˆã¨ãªã£ãŸã€‚\n`; }
    }
    let atmosphereText = '';
    if (matchContext.atmosphere_team1 || matchContext.atmosphere_team2) {
        atmosphereText = '\n--- ### **å‚è€ƒæƒ…å ±ï¼šè©¦åˆå‰ã®é›°å›²æ°—ãƒ»å…¬ç´„**\n';
        if (matchContext.atmosphere_team1) atmosphereText += `- ${dbMatch.team1}: ${matchContext.atmosphere_team1}\n`;
        if (matchContext.atmosphere_team2) atmosphereText += `- ${dbMatch.team2}: ${matchContext.atmosphere_team2}\n`;
    }
    let ballQualityText = '';
    if (matchContext.team1BallQuality && matchContext.team2BallQuality) {
        ballQualityText = `\n--- ### **å‚è€ƒæƒ…å ±ï¼šãƒãƒ¼ãƒ åˆ¥ æ‰“çƒå“è³ª**\n- ${matchContext.team1BallQuality}\n- ${matchContext.team2BallQuality}\n`;
    }
    
    let cinderellaPraiseInstruction = ""; 
    const idParts = matchId.split('-');
    let roundNum = 0;
    if (idParts[0] === 'F') {
        roundNum = Math.log2(tournamentState.teams.length); // 7
    } else if (idParts[1] && idParts[1].startsWith('R')) {
        roundNum = parseInt(idParts[1].slice(1));
    }
    if (roundNum > 0) {
        if ( (loserRank === 'E' && roundNum >= 3) ||
             (loserRank === 'D' && roundNum >= 4) ||
             (loserRank === 'C' && roundNum >= 5) )
        {
            cinderellaPraiseInstruction = `
- **ã€â˜…å¿«é€²æ’ƒã¸ã®è¨€åŠã€‘**: æ•—åŒ—ã—ãŸ${loserName}ã¯${loserRankDesc}(${loserRank}ãƒ©ãƒ³ã‚¯)ã§ã—ãŸãŒã€ä»Šå¤§ä¼šã¯ã€Œ${loserJourney}ã€ã¨è¦‹äº‹ãªå¿«é€²æ’ƒã‚’è¦‹ã›ã€${roundName}ã¾ã§å‹ã¡ä¸ŠãŒã‚Šã¾ã—ãŸã€‚ã“ã®è¨˜äº‹ã§ã¯ã€${loserName}ã®å¥é—˜ã‚’ç§°ãˆã‚‹ä¸€æ–‡ï¼ˆä¾‹ï¼šã€Œ${loserRankDesc}ãªãŒã‚‰${roundName}ã¾ã§å‹ã¡é€²ã‚“ã å½¼ã‚‰ã«ã€çƒå ´å…¨ä½“ã‹ã‚‰æ‹æ‰‹ãŒé€ã‚‰ã‚ŒãŸã€ï¼‰ã‚’**å¿…ãš**å«ã‚ã¦ãã ã•ã„ã€‚`;
        }
    }

    if (dbMatch.details) {
        // (Aãƒ«ãƒ¼ãƒˆï¼šè©³ç´°å…¥åŠ›ã‚ã‚Š)
        const { highlights, keyPlayerNames } = createHighlightsText(dbMatch, winnerName);
        const factListText = highlights.map(fact => `- ${fact.inning || ''}å› ${fact.team || ''} ${fact.player || ''}: ${fact.description}`).join('\n');
        const winnerKey = dbMatch.team1 === winnerName ? 'team1' : 'team2';
        const winnerPlayersInGame = new Set( (dbMatch.details.batting?.[winnerKey] || []).map(p => p.name).concat((dbMatch.details.pitching?.[winnerKey] || []).map(p => p.name)) );
        const winnerKeyPlayers = keyPlayerNames.filter(name => winnerPlayersInGame.has(name));
        const loserKeyPlayers = keyPlayerNames.filter(name => !winnerPlayersInGame.has(name));
        const formatPlayerList = (playerNames, teamName, detailedTeamData) => {
            if (playerNames.length === 0) return 'ç‰¹ã«ãªã—';
            return playerNames.map(playerName => {
                const detailedInfo = detailedTeamData?.players.find(p => p.name === playerName);
                return detailedInfo ? `- **${detailedInfo.name} (${detailedInfo.year}å¹´ãƒ»${detailedInfo.position})**: ${detailedInfo.desc}` : `- **${playerName}**`;
            }).join('\n');
        };
        const winnerPlayersPrompt = formatPlayerList(winnerKeyPlayers, winnerName, winnerDetailedData);
        const loserPlayersPrompt = formatPlayerList(loserKeyPlayers, loserName, loserDetailedData);
        const lineupChangesText = `- ${winnerName}: ${winnerLineupChanges}\n- ${loserName}: ${loserLineupChanges}`;
        
        prompt = `ã‚ãªãŸã¯ã€æ—¥æœ¬ã®é«˜æ ¡é‡çƒã‚’æ·±ãæ„›ã™ã‚‹ã€æƒ…ç†±çš„ãªã‚¹ãƒãƒ¼ãƒ„è¨˜è€…ã§ã™ã€‚
ã‚ãªãŸã®å”¯ä¸€ã®ä»•äº‹ã¯ã€æä¾›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦æœ€é«˜ã®è¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§ã™ã€‚
---
### **å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰**
${PREFECTURE_LORE}
---
### **ç¾åœ¨ã®è©¦åˆçŠ¶æ³**
- **å¤§ä¼š:** ${tournamentYear}å¹´åº¦ ${tournamentName}
- **æ–‡è„ˆ:** ${tournamentContextPrompt}
- **ãƒ©ã‚¦ãƒ³ãƒ‰:** ${roundName}
${scheduleText}
${calledGameText}
### **è©¦åˆçµæœã‚µãƒãƒªãƒ¼**
- ${winnerName} ${winnerSeedRank}ãŒ ${loserName} ${loserSeedRank}ã« ${winnerScore} - ${loserScore} ã§å‹åˆ©ã€‚
${rivalryText} 
${injuryReport || ''}
### **ã€æœ€é‡è¦ã€‘ã“ã®è¨˜äº‹ã®å”¯ä¸€ã®äº‹å®Ÿæƒ…å ±æº (â˜…èƒŒç•ªå·ãƒ»ç›—å¡ä»˜ããƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢)**
${matchContext.playerStatsText} 
---
${atmosphereText}
${ballQualityText}
### **ã€æœ€é‡è¦ã€‘ã“ã®è¨˜äº‹ã®å”¯ä¸€ã®äº‹å®Ÿæƒ…å ±æº (ãƒã‚¤ãƒ©ã‚¤ãƒˆ)**
${factListText}
---
### **ä»Šå¤§ä¼šã®ä¸»ãªæŠ•æ‰‹ç™»æ¿å±¥æ­´ (ã“ã®è©¦åˆã‚ˆã‚Šå‰)**
${pitcherGamelogInfo || 'ä»Šå¤§ä¼šã€ã“ã‚ŒãŒåˆç™»æ¿ã§ã™ã€‚'}
---
### **ä»Šå¤§ä¼šã®ä¸»ãªæ‰“è€…æˆç¸¾å±¥æ­´ (ã“ã®è©¦åˆã‚ˆã‚Šå‰)**
${batterGamelogInfo || 'æ‰“è€…ã®è©¦åˆå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}
---
### **å‚è€ƒæƒ…å ±ï¼šè£œè¶³**
- **å‰è©¦åˆã‹ã‚‰ã®ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´**:
${lineupChangesText}
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹è©¦åˆã®æ±ºã‚æ‰‹**: ${dbMatch.summary || 'ãªã—'}
---
### **å‚è€ƒæƒ…å ±ï¼šãƒãƒ¼ãƒ ã¨é¸æ‰‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« (â˜…ãƒãƒ¼ãƒ æ‰“ç‡ãƒ»é€šç®—ç›—å¡å«ã‚€)**
- **${winnerName} ${winnerSeedRank}**: ${winnerDynamicInfo}
  - **ä»Šå¤§ä¼šã®è»Œè·¡**: ${winnerJourney}
  - **ç›£ç£**: ${winnerCoach ? `${winnerCoach.name} (${winnerCoach.style})` : 'æƒ…å ±ãªã—'}
- **ä¸»å°†**: ${winnerCaptainName}
  - **ä¸»ãªé¸æ‰‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«**:\n${winnerPlayersPrompt}
- **${loserName} ${loserSeedRank}**: ${loserDynamicInfo}
  - **ä»Šå¤§ä¼šã®è»Œè·¡**: ${loserJourney}
  - **ç›£ç£**: ${loserCoach ? `${loserCoach.name} (${loserCoach.style})` : 'æƒ…å ±ãªã—'}
- **ä¸»å°†**: ${loserCaptainName}
  - **ä¸»ãªé¸æ‰‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«**:\n${loserPlayersPrompt}
---
### **åŸ·ç­†æŒ‡ç¤º**
${cinderellaPraiseInstruction}
- **ã€â˜…å¤§ä¼šã®æ–‡è„ˆã‚’åæ˜ ã€‘**: è¨˜äº‹å…¨ä½“ã§ã€${tournamentName}ãªã‚‰ã§ã¯ã®è¦–ç‚¹ï¼ˆä¾‹ï¼šå¤ã®3å¹´ç”Ÿã®æƒ³ã„ã€ç§‹ã®æ–°ãƒãƒ¼ãƒ ã®è©¦é‡‘çŸ³ã€æ˜¥ã®ã‚·ãƒ¼ãƒ‰æ¨©äº‰ã„ï¼‰ã‚’å¿…ãšåæ˜ ã•ã›ã¦ãã ã•ã„ã€‚
- **ã€â˜…â˜… æ¬ å ´è€…ã¸ã®è¨€åŠ (æœ€é‡è¦) â˜…â˜…ã€‘**: ã‚‚ã—ã€Œè©¦åˆçµæœã‚µãƒãƒªãƒ¼ã€ã®ç›´ä¸‹ã«ã€Œä¸»ãªæ¬ å ´è€…ã€ï¼ˆä¾‹ï¼šã€‡ã€‡ [ğŸ¥] (ä¸»åŠ›), â–³â–³ [ğŸ©¹] (æ§ãˆ)ï¼‰ã«é–¢ã™ã‚‹æƒ…å ±(${injuryReport})ãŒã‚ã‚‹å ´åˆã€ãã®é¸æ‰‹ã®**é‡è¦åº¦ï¼ˆä¸»åŠ›ã‹æ§ãˆã‹ï¼‰**ã«å¿œã˜ã¦ã€è¨˜äº‹ã®æ·±åˆ»åº¦ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€ã‚¨ãƒ¼ã‚¹å§«å·(ä¸»åŠ›)ã®é›¢è„±ã¯ãƒ¤ãƒã™ãã‚‹ã€ã€éˆ´æœ¨(æ§ãˆ)ã®æ€ªæˆ‘ã¯ç—›ã„ãŒã€ã¾ã...ã€ï¼‰
- **ã€æ¬¡æˆ¦ã¸ã®å±•æœ›ã€‘**: è¨˜äº‹ã®æœ€å¾Œã«ã€æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ï¼ˆ${nextOpponentText}ï¼‰ã«ç°¡æ½”ã«è§¦ã‚Œã€ä»Šå¾Œã®æˆ¦ã„ã¸ã®å±•æœ›ã‚’è¨˜è¿°ã—ã¦ç· ã‚ããã‚‹ã“ã¨ã€‚
- ã€Œäº‹å®Ÿãƒªã‚¹ãƒˆã€ã‚’å³å¯†ã«åŸºã«ã€è©¦åˆã®ç‰©èªã‚’å†æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚
- **ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘**: **ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã®ã€‡ã€‡ã€**ã‚„**ã€Œã‚·ãƒ¼ãƒ‰æ ¡ã®â–³â–³ãŒè‹¦æˆ¦ã€**ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚å…·ä½“çš„ã«è¨€åŠã—ã€è©¦åˆã®æ–‡è„ˆã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚
- **ã€ç›£ç£ã®é‡‡é…ã€‘**: ã€Œã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´ã€ãŒã‚ã£ãŸå ´åˆã€ãã®é‡‡é…ãŒè©¦åˆã«ã©ã†å½±éŸ¿ã—ãŸã‹ã«è§¦ã‚Œã‚‹ã“ã¨ã€‚
- **ã€ç‰©èªã®é€£ç¶šæ€§ã€‘**: ã€Œä»Šå¤§ä¼šã®è»Œè·¡ã€æƒ…å ±ã‚’å‚è€ƒã«ã€ã“ã‚Œã¾ã§ã®æˆ¦ã„ã¨ç¹‹ãŒã‚Šã®ã‚ã‚‹ç‰©èªã‚’æå†™ã™ã‚‹ã“ã¨ã€‚
- è©¦åˆå¾Œã®ä¸¡ãƒãƒ¼ãƒ ç›£ç£ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã€è©¦åˆå†…å®¹ã‚„ãƒãƒ¼ãƒ ã®èƒŒæ™¯ã‚’åæ˜ ã•ã›ã¦ç”Ÿæˆã™ã‚‹ã“ã¨ã€‚
- **ã€æ¬¡æˆ¦ã¸ã®å±•æœ›ã€‘**: è¨˜äº‹ã®æœ€å¾Œã«ã€æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ï¼ˆ${nextOpponentText}ï¼‰ã«ç°¡æ½”ã«è§¦ã‚Œã€ä»Šå¾Œã®æˆ¦ã„ã¸ã®å±•æœ›ã‚’è¨˜è¿°ã—ã¦ç· ã‚ããã‚‹ã“ã¨ã€‚
- **ã€èƒŒç•ªå·ã®æ„å‘³ï¼ˆè£é‡ï¼‰ã€‘**: è¨˜äº‹ä¸­ã§é¸æ‰‹ã«è¨€åŠã™ã‚‹éš›ã€**ã‚‚ã—ãã®èƒŒç•ªå·ãŒç‰©èªä¸Šé‡è¦ã§ã‚ã‚Œã°**ï¼ˆä¾‹ï¼šã‚¨ãƒ¼ã‚¹[#1]ã®å¿«æŠ•ãƒ»ä¸æŒ¯ã€ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ç•ªå·[#2-9]ã®è²¬ä»»ã€ã¾ãŸã¯æ§ãˆç•ªå·[#10ä»¥é™]ã®é¸æ‰‹ãŒäºˆæƒ³å¤–ã®æ´»èºã‚’ã—ãŸå ´åˆãªã©ï¼‰ã€ãã®èƒŒç•ªå·ãŒæŒã¤æ„å‘³ã«è§¦ã‚Œã¦ãã ã•ã„#ã¯èƒŒç•ªå·ã¨è¨€ã„æ›ãˆã¦ãã ã•ã„ã€‚(ä¾‹S1â†’èƒŒç•ªå·1)ã€‚
- **ã€ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ã®å ´åˆã€‘**: ã‚‚ã—è©¦åˆãŒã‚³ãƒ¼ãƒ«ãƒ‰ã§çµ‚äº†ã—ãŸå ´åˆã€ãã®æ—¨ã‚’è¨˜äº‹ã®å†’é ­ã‚„ã‚¿ã‚¤ãƒˆãƒ«ã§æ˜ç¢ºã«è¨˜è¿°ã—ã€å¤§å·®ãŒã¤ã„ãŸç†ç”±ã«ã‚‚è§¦ã‚Œã‚‹ã“ã¨ã€‚
- **ã€å› ç¸ã®å¯¾æ±ºã€‘**: ã‚‚ã—è©¦åˆãŒã€Œå› ç¸ã®å¯¾æ±ºã€ã§ã‚ã£ãŸå ´åˆã€ãã®ãƒ‰ãƒ©ãƒæ€§ã‚’è¨˜äº‹ã®ä¸­å¿ƒã«æ®ãˆã€ç†±ãæå†™ã—ã¦ãã ã•ã„ã€‚
- **ã€é¸æ‰‹ã®çŠ¶æ…‹ã¨æ‰“çƒã®è³ªï¼ˆæ‰“è€…ï¼‰ã€‘**: ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ã«ã€Œ(çŠ¶æ…‹: ã€‡ã€‡)ã€ã¨ã„ã†è¨˜è¿°ãŒã‚ã‚‹é¸æ‰‹ã«æ³¨ç›®ã—ã€**å‰å›ã®è©¦åˆã‹ã‚‰ã®é€£ç¶šæ€§**ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚
- **ã€è©¦åˆå‰ã®é›°å›²æ°—ã€‘**: ã‚‚ã—ã€Œè©¦åˆå‰ã®é›°å›²æ°—ãƒ»å…¬ç´„ã€ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®æƒ…å ±ï¼ˆä¾‹ï¼šã€Œç›£ç£ãŒã‚¨ãƒ¼ã‚¹æ¸©å­˜ã‚’å…¬è¨€ã€ï¼‰ã‚’**è©¦åˆçµæœã¨é–¢é€£ä»˜ã‘**ã€è¨˜äº‹ã®é‡è¦ãªãƒ†ãƒ¼ãƒã¨ã—ã¦æ‰±ã£ã¦ãã ã•ã„ã€‚
- **ã€å¸¸è­˜ã®åæ˜ ã€‘**: ã‚ãªãŸãŒç†ŸçŸ¥ã—ã¦ã„ã‚‹ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰ã‚’**èƒŒæ™¯çŸ¥è­˜ã¨ã—ã¦**åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚
- **ã€çƒå ´ã®åœ°ã®åˆ©ã€‘**: ã‚‚ã—ã€Œåœ°ã®åˆ©ã€æƒ…å ±ãŒã‚ã‚‹å ´åˆã€ãã®**åœ°å…ƒã®ã‚¢ãƒ‰ãƒãƒ³ãƒ†ãƒ¼ã‚¸**ãŒè©¦åˆã«ã©ã†å½±éŸ¿ã—ãŸã‹ã«è§¦ã‚Œã¦ãã ã•ã„ã€‚
- **ã€ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã€‘**: è¨˜äº‹ã®æœ€å¾Œã«ã€Œä»Šæ—¥ã®ãƒ’ãƒ¼ãƒ­ãƒ¼ã€ã¨ã„ã†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨­ã‘ã¦ãã ã•ã„ã€‚ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ã‚„äº‹å®Ÿãƒªã‚¹ãƒˆã‹ã‚‰**æœ€ã‚‚æ´»èºã—ãŸå‹åˆ©ãƒãƒ¼ãƒ ã®é¸æ‰‹1å**ã‚’é¸ã³å‡ºã—ã€ãã®é¸æ‰‹ã¸ã®æ¶ç©ºã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã¨ã€ãã‚Œã«å¯¾ã™ã‚‹ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚‰ã—ã„å›ç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
- **ã€ç›£ç£ãƒ»ä¸»å°†ã‚³ãƒ¡ãƒ³ãƒˆã€‘**: ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã®å¾Œã€ã€Œä¸¡ãƒãƒ¼ãƒ ã®å£°ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨­ã‘ã€**å‹åˆ©ãƒãƒ¼ãƒ **ã¨**æ•—åŒ—ãƒãƒ¼ãƒ **ã®ã€Œç›£ç£ã€ãŠã‚ˆã³ã€Œä¸»å°†ã€ã®è©¦åˆå¾Œã®ç·æ‹¬ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã€ãã‚Œãã‚Œç°¡æ½”ã«ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
- **ã€â˜…æ³¨ç›®ã®æ‰“å¸­ï¼ˆæœ€é‡è¦ï¼‰ã€‘**:
    - ã€Œäº‹å®Ÿãƒªã‚¹ãƒˆã€ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ã«ã€Œï¼ˆâ˜…æ³¨ç›®ï¼‰ã€ãƒãƒ¼ã‚¯ãŒä»˜ã„ã¦ã„ã‚‹æ‰“å¸­ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚ŒãŒ**ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆç›£ç£ï¼‰ãŒã€è©¦åˆã®åˆ†æ°´å¶ºã€ã ã¨åˆ¤æ–­ã—ãŸ**ã€æœ€ã‚‚é‡è¦ãªæ‰“å¸­ã§ã™ã€‚
    - ã‚ãªãŸã®è¨˜äº‹ã§ã¯ã€**ã“ã®è¨˜äº‹ã®ä¸­å¿ƒçš„ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ**ã¨ã—ã¦ã€ã“ã®ã€Œâ˜…æ³¨ç›®ã€ã®æ‰“å¸­ã®å‰å¾Œã‚’ã€æœ€ã‚‚ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«æå†™ã—ã¦ãã ã•ã„ã€‚
- **ã€â˜…ä»Šå¤§ä¼šã®æˆç¸¾ (æœ€é‡è¦)ã€‘**:
    - ã€Œå‚è€ƒæƒ…å ±ï¼šãƒãƒ¼ãƒ ã¨é¸æ‰‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€ã«**ã€ä»Šå¤§ä¼šã®ãƒãƒ¼ãƒ æ‰“ç‡ã¯.XXXã€**ã¨ã„ã†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
    - ã“ã®æƒ…å ±ã‚’**å¿…ãšè¨˜äº‹ã«å«ã‚**ã€ãƒãƒ¼ãƒ ã®å¥½èª¿ãƒ»ä¸æŒ¯ã®æ–‡è„ˆã¨ã—ã¦æå†™ã—ã¦ãã ã•ã„ã€‚
- **ã€â˜…ç›—å¡ã¸ã®è¨€åŠ (é‡è¦)ã€‘**:
    - ã€Œãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ã€ã«**ç›—å¡(SB)**ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹é¸æ‰‹ãŒã„ãŸå ´åˆã€ãã®é¸æ‰‹ã®æ©Ÿå‹•åŠ›ï¼ˆä¾‹ï¼šã€Œã€‡ã€‡ãŒè¶³ã§ãƒãƒ£ãƒ³ã‚¹ã‚’åºƒã’ã€ï¼‰ã«ã‚‚è¨€åŠã™ã‚‹ã“ã¨ã€‚
    - ã•ã‚‰ã«ã€ãã®é¸æ‰‹ã®**ã€Œä»Šå¤§ä¼šã®é€šç®—ç›—å¡æ•°ã€**ï¼ˆä¾‹ï¼š(ä»Šå¤§ä¼š: ... 4ç›—)ï¼‰ã‚‚å¿…ãšå‚ç…§ã—ã€**ã€Œã€‡ã€‡ã¯ã“ã‚Œã§ä»Šå¤§ä¼š4å€‹ç›®ã®ç›—å¡ã€**ã¨ã„ã£ãŸå…·ä½“çš„ãªæ•°å­—ã‚’è¨˜äº‹ã«å«ã‚ã¦ãã ã•ã„ã€‚
- **ã€â˜…é€šç®—æˆç¸¾ã¸ã®è¨€åŠ (è£é‡)ã€‘**:
    - ã€Œå‚è€ƒæƒ…å ±ã€ã«**ã€(å‚è€ƒ: ãƒãƒ¼ãƒ é€šç®—æ‰“ç‡ .XXX, é€šç®— Y ç›—å¡)ã€**ã¨ã„ã†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€å¿…è¦ã«å¿œã˜ã¦ãã®ãƒãƒ¼ãƒ ã®æ©Ÿå‹•åŠ›ã«ã‚‚è¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€â˜…ç™»æ¿å±¥æ­´ã¸ã®è¨€åŠ (æœ€é‡è¦)ã€‘**: ã€Œä»Šå¤§ä¼šã®ä¸»ãªæŠ•æ‰‹ç™»æ¿å±¥æ­´ã€ã®æƒ…å ±ã‚’å¿…ãšç¢ºèªã—ã€ä»¥ä¸‹ã®ç‚¹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã‚‹ã“ã¨ã€‚
    - **é€£æŠ•/ç™»æ¿é–“éš”**: ã€Œã€‡ã€‡ã€é€£æŠ•ã˜ã‚ƒã‚“ã€ã€Œä¸­1æ—¥ã§ã“ã‚Œã¯ã‚­ãƒ„ã‚¤ã€
    - **é…·ä½¿**: ã€Œã‚¨ãƒ¼ã‚¹æŠ•ã’ã™ãã ã‚ã€ã€Œç›£ç£ã¯éˆ´æœ¨ã‚’å£Šã™æ°—ã‹ã€
    - **å¥½ä¸èª¿ã®æ³¢**: ã€Œå‰å›ç‚ä¸Šã—ãŸã®ã«ã‚ˆã†ç«‹ã¡ç›´ã£ãŸãªã€ã€Œã“ãªã„ã ã¯è‰¯ã‹ã£ãŸã®ã«ä»Šæ—¥ã¯ã‚¢ã‚«ãƒ³ã‹ã€
- **ã€â˜…æ‰“è€…å±¥æ­´ã¸ã®è¨€ä¸ (æœ€é‡è¦)ã€‘**: ã€Œä»Šå¤§ä¼šã®ä¸»ãªæ‰“è€…æˆç¸¾å±¥æ­´ã€ã‚‚å¿…ãšç¢ºèªã—ã€ä»¥ä¸‹ã®ç‚¹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã‚‹ã“ã¨ã€‚
    - **å¥½ä¸èª¿ã®æ³¢**: ã€Œã€‡ã€‡ã€ä»Šæ—¥ã§3è©¦åˆé€£ç¶šãƒ’ãƒƒãƒˆã‚„ã‚“ï¼ã€ã€Œâ–³â–³ã€10æ‰“æ•°ãƒãƒ¼ãƒ’ãƒƒãƒˆã¨ã‹ã‚‚ã†çµ‚ã‚ã‚Šã ã‚â€¦ã€
    - **å½¹å‰²**: ã€Œã“ã„ã¤ä»£æ‰“æˆåŠŸç‡100%ã˜ã‚ƒã­ï¼Ÿã€ã€Œ1ç•ªã«ä¸Šã’ãŸã‚‰æ‰“ã¡å‡ºã—ãŸãªã€
---
### ç·¨é›†é•·ã‹ã‚‰ã®è¿½åŠ æŒ‡ç¤º
${(userFeedback && userFeedback.include) ? `- **ã€æœ€é‡è¦æŒ‡ç¤ºã€‘** ${userFeedback.include}\n` : ''}
${(userFeedback && userFeedback.exclude) ? `- **ã€å³ç¦äº‹é …ã€‘** ${userFeedback.exclude}\n` : 'ç‰¹ã«ãªã—'}
---
### å‡ºåŠ›å½¢å¼ã€å³å®ˆã€‘
{"title": "ï¼ˆã“ã“ã«è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼‰", "body": "ï¼ˆã“ã“ã«è¨˜äº‹ã®æœ¬æ–‡ï¼‰"}
`;

   } else {
        // (Bãƒ«ãƒ¼ãƒˆï¼šè©³ç´°å…¥åŠ›ãªã—)
        prompt = `ã‚ãªãŸã¯ã€é«˜æ ¡é‡çƒå°‚é–€ã®AIè¨˜è€…ã§ã™ã€‚
ä»¥ä¸‹ã®è©¦åˆçµæœã«åŸºã¥ãã€ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
---
### **å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰**
${PREFECTURE_LORE}
---
### **ç¾åœ¨ã®è©¦åˆçŠ¶æ³**
- **å¤§ä¼š:** ${tournamentYear}å¹´åº¦ ${tournamentName}
- **æ–‡è„ˆ:** ${tournamentContextPrompt}
- **ãƒ©ã‚¦ãƒ³ãƒ‰:** ${roundName} 
${scheduleText} 
### è©¦åˆæƒ…å ±
- **å‹åˆ©ãƒãƒ¼ãƒ **: ${winnerName} ${winnerSeedRank} (${winnerRankDesc})(ä¸»å°†: ${winnerCaptainName})
- **æ•—åŒ—ãƒãƒ¼ãƒ **: ${loserName} ${loserSeedRank} (${loserRankDesc})(ä¸»å°†: ${loserCaptainName})
- **ã‚¹ã‚³ã‚¢**: ${winnerScore} - ${loserScore}
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹è©¦åˆã®æ±ºã‚æ‰‹**: ${dbMatch.summary || 'ãªã—'}
${calledGameText} 
${rivalryText} 
${injuryReport || ''}
### **å‚è€ƒæƒ…å ±ï¼šãƒãƒ¼ãƒ ã®èƒŒæ™¯ (â˜…ãƒãƒ¼ãƒ æ‰“ç‡ãƒ»é€šç®—ç›—å¡å«ã‚€)**
- **${winnerName} ${winnerSeedRank}**: ${winnerDynamicInfo}
  - **ä»Šå¤§ä¼šã®è»Œè·¡**: ${winnerJourney}
- **${loserName} ${loserSeedRank}**: ${loserDynamicInfo}
  - **ä»Šå¤§ä¼šã®è»Œè·¡**: ${loserJourney}
---
### åŸ·ç­†æŒ‡ç¤º
- **ã€â˜…å¤§ä¼šã®æ–‡è„ˆã‚’åæ˜ ã€‘**: è¨˜äº‹å…¨ä½“ã§ã€${tournamentName}ãªã‚‰ã§ã¯ã®è¦–ç‚¹ï¼ˆä¾‹ï¼šå¤ã®3å¹´ç”Ÿã®æƒ³ã„ã€ç§‹ã®æ–°ãƒãƒ¼ãƒ ã®è©¦é‡‘çŸ³ã€æ˜¥ã®ã‚·ãƒ¼ãƒ‰æ¨©äº‰ã„ï¼‰ã‚’å¿…ãšåæ˜ ã•ã›ã¦ãã ã•ã„ã€‚
- **ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘**: **ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã®ã€‡ã€‡ãŒé †å½“ã«å‹åˆ©ã€**ã‚„**ã€Œãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã®â–³â–³ãŒç¬¬8ã‚·ãƒ¼ãƒ‰ã‚’ç ´ã‚‹æ³¢ä¹±ã€**ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚å…·ä½“çš„ã«è¨€åŠã—ã¦ãã ã•ã„ã€‚
- **ã€â˜…â˜… æ¬ å ´è€…ã¸ã®è¨€åŠ (æœ€é‡è¦) â˜…â˜…ã€‘**: ã‚‚ã—ã€Œè©¦åˆæƒ…å ±ã€ã®ç›´ä¸‹ã«ã€Œä¸»ãªæ¬ å ´è€…ã€ï¼ˆä¾‹ï¼šã€‡ã€‡ [ğŸ¥] (ä¸»åŠ›), â–³â–³ [ğŸ©¹] (æ§ãˆ)ï¼‰ã«é–¢ã™ã‚‹æƒ…å ±(${injuryReport})ãŒã‚ã‚‹å ´åˆã€ãã®é¸æ‰‹ã®**é‡è¦åº¦ï¼ˆä¸»åŠ›ã‹æ§ãˆã‹ï¼‰**ã«å¿œã˜ã¦ã€è¨˜äº‹ã®æ·±åˆ»åº¦ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€ã‚¨ãƒ¼ã‚¹å§«å·(ä¸»åŠ›)ã®é›¢è„±ã¯ãƒ¤ãƒã™ãã‚‹ã€ã€éˆ´æœ¨(æ§ãˆ)ã®æ€ªæˆ‘ã¯ç—›ã„ãŒã€ã¾ã...ã€ï¼‰
${cinderellaPraiseInstruction}
- **ã€â˜…ä»Šå¤§ä¼šã®æˆç¸¾ (æœ€é‡è¦)ã€‘**: ã€Œãƒãƒ¼ãƒ ã®èƒŒæ™¯ã€ã«ã‚ã‚‹ã€ä»Šå¤§ä¼šã®ãƒãƒ¼ãƒ æ‰“ç‡ã¯.XXXã€ã¨ã„ã†æƒ…å ±ã‚’**å¿…ãšè¨˜äº‹ã«å«ã‚**ã€ãƒãƒ¼ãƒ ã®å¥½èª¿ãƒ»ä¸æŒ¯ã®æ–‡è„ˆã¨ã—ã¦æå†™ã—ã¦ãã ã•ã„ã€‚
- è¨˜äº‹ã®æœ€å¾Œã«ã€å‹åˆ©ãƒãƒ¼ãƒ ã®ç›£ç£ã¾ãŸã¯ä¸»å°†ã®å–œã³ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä¾‹ï¼šã€ã€‡ã€‡ç›£ç£ã€Œé¸æ‰‹ãŸã¡ãŒã‚ˆãé ‘å¼µã£ã¦ãã‚ŒãŸã€ã€ï¼‰ã‚’ä¸€è¡Œè¿½åŠ ã—ã¦ãã ã•ã„ã€‚
- **è¨˜äº‹ã®æœ€å¾Œã«ã€æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ï¼ˆ${nextOpponentText}ï¼‰ã«ç°¡æ½”ã«è§¦ã‚Œã¦ç· ã‚ããã£ã¦ãã ã•ã„ã€‚**
- è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;
    }

// â–¼â–¼â–¼ ã€è¿½åŠ ã€‘ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼çµæœãŒã‚ã‚Œã°ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¼·åˆ¶çš„ã«è¿½åŠ ã™ã‚‹ â–¼â–¼â–¼
    if (matchContext.interview) {
        const { manager, hero } = matchContext.interview;
        
        prompt += `
\n---
### ã€ç‹¬å ã€‘è©¦åˆå¾Œã®å–œã³ã®å£°
#### â‘  ç›£ç£ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼
è¨˜è€…ï¼šã€Œ${manager.question}ã€
ç›£ç£ï¼šã€Œ${manager.answer}ã€

#### â‘¡ ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼
è¨˜è€…ï¼šã€Œ${hero.question}ã€
é¸æ‰‹ï¼šã€Œ${hero.answer}ã€

**åŸ·ç­†æŒ‡ç¤ºï¼ˆæœ€å„ªå…ˆï¼‰:** è¨˜äº‹ã®å¾ŒåŠã§ã€ç›£ç£ã®ç·æ‹¬ã‚³ãƒ¡ãƒ³ãƒˆã¨ã€ãƒ’ãƒ¼ãƒ­ãƒ¼é¸æ‰‹ã®ç”Ÿã®å£°ã‚’å¿…ãšå¼•ç”¨ã—ã¦ãã ã•ã„ã€‚
ç›£ç£ã®è¨€è‘‰ã‹ã‚‰ã¯ã€Œãƒãƒ¼ãƒ ã®æ–¹é‡ã‚„å‹å› ã€ã‚’ã€é¸æ‰‹ã®è¨€è‘‰ã‹ã‚‰ã¯ã€Œç¾å ´ã®ç†±é‡ã‚„æ„Ÿæƒ…ã€ã‚’æ±²ã¿å–ã‚Šã€è¨˜äº‹ã«æ·±ã¿ã‚’ä¸ãˆã¦ãã ã•ã„ã€‚
---
`;
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json(); 
        if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
            const rawTextFromAi = result.candidates[0].content.parts[0].text; 
            const article = parseJsonFromText(rawTextFromAi); 
            if (article && !article.body && article.article) { article.body = article.article; }
            if (article && article.title && article.body) { 
                
                const isNewspaperWorthy = (
                    dbMatch.details && 
                    tournamentState.settings.enableArticleGeneration
                );
                const newspaperHtml = isNewspaperWorthy ? createNewspaperHtml(article, { winnerName, loserName, dbMatch, matchId }) : null;
                
                return { 
                    ...article, 
                    isNewspaper: isNewspaperWorthy,
                    timestamp: Date.now(), 
                    newspaperHtml: newspaperHtml,
                    context: matchContext
                };
            } else {
                 console.error("parseJsonFromText failed or keys (title/body/article) missing for raw text:", rawTextFromAi);
                 throw new Error("AI response format error after parsing."); 
            }
        } else {
             console.error("Unexpected AI response structure:", result);
             throw new Error("AI response structure is missing expected parts."); 
        }
    } catch (error) {
        console.error("AIè¨˜äº‹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return { 
            title: "è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼", body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 
            timestamp: Date.now(), error: true, errorId: matchId,
            context: matchContext 
        };
    }
}

/**
     * AIã«ã‚¹ã‚­ãƒƒãƒ—ã—ãŸãƒ©ã‚¦ãƒ³ãƒ‰ã®ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆè¨˜äº‹ã‚’ç”Ÿæˆã•ã›ã‚‹
     */
    async function generateSkipRoundSummaryArticle(roundNumber, results) {
        // æœ€ã‚‚ç•ªç‹‚ã‚ã›ãŒå¤§ãã‹ã£ãŸè©¦åˆã‚’1ã¤é¸å‡º
        const biggestUpset = results.filter(r => r.rankDiff >= 2).sort((a,b) => b.rankDiff - a.rankDiff)[0];
        
        let highlightText = "ã‚·ãƒ¼ãƒ‰æ ¡ã‚„æœ‰åŠ›æ ¡ãŒé †å½“ã«å‹ã¡é€²ã¿ã¾ã—ãŸã€‚";
        if (biggestUpset) {
            highlightText = `æœ€å¤§ã®æ³¢ä¹±ã¯${biggestUpset.winnerName}ãŒå¼·è±ª${biggestUpset.loserName}ã‚’${biggestUpset.winnerScore}-${biggestUpset.loserScore}ã§ç ´ã£ãŸä¸€æˆ¦ã§ã—ãŸã€‚`;
        }

        const prompt = `ã‚ãªãŸã¯é«˜æ ¡é‡çƒå°‚é–€ã®AIè¨˜è€…ã§ã™ã€‚
ç¾åœ¨ã€${tournamentState.tournamentYear}å¹´åº¦${tournamentNameMap[tournamentState.currentTournament]}ãŒé€²è¡Œä¸­ã§ã™ã€‚
${roundNumber}å›æˆ¦ã®å…¨è©¦åˆãŒçµ‚äº†ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å…ƒã«ã€ç°¡æ½”ãªãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆè¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### ${roundNumber}å›æˆ¦ãƒã‚¤ãƒ©ã‚¤ãƒˆ
- ${highlightText}
- æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã¯ã€å‹ã¡ä¸ŠãŒã£ãŸçŒ›è€…ãŸã¡ã«ã‚ˆã‚‹æ›´ãªã‚‹æ¿€æˆ¦ãŒæœŸå¾…ã•ã‚Œã¾ã™ã€‚

### åŸ·ç­†æŒ‡ç¤º
- ä¸Šè¨˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è‡ªç„¶ãªæ–‡ç« ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
- ã‚¿ã‚¤ãƒˆãƒ«ã¯ã€Œ${roundNumber}å›æˆ¦ãŒçµ‚äº†ï¼æ³¢ä¹±ã¯èµ·ãã‚‹ã‹ï¼Ÿã€ã®ã‚ˆã†ã«ã€æ¬¡ã¸ã®æœŸå¾…æ„Ÿã‚’ç…½ã‚‹ã‚‚ã®ã«ã—ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼
JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„: {"title": "è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«", "body": "è¨˜äº‹ã®æœ¬æ–‡"}`;

        try {
            const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
                if (article) return { ...article, timestamp: Date.now() };
            }
            throw new Error("AI summary response format error.");
        } catch (error) {
            console.error("AI summary article generation failed:", error);
            return { title: "ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆè¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼", body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", timestamp: Date.now(), error: true, errorId: `skip-summary-${roundNumber}` };
        }
    }


/**
 * è©¦åˆç›´å‰ã®ã€Œå¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆã€ã‚’AIã«ç”Ÿæˆã•ã›ã‚‹
 * (â˜…Gamelog, DynamicInfo, ä¼šå ´, å› ç¸ã®æƒ…å ±ã‚’è¿½åŠ ã—ãŸæœ€çµ‚ç‰ˆ)
 * @param {object} context - è©¦åˆã¨ãƒãƒ¼ãƒ ã®å…¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
 * @param {number} numComments - ç”Ÿæˆã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆæ•°
 * @returns {Promise<Array<object>>} - ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
 */
async function generatePreGameCheerComments(context, numComments) {
    
    // --- 1. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†è§£ ---
    const {
        name: teamName,
        rank: teamRank,
        opponent: opponentName,
        opponentRank: opponentRank,
        round: roundName,
        path: tournamentPath, // (getCurrentTournamentPerformance ã®çµæœ)
        detailed: detailedData, // (é™çš„ãªæ³¨ç›®é¸æ‰‹æƒ…å ±)
        info: teamInfo,         // (generateDynamicTeamInfo ã®çµæœ)
        playerGamelogs,       // (formatPlayerGamelogsForPrompt ã®çµæœ)
        schedule,             // (è©¦åˆä¼šå ´ãƒ»æ—¥ç¨‹)
        rivalry               // (å› ç¸æƒ…å ±)
    } = context;

    // --- 2. AIã¸ã®ãƒšãƒ«ã‚½ãƒŠæŒ‡ç¤º ---
    let personaInstructions = `
ã‚ãªãŸã¯ã€Œ${teamName}ã€ã®ç†±ç‹‚çš„ãªå¿œæ´å›£ã€ã¾ãŸã¯è©¦åˆã«æœŸå¾…ã™ã‚‹ãƒ•ã‚¡ãƒ³ã§ã™ã€‚ä»¥ä¸‹ã®ãƒšãƒ«ã‚½ãƒŠï¼ˆå½¹å‰²ï¼‰ã«ãªã‚Šãã£ã¦ã€è©¦åˆç›´å‰ã®å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆã‚’åˆè¨ˆ ${numComments} å€‹ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### ãƒšãƒ«ã‚½ãƒŠï¼ˆå½¹å‰²ï¼‰ã¨ã€ã‚ãªãŸãŒèªã‚‹ã¹ãè¦–ç‚¹
- **OB (OBãƒ»OG):**
    - **è¦–ç‚¹:** ã‚ãªãŸã®åœ¨ç±æ™‚ä»£ï¼ˆä¾‹ï¼š5å¹´å‰ã€20å¹´å‰ï¼‰ã®æ€ã„å‡ºã¨ã€ç¾åœ¨ã®ãƒãƒ¼ãƒ ã‚’æ¯”è¼ƒã—ã¦ãã ã•ã„ã€‚
    - **ï¼ˆé‡è¦ï¼‰:** ã‚‚ã—å¿œæ´ã™ã‚‹ãƒãƒ¼ãƒ ãŒã€Œ283å­¦åœ’ã€ã‚„ã€Œ765ç·åˆã€ã®ã‚ˆã†ãª**å‰µéƒ¨æ•°å¹´ã®æ–°ã—ã„å­¦æ ¡**ã®å ´åˆã€ã€Œ40å¹´å‰ã€ã¨ã„ã£ãŸçŸ›ç›¾ã—ãŸç™ºè¨€ã¯**çµ¶å¯¾ã«ã›ãš**ã€ã€Œå‰µéƒ¨ã¾ã‚‚ãªã„ã®ã«, ã“ã“ã¾ã§æ¥ã‚‹ã¨ã¯â€¦ã€ã€Œä¿ºãŒ1æœŸç”Ÿã ã£ãŸé ƒã¯â€¦ã€ã¨ã„ã£ãŸã€**æ–°ã—ã„å­¦æ ¡ã®OBã‚‰ã—ã„**ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

- **åœ¨æ ¡ç”Ÿ (ãƒ–ãƒ©ã‚¹ãƒãƒ³ãƒ‰éƒ¨å“¡ã‚„å‹äººãªã©):**
    - **è¦–ç‚¹:** ä»Šã®å­¦æ ¡ã®é›°å›²æ°—ã‚„ã€å¿œæ´ç·´ç¿’ã®æ§˜å­ã€ã‚¯ãƒ©ã‚¹ãƒ¡ã‚¤ãƒˆã¨ã—ã¦ã®é¸æ‰‹ã®ç´ é¡”ï¼ˆæ¶ç©ºã§OKï¼‰ã‚’èªã£ã¦ãã ã•ã„ã€‚
    - **ï¼ˆä¾‹ï¼‰:** ã€Œã€‡ã€‡ãã‚“ã€ã„ã¤ã‚‚ã¯æ•™å®¤ã§é™ã‹ãªã®ã«ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã ã¨å‡„ã„ï¼ã€ã€Œãƒ–ãƒ©ãƒãƒ³ã‚‚æ°—åˆå…¥ã£ã¦ã¾ã™ï¼ã€

- **åœ°å…ƒãƒ•ã‚¡ãƒ³ (ãã®åœ°åŸŸã«ä½ã‚€ãƒ•ã‚¡ãƒ³):**
    - **è¦–ç‚¹:** åœ°åŸŸã®æœŸå¾…ï¼ˆä¾‹ï¼šã€Œä»Šå¹´ã“ãç”²å­åœ’ã¸ã€ã€Œã€‡ã€‡ï¼ˆåœ°åï¼‰ã®èª‡ã‚Šã ã€ï¼‰ã‚’èªã£ã¦ãã ã•ã„ã€‚

- **é¸æ‰‹ã®å®¶æ— (æ¶ç©ºã®è¦ªã‚„å…„å¼Ÿ):**
    - **è¦–ç‚¹:** é¸æ‰‹ã®å€‹äººçš„ãªåŠªåŠ›ï¼ˆæ¶ç©ºã§OKï¼‰ã‚„ã€å®¶åº­ã§ã®æ§˜å­ã‚’èªã£ã¦ãã ã•ã„ã€‚
    - **ï¼ˆä¾‹ï¼‰:** ã€Œæ¯å­ãŒãƒ™ãƒ³ãƒå…¥ã‚Šã§ããŸã ã‘ã§å¥‡è·¡ã§ã™ã€ã€Œã‚ã®å­ã€æ¯æœ5æ™‚ã«èµ·ãã¦ç´ æŒ¯ã‚Šã—ã¦ã¾ã—ãŸã‹ã‚‰â€¦ã€
`;

    if (teamRank === 'A' || teamRank === 'B') {
        personaInstructions += `
- **ï¼ˆç„¡é–¢ä¿‚ã®ï¼‰é«˜æ ¡é‡çƒãƒ•ã‚¡ãƒ³:**
    - **è¦–ç‚¹:** ã‚ãªãŸã¯ã€ã“ã®è©¦åˆãŒ ${teamName}ï¼ˆ${getRankDescription(teamRank)}ï¼‰ã®è©¦åˆã ã‹ã‚‰è¦³ã«æ¥ãŸã€Œç„¡é–¢ä¿‚ã®é‡çƒå¥½ãã€ã§ã™ã€‚å­¦æ ¡é–¢ä¿‚è€…ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
    - **ï¼ˆä¾‹ï¼‰:** ã€Œä»Šæ—¥ã®ç›®å½“ã¦ã¯ã“ã®ã‚«ãƒ¼ãƒ‰ã€‚ãƒã‚¤ãƒ¬ãƒ™ãƒ«ãªè©¦åˆã‚’æœŸå¾…ã—ã¦ã‚‹ã€ã€Œã€‡ã€‡ï¼ˆæ³¨ç›®é¸æ‰‹ï¼‰ã®ãƒ”ãƒƒãƒãƒ³ã‚°/ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°ãŒè¦‹ãŸãã¦æœ‰ä¼‘ã¨ã£ãŸã‚ã€ã€Œã©ã£ã¡ãŒå‹ã£ã¦ã‚‚ã„ã„ã‹ã‚‰ç†±ã„è©¦åˆã‚’è¦‹ã›ã¦ãã‚Œã€
`;
    }
    
    // --- 3. AIã¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (â˜…æ–°æƒ…å ±è¿½åŠ ç‰ˆ) ---
    const prompt = `
${personaInstructions}

### è©¦åˆæƒ…å ±
- **å¿œæ´ã™ã‚‹ãƒãƒ¼ãƒ :** ${teamName} (ãƒ©ãƒ³ã‚¯: ${teamRank})
- **å¯¾æˆ¦ç›¸æ‰‹:** ${opponentName} (ãƒ©ãƒ³ã‚¯: ${opponentRank})
- **ãƒ©ã‚¦ãƒ³ãƒ‰:** ${roundName}
- **è©¦åˆä¼šå ´:** ${schedule || 'æœªå®š'}
${rivalry ? `- **${rivalry}**` : ''}

### å‚è€ƒæƒ…å ±ï¼šå¿œæ´ã™ã‚‹ãƒãƒ¼ãƒ ã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿
- **ãƒãƒ¼ãƒ ã®èƒŒæ™¯(info):** ${teamInfo || 'ç‰¹ã«ãªã—'}
- **ä»Šå¤§ä¼šã®è»Œè·¡:** ${tournamentPath || 'ä»Šå¤§ä¼šåˆæˆ¦'}
- **æ³¨ç›®é¸æ‰‹ (é™çš„):** ${detailedData ? detailedData.players.map(p => p.name).join(', ') : 'æƒ…å ±ãªã—'}
- **ä»Šå¤§ä¼šã®é¸æ‰‹æˆç¸¾å±¥æ­´ (Gamelog):**
${playerGamelogs || 'ä»Šå¤§ä¼šã®è©¦åˆå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}

### æŒ‡ç¤º
1.  **ãƒšãƒ«ã‚½ãƒŠã«ãªã‚Šãã‚‹:** ä¸Šè¨˜ã®ãƒšãƒ«ã‚½ãƒŠï¼ˆOBã€åœ¨æ ¡ç”Ÿã€åœ°å…ƒãƒ•ã‚¡ãƒ³ã€å®¶æ—ã€ç„¡é–¢ä¿‚ã®ãƒ•ã‚¡ãƒ³ç­‰ï¼‰ã«å®Œå…¨ã«ãªã‚Šãã‚Šã€ãã®ç«‹å ´ã‹ã‚‰ã®å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
2.  **æ–‡è„ˆã‚’åæ˜ :** è©¦åˆæƒ…å ±ï¼ˆç›¸æ‰‹ãŒæ ¼ä¸Šã‹ã€æ­´å²çš„ãªå¿«é€²æ’ƒã‹ã€æ³¨ç›®é¸æ‰‹ã¯èª°ã‹ï¼‰ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«åæ˜ ã•ã›ã¦ãã ã•ã„ã€‚
3.  **â˜…ã€æœ€é‡è¦ã€‘èƒŒæ™¯(info)ã®æ´»ç”¨:** ã€Œãƒãƒ¼ãƒ ã®èƒŒæ™¯(info)ã€ã‚’ç†Ÿèª­ã—ã¦ãã ã•ã„ã€‚
    - ï¼ˆä¾‹ï¼šã‚‚ã—ã€Œå·æ ¹ã€ãªã‚‰ã€Œæœ€å¾Œã®å¤ã€ã‚„ã€Œé–‰æ ¡ã€ã«è§¦ã‚Œã‚‹ï¼‰
    - ï¼ˆä¾‹ï¼šã‚‚ã—ã€Œæµœæ¾ç‰¹æ”¯ã€ãªã‚‰ã€Œå‰µéƒ¨ä¸€å¹´ç›®ã€ã€Œ52-0ã®å¤§æ•—ã€ã®è¨˜æ†¶ã«è§¦ã‚Œã‚‹ï¼‰
    - ï¼ˆä¾‹ï¼šã‚‚ã—ã€Œ283å­¦åœ’ã€ãªã‚‰ã€Œç‹è€…ã¨ã—ã¦ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã€ã«è§¦ã‚Œã‚‹ï¼‰
    - ï¼ˆä¾‹ï¼šã‚‚ã—ã€Œä»Šå¤§ä¼šã®ãƒãƒ¼ãƒ æ‰“ç‡ã¯.350ã€ã¨ã‚ã‚Œã°ã€ã€Œæ‰“ç·šå¥½èª¿ï¼ã€ã«è§¦ã‚Œã‚‹ï¼‰
    - ã“ã®èƒŒæ™¯æƒ…å ±ã«åŸºã¥ã„ãŸã€**å…·ä½“çš„ã§è§£åƒåº¦ã®é«˜ã„**ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¿…ãšç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
4.  **â˜…ã€é‡è¦ã€‘Gamelogã®æ´»ç”¨:** ã€Œé¸æ‰‹æˆç¸¾å±¥æ­´(Gamelog)ã€ã‚’èª­ã¿ã€å…·ä½“çš„ãªé¸æ‰‹ã®**å¥½ä¸èª¿ã®æ³¢**ã«ã‚‚è¨€åŠã—ã¦ãã ã•ã„ã€‚
    - ï¼ˆä¾‹ï¼šã€Œã€‡ã€‡ãã‚“ã€1å›æˆ¦ã¯3ã‚¿ã‚³ã ã£ãŸã‘ã©ã€2å›æˆ¦ã¯ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³ï¼ä»Šæ—¥ãŒå¤§äº‹ã ãï¼ã€ï¼‰
    - ï¼ˆä¾‹ï¼šã€Œã‚¨ãƒ¼ã‚¹ã®â–³â–³ã€å‰å›ç™»æ¿ã¯ä¸­1æ—¥ã ã£ãŸã‹ã‚‰å¿ƒé…ã—ã¦ãŸã‚“ã â€¦ä»Šæ—¥ã¯é ¼ã‚€ï¼ã€ï¼‰
5.  **â˜…è©¦åˆä¼šå ´ã¨å› ç¸:** ã‚‚ã—è©¦åˆãŒã€Œè‰è–™çƒå ´ã€ãªã©**åœ°å…ƒé–‹å‚¬**ã§ã‚ã£ãŸã‚Šã€ã€Œå› ç¸ã®å¯¾æ±ºã€ã§ã‚ã£ãŸã‚Šã™ã‚‹å ´åˆã€ãã®ç‚¹ã«ã‚‚è¨€åŠã—ã¦æœŸå¾…æ„Ÿã‚’é«˜ã‚ã¦ãã ã•ã„ã€‚
6.  **å‰µä½œã‚’è¨±å¯:** é¸æ‰‹ã‚„ç›£ç£ã¨ã®ï¼ˆæ¶ç©ºã®ï¼‰å€‹äººçš„ãªæ€ã„å‡ºã‚„ã€éå»ã®æ­´å²ï¼ˆä¾‹ï¼š40å¹´å‰ã®åˆå‹åˆ©ï¼‰ã‚’**è‡ªç”±ã«å‰µä½œã—ã¦**ã€ã‚³ãƒ¡ãƒ³ãƒˆã«æ·±ã¿ã‚’ä¸ãˆã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼ã€å³å®ˆã€‘
å¿…ãšä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼"ã®ã¿"ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
[
    {"personality": "ï¼ˆä¾‹ï¼šã€‡ã€‡é«˜æ ¡OBï¼‰", "comment": "ï¼ˆç”Ÿæˆã—ãŸã‚³ãƒ¡ãƒ³ãƒˆ1ï¼‰"},
    {"personality": "ï¼ˆä¾‹ï¼šåœ¨æ ¡ç”Ÿï¼‰", "comment": "ï¼ˆç”Ÿæˆã—ãŸã‚³ãƒ¡ãƒ³ãƒˆ2ï¼‰"},
    {"personality": "ï¼ˆä¾‹ï¼šåœ°å…ƒã®ãƒ•ã‚¡ãƒ³ï¼‰", "comment": "ï¼ˆç”Ÿæˆã—ãŸã‚³ãƒ¡ãƒ³ãƒˆ3ï¼‰"}
    // ... (æŒ‡å®šã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆæ•°ã ã‘ç¶šã‘ã‚‹) ...
]
`;

    // --- 4. AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (å¤‰æ›´ãªã—) ---
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const commentsJson = parseJsonFromText(rawText);
            if (Array.isArray(commentsJson)) {
                return commentsJson;
            }
        }
        throw new Error("AI response format error (PreGameComments).");
    } catch (error) {
        console.error("AIå¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return [{ personality: "ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼", comment: "å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ..." }];
    }
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
// â–²â–²â–² è²¼ã‚Šä»˜ã‘ã¯ã“ã“ã¾ã§ â–²â–²
// â–²â–²â–² è²¼ã‚Šä»˜ã‘ã¯ã“ã“ã¾ã§ â–²â–²

// â–¼â–¼â–¼ å¤§ä¼šè¡¨å½°å¼ (Awards) æ©Ÿèƒ½ â–¼â–¼â–¼

document.getElementById('show-awards-btn').addEventListener('click', () => {
    renderAwardsModal();
    document.getElementById('awards-modal').classList.remove('hidden');
    document.getElementById('awards-modal').classList.add('flex');
});

document.getElementById('awards-modal-close-btn').addEventListener('click', () => {
    document.getElementById('awards-modal').classList.add('hidden');
    document.getElementById('awards-modal').classList.remove('flex');
});

/**
 * [FIXED] è¡¨å½°å¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æç”»ã™ã‚‹ (å¤§ä¼šMVPé¸å‡ºæ©Ÿèƒ½ã‚’è¿½åŠ )
 */
function renderAwardsModal() {
    const contentEl = document.getElementById('awards-content');
    contentEl.innerHTML = '<div class="loader text-center py-16">å…¨é¸æ‰‹ã®è¨˜éŒ²ã‚’é›†è¨ˆä¸­...</div>';

    // --- 1. ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ ---
    const allBatters = [];
    const allPitchers = [];

    Object.keys(tournamentState.teamRecords).forEach(teamName => {
        const record = tournamentState.teamRecords[teamName];
        if (!record.playerStats) return;
        
        // æ‰“è€…é›†è¨ˆ
        if (record.playerStats.batting) {
            Object.entries(record.playerStats.batting).forEach(([name, s]) => {
                if ((s.pa || 0) > 0) {
                    const ops = parseFloat(calculateOps(s));
                    const h = s.h||0; const bb=(s.bb||0)+(s.hbp||0); const ab=s.ab||0;
                    const tb = (s.tb||h) + (s.hr||0)*3;
                    const times = ab + bb;
                    let rc = times > 0 ? ((h + bb) * tb) / times : 0;
                    
                    allBatters.push({
                        name, team: teamName, stats: s,
                        avg: s.ab > 0 ? s.h / s.ab : 0,
                        ops: ops, rc: rc,
                        pos: s.pos || 'æŒ‡', games: s.games || 0
                    });
                }
            });
        }

        // æŠ•æ‰‹é›†è¨ˆ
        if (record.playerStats.pitching) {
            Object.entries(record.playerStats.pitching).forEach(([name, p]) => {
                const s = p.career;
                if (s && s.ip > 0) {
                    allPitchers.push({
                        name, team: teamName, stats: s,
                        era: s.er * 9 / s.ip,
                        so: s.so || 0, w: s.w || 0, ip: s.ip
                    });
                }
            });
        }
    });

    const tournamentMaxGames = allBatters.reduce((max, p) => Math.max(max, p.games), 0) || 1;
    const minPa = Math.max(10, tournamentMaxGames * 2); // è¦å®šæ‰“å¸­
    const minIp = Math.max(5, tournamentMaxGames * 0.5); // è¦å®šæŠ•çƒå›

    // --- 2. â˜…â˜…â˜… å¤§ä¼šMVPé¸å‡º (æ–°è¦è¿½åŠ ) â˜…â˜…â˜… ---
    let mvpData = null;
    const finalMatch = tournamentState.matches['F-R1-M1'];
    const championTeam = finalMatch?.winner; // å„ªå‹ãƒãƒ¼ãƒ 

    if (championTeam) {
        // å„ªå‹ãƒãƒ¼ãƒ ã®é¸æ‰‹ã‚’æŠ½å‡º
        const champBatters = allBatters.filter(p => p.team === championTeam);
        const champPitchers = allPitchers.filter(p => p.team === championTeam);

        // æŠ•æ‰‹MVPå€™è£œ (å‹åˆ©æ•° > é˜²å¾¡ç‡ > æŠ•çƒå›)
        const bestChampPitcher = champPitchers.sort((a, b) => {
            if (b.stats.w !== a.stats.w) return b.stats.w - a.stats.w;
            return a.era - b.era;
        })[0];

        // æ‰“è€…MVPå€™è£œ (RC > OPS)
        const bestChampBatter = champBatters.sort((a, b) => b.rc - a.rc)[0];

        // æŠ•æ‰“ã®æ¯”è¼ƒ (æŠ•æ‰‹ãŒ3å‹ä»¥ä¸Šã¾ãŸã¯é˜²å¾¡ç‡1ç‚¹å°ãªã‚‰æŠ•æ‰‹ã‚’å„ªå…ˆã€ãã‚Œä»¥å¤–ã¯æ‰“è€…)
        if (bestChampPitcher && (bestChampPitcher.stats.w >= 3 || bestChampPitcher.era < 2.00)) {
            mvpData = {
                type: 'æŠ•æ‰‹',
                name: bestChampPitcher.name,
                team: bestChampPitcher.team,
                desc: `${bestChampPitcher.stats.w}å‹ é˜²å¾¡ç‡${bestChampPitcher.era.toFixed(2)} ${bestChampPitcher.stats.so}å¥ªä¸‰æŒ¯`,
                detail: `ã‚¨ãƒ¼ã‚¹ã¨ã—ã¦ãƒãƒ¼ãƒ ã‚’å„ªå‹ã«å°ã„ãŸã€‚`
            };
        } else if (bestChampBatter) {
            mvpData = {
                type: 'é‡æ‰‹',
                name: bestChampBatter.name,
                team: bestChampBatter.team,
                desc: `æ‰“ç‡${bestChampBatter.avg.toFixed(3)} ${bestChampBatter.stats.hr}æœ¬å¡æ‰“ ${bestChampBatter.stats.rbi}æ‰“ç‚¹`,
                detail: `åœ§å€’çš„ãªæ‰“æ£’ã§ãƒãƒ¼ãƒ ã®å‹åˆ©ã«è²¢çŒ®ã—ãŸã€‚`
            };
        }
    } else {
        mvpData = { name: "???", team: "å„ªå‹æ±ºå®šå¾Œ", desc: "å¤§ä¼šçµ‚äº†å¾Œã«ç™ºè¡¨ã•ã‚Œã¾ã™", detail: "" };
    }
    // --- â˜…â˜…â˜… MVPé¸å‡ºã“ã“ã¾ã§ â˜…â˜…â˜… ---


    // --- 3. ã‚¿ã‚¤ãƒˆãƒ«ãƒ›ãƒ«ãƒ€ãƒ¼é¸å‡º ---
    const leadingHitters = allBatters.filter(p => p.stats.pa >= minPa).sort((a, b) => b.avg - a.avg).slice(0, 5);
    const homeRunKings = allBatters.sort((a, b) => (b.stats.hr || 0) - (a.stats.hr || 0)).slice(0, 5);
    const rbiKings = allBatters.sort((a, b) => (b.stats.rbi || 0) - (a.stats.rbi || 0)).slice(0, 5);
    const sbKings = allBatters.sort((a, b) => (b.stats.sb || 0) - (a.stats.sb || 0)).slice(0, 5);
    const eraLeaders = allPitchers.filter(p => p.stats.ip >= minIp).sort((a, b) => a.era - b.era).slice(0, 5);
    const soLeaders = allPitchers.sort((a, b) => b.so - a.so).slice(0, 5);

    // --- 4. ãƒ™ã‚¹ãƒˆãƒŠã‚¤ãƒ³é¸å‡º ---
    const positions = ['æŠ•', 'æ•', 'ä¸€', 'äºŒ', 'ä¸‰', 'éŠ', 'å¤–'];
    const bestNine = {};

    const bestPitcher = allPitchers.filter(p => p.stats.ip >= minIp).sort((a, b) => {
        const scoreA = (10 - a.era) * 2 + (a.stats.w * 5) + (a.stats.so * 0.1);
        const scoreB = (10 - b.era) * 2 + (b.stats.w * 5) + (b.stats.so * 0.1);
        return scoreB - scoreA;
    })[0];
    bestNine['æŠ•'] = bestPitcher;

    positions.slice(1).forEach(pos => {
        const candidates = allBatters.filter(p => p.pos && p.pos.includes(pos) && p.stats.pa >= minPa);
        if (pos === 'å¤–') {
            bestNine['å¤–'] = candidates.sort((a, b) => b.rc - a.rc).slice(0, 3);
        } else {
            bestNine[pos] = candidates.sort((a, b) => b.ops - a.ops)[0];
        }
    });

    // --- 5. HTMLç”Ÿæˆ ---
    // (MVPã‚«ãƒ¼ãƒ‰ã®HTMLç”Ÿæˆ)
    const mvpHtml = `
        <div class="bg-gradient-to-r from-yellow-100 to-amber-200 p-6 rounded-lg shadow-lg border-2 border-amber-400 mb-8 text-center transform transition hover:scale-105 duration-300">
            <h4 class="text-2xl font-black text-amber-800 mb-2 flex justify-center items-center">
                <span class="text-3xl mr-2">ğŸ‘‘</span> å¤§ä¼šæœ€å„ªç§€é¸æ‰‹ (MVP) <span class="text-3xl ml-2">ğŸ‘‘</span>
            </h4>
            <div class="mt-4">
                <p class="text-3xl font-bold text-gray-900">${mvpData.name} <span class="text-lg font-normal text-gray-700">(${mvpData.team})</span></p>
                <p class="text-xl font-bold text-blue-800 mt-2">${mvpData.desc}</p>
                <p class="text-sm text-gray-600 mt-2 italic">"${mvpData.detail}"</p>
            </div>
        </div>
    `;

    const createRankingTable = (title, list, metricLabel, metricKey, isRate = false) => `
        <div class="bg-white p-4 rounded shadow mb-4 border-t-4 border-blue-500">
            <h4 class="font-bold text-gray-700 border-b pb-2 mb-2 flex justify-between">
                ${title} <span class="text-xs font-normal text-gray-500 self-end">${metricLabel}</span>
            </h4>
            <table class="w-full text-sm">
                ${list.map((p, i) => {
                    let val = isRate ? (p[metricKey]).toFixed(3) : (metricKey.split('.').reduce((o, k) => o?.[k], p) || 0);
                    if (title === "æœ€å„ªç§€é˜²å¾¡ç‡") val = p.era.toFixed(2);
                    return `
                    <tr class="${i===0 ? 'font-bold bg-yellow-50' : ''}">
                        <td class="w-6 text-center">${i+1}</td>
                        <td>${p.name} <span class="text-xs text-gray-500">(${p.team})</span></td>
                        <td class="text-right font-mono">${val}</td>
                    </tr>`;
                }).join('')}
            </table>
        </div>
    `;

    const createBestNineCard = (pos, player) => {
        if (!player) return `<div class="p-2 border rounded bg-gray-50 text-center text-gray-400 mb-2">${pos}: è©²å½“ãªã—</div>`;
        if (Array.isArray(player)) return player.map(p => createBestNineCard(pos, p)).join('');
        
        const statText = (pos === 'æŠ•') 
            ? `é˜²${player.era.toFixed(2)}` 
            : `OPS${player.ops.toFixed(3)}`;

        return `
            <div class="p-2 border-l-4 border-amber-400 rounded bg-white shadow-sm flex justify-between items-center mb-2">
                <div class="flex items-center">
                    <span class="w-8 text-center text-xs font-bold text-amber-800 bg-amber-100 py-1 rounded mr-2">${pos}</span>
                    <div>
                        <p class="font-bold text-gray-800 text-sm">${player.name}</p>
                        <p class="text-xs text-gray-500">${player.team}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-bold text-blue-700 text-sm">${statText}</p>
                </div>
            </div>
        `;
    };

    let html = `
        ${mvpHtml}
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b-2 border-red-500 pb-1">âš¾ æ‰“æ’ƒéƒ¨é–€</h3>
                ${createRankingTable('é¦–ä½æ‰“è€…', leadingHitters, 'æ‰“ç‡', 'avg', true)}
                ${createRankingTable('æœ¬å¡æ‰“ç‹', homeRunKings, 'æœ¬å¡æ‰“', 'stats.hr')}
                ${createRankingTable('æ‰“ç‚¹ç‹', rbiKings, 'æ‰“ç‚¹', 'stats.rbi')}
                ${createRankingTable('ç›—å¡ç‹', sbKings, 'ç›—å¡', 'stats.sb')}
            </div>

            <div class="lg:col-span-1">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b-2 border-blue-500 pb-1">âš¾ æŠ•æ‰‹éƒ¨é–€</h3>
                ${createRankingTable('æœ€å„ªç§€é˜²å¾¡ç‡', eraLeaders, 'é˜²å¾¡ç‡', 'era', true)}
                ${createRankingTable('æœ€å¤šå¥ªä¸‰æŒ¯', soLeaders, 'å¥ªä¸‰æŒ¯', 'so')}
            </div>

            <div class="lg:col-span-1">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b-2 border-amber-500 pb-1">âœ¨ ãƒ™ã‚¹ãƒˆãƒŠã‚¤ãƒ³</h3>
                <div class="bg-gray-100 p-3 rounded-lg">
                    ${createBestNineCard('æŠ•', bestNine['æŠ•'])}
                    ${createBestNineCard('æ•', bestNine['æ•'])}
                    ${createBestNineCard('ä¸€', bestNine['ä¸€'])}
                    ${createBestNineCard('äºŒ', bestNine['äºŒ'])}
                    ${createBestNineCard('ä¸‰', bestNine['ä¸‰'])}
                    ${createBestNineCard('éŠ', bestNine['éŠ'])}
                    <div class="mt-4">
                        <p class="text-xs text-gray-500 mb-1 font-bold">å¤–é‡æ‰‹</p>
                        ${createBestNineCard('å¤–', bestNine['å¤–'])}
                    </div>
                </div>
            </div>
        </div>
    `;

    contentEl.innerHTML = html;
}

async function generateSnsPosts(matchContext) {
    const { winnerName, loserName, dbMatch, highlights } = matchContext;
    
    // â–¼â–¼â–¼ ä¿®æ­£: å‹è€…ã®ã‚¹ã‚³ã‚¢ã‚’åˆ¤å®šã—ã¦å…ˆã«è¡¨ç¤ºã™ã‚‹ â–¼â–¼â–¼
    const score1 = parseInt(dbMatch.score1) || 0;
    const score2 = parseInt(dbMatch.score2) || 0;
    
    const winnerScore = (dbMatch.team1 === winnerName) ? score1 : score2;
    const loserScore = (dbMatch.team1 === winnerName) ? score2 : score1;
    
    // AIã«æ¸¡ã™ã‚¹ã‚³ã‚¢æ–‡å­—åˆ—ã‚’ã€Œå‹è€… - æ•—è€…ã€ã®é †ã«ã™ã‚‹ (ä¾‹: "7-0")
    const scoreString = `${winnerScore}-${loserScore}`;
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    
    // ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ¯ãƒ¼ãƒ‰å€™è£œã®é¸å®š
    let trendCandidates = [`#${winnerName}`, `#é«˜æ ¡é‡çƒ`, `#${loserName}`];
    
    if (matchContext.highlights.some(h => h.description.includes("ã‚µãƒ¨ãƒŠãƒ©"))) trendCandidates.unshift("ã‚µãƒ¨ãƒŠãƒ©");
    if (matchContext.highlights.some(h => h.description.includes("é€†è»¢"))) trendCandidates.unshift("é€†è»¢å‹åˆ©");
    if (parseInt(dbMatch.score1) + parseInt(dbMatch.score2) >= 15) trendCandidates.unshift("ä¹±æ‰“æˆ¦");
    if (winnerScore > 0 && loserScore === 0) trendCandidates.unshift("å®Œå°"); // å®Œå°åˆ¤å®šã‚‚ä¿®æ­£
    
    if (matchContext.keyPlayerNames && matchContext.keyPlayerNames.length > 0) {
        trendCandidates.unshift(matchContext.keyPlayerNames[0]); 
    }

    const primaryTrend = trendCandidates[0];

    const prompt = `ã‚ãªãŸã¯Xï¼ˆæ—§Twitterï¼‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ã€‚
é«˜æ ¡é‡çƒã®è©¦åˆã€Œ${winnerName} vs ${loserName}ã€ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚
**çµæœ: ${winnerName}ã®å‹åˆ© (${scoreString})**

ä»¥ä¸‹ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å…ƒã«ã€ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«æµã‚Œã‚‹**ãƒªã‚¢ãƒ«ãªçŸ­æ–‡ãƒã‚¹ãƒˆï¼ˆãƒ„ã‚¤ãƒ¼ãƒˆï¼‰ã‚’10å€‹**ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### è©¦åˆãƒã‚¤ãƒ©ã‚¤ãƒˆ
${highlights.map(h => h.description).join('\n')}

### ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ¯ãƒ¼ãƒ‰
${trendCandidates.join(', ')}

### åŸ·ç­†æŒ‡ç¤º
- **BBSï¼ˆãªã‚“Jï¼‰ã¨ã¯ç•°ãªã‚‹æ–‡ä½“**ã«ã—ã¦ãã ã•ã„ã€‚
- çµµæ–‡å­—ï¼ˆğŸ˜­, âœ¨, ğŸ”¥, âš¾ï¼‰ã‚’é©åº¦ã«ä½¿ã£ã¦ãã ã•ã„ã€‚
- ã€Œæ„Ÿå‹•ã—ãŸã€ã€Œæ¶™æ­¢ã¾ã‚‰ã‚“ã€ã€Œé³¥è‚ŒãŸã£ãŸã€ãªã©ã€æ„Ÿæƒ…çš„ãªæŠ•ç¨¿ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
- ã€Œ${winnerName}ãŠã‚ã§ã¨ã†ï¼ã€ã€Œ${loserName}ã‚‚ãŠç–²ã‚Œæ§˜ã€ã¨ã„ã£ãŸã€çˆ½ã‚„ã‹ãªæŠ•ç¨¿ã‚‚å«ã‚ã¦ãã ã•ã„ã€‚
- é©šãã®ãƒ—ãƒ¬ãƒ¼ã«ã¯ã€Œãˆãã„ã€ã€Œã‚„ã°ã™ãã€ã¨ã„ã£ãŸè‹¥è€…è¨€è‘‰ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
- å¿…ãšå…¨ã¦ã®ãƒã‚¹ãƒˆã«ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼ˆä¾‹: #${winnerName}, #é«˜æ ¡é‡çƒï¼‰ã‚’1ã¤ä»¥ä¸Šä»˜ã‘ã¦ãã ã•ã„ã€‚
- **${primaryTrend}** ã«ã¤ã„ã¦è¨€åŠã™ã‚‹ãƒã‚¹ãƒˆã‚’å¤šã‚ã«ã—ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼ (JSON)
[
    {"handle": "@baseball_love", "name": "é‡çƒå¢âš¾ï¸", "text": "ï¼ˆãƒã‚¹ãƒˆæœ¬æ–‡ï¼‰", "likes": 120, "rts": 45},
    {"handle": "@user1234", "name": "ä¸€èˆ¬äºº", "text": "ï¼ˆãƒã‚¹ãƒˆæœ¬æ–‡ï¼‰", "likes": 5, "rts": 0}
]`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const posts = parseJsonFromText(result.candidates[0].content.parts[0].text);
            return { posts, trends: trendCandidates.slice(0, 5) };
        }
        return null;
    } catch (error) {
        console.error("SNSç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
        return null;
    }
}

let currentSnsData = null; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ä¿æŒ

/**
 * SNSãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã‚’æç”»ã™ã‚‹ (å±¥æ­´å¯¾å¿œç‰ˆ)
 */
function renderSnsModalContent(tab = 'trend') {
    const container = document.getElementById('sns-content-area');
    container.innerHTML = '';

    // å±¥æ­´ãŒãªã„å ´åˆ
    if (!tournamentState.snsLogs || tournamentState.snsLogs.length === 0) {
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full text-gray-500">
                <span class="text-4xl mb-2">ğŸ“±</span>
                <p>ã¾ã SNSã®æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                <p class="text-sm mt-2">283å­¦åœ’ã®è©¦åˆå¾Œã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚</p>
            </div>`;
        return;
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€æœ€æ–°ã®ãƒ­ã‚°ã‚’ä½¿ç”¨
    if (!currentSnsData) {
        currentSnsData = tournamentState.snsLogs[0].data;
    }

    if (tab === 'trend') {
        // --- [ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¿ãƒ–]ï¼šéå»ãƒ­ã‚°ä¸€è¦§ï¼ˆç½®ãå ´ï¼‰ã‚’è¡¨ç¤º ---
        
        let historyHtml = `<div class="bg-gray-50 p-3 font-bold text-gray-500 text-xs border-b">ãƒˆãƒ¬ãƒ³ãƒ‰å±¥æ­´ (ã‚¿ãƒƒãƒ—ã§TLã‚’è¡¨ç¤º)</div>`;
        
        tournamentState.snsLogs.forEach((log, i) => {
            const timeStr = new Date(log.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const topTrend = log.data.trends[0];
            
            historyHtml += `
            <div class="sns-trend-item hover:bg-blue-50 transition-colors cursor-pointer" onclick="loadSnsLog('${log.id}')">
                <div class="flex justify-between items-start">
                    <div class="sns-trend-meta text-xs text-gray-400">${i + 1} Â· ${log.roundName} Â· ${timeStr}</div>
                    <span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">${log.score}</span>
                </div>
                <div class="sns-trend-word text-base font-bold text-gray-800 mt-1">${topTrend}</div>
                <div class="sns-trend-count text-xs text-gray-500 mt-1">${log.matchTitle}</div>
            </div>
            `;
        });
        container.innerHTML = historyHtml;

    } else {
        // --- [æœ€æ–°ã‚¿ãƒ–]ï¼šé¸æŠä¸­ã®è©¦åˆã®TLã‚’è¡¨ç¤º ---
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã©ã®è©¦åˆã®TLã‹è¡¨ç¤ºï¼‰
        const currentLog = tournamentState.snsLogs.find(l => l.data === currentSnsData) || tournamentState.snsLogs[0];
        const headerHtml = `
            <div class="p-3 bg-blue-50 border-b border-blue-100 flex justify-between items-center sticky top-0 z-10">
                <div>
                    <p class="text-xs font-bold text-blue-600">${currentLog.roundName}</p>
                    <p class="text-sm font-bold text-gray-800">${currentLog.matchTitle}</p>
                </div>
                <span class="text-xl font-bold text-blue-300">#</span>
            </div>
        `;
        
        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
        const postsHtml = document.createElement('div');
        renderTimeline(postsHtml, currentSnsData.posts);
        
        container.innerHTML = headerHtml;
        container.appendChild(postsHtml);
    }
}

/**
 * [NEW] å±¥æ­´ã‹ã‚‰ç‰¹å®šã®è©¦åˆã®SNSãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤ºã™ã‚‹
 */
window.loadSnsLog = function(matchId) {
    const log = tournamentState.snsLogs.find(l => l.id === matchId);
    if (log) {
        currentSnsData = log.data; // è¡¨ç¤ºãƒ‡ãƒ¼ã‚¿ã‚’åˆ‡ã‚Šæ›¿ãˆ
        switchSnsTab('timeline');  // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¿ãƒ–ã¸ç§»å‹•
    }
};

// --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ  (ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚) ---
document.body.addEventListener('click', (e) => {
    // SNSãƒœã‚¿ãƒ³ (ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ & ãƒ¡ã‚¤ãƒ³ç”»é¢)
    if (e.target.closest('#open-sns-btn') || e.target.closest('#open-sns-btn-main')) {
        const modal = document.getElementById('sns-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // æœ€æ–°ã®ãƒ­ã‚°ãŒã‚ã‚Œã°ãã‚Œã‚’ã‚»ãƒƒãƒˆ
        if (tournamentState.snsLogs && tournamentState.snsLogs.length > 0) {
            currentSnsData = tournamentState.snsLogs[0].data;
        }
        
        switchSnsTab('trend'); // æœ€åˆã¯ãƒˆãƒ¬ãƒ³ãƒ‰ä¸€è¦§ï¼ˆç½®ãå ´ï¼‰ã‚’è¡¨ç¤º
    }
});

function renderTimeline(container, posts) {
    posts.forEach(post => {
        const div = document.createElement('div');
        div.className = 'sns-post';
        div.innerHTML = `
            <div class="sns-avatar" style="background-color: hsl(${Math.random()*360}, 70%, 80%)"></div>
            <div class="sns-content">
                <div class="sns-user-info">
                    <span class="sns-name">${post.name}</span>
                    <span class="sns-handle">${post.handle}</span>
                    <span class="sns-time">Â· ${Math.floor(Math.random()*10 + 1)}åˆ†</span>
                </div>
                <div class="sns-text">${post.text.replace(/#(\S+)/g, '<span class="text-blue-500">#$1</span>')}</div>
                <div class="sns-actions">
                    <span class="sns-action-btn">ğŸ’¬ ${Math.floor(post.likes / 10)}</span>
                    <span class="sns-action-btn retweet"> ${post.rts}</span>
                    <span class="sns-action-btn like">â¤ï¸ ${post.likes}</span>
                    <span class="sns-action-btn">â¬†ï¸</span>
                </div>
            </div>
        `;
        container.appendChild(div);
    });
}

function switchSnsTab(tab) {
    const btnTrend = document.getElementById('sns-tab-trend');
    const btnTimeline = document.getElementById('sns-tab-timeline');
    
    if (tab === 'trend') {
        btnTrend.className = "flex-1 py-3 font-bold hover:bg-gray-100 border-b-4 border-blue-500 text-gray-900";
        btnTimeline.className = "flex-1 py-3 font-bold text-gray-500 hover:bg-gray-100";
    } else {
        btnTrend.className = "flex-1 py-3 font-bold text-gray-500 hover:bg-gray-100";
        btnTimeline.className = "flex-1 py-3 font-bold hover:bg-gray-100 border-b-4 border-blue-500 text-gray-900";
    }
    renderSnsModalContent(tab);
}

/**
 * [ä¿®æ­£ç‰ˆ] AIã«è©¦åˆçµæœã®æ²ç¤ºæ¿ã®åå¿œã‚’ç”Ÿæˆã•ã›ã‚‹
 * (â˜…ã€Œè»½å‚·ã€é¸æ‰‹ã¸ã®è¨€åŠæŒ‡ç¤ºã‚’å¼·åŒ–)
 */
async function generateBbsComments(matchContext) {
    const { 
        winnerName, loserName, dbMatch, matchId, 
        winnerData, loserData, winnerDynamicInfo, loserDynamicInfo,
        nextOpponent, winnerSeedRank, loserSeedRank,
        loserJourney, // â˜… æ•—è€…ã®è»Œè·¡
        injuryReport
    } = matchContext;
    
    const winnerScore = Math.max(parseInt(dbMatch.score1) || 0, parseInt(dbMatch.score2) || 0);
    const loserScore = Math.min(parseInt(dbMatch.score1) || 0, parseInt(dbMatch.score2) || 0);
    const winnerRankDesc = getRankDescription(calculateRank(winnerName, tournamentState));
    const loserRank = calculateRank(loserName, tournamentState);
    const loserRankDesc = getRankDescription(loserRank);
    
    const tournamentName = tournamentNameMap[tournamentState.currentTournament] || 'å¤§ä¼š';
    const tournamentYear = tournamentState.tournamentYear;
    let tournamentBbsContext = "";
    if (tournamentState.currentTournament === 'summer') {
        tournamentBbsContext = "3å¹´ç”Ÿã«ã¨ã£ã¦ã¯ã‚¬ãƒã§æœ€å¾Œã®å¤ã‚„ã€‚";
    } else if (tournamentState.currentTournament === 'autumn') {
        tournamentBbsContext = "æ–°ãƒãƒ¼ãƒ ã®åˆé™£ã‚„ãªã€‚ã“ã“ã§ã®çµæœãŒã‚»ãƒ³ãƒãƒ„é¸è€ƒã«éŸ¿ãã§ã€‚";
    } else if (tournamentState.currentTournament === 'spring') {
        tournamentBbsContext = "å¤ã®ã‚·ãƒ¼ãƒ‰æ¨©ãŒã‹ã‹ã£ãŸå‰å“¨æˆ¦ã‚„ã€‚";
    }

    const roundName = getRoundNameFromMatchId(matchId); 
    
    let nextOpponentText = 'æ¬¡ã®ç›¸æ‰‹ã¯æœªå®šã€‚'; 
    if (nextOpponent) {
        if (nextOpponent.opponentName === 'å„ªå‹') {
            nextOpponentText = (tournamentState.currentTournament === 'summer')
                ? 'å¤ã®ç”²å­åœ’å‡ºå ´æ±ºå®šï¼'
                : (tournamentState.currentTournament === 'autumn' ? 'ã‚»ãƒ³ãƒãƒ„å‡ºå ´ãŒæœ‰åŠ›ã¨ãªã£ãŸã€‚' : 'ä»Šå¤§ä¼šã€è¦‹äº‹å„ªå‹ã‚’æœãŸã—ãŸã€‚');
        }
        else if (nextOpponent.opponentName && nextOpponent.opponentName !== 'ï¼ˆæœªå®šï¼‰') {
            const nextOpponentSeed = getSeedRankString(nextOpponent.opponentName, tournamentState.seeds);
            const rankText = nextOpponent.opponentRank ? `(${nextOpponent.opponentRank}ãƒ©ãƒ³ã‚¯)` : '';
            nextOpponentText = `æ¬¡ã®${nextOpponent.roundName}ã§ã¯ã€${nextOpponent.opponentName}${nextOpponentSeed}${rankText}ã¨å¯¾æˆ¦ã™ã‚‹ã€‚`;
        } 
        else if (nextOpponent.decidingMatch) {
            const dm = nextOpponent.decidingMatch;
            const team1Seed = getSeedRankString(dm.team1, tournamentState.seeds);
            const team2Seed = getSeedRankString(dm.team2, tournamentState.seeds);
            nextOpponentText = `æ¬¡ã®${nextOpponent.roundName}ã§ã¯ã€${dm.team1}${team1Seed}(${dm.rank1}ãƒ©ãƒ³ã‚¯)ã¨${dm.team2}${team2Seed}(${dm.rank2}ãƒ©ãƒ³ã‚¯)ã®å‹è€…ã¨å¯¾æˆ¦ã™ã‚‹ã€‚`;
        }
    }
    const calledGameText = matchContext.calledGame ? `\n- **ç‰¹è¨˜äº‹é …:** ${matchContext.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ` : '';
    const rivalryText = matchContext.rivalryType ? `\n- **ç‰¹è¨˜äº‹é …:** ã“ã®è©¦åˆã¯ã€Œ${matchContext.rivalryType}ã€ã¨ã„ã†ç‰¹åˆ¥ãªå› ç¸ã®å¯¾æ±ºã§ã—ãŸã€‚` : '';
    let scheduleText = '';
    if (matchContext.schedule) {
        const sched = matchContext.schedule;
        const team1Region = TEAM_DATA[dbMatch.team1]?.region || 'ä¸æ˜';
        const team2Region = TEAM_DATA[dbMatch.team2]?.region || 'ä¸æ˜';
        scheduleText = `\n- **è©¦åˆä¼šå ´:** ${sched.stadiumFull} (${sched.region}åœ°åŒº)\n`;
        if (sched.region === team1Region && sched.region !== team2Region) { scheduleText += `- **åœ°ã®åˆ©:** ${dbMatch.team1}ã«ã¨ã£ã¦åœ°å…ƒçƒå ´ã§ã®è©¦åˆã¨ãªã£ãŸã€‚\n`; }
        else if (sched.region !== team1Region && sched.region === team2Region) { scheduleText += `- **åœ°ã®åˆ©:** ${dbMatch.team2}ã«ã¨ã£ã¦åœ°å…ƒçƒå ´ã§ã®è©¦åˆã¨ãªã£ãŸã€‚\n`; }
    }
    let atmosphereText = '';
    if (matchContext.atmosphere_team1 || matchContext.atmosphere_team2) {
        atmosphereText = '\n--- ### **å‚è€ƒæƒ…å ±ï¼šè©¦åˆå‰ã®é›°å›²æ°—ãƒ»å…¬ç´„**\n';
        if (matchContext.atmosphere_team1) atmosphereText += `- ${dbMatch.team1}: ${matchContext.atmosphere_team1}\n`;
        if (matchContext.atmosphere_team2) atmosphereText += `- ${dbMatch.team2}: ${matchContext.atmosphere_team2}\n`;
    }
    let ballQualityText = '';
    if (matchContext.team1BallQuality && matchContext.team2BallQuality) {
        ballQualityText = `\n--- ### **å‚è€ƒæƒ…å ±ï¼šãƒãƒ¼ãƒ åˆ¥ æ‰“çƒå“è³ª**\n- ${matchContext.team1BallQuality}\n- ${matchContext.team2BallQuality}\n`;
    }

    let cinderellaPraiseInstruction = "";
    const idParts = matchId.split('-');
    let roundNum = 0;
    if (idParts[0] !== 'F' && idParts[1] && idParts[1].startsWith('R')) {
        roundNum = parseInt(idParts[1].slice(1));
    }
    if ( (loserRank === 'E' && roundNum >= 3) ||
         (loserRank === 'D' && roundNum >= 4) ||
         (loserRank === 'C' && roundNum >= 5) )
    {
        cinderellaPraiseInstruction = `
- **ã€â˜…å¿«é€²æ’ƒã¸ã®è¨€åŠã€‘**: æ•—åŒ—ã—ãŸ${loserName}ã¯${loserRankDesc}(${loserRank}ãƒ©ãƒ³ã‚¯)ã ã£ãŸãŒã€${roundName}ã¾ã§å‹ã¡ä¸ŠãŒã£ãŸã€‚ã“ã®ã€Œå¿«é€²æ’ƒã€ã‚’**ã€Œ${loserName}ã€ã‚ˆã†ã‚„ã£ã¨ã‚‹ã€ã€Œæ¥å¹´ãŒæ¥½ã—ã¿ãªãƒãƒ¼ãƒ ã€**ã®ã‚ˆã†ã«ã€å¿…ãšç§°è³›ã™ã‚‹ã“ã¨ã€‚`;
    }

    let prompt; 

    if (dbMatch.details) {
        // (Aãƒ«ãƒ¼ãƒˆï¼šè©³ç´°å…¥åŠ›ã‚ã‚Š)
        const { highlights } = createHighlightsText(dbMatch, winnerName);
        const highlightsText = highlights.map(fact => `- ${fact.inning || ''}å› ${fact.team || ''} ${fact.player || ''}: ${fact.description}`).join('\n');
        
        prompt = `ã‚ãªãŸã¯ã€åŒ¿åæ²ç¤ºæ¿ã«é›†ã†ã€æ§˜ã€…ãªç«‹å ´ã®é«˜æ ¡é‡çƒãƒ•ã‚¡ãƒ³ã§ã™ã€‚
ä»¥ä¸‹ã®è©¦åˆçµæœã¨è©³ç´°ãªãƒã‚¤ãƒ©ã‚¤ãƒˆã«åŸºã¥ãã€å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ãªã‚Šãã£ã¦ã€è¾›è¾£ã§ãƒªã‚¢ãƒ«ãªçŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’10ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
---
### **å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰**
${PREFECTURE_LORE}
---
### è©¦åˆæƒ…å ±
- **å¤§ä¼š:** ${tournamentYear}å¹´åº¦ ${tournamentName} (${tournamentBbsContext})
- **ãƒ©ã‚¦ãƒ³ãƒ‰:** ${roundName}
- **å‹åˆ©ãƒãƒ¼ãƒ **: ${winnerName} ${winnerSeedRank} (${winnerRankDesc})
- **æ•—åŒ—ãƒãƒ¼ãƒ **: ${loserName} ${loserSeedRank} (${loserRankDesc})
- **ã‚¹ã‚³ã‚¢**: ${winnerScore} - ${loserScore}
${calledGameText} 
${rivalryText}
${injuryReport || ''}
### æ¬¡ã®è©¦åˆæƒ…å ±
- **${winnerName}ã®æ¬¡ã®è©¦åˆ**: ${nextOpponentText}
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹: ${dbMatch.summary || 'ç‰¹ã«ãªã—'}
${ballQualityText} 
### è©¦åˆã®ä¸»ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
${highlightsText}
### ä»Šå¤§ä¼šã®ä¸»ãªæŠ•æ‰‹ç™»æ¿å±¥æ­´ (ã“ã®è©¦åˆã‚ˆã‚Šå‰)
${matchContext.pitcherGamelogInfo || 'ä»Šå¤§ä¼šã€ã“ã‚ŒãŒåˆç™»æ¿ã§ã™ã€‚'}
### ä»Šå¤§ä¼šã®ä¸»ãªæ‰“è€…æˆç¸¾å±¥æ­´ (ã“ã®è©¦åˆã‚ˆã‚Šå‰)
${matchContext.batterGamelogInfo || 'æ‰“è€…ã®è©¦åˆå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}
### ãƒãƒ¼ãƒ ã®èƒŒæ™¯ (â˜…ãƒãƒ¼ãƒ æ‰“ç‡ãƒ»é€šç®—ç›—å¡å«ã‚€)
- **${winnerName} ${winnerSeedRank}**: ${winnerDynamicInfo}
- **${loserName} ${loserSeedRank}**: ${loserDynamicInfo}
  - **è»Œè·¡**: ${loserJourney}

### ã‚ãªãŸãŒãªã‚Šãã‚‹ã¹ãã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨æŒ‡ç¤º
- **ã€â˜…å¤§ä¼šã®æ–‡è„ˆã‚’åæ˜ ã€‘**: ${tournamentName}ãªã‚‰ã§ã¯ã®è¦–ç‚¹ï¼ˆä¾‹ï¼šã€Œå¤ã¯3å¹´ç”Ÿæœ€å¾Œã‚„ãªã€ã€Œç§‹ã®æ–°ãƒãƒ¼ãƒ ã®ä»•ä¸ŠãŒã‚Šè¦‹ãˆã¦ããŸãªã€ï¼‰ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã‚‹ã“ã¨ã€‚
- **ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘**: **ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã•ã™ãŒã‚„ãªã€ã€Œç¬¬5ã‚·ãƒ¼ãƒ‰ãŒè² ã‘ãŸãƒ³ã‚´wwwã€**ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚å…·ä½“çš„ã«è¨€åŠã—ã¦ãã ã•ã„ã€‚
- **ã€â˜…â˜…æ¬ å ´è€…ã¸ã®è¨€åŠ (æœ€é‡è¦)ã€‘**: ã‚‚ã—ã€Œä¸»ãªæ¬ å ´è€…ã€ã«é¸æ‰‹åï¼ˆä¾‹ï¼šã€‡ã€‡ [ğŸ¥], â–³â–³ [ğŸ©¹]ï¼‰ãŒã‚ã‚‹å ´åˆã€ãã®ä¸»åŠ›ãŒæ¬ å ´ã—ãŸã“ã¨ãŒè©¦åˆã«ã©ã†å½±éŸ¿ã—ãŸã‹ï¼ˆä¾‹ï¼šã€Œã‚¨ãƒ¼ã‚¹å§«å·[ğŸ¥]æŠœãã§ã‚ˆãå‹ã£ãŸã‚ã€ã€Œã€‡ã€‡ãŒ[ğŸ©¹]ã§ã„ãªã„ã®ãŒéŸ¿ã„ãŸãªã€ï¼‰ã‚’**å¿…ãšè¨˜äº‹ã«å«ã‚ã¦ãã ã•ã„ã€‚**
${cinderellaPraiseInstruction}
- **ã€â˜…ç™»æ¿å±¥æ­´ã¸ã®è¨€åŠã€‘**: ã€Œä»Šå¤§ä¼šã®ä¸»ãªæŠ•æ‰‹ç™»æ¿å±¥æ­´ã€ã«æƒ…å ±ãŒã‚ã‚‹å ´åˆã€**ã€Œã€‡ã€‡ã€é€£æŠ•ã˜ã‚ƒã‚“ã€**ã®ã‚ˆã†ã«ã€ç™»æ¿å±¥æ­´ã‚’è¸ã¾ãˆãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’ã™ã‚‹ã“ã¨ã€‚
- **ã€â˜…ä»Šå¤§ä¼šã®æˆç¸¾ (æœ€é‡è¦)ã€‘**: ã€Œãƒãƒ¼ãƒ ã®èƒŒæ™¯ã€ã«ã‚ã‚‹ã€ä»Šå¤§ä¼šã®ãƒãƒ¼ãƒ æ‰“ç‡ã¯.XXXã€ã¨ã„ã†æƒ…å ±ã‚’**å¿…ãšã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚**ã€ãƒãƒ¼ãƒ ã®å¥½èª¿ãƒ»ä¸æŒ¯ã«ã‚‚è¨€åŠã—ã¦ãã ã•ã„ã€‚
- **ã€â˜…ç›—å¡ã¸ã®è¨€åŠ (é‡è¦)ã€‘**: ã€Œãƒã‚¤ãƒ©ã‚¤ãƒˆã€ã‚„ã€Œãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ã€ã«**ç›—å¡**ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ãŸã‚‰ã€ãã®é¸æ‰‹ã®è¶³ï¼ˆæ©Ÿå‹•åŠ›ï¼‰ã‚’è¤’ã‚ã‚‹ã“ã¨ã€‚
- **ã€â˜…æ³¨ç›®ã®æ‰“å¸­ï¼ˆæœ€é‡è¦ï¼‰ã€‘**: ã€Œè©¦åˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã€ã«ã€Œï¼ˆâ˜…æ³¨ç›®ï¼‰ã€ãƒãƒ¼ã‚¯ãŒä»˜ã„ã¦ã„ã‚‹æ‰“å¸­ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚ŒãŒ**è©¦åˆã®ã‚¿ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆ**ã§ã™ã€‚ãã®æ‰“å¸­ãŒæ±ºå®šçš„ãªç¬é–“ã§ã‚ã£ãŸã¨ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚
- **ã€æ¬¡æˆ¦ã¸ã®è¨€åŠã€‘**: å‹è€…ãƒãƒ¼ãƒ ã®ã€Œæ¬¡ã®è©¦åˆæƒ…å ±ã€ï¼ˆ${nextOpponentText}ï¼‰ã«è§¦ã‚Œã€ã€Œæ¬¡ã¯ã€‡ã€‡ã‹â€¦ã€ã¨ã„ã£ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ã€‚`;

    } else {
        // (Bãƒ«ãƒ¼ãƒˆï¼šè©³ç´°å…¥åŠ›ãªã—)
        prompt = `ã‚ãªãŸã¯ã€åŒ¿åæ²ç¤ºæ¿ã«é›†ã†ã€æ§˜ã€…ãªç«‹å ´ã®é«˜æ ¡é‡çƒãƒ•ã‚¡ãƒ³ã§ã™ã€‚
ä»¥ä¸‹ã®è©¦åˆçµæœã«ã¤ã„ã¦ã€ãã‚Œãã‚Œã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ãªã‚Šãã£ã¦ã€è¾›è¾£ã§ãƒªã‚¢ãƒ«ãªçŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’10ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
---
### **å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰**
${PREFECTURE_LORE}
---
### è©¦åˆæƒ…å ±
- **å¤§ä¼š:** ${tournamentYear}å¹´åº¦ ${tournamentName} (${tournamentBbsContext})
- **ãƒ©ã‚¦ãƒ³ãƒ‰:** ${roundName} 
- **å‹åˆ©ãƒãƒ¼ãƒ **: ${winnerName} ${winnerSeedRank} (${winnerRankDesc})
- **æ•—åŒ—ãƒãƒ¼ãƒ **: ${loserName} ${loserSeedRank} (${loserRankDesc})
- **ã‚¹ã‚³ã‚¢**: ${winnerScore} - ${loserScore}
${calledGameText} 
${rivalryText} 
${injuryReport || ''}
### æ¬¡ã®è©¦åˆæƒ…å ±
- **${winnerName}ã®æ¬¡ã®è©¦åˆ**: ${nextOpponentText}
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªã‚‹è©¦åˆã®æ±ºã‚æ‰‹: ${dbMatch.summary || 'ãªã—'}
### ãƒãƒ¼ãƒ ã®èƒŒæ™¯ (â˜…ãƒãƒ¼ãƒ æ‰“ç‡ãƒ»é€šç®—ç›—å¡å«ã‚€)
- **${winnerName} ${winnerSeedRank}**: ${winnerDynamicInfo}
- **${loserName} ${loserSeedRank}**: ${loserDynamicInfo}
  - **è»Œè·¡**: ${loserJourney}

### ã‚ãªãŸãŒãªã‚Šãã‚‹ã¹ãã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨æŒ‡ç¤º
- **ã€â˜…å¤§ä¼šã®æ–‡è„ˆã‚’åæ˜ ã€‘**: ${tournamentName}ãªã‚‰ã§ã¯ã®è¦–ç‚¹ï¼ˆä¾‹ï¼šã€Œå¤ã¯3å¹´ç”Ÿæœ€å¾Œã‚„ãªã€ã€Œç§‹ã®æ–°ãƒãƒ¼ãƒ ã®ä»•ä¸ŠãŒã‚Šè¦‹ãˆã¦ããŸãªã€ï¼‰ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã‚‹ã“ã¨ã€‚
- **ã€â˜…ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯è¨€åŠã€‘**: **ã€Œç¬¬1ã‚·ãƒ¼ãƒ‰ã•ã™ãŒã‚„ãªã€ã€Œç¬¬5ã‚·ãƒ¼ãƒ‰ãŒè² ã‘ãŸãƒ³ã‚´wwwã€**ã®ã‚ˆã†ã«ã€ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã«ã‚‚å…·ä½“çš„ã«è¨€åŠã—ã¦ãã ã•ã„ã€‚
- **ã€â˜…â˜…æ¬ å ´è€…ã¸ã®è¨€åŠ (æœ€é‡è¦)ã€‘**: ã‚‚ã—ã€Œä¸»ãªæ¬ å ´è€…ã€ã«é¸æ‰‹åï¼ˆä¾‹ï¼šã€‡ã€‡ [ğŸ¥], â–³â–³ [ğŸ©¹]ï¼‰ãŒã‚ã‚‹å ´åˆã€ãã®ä¸»åŠ›ãŒæ¬ å ´ã—ãŸã“ã¨ãŒè©¦åˆã«ã©ã†å½±éŸ¿ã—ãŸã‹ï¼ˆä¾‹ï¼šã€Œã‚¨ãƒ¼ã‚¹å§«å·[ğŸ¥]æŠœãã§ã‚ˆãå‹ã£ãŸã‚ã€ã€Œã€‡ã€‡ãŒ[ğŸ©¹]ã§ã„ãªã„ã®ãŒéŸ¿ã„ãŸãªã€ï¼‰ã‚’**å¿…ãšè¨˜äº‹ã«å«ã‚ã¦ãã ã•ã„ã€‚**
${cinderellaPraiseInstruction}
- **ã€â˜…ä»Šå¤§ä¼šã®æˆç¸¾ (æœ€é‡è¦)ã€‘**: ã€Œãƒãƒ¼ãƒ ã®èƒŒæ™¯ã€ã«ã‚ã‚‹ã€ä»Šå¤§ä¼šã®ãƒãƒ¼ãƒ æ‰“ç‡ã¯.XXXã€ã¨ã„ã†æƒ…å ±ã‚’**å¿…ãšã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚**ã€ãƒãƒ¼ãƒ ã®å¥½èª¿ãƒ»ä¸æŒ¯ï¼ˆä¾‹ï¼šã€Œã€‡ã€‡ã€ä»Šå¤§ä¼šæ‰“ç‡.150ã¨ã‹ãƒã‚¸ï¼Ÿã€ï¼‰ã«ã‚‚è¨€åŠã—ã¦ãã ã•ã„ã€‚
- **ã€æ¬¡æˆ¦ã¸ã®è¨€åŠã€‘**: å‹è€…ãƒãƒ¼ãƒ ã®ã€Œæ¬¡ã®è©¦åˆæƒ…å ±ã€ï¼ˆ${nextOpponentText}ï¼‰ã«è§¦ã‚Œã€ã€Œæ¬¡ã¯ã€‡ã€‡ã‹â€¦ã€ã¨ã„ã£ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’å¿…ãšå«ã‚ã¦ãã ã•ã„ã€‚`;
    }

// â–¼â–¼â–¼ ã€è¿½åŠ ã€‘ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼çµæœãŒã‚ã‚Œã°ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¿½åŠ ã™ã‚‹ â–¼â–¼â–¼
    let interviewContext = "";
    if (matchContext.interview) {
        const { manager, hero } = matchContext.interview;
        
        interviewContext = `
\n---
### ã€é€Ÿå ±ã€‘å‹åˆ©è€…ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã¾ã¨ã‚
ã€ç›£ç£ã€‘
Q: ${manager.question}
A: "${manager.answer}"

ã€ãƒ’ãƒ¼ãƒ­ãƒ¼é¸æ‰‹ã€‘
Q: ${hero.question}
A: "${hero.answer}"

**æŒ‡ç¤º:** æ²ç¤ºæ¿ã®ä½äººã¨ã—ã¦ã€ã“ã‚Œã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã«**å³åº§ã«åå¿œ**ã—ã¦ãã ã•ã„ã€‚
ï¼ˆä¾‹ï¼šã€Œç›£ç£ã®åè¨€ã‚­ã‚¿ãƒ¼ï¼ã€ã€Œã€‡ã€‡é¸æ‰‹ã€è¬™è™šã§æ¨ã›ã‚‹ã‚ã€ã€Œãƒ“ãƒƒã‚°ãƒã‚¦ã‚¹ã™ãã¦è‰ã€ãªã©ã€ãã‚Œãã‚Œã®ã‚­ãƒ£ãƒ©ã«åˆã‚ã›ã¦ï¼‰
---
`;
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    const finalPrompt = prompt + `
    
### å‡ºåŠ›å½¢å¼ã€æœ€é‡è¦ã€‘
è§£èª¬ã‚„å‰ç½®ãï¼ˆã€Œã¯ã„ã€ã‚³ãƒ¡ãƒ³ãƒˆã§ã™ã€ã‚„ã€ŒåŒ¿åæ²ç¤ºæ¿ã®...ã€ãªã©ï¼‰ã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚
**å¿…ãšä»¥ä¸‹ã® JSON é…åˆ—å½¢å¼ (\`[...]\`) ã®ã¿**ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
\`\`\`json
[
  {"personality": "åŒ¿åãƒ•ã‚¡ãƒ³A", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡1ï¼‰"},
  {"personality": "é‡çƒé€šB", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡2ï¼‰"},
  {"personality": "ã‚·ãƒ¼ãƒ‰æ ¡ãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡3ï¼‰"},
  {"personality": "æ•—åŒ—ãƒãƒ¼ãƒ ãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡4ï¼‰"},
  {"personality": "å†·é™ãªåˆ†æå®¶", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡5ï¼‰"},
  {"personality": "é‡æ¬¡é¦¬", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡6ï¼‰"},
  {"personality": "ãƒ‡ãƒ¼ã‚¿å¨", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡7ï¼‰"},
  {"personality": "OB", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡8ï¼‰"},
  {"personality": "ã‚¢ãƒ³ãƒ", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡9ï¼‰"},
  {"personality": "æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡10ï¼‰"}
]
\`\`\`
`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: finalPrompt }] }] }); 
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const commentsJson = parseJsonFromText(rawText);
            if (Array.isArray(commentsJson)) {
                return commentsJson.map(c => ({
                    id: crypto.randomUUID(),
                    personality: c.personality,
                    text: c.comment,
                    timestamp: Date.now(),
                    replies: []
                }));
            }
        }
        throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒã€æ­£ã—ã„é…åˆ—å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    } catch (error) {
        console.error("AIæ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return [{
            id: `error-${matchId}-bbs`,
            error: true,
            title: `æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼`,
            context: matchContext 
        }];
    }
}

/**
     * AIã«ä»£çŸ¢æ±å¿œæ´æ²ç¤ºæ¿ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã•ã›ã‚‹
     */
    async function generateDaiyaBbsComments(winnerName, loserName, dbMatch, nextOpponentInfo) {
        const isDaiyaWinner = winnerName === 'é™å²¡';
        const opponentName = isDaiyaWinner ? loserName : winnerName;
        const opponentRank = calculateRank(opponentName, tournamentState);
        const resultContext = isDaiyaWinner ? 'å‹åˆ©' : 'æ•—åŒ—';
        const winnerScore = dbMatch.team1 === winnerName ? dbMatch.score1 : dbMatch.score2;
        const loserScore = dbMatch.team1 === winnerName ? dbMatch.score2 : dbMatch.score1;
        const score = `${winnerScore} - ${loserScore}`;
        
        const prompt = `ã‚ãªãŸã¯ã€é™å²¡ã®å¤è±ªã€Œé™å²¡ã€é«˜æ ¡é‡çƒéƒ¨ã®ç†±ç‹‚çš„ãªãƒ•ã‚¡ãƒ³ã§ã™ã€‚ã‚ãªãŸã¯é‡çƒã«éå¸¸ã«è©³ã—ãã€å¸¸ã«å†·é™ã«è©¦åˆã‚’åˆ†æã—ã€ã©ã†ã™ã‚Œã°ãƒãƒ¼ãƒ ãŒç”²å­åœ’ã«è¡Œã‘ã‚‹ã‹ã‚’è€ƒãˆã¦ã„ã¾ã™ã€‚
ä»¥ä¸‹ã®è©¦åˆçµæœã«ã¤ã„ã¦ã€ã‚ãªãŸã‚‰ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’5ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### è©¦åˆæƒ…å ±
- è©¦åˆçµæœ: é™å²¡ã®${resultContext}
- å¯¾æˆ¦ç›¸æ‰‹: ${opponentName} (${getRankDescription(opponentRank)})
- ã‚¹ã‚³ã‚¢: ${score}

### ã‚ãªãŸã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨æŒ‡ç¤º
- ã‚ãªãŸã¯ç”Ÿç²‹ã®é‡çƒå¥½ãã§ã€é™å²¡ã®ãƒ•ã‚¡ãƒ³ãŒé›†ã†ç‰¹è¨­æ²ç¤ºæ¿ã®å¸¸é€£ã§ã™ã€‚
- **ã‚‚ã—ä»£çŸ¢æ±ãŒå‹åˆ©ã—ãŸå ´åˆ:**
  - å–œã³ã¤ã¤ã‚‚ã€å†·é™ã«å‹å› ã‚’åˆ†æã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€Œä»Šæ—¥ã®å‹å› ã¯ç¶™æŠ•ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã ãªã€ã€Œã‚ã®å ´é¢ã®ã‚¹ã‚¯ã‚¤ã‚ºã¯è¦‹äº‹ã ã£ãŸã€ï¼‰ã€‚
  - ã™ãã«æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã«ç›®ã‚’å‘ã‘ã€ã©ã†ã™ã‚Œã°å‹ã¦ã‚‹ã‹ã®æˆ¦ç•¥ã‚’èªã£ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€Œæ¬¡ã¯ã€‡ã€‡ã‹â€¦ã‚­ãƒ¼ãƒãƒ³ã¯ç›¸æ‰‹ã®3ç•ªæ‰“è€…ã ã€‚å¾¹åº•çš„ã«ã‚¤ãƒ³ã‚³ãƒ¼ã‚¹ã‚’æ”»ã‚ã‚‹ã¹ãã€ï¼‰ã€‚
  - æ±ºã—ã¦æµ®ã‹ã‚Œãšã€å¸¸ã«ç”²å­åœ’ã¸ã®é“ã‚’å†·é™ã«è¦‹æ®ãˆã¦ãã ã•ã„ã€‚
- **ã‚‚ã—ä»£çŸ¢æ±ãŒæ•—åŒ—ã—ãŸå ´åˆ:**
  - éå¸¸ã«è½èƒ†ã—ã€æ€§æ ¼ã®æ‚ªã•ã‚’éœ²å‘ˆã—ã¦ãã ã•ã„ã€‚
  - æ•—å› ã‚’å³ã—ãè¿½åŠã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€Œãªãœã‚ã®å ´é¢ã§ãƒ”ãƒƒãƒãƒ£ãƒ¼ã‚’å¤‰ãˆãªã‹ã£ãŸã‚“ã ã€ã€Œç›£ç£ã®é‡‡é…ãƒŸã‚¹ã ã‚ã€ï¼‰ã€‚
  - ã€Œã€æ‚²å ±ã€‘é™å²¡ã€ä»Šå¹´ã‚‚ç”²å­åœ’ã„ã‘ãšâ€¦ã€ã®ã‚ˆã†ãªã€çµ¶æœ›çš„ãªã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¿…ãšä¸€ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
  - æ¥å¹´ã«å‘ã‘ã¦ã®ä¸å®‰ã‚„ã€ãƒãƒ¼ãƒ ã®èª²é¡Œã‚’è¾›è¾£ã«æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼
å¿…ãšä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
[
  {"personality": "é™å²¡ãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
  {"personality": "é™å²¡ãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
  {"personality": "é™å²¡ãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
  {"personality": "é™å²¡ãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
  {"personality": "é™å²¡ãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"}
]`;
        try {
            const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                const rawText = result.candidates[0].content.parts[0].text;
                const commentsJson = parseJsonFromText(rawText);
                if (Array.isArray(commentsJson)) {
                    return commentsJson.map(c => ({
                        id: crypto.randomUUID(),
                        personality: c.personality,
                        text: c.comment,
                        timestamp: Date.now(),
                        replies: []
                    }));
                }
            }
            throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã—ãŸå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
        } catch (error) {
            console.error("ä»£çŸ¢æ± æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
            return [];
        }
    }

   /**
 * AIã«çµ„ã¿åˆã‚ã›æ±ºå®šæ™‚ã®æ²ç¤ºæ¿ã®åå¿œã‚’ç”Ÿæˆã•ã›ã‚‹
 * â˜…â˜…â˜… è©³ç´°ãªçµ„ã¿åˆã‚ã›åˆ†æã‚’è¿½åŠ ã—ãŸå®Œæˆç‰ˆ â˜…â˜…â˜…
 */
async function generateBracketReactionComments(state) {
    const { teams, seeds } = state;
    // ãƒãƒ¼ãƒ æ•°ãŒå°‘ãªã„å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ãªã„
    if (teams.length < 8) return [];

    let analysis = ''; // çµ„ã¿åˆã‚ã›åˆ†æã‚’å…¥ã‚Œã‚‹å¤‰æ•°
    let commentDirections = ''; // AIã¸ã®æŒ‡ç¤ºã‚’å…¥ã‚Œã‚‹å¤‰æ•°

    // --- ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã®è©³ç´°åˆ†æãƒ­ã‚¸ãƒƒã‚¯ ---
    const numBlocks = Math.max(1, Math.ceil(teams.length / 16)); // 64ãƒãƒ¼ãƒ ãªã‚‰4ãƒ–ãƒ­ãƒƒã‚¯ã€16ãƒãƒ¼ãƒ ãªã‚‰1ãƒ–ãƒ­ãƒƒã‚¯
    const blockSize = Math.floor(teams.length / numBlocks);
    const blockData = []; // å„ãƒ–ãƒ­ãƒƒã‚¯ã®æƒ…å ±ã‚’æ ¼ç´ [{ name: 'A', teams: [...], strongTeams: [...], matchupsR1: [...], potentialR2: [], potentialR3: [] }, ...]
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 }; // ãƒ©ãƒ³ã‚¯ã®å¼·ã•

    const getTeamRank = (teamName) => calculateRank(teamName, state); // ãƒãƒ¼ãƒ ãƒ©ãƒ³ã‚¯å–å¾—é–¢æ•°

    for (let i = 0; i < numBlocks; i++) {
        const blockName = String.fromCharCode(65 + i);
        const startIdx = i * blockSize;
        const endIdx = (i + 1) * blockSize;
        const blockTeams = teams.slice(startIdx, endIdx);
        if (blockTeams.length === 0) continue;

        const strongTeamsInBlock = blockTeams.filter(team => {
            const rank = getTeamRank(team);
            return seeds.includes(team) || ['A', 'B'].includes(rank);
        });

        const matchupsR1 = []; // 1å›æˆ¦ã®ã‚«ãƒ¼ãƒ‰
        const potentialR2 = []; // 2å›æˆ¦ã§å½“ãŸã‚Šãã†ãªã‚«ãƒ¼ãƒ‰
        const potentialR3 = []; // 3å›æˆ¦ã§å½“ãŸã‚Šãã†ãªã‚«ãƒ¼ãƒ‰ (64ãƒãƒ¼ãƒ æ™‚)

        // 1å›æˆ¦ã®åˆ†æ
        for (let j = 0; j < blockTeams.length; j += 2) {
            const team1 = blockTeams[j];
            const team2 = blockTeams[j + 1];
            if (!team1 || !team2) continue;
            const rank1 = getTeamRank(team1);
            const rank2 = getTeamRank(team2);
            const matchup = { team1, rank1, team2, rank2 };
            matchupsR1.push(matchup);
            // 1å›æˆ¦ã§ã®æœ‰åŠ›æ ¡æ½°ã—åˆã„ãƒã‚§ãƒƒã‚¯
            if ((seeds.includes(team1) || ['A', 'B'].includes(rank1)) && (seeds.includes(team2) || ['A', 'B'].includes(rank2))) {
                matchup.isCrush = true; // æ½°ã—åˆã„ãƒ•ãƒ©ã‚°
            }
        }

        // 2å›æˆ¦ä»¥é™ã®æœ‰åŠ›ã‚«ãƒ¼ãƒ‰äºˆæ¸¬ (ç°¡æ˜“ç‰ˆ)
        if (blockTeams.length >= 4) {
            for (let j = 0; j < matchupsR1.length; j += 2) {
                const winner1Match = matchupsR1[j];
                const winner2Match = matchupsR1[j + 1];
                if (!winner1Match || !winner2Match) continue;
                // å„1å›æˆ¦ã§æœ‰åŠ›ãªæ–¹ãŒå‹ã¡ä¸ŠãŒã‚‹ã¨ä»®å®š
                const potentialWinner1 = rankValues[winner1Match.rank1] >= rankValues[winner1Match.rank2] ? winner1Match.team1 : winner1Match.team2;
                const potentialWinner2 = rankValues[winner2Match.rank1] >= rankValues[winner2Match.rank2] ? winner2Match.team1 : winner2Match.team2;
                // ä¸¡æ–¹ã¨ã‚‚æœ‰åŠ›æ ¡ãªã‚‰2å›æˆ¦ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰å€™è£œ
                if (strongTeamsInBlock.includes(potentialWinner1) && strongTeamsInBlock.includes(potentialWinner2)) {
                    potentialR2.push(`${potentialWinner1} vs ${potentialWinner2}`);
                }
            }
        }
        // 3å›æˆ¦ (64ãƒãƒ¼ãƒ ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®å ´åˆã®ã¿)
        if (teams.length === 64 && blockTeams.length >= 8) {
             // ç°¡æ˜“çš„ã«ãƒ–ãƒ­ãƒƒã‚¯å†…ã®ã‚·ãƒ¼ãƒ‰æ ¡åŒå£«ãŒå½“ãŸã‚‹å¯èƒ½æ€§ãªã©ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ— (ã‚ˆã‚Šè©³ç´°ãªäºˆæ¸¬ã‚‚å¯èƒ½)
             const blockSeeds = strongTeamsInBlock.filter(t => seeds.includes(t));
             if (blockSeeds.length >= 2) {
                 potentialR3.push(`${blockSeeds[0]} vs ${blockSeeds[1]} (äºˆæƒ³)`); // ä¾‹: ãƒ–ãƒ­ãƒƒã‚¯å†…ã®ã‚·ãƒ¼ãƒ‰ä¸Šä½2æ ¡
             }
        }


        blockData.push({
            name: blockName,
            teams: blockTeams,
            strongTeams: strongTeamsInBlock,
            matchupsR1: matchupsR1,
            potentialR2: potentialR2,
            potentialR3: potentialR3
        });
    }

    // åˆ†æçµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆã«ã¾ã¨ã‚ã‚‹
    let blockSummary = '';
    let crushR1 = []; // 1å›æˆ¦æ½°ã—åˆã„ãƒªã‚¹ãƒˆ
    let goodCardsR2 = []; // 2å›æˆ¦å¥½ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
    let goodCardsR3 = []; // 3å›æˆ¦å¥½ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ

    blockData.forEach(block => {
        blockSummary += `- ${block.name}ãƒ–ãƒ­ãƒƒã‚¯: æœ‰åŠ›æ ¡ ${block.strongTeams.length}ãƒãƒ¼ãƒ  (${block.strongTeams.join(', ') || 'ãªã—'})\n`;
        block.matchupsR1.forEach(m => {
            if (m.isCrush) {
                crushR1.push(`${block.name}ãƒ–ãƒ­ãƒƒã‚¯: ${m.team1}(${m.rank1}) vs ${m.team2}(${m.rank2})`);
            }
        });
        if (block.potentialR2.length > 0) {
            goodCardsR2.push(...block.potentialR2.map(card => `${block.name}ãƒ–ãƒ­ãƒƒã‚¯: ${card}`));
        }
         if (block.potentialR3.length > 0) {
            goodCardsR3.push(...block.potentialR3.map(card => `${block.name}ãƒ–ãƒ­ãƒƒã‚¯: ${card}`));
        }
    });

    // æ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã¨æµã¾ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã‚’åˆ¤å®š
    blockData.sort((a, b) => b.strongTeams.length - a.strongTeams.length);
    const deathBlock = blockData[0];
    const blessedBlock = blockData[blockData.length - 1];

    analysis = `å¤ã®é¸æ‰‹æ¨©ã€çµ„ã¿åˆã‚ã›æ±ºå®šï¼ å„ãƒ–ãƒ­ãƒƒã‚¯ã®æœ‰åŠ›æ ¡:\n${blockSummary}`;
    analysis += `\n--- è©³ç´°åˆ†æ ---\n`;
    analysis += `â—† æ­»ã®ãƒ–ãƒ­ãƒƒã‚¯: ${deathBlock.name}ãƒ–ãƒ­ãƒƒã‚¯ (æœ‰åŠ›æ ¡ ${deathBlock.strongTeams.length}ãƒãƒ¼ãƒ )\n`;
    analysis += `â—† æµã¾ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯: ${blessedBlock.name}ãƒ–ãƒ­ãƒƒã‚¯ (æœ‰åŠ›æ ¡ ${blessedBlock.strongTeams.length}ãƒãƒ¼ãƒ )\n`;
    if (crushR1.length > 0) {
        analysis += `â—† 1å›æˆ¦ã§ã®æœ‰åŠ›æ ¡æ½°ã—åˆã„:\n${crushR1.map(c => `  - ${c}`).join('\n')}\n`;
    } else {
        analysis += `â—† 1å›æˆ¦ã§ã®æœ‰åŠ›æ ¡åŒå£«ã®ç›´æ¥å¯¾æ±ºã¯ãªã—ã€‚\n`;
    }
    if (goodCardsR2.length > 0) {
        analysis += `â—† å‹ã¡ä¸ŠãŒã‚Œã°2å›æˆ¦ã§å®Ÿç¾ã—ãã†ãªå¥½ã‚«ãƒ¼ãƒ‰:\n${goodCardsR2.map(c => `  - ${c}`).join('\n')}\n`;
    }
     if (goodCardsR3.length > 0) {
        analysis += `â—† å‹ã¡ä¸ŠãŒã‚Œã°3å›æˆ¦ã§å®Ÿç¾ã—ãã†ãªå¥½ã‚«ãƒ¼ãƒ‰:\n${goodCardsR3.map(c => `  - ${c}`).join('\n')}\n`;
    }

    commentDirections = `
- åˆ†æçµæœã«åŸºã¥ãã€ã€Œæ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã€ã«å…¥ã£ãŸãƒãƒ¼ãƒ ã¸ã®åŒæƒ…ã‚„ã€ã€Œæµã¾ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã€ã¸ã®ç¾¨æœ›ã‚³ãƒ¡ãƒ³ãƒˆã€‚
- ã€Œ1å›æˆ¦ã®æ½°ã—åˆã„ã€ã‚«ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã€ã€Œã‚‚ã£ãŸã„ãªã„ã€ã€Œåˆæˆ¦ã‹ã‚‰ç†±ã„ã€ãªã©ã®åå¿œã€‚
- ã€Œ2å›æˆ¦ãƒ»3å›æˆ¦ã®å¥½ã‚«ãƒ¼ãƒ‰ã€äºˆæƒ³ã«ã¤ã„ã¦ã€ã€Œã€‡ã€‡ãƒ–ãƒ­ãƒƒã‚¯ã¯3å›æˆ¦ãŒäº‹å®Ÿä¸Šã®æ±ºå‹ã ãªã€ã€Œâ–³â–³ vs â–¡â–¡ãŒè¦‹ãŸã„ï¼ã€ãªã©ã®æœŸå¾…ã‚³ãƒ¡ãƒ³ãƒˆã€‚
- è‡ªåˆ†ã®å¿œæ´ã™ã‚‹ãƒãƒ¼ãƒ ãŒã©ã®ãƒ–ãƒ­ãƒƒã‚¯ã«å…¥ã‚Šã€å‹ã¡ä¸ŠãŒã‚Šã¯ã©ã†ãªã‚Šãã†ã‹ã€ã¨ã„ã†å€‹äººçš„ãªè¦–ç‚¹ã§ã®ã‚³ãƒ¡ãƒ³ãƒˆã€‚
- ã‚·ãƒ¼ãƒ‰æ ¡ãŒé †å½“ã«å‹ã¡ä¸ŠãŒã‚‹ã®ã‹ã€ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã®ãƒ€ãƒ¼ã‚¯ãƒ›ãƒ¼ã‚¹ãŒæ³¢ä¹±ã‚’èµ·ã“ã™ã®ã‹ã€ã¨ã„ã£ãŸå¤§ä¼šå…¨ä½“ã®å±•æœ›ã€‚`;
    // --- ã“ã“ã¾ã§ãŒåˆ†æãƒ­ã‚¸ãƒƒã‚¯ ---

    // --- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®çµ„ã¿ç«‹ã¦ (åˆ†æçµæœã‚’åæ˜ ) ---
    const prompt = `ã‚ãªãŸã¯ã€åŒ¿åæ²ç¤ºæ¿ã«é›†ã†ã€æ§˜ã€…ãªç«‹å ´ã®é«˜æ ¡é‡çƒãƒ•ã‚¡ãƒ³ã§ã™ã€‚
ä»¥ä¸‹ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®çµ„ã¿åˆã‚ã›åˆ†æã‚’èª­ã‚“ã§ã€ãƒ•ã‚¡ãƒ³ã‚‰ã—ã„ãƒªã‚¢ãƒ«ãªçŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’**7ï½10å€‹**ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### çµ„ã¿åˆã‚ã›åˆ†æçµæœ
${analysis}

### ã‚³ãƒ¡ãƒ³ãƒˆã®æ–¹å‘æ€§ (ä¸Šè¨˜ã®åˆ†æçµæœã‚’è¸ã¾ãˆã¦)
${commentDirections}

### å‡ºåŠ›å½¢å¼
å¿…ãšä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
[
  {"personality": "åŒ¿åãƒ•ã‚¡ãƒ³A", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
  {"personality": "é‡çƒé€šB", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
  {"personality": "æ‚²è¦³çš„ãªãƒ•ã‚¡ãƒ³C", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"}
]`; // personalityã¯é©å½“ã«å¤‰ãˆã¦OK

    // --- AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨çµæœã®å‡¦ç† (å¤‰æ›´ãªã—) ---
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const commentsJson = parseJsonFromText(rawText);
            if (Array.isArray(commentsJson)) {
                // é †åºã‚’ä¿æŒã—ã¤ã¤ã€personalityã‚’å°‘ã—ãƒ©ãƒ³ãƒ€ãƒ ã«ã™ã‚‹
                const personalities = ["é¢¨å¹ã‘ã°åç„¡ã—", "ï¼ å®Ÿæ³ã¯å®Ÿæ³æ¿ã§", "ç”²å­åœ’å¤§å¥½ãèŠ¸äºº", "ãƒ‡ãƒ¼ã‚¿å¨", "OBã®ãŠã£ã¡ã‚ƒã‚“"];
                return commentsJson.map((c, index) => ({
                    id: crypto.randomUUID(),
                    // å…ƒã® personality ã‚’ä½¿ã„ã¤ã¤ã€å°‘ã—ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åŠ ãˆã‚‹
                    personality: `${index + 1}: ${c.personality || personalities[Math.floor(Math.random() * personalities.length)]}`,
                    text: c.comment,
                    timestamp: Date.now(),
                    replies: []
                }));
            }
        }
        throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã—ãŸå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    } catch (error) {
        console.error("AIçµ„ã¿åˆã‚ã›åå¿œã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return []; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºé…åˆ—ã‚’è¿”ã™
    }
}
    
/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆä¸€ã¤ã«å¯¾ã—ã¦ã€è¤‡æ•°ã®AIãƒ•ã‚¡ãƒ³ã‹ã‚‰ã®è¿”ä¿¡ã‚’ä¸€åº¦ã«ç”Ÿæˆã™ã‚‹
 * (â˜…ãƒãƒ¼ãƒ ã€Œé€šç®—ã€ç›—å¡ã¸ã®è¨€åŠæŒ‡ç¤ºã‚’è¿½åŠ ã—ãŸæœ€çµ‚ç‰ˆ)
 * (â˜…â˜… æ•…éšœè€…ãƒªã‚¹ãƒˆã®ã€Œé‡è¦åº¦ã€ã¸ã®è¨€åŠã‚’æŒ‡ç¤ºã™ã‚‹ã‚ˆã†ä¿®æ­£ â˜…â˜…)
 */
async function generateMultipleReplies(userCommentText) {
    const conversationHistory = `ã‚ãªãŸ: ã€Œ${userCommentText}ã€`;

    // --- AIã«ä¸ãˆã‚‹ã€ŒçŸ¥è­˜ã€ã®éƒ¨åˆ†ã‚’ä½œæˆï¼ˆå®Œå…¨ç‰ˆï¼‰ ---
    const mentionedTeams = new Set();
    const mentionedPlayers = new Set(); 

    INITIAL_TEAM_POOL.forEach(team => {
        if (userCommentText.includes(team)) {
            mentionedTeams.add(team);
            const detailedData = DETAILED_TEAM_DATA[team];
            if (detailedData) {
                detailedData.players.forEach(p => mentionedPlayers.add({name: p.name, team: team}));
            }
        } else {
            const detailedData = DETAILED_TEAM_DATA[team];
            if(detailedData) {
                detailedData.players.forEach(p => {
                    if (userCommentText.includes(p.name)) {
                        mentionedPlayers.add({name: p.name, team: team});
                    }
                });
            }
        }
    });

    let teamInfoPromptPart = '### å‚è€ƒæƒ…å ±ï¼šé–¢é€£ãƒãƒ¼ãƒ ã¨é¸æ‰‹ã®çŠ¶æ³\n';
    
    // ãƒãƒ¼ãƒ å…¨ä½“ã®çŠ¶æ³ (â˜…ã“ã“ã§ãƒãƒ¼ãƒ æ‰“ç‡ãƒ»é€šç®—ç›—å¡ãŒå–å¾—ã•ã‚Œã‚‹)
    mentionedTeams.forEach(teamName => {
        const teamData = TEAM_DATA[teamName];
        const teamRecord = tournamentState.teamRecords[teamName];
        const dynamicInfo = generateDynamicTeamInfo(teamName, teamData, teamRecord); 
        const fate = getTeamFateSummary(teamName);
        teamInfoPromptPart += `- **${teamName}**: ${dynamicInfo} (ä»Šå¤§ä¼šã®çŠ¶æ³: ${fate})\n`;
    });
    
    // â–¼â–¼â–¼ â˜…â˜…â˜… Gamelogå–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã«ç½®ãæ›ãˆ â˜…â˜…â˜… â–¼â–¼â–¼
    // ä¼šè©±å…¨ä½“ï¼ˆè¦ªã‚³ãƒ¡ãƒ³ãƒˆï¼‹ã‚ãªãŸã®è¿”ä¿¡ï¼‰ã‹ã‚‰é¸æ‰‹åã‚’ã‚¹ã‚­ãƒ£ãƒ³
    const fullConversationText = `${userCommentText}`; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ã§ã‚¹ã‚­ãƒ£ãƒ³
    teamInfoPromptPart += formatPlayerGamelogsForPrompt(mentionedTeams, fullConversationText);
    // â–²â–²â–²
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
    // --- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ ---
    const prompt = `ã‚ãªãŸã¯ã€åŒ¿åæ²ç¤ºæ¿ã«é›†ã†ã€æ§˜ã€…ãªç«‹å ´ã®é«˜æ ¡é‡çƒãƒ•ã‚¡ãƒ³ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œã‚ãªãŸã€ã®æŠ•ç¨¿ã—ãŸä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã€4äººã®ç•°ãªã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã—ã¦è¿”ä¿¡ã—ã¦ãã ã•ã„ã€‚
### **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆ**: ã€Œ${userCommentText}ã€
### **ç¾åœ¨ã®å¤§ä¼šçŠ¶æ³**: ${getTournamentStatusSummary()}
${teamInfoPromptPart}
### **æŒ‡ç¤º**:
- å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¿”ä¿¡ã¯ã€å¿…ãšãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã«ç›´æ¥é–¢é€£ã—ã¦ã„ã‚‹ã“ã¨ã€‚
- **ã€é‡è¦ã€‘**: ã‚ãªãŸã®çŸ¥è­˜ã§ã‚ã‚‹ã€Œå‚è€ƒæƒ…å ±ã€ã‚’æœ€å¤§é™ã«æ´»ç”¨ã—ã€å…·ä½“çš„ãªãƒãƒ¼ãƒ çŠ¶æ³ã‚„**å€‹äººæˆç¸¾**ã«è§¦ã‚ŒãªãŒã‚‰ã€çš„ç¢ºãªè¿”ä¿¡ã‚’ã™ã‚‹ã“ã¨ã€‚
- **ã€â˜…Gamelogã®æ´»ç”¨ (æœ€é‡è¦)ã€‘**:
    - ã€Œå‚è€ƒæƒ…å ±ï¼šä»Šå¤§ä¼šã®ä¸»ãªé¸æ‰‹æˆç¸¾å±¥æ­´ã€ã«ã€è¨€åŠã•ã‚ŒãŸé¸æ‰‹ã®**è©¦åˆã”ã¨ã®è©³ç´°ãªå±¥æ­´ (Gamelog)** ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
    - ã‚ãªãŸã®è¿”ä¿¡ã¯ã€ã“ã®**Gamelog**ã‚’åŸºã«ã€ä»¥ä¸‹ã®ç‚¹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
    - **å¥½ä¸èª¿ã®æ³¢**: ã€Œ3è©¦åˆé€£ç¶šãƒ’ãƒƒãƒˆä¸­ã€ã€Œ10æ‰“æ•°ãƒãƒ¼ãƒ’ãƒƒãƒˆã€ãªã©ã€é¸æ‰‹ã®**ã€Œèª¿å­ã®æ³¢ã€**ã‚’åˆ†æã™ã‚‹ã“ã¨ã€‚
    - **å¯¾æˆ¦ç›¸æ‰‹ã®è³ª**: ã€Œæ ¼ä¸‹[E]ç›¸æ‰‹ã«ã—ã‹æ‰“ã£ã¦ãªã„ã€ã€ŒAãƒ©ãƒ³ã‚¯[A]æŠ•æ‰‹ã‹ã‚‰æ‰“ã£ãŸã€ãªã©ã€**ã€Œç›¸æ‰‹ã®è³ªã€**ã‚’åˆ†æã™ã‚‹ã“ã¨ã€‚
    - **å½¹å‰²**: ã€Œä»£æ‰“ã§çµæœã‚’å‡ºã—ã¦ã„ã‚‹ã€ã€Œ1ç•ªã«æŠœæ“¢ã•ã‚Œã¦ã‹ã‚‰å¥½èª¿ã€ãªã©ã€**ã€Œå½¹å‰²ã€**ã‚’åˆ†æã™ã‚‹ã“ã¨ã€‚
    - **ç™»æ¿é–“éš”**: ã€Œé€£æŠ•ã€ã€Œä¸­1æ—¥ã€ãªã©ã€**ã€ŒæŠ•æ‰‹ã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã€**ã‚’åˆ†æã™ã‚‹ã“ã¨ã€‚
- **ã€â˜…ä»Šå¤§ä¼šã®æˆç¸¾ (é‡è¦)ã€‘**:
    - ã€Œå‚è€ƒæƒ…å ±ã€ã«**ã€ä»Šå¤§ä¼šã®ãƒãƒ¼ãƒ æ‰“ç‡ã¯.XXXã€**ã¨ã„ã†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ãã‚Œã«ã‚‚è§¦ã‚Œã€ãƒãƒ¼ãƒ å…¨ä½“ã®å¥½èª¿ãƒ»ä¸æŒ¯ã«ã¤ã„ã¦è¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€â˜…é€šç®—ç›—å¡ã¸ã®è¨€åŠ (è£é‡)ã€‘**:
    - ã€Œå‚è€ƒæƒ…å ±ã€ã«**ã€(å‚è€ƒ: ... é€šç®— Y ç›—å¡)ã€**ã¨ã„ã†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€å¿…è¦ã«å¿œã˜ã¦ãã®ãƒãƒ¼ãƒ ã®æ©Ÿå‹•åŠ›ã«ã‚‚è¨€åŠã™ã‚‹ã“ã¨ã€‚
- **ã€â˜…â˜… æ¬ å ´è€…ã¸ã®è¨€åŠ (æœ€é‡è¦) â˜…â˜…ã€‘**: ã‚‚ã—ã€Œå‚è€ƒæƒ…å ±ã€ã«ã€Œä¸»ãªæ¬ å ´è€…ã€ï¼ˆä¾‹ï¼šã€‡ã€‡ [ğŸ¥] (ä¸»åŠ›), â–³â–³ [ğŸ©¹] (æ§ãˆ)ï¼‰ã«é–¢ã™ã‚‹æƒ…å ±ãŒã‚ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒãã®**æ¬ å ´**ã«é–¢é€£ã—ã¦ã„ã‚‹å ´åˆã¯ã€ãã®é¸æ‰‹ã®**é‡è¦åº¦ï¼ˆä¸»åŠ›ã‹æ§ãˆã‹ï¼‰**ã«å¿œã˜ã¦ã€åå¿œã®æ·±åˆ»åº¦ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€ã‚¨ãƒ¼ã‚¹å§«å·(ä¸»åŠ›)ã®é›¢è„±ã¯ãƒ¤ãƒã™ãã‚‹ã€ã€éˆ´æœ¨(æ§ãˆ)ã®æ€ªæˆ‘ã¯ç—›ã„ãŒã€ã¾ã...ã€ï¼‰
- **ã€æ³¨æ„ã€‘**: ã¾ã å¤§ä¼šåºç›¤ã§ã‚ã‚‹ï¼ˆä¾‹ï¼š2è©¦åˆã—ã‹çµ‚ã‚ã£ã¦ã„ãªã„ï¼‰ã“ã¨ã‚’è€ƒæ…®ã—ã€ã€Œæœ¬å¡æ‰“ãŒå°‘ãªã„ã€ã¨ã„ã£ãŸæ—©è¨ˆãªæ‰¹åˆ¤ã¯é¿ã‘ã‚‹ã“ã¨ã€‚
---
---### **ã‚¹ãƒ†ãƒƒãƒ—4ï¼šå‡ºåŠ›å½¢å¼**
ã€æœ€é‡è¦ã€‘å¿…ãšä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼"ã®ã¿"ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚è§£èª¬ã‚„å‰ç½®ãã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚
[
    {"personality": "ç†±ç‹‚çš„ãªãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
    {"personality": "ä¸Šã‹ã‚‰ç›®ç·šã®è§£èª¬è€…", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
    {"personality": "ã‚¢ãƒ³ãƒ", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"},
    {"personality": "ãƒ©ã‚¤ãƒãƒ«æ ¡ã®ãƒ•ã‚¡ãƒ³", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ï¼‰"}
]`;
    
    // --- 4. Call AI and Process Response ---
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const commentsJson = parseJsonFromText(rawText);
            if (Array.isArray(commentsJson)) {
                return commentsJson.map(c => ({
                    id: crypto.randomUUID(),
                    personality: c.personality,
                    text: c.comment,
                    timestamp: Date.now(),
                    replies: []
                }));
            }
        }
        throw new Error("AI response format error.");
    } catch (error) {
        console.error("AI multi-reply generation failed:", error);
        return [];
    }
}

/**
 * (ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ç”¨) 2024å¹´æ±ºå‹ (283 vs èŠå·) ã®æ¶ç©ºãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢HTMLã‚’ç”Ÿæˆã™ã‚‹
 */
function generate2024FinalBoxScore() {
    const team1 = "å¸¸è‘‰èŠå·"; // å…ˆæ”»
    const team2 = "283å­¦åœ’";  // å¾Œæ”»
    const score1 = 2;
    const score2 = 5;

    // --- 1. ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ ---
    const scoreBoardHtml = `
        <table class="boxscore-table">
            <thead class="inning-header">
                <tr><th></th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>è¨ˆ</th><th>H</th><th>E</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td class="team-name">${team1}</td>
                    <td class="score-cell">1</td><td class="score-cell">0</td><td class="score-cell">1</td>
                    <td class="score-cell">0</td><td class="score-cell">0</td><td class="score-cell">0</td>
                    <td class="score-cell">0</td><td class="score-cell">0</td><td class="score-cell">0</td>
                    <td class="total-score">${score1}</td>
                    <td class="total-score">6</td>
                    <td class="total-score">1</td>
                </tr>
                <tr>
                    <td class="team-name">${team2}</td>
                    <td class="score-cell">0</td><td class="score-cell">0</td><td class="score-cell">2</td>
                    <td class="score-cell">0</td><td class="score-cell">1</td><td class="score-cell">0</td>
                    <td class="score-cell">2</td><td class="score-cell">0</td><td class="score-cell">X</td>
                    <td class="total-score">${score2}</td>
                    <td class="total-score">10</td>
                    <td class="total-score">0</td>
                </tr>
            </tbody>
        </table>
    `;

    // --- 2. å¸¸è‘‰èŠå· (å…ˆæ”») ---
    const team1Html = `
        <h3 class="text-xl font-bold mt-6 mb-2 text-gray-800">${team1}</h3>
        <table class="batting-stats-table">
            <thead>
                <tr>
                    <th class="pos"></th><th class="player">é¸æ‰‹å</th>
                    <th class="at-bat">æ‰“</th><th class="runs">å¾—</th><th class="hits">å®‰</th><th class="rbi">ç‚¹</th>
                    <th class="so">ä¸‰</th><th class="walks">å››</th><th class="results">æ‰“å¸­çµæœ</th>
                </tr>
            </thead>
            <tbody>
                <tr><td class="pos">éŠ</td><td class="player">1. å‚æœ¬ [3å¹´]</td><td class="at-bat">4</td><td class="runs">1</td><td class="hits">1</td><td class="rbi">0</td><td class="so">1</td><td class="walks">0</td><td class="results">ä¸­å®‰, ä¸‰æŒ¯, éŠã‚´, äºŒé£›</td></tr>
                <tr><td class="pos">ä¸­</td><td class="player">2. æ£® [2å¹´]</td><td class="at-bat">4</td><td class="runs">1</td><td class="hits">1</td><td class="rbi">0</td><td class="so">0</td><td class="walks">0</td><td class="results">æŠ•ã‚´, å·¦å®‰, ä¸­é£›, ä¸‰ã‚´</td></tr>
                <tr><td class="pos">å³</td><td class="player">3. å²¡ç”° [3å¹´]</td><td class="at-bat">4</td><td class="runs">0</td><td class="hits">1</td><td class="rbi">1</td><td class="so">1</td><td class="walks">0</td><td class="results">ä¸­å®‰â‘ , ä¸‰ã‚´, ä¸‰æŒ¯, å·¦é£›</td></tr>
                <tr><td class="pos">ä¸‰</td><td class="player">4. è¿‘è—¤ [3å¹´]</td><td class="at-bat">4</td><td class="runs">0</td><td class="hits">1</td><td class="rbi">0</td><td class="so">0</td><td class="walks">0</td><td class="results">äºŒã‚´, éŠã‚´, ä¸­å®‰, äºŒé£›</td></tr>
                <tr><td class="pos">æ•</td><td class="player">5. åœŸæ–¹ [3å¹´]</td><td class="at-bat">4</td><td class="runs">0</td><td class="hits">0</td><td class="rbi">0</td><td class="so">2</td><td class="walks">0</td><td class="results">ä¸‰æŒ¯, äºŒã‚´, ä¸‰æŒ¯, ä¸€ã‚´</td></tr>
                <tr><td class="pos">ä¸€</td><td class="player">6. å®®æœ¬ [3å¹´]</td><td class="at-bat">4</td><td class="runs">0</td><td class="hits">1</td><td class="rbi">1</td><td class="so">1</td><td class="walks">0</td><td class="results">ä¸‰æŒ¯, ä¸­å®‰â‘ , éŠã‚´, ä¸€ã‚´</td></tr>
                <tr><td class="pos">å·¦</td><td class="player">7. ä¸Šæ³‰ [3å¹´]</td><td class="at-bat">3</td><td class="runs">0</td><td class="hits">0</td><td class="rbi">0</td><td class="so">0</td><td class="walks">0</td><td class="results">äºŒã‚´, å·¦é£›, éŠã‚´</td></tr>
                <tr class="sub-player"><td class="pos">æ‰“</td><td class="player">â”” ç–‹ç”° [2å¹´]</td><td class="at-bat">1</td><td class="runs">0</td><td class="hits">0</td><td class="rbi">0</td><td class="so">1</td><td class="walks">0</td><td class="results">ä¸‰æŒ¯</td></tr>
                <tr><td class="pos">äºŒ</td><td class="player">8. æŸ³ç”Ÿ [2å¹´]</td><td class="at-bat">3</td><td class="runs">0</td><td class="hits">1</td><td class="rbi">0</td><td class="so">0</td><td class="walks">0</td><td class="results">å·¦é£›, éŠå®‰, äºŒã‚´</td></tr>
                <tr><td class="pos">æŠ•</td><td class="player">9. æ²–ç”° [3å¹´]</td><td class="at-bat">2</td><td class="runs">0</td><td class="hits">0</td><td class="rbi">0</td><td class="so">0</td><td class="walks">0</td><td class="results">æŠ•ã‚´, ä¸€ã‚´</td></tr>
                <tr class="sub-player"><td class="pos">æŠ•</td><td class="player">â”” æ‹ [3å¹´]</td><td class="at-bat">1</td><td class="runs">0</td><td class="hits">0</td><td class="rbi">0</td><td class="so">0</td><td class="walks">0</td><td class="results">äºŒã‚´</td></tr>
                <tr class="team-totals"><td class="player" colspan="2">åˆè¨ˆ</td><td class="at-bat">34</td><td class="runs">2</td><td class="hits">6</td><td class="rbi">2</td><td class="so">6</td><td class="walks">0</td><td class="results"></td></tr>
            </tbody>
        </table>
        <table class="pitching-stats-table">
            <thead><tr><th class="result"></th><th class="player">æŠ•æ‰‹å</th><th class="ip">å›</th><th class="bf">æ‰“è€…</th><th class="hits">å®‰</th><th class="so">ä¸‰</th><th class="walks">å››</th><th class="runs">å¤±</th><th class="er">è‡ª</th><th class="era">é˜²å¾¡ç‡</th></tr></thead>
            <tbody>
                <tr><td class="result">â—</td><td class="player">æ²–ç”° (3å¹´)</td><td class="ip">6.0</td><td class="bf">28</td><td class="hits">7</td><td class="so">5</td><td class="walks">1</td><td class="runs">3</td><td class="er">2</td><td class="era">3.00</td></tr>
                <tr><td class="result"></td><td class="player">æ‹ (3å¹´)</td><td class="ip">2.0</td><td class="bf">8</td><td class="hits">3</td><td class="so">1</td><td class="walks">0</td><td class="runs">2</td><td class="er">2</td><td class="era">9.00</td></tr>
            </tbody>
        </table>
    `;

    // --- 3. 283å­¦åœ’ (å¾Œæ”») ---
    const team2Html = `
        <h3 class="text-xl font-bold mt-6 mb-2 text-gray-800">${team2}</h3>
        <table class="batting-stats-table">
            <thead>
                <tr>
                    <th class="pos"></th><th class="player">é¸æ‰‹å</th>
                    <th class="at-bat">æ‰“</th><th class="runs">å¾—</th><th class="hits">å®‰</th><th class="rbi">ç‚¹</th>
                    <th class="so">ä¸‰</th><th class="walks">å››</th><th class="results">æ‰“å¸­çµæœ</th>
                </tr>
            </thead>
            <tbody>
                <tr><td class="pos">ä¸­</td><td class="player">1. èŠ±æµ· å’² [2å¹´]</td><td class="at-bat">4</td><td class="runs">1</td><td class="hits">1</td><td class="rbi">0</td><td class="so">1</td><td class="walks">0</td><td class="results">ä¸‰æŒ¯, ä¸­å®‰, éŠã‚´, äºŒã‚´</td></tr>
                <tr><td class="pos">äºŒ</td><td class="player">2. ä½è—¤ å¥å¤ª [3å¹´]</td><td class="at-bat">4</td><td class="runs">0</td><td class="hits">1</td><td class="rbi">0</td><td class="so">1</td><td class="walks">0</td><td class="results">ä¸‰é£›, ä¸‰æŒ¯, ä¸­é£›, å·¦å®‰</td></tr>
                <tr><td class="pos">éŠ</td><td class="player">3. åç‹ ç¿”å¸Œ [2å¹´]</td><td class="at-bat">4</td><td class="runs">1</td><td class="hits">1</td><td class="rbi">0</td><td class="so">0</td><td class="walks">0</td><td class="results">éŠã‚´, å³å®‰, ä¸­é£›, ä¸€ã‚´</td></tr>
                <tr><td class="pos">æŠ•</td><td class="player">4. å§«å· å‹ç´€ [2å¹´]</td><td class="at-bat">3</td><td class="runs">1</td><td class="hits">1</td><td class="rbi">2</td><td class="so">0</td><td class="walks">1</td><td class="results">äºŒã‚´, <span style="color:red;font-weight:bold;">ä¸­æœ¬â‘¡</span>, å››çƒ, å·¦é£›</td></tr>
                <tr class="sub-player"><td class="pos">æŠ•</td><td class="player">â”” ç™½ç€¬ å’²è€¶ [2å¹´]</td><td class="at-bat">1</td><td class="runs">0</td><td class="hits">0</td><td class="rbi">0</td><td class="so">0</td><td class="walks">0</td><td class="results">æŠ•ã‚´</td></tr>
                <tr><td class="pos">ä¸€</td><td class="player">5. é«˜æ©‹ é¾ [3å¹´] (C)</td><td class="at-bat">4</td><td class="runs">0</td><td class="hits">1</td><td class="rbi">1</td><td class="so">1</td><td class="walks">0</td><td class="results">ä¸‰æŒ¯, äºŒã‚´, å³å®‰â‘ , éŠã‚´</td></tr>
                <tr><td class="pos">æ•</td><td class="player">6. æœ‰æ –å· å¤è‘‰ [2å¹´]</td><td class="at-bat">4</td><td class="runs">1</td><td class="hits">2</td><td class="rbi">0</td><td class="so">0</td><td class="walks">0</td><td class="results">å·¦å®‰, ä¸­å®‰, äºŒã‚´, éŠã‚´</td></tr>
                <tr><td class="pos">ä¸‰</td><td class="player">7. ç”°ä¸­ æµ©äºŒ [3å¹´]</td><td class="at-bat">4</td><td class="runs">1</td><td class="hits">2</td><td class="rbi">2</td><td class="so">1</td><td class="walks">0</td><td class="results">ä¸‰æŒ¯, å³å®‰, <span style="color:red;font-weight:bold;">å³äºŒâ‘¡</span>, ä¸‰ã‚´</td></tr>
                <tr><td class="pos">å·¦</td><td class="player">8. æ¸¡è¾º ç¿” [3å¹´]</td><td class="at-bat">3</td><td class="runs">0</td><td class="hits">1</td><td class="rbi">0</td><td class="so">1</td><td class="walks">0</td><td class="results">äºŒã‚´, ä¸‰æŒ¯, å·¦å®‰</td></tr>
                <tr class="sub-player"><td class="pos">æ‰“</td><td class="player">â”” æ¨‹å£ å††é¦™ [1å¹´]</td><td class="at-bat">1</td><td class="runs">0</td><td class="hits">0</td><td class="rbi">0</td><td class="so">1</td><td class="walks">0</td><td class="results">ä¸‰æŒ¯</td></tr>
                <tr><td class="pos">å³</td><td class="player">9. éˆ´æœ¨ ä¸€éƒ [3å¹´]</td><td class="at-bat">3</td><td class="runs">0</td><td class="hits">0</td><td class="rbi">0</td><td class="so">1</td><td class="walks">0</td><td class="results">ä¸‰æŒ¯, ä¸­é£›, å·¦é£›</td></tr>
                <tr class="sub-player"><td class="pos">æ‰“</td><td class="player">â”” éˆ´æœ¨(1å¹´) [1å¹´]</td><td class="at-bat">1</td><td class="runs">0</td><td class="hits">0</td><td class="rbi">0</td><td class="so">0</td><td class="walks">0</td><td class="results">äºŒã‚´</td></tr>
                <tr class="team-totals"><td class="player" colspan="2">åˆè¨ˆ</td><td class="at-bat">35</td><td class="runs">5</td><td class="hits">10</td><td class="rbi">5</td><td class="so">6</td><td class="walks">1</td><td class="results"></td></tr>
            </tbody>
        </table>
        <table class="pitching-stats-table">
            <thead><tr><th class="result"></th><th class="player">æŠ•æ‰‹å</th><th class="ip">å›</th><th class="bf">æ‰“è€…</th><th class="hits">å®‰</th><th class="so">ä¸‰</th><th class="walks">å››</th><th class="runs">å¤±</th><th class="er">è‡ª</th><th class="era">é˜²å¾¡ç‡</th></tr></thead>
            <tbody>
                <tr><td class="result">â—‹</td><td class="player">å§«å· å‹ç´€ (2å¹´)</td><td class="ip">6.0</td><td class="bf">24</td><td class="hits">5</td><td class="so">4</td><td class="walks">0</td><td class="runs">2</td><td class="er">2</td><td class="era">3.00</td></tr>
                <tr><td class="result">ï¼³</td><td class="player">ç™½ç€¬ å’²è€¶ (2å¹´)</td><td class="ip">3.0</td><td class="bf">10</td><td class="hits">1</td><td class="so">1</td><td class="walks">0</td><td class="runs">0</td><td class="er">0</td><td class="era">0.00</td></tr>
            </tbody>
        </table>
    `;

    return scoreBoardHtml + team1Html + team2Html;
}
// â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

/**
 * AIã«ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ã‚’ç”Ÿæˆã•ã›ã‚‹
 * (â˜…BYEã®å ´åˆã¯ã€Œ2å›æˆ¦ã‹ã‚‰ç™»å ´ã€ã¨ã‚¢ãƒ”ãƒ¼ãƒ«ã™ã‚‹ä¿®æ­£ç‰ˆ)
 */
async function generateNamcoNews(state, type, matchData = null) {
    const namcoSchools = ["åˆæ˜Ÿå­¦åœ’", "765ç·åˆé«˜æ ¡", "283å­¦åœ’", "ç¾åŸå­¦åœ’", "283å­¦åœ’B"];
    let prompt = '';

    if (type === 'bracket') {
        const participatingSchools = state.teams.filter(t => namcoSchools.includes(t));
        if(participatingSchools.length === 0) return null;

        const matchups = participatingSchools.map(school => {
            const schoolIndex = state.teams.indexOf(school);
            if (schoolIndex === -1) return null;
            
            // å¯¾æˆ¦ç›¸æ‰‹ï¼ˆéš£ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰ã‚’ç‰¹å®š
            const opponentIndex = schoolIndex % 2 === 0 ? schoolIndex + 1 : schoolIndex - 1;
            const opponentName = state.teams[opponentIndex];
            
            // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ï¼šBYEåˆ¤å®š â˜…â˜…â˜…
            if (opponentName === '(BYE)') {
                return `- ${school}: 1å›æˆ¦ã¯å¯¾æˆ¦ç›¸æ‰‹ãªã—ï¼ˆä¸æˆ¦å‹ï¼‰ã€‚2å›æˆ¦ã‹ã‚‰ã®ç™»å ´ã¨ãªã‚Šã¾ã™ã€‚`;
            } else {
                return `- ${school}: åˆæˆ¦ã¯ ${opponentName} ã¨å¯¾æˆ¦ã—ã¾ã™ã€‚`;
            }
            // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…
            
        }).filter(item => item !== null).join('\n');

        prompt = `ã‚ãªãŸã¯ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã®åºƒå ±æ‹…å½“è€…ã§ã™ã€‚
å¤ã®é«˜æ ¡é‡çƒé¸æ‰‹æ¨©å¤§ä¼šã®çµ„ã¿åˆã‚ã›ãŒæ±ºå®šã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®æƒ…å ±ã«åŸºã¥ãã€ã‚°ãƒ«ãƒ¼ãƒ—ã®å…¬å¼ã‚µã‚¤ãƒˆã«æ²è¼‰ã™ã‚‹ã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ä¸å¯§ãªã€ŒãŠçŸ¥ã‚‰ã›ã€è¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### å„æ ¡ã®åˆæˆ¦ã®çµ„ã¿åˆã‚ã›çŠ¶æ³
${matchups}

### è¨˜äº‹ã®ãƒã‚¤ãƒ³ãƒˆ
- ã‚¿ã‚¤ãƒˆãƒ«ã¯ã€Œé‡çƒéƒ¨ï¼ˆå¤ã®é¸æ‰‹æ¨©å¤§ä¼šï¼‰çµ„ã¿åˆã‚ã›æ±ºå®šã®ãŠçŸ¥ã‚‰ã›ã€ã¨ã™ã‚‹ã€‚
- æœ¬æ–‡ã§ã¯ã€æŠ½é¸ä¼šãŒè¡Œã‚ã‚ŒãŸã“ã¨ã¨ã€ä¸Šè¨˜ã®çµ„ã¿åˆã‚ã›ãŒæ±ºå®šã—ãŸã“ã¨ã‚’å ±å‘Šã—ã¦ãã ã•ã„ã€‚
- **ã€é‡è¦ã€‘ä¸æˆ¦å‹ï¼ˆBYEï¼‰ã®ãƒãƒ¼ãƒ ã«ã¤ã„ã¦:**
  - ã€Œè¦å®šã«ã‚ˆã‚Š1å›æˆ¦ã¯å…é™¤ã•ã‚Œã€2å›æˆ¦ã‹ã‚‰ã®ç™»å ´ã¨ãªã‚‹ã€ã“ã¨ã‚’æ˜è¨˜ã—ã¦ãã ã•ã„ã€‚
  - ã€Œæ—¥ç¨‹çš„ãªä½™è£•ã‚’æ´»ã‹ã—ã€ä¸‡å…¨ã®çŠ¶æ…‹ã§åˆæˆ¦ï¼ˆ2å›æˆ¦ï¼‰ã«è‡¨ã¿ã¾ã™ã€ã¨ã„ã£ãŸãƒã‚¸ãƒ†ã‚£ãƒ–ãªè¡¨ç¾ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
- æœ€å¾Œã«ã€ç³»åˆ—æ ¡é‡çƒéƒ¨ã¸ã®å¿œæ´ã‚’ãŠé¡˜ã„ã™ã‚‹è¨€è‘‰ã§ç· ã‚ããã‚‹ã€‚
- å…¨ä½“çš„ã«ã€ä¼æ¥­ã®å…¬å¼ç™ºè¡¨ã¨ã—ã¦ãµã•ã‚ã—ã„ã€ä¸å¯§ã§ãƒ•ã‚©ãƒ¼ãƒãƒ«ãªæ–‡ä½“ã«ã™ã‚‹ã“ã¨ã€‚

### å‡ºåŠ›å½¢å¼
ä»¥ä¸‹ã®JSONå½¢å¼ã§ã€ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
{"title": "è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«", "body": "è¨˜äº‹ã®æœ¬æ–‡ï¼ˆæ”¹è¡Œã¯\\nã‚’ä½¿ç”¨ï¼‰"}`;

    } else if (type === 'matchResult') {
        // (è©¦åˆçµæœã®ãŠçŸ¥ã‚‰ã›ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
        const { winnerName, loserName, dbMatch } = matchData;
        const isCivilWar = (winnerName === '283å­¦åœ’' && loserName === '283å­¦åœ’B') || (winnerName === '283å­¦åœ’B' && loserName === '283å­¦åœ’');

        const namcoTeam = namcoSchools.includes(winnerName) ? winnerName : loserName;
        const opponent = namcoSchools.includes(winnerName) ? loserName : winnerName;
        const result = namcoSchools.includes(winnerName) ? 'å‹åˆ©' : 'æ•—åŒ—';
        const score = namcoSchools.includes(winnerName) ? `${dbMatch.score1}-${dbMatch.score2}` : `${dbMatch.score2}-${dbMatch.score1}`;

        prompt = `ã‚ãªãŸã¯ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã®åºƒå ±æ‹…å½“è€…ã§ã™ã€‚
æœ¬æ—¥è¡Œã‚ã‚ŒãŸã€å¤ã®é«˜æ ¡é‡çƒé¸æ‰‹æ¨©å¤§ä¼šã®è©¦åˆçµæœã«ã¤ã„ã¦ã€å…¬å¼ã‚µã‚¤ãƒˆã«æ²è¼‰ã™ã‚‹ã€ŒãŠçŸ¥ã‚‰ã›ã€è¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### è©¦åˆæƒ…å ±
- ç³»åˆ—æ ¡: ${namcoTeam}
- å¯¾æˆ¦ç›¸æ‰‹: ${opponent}
- çµæœ: ${namcoTeam}ã®${result}
- ã‚¹ã‚³ã‚¢: ${score}

### è¨˜äº‹ã®ãƒã‚¤ãƒ³ãƒˆ
- ã‚¿ã‚¤ãƒˆãƒ«ã¯ã€Œé‡çƒéƒ¨ï¼ˆå¤ã®é¸æ‰‹æ¨©å¤§ä¼šï¼‰è©¦åˆçµæœã®ãŠçŸ¥ã‚‰ã›ã€ã¨ã™ã‚‹ã€‚
- æœ¬æ–‡ã§ã¯ã€ã¾ãšè©¦åˆãŒè¡Œã‚ã‚ŒãŸã“ã¨ã¨ã€çµæœã‚’ç°¡æ½”ã«å ±å‘Šã™ã‚‹ã€‚
- **ã‚‚ã—å‹åˆ©ã—ãŸå ´åˆ:**
  - å¿œæ´ã¸ã®æ„Ÿè¬ã‚’è¿°ã¹ã€æ¬¡ã®è©¦åˆã¸ã®æ„æ°—è¾¼ã¿ã‚’èªã‚‹ï¼ˆä¾‹ï¼šã€Œæ¬¡æˆ¦ã‚‚ãƒãƒ¼ãƒ ä¸€ä¸¸ã¨ãªã£ã¦å‹åˆ©ã‚’ç›®æŒ‡ã—ã¾ã™ã€ï¼‰ã€‚
- **ã‚‚ã—æ•—åŒ—ã—ãŸå ´åˆ:**
  - é¸æ‰‹ãŸã¡ã®å¥é—˜ã‚’ç§°ãˆã€å¿œæ´ã¸ã®æ„Ÿè¬ã‚’æ·±ãè¿°ã¹ã‚‹ï¼ˆä¾‹ï¼šã€Œçš†æ§˜ã®ç†±ã„å£°æ´ãŒã€é¸æ‰‹ã®åŠ›ã¨ãªã‚Šã¾ã—ãŸã€‚å¿ƒã‚ˆã‚Šæ„Ÿè¬ç”³ã—ä¸Šã’ã¾ã™ã€ï¼‰ã€‚
  - æ–°ãƒãƒ¼ãƒ ã§ã®å†èµ·ã‚’èª“ã†è¨€è‘‰ã§ç· ã‚ããã‚‹ã€‚
- å…¨ä½“çš„ã«ã€ä¼æ¥­ã®å…¬å¼ç™ºè¡¨ã¨ã—ã¦ãµã•ã‚ã—ã„ã€ä¸å¯§ã§ãƒ•ã‚©ãƒ¼ãƒãƒ«ãªæ–‡ä½“ã«ã™ã‚‹ã“ã¨ã€‚

### å‡ºåŠ›å½¢å¼
ä»¥ä¸‹ã®JSONå½¢å¼ã§ã€ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
{"title": "è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«", "body": "è¨˜äº‹ã®æœ¬æ–‡ï¼ˆæ”¹è¡Œã¯\\nã‚’ä½¿ç”¨ï¼‰"}`;
    }

    if (!prompt) return null;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const newsJson = parseJsonFromText(rawText);
            if (newsJson) {
                return { ...newsJson, timestamp: Date.now() };
            }
        }
        throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã—ãŸå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    } catch (error) {
        console.error("ãƒŠãƒ ã‚³ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return null;
    }
}

/**
 * AIãŒç”Ÿæˆã—ãŸæ–°èãƒ‡ãƒ¼ã‚¿ã‹ã‚‰HTMLã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…sinbun.txtã‚’å‚è€ƒã«ã€Webãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹é¢¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«å¤‰æ›´)
 */
function createNewspaperHtml(articleData, matchData) {
    const { winnerName, loserName, dbMatch, matchId } = matchData;
    const idParts = matchId.split('-');
    // 128ãƒãƒ¼ãƒ åˆ¶(7ãƒ©ã‚¦ãƒ³ãƒ‰)ã«å¯¾å¿œ
    const roundNum = idParts[0] === 'F' ? Math.log2(tournamentState.teams.length) : parseInt(idParts[1].slice(1));
    const isLateRound = roundNum >= 5; // R5(æº–ã€…æ±ºå‹)ä»¥é™
    const containerClass = isLateRound ? 'newspaper-late' : 'newspaper-early';
    const winnerScore = dbMatch.team1 === winnerName ? dbMatch.score1 : dbMatch.score2;
    const loserScore = dbMatch.team1 === winnerName ? dbMatch.score2 : dbMatch.score1;

    // AIãŒç”Ÿæˆã—ãŸæœ¬æ–‡(article.body)ã‚’ã€æœ€åˆã®æ®µè½ï¼ˆãƒªãƒ¼ãƒ‰æ–‡ï¼‰ã¨æ®‹ã‚Šã®æœ¬æ–‡ã«åˆ†å‰²ã™ã‚‹
    let bodyText = articleData.body.replace(/\\n/g, '\n');
    let leadSentence = articleData.title; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚µãƒ–è¦‹å‡ºã—(h2)ã¯è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«
    let mainBody = bodyText;

    const firstParagraphBreak = bodyText.indexOf('\n\n'); // æœ€åˆã®ç©ºè¡Œï¼ˆæ®µè½åŒºåˆ‡ã‚Šï¼‰ã‚’æ¢ã™
    if (firstParagraphBreak !== -1) {
        // æœ€åˆã®ç©ºè¡Œã¾ã§ã‚’ãƒªãƒ¼ãƒ‰æ–‡ã¨ã™ã‚‹
        leadSentence = bodyText.substring(0, firstParagraphBreak).trim();
        // ãã‚Œä»¥é™ã‚’æœ¬æ–‡ã¨ã™ã‚‹
        mainBody = bodyText.substring(firstParagraphBreak).trim();
    } else {
        // æ®µè½åŒºåˆ‡ã‚ŠãŒãªã„å ´åˆã€AIãŒç”Ÿæˆã—ãŸè¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«(article.title)ã‚’ãƒªãƒ¼ãƒ‰æ–‡ã¨ã—ã¦ä½¿ç”¨
        mainBody = bodyText;
        leadSentence = articleData.title;
    }
    
    // sinbun.txt [cite: 63, 65] ã‚’å‚è€ƒã«ã€å†™çœŸã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
    // AIãŒç”Ÿæˆã—ãŸ newspaperData ã‹ã‚‰ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
    const photoCaption = articleData.newspaperData?.photoCaption || `[${getRoundNameFromMatchId(matchId)}ã®æ§˜å­]`;

    // sinbun.txt  ã‚’å‚è€ƒã«ã€AIãŒç”Ÿæˆã—ãŸå¤§è¦‹å‡ºã— (newspaperData.mainHeadline) ã‚’å–å¾—
    const mainHeadline = articleData.newspaperData?.mainHeadline || `${winnerName}ã€${loserName}ã‚’ä¸‹ã—${getRoundNameFromMatchId(matchId)}çªç ´`;

    return `
        <div class="newspaper-container ${containerClass}">
            <div class="newspaper-header">
                <h2 class="newspaper-title">ç†±é—˜ã‚¹ãƒãƒ¼ãƒ„</h2>
                <p class="newspaper-date">${new Date(articleData.timestamp).toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
            </div>
            
            <div class="newspaper-content">
                <h1 class="newspaper-main-headline">${mainHeadline}</h1>
                
                <h2 class="newspaper-sub-headline">${leadSentence}</h2>
                
                ${isLateRound ? `
                    <figure class="newspaper-image-wrapper">
                        <div class="newspaper-image-placeholder">${photoCaption}</div>
                        <figcaption class="newspaper-image-caption">${photoCaption}ï¼ˆã‚«ãƒ¡ãƒ©ãƒ»AIè¨˜è€…ï¼‰</figcaption>
                    </figure>
                ` : ''}
                
                <p class="newspaper-text">${mainBody.replace(/\n/g, '<br><br>')}</p>
                
                <div class="newspaper-score-box">
                    <h3>${getRoundNameFromMatchId(matchId)} æœ€çµ‚ã‚¹ã‚³ã‚¢</h3>
                    <p class="score">${winnerName} ${winnerScore} - ${loserScore} ${loserName}</p>
                </div>
            </div>
        </div>
    `;
}

/**
 * [UPDATED] AIã‚¹ãƒãƒ¼ãƒ„æ–°èè¨˜äº‹ã®ç”Ÿæˆ
 * (â˜…ãƒãƒ¼ãƒ æ•°ã«å¿œã˜ã¦ãƒ©ã‚¦ãƒ³ãƒ‰åã‚’å‹•çš„ã«åˆ¤å®š)
 */
async function generateSportsNewspaper(roundNumber) {
    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ãƒãƒ¼ãƒ æ•°ã‹ã‚‰ãƒ©ã‚¦ãƒ³ãƒ‰åãƒãƒƒãƒ—ã‚’ä½œæˆ â˜…â˜…â˜…
    const numTeams = tournamentState.teams.length; 
    const finalRound = Math.log2(numTeams); // 128->7, 64->6

    const roundNameMap = {
        [finalRound]: 'æ±ºå‹',
        [finalRound-1]: 'æº–æ±ºå‹',
        [finalRound-2]: 'æº–ã€…æ±ºå‹',
        [finalRound-3]: '4å›æˆ¦' // ç”²å­åœ’ã®å ´åˆã¯3å›æˆ¦ã«ãªã‚‹ãŒã€å®Ÿè³ªãƒ™ã‚¹ãƒˆ16æ±ºå®šæˆ¦
    };
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    const roundName = roundNameMap[roundNumber] || `${roundNumber}å›æˆ¦`;
    // R1, R2ãªã©ãƒãƒƒãƒ—ã«ãªã„ãƒ©ã‚¦ãƒ³ãƒ‰ã¯ã‚¹ã‚­ãƒƒãƒ—(nullã‚’è¿”ã™)
    // ãŸã ã—ç”²å­åœ’(64ãƒãƒ¼ãƒ )ã®å ´åˆã€[finalRound-3]ã¯ã€Œ3å›æˆ¦ã€ã«ãªã‚‹ãŸã‚ã€ç™ºè¡Œå¯¾è±¡ã¨ã™ã‚‹
    if (!roundNameMap[roundNumber]) return null; 

    const matchIdsInRound = Object.keys(tournamentState.matches).filter(id => 
        (id.includes(`-R${roundNumber}-`)) || (roundNumber === finalRound && id.includes('F-R1-'))
    );
    const results = matchIdsInRound.map(id => tournamentState.matches[id]);

    const resultsText = results.map(match => {
        if (!match.winner) return null;
        const winnerRank = getRankDescription(calculateRank(match.winner, tournamentState));
        const loser = match.team1 === match.winner ? match.team2 : match.team1;
        if (!loser) return null;
        const loserRank = getRankDescription(calculateRank(loser, tournamentState));
        const winnerScore = match.team1 === match.winner ? match.score1 : match.score2;
        const loserScore = match.team1 === match.winner ? match.score2 : match.score1;
        return `${winnerRank}ãƒ»${match.winner}ãŒ${loserRank}ãƒ»${loser}ã« ${winnerScore}-${loserScore} ã§å‹åˆ©ã€‚`;
    }).filter(Boolean).join('\n');

    if (!resultsText) return null;

    const prompt = `ã‚ãªãŸã¯ã€èª­è€…ã®è³¼è²·æ„æ¬²ã‚’æ»ãç«‹ã¦ã‚‹ã®ãŒå¾—æ„ãªã€æ—¥æœ¬ã®ã‚¹ãƒãƒ¼ãƒ„æ–°èã®ç·¨é›†é•·ã§ã™ã€‚
ç¾åœ¨ã€é«˜æ ¡é‡çƒã®${tournamentState.tournamentYear}å¹´åº¦${tournamentNameMap[tournamentState.currentTournament]}ãŒé€²è¡Œä¸­ã§ã™ã€‚${roundName}ã®å…¨è©¦åˆãŒçµ‚äº†ã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®è©¦åˆçµæœã‚’åŸºã«ã€æœ€ã‚‚è¡æ’ƒçš„ã§ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãªå‡ºæ¥äº‹ã‚’ä¸€ã¤é¸ã³å‡ºã—ã€ãã‚Œã«å¯¾å¿œã™ã‚‹æ–°èã®ä¸€é¢ã‚’é£¾ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### ${roundName} å…¨è©¦åˆçµæœ
${resultsText}

### ã‚ãªãŸãŒä½œæˆã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
ä»¥ä¸‹ã®4ã¤ã®è¦ç´ ã‚’ã€JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
1.  **mainHeadline**: æœ€ã‚‚é‡è¦ãªçµæœã‚’ä¼ãˆã‚‹ã€çŸ­ãã€è¡æ’ƒçš„ã§ã€æ‰‡æƒ…çš„ãªå¤§è¦‹å‡ºã—ã€‚ï¼ˆä¾‹ï¼šã€Œæ€ªç‰©æ•£ã‚‹ï¼ã€ã€Œç‹è€…ã€ç›¤çŸ³ã®æ±ºå‹ã¸ã€ï¼‰
2.  **subHeadline**: mainHeadlineã‚’è£œè¶³ã™ã‚‹ã€å°‘ã—è©³ã—ã„å°è¦‹å‡ºã—ã€‚
3.  **photoCaption**: ãã®æ—¥ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒ³ã‚’åˆ‡ã‚Šå–ã£ãŸæ¶ç©ºã®å†™çœŸã«å¯¾ã™ã‚‹ã€æƒ…æ™¯ãŒç›®ã«æµ®ã‹ã¶ã‚ˆã†ãªã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã€‚ï¼ˆä¾‹ï¼šã€Œã‚ã¨ä¸€æ­©åŠã°ãšã€ãƒã‚¦ãƒ³ãƒ‰ã«å´©ã‚Œè½ã¡ã‚‹ã€‡ã€‡é«˜æ ¡ã®ã‚¨ãƒ¼ã‚¹â–³â–³ã€ï¼‰
4.  **otherResults**: ãã®ä»–ã®æ³¨ç›®ã™ã¹ãçµæœã‚’2ã¤ã€ç°¡æ½”ã«ã¾ã¨ã‚ãŸã‚‚ã®ã€‚

### å‡ºåŠ›å½¢å¼
{"mainHeadline": "...", "subHeadline": "...", "photoCaption": "...", "otherResults": ["...", "..."]}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const newspaperData = parseJsonFromText(rawText);
            if (newspaperData) return newspaperData;
        }
        throw new Error("AI newspaper response format error.");
    } catch (error) {
        console.error("AI newspaper generation failed:", error);
        return null;
    }
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

   /**
     * ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†æ™‚ã«æ–°èç™ºè¡Œãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹
     * (â˜…128ãƒãƒ¼ãƒ åˆ¶ï¼7ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¶ã«å¯¾å¿œ)
     */
    async function handleRoundCompletion(roundNumber) {
        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
        const numTeams = tournamentState.teams.length; // 128
        const finalRound = Math.log2(numTeams); // 7

        // R4, R5, R6, R7(æ±ºå‹) ã§ç™ºè¡Œ
        const significantRounds = [finalRound, finalRound - 1, finalRound - 2, finalRound - 3].filter(r => r > 0);
        if (!significantRounds.includes(roundNumber)) return;

        // â˜… æ—¢ã«ã€Œã“ã®å¤§ä¼šã®ã€ã€Œã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã€ã®æ–°èãŒç™ºè¡Œæ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
        const alreadyExists = tournamentState.news.some(n => 
            n.roundNumber === roundNumber && 
            n.isNewspaper &&
            n.context?.tournament === tournamentState.currentTournament // å¤§ä¼šã‚­ãƒ¼ã‚‚ãƒã‚§ãƒƒã‚¯
        );
        if (alreadyExists) return;

        const newspaperData = await generateSportsNewspaper(roundNumber);
        if (newspaperData) {
            // 128ãƒãƒ¼ãƒ åˆ¶(7ãƒ©ã‚¦ãƒ³ãƒ‰)ã®ãƒ©ã‚¦ãƒ³ãƒ‰åãƒãƒƒãƒ—
            const roundNameMap = {
                [finalRound]: 'æ±ºå‹',       // R7
                [finalRound-1]: 'æº–æ±ºå‹',   // R6
                [finalRound-2]: 'æº–ã€…æ±ºå‹', // R5
                [finalRound-3]: '4å›æˆ¦'     // R4
            };
            // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…
            const roundName = roundNameMap[roundNumber] || `${roundNumber}å›æˆ¦`;

            tournamentState.news.push({
                title: `ã€ç†±é—˜æ–°èã€‘${roundName}ç‰¹é›†å·ãŒç™ºè¡Œã•ã‚Œã¾ã—ãŸï¼`,
                body: newspaperData.subHeadline,
                timestamp: Date.now(),
                isNewspaper: true,
                roundNumber: roundNumber,
                newspaperData: newspaperData,
                context: { // â˜… å†ç”Ÿæˆã‚„è­˜åˆ¥ç”¨ã«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
                    isNewspaper: true,
                    round: roundNumber,
                    tournament: tournamentState.currentTournament
                }
            });
            renderNews(tournamentState.news);
            saveState();
        }
    }
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

    /**
     * æ–°èãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æç”»ã™ã‚‹
     */
    function renderNewspaperModal(newspaperData) {
        const { mainHeadline, subHeadline, photoCaption, otherResults, imageUrl } = newspaperData;
        
        const imageHtml = imageUrl 
            ? `<img src="${imageUrl}" alt="${photoCaption}" class="w-full h-auto my-4 border">` 
            : `<div class="newspaper-image-placeholder my-4"><p class="text-sm p-4">${photoCaption}</p></div>`;

        newspaperModalBody.innerHTML = `
            <div class="newspaper-container newspaper-late">
                <div class="newspaper-header">
                    <h2 class="newspaper-title">ç†±é—˜ã‚¹ãƒãƒ¼ãƒ„</h2>
                    <p class="newspaper-date">${new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
                <div class="newspaper-content">
                    <h1 class="newspaper-main-headline">${mainHeadline}</h1>
                    <div class="newspaper-body-content">
                        <h2 class="newspaper-sub-headline">${subHeadline}</h2>
                        ${imageHtml}
                        <div class="newspaper-score-box">
                            <h3>ãã®ä»–ã®ä¸»ãªçµæœ</h3>
                            ${otherResults.map(r => `<p>${r}</p>`).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

  /**
 * AIã«æ²ç¤ºæ¿ã®è¿”ä¿¡ã‚’ç”Ÿæˆã•ã›ã‚‹ï¼ˆæœ€æ–°ã®ç’°å¢ƒã«é©åˆã—ãŸæœ€çµ‚ç‰ˆï¼‰
 * (â˜…ãƒãƒ¼ãƒ ã€Œé€šç®—ã€ç›—å¡ã¸ã®è¨€åŠæŒ‡ç¤ºã‚’è¿½åŠ ã—ãŸæœ€çµ‚ç‰ˆ)
 */
async function generateBbsReply(parentCommentId, userReplyText, bbsType, aiPersona, context) {
    const commentSource = bbsType === 'general' ? tournamentState.bbsComments : tournamentState.daiyaBbsComments;
    const parentComment = findCommentById(commentSource, parentCommentId);
    if (!parentComment) return null;

    // --- 1. AIã«æ¸¡ã™ãŸã‚ã®ã€Œæ–‡è„ˆã€ã‚’åé›†ã™ã‚‹ ---
    const userReplyObject = { id: 'temp_user_reply', personality: 'ã‚ãªãŸ', text: userReplyText, replies: [] };
    parentComment.replies.push(userReplyObject);
    const conversationHistory = formatConversationHistory(commentSource, 'temp_user_reply');
    parentComment.replies.pop();

    const mentionedTeams = new Set();
    conversationHistory.split('\n').forEach(line => {
        INITIAL_TEAM_POOL.forEach(team => {
            if (line.includes(team)) {
                mentionedTeams.add(team);
            }
        });
    });

    // --- 2. AIã«ä¸ãˆã‚‹ã€ŒçŸ¥è­˜ã€ã®éƒ¨åˆ†ã‚’ä½œæˆã™ã‚‹ ---
    let teamInfoPromptPart = '';
    if (mentionedTeams.size > 0) {
        teamInfoPromptPart = '### é–¢é€£ãƒãƒ¼ãƒ ã®èƒŒæ™¯æƒ…å ±\n';
        mentionedTeams.forEach(teamName => {
            const teamData = TEAM_DATA[teamName];
            const teamRecord = tournamentState.teamRecords[teamName];
            const dynamicInfo = generateDynamicTeamInfo(teamName, teamData, teamRecord); // â˜…æ‰“ç‡ãƒ»é€šç®—ç›—å¡å…¥ã‚Šã®æƒ…å ±ã‚’å–å¾—
            teamInfoPromptPart += `- **${teamName}**: ${dynamicInfo}\n`;
        });
    }
    
    // â–¼â–¼â–¼ â˜…â˜…â˜… Gamelogå–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ  â˜…â˜…â˜… â–¼â–¼â–¼
    // ä¼šè©±å…¨ä½“ï¼ˆè¦ªã‚³ãƒ¡ãƒ³ãƒˆï¼‹ã‚ãªãŸã®è¿”ä¿¡ï¼‰ã‹ã‚‰é¸æ‰‹åã‚’ã‚¹ã‚­ãƒ£ãƒ³
    const fullConversationText = `${parentComment.text}\n${userReplyText}`;
    teamInfoPromptPart += formatPlayerGamelogsForPrompt(mentionedTeams, fullConversationText);
    // â–²â–²â–²
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
    // --- 3. æœ€çµ‚çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ç«‹ã¦ã‚‹ï¼ˆâ˜…è„±ç·šé˜²æ­¢ç­–ã‚’é©ç”¨ï¼‰ ---
    const prompt = `ã‚ãªãŸã¯ã€åŒ¿åæ²ç¤ºæ¿ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€Œ${aiPersona}ã€ã§ã™ã€‚ã‚ãªãŸã¯ä»Šã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æ—¥æœ¬ã®é«˜æ ¡é‡çƒã«ã¤ã„ã¦ä¼šè©±ã—ã¦ã„ã¾ã™ã€‚
ã‚ãªãŸã®å”¯ä¸€ã®ä»•äº‹ã¯ã€ä¼šè©±ã®æµã‚Œã¨ã‚ãªãŸã®çŸ¥è­˜ã«åŸºã¥ãã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ãªã‚Šãã£ã¦è‡ªç„¶ãªè¿”ä¿¡ã‚’ã™ã‚‹ã“ã¨ã§ã™ã€‚é‡çƒä»¥å¤–ã®è©±é¡Œã«ã¯çµ¶å¯¾ã«è§¦ã‚Œãªã„ã§ãã ã•ã„ã€‚
---
### **ã‚¹ãƒ†ãƒƒãƒ—1ï¼šç¾åœ¨ã®ä¼šè©±çŠ¶æ³ã‚’ç†è§£ã™ã‚‹**
- **ã“ã‚Œã¾ã§ã®ä¼šè©±ã®æµã‚Œ**:
${conversationHistory}
- **ã‚ãªãŸã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼**: ${aiPersona}
- **ç¾åœ¨ã®å¤§ä¼šçŠ¶æ³**: ${context.tournamentSummary}
---
### **ã‚¹ãƒ†ãƒƒãƒ—2ï¼šé–¢é€£æƒ…å ±ã‚’æ€ã„å‡ºã™**
${teamInfoPromptPart}
---
### **ã‚¹ãƒ†ãƒƒãƒ—3ï¼šè¿”ä¿¡ã™ã‚‹**
ä¸Šè¨˜ã®ã‚¹ãƒ†ãƒƒãƒ—1ã¨2ã®æƒ…å ±ã‚’å…ƒã«ã€ä¼šè©±ã®æœ€å¾Œã®ç™ºè¨€ã€Œ${userReplyText}ã€ã«å¯¾ã—ã¦ã€ã‚ãªãŸã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã—ã¦æœ€ã‚‚è‡ªç„¶ã§çš„ã‚’å°„ãŸè¿”ä¿¡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
- **æŒ‡ç¤º**:
  - å¿…ãšç›¸æ‰‹ã®ç™ºè¨€ã«ç›´æ¥å¿œç­”ã™ã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ã‚‹ã“ã¨ã€‚
  - å¿œç­”ã®æ ¹æ‹ ã¨ã—ã¦ã€ã‚¹ãƒ†ãƒƒãƒ—2ã®ã€Œé–¢é€£æƒ…å ±ã€ã‚’è‡ªç„¶ãªå½¢ã§ä¼šè©±ã«å«ã‚ã‚‹ã“ã¨ã€‚
  - **ã€â˜…Gamelogã®æ´»ç”¨ (æœ€é‡è¦)ã€‘**:
      - ã€Œå‚è€ƒæƒ…å ±ï¼šä»Šå¤§ä¼šã®ä¸»ãªé¸æ‰‹æˆç¸¾å±¥æ­´ã€ã«ã€è¨€åŠã•ã‚ŒãŸé¸æ‰‹ã®**è©¦åˆã”ã¨ã®è©³ç´°ãªå±¥æ­´ (Gamelog)** ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
      - ã‚ãªãŸã®è¿”ä¿¡ã¯ã€ã“ã®**Gamelog**ã‚’åŸºã«ã€ä»¥ä¸‹ã®ç‚¹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
      - **å¥½ä¸èª¿ã®æ³¢**: ã€Œ3è©¦åˆé€£ç¶šãƒ’ãƒƒãƒˆä¸­ã€ã€Œ10æ‰“æ•°ãƒãƒ¼ãƒ’ãƒƒãƒˆã€ãªã©ã€é¸æ‰‹ã®**ã€Œèª¿å­ã®æ³¢ã€**ã‚’åˆ†æã™ã‚‹ã“ã¨ã€‚
      - **å¯¾æˆ¦ç›¸æ‰‹ã®è³ª**: ã€Œæ ¼ä¸‹[E]ç›¸æ‰‹ã«ã—ã‹æ‰“ã£ã¦ãªã„ã€ã€ŒAãƒ©ãƒ³ã‚¯[A]æŠ•æ‰‹ã‹ã‚‰æ‰“ã£ãŸã€ãªã©ã€**ã€Œç›¸æ‰‹ã®è³ªã€**ã‚’åˆ†æã™ã‚‹ã“ã¨ã€‚
      - **ç™»æ¿é–“éš”**: ã€Œé€£æŠ•ã€ã€Œä¸­1æ—¥ã€ãªã©ã€**ã€ŒæŠ•æ‰‹ã®ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã€**ã‚’åˆ†æã™ã‚‹ã“ã¨ã€‚
  - **ã€â˜…ä»Šå¤§ä¼šã®æˆç¸¾ (é‡è¦)ã€‘**:
      - ã€Œå‚è€ƒæƒ…å ±ã€ã«**ã€ä»Šå¤§ä¼šã®ãƒãƒ¼ãƒ æ‰“ç‡ã¯.XXXã€**ã¨ã„ã†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ãã‚Œã«ã‚‚è§¦ã‚Œã€ãƒãƒ¼ãƒ å…¨ä½“ã®å¥½èª¿ãƒ»ä¸æŒ¯ã«ã¤ã„ã¦è¨€åŠã™ã‚‹ã“ã¨ã€‚
  - **ã€â˜…é€šç®—ç›—å¡ã¸ã®è¨€åŠ (è£é‡)ã€‘**:
      - ã€Œå‚è€ƒæƒ…å ±ã€ã«**ã€(å‚è€ƒ: ... é€šç®— Y ç›—å¡)ã€**ã¨ã„ã†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€å¿…è¦ã«å¿œã˜ã¦ãã®ãƒãƒ¼ãƒ ã®æ©Ÿå‹•åŠ›ã«ã‚‚è¨€åŠã™ã‚‹ã“ã¨ã€‚
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
  - ç›¸æ‰‹ãŒè©±ã—ã¦ã„ãªã„ç„¡é–¢ä¿‚ãªãƒãƒ¼ãƒ ã‚„è©¦åˆã®æƒ…å ±ã‚’ä¸€æ–¹çš„ã«è§£èª¬ã—ãªã„ã“ã¨ã€‚
---
### **ã‚¹ãƒ†ãƒƒãƒ—4ï¼šå‡ºåŠ›å½¢å¼**
ã€æœ€é‡è¦ã€‘å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼"ã®ã¿"ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚è§£èª¬ã‚„å‰ç½®ãã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚
{"comment": "ï¼ˆã‚ãªãŸã®è¿”ä¿¡æœ¬æ–‡ï¼‰"}`;
    
    // --- 4. AIã‚’å‘¼ã³å‡ºã—ã€çµæœã‚’å‡¦ç†ã™ã‚‹ ---
    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const replyJson = parseJsonFromText(rawText);
            if (replyJson && replyJson.comment) {
                return {
                    id: crypto.randomUUID(),
                    personality: aiPersona,
                    text: replyJson.comment,
                    timestamp: Date.now(),
                    replies: []
                };
            }
        }
        throw new Error("AIã®å¿œç­”å½¢å¼ãŒä¸æ­£ã§ã™ã€‚");
    } catch (error) {
        console.error("AIè¿”ä¿¡ã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return null;
    }
}


/**
     * AIã‹ã‚‰ã®å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å®‰å…¨ã«æŠ½å‡ºã™ã‚‹
     */
    function parseJsonFromText(text) {
        try {
            const cleanedText = text.replace(/```json/g, '').replace(/```/g, '').trim();
            const jsonMatch = cleanedText.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            }
        } catch (e) {
            console.error("Failed to parse JSON from text:", text, e);
        }
        return null;
    }

    /**
     * ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API(Netlify Function)ã‚’å‘¼ã³å‡ºã™
     */
    async function fetchWithRetry(payload, maxRetries = 3) {
        const functionUrl = '/.netlify/functions/generateApiContent'; // Netlify Functionã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
        let lastError;

        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    return response;
                }
                
                if (response.status >= 400 && response.status < 500 && response.status !== 429) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error}`);
                }

                lastError = new Error(`API Error: ${response.status}`);
                const delay = Math.pow(2, i) * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));

            } catch (error) {
                lastError = error;
                const delay = Math.pow(2, i) * 1000;
                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        throw lastError;
    }

    /**
     * ãƒãƒ¼ãƒ ãƒ©ãƒ³ã‚¯ï¼ˆAï½Eï¼‰ã‹ã‚‰èª¬æ˜çš„ãªæ–‡å­—åˆ—ã‚’å–å¾—ã™ã‚‹
     */
    function getRankDescription(rank) {
        switch(rank) {
            case 'A': return 'åé–€æ ¡';
            case 'B': return 'å¼·è±ªæ ¡';
            case 'C': return 'ä¸­å …æ ¡';
            case 'D': return 'ç™ºå±•é€”ä¸Šã®ãƒãƒ¼ãƒ ';
            case 'E': return 'æŒ‘æˆ¦è€…';
            default: return 'å®ŸåŠ›ä¸æ˜';
        }
    }
    
/**
     * [NEW HELPER] é¸æ‰‹ã®ã€Œä»Šå¤§ä¼šã€ã®é€šç®—æˆç¸¾ã‚’è¨ˆç®—ã™ã‚‹
     */
    function calculateCurrentTournamentStats(battingGamelogs = [], pitchingGamelogs = [], excludeMatchId) {
        const currentTournamentKey = tournamentState.currentTournament;
        let stats = { AB: 0, H: 0, AVG: 0, IP: 0, ER: 0, ERA: Infinity };
        const isCurrentTournamentLog = (log) => {
            if (log.matchId === excludeMatchId) return false;
            const logRound = log.round || '';
            if (currentTournamentKey === 'summer') return logRound.includes('å›æˆ¦') || logRound.includes('æ±ºå‹');
            if (currentTournamentKey === 'summer_koshien') return true; // ç”²å­åœ’
            if (currentTournamentKey === 'autumn') return logRound.includes('åœ°åŒº') || logRound.includes('å›æˆ¦') || logRound.includes('æ±ºå‹');
            if (currentTournamentKey === 'spring') return logRound.includes('åœ°åŒº') || logRound.includes('å›æˆ¦') || logRound.includes('æ±ºå‹');
            return false;
        };
        if (battingGamelogs) {
            battingGamelogs.filter(isCurrentTournamentLog).forEach(log => {
                stats.AB += log.stats?.ab || 0;
                stats.H += log.stats?.h || 0;
            });
            stats.AVG = (stats.AB > 0) ? (stats.H / stats.AB) : 0;
        }
        if (pitchingGamelogs) {
            pitchingGamelogs.filter(isCurrentTournamentLog).forEach(log => {
                stats.IP += parseFloat(log.ip) || 0;
                stats.ER += parseInt(log.er) || 0;
            });
            stats.ERA = (stats.IP > 0) ? ((stats.ER * 9) / stats.IP) : Infinity;
        }
        return stats;
    }

/**
 * [NEW] é¸æ‰‹ã®èª¿å­ãƒ•ãƒ©ã‚°ã‚’çµµæ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ã«å¤‰æ›ã™ã‚‹
 * (â˜…ã€Œè»½å‚·[ğŸ©¹]ã€ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ )
 */
function getPlayerConditionIcon(flag) {
    if (!flag) return "";
    
    // â˜…â˜…â˜… æ•…éšœãƒ»ä½“èª¿ä¸è‰¯ (æœ€å„ªå…ˆ) â˜…â˜…â˜…
    if (flag === "injured" || flag === "sick") { // é‡å‚·/ç—…æ°—
        return '<span class="condition-icon" title="æ•…éšœä¸­/ä½“èª¿ä¸è‰¯ (èµ·ç”¨ä¸å¯)">ğŸ¥</span>';
    }
    if (flag === "minor_injury") { // è»½å‚·
        return '<span class="condition-icon" title="è»½ã„æ€ªæˆ‘ (æ¬¡æˆ¦èµ·ç”¨ä¸å¯)">ğŸ©¹</span>';
    }
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    // 5æ®µéšè©•ä¾¡
    if (flag === "peak") return '<span class="condition-icon" title="çµ¶å¥½èª¿">ğŸ”¥</span>';
    if (flag === "hot" || flag === "hot_streak") return '<span class="condition-icon" title="å¥½èª¿">ğŸ‘</span>';
    if (flag === "cold" || flag === "slumping") return '<span class="condition-icon" title="ä¸èª¿">â„ï¸</span>';
    if (flag === "slump") return '<span class="condition-icon" title="çµ¶ä¸èª¿">ğŸ¥¶</span>';
    
    // ç‰¹æ®Šãƒ•ãƒ©ã‚°
    if (flag === "fatigued") return '<span class="condition-icon" title="ç–²åŠ´">ğŸ˜“</span>';
    if (flag === "powered_up") return '<span class="condition-icon" title="ä¸€ç™ºè­¦æˆ’">ğŸ’ª</span>';
    if (flag === "clutch_hitter") return '<span class="condition-icon" title="å‹è² å¼·ã„">âœ¨</span>';
    if (flag === "dominant") return '<span class="condition-icon" title="åœ§å·»">ğŸ”¥</span>';
    if (flag === "crafty_pitcher") return '<span class="condition-icon" title="æŠ€å·§æ´¾">ğŸ‘</span>';
    if (flag === "seeking_redemption") return '<span class="condition-icon" title="è¦ä¿®æ­£">â„ï¸</span>';
    if (flag === "tough_loss" || flag === "unlucky") return '<span class="condition-icon" title="ä¸é‹">ğŸ˜“</span>';
    
    return ""; // 'normal' ã‚„ä¸æ˜ãªãƒ•ãƒ©ã‚°ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
     * ãƒãƒ¼ãƒ åã‹ã‚‰ã‚·ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚¯ã®æ–‡å­—åˆ— (ä¾‹: "(ç¬¬1ã‚·ãƒ¼ãƒ‰)") ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
     * @param {string} teamName - ãƒãƒ¼ãƒ å
     * @param {Array<object>} seeds - tournamentState.seeds (ã‚·ãƒ¼ãƒ‰æ ¡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—)
     * @returns {string} - "(ç¬¬1ã‚·ãƒ¼ãƒ‰)" ã¾ãŸã¯ ""
     */
    function getSeedRankString(teamName, seeds) {
        if (!seeds || !teamName) return '';
        // seeds é…åˆ—ãŒ { team: "...", rank: 1 } ã®å½¢å¼ã§ã‚ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
        const seedInfo = seeds.find(s => s.team === teamName);
        return seedInfo ? `(ç¬¬${seedInfo.rank}ã‚·ãƒ¼ãƒ‰)` : '';
    }

    /**
 * Generates a team's tournament path history, compatible with all tournament types.
 */
function getTournamentPath(teamName, startingMatchId) {
    if (!teamName) return "ï¼ˆä¸æ˜ï¼‰";
    const path = [];
    
    // Combine all matches from all tournaments into one list
    const allMatches = { 
        ...tournamentState.matches, 
        ...(tournamentState.autumnData?.allMatches || {}),
        ...(tournamentState.springData?.allMatches || {}) 
    };

    // Determine the current round number to analyze up to that point
    const idParts = startingMatchId.split('-');
    if (idParts.length < 3) return 'ï¼ˆåœ°åŒºäºˆé¸çªç ´ï¼‰'; // Not a main tournament match
    let currentRoundNum = parseInt(idParts[1].slice(1));

    // Loop from the first round up to the current round
    for (let r = 1; r < currentRoundNum; r++) {
        // Find the match the team won in that round
        const matchInRound = Object.values(allMatches).find(match =>
            match.id && 
            match.id.includes(`-R${r}-`) && // Belongs to the correct round
            match.winner === teamName
        );

        if (matchInRound) {
            const opponent = matchInRound.team1 === teamName ? matchInRound.team2 : matchInRound.team1;
            const winnerScore = matchInRound.team1 === teamName ? matchInRound.score1 : matchInRound.score2;
            const loserScore = matchInRound.team1 === teamName ? matchInRound.score2 : matchInRound.score1;
            path.push(`${r}å›æˆ¦ vs ${opponent} (${winnerScore}-${loserScore})`);
        }
    }

    return path.length > 0 ? path.join(' â†’ ') : 'ï¼ˆä»Šå¤§ä¼šåˆæˆ¦ï¼‰';
}
    /**
     * AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã«ã€ãƒãƒ¼ãƒ ã®æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹æƒ…å ±ã‚’ç”Ÿæˆã™ã‚‹
     */
    /**
 * Generates the next opponent info, compatible with all tournament structures.
 */
function getNextOpponentInfoForPrompt(teamName) {
    // Combine all matches from all tournaments into one list
    const allMatches = { 
        ...tournamentState.matches, 
        ...(tournamentState.autumnData?.allMatches || {}),
        ...(tournamentState.springData?.allMatches || {}) 
    };

    let latestMatch = null;
    let maxRound = -1;

    // Find the most recent game this team played in
    for (const matchId in allMatches) {
        const match = allMatches[matchId];
        if (match.team1 === teamName || match.team2 === teamName) {
            const roundNum = match.id.includes('-R') ? parseInt(match.id.split('-')[1].slice(1)) : 0;
            if (roundNum > maxRound) {
                maxRound = roundNum;
                latestMatch = match;
            }
        }
    }

    if (!latestMatch) return "ï¼ˆã¾ã è©¦åˆãªã—ï¼‰";
    if (latestMatch.winner !== teamName) return "ï¼ˆã“ã®è©¦åˆã§æ•—é€€ï¼‰";
    
    // Find the next game this team is in
    for (const matchId in allMatches) {
        const match = allMatches[matchId];
        
        // Look for a future game where this team is slotted but the opponent is not yet decided
        if ((match.team1 === teamName && !match.team2) || (match.team2 === teamName && !match.tran1)) {
             return "ï¼ˆæ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã¯æœªå®šï¼‰";
        }
        
        // Look for a future game where the opponent is known
        if (match.team1 === teamName && match.team2 && !match.winner) {
             return `æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã¯${match.team2}ã§ã™ã€‚`;
        }
        if (match.team2 === teamName && match.team1 && !match.winner) {
            return `æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã¯${match.team1}ã§ã™ã€‚`;
        }
    }

    return "ï¼ˆå„ªå‹ã€ã¾ãŸã¯æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸ï¼‰";
}
    /**
     * AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã«ã€æ²ç¤ºæ¿ã®ä¼šè©±å±¥æ­´ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹
     */
    function formatConversationHistory(comments, targetId) {
        let history = [];
        function findPath(currentComments, currentPath) {
            for(const comment of currentComments) {
                const newPath = [...currentPath, comment];
                if(comment.id === targetId) {
                    history = newPath;
                    return true;
                }
                if(comment.replies && findPath(comment.replies, newPath)) {
                    return true;
                }
            }
            return false;
        }
        findPath(comments, []);
        return history.map(c => `${c.personality}:ã€Œ${c.text}ã€`).join('\n');
    }

    /**
     * [UPDATED] AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã«ã€ç¾åœ¨ã®å¤§ä¼šçŠ¶æ³ã®è¦ç´„ã‚’ç”Ÿæˆã™ã‚‹
     * (â˜…ãƒãƒ¼ãƒ æ•°ã«å¿œã˜ã¦ãƒ©ã‚¦ãƒ³ãƒ‰åã‚’å‹•çš„ã«åˆ¤å®š)
     */
    function getTournamentStatusSummary() {
        if (tournamentState.currentTournament === 'autumn') {
            return `ç¾åœ¨ã€${tournamentState.tournamentYear}å¹´åº¦ ç§‹å­£å¤§ä¼šãŒé€²è¡Œä¸­ã§ã™ã€‚ãƒ•ã‚§ãƒ¼ã‚º: ${tournamentState.autumnPhase}`;
        }
        
        const finalMatch = tournamentState.matches['F-R1-M1'];
        if (finalMatch?.winner) return `${finalMatch.winner}ãŒå„ªå‹ã—ã¾ã—ãŸã€‚`;
        if (finalMatch?.team1 && finalMatch.team2) return `æ±ºå‹æˆ¦ã®çµ„ã¿åˆã‚ã›ã¯ ${finalMatch.team1} vs ${finalMatch.team2} ã§ã™ã€‚`;
        
        // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: å‹•çš„ãªãƒ©ã‚¦ãƒ³ãƒ‰ãƒãƒƒãƒ—ä½œæˆ â˜…â˜…â˜…
        const numTeams = tournamentState.teams.length;
        const finalRound = Math.log2(numTeams); 
        
        // ãƒãƒƒãƒ—ã‚’å‹•çš„ã«ç”Ÿæˆ
        const roundNameMap = {};
        roundNameMap[finalRound] = "æ±ºå‹";
        roundNameMap[finalRound - 1] = "æº–æ±ºå‹";
        roundNameMap[finalRound - 2] = "æº–ã€…æ±ºå‹";
        // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

        for (let r = finalRound - 1; r >= 1; r--) {
            const roundIds = Object.keys(tournamentState.matches).filter(id => id.includes(`-R${r}-`));
            // ã¾ã å‹è€…ãŒæ±ºã¾ã£ã¦ã„ãªã„è©¦åˆãŒã‚ã‚‹ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’æ¢ã™
            if (roundIds.some(id => tournamentState.matches[id]?.team1 && tournamentState.matches[id]?.team2 && !tournamentState.matches[id].winner)) {
                 return `ç¾åœ¨ã€${roundNameMap[r] || r + 'å›æˆ¦'}ãŒé€²è¡Œä¸­ã§ã™ã€‚`;
            }
            // å…¨è©¦åˆçµ‚ã‚ã£ãŸãƒ©ã‚¦ãƒ³ãƒ‰ã®ã€Œæ¬¡ã€ã‚’æ¢ã™ãƒ­ã‚¸ãƒƒã‚¯ã‚‚å¿…è¦ã ãŒã€
            // ç°¡æ˜“çš„ã«ã€Œã‚«ãƒ¼ãƒ‰ãŒçµ„ã¾ã‚Œã¦ã„ã‚‹æœ€ã‚‚æ·±ã„ãƒ©ã‚¦ãƒ³ãƒ‰ã€ã‚’è¿”ã™ãƒ­ã‚¸ãƒƒã‚¯ã§ååˆ†
        }
        
        return 'å¤§ä¼šã¯ã¾ã‚‚ãªãé–‹å§‹ã•ã‚Œã¾ã™ã€‚';
    }
    /**
     * IDã‚’å…ƒã«ã€å…¥ã‚Œå­æ§‹é€ ã®ã‚³ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç‰¹å®šã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¤ã‘å‡ºã™
     */
    function findCommentById(comments, id) {
        for (const comment of comments) {
            if (comment.id === id) return comment;
            if (comment.replies && comment.replies.length > 0) {
                const found = findCommentById(comment.replies, id);
                if (found) return found;
            }
        }
        return null;
    }

// â–¼â–¼â–¼ ãƒãƒ¼ãƒãƒ£ãƒ«ã‚«ãƒ¼ãƒ‰æ©Ÿèƒ½ç”¨ãƒ­ã‚¸ãƒƒã‚¯ (æ–°è¦è¿½åŠ ) â–¼â–¼â–¼

// â–¼â–¼â–¼ ã€æ”¹ä¿®ç‰ˆã€‘ãƒãƒ¼ãƒãƒ£ãƒ«ã‚«ãƒ¼ãƒ‰ï¼†æ ¡ç« ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼

/**
 * ãƒãƒ¼ãƒ åã¨info(ç´¹ä»‹æ–‡)ã‚’è§£æã—ã€æœ€é©ãªãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ±ºå®šã™ã‚‹
 * @param {string} name - ãƒãƒ¼ãƒ å
 * @param {string} info - ãƒãƒ¼ãƒ ç´¹ä»‹æ–‡
 */
function analyzeTeamTheme(name, info) {
    const text = (name + info).toLowerCase(); // æ¤œç´¢å¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆ

    // 1. ç‰¹åˆ¥æŒ‡å®š (ãƒ¦ãƒ‹ãƒ¼ã‚¯æ ¡)
    if (name.includes("283")) return { css: "theme-ocean", icon: "ğŸª¶", initial: "ç¿¼" }; // ç¿¼
    if (name.includes("765")) return { css: "theme-royal", icon: "ğŸ‘‘", initial: "765" };
    if (name.includes("åˆæ˜Ÿ")) return { css: "theme-idol", icon: "â­", initial: "æ˜Ÿ" };
    if (name.includes("ã‚ªã‚¤ã‚¹ã‚«")) return { css: "theme-nature", icon: "ğŸŒ", initial: "O" };
    if (name.includes("è™åºœå³¶")) return { css: "theme-ocean", icon: "ğŸ¯", initial: "è™" }; // è™ï¼‹å³¶
    if (name.includes("æµœæ¾ç‰¹æ”¯")) return { css: "theme-nature", icon: "ğŸŒ±", initial: "ç‰¹" };

    // 2. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã«ã‚ˆã‚‹ãƒ†ãƒ¼ãƒæ±ºå®š
    
    // ğŸŒŠ æµ·ãƒ»æ°´ç³»
    if (text.includes("æ°´ç”£") || text.includes("æµ·") || text.includes("æ¸¯") || text.includes("å³¶") || text.includes("æ¹–") || text.includes("æ²¼") || text.includes("æ³¢") || text.includes("æµœ") || text.includes("æ´¥")) {
        let icon = "ğŸŒŠ";
        if (text.includes("æ°´ç”£") || text.includes("é­š")) icon = "ğŸŸ";
        if (text.includes("èˆ¹") || text.includes("æ¸¯")) icon = "âš“";
        return { css: "theme-ocean", icon: icon, initial: name.charAt(0) };
    }

    // ğŸ”¥ ç«ãƒ»ç†±è¡€ç³»
    if (text.includes("é£›é¾") || text.includes("ç†±") || text.includes("é™½") || text.includes("æ—¥") || text.includes("ç´…") || text.includes("èµ¤") || text.includes("æ”»æ’ƒ")) {
        let icon = "ğŸ”¥";
        if (text.includes("é¾") || text.includes("ç«œ")) icon = "ğŸ‰";
        if (text.includes("æ—¥") || text.includes("é™½")) icon = "â˜€ï¸";
        return { css: "theme-fire", icon: icon, initial: name.charAt(0) };
    }

    // âš™ï¸ å·¥æ¥­ãƒ»æŠ€è¡“ç³»
    if (text.includes("å·¥æ¥­") || text.includes("æŠ€è¡“") || text.includes("é«˜å°‚") || text.includes("ç§‘å­¦") || text.includes("é‰„")) {
        let icon = "âš™ï¸";
        if (text.includes("ç§‘å­¦") || text.includes("ãƒ‡ãƒ¼ã‚¿")) icon = "ğŸ“ˆ";
        return { css: "theme-tech", icon: icon, initial: name.includes("å·¥æ¥­") ? "å·¥" : name.charAt(0) };
    }

    // ğŸŒ² è‡ªç„¶ãƒ»è¾²æ¥­ç³»
    if (text.includes("è¾²æ¥­") || text.includes("è¾²") || text.includes("å±±") || text.includes("æ£®") || text.includes("æ—") || text.includes("æ¾") || text.includes("ç·‘") || text.includes("è‘‰") || text.includes("èŠ")) {
        let icon = "ğŸŒ²";
        if (text.includes("è¾²æ¥­") || text.includes("è¾²")) icon = "ğŸŒ¾";
        if (text.includes("å±±") || text.includes("å²³")) icon = "â›°ï¸";
        if (text.includes("è‘‰") || text.includes("èŠ") || text.includes("èŒ¶")) icon = "ğŸƒ";
        return { css: "theme-nature", icon: icon, initial: name.includes("è¾²æ¥­") ? "è¾²" : name.charAt(0) };
    }

    // ğŸ¯ å•†æ¥­ãƒ»çŒ›ç£ç³» (é»„è‰²ãƒ»ã‚´ãƒ¼ãƒ«ãƒ‰)
    if (text.includes("å•†æ¥­") || text.includes("å•†") || text.includes("è™") || text.includes("ç…å­") || text.includes("æ˜Ÿ") || text.includes("é‡‘")) {
        let icon = "ğŸ’°"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå•†æ¥­
        if (text.includes("è™")) icon = "ğŸ¯";
        if (text.includes("æ˜Ÿ")) icon = "â­";
        return { css: "theme-tiger", icon: icon, initial: name.includes("å•†æ¥­") ? "å•†" : name.charAt(0) };
    }

    // ğŸ‘‘ ç‹è€…ãƒ»ä¼çµ±ãƒ»åé–€ (ç´«ãƒ»ãƒ­ã‚¤ãƒ¤ãƒ«)
    if (text.includes("é™å²¡") || text.includes("è–éš·") || text.includes("å¸ç‹") || text.includes("ç‹") || text.includes("çš‡") || text.includes("ç´«")) {
        return { css: "theme-royal", icon: "ğŸ›¡ï¸", initial: name.charAt(0) };
    }

    // ğŸŒ¸ ãã®ä»–ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (åå‰ã®ãƒãƒƒã‚·ãƒ¥ã§è‰²ã‚’åˆ†æ•£)
    const colors = ["theme-ocean", "theme-fire", "theme-nature", "theme-royal"];
    let hash = 0;
    for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
    const randomTheme = colors[Math.abs(hash) % colors.length];
    
    return { css: randomTheme, icon: "âš¾", initial: name.charAt(0) };
}

// ãƒãƒ¼ãƒ ãƒ­ã‚´ã¨ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° (ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç‰ˆ)
function showVirtualTeamCard(teamName) {
    const overlay = document.getElementById('virtual-card-overlay');
    const card = document.getElementById('virtual-card');
    const data = TEAM_DATA[teamName];
    const record = tournamentState.teamRecords[teamName];

    if (!data || !record) return;

    // ãƒ©ãƒ³ã‚¯è¨ˆç®—
    const rank = calculateRank(teamName, tournamentState);
    let rankColor = '#6b7280'; // E
    if(rank === 'A') rankColor = '#ef4444'; // èµ¤
    if(rank === 'B') rankColor = '#f97316'; // ã‚ªãƒ¬ãƒ³ã‚¸
    if(rank === 'C') rankColor = '#eab308'; // é»„
    if(rank === 'D') rankColor = '#3b82f6'; // é’

    // â˜…â˜…â˜… ã“ã“ã§AIãƒ‡ã‚¶ã‚¤ãƒ³ç”Ÿæˆã‚’å®Ÿè¡Œ â˜…â˜…â˜…
    const theme = analyzeTeamTheme(teamName, data.info || "");
    
    // çŸ­ã„ç´¹ä»‹æ–‡ç”Ÿæˆ
    let shortInfo = data.info.split('ã€‚')[0] + 'ã€‚';
    if (shortInfo.length > 50) shortInfo = shortInfo.substring(0, 50) + '...';

    // æˆç¸¾æ¦‚è¦
    const wins = record.wins || 0;
    const bestResult = record.best ? getRankString(record.best.rank) : 'ãªã—';
    
    // ç›£ç£æƒ…å ±
    const coachName = data.coach ? data.coach.name : 'ä¸æ˜';
    const coachStyle = data.coach ? data.coach.style : '---';

    // HTMLç”Ÿæˆ
    card.innerHTML = `
        <span class="card-rank-badge" style="background-color: ${rankColor}; box-shadow: 0 0 10px ${rankColor};">RANK ${rank}</span>
        
        <div class="generated-logo ${theme.css}">
            <span class="logo-icon">${theme.icon}</span>
            <span class="logo-initial">${theme.initial}</span>
        </div>

        <h3 class="card-team-name">${teamName}</h3>
        <p class="text-xs text-gray-500 font-bold mb-3 tracking-widest uppercase">
            ${data.region} AREA / ${data.type} SCHOOL
        </p>
        
        <p class="card-info-text border-t border-b border-gray-200 py-3 mx-2">
            ${shortInfo}
        </p>

        <div class="card-stats-grid">
            <div class="card-stat-item">
                <span class="card-stat-label">ç›£ç£ãƒ»é‡‡é…</span>
                <span class="card-stat-value text-sm">${coachName}</span>
                <span class="text-xs text-gray-500">(${coachStyle})</span>
            </div>
            <div class="card-stat-item">
                <span class="card-stat-label">æœ€é«˜æˆç¸¾</span>
                <span class="card-stat-value text-sm">${bestResult}</span>
            </div>
        </div>

        <div class="card-actions">
            <button id="vcard-close-btn" class="bg-gray-100 text-gray-600 px-5 py-2 rounded-full font-bold hover:bg-gray-200 transition text-sm">é–‰ã˜ã‚‹</button>
            <button id="vcard-detail-btn" class="bg-gradient-to-r from-blue-600 to-blue-500 text-white px-8 py-2 rounded-full font-bold hover:from-blue-700 hover:to-blue-600 transition shadow-md transform hover:scale-105 text-sm" data-team-name="${teamName}">
                ãƒ‡ãƒ¼ã‚¿å®¤ã¸
            </button>
        </div>
    `;

    // è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    overlay.classList.remove('hidden');
    requestAnimationFrame(() => {
        overlay.classList.add('active');
    });

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('vcard-detail-btn').onclick = (e) => {
        e.stopPropagation();
        closeVirtualCard();
        showTeamStatusModal(teamName);
    };
    document.getElementById('vcard-close-btn').onclick = (e) => {
        e.stopPropagation();
        closeVirtualCard();
    };
}
// â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

// ã‚«ãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹é–¢æ•°
function closeVirtualCard() {
    const overlay = document.getElementById('virtual-card-overlay');
    overlay.classList.remove('active');
    setTimeout(() => {
        overlay.classList.add('hidden');
    }, 300); // CSSã®transitionæ™‚é–“ã¨åˆã‚ã›ã‚‹
}

// ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('virtual-card-overlay').addEventListener('click', (e) => {
    if (e.target === document.getElementById('virtual-card-overlay')) {
        closeVirtualCard();
    }
});
// â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// â–¼â–¼â–¼ ã“ã®é–¢æ•°ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã€Œæ–°è¦è¿½åŠ ã€(11843è¡Œç›®ã‚ãŸã‚Š) â–¼â–¼â–¼

/**
 * [NEW] E/D/Cãƒ©ãƒ³ã‚¯ãƒãƒ¼ãƒ ã®ã€Œå¿«é€²æ’ƒã€ã‚’è®ƒãˆã‚‹ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãªè¨˜äº‹ã‚’AIã«ç”Ÿæˆã•ã›ã‚‹
 * (â˜…å†ç”Ÿæˆç”¨ã« context ã¸ã®æƒ…å ±ä¿å­˜ã‚’å¼·åŒ–)
 * @param {string} loserName - æ•—é€€ã—ãŸãƒãƒ¼ãƒ å
 * @param {string} loserRank - æ•—é€€ã—ãŸãƒãƒ¼ãƒ ã®ãƒ©ãƒ³ã‚¯ (E, D, C)
 * @param {number} roundNum - æ•—é€€ã—ãŸãƒ©ã‚¦ãƒ³ãƒ‰ç•ªå· (3, 4, 5)
 * @param {object} matchContext - è©¦åˆã®å…¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
 * @returns {Promise<object>} - ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
async function generateCinderellaArticle(loserName, loserRank, roundNum, matchContext) {
    const { loserJourney, winnerName, dbMatch } = matchContext;
    const loserScore = (dbMatch.team1 === loserName ? dbMatch.score1 : dbMatch.score2);
    const winnerScore = (dbMatch.team1 === loserName ? dbMatch.score2 : dbMatch.score1);
    
    const rankMap = { 'E': 'Eãƒ©ãƒ³ã‚¯', 'D': 'Dãƒ©ãƒ³ã‚¯', 'C': 'Cãƒ©ãƒ³ã‚¯' };
    const roundMap = { 3: '3å›æˆ¦', 4: '4å›æˆ¦', 5: 'æº–ã€…æ±ºå‹' };
    const storyTitle = `${rankMap[loserRank]}ãƒ»${loserName}ã®å¿«é€²æ’ƒã€${roundMap[roundNum]}ã§æ•£ã‚‹ã€‚`;

    const prompt = `ã‚ãªãŸã¯ã€æƒ…ç†±çš„ã§äººé–“ãƒ‰ãƒ©ãƒã‚’æãã®ãŒå¾—æ„ãªã‚¹ãƒãƒ¼ãƒ„è¨˜è€…ã§ã™ã€‚
ã‚ãªãŸã¯ä»Šã€${tournamentState.tournamentYear}å¹´åº¦ å¤å­£å¤§ä¼šã§ã€ä¿¡ã˜ã‚‰ã‚Œãªã„ã»ã©ã®ã€Œå¿«é€²æ’ƒ(ã‚·ãƒ³ãƒ‡ãƒ¬ãƒ©ã‚¹ãƒˆãƒ¼ãƒªãƒ¼)ã€ã‚’è¦‹ã›ãŸãƒãƒ¼ãƒ ã®ã€æœ€å¾Œã®è©¦åˆã‚’å–æã—çµ‚ãˆã¾ã—ãŸã€‚
ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€å½¼ã‚‰ã®å¥é—˜ã‚’æœ€å¤§é™ã«ã€Œè¤’ã‚ç§°ãˆã‚‹ã€ã€æ„Ÿå‹•çš„ãªç‰¹é›†è¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚

### å–æãƒ‡ãƒ¼ã‚¿
- **ä¸»å½¹ï¼ˆæ•—é€€ãƒãƒ¼ãƒ ï¼‰:** ${loserName} (${rankMap[loserRank]})
- **å¿«é€²æ’ƒã®è»Œè·¡:** ${loserJourney}
- **æœ€å¾Œã®è©¦åˆ:** ${roundMap[roundNum]}ã€${winnerName}ã« ${loserScore}-${winnerScore} ã§æ•—é€€ã€‚
- **ãƒãƒ¼ãƒ ã®èƒŒæ™¯:** ${TEAM_DATA[loserName]?.info || 'æƒ…å ±ãªã—'}
- **ç›£ç£:** ${TEAM_DATA[loserName]?.coach?.name || 'ç›£ç£'}

### åŸ·ç­†æŒ‡ç¤º
1.  **ã‚¿ã‚¤ãƒˆãƒ«:** ã€Œ${storyTitle}ã€ã®ã‚ˆã†ãªã€å½¼ã‚‰ã®æŒ‘æˆ¦ã‚’è®ƒãˆã‚‹æ„Ÿå‹•çš„ãªã‚¿ã‚¤ãƒˆãƒ«ã«ã—ã¦ãã ã•ã„ã€‚
2.  **è¨˜äº‹ã®ç„¦ç‚¹:** ã“ã®è¨˜äº‹ã®ä¸»å½¹ã¯**å‹è€…ã§ã¯ãªãã€æ•—ã‚ŒãŸ${loserName}**ã§ã™ã€‚
3.  **ã€æœ€é‡è¦ã€‘å‹ã¡ä¸ŠãŒã‚Šã®è»Œè·¡:**
    - ã€Œå¿«é€²æ’ƒã®è»Œè·¡ã€(${loserJourney})ã‚’å¿…ãšè¨˜äº‹ã«å«ã‚ã¦ãã ã•ã„ã€‚
    - ï¼ˆä¾‹ï¼šã€Œãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã®Eãƒ©ãƒ³ã‚¯æ ¡ã¨ã—ã¦é–‹å¹•ã—ãŸå½¼ã‚‰ã€‚1å›æˆ¦ã§ã€‡ã€‡ã‚’ã€2å›æˆ¦ã§æ ¼ä¸Šã®â–³â–³ã‚’ç ´ã‚Š...ã€ï¼‰
    - å½¼ã‚‰ãŒã€ŒEãƒ©ãƒ³ã‚¯ã€ã‚„ã€ŒDãƒ©ãƒ³ã‚¯ã€ã§ã‚ã‚ŠãªãŒã‚‰ã€ã“ã“ã¾ã§å‹ã¡ä¸ŠãŒã£ã¦ããŸã“ã¨ãŒã€ã©ã‚Œã»ã©ã®å‰æ¥­ã§ã‚ã£ãŸã‹ã‚’ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«æå†™ã—ã¦ãã ã•ã„ã€‚
4.  **æœ€å¾Œã®è©¦åˆ:** ä»Šæ—¥ã®æœ€å¾Œã®è©¦åˆãŒã€ã„ã‹ã«å½¼ã‚‰ãŒå…¨åŠ›ã‚’å‡ºã—åˆ‡ã£ãŸç´ æ™´ã‚‰ã—ã„æˆ¦ã„ã§ã‚ã£ãŸã‹ã‚’ã€ã‚¹ã‚³ã‚¢ï¼ˆ${loserScore}-${winnerScore}ï¼‰ã‚’äº¤ãˆã¦æå†™ã—ã¦ãã ã•ã„ã€‚
5.  **ç›£ç£ã¨é¸æ‰‹ã®ã‚³ãƒ¡ãƒ³ãƒˆ:**
    - è©¦åˆå¾Œã€æ³£ãå´©ã‚Œã‚‹é¸æ‰‹ãŸã¡ã€‚
    - ${TEAM_DATA[loserName]?.coach?.name || 'ç›£ç£'}ã®ã€ã€Œé¸æ‰‹ãŸã¡ã¯ç§ã®èª‡ã‚Šã ã€‚èƒ¸ã‚’å¼µã£ã¦åœ°å…ƒã«å¸°ã‚ã†ã€ã¨ã„ã£ãŸè¶£æ—¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰µä½œã—ã¦ãã ã•ã„ã€‚
    - ä¸»å°†ã®ã€ã€Œã“ã“ã¾ã§æ¥ã‚‰ã‚ŒãŸã®ã¯å¿œæ´ã®ãŠã‹ã’ã€‚æ‚”ã—ã„ãŒã€æ‚”ã„ã¯ãªã„ã€ã¨ã„ã£ãŸè¶£æ—¨ã®æ¶™ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰µä½œã—ã¦ãã ã•ã„ã€‚
6.  **ç· ã‚ããã‚Š:** ã€Œå½¼ã‚‰ã®å¤ã¯çµ‚ã‚ã£ãŸã€‚ã—ã‹ã—ã€${loserName}ãŒè¦‹ã›ãŸå¤¢ã¯ã€é™å²¡ã®ãƒ•ã‚¡ãƒ³ã®èƒ¸ã«ç¢ºã‹ã«åˆ»ã¾ã‚ŒãŸã€ã¨ã„ã£ãŸã€å½¼ã‚‰ã®æŒ‘æˆ¦ã‚’æ°¸é ã«è¨˜æ†¶ã™ã‚‹ã‹ã®ã‚ˆã†ãªã€æ„Ÿå‹•çš„ãªè¨€è‘‰ã§ç· ã‚ããã£ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼ (JSON)
{"title": "ï¼ˆã“ã“ã«è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼‰", "body": "ï¼ˆã“ã“ã«è¨˜äº‹ã®æœ¬æ–‡ï¼‰"}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (article) {
                return { 
                    ...article, 
                    timestamp: Date.now(),
                    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
                    context: { 
                        ...matchContext, 
                        isCinderellaStory: true, 
                        loserName: loserName, // loserName ã‚’æ˜ç¤ºçš„ã«ä¿å­˜
                        loserRank: loserRank, // loserRank ã‚’æ˜ç¤ºçš„ã«ä¿å­˜
                        roundNum: roundNum    // roundNum ã‚’æ˜ç¤ºçš„ã«ä¿å­˜
                    }
                    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…
                };
            }
        }
        throw new Error("AI cinderella response format error.");
    } catch (error) {
        console.error(`AIå¿«é€²æ’ƒè¨˜äº‹ï¼ˆ${loserName}ï¼‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:`, error);
        return { 
            title: "å¿«é€²æ’ƒ è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼", body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 
            timestamp: Date.now(), error: true, errorId: `cinderella-${matchContext.matchId}`,
            // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
            context: { 
                ...matchContext, 
                isCinderellaStory: true, 
                loserName: loserName, // loserName ã‚’æ˜ç¤ºçš„ã«ä¿å­˜
                loserRank: loserRank, // loserRank ã‚’æ˜ç¤ºçš„ã«ä¿å­˜
                roundNum: roundNum    // roundNum ã‚’æ˜ç¤ºçš„ã«ä¿å­˜
            }
            // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…
        };
    }
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * [UPDATED] ãƒ©ã‚¦ãƒ³ãƒ‰ãŒçµ‚äº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯ã—ã€AIæ–°èã®ç”Ÿæˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹
 * (â˜…ãƒãƒ¼ãƒ æ•°ã«å¿œã˜ã¦ç™ºè¡Œãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å‹•çš„ã«åˆ¤å®š)
 */
async function checkAndTriggerNewspaper(roundNum) {
    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ãƒãƒ¼ãƒ æ•°ã‹ã‚‰æœ€çµ‚ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’è¨ˆç®— â˜…â˜…â˜…
    const numTeams = tournamentState.teams.length; 
    const finalRound = Math.log2(numTeams); // 128->7, 64->6

    // æ–°èã‚’ç™ºè¡Œã™ã‚‹ãƒ©ã‚¦ãƒ³ãƒ‰ï¼šæ±ºå‹ã€æº–æ±ºå‹ã€æº–ã€…æ±ºå‹ã€ãã®1ã¤å‰(ãƒ™ã‚¹ãƒˆ16æ±ºå®šæˆ¦)
    // 128ãƒãƒ¼ãƒ åˆ¶: 7, 6, 5, 4
    // 64ãƒãƒ¼ãƒ åˆ¶ : 6, 5, 4, 3
    const significantRounds = [finalRound, finalRound - 1, finalRound - 2, finalRound - 3];
    
    if (!significantRounds.includes(roundNum)) return;
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    const alreadyExists = tournamentState.news.some(n => 
        n.roundNumber === roundNum && 
        n.isNewspaper &&
        n.context?.tournament === tournamentState.currentTournament
    );
    if (alreadyExists) return;

    let numMatchesInRound;
    let roundMatchIds;
    if (roundNum === finalRound) { // æ±ºå‹
        numMatchesInRound = 1;
        roundMatchIds = Object.keys(tournamentState.matches).filter(id => id.startsWith('F-R1-'));
    } else {
        numMatchesInRound = numTeams / Math.pow(2, roundNum);
        roundMatchIds = Object.keys(tournamentState.matches).filter(id => id.includes(`-R${roundNum}-M`));
    }

    const completedMatches = roundMatchIds.filter(id => tournamentState.matches[id].winner).length;

    if (completedMatches === numMatchesInRound) {
        console.log(`Round ${roundNum} complete! Generating Newspaper...`);
        
        const newspaperData = await generateSportsNewspaper(roundNum);
        
        if (newspaperData) {
            const roundName = getRoundNameFromMatchId(roundMatchIds[0]);
            
            tournamentState.news.push({
                title: `ã€ç†±é—˜æ–°èã€‘${roundName}ç‰¹é›†å·ãŒç™ºè¡Œã•ã‚Œã¾ã—ãŸï¼`,
                body: newspaperData.subHeadline,
                timestamp: Date.now(),
                isNewspaper: true,
                roundNumber: roundNum,
                newspaperData: newspaperData,
                context: {
                    isNewspaper: true,
                    round: roundNum,
                    tournament: tournamentState.currentTournament
                }
            });
            
            renderNews(tournamentState.news);
            saveState();
        }
    }
}

/**
 * [NEW] çµ‚äº†ã—ãŸãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ç·æ‹¬ã™ã‚‹ã€Œãªã‚“Jã¾ã¨ã‚ã‚¹ãƒ¬ãƒƒãƒ‰ã€ã‚’AIã«ç”Ÿæˆã•ã›ã‚‹
 * (â˜…currentTournamentæœªå®šç¾©ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£)
 */
async function generateRoundSummaryBbsThread(roundNum) {
    const state = tournamentState;
    const allMatches = state.matches;
    const numTeams = state.teams.length;
    const tournamentName = tournamentNameMap[state.currentTournament] || 'å¤§ä¼š';
    const roundName = getRoundNameFromMatchId(`L-R${roundNum}-M1`);
    
    if (roundNum >= Math.log2(numTeams) - 1) { // æº–æ±ºå‹(R6)ä»¥é™ã¯å¯¾è±¡å¤–
        return;
    }
    
    let analysisText = "";
    let upsets = [];
    let closeCalls = [];
    let notableNextMatchups = [];

    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
    const getTeamRank = (teamName) => calculateRank(teamName, state);
    
    const roundMatchIds = Object.keys(allMatches).filter(id => id.includes(`-R${roundNum}-M`));

    roundMatchIds.forEach(matchId => {
        const match = allMatches[matchId];
        if (!match.winner) return;
        const winner = match.winner;
        const loser = (match.team1 === winner) ? match.team2 : match.team1;
        if (!loser || loser === '(BYE)') return;
        const rankW = getTeamRank(winner);
        const rankL = getTeamRank(loser);
        const rankDiff = rankValues[rankW] - rankValues[rankL];
        const scoreW = Math.max(parseInt(match.score1) || 0, parseInt(match.score2) || 0);
        const scoreL = Math.min(parseInt(match.score1) || 0, parseInt(match.score2) || 0);
        if (rankDiff <= -2) {
            upsets.push(`${winner}(${rankW}) ãŒ ${loser}(${rankL}) ã‚’ ${scoreW}-${scoreL} ã§ç ´ã‚‹å¤§æ³¢ä¹±`);
        }
        else if ((rankW === 'A' || rankW === 'B') && (scoreW - scoreL <= 2)) {
            closeCalls.push(`${winner}(${rankW}) ãŒ ${loser}(${rankL}) ã« ${scoreW}-${scoreL} ã®è¾›å‹`);
        }
    });

    const nextRoundNum = roundNum + 1;
    const nextRoundMatchIds = Object.keys(allMatches).filter(id => id.includes(`-R${nextRoundNum}-M`));

    nextRoundMatchIds.forEach(matchId => {
        const match = allMatches[matchId];
        if (match.team1 && match.team2) {
            const rank1 = getTeamRank(match.team1);
            const rank2 = getTeamRank(match.team2);
            if ((rankValues[rank1] >= 4 && rankValues[rank2] >= 4) || (rankValues[rank1] >= 4 && rankValues[rank2] === 3) || (rankValues[rank1] === 3 && rankValues[rank2] >= 4)) {
                notableNextMatchups.push(`${match.team1}(${rank1}) vs ${match.team2}(${rank2})`);
            }
        }
    });

    analysisText += "### ä¸»ãªç•ªç‹‚ã‚ã› (ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒªãƒ³ã‚°)\n";
    analysisText += upsets.length > 0 ? upsets.map(s => `- ${s}`).join('\n') : "ç‰¹ã«ãªã—\n";
    analysisText += "\n### å¼·è±ªæ ¡ã®è‹¦æˆ¦ (æ¥æˆ¦)\n";
    analysisText += closeCalls.length > 0 ? closeCalls.map(s => `- ${s}`).join('\n') : "ç‰¹ã«ãªã—\n";
    analysisText += `\n### æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ (${getRoundNameFromMatchId(`L-R${nextRoundNum}-M1`)}) ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰\n`;
    analysisText += notableNextMatchups.length > 0 ? notableNextMatchups.map(s => `- ${s}`).join('\n') : "ç‰¹ã«ãªã—\n";

    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
    let tournamentContextPrompt = "";
    // `currentTournament` ã§ã¯ãªã `state.currentTournament` ã‚’ä½¿ç”¨
    if (state.currentTournament === 'summer') {
        tournamentContextPrompt = "3å¹´ç”Ÿã«ã¨ã£ã¦ã¯ã‚¬ãƒã§æœ€å¾Œã®å¤ã‚„ã€‚";
    } else if (state.currentTournament === 'autumn') {
        tournamentContextPrompt = "æ–°ãƒãƒ¼ãƒ ã®åˆé™£ã‚„ãªã€‚ã“ã“ã§ã®çµæœãŒã‚»ãƒ³ãƒãƒ„é¸è€ƒã«éŸ¿ãã§ã€‚";
    } else if (state.currentTournament === 'spring') {
        tournamentContextPrompt = "å¤ã®ã‚·ãƒ¼ãƒ‰æ¨©ãŒã‹ã‹ã£ãŸå‰å“¨æˆ¦ã‚„ã€‚";
    }
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    const prompt = `ã‚ãªãŸã¯ã€åŒ¿åæ²ç¤ºæ¿ã€Œãªã‚“ã§ã‚‚å®Ÿæ³Jï¼ˆãªã‚“Jï¼‰ã€ã®ä½æ°‘ã§ã™ã€‚ã‚ãªãŸã¯é«˜æ ¡é‡çƒã«è©³ã—ãã€ç…½ã‚Šã‚„ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚’äº¤ãˆãªãŒã‚‰ä¼šè©±ã‚’ç››ã‚Šä¸Šã’ã¾ã™ã€‚
${state.tournamentYear}å¹´åº¦ ${tournamentName}ã®ã€Œ${roundName}ã€ãŒå…¨è©¦åˆçµ‚äº†ã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®åˆ†æçµæœã«åŸºã¥ãã€**ãªã‚“Jã‚‰ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«**ã¨ã€ãã®ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã§ã®**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªåå¿œã‚³ãƒ¡ãƒ³ãƒˆã‚’20ã€œ25å€‹**ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### å¤§ä¼šã®æ–‡è„ˆ (æœ€é‡è¦)
${tournamentContextPrompt}

### å‚è€ƒæƒ…å ±ï¼šé™å²¡çœŒé«˜æ ¡é‡çƒã®ã€Œå¸¸è­˜ã€ï¼ˆå‹¢åŠ›å›³ï¼‰
${PREFECTURE_LORE}

### ${roundName} è©¦åˆçµæœã®åˆ†æ
${analysisText}

### ã‚ãªãŸãŒç”Ÿæˆã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã®æ–¹å‘æ€§
- **ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«:** ã€Œ${roundName}ãŒçµ‚ã‚ã£ãŸã‚ã‘ã‚„ãŒã€ã€ã¨ã„ã†ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å¿…ãšä½¿ã£ã¦ãã ã•ã„ã€‚
- **ã€â˜…å¤§ä¼šã®æ–‡è„ˆã‚’åæ˜ ã€‘**: ${tournamentName}ãªã‚‰ã§ã¯ã®è¦–ç‚¹ï¼ˆä¾‹ï¼šã€Œå¤ã¯3å¹´ç”Ÿæœ€å¾Œã‚„ãªã€ã€Œç§‹ã®æ–°ãƒãƒ¼ãƒ ã®ä»•ä¸ŠãŒã‚Šè¦‹ãˆã¦ããŸãªã€ã€Œæ˜¥ã§ã‚·ãƒ¼ãƒ‰å–ã‚Œã‚ˆã€ï¼‰ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã‚ã‚‹ã“ã¨ã€‚
- **åˆ†æçµæœã¸ã®åå¿œ:**
    - ã€Œä¸»ãªç•ªç‹‚ã‚ã›ã€ã«æ¿€ã—ãåå¿œã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€Œé™é«˜ãŒã¾ã•ã‹ã®å°ç¬ ã«è² ã‘ã¦ã¦è‰ã€ï¼‰
    - ã€Œå¼·è±ªæ ¡ã®è‹¦æˆ¦ã€ã«åå¿œã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€Œ283å­¦åœ’ãŒé™å²¡åŒ—ã«4-3ã¨ã‹å±ãªã™ããƒ¯ãƒ­ã‚¿ã€ï¼‰
    - ã€Œæ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰ã€ã«æœŸå¾…ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€Œæ¬¡ã®é™å•†ã¨ç¿”æ´‹ã®è©¦åˆã¯ã‚¬ãƒã§æ¥½ã—ã¿ã€ã€Œã€‡ã€‡ vs â–³â–³ã€äº‹å®Ÿä¸Šã®æ±ºå‹ã ã‚ã€ï¼‰
- **ãªã‚“Jã‚‰ã—ã•:**
    - çŸ­ã„ç…½ã‚Šãƒ¬ã‚¹ã€‚ã€Œã¯ï¼Ÿã€ã€Œé›‘é­šwã€ã€Œãƒ•ã‚¡ãƒ¼wwwã€
    - ä»–ã®ã‚³ãƒ¡ãƒ³ãƒˆã¸ã®å®‰ä¾¡ (>>) ä»˜ãã®è¿”ä¿¡ã‚„ãƒ„ãƒƒã‚³ãƒŸã€‚
    - è‡ªåˆ†ã®å¿œæ´ã—ã¦ã„ãŸãƒãƒ¼ãƒ ã®æ•—é€€ã‚’å˜†ãã‚³ãƒ¡ãƒ³ãƒˆï¼ˆæ¶ç©ºã§OKï¼‰ã€‚

### å‡ºåŠ›å½¢å¼ (JSON)
{
  "threadTitle": "ï¼ˆ${roundName}ãŒçµ‚ã‚ã£ãŸã‚ã‘ã‚„ãŒã€ã€‡ã€‡ã™ããƒ¯ãƒ­ã‚¿wwwï¼‰",
  "comments": [
    {"personality": "1: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆã‚¹ãƒ¬ä¸»ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"},
    {"personality": "2: é¢¨å¹ã‘ã°åç„¡ã—", "comment": "ï¼ˆä½æ°‘2ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"}
    // ... (åˆè¨ˆ20ã€œ25å€‹ã®ã‚³ãƒ¡ãƒ³ãƒˆ) ...
  ]
}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const bbsJson = parseJsonFromText(rawText);
            
            if (bbsJson && bbsJson.threadTitle && Array.isArray(bbsJson.comments)) {
                const threadId = `summary-thread-R${roundNum}-${state.currentTournament}`;
                return {
                    id: threadId,
                    title: bbsJson.threadTitle,
                    matchId: threadId,
                    comments: bbsJson.comments.map((c, index) => ({ 
                        id: crypto.randomUUID(),
                        personality: c.personality || `${index + 1}: é¢¨å¹ã‘ã°åç„¡ã—`, 
                        text: c.comment,
                        timestamp: Date.now() + index * 10, 
                        replies: [] 
                    })),
                    timestamp: Date.now(),
                    context: { isRoundSummary: true, round: roundNum }
                };
            }
        }
        throw new Error("AI round summary response format error.");
    } catch (error) {
        console.error(`AIãƒ©ã‚¦ãƒ³ãƒ‰ç·æ‹¬ã‚¹ãƒ¬ãƒƒãƒ‰(R${roundNum})ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:`, error);
        return null;
    }
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²


// â–¼â–¼â–¼ ã“ã®é–¢æ•°ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã€Œæ–°è¦è¿½åŠ ã€(11842è¡Œç›®ã‚ãŸã‚Š) â–¼â–¼â–¼

/**
 * [NEW] ãƒ©ã‚¦ãƒ³ãƒ‰ãŒçµ‚äº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯ã—ã€AIç·æ‹¬ã‚¹ãƒ¬ãƒƒãƒ‰ã®ç”Ÿæˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹
 * (â˜…R6(æº–æ±ºå‹)çµ‚äº†æ™‚ã«ã‚‚å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ä¿®æ­£)
 */
async function checkAndTriggerRoundSummary(roundNum) {
    const numTeams = tournamentState.teams.length; // 128
    const finalRound = Math.log2(numTeams); // 7
    
    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
    // R6(æº–æ±ºå‹) = 6ã€‚æ±ºå‹(R7) = 7ã€‚
    // R6çµ‚äº†æ™‚(roundNum=6)ã‚‚å®Ÿè¡Œã—ã€R7(æ±ºå‹)çµ‚äº†æ™‚(roundNum=7)ã¯å®Ÿè¡Œã—ãªã„ã€‚
    if (roundNum > (finalRound - 1)) { // (6 > 6) = false, (7 > 6) = true
        return;
    }
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…
    
    const threadId = `summary-thread-R${roundNum}-${tournamentState.currentTournament}`;
    
    if (tournamentState.matomeThreads[threadId]) {
        console.log(`Round ${roundNum} (${tournamentState.currentTournament}) summary thread already exists. Skipping.`);
        return;
    }

    const numMatchesInRound = numTeams / Math.pow(2, roundNum);
    const roundMatchIds = Object.keys(tournamentState.matches).filter(id => id.includes(`-R${roundNum}-M`));
    const completedMatches = roundMatchIds.filter(id => tournamentState.matches[id].winner).length;

    if (completedMatches === numMatchesInRound) {
        console.log(`Round ${roundNum} complete! Generating summary thread...`);
        
        const threadData = await generateRoundSummaryBbsThread(roundNum);
        
        if (threadData) {
            tournamentState.matomeThreads[threadData.id] = {
                thread: threadData.comments,
                context: threadData.context
            };
            
            const roundName = getRoundNameFromMatchId(`L-R${roundNum}-M1`);
            tournamentState.news.push({
                title: `ã€${tournamentNameMap[tournamentState.currentTournament]} ${roundName} ç·æ‹¬ã€‘${threadData.title}`,
                body: `AIãŒ${roundName}ã®å…¨è©¦åˆã‚’åˆ†æã—ã€ã¾ã¨ã‚ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç«‹ã¦ãŸã‚ˆã†ã§ã™ã€‚ã€Œã¾ã¨ã‚ã‚µã‚¤ãƒˆã€ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚`,
                timestamp: Date.now(),
                isMatomeLink: true,
                matomeThreadId: threadData.id
            });
            
            renderNews(tournamentState.news);
            console.log(`Round ${roundNum} summary thread generated and saved.`);
        }
    }
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * [NEW] é¸æ‰‹ã®ã€Œæ•…éšœã€ã‚„ã€Œã‚¢ã‚¯ã‚·ãƒ‡ãƒ³ãƒˆã€ã«é–¢ã™ã‚‹AIè¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…ã€Œè»½å‚·(accident_minor_injury)ã€ã‚·ãƒŠãƒªã‚ªã‚’è¿½åŠ )
 * (â˜…â˜… é¸æ‰‹ã®é‡è¦åº¦(importance)ã«å¿œã˜ã¦AIã®ãƒˆãƒ¼ãƒ³ã‚’å¤‰æ›´ â˜…â˜…)
 */
async function generateAccidentArticle(teamName, playerName, accidentType, context = {}, importance) {
    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
    let playerImportance = "æ§ãˆé¸æ‰‹";
    let toneInstruction = `
- **ãƒˆãƒ¼ãƒ³:** æ§ãˆé¸æ‰‹ã®é›¢è„±ã¨ã—ã¦ã€ãƒãƒ¼ãƒ ã«ã¨ã£ã¦ã¯ç—›æ‰‹ã§ã‚ã‚‹ã“ã¨ã‚’ä¼ãˆã¤ã¤ã‚‚ã€å†·é™ãªãƒˆãƒ¼ãƒ³ã§å ±ã˜ã¦ãã ã•ã„ã€‚
- ï¼ˆä¾‹ï¼šã€Œè²´é‡ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦åŠ›ãŒé›¢è„±ã€ã€Œãƒãƒ¼ãƒ ã®å±¤ãŒè©¦ã•ã‚Œã‚‹ã€ï¼‰`;

    if (importance === 'Shuryoku_Static' || importance === 'Shuryoku_Dynamic') {
        playerImportance = "ä¸»åŠ›é¸æ‰‹ï¼ˆã‚¨ãƒ¼ã‚¹ã€ä¸»å°†ã€ã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—ãªã©ï¼‰";
        toneInstruction = `
- **ãƒˆãƒ¼ãƒ³:** ãƒãƒ¼ãƒ ã®æ ¹å¹¹ã‚’æºã‚‹ãŒã™ã€Œå¤§å•é¡Œã€ã¨ã—ã¦ã€éå¸¸ã«æ·±åˆ»ãªãƒˆãƒ¼ãƒ³ã§å ±ã˜ã¦ãã ã•ã„ã€‚
- ï¼ˆä¾‹ï¼šã€Œ${teamName}ã«æ¿€éœ‡ï¼ã€ã€Œé€£è¦‡ã«æš—é›²ã€ã€Œå¤§é»’æŸ±ã€‡ã€‡ã€ç„¡å¿µã®é›¢è„±ã€ï¼‰`;
    } else if (importance === 'Regular_Dynamic') {
        playerImportance = "ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼é¸æ‰‹";
        toneInstruction = `
- **ãƒˆãƒ¼ãƒ³:** ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼é¸æ‰‹ã®é›¢è„±ã¨ã—ã¦ã€ãƒãƒ¼ãƒ ã®æˆ¦åŠ›ãƒ€ã‚¦ãƒ³ã‚’æ‡¸å¿µã™ã‚‹ãƒˆãƒ¼ãƒ³ã§å ±ã˜ã¦ãã ã•ã„ã€‚
- ï¼ˆä¾‹ï¼šã€Œ${playerName}ã®é›¢è„±ã¯ç—›ã„ã€ã€Œç›£ç£ã¯${playerName}ã®ä»£å½¹ã‚’èª°ã«ã™ã‚‹ã®ã‹ã€ï¼‰`;
    }
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    let prompt = `ã‚ãªãŸã¯ã€Œé™å²¡ ç†±é—˜ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ã€ã®ç·Šæ€¥é€Ÿå ±ãƒ‡ã‚¹ã‚¯ã§ã™ã€‚
${teamName}ã®${playerName}é¸æ‰‹ã«é–¢ã™ã‚‹ã€ãƒã‚¬ãƒ†ã‚£ãƒ–ãªã€Œã‚¢ã‚¯ã‚·ãƒ‡ãƒ³ãƒˆã€æƒ…å ±ãŒå…¥ã£ã¦ãã¾ã—ãŸã€‚
ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### å–æãƒ‡ãƒ¼ã‚¿
- **ãƒãƒ¼ãƒ :** ${teamName}
- **é¸æ‰‹:** ${playerName}
- **é¸æ‰‹ã®é‡è¦åº¦:** ${playerImportance}
- **ã‚¢ã‚¯ã‚·ãƒ‡ãƒ³ãƒˆç¨®åˆ¥:** ${accidentType}
- **é–¢é€£ãƒ‡ãƒ¼ã‚¿:** ${context.log || 'æƒ…å ±ãªã—'}
- **ç›£ç£:** ${TEAM_DATA[teamName]?.coach?.name || 'ç›£ç£'}

### åŸ·ç­†æŒ‡ç¤º
1.  **ã‚¿ã‚¤ãƒˆãƒ«:** è¡æ’ƒçš„ãªã‚¿ã‚¤ãƒˆãƒ«ã«ã—ã¦ãã ã•ã„ã€‚
    - (é…·ä½¿æ•…éšœã®å ´åˆ): ã€Œã€${teamName}ã«æ¿€éœ‡ã€‘ã‚¨ãƒ¼ã‚¹${playerName}ã€é€£æŠ•ã®å½±éŸ¿ã§èƒŒä¸­ã«å¼µã‚Šã‹ã€ã€Œ${playerName}ã€${context.round || 'æ¬¡æˆ¦'}ã®å‡ºå ´çµ¶æœ›çš„ã€
    - (ä½“èª¿ä¸è‰¯ã®å ´åˆ): ã€Œï¼ˆå·å¤–ï¼‰${teamName}ã«ã‚¢ã‚¯ã‚·ãƒ‡ãƒ³ãƒˆï¼ ${playerName}ã‚‰ä¸»åŠ›æ•°åãŒä½“èª¿ä¸è‰¯ã‚’è¨´ãˆç—…é™¢ã¸ã€
    - (HBPæ•…éšœã®å ´åˆ): ã€Œã€${teamName}ã€‘${playerName}ã€å‰è©¦åˆã®æ­»çƒã®å½±éŸ¿ã§éª¨æŠ˜ã‹ã€ã€Œ${playerName}ã€ç„¡å¿µã®æˆ¦ç·šé›¢è„±ã€
    - (è»½å‚·ã®å ´åˆ): ã€Œã€${teamName}ã€‘${playerName}ã€ç·´ç¿’ä¸­ã«è»½åº¦ã®æ»æŒ«ã€ã€Œ${context.log || 'å‰è©¦åˆã§ã®èµ°å¡'}ãŒå½±éŸ¿ã‹ã€‚${playerName}ã€æ¬¡æˆ¦ã¯å¤§äº‹ã‚’å–ã£ã¦æ¬ å ´ã¸ã€
2.  **æœ¬æ–‡:**
    - (é…·ä½¿æ•…éšœã®å ´åˆ): ${playerName}ãŒ${context.log || 'é€£æŠ•'}ã®å½±éŸ¿ã§ã€èº«ä½“ã®ç•°å¸¸ï¼ˆä¾‹ï¼šè‚©ã®é•å’Œæ„Ÿã€èƒŒä¸­ã®å¼µã‚Šï¼‰ã‚’è¨´ãˆãŸã“ã¨ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚ç›£ç£ãŒã€Œ${context.round || 'æ¬¡æˆ¦'}ã¯æŠ•ã’ã•ã›ãªã„ã€ã¨æ˜è¨€ã—ãŸã€ã¨ã„ã†ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰µä½œã—ã¦ãã ã•ã„ã€‚
    - (ä½“èª¿ä¸è‰¯ã®å ´åˆ): ${playerName}ãŒçªç™ºçš„ãªä½“èª¿ä¸è‰¯ï¼ˆä¾‹ï¼šé£Ÿä¸­æ¯’ã€é«˜ç†±ï¼‰ã«è¦‹èˆã‚ã‚Œã€æ¬¡æˆ¦ã®å‡ºå ´ãŒçµ¶æœ›çš„ã§ã‚ã‚‹ã“ã¨ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚
    - (HBPæ•…éšœã®å ´åˆ): ${playerName}ãŒã€${context.log || 'å‰å›ã®è©¦åˆ'}ã§å—ã‘ãŸæ­»çƒã®å½±éŸ¿ã«ã‚ˆã‚Šã€ç—…é™¢ã§ç²¾å¯†æ¤œæŸ»ã‚’å—ã‘ãŸã“ã¨ã‚’æå†™ã—ã¦ãã ã•ã„ã€‚æ¤œæŸ»ã®çµæœã€ã€Œå³æ‰‹ã®ç”²ï¼ˆã¾ãŸã¯è‚‹éª¨ï¼‰ã«ãƒ’ãƒ“ãŒå…¥ã£ã¦ãŠã‚Šã€ä»Šå¤§ä¼šã®å‡ºå ´ã¯çµ¶æœ›çš„ã€ã¨è¨ºæ–­ã•ã‚ŒãŸã€ã¨ã„ã†è¡æ’ƒçš„ãªå†…å®¹ã«ã—ã¦ãã ã•ã„ã€‚
    - (è»½å‚·ã®å ´åˆ): ${playerName}ãŒ${context.log || 'å‰å›ã®è©¦åˆã§ã®èµ°å¡'}ä¸­ã«è¶³é¦–ã‚’è»½åº¦æ»æŒ«ã—ãŸï¼ˆã¾ãŸã¯ç·´ç¿’ä¸­ã«è»½ã„è‚‰é›¢ã‚Œã‚’èµ·ã“ã—ãŸï¼‰ã¨ç™ºè¡¨ã€‚ç›£ç£ã¯ã€Œå¤§äº‹ã‚’å–ã£ã¦æ¬¡ã®è©¦åˆã¯ä¼‘ã¾ã›ã‚‹ã€ã¨ã‚³ãƒ¡ãƒ³ãƒˆã€‚
3.  **å½±éŸ¿:** ã“ã®é›¢è„±ãŒã€${teamName}ã®ä»Šå¾Œã«ã©ã‚Œã»ã©æ·±åˆ»ãªå½±éŸ¿ã‚’ä¸ãˆã‚‹ã‹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
4.  **ã€â˜…é‡è¦åº¦ã«å¿œã˜ãŸãƒˆãƒ¼ãƒ³ã®ä½¿ã„åˆ†ã‘â˜…ã€‘**
    ${toneInstruction}

### å‡ºåŠ›å½¢å¼ (JSON)
{"title": "ï¼ˆã“ã“ã«è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼‰", "body": "ï¼ˆã“ã“ã«è¨˜äº‹ã®æœ¬æ–‡ï¼‰"}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (article) {
                return { 
                    ...article, 
                    timestamp: Date.now(),
                    isAccident: true,
                    context: { teamName, playerName, accidentType, importance } // â˜…importanceã‚’ä¿å­˜
                };
            }
        }
        throw new Error("AI accident response format error.");
    } catch (error) {
        console.error(`AIã‚¢ã‚¯ã‚·ãƒ‡ãƒ³ãƒˆè¨˜äº‹ï¼ˆ${playerName}ï¼‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:`, error);
        return null;
    }
}



/**
 * AIã«ç”²å­åœ’ï¼ˆã¾ãŸã¯æ±æµ·å¤§ä¼šï¼‰ã®çµæœã‚’ç·æ‹¬ã™ã‚‹è¨˜äº‹ã‚’ç”Ÿæˆã•ã›ã‚‹
 */
async function generateKoshienSummaryArticle(teamName, resultLabel, type) {
    let context, titleInstruction;

    if (type === 'summer') {
        context = `å¤ã®ç”²å­åœ’ã€å…¨å›½ã®é ‚ç‚¹ã‚’ç›®æŒ‡ã—ãŸ${teamName}ã®æˆ¦ã„ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚`;
        titleInstruction = `ã€Œ${teamName}ã€è–åœ°ã§ã®æˆ¦ã„ã®è»Œè·¡ã€ã®ã‚ˆã†ãªã€å¤ã®çµ‚ã‚ã‚Šã‚’æ„Ÿã˜ã•ã›ã‚‹æ„Ÿå‹•çš„ãªã‚¿ã‚¤ãƒˆãƒ«ã«ã—ã¦ãã ã•ã„ã€‚`;
    } else if (type === 'spring') {
        context = `é¸æŠœé«˜æ ¡é‡çƒå¤§ä¼šã«å‡ºå ´ã—ãŸ${teamName}ã®æœ€çµ‚çµæœãŒç¢ºå®šã—ã¾ã—ãŸã€‚`;
        titleInstruction = `ã€Œ${teamName}ã€æ˜¥ã®è–åœ°ã«çˆªç—•ã€ã®ã‚ˆã†ã«ã€æ¥ãŸã‚‹å¤ã¸ã®æœŸå¾…ã‚’æ„Ÿã˜ã•ã›ã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã«ã—ã¦ãã ã•ã„ã€‚`;
    } else { // tokai
        context = `ç§‹å­£æ±æµ·å¤§ä¼šã§ã€é™å²¡çœŒä»£è¡¨ã®${teamName}ãŒè¦‹äº‹ãªæˆ¦ã„ã‚’è¦‹ã›ã¾ã—ãŸã€‚`;
        titleInstruction = `ã€Œ${teamName}ã€ã‚»ãƒ³ãƒãƒ„å½“ç¢ºï¼ã€ã®ã‚ˆã†ã«ã€é€Ÿå ±ã‚‰ã—ãã€å–œã³ãŒä¼ã‚ã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã«ã—ã¦ãã ã•ã„ã€‚`;
    }

    const prompt = `ã‚ãªãŸã¯ã€æƒ…ç†±çš„ãªé«˜æ ¡é‡çƒå°‚é–€ã®AIè¨˜è€…ã§ã™ã€‚
ä»¥ä¸‹ã®æƒ…å ±ã«åŸºã¥ãã€èª­è€…ã®å¿ƒã‚’æ‰“ã¤ã‚ˆã†ãªç·æ‹¬è¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### å¤§ä¼šçµæœ
- ãƒãƒ¼ãƒ : ${teamName}
- æœ€çµ‚æˆç¸¾: ${resultLabel}
- æ–‡è„ˆ: ${context}

### åŸ·ç­†æŒ‡ç¤º
- ${titleInstruction}
- ãƒãƒ¼ãƒ ã®ã“ã‚Œã¾ã§ã®åŠªåŠ›ã‚„ã€çœŒå¤§ä¼šã§ã®æˆ¦ã„ã¶ã‚Šã‚’ç§°ãˆã€ä»Šå›ã®çµæœãŒæŒã¤æ„å‘³ã‚’ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«æå†™ã—ã¦ãã ã•ã„ã€‚
- æœ€å¾Œã«ã€é¸æ‰‹ãŸã¡ã¸ã®è³›è¾ã‚„ã€ä»Šå¾Œã®ãƒãƒ¼ãƒ ã¸ã®æœŸå¾…ã‚’è¿°ã¹ã¦ç· ã‚ããã£ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼
JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„: {"title": "è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«", "body": "è¨˜äº‹ã®æœ¬æ–‡"}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (article) return { ...article, timestamp: Date.now() };
        }
        throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã—ãŸå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    } catch (error) {
        console.error("AIç”²å­åœ’è¨˜äº‹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return { title: "è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼", body: "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", timestamp: Date.now(), error: true };
    }
}
// --- Match Processing & Event Listeners ---


/**
 * [UPDATED] AIã«ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®çµ„ã¿åˆã‚ã›ã‹ã‚‰æ¶ç©ºã®å› ç¸ã‚’å‹•çš„ã«å‰µä½œã•ã›ã‚‹
 * (â˜…ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰ã«å¯¾å¿œã—ã€å…¨å›½è¦æ¨¡ã®å› ç¸ã‚’ä½œã‚‰ã›ã‚‹)
 */
async function generateDynamicFeuds(state) {
    const { matches, teams } = state;
    if (!matches || !teams) return [];

    // 1å›æˆ¦ã®çµ„ã¿åˆã‚ã›ã¨ã€å„ãƒãƒ¼ãƒ ã®è£œè¶³æƒ…å ±ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
    const round1Matchups = Object.values(matches).filter(m => m.id.includes('-R1-M'));
    const matchupInfo = round1Matchups.map(match => {
        const { team1, team2 } = match;
        if (!team1 || !team2 || team1 === '(BYE)' || team2 === '(BYE)') return null;

        const team1Data = TEAM_DATA[team1];
        const team1Record = state.teamRecords[team1];
        const team1Info = `"${team1}" (${team1Data?.region || 'ä¸æ˜'}, ç›£ç£: ${team1Data?.coach?.name}, ãƒ©ãƒ³ã‚¯: ${calculateRank(team1, state)})`;

        const team2Data = TEAM_DATA[team2];
        const team2Record = state.teamRecords[team2];
        const team2Info = `"${team2}" (${team2Data?.region || 'ä¸æ˜'}, ç›£ç£: ${team2Data?.coach?.name}, ãƒ©ãƒ³ã‚¯: ${calculateRank(team2, state)})`;

        return `${team1Info} vs ${team2Info}`;
    }).filter(Boolean).join('\n');

    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®åˆ‡ã‚Šæ›¿ãˆ â˜…â˜…â˜…
    let personaPrompt = "";
    let contextPrompt = "";
    
    if (state.currentTournament === 'summer_koshien') {
        personaPrompt = "ã‚ãªãŸã¯ã€å…¨å›½ã®é«˜æ ¡é‡çƒäº‹æƒ…ã«é€šã˜ã‚‹ãƒ™ãƒ†ãƒ©ãƒ³ã®ã‚¹ãƒãƒ¼ãƒ„ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚";
        contextPrompt = "å¤ã®ç”²å­åœ’ï¼ˆå…¨å›½å¤§ä¼šï¼‰ã®1å›æˆ¦";
    } else {
        personaPrompt = "ã‚ãªãŸã¯ã€é™å²¡çœŒã®é«˜æ ¡é‡çƒã®æ­´å²ã‚’ã™ã¹ã¦çŸ¥ã‚‹ãƒ™ãƒ†ãƒ©ãƒ³ã®ã‚¹ãƒãƒ¼ãƒ„ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚";
        contextPrompt = "å¤ã®é™å²¡çœŒå¤§ä¼šã®1å›æˆ¦";
    }
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    const prompt = `${personaPrompt}
${contextPrompt}ã®çµ„ã¿åˆã‚ã›ãŒæ±ºå®šã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã¨è£œè¶³æƒ…å ±ï¼ˆåœ°åŸŸã€ç›£ç£ã€ãƒ©ãƒ³ã‚¯ï¼‰ã‚’ç†Ÿèª­ã—ã¦ãã ã•ã„ã€‚

### 1å›æˆ¦ çµ„ã¿åˆã‚ã›ãƒªã‚¹ãƒˆ
${matchupInfo}

### æŒ‡ç¤º
ä¸Šè¨˜ã®ãƒªã‚¹ãƒˆã‹ã‚‰ã€æœ€ã‚‚ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãªæ¶ç©ºã®å› ç¸ï¼ˆãƒ•ã‚§ã‚¤ã‚¯ãƒ»ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼‰ã‚’æŒã¤å¯¾æ±ºã‚’**3ã¤**å³é¸ã—ã€ãã®èƒŒæ™¯ã‚’å‰µä½œã—ã¦ãã ã•ã„ã€‚

### å› ç¸ã®å‰µä½œãƒ‘ã‚¿ãƒ¼ãƒ³ä¾‹
- **åœ°åŸŸå¯¾æ±º:** ã€Œæ±åŒ—å‹¢åŒå£«ã®æ½°ã—åˆã„ã€ã€Œé–¢æ±vsé–¢è¥¿ã®ãƒ—ãƒ©ã‚¤ãƒ‰æ¿€çªã€
- **æ˜¨å¹´ã®ãƒªãƒ™ãƒ³ã‚¸ãƒãƒƒãƒ:** æ˜¨å¹´ã®å¤§ä¼šï¼ˆç”²å­åœ’ã‚„åœ°æ–¹å¤§ä¼šï¼‰ã§åŠ‡çš„ãªæ•—åŒ—ã‚’å–«ã—ãŸç›¸æ‰‹ã¨ã®å†æˆ¦ã€‚
- **ç›£ç£ã®å¸«å¼Ÿå¯¾æ±º:** ä¸¡ãƒãƒ¼ãƒ ã®ç›£ç£ãŒã€å®Ÿã¯å¤§å­¦æ™‚ä»£ã®å…ˆè¼©ã¨å¾Œè¼©ã ã£ãŸã€‚
- **ãƒ‰ãƒ©ãƒ•ãƒˆæ³¨ç›®å¯¾æ±º:** ãƒ—ãƒ­æ³¨ç›®ã®ã‚¨ãƒ¼ã‚¹ã¨ã‚¹ãƒ©ãƒƒã‚¬ãƒ¼ã®å¯¾æ±ºã€‚

### å‡ºåŠ›å½¢å¼ã€å³å®ˆã€‘
ä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼"ã®ã¿"ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚è§£èª¬ã‚„ã€Œã¯ã„ã€ãªã©ã®è¿”ç­”ã¯ä¸è¦ã§ã™ã€‚
[
  { "teams": ["ãƒãƒ¼ãƒ A", "ãƒãƒ¼ãƒ B"], "type": "å› ç¸ã®ã‚¿ã‚¤ãƒ—ï¼ˆä¾‹ï¼šå¸«å¼Ÿå¯¾æ±ºï¼‰", "story": "AIãŒå‰µä½œã—ãŸçŸ­ã„èƒŒæ™¯ã‚¹ãƒˆãƒ¼ãƒªãƒ¼" },
  { "teams": ["ãƒãƒ¼ãƒ C", "ãƒãƒ¼ãƒ D"], "type": "æ±è¥¿å¯¾æ±º", "story": "æ±ã®æ¨ªç¶±Cæ ¡ã¨è¥¿ã®æ¨ªç¶±Dæ ¡ãŒåˆæˆ¦ã‹ã‚‰æ¿€çªã™ã‚‹äº‹å®Ÿä¸Šã®æ±ºå‹æˆ¦" }
]`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const feudsJson = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (Array.isArray(feudsJson)) {
                return feudsJson;
            }
        }
        throw new Error("AI response format error.");
    } catch (error) {
        console.error("AIã«ã‚ˆã‚‹å‹•çš„å› ç¸ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return []; 
    }
}
/**
 * å»¶é•·ã‚¤ãƒ‹ãƒ³ã‚°ã‚’å…¨ã¦ã®é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ã™ã‚‹
 */
function addExtraInning() {
    // --- 1. ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–° ---
    const scoreTable = document.getElementById('inning-score-table');
    if (scoreTable) {
        const headerRow = scoreTable.querySelector('thead tr');
        // ç¾åœ¨ã®æœ€çµ‚ã‚¤ãƒ‹ãƒ³ã‚°ç•ªå·ã‚’å–å¾—ã—ã€1ã‚’è¶³ã™
        const lastInningHeader = headerRow.children[headerRow.children.length - 3];
        const newInningNum = parseInt(lastInningHeader.textContent) + 1;

        // æ–°ã—ã„ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
        const newTh = document.createElement('th');
        newTh.className = 'w-10';
        newTh.textContent = newInningNum;
        headerRow.insertBefore(newTh, headerRow.children[headerRow.children.length - 2]);

        // å„ãƒãƒ¼ãƒ ã®è¡Œã«æ–°ã—ã„å…¥åŠ›æ¬„ã‚’è¿½åŠ 
        scoreTable.querySelectorAll('tbody tr').forEach(row => {
            const newTd = document.createElement('td');
            newTd.innerHTML = `<input type="text" value="">`;
            row.insertBefore(newTd, row.children[row.children.length - 1]);
        });
    }

    // --- 2. ä¸¡ãƒãƒ¼ãƒ ã®æ‰“æ’ƒæˆç¸¾ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–° ---
    for (const teamKey of ['team1', 'team2']) {
        const battingTable = document.getElementById(`batting-table-${teamKey}`);
        if (!battingTable) continue;

        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ›´æ–°
        const headerRow = battingTable.querySelector('thead tr');
        const lastInningHeader = headerRow.lastElementChild.previousElementSibling;
        const newInningNum = parseInt(lastInningHeader.textContent) + 1;
        const newTh = document.createElement('th');
        newTh.className = 'col-inning';
        newTh.textContent = newInningNum;
        headerRow.insertBefore(newTh, headerRow.lastElementChild);

        // å…¨ã¦ã®é¸æ‰‹è¡Œï¼ˆã‚¹ã‚¿ãƒ¡ãƒ³ãƒ»äº¤ä»£ï¼‰ã«æ–°ã—ã„å…¥åŠ›æ¬„ã‚’è¿½åŠ 
        battingTable.querySelectorAll('tbody tr').forEach(row => {
            const newTd = document.createElement('td');
            newTd.innerHTML = `<input type="text" placeholder="-">`;
            row.appendChild(newTd);
        });

        // ã‚¤ãƒ‹ãƒ³ã‚°å‡ºæ¥äº‹å…¥åŠ›æ¬„ã®colspanã‚’æ›´æ–°ã—ã€æ–°ã—ã„å…¥åŠ›æ¬„ã‚’è¿½åŠ 
        const tfoot = battingTable.querySelector('tfoot');
        if (tfoot) {
            const targetCell = tfoot.querySelector('td[colspan]');
            const currentNumInnings = parseInt(targetCell.getAttribute('colspan')) - 1;
            targetCell.setAttribute('colspan', currentNumInnings + 2);

            const newEventTd = document.createElement('td');
            newEventTd.className = 'border-t-2';
            newEventTd.innerHTML = `<input type="text" class="inning-events-input w-full text-left px-1 text-xs" data-team-key="${teamKey}" data-inning-index="${newInningNum - 1}" placeholder="ä¾‹: éˆ´æœ¨ ç›—å¡">`;
            
            const eventRow = tfoot.querySelector('tr');
            eventRow.insertBefore(newEventTd, eventRow.lastElementChild);
        }
    }
}

/**
 * ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
 */
function updateTicker() {
    const tickerContainer = document.querySelector('.ticker-content');
    const oldTickerText = document.getElementById('ticker-text');
    if (!tickerContainer || !oldTickerText) return;

    let headlines = tournamentState.tickerHeadlines || [];
    
    // è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ãŒãªã‘ã‚Œã°ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚‚ã®ã‚’è¡¨ç¤º
    if (headlines.length === 0) {
        const defaultHeadlines = [
            "æ˜¨å¹´åº¦ç‹è€…ãƒ»283å­¦åœ’ã€çœŒå†…é€£è¦‡ã¨ã€Œå…¨å›½ã§ã®ä¸€å‹ã€ã¸è¦–ç•Œè‰¯å¥½ã‹",
            "ã€å…¬ç«‹æœ€å¾Œã®ç ¦ã€é™å²¡ã€åé–€å¾©æ´»ã¸ã€ä»Šå¹´ã“ãã€",
            "ãƒ—ãƒ­æ³¨ç›®158kmå³è…•ãƒ»æ–è—¤æ“ã™ã‚‹å¯Œå£«å®®åŒ—ã€ãƒ¯ãƒ³ãƒãƒ³ãƒãƒ¼ãƒ ã®æ±šåè¿”ä¸Šãªã‚‹ã‹",
            "å‰µéƒ¨ä¸€å¹´ç›®ãƒ»æµœæ¾ç‰¹æ”¯ã€åˆã‚ã¦ã®å¤ã€‚ã€Œã¾ãšã¯1ç‚¹ã€ã‚’åˆè¨€è‘‰ã«æŒ‘ã‚€",
            "é›¢å³¶ã®ãƒãƒ³ãƒ‡ã‚’è¦†ã›ï¼è™åºœå³¶ç·åˆã€é€†å¢ƒã‚¹ãƒ”ãƒªãƒƒãƒ„ã§æœ¬åœŸå‹¢ã«æŒ‘ã‚€",
            "765ç·åˆé«˜æ ¡ã€2å¹´å‰ã®æ „å…‰å†ã³ã€‚ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã‹ã‚‰ã®é€†è¥²ãªã‚‹ã‹",
            "æœ€å¾Œã®å¤ãƒ»å·æ ¹ã€é–‰æ ¡ã™ã‚‹æ¯æ ¡ã®åã‚’åˆ»ã‚ã‚‹ã‹",
            "ã€ãƒ™ã‚¹ãƒˆ8ã®å£ã€ã¯è¶Šãˆã‚‰ã‚Œã‚‹ã‹ã€‚å …å®ˆã®è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã€æ‰“ç·šã®ä»•ä¸ŠãŒã‚Šã¯"
        ];
        headlines = new Array(5).fill(defaultHeadlines).flat().sort(() => Math.random() - 0.5);
    }

    const newTextContent = headlines.join('ã€€ï¼ï¼ã€€');
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãŸã‚ã«è¦ç´ ã‚’å†ç”Ÿæˆ
    const newTickerText = oldTickerText.cloneNode(false);
    newTickerText.textContent = newTextContent;
    oldTickerText.remove();
    tickerContainer.appendChild(newTickerText);
}

/**
 * è©¦åˆçµæœã‹ã‚‰ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚«ãƒ¼ç”¨ã®çŸ­ã„ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã‚’ç”Ÿæˆã™ã‚‹
 * @param {object} matchData - è©¦åˆã®ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @returns {string | null} - ç”Ÿæˆã•ã‚ŒãŸãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã®æ–‡å­—åˆ—ã€ã¾ãŸã¯null
 */
function generateTickerHeadline(matchData) {
    const { winnerName, loserName, score1, score2 } = matchData;
    const winnerScore = Math.max(parseInt(score1), parseInt(score2));
    const loserScore = Math.min(parseInt(score1), parseInt(score2));
    const scoreDiff = winnerScore - loserScore;

    const winnerRank = calculateRank(winnerName, tournamentState);
    const loserRank = calculateRank(loserName, tournamentState);
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
    const rankDiff = rankValues[winnerRank] - rankValues[loserRank];

    // ãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼šå¤§ç•ªç‹‚ã‚ã›ï¼ˆã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒªãƒ³ã‚°ï¼‰
    if (rankDiff <= -2) {
        return `ã€æ³¢ä¹±ã€‘${getRankDescription(loserRank)}ãƒ»${loserName}ãŒåˆæˆ¦ã§æ•£ã‚‹ï¼ ${winnerName}ãŒé‡‘æ˜ŸæŒ™ã’ã‚‹`;
    }
    // ãƒ‘ã‚¿ãƒ¼ãƒ³2ï¼šæ¥æˆ¦
    if (scoreDiff <= 2 && rankDiff <= 1 && rankDiff >= -1) {
        return `æ‰‹ã«æ±—æ¡ã‚‹æ¥æˆ¦ï¼ ${winnerName}ãŒ${loserName}ã‚’${winnerScore}-${loserScore}ã§æŒ¯ã‚Šåˆ‡ã‚‹`;
    }
    // ãƒ‘ã‚¿ãƒ¼ãƒ³3ï¼šåœ§å‹
    if (scoreDiff >= 8 && rankDiff >= 2) {
        return `ç‹è€…ãƒ»${winnerName}ã€ç›¤çŸ³ã®è©¦åˆé‹ã³ã§${loserName}ã‚’åœ§å€’ã€‚${winnerScore}å¯¾${loserScore}ã§ã‚³ãƒ¼ãƒ«ãƒ‰å‹ã¡ç´šã®å¿«å‹`;
    }
    // ãƒ‘ã‚¿ãƒ¼ãƒ³4ï¼šãƒ©ã‚¤ãƒãƒ«å¯¾æ±º
    const rivalry = RIVALRIES.find(r => r.teams.includes(winnerName) && r.teams.includes(loserName));
    if (rivalry) {
        return `å› ç¸ã®${rivalry.type}ã¯${winnerName}ã«è»é…ï¼ ${loserName}ã‚’ä¸‹ã™`;
    }
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    return `${winnerName}ãŒ${loserName}ã‚’ä¸‹ã—ã€æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸é§’ã‚’é€²ã‚ã‚‹`;
}


/**
 * [HELPER] æ‰“å¸­çµæœã®æ–‡å­—åˆ—ã‚’ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ã®æ—¥æœ¬èªã«ç¿»è¨³ã™ã‚‹
 * (â˜…ã€Œæ³¨ç›®ã€ãƒ•ãƒ©ã‚°å¯¾å¿œ æœ€çµ‚ç‰ˆ)
 */
function translateResult(res, playerInfo, eventType = '') {
    if (!res) return null;
    let tempRes = res.trim();

    // 1. æ³¨ç›®ãƒ•ãƒ©ã‚°ã‚’ãƒ‘ãƒ¼ã‚¹
    let markPrefix = ''; // æ³¨ç›®ï¼ˆç¿»è¨³å¾Œï¼‰
    if (tempRes.startsWith('â˜…:')) {
        markPrefix = 'ï¼ˆâ˜…æ³¨ç›®ï¼‰';
        tempRes = tempRes.substring(3); // "â˜…:" ã‚’å‰Šé™¤
    }

    // 2. å‹¢ã„(Strength)ã‚’ãƒ‘ãƒ¼ã‚¹
    let strengthPrefix = '';
    let strengthPrefixOut = '';
    if (tempRes.startsWith('S:')) {
        strengthPrefix = 'é‹­ã„';
        strengthPrefixOut = 'é‹­ã„å½“ãŸã‚Šã®';
        tempRes = tempRes.substring(2); // "S:" ã‚’å‰Šé™¤
    } else if (tempRes.startsWith('W:')) {
        strengthPrefix = 'è©°ã¾ã‚ŠãªãŒã‚‰ã‚‚';
        strengthPrefixOut = 'è©°ã¾ã£ãŸå½“ãŸã‚Šã®';
        tempRes = tempRes.substring(2); // "W:" ã‚’å‰Šé™¤
    }

    // 3. æ–¹å‘ã‚’ãƒ‘ãƒ¼ã‚¹
    let direction = '';
    const directionMap = {'æŠ•': 'ãƒ”ãƒƒãƒãƒ£ãƒ¼', 'æ•': 'ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼', 'ä¸€': 'ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ', 'äºŒ': 'ã‚»ã‚«ãƒ³ãƒ‰', 'ä¸‰': 'ã‚µãƒ¼ãƒ‰', 'éŠ': 'ã‚·ãƒ§ãƒ¼ãƒˆ', 'å·¦': 'ãƒ¬ãƒ•ãƒˆ', 'ä¸­': 'ã‚»ãƒ³ã‚¿ãƒ¼', 'å³': 'ãƒ©ã‚¤ãƒˆ'};
    const directionKeys = Object.keys(directionMap);
    for (const key of directionKeys) {
        if (tempRes.startsWith(key)) {
            direction = directionMap[key] + 'ã¸';
            if (tempRes.includes('ã‚´ãƒ­') || tempRes.includes('é£›') || tempRes.includes('é‚ª') || tempRes.includes('ç›´')) {
                direction = directionMap[key];
            }
            tempRes = tempRes.substring(key.length).trim();
            break;
        }
    }

    // 4. æ‰“ç‚¹ã¨ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—
    let description = `${playerInfo}ãŒ`; // åŸºæœ¬ã®ä¸»èª
    const rbiMatch = tempRes.match(/(\d+)ç‚¹/);
    const eventText = eventType ? `${eventType}ã¨ãªã‚‹` : '';

    // 5. çµæœã®ç¿»è¨³ (â˜…markPrefixã‚’å…¨ã¦ã«è¿½åŠ )
    if (tempRes.includes('æœ¬å¡æ‰“')) {
        let hrRbiText = 'ã‚½ãƒ­';
        if (rbiMatch) {
            const rbi = parseInt(rbiMatch[1]);
            if (rbi === 4) hrRbiText = 'æº€å¡';
            else if (rbi === 3) hrRbiText = '3ãƒ©ãƒ³';
            else if (rbi === 2) hrRbiText = '2ãƒ©ãƒ³';
        }
        description = `${playerInfo}ãŒ${markPrefix}${strengthPrefix ? strengthPrefix + ' ' : ''}${direction ? direction + 'ã¸ã®' : ''}${eventText}${hrRbiText}ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³ã‚’æ”¾ã£ãŸ`;
    
    } else {
        // æœ¬å¡æ‰“ä»¥å¤–
        const rbiText = rbiMatch ? (parseInt(rbiMatch[1]) > 1 ? `${rbiMatch[1]}ç‚¹ã‚¿ã‚¤ãƒ ãƒªãƒ¼` : 'ã‚¿ã‚¤ãƒ ãƒªãƒ¼') : '';

        if (tempRes.includes('ä¸‰å¡æ‰“')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefix ? strengthPrefix + ' ' : ''}${direction ? direction + 'ã¸ã®' : ''}${eventText}${rbiText}ä¸‰å¡æ‰“ã‚’æ”¾ã£ãŸ`;
        else if (tempRes.includes('äºŒå¡æ‰“')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefix ? strengthPrefix + ' ' : ''}${direction ? direction + 'ã¸ã®' : ''}${eventText}${rbiText}äºŒå¡æ‰“ã‚’æ”¾ã£ãŸ`;
        else if (tempRes.includes('å®‰')) {
            let hitDescription = "ãƒ’ãƒƒãƒˆ";
            let actionDesc = "æ”¾ã£ãŸ";
            let adjective = ""; // å½¢å®¹è©

            // å†…é‡å®‰æ‰“ç³»ï¼ˆæŠ•ãƒ»æ•ãƒ»ä¸€ãƒ»äºŒãƒ»ä¸‰ãƒ»éŠï¼‰ã®å ´åˆã®åˆ†å²
            const isInfield = ['ãƒ”ãƒƒãƒãƒ£ãƒ¼', 'ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼', 'ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ', 'ã‚»ã‚«ãƒ³ãƒ‰', 'ã‚µãƒ¼ãƒ‰', 'ã‚·ãƒ§ãƒ¼ãƒˆ'].includes(direction);

            if (isInfield) {
                if (strengthPrefix === 'é‹­ã„') {
                    // S: (å¼·) -> å¼·è¥²ãƒ’ãƒƒãƒˆ
                    hitDescription = "å¼·è¥²ã®å†…é‡å®‰æ‰“";
                    adjective = "å¼·çƒˆãª";
                    // ã€Œé‹­ã„ ãƒ”ãƒƒãƒãƒ£ãƒ¼ã¸ã®...ã€ã¨ãªã‚‰ãªã„ã‚ˆã†ã€å…±é€šprefixã‚’æ¶ˆå»ã—ã¦ç‹¬è‡ªå½¢å®¹è©ã‚’ä½¿ã†
                    strengthPrefix = ""; 
                } 
                else if (strengthPrefix === 'è©°ã¾ã‚ŠãªãŒã‚‰ã‚‚') {
                    // W: (å¼±) -> ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒ¼ãƒãƒ³ãƒˆ
                    hitDescription = "ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒ¼ãƒãƒ³ãƒˆ";
                    adjective = "çµ¶å¦™ãª";
                    actionDesc = "æ±ºã‚ãŸ";
                    strengthPrefix = ""; 
                }
                else {
                    // æŒ‡å®šãªã— -> ãƒœãƒ†ãƒœãƒ†ã®å†…é‡å®‰æ‰“
                    hitDescription = "å†…é‡å®‰æ‰“";
                    adjective = "ãƒœãƒ†ãƒœãƒ†ã®";
                    actionDesc = "ã‚‚ãå–ã£ãŸ";
                }

                // å†…é‡å®‰æ‰“ç”¨ã®æ–‡ç« ç”Ÿæˆã—ã¦ãƒªã‚¿ãƒ¼ãƒ³
                description = `${playerInfo}ãŒ${markPrefix}${direction}ã¸ã®${adjective}${hitDescription}ã‚’${actionDesc}`;
                return description.replace(/ã‚¿ã‚¤ãƒ ãƒªãƒ¼1ç‚¹/g, 'ã‚¿ã‚¤ãƒ ãƒªãƒ¼').replace(/1ç‚¹ã‚’æŒ™ã’ãŸ/g, 'ç‚¹ã‚’æŒ™ã’ãŸ');
            }
            
            // é€šå¸¸ã®ãƒ’ãƒƒãƒˆï¼ˆå¤–é‡ãƒ’ãƒƒãƒˆãªã©ï¼‰
            description = `${playerInfo}ãŒ${markPrefix}${strengthPrefix ? strengthPrefix + ' ' : ''}${direction ? direction + 'ã¸ã®' : ''}${eventText}${rbiText}ãƒ’ãƒƒãƒˆã‚’æ”¾ã£ãŸ`;
        }
        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²        
        else if (tempRes.includes('çŠ é£›')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å¤–é‡'}ã¸ã®${eventText}çŠ ç‰²ãƒ•ãƒ©ã‚¤${rbiMatch ? `ã§${rbiMatch[1]}ç‚¹` : 'ã§1ç‚¹'}ã‚’æŒ™ã’ãŸ`;
        else if (tempRes.includes('çŠ æ‰“')) description = `${playerInfo}ãŒ${markPrefix}${direction ? direction + 'ã¸' : ''}é€ã‚Šãƒãƒ³ãƒˆã‚’æ±ºã‚ãŸ`;
        
        else if (tempRes.includes('ã‚´ãƒ­') && rbiMatch) description = `${playerInfo}ã®${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å†…é‡'}ã‚´ãƒ­ã®é–“ã«${eventText}${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
        else if ((tempRes.includes('ã‚¨ãƒ©ãƒ¼') || tempRes.includes('å¤±')) && rbiMatch) description = `${playerInfo}ãŒ${markPrefix}ç›¸æ‰‹${direction ? direction + 'ã®' : ''}ã‚¨ãƒ©ãƒ¼ã®é–“ã«${eventText}${rbiMatch[1]}ç‚¹ã‚’è¨˜éŒ²ã—ãŸ`;
        else if (tempRes.includes('é‡é¸') && rbiMatch) description = `${playerInfo}ã®${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å†…é‡'}ã¸ã®${eventText}é‡é¸ã®é–“ã«${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
        
        else if (tempRes.includes('æŒ¯ã‚Šé€ƒã’')) {
            if (rbiMatch) description = `${playerInfo}ãŒ${markPrefix}${eventText}ä¸‰æŒ¯æŒ¯ã‚Šé€ƒã’ã®é–“ã«${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ã€æ‰“è€…ã‚‚å‡ºå¡ã—ãŸ`;
            else description = `${playerInfo}ãŒ${markPrefix}${eventText}ä¸‰æŒ¯æŒ¯ã‚Šé€ƒã’ã§å‡ºå¡ã—ãŸ`;
        }
        else if (tempRes.includes('æ‰“æ’ƒå¦¨å®³')) {
            if (rbiMatch) description = `${playerInfo}ãŒ${markPrefix}${eventText}æ‰“æ’ƒå¦¨å®³ï¼ˆæŠ¼ã—å‡ºã—ï¼‰ã§${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ã€å‡ºå¡ã—ãŸ`;
            else description = `${playerInfo}ãŒ${markPrefix}${eventText}æ‰“æ’ƒå¦¨å®³ã§å‡ºå¡ã—ãŸ`;
        }

        else if (tempRes.includes('å››çƒ')) {
            if (rbiMatch) description = `${playerInfo}ãŒ${markPrefix}${eventText}æŠ¼ã—å‡ºã—ã®å››çƒã‚’é¸ã³ã€${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
            else description = `${playerInfo}ãŒ${markPrefix}å››çƒã‚’é¸ã‚“ã `;
        }
        else if (tempRes.includes('æ­»çƒ')) {
            if (rbiMatch) description = `${playerInfo}ãŒ${markPrefix}${eventText}æŠ¼ã—å‡ºã—ã®æ­»çƒã‚’å—ã‘ã€${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
            else description = `${playerInfo}ãŒ${markPrefix}æ­»çƒã§å‡ºå¡ã—ãŸ`;
        }
        else if (tempRes.includes('æ•¬é ')) {
            if (rbiMatch) {
                description = `${playerInfo}ãŒ${markPrefix}${eventText}æŠ¼ã—å‡ºã—ã®æ•¬é å››çƒã‚’é¸ã³ã€${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
            } else {
                description = `${playerInfo}ãŒ${markPrefix}${eventText}æ•¬é å››çƒã§å‡ºå¡ã—ãŸ`;
            }
        }
        
        else if (tempRes.includes('ä¸‰æŒ¯')) description = `${playerInfo}ãŒ${markPrefix}ä¸‰æŒ¯ã«å€’ã‚ŒãŸ`;
        else if (tempRes.includes('ä½µæ®º')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å†…é‡'}ã‚´ãƒ­ã§ä½µæ®ºæ‰“ã«å€’ã‚ŒãŸ`;
        else if (tempRes.includes('é‚ª')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'ãƒ•ã‚¡ã‚¦ãƒ«ã‚¾ãƒ¼ãƒ³'}ã¸ã®é‚ªé£›ï¼ˆãƒ•ã‚¡ã‚¦ãƒ«ãƒ•ãƒ©ã‚¤ï¼‰ã«å€’ã‚ŒãŸ`;
        else if (tempRes.includes('ã‚´ãƒ­')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å†…é‡'}ã‚´ãƒ­ã«å€’ã‚ŒãŸ`;
        else if (tempRes.includes('é£›')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å¤–é‡'}ãƒ•ãƒ©ã‚¤ã«å€’ã‚ŒãŸ`;
        else if (tempRes.includes('ç›´')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || ''}ãƒ©ã‚¤ãƒŠãƒ¼ã«å€’ã‚ŒãŸ`;
        
        // â–¼â–¼â–¼ ä¿®æ­£ï¼šçŠ å¤±ã‚’å€‹åˆ¥ã«ç¿»è¨³ã—ã¦ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‚’å‡ºã™ â–¼â–¼â–¼
        else if (tempRes.includes('çŠ å¤±')) {
            if (rbiMatch) {
                // æ‰“ç‚¹ãŒã‚ã‚‹å ´åˆï¼ˆçŠ é£›å¤±ç­–ã®å¯èƒ½æ€§å¤§ï¼‰
                description = `${playerInfo}ãŒ${markPrefix}${direction ? direction + 'ã¸ã®' : ''}çŠ ç‰²ãƒ•ãƒ©ã‚¤ï¼ˆã¾ãŸã¯ãƒãƒ³ãƒˆï¼‰ã‚’æ”¾ã¤ã‚‚å¤±ç­–ã¨ãªã‚Šå‡ºå¡ã€${eventText}${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
            } else {
                // æ‰“ç‚¹ãŒãªã„å ´åˆï¼ˆçŠ æ‰“å¤±ç­–ã®å¯èƒ½æ€§å¤§ï¼‰
                description = `${playerInfo}ã®${markPrefix}${direction ? direction + 'ã¸ã®' : ''}çŠ ç‰²ãƒãƒ³ãƒˆï¼ˆã¾ãŸã¯ãƒ•ãƒ©ã‚¤ï¼‰ãŒç›¸æ‰‹ã®å¤±ç­–ã‚’èª˜ã„ã€å‡ºå¡ã—ãŸ`;
            }
        }
        // é€šå¸¸ã®ã‚¨ãƒ©ãƒ¼
        else if (tempRes.includes('ã‚¨ãƒ©ãƒ¼') || tempRes.includes('å¤±')) {
            description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}ç›¸æ‰‹${direction ? direction + 'ã®' : ''}ã‚¨ãƒ©ãƒ¼ã§å‡ºå¡ã—ãŸ`;
        }
        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

        else if (tempRes.includes('é‡é¸')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction ? direction + 'ã¸ã®' : ''}é‡é¸ã§å‡ºå¡ã—ãŸ`;
        else return null;
    }

    // 6. æœ€çµ‚èª¿æ•´
    return description.replace(/ã‚¿ã‚¤ãƒ ãƒªãƒ¼1ç‚¹/g, 'ã‚¿ã‚¤ãƒ ãƒªãƒ¼').replace(/1ç‚¹ã‚’æŒ™ã’ãŸ/g, 'ç‚¹ã‚’æŒ™ã’ãŸ');
};
// â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// â–¼â–¼â–¼ ã€æ–°è¦è¿½åŠ ã€‘ä½œæˆ¦ãƒœãƒ¼ãƒ‰ (æ‰“é †å…¥ã‚Œæ›¿ãˆ) æ©Ÿèƒ½ â–¼â–¼â–¼

// â–¼â–¼â–¼ ã€æ”¹è‰¯ç‰ˆã€‘ä½œæˆ¦ãƒœãƒ¼ãƒ‰ (æ‰“é †å…¥ã‚Œæ›¿ãˆ) æ©Ÿèƒ½ â–¼â–¼â–¼

let editingLineup = { starters: [], bench: [], teamKey: null, matchId: null };
let selectedPlayerIndex = null; // é¸æŠä¸­ã®é¸æ‰‹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

// ä½œæˆ¦ãƒœãƒ¼ãƒ‰ã‚’é–‹ã
function openLineupManager(matchId, teamKey) {
    const match = findMatchById(matchId);
    if (!match || !match.details || !match.details.batting || !match.details.batting[teamKey]) {
        alert("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ä¸€åº¦è©³ç´°ç”»é¢ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚");
        return;
    }

    const currentBatting = match.details.batting[teamKey];
    const teamName = match[teamKey];
    const teamRecord = tournamentState.teamRecords[teamName];

    editingLineup.matchId = matchId;
    editingLineup.teamKey = teamKey;
    editingLineup.starters = [];
    editingLineup.bench = [];
    selectedPlayerIndex = null;

    // ãƒ­ã‚¹ã‚¿ãƒ¼ãƒã‚¹ã‚¿ã‚’å–å¾—
    let fullRoster = [];
    if (TEAM_ROSTER_MASTER[teamName]) {
        fullRoster = JSON.parse(JSON.stringify(TEAM_ROSTER_MASTER[teamName]));
    } else if (teamRecord && teamRecord.roster) {
        fullRoster = JSON.parse(JSON.stringify(teamRecord.roster));
    }

    // æˆç¸¾å–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼
    const getStats = (pName) => {
        if (!teamRecord || !teamRecord.playerStats || !teamRecord.playerStats.batting || !teamRecord.playerStats.batting[pName]) {
            return { avg: ".---", hr: 0, rbi: 0, ops: ".---", condition: "" };
        }
        const s = teamRecord.playerStats.batting[pName];
        const avg = s.ab > 0 ? (s.h / s.ab).toFixed(3) : ".000";
        const ops = calculateOps(s);
        
        // èª¿å­ã‚¢ã‚¤ã‚³ãƒ³ã®å–å¾—
        let cond = "";
        if (s.narrative_flag) cond = getPlayerConditionIcon(s.narrative_flag);
        else if (teamRecord.playerStats.pitching?.[pName]?.narrative_flag) {
            cond = getPlayerConditionIcon(teamRecord.playerStats.pitching[pName].narrative_flag);
        }
        
        return { avg, hr: s.hr || 0, rbi: s.rbi || 0, ops, condition: cond };
    };

    // 1. ç¾åœ¨ã®ã‚¹ã‚¿ãƒ¡ãƒ³ (1-9ç•ª) ã‚’æŠ½å‡º
    for (let i = 1; i <= 9; i++) {
        const currentData = currentBatting.find(p => p.order == i);
        let playerObj = null;

        if (currentData && currentData.name) {
            playerObj = fullRoster.find(p => p.name === currentData.name);
            if (!playerObj) playerObj = { ...currentData, grade: '?', throwBat: '?' };
        }

        if (!playerObj) playerObj = { name: '---', pos: '?', number: '', empty: true };
        
        // â˜… æˆç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’ä»˜ä¸
        playerObj.stats = getStats(playerObj.name);
        
        editingLineup.starters.push(playerObj);
    }

    // 2. ãƒ™ãƒ³ãƒå…¥ã‚Šãƒ¡ãƒ³ãƒãƒ¼ã‚’æŠ½å‡º
    fullRoster.forEach(p => {
        const isStarter = editingLineup.starters.some(s => s.name === p.name);
        if (!isStarter) {
            const pClone = { ...p }; // ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
            pClone.stats = getStats(p.name); // â˜… æˆç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’ä»˜ä¸
            editingLineup.bench.push(pClone);
        }
    });

    renderLineupBoard();
    document.getElementById('lineup-manager-modal').classList.remove('hidden');
    document.getElementById('lineup-manager-modal').classList.add('flex');
}

// ãƒœãƒ¼ãƒ‰ã‚’æç”»ã™ã‚‹
function renderLineupBoard() {
    const startersContainer = document.getElementById('lineup-starters-container');
    const benchContainer = document.getElementById('lineup-bench-container');
    startersContainer.innerHTML = '';
    benchContainer.innerHTML = '';

    editingLineup.starters.forEach((p, index) => {
        const card = createPlayerCard(p, index, true);
        startersContainer.appendChild(card);
    });

    editingLineup.bench.forEach((p, index) => {
        const globalIndex = 9 + index;
        const card = createPlayerCard(p, globalIndex, false);
        benchContainer.appendChild(card);
    });
}

// é¸æ‰‹ã‚«ãƒ¼ãƒ‰è¦ç´ ã‚’ä½œæˆ (â˜…æˆç¸¾è¡¨ç¤ºã‚’è¿½åŠ )
function createPlayerCard(p, index, isStarter) {
    const div = document.createElement('div');
    div.className = `lineup-card ${selectedPlayerIndex === index ? 'selected' : ''}`;
    div.dataset.index = index;
    
    let posClass = 'bg-gray-600';
    if (p.pos === 'æŠ•') posClass = 'pos-P';
    else if (p.pos === 'æ•') posClass = 'pos-C';
    else if (['ä¸€','äºŒ','ä¸‰','éŠ'].includes(p.pos)) posClass = 'pos-IF';
    else if (['å·¦','ä¸­','å³','å¤–'].includes(p.pos)) posClass = 'pos-OF';
    
    // æˆç¸¾HTMLã®ç”Ÿæˆ
    const stats = p.stats || { avg: ".---", hr: 0, rbi: 0, ops: ".---", condition: "" };
    
    // æ‰“ç‡ã«ã‚ˆã£ã¦è‰²ã‚’å¤‰ãˆã‚‹
    const avgVal = parseFloat(stats.avg);
    const avgClass = avgVal >= 0.400 ? 'text-orange-400 font-bold' : (avgVal >= 0.300 ? 'text-yellow-300' : 'text-gray-400');

    const statsHtml = p.empty ? '' : `
        <div class="text-xs mt-0.5 flex space-x-2 items-center">
            <span class="${avgClass}">ç‡${stats.avg}</span>
            <span class="text-gray-300">æœ¬${stats.hr}</span>
            <span class="text-gray-300">ç‚¹${stats.rbi}</span>
            <span class="text-blue-300">OPS${stats.ops}</span>
        </div>
    `;

    div.innerHTML = `
        ${isStarter ? `<div class="lineup-order-num">${index + 1}</div>` : ''}
        <div class="lineup-pos-badge ${posClass}">${p.pos || '?'}</div>
        
        <div style="flex-grow: 1; min-width: 0;">
            <div class="lineup-name flex items-center">
                <span class="truncate">${p.name}</span>
                <span class="text-xs font-normal text-gray-500 ml-1">#${p.number}</span>
                <span class="ml-2">${stats.condition}</span>
            </div>
            ${statsHtml}
        </div>
        
        <div class="lineup-stat text-right text-xs text-gray-500 ml-2">
            <div>${p.throwBat || ''}</div>
            <div>${p.grade ? p.grade + 'å¹´' : ''}</div>
        </div>
    `;

    div.onclick = () => handlePlayerClick(index);
    return div;
}

// ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
function handlePlayerClick(index) {
    if (selectedPlayerIndex === null) {
        selectedPlayerIndex = index;
        renderLineupBoard();
    } else if (selectedPlayerIndex === index) {
        selectedPlayerIndex = null;
        renderLineupBoard();
    } else {
        swapPlayers(selectedPlayerIndex, index);
        selectedPlayerIndex = null;
        renderLineupBoard();
    }
}

// é¸æ‰‹ã‚’å…¥ã‚Œæ›¿ãˆã‚‹ãƒ­ã‚¸ãƒƒã‚¯
function swapPlayers(idx1, idx2) {
    const getListAndLocalIdx = (idx) => {
        if (idx < 9) return { list: editingLineup.starters, localIdx: idx };
        return { list: editingLineup.bench, localIdx: idx - 9 };
    };

    const obj1 = getListAndLocalIdx(idx1);
    const obj2 = getListAndLocalIdx(idx2);

    const temp = obj1.list[obj1.localIdx];
    obj1.list[obj1.localIdx] = obj2.list[obj2.localIdx];
    obj2.list[obj2.localIdx] = temp;
}

// æ±ºå®šãƒœã‚¿ãƒ³ï¼šå¤‰æ›´ã‚’è©³ç´°å…¥åŠ›ç”»é¢ã«åæ˜ ã™ã‚‹
function applyLineupChanges() {
    const { matchId, teamKey } = editingLineup;
    const match = findMatchById(matchId);
    if (!match) return;

    const targetArray = match.details.batting[teamKey];
    
    // ã‚¹ã‚¿ãƒ¡ãƒ³é…åˆ—ã‚’æ›´æ–°ï¼ˆæ—¢å­˜ã®orderã«åˆã‚ã›ã¦ä¸­èº«ã‚’æ›¸ãæ›ãˆï¼‰
    editingLineup.starters.forEach((p, i) => {
        const order = (i + 1).toString();
        let targetRow = targetArray.find(row => row.order == order);
        
        if (!targetRow) {
            targetRow = { order: order, results: [], sub_type: null };
            targetArray.push(targetRow);
        }

        targetRow.name = p.name;
        targetRow.number = p.number;
        targetRow.pos = p.pos;
        targetRow.throwBat = p.throwBat;
    });

    saveState();
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦è©³ç´°ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
    document.getElementById('lineup-manager-modal').classList.add('hidden');
    document.getElementById('lineup-manager-modal').classList.remove('flex');
    openDetailsModal(matchId); 
    
    // å°‘ã—é…ã‚Œã¦é€šçŸ¥ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ã¨é‡ãªã‚‰ãªã„ã‚ˆã†ã«ï¼‰
    setTimeout(() => alert("ã‚ªãƒ¼ãƒ€ãƒ¼ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚"), 100);
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.getElementById('lineup-manager-close-btn').onclick = () => {
    document.getElementById('lineup-manager-modal').classList.add('hidden');
    document.getElementById('lineup-manager-modal').classList.remove('flex');
};
document.getElementById('lineup-manager-save-btn').onclick = applyLineupChanges;

// â–¼â–¼â–¼ ã€æ–°è¦è¿½åŠ ã€‘ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãƒ»ã‚¹ãƒ­ãƒƒãƒˆç®¡ç†æ©Ÿèƒ½ â–¼â–¼â–¼

const MAX_SAVE_SLOTS = 5;

// ã‚¹ãƒ­ãƒƒãƒˆä¸€è¦§ã‚’æç”»ã™ã‚‹
function renderSaveSlots() {
    const container = document.getElementById('save-slots-container');
    container.innerHTML = '';

    for (let i = 1; i <= MAX_SAVE_SLOTS; i++) {
        const key = `tournament_save_slot_${i}`;
        const dataJson = localStorage.getItem(key);
        let infoText = "ãƒ‡ãƒ¼ã‚¿ãªã—";
        let timestamp = "";
        let hasData = false;

        if (dataJson) {
            try {
                const data = JSON.parse(dataJson);
                const date = new Date(data.savedAt || Date.now());
                const yearStr = data.tournamentYear || '????';
                const tourneyStr = tournamentNameMap[data.currentTournament] || '';
                // é€²è¡ŒçŠ¶æ³ã®è¦ç´„
                infoText = `${yearStr}å¹´ ${tourneyStr}`;
                timestamp = date.toLocaleString('ja-JP');
                hasData = true;
            } catch (e) {
                infoText = "ãƒ‡ãƒ¼ã‚¿ç ´æ";
            }
        }

        const div = document.createElement('div');
        div.className = "flex items-center justify-between p-3 border rounded bg-white hover:bg-gray-50 transition-colors";
        div.innerHTML = `
            <div class="flex flex-col">
                <span class="font-bold text-gray-700">SLOT ${i}</span>
                <span class="text-sm text-blue-600 font-semibold">${infoText}</span>
                <span class="text-xs text-gray-400">${timestamp}</span>
            </div>
            <div class="flex space-x-2">
                <button class="save-slot-btn bg-blue-100 text-blue-700 text-xs font-bold px-3 py-1.5 rounded hover:bg-blue-200 border border-blue-300" data-slot="${i}">
                    ä¸Šæ›¸ãä¿å­˜
                </button>
                ${hasData ? `
                <button class="load-slot-btn bg-green-100 text-green-700 text-xs font-bold px-3 py-1.5 rounded hover:bg-green-200 border border-green-300" data-slot="${i}">
                    ãƒ­ãƒ¼ãƒ‰
                </button>
                <button class="delete-slot-btn bg-red-50 text-red-600 text-xs font-bold px-2 py-1.5 rounded hover:bg-red-100 border border-red-200" data-slot="${i}">
                    å‰Šé™¤
                </button>` : ''}
            </div>
        `;
        container.appendChild(div);
    }

    // ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ã®è¡¨ç¤ºæ›´æ–°
    updateAutosaveDisplay();
}

// ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–æƒ…å ±ã®æ›´æ–°
function updateAutosaveDisplay() {
        const infoEl = document.getElementById('autosave-info');
        const btn = document.getElementById('load-autosave-btn');

        const compressed = localStorage.getItem('tournament_autosave_compressed');
        const raw = localStorage.getItem('tournament_autosave');
        
        let data = null;

        try {
            if (compressed) {
                data = decompressData(compressed);
            } else if (raw) {
                data = JSON.parse(raw);
            }

            if (data) {
                const date = new Date(data.savedAt || Date.now());
                infoEl.textContent = `${data.tournamentYear}å¹´ (${date.toLocaleString()})`;
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                throw new Error("No data");
            }
        } catch (e) {
            infoEl.textContent = "ãƒ‡ãƒ¼ã‚¿ãªã—";
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

// ã‚¹ãƒ­ãƒƒãƒˆã¸ã®ä¿å­˜
function saveToSlot(slotNum) {
    if (!tournamentState) return;
    
    // ä¿å­˜æ™‚åˆ»ã‚’è¿½åŠ 
    tournamentState.savedAt = Date.now();
    
    const key = `tournament_save_slot_${slotNum}`;
    try {
        localStorage.setItem(key, JSON.stringify(tournamentState));
        renderSaveSlots(); // ãƒªã‚¹ãƒˆæ›´æ–°
        alert(`ã‚¹ãƒ­ãƒƒãƒˆ${slotNum}ã«ä¿å­˜ã—ã¾ã—ãŸã€‚`);
    } catch (e) {
        alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å®¹é‡ä¸è¶³ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
    }
}

// ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰ã®ãƒ­ãƒ¼ãƒ‰
async function loadFromSlot(slotNum) {
    const key = `tournament_save_slot_${slotNum}`;
    const dataJson = localStorage.getItem(key);
    if (!dataJson) return;

    if (await showConfirm(`ã‚¹ãƒ­ãƒƒãƒˆ${slotNum}ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®é€²è¡ŒçŠ¶æ³ã¯å¤±ã‚ã‚Œã¾ã™ã€‚`)) {
        try {
            const data = JSON.parse(dataJson);
            tournamentState = data;
            
            // ç”²å­åœ’ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒå‡¦ç†ãªã©ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã®æµç”¨ï¼‰
            if (tournamentState.currentTournament === 'summer_koshien') {
                restoreKoshienData(tournamentState.teams);
            }
            
            alert("ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚");
            document.getElementById('save-load-modal').classList.add('hidden');
            renderTournament(tournamentState);
        } catch (e) {
            alert("ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
    }
}

/**
     * ã€ä¿®æ­£ç‰ˆã€‘ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ï¼ˆåœ§ç¸®ä¿å­˜ï¼‰
     */
    function performAutoSave() {
        if (!tournamentState) return;
        try {
            tournamentState.savedAt = Date.now();
            const compressed = compressData(tournamentState);
            localStorage.setItem('tournament_autosave_compressed', compressed);
            
            // å¤ã„éåœ§ç¸®ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ã‚’å‰Šé™¤
            if (localStorage.getItem('tournament_autosave')) {
                localStorage.removeItem('tournament_autosave');
            }
        } catch (e) {
            console.error("Auto-save failed:", e);
        }
    }

// ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ã‹ã‚‰ã®ãƒ­ãƒ¼ãƒ‰
async function loadFromAutosave() {
        // åœ§ç¸®ç‰ˆã‚’å„ªå…ˆç¢ºèª
        const compressed = localStorage.getItem('tournament_autosave_compressed');
        const raw = localStorage.getItem('tournament_autosave');

        if (!compressed && !raw) return;

        if (await showConfirm(`ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ`)) {
            try {
                let data;
                if (compressed) {
                    data = decompressData(compressed);
                } else {
                    data = JSON.parse(raw);
                }

                tournamentState = data;
                if (tournamentState.currentTournament === 'summer_koshien') {
                    restoreKoshienData(tournamentState.teams);
                }
                document.getElementById('save-load-modal').classList.add('hidden');
                renderTournament(tournamentState);
                alert("ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚");
            } catch (e) {
                console.error(e);
                alert("ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
            }
        }
    }


// ã‚¹ãƒ­ãƒƒãƒˆå‰Šé™¤
function deleteSlot(slotNum) {
    if (confirm(`ã‚¹ãƒ­ãƒƒãƒˆ${slotNum}ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        localStorage.removeItem(`tournament_save_slot_${slotNum}`);
        renderSaveSlots();
    }
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
document.addEventListener('click', (e) => {
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    if (e.target.id === 'tab-slots') {
        document.getElementById('content-slots').classList.remove('hidden');
        document.getElementById('content-code').classList.add('hidden');
        e.target.classList.add('border-blue-600', 'text-blue-600');
        e.target.classList.remove('border-transparent', 'text-gray-500');
        const codeTab = document.getElementById('tab-code');
        codeTab.classList.remove('border-blue-600', 'text-blue-600');
        codeTab.classList.add('border-transparent', 'text-gray-500');
        renderSaveSlots();
    }
    if (e.target.id === 'tab-code') {
        document.getElementById('content-slots').classList.add('hidden');
        document.getElementById('content-code').classList.remove('hidden');
        e.target.classList.add('border-blue-600', 'text-blue-600');
        e.target.classList.remove('border-transparent', 'text-gray-500');
        const slotsTab = document.getElementById('tab-slots');
        slotsTab.classList.remove('border-blue-600', 'text-blue-600');
        slotsTab.classList.add('border-transparent', 'text-gray-500');
    }

    // ã‚¹ãƒ­ãƒƒãƒˆæ“ä½œ
    if (e.target.matches('.save-slot-btn')) saveToSlot(e.target.dataset.slot);
    if (e.target.matches('.load-slot-btn')) loadFromSlot(e.target.dataset.slot);
    if (e.target.matches('.delete-slot-btn')) deleteSlot(e.target.dataset.slot);
    
// ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ãƒ­ãƒ¼ãƒ‰
    if (e.target.id === 'load-autosave-btn') loadFromAutosave();
// ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ã‚»ãƒ¼ãƒ–ãƒœã‚¿ãƒ³
    if (e.target.id === 'save-btn') {
        renderSaveSlots();
        document.getElementById('tab-slots').click(); // ã‚¹ãƒ­ãƒƒãƒˆã‚¿ãƒ–ã‚’é–‹ã
        // â˜… ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹å‡¦ç†ã‚’è¿½åŠ 
        document.getElementById('save-load-modal').classList.remove('hidden');
        document.getElementById('save-load-modal').classList.add('flex');
    }
    });
// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸæ™‚ã®åˆæœŸåŒ–ãƒ•ãƒƒã‚¯
const originalSaveBtnClick = document.getElementById('save-btn').onclick; // å¿µã®ãŸã‚
document.getElementById('save-btn').addEventListener('click', () => {
    renderSaveSlots();
    document.getElementById('tab-slots').click(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¹ãƒ­ãƒƒãƒˆã‚¿ãƒ–ã‚’é–‹ã
});

/**
 * [ä¿®æ­£ãƒ»å®Œå…¨ç‰ˆ] è©¦åˆã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€Œäº‹å®Ÿã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã€ã¨æ´»èºé¸æ‰‹ãƒªã‚¹ãƒˆã‚’è¿”ã™
 * (â˜…å¤‰æ•°é‡è¤‡ã‚¨ãƒ©ãƒ¼ä¿®æ­£æ¸ˆã¿)
 */
function createHighlightsText(dbMatch, winnerName) {
    // è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºã‚’è¿”ã™
    if (!dbMatch || !dbMatch.details) {
        return { highlights: [], keyPlayerNames: [] };
    }

    // å®ˆå‚™äº¤ä»£å±¥æ­´ã‚’å–å¾— (â˜…ã“ã“ã§å®£è¨€)
    const positionChanges = dbMatch.details.positionChanges || [];

    // --- å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼šãã®ã‚¤ãƒ‹ãƒ³ã‚°ãƒ»ãã®ãƒãƒ¼ãƒ ã®ã€ç‰¹å®šãƒã‚¸ã‚·ãƒ§ãƒ³ã®é¸æ‰‹åã‚’ç‰¹å®šã™ã‚‹ ---
    const getFielderName = (defensiveTeamKey, currentInning, topBottom, posKey) => {
        if (!posKey) return "";

        // 1. å®ˆå‚™äº¤ä»£å±¥æ­´ã‹ã‚‰ã€ã“ã®æ™‚ç‚¹ã§ã®æœ€æ–°ã®å®ˆå‚™è€…ã‚’æ¢ã™
        const relevantChanges = positionChanges.filter(change => {
            if (change.teamKey !== defensiveTeamKey) return false;
            if (change.newPos !== posKey) return false;
            
            const changeInning = parseInt(change.inning);
            if (changeInning < currentInning) return true; 
            if (changeInning === currentInning) {
                return true; 
            }
            return false;
        });

        // æœ€æ–°ã®å¤‰æ›´ã‚’æ¡ç”¨
        if (relevantChanges.length > 0) {
            const lastChange = relevantChanges[relevantChanges.length - 1];
            return `ãƒ»${lastChange.playerName}`;
        }

        // 2. å¤‰æ›´å±¥æ­´ã«ãªã‘ã‚Œã°ã€ã‚¹ã‚¿ãƒ¡ãƒ³ã‹ã‚‰æ¢ã™
        const roster = dbMatch.details.batting?.[defensiveTeamKey] || [];
        const starter = roster.find(p => {
            return p.pos === posKey && p.order && !p.order.includes('sub');
        });

        return starter ? `ãƒ»${starter.name}` : "";
    };

    // --- å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼šæ‰“å¸­çµæœã‚’æ—¥æœ¬èªã«ç¿»è¨³ ---
    const translateResult = (res, playerInfo, eventType = '', defensiveTeamKey, currentInning, topBottom) => {
        if (!res) return null;
        let tempRes = res.trim();

        let markPrefix = ''; 
        if (tempRes.startsWith('â˜…:')) {
            markPrefix = 'ï¼ˆâ˜…æ³¨ç›®ï¼‰';
            tempRes = tempRes.substring(3); 
        }

        let strengthPrefix = '';
        let strengthPrefixOut = '';
        if (tempRes.startsWith('S:')) {
            strengthPrefix = 'é‹­ã„';
            strengthPrefixOut = 'é‹­ã„å½“ãŸã‚Šã®';
            tempRes = tempRes.substring(2); 
        } else if (tempRes.startsWith('W:')) {
            strengthPrefix = 'è©°ã¾ã‚ŠãªãŒã‚‰ã‚‚';
            strengthPrefixOut = 'è©°ã¾ã£ãŸå½“ãŸã‚Šã®';
            tempRes = tempRes.substring(2); 
        }

        let direction = '';
        let posKey = ''; 
        const directionMap = {'æŠ•': 'ãƒ”ãƒƒãƒãƒ£ãƒ¼', 'æ•': 'ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼', 'ä¸€': 'ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ', 'äºŒ': 'ã‚»ã‚«ãƒ³ãƒ‰', 'ä¸‰': 'ã‚µãƒ¼ãƒ‰', 'éŠ': 'ã‚·ãƒ§ãƒ¼ãƒˆ', 'å·¦': 'ãƒ¬ãƒ•ãƒˆ', 'ä¸­': 'ã‚»ãƒ³ã‚¿ãƒ¼', 'å³': 'ãƒ©ã‚¤ãƒˆ'};
        const directionKeys = Object.keys(directionMap);
        
        for (const key of directionKeys) {
            if (tempRes.startsWith(key)) {
                posKey = key;
                direction = directionMap[key];
                if (!tempRes.includes('ã‚´ãƒ­') && !tempRes.includes('é£›') && !tempRes.includes('é‚ª') && !tempRes.includes('ç›´')) {
                    direction += 'ã¸';
                }
                tempRes = tempRes.substring(key.length).trim();
                break;
            }
        }

        const getFielderStr = () => getFielderName(defensiveTeamKey, currentInning, topBottom, posKey);

        let description = `${playerInfo}ãŒ`; 
        const rbiMatch = tempRes.match(/(\d+)ç‚¹/);
        const eventText = eventType ? `${eventType}ã¨ãªã‚‹` : '';

        if (tempRes.includes('æœ¬å¡æ‰“')) {
            let hrRbiText = 'ã‚½ãƒ­';
            if (rbiMatch) {
                const rbi = parseInt(rbiMatch[1]);
                if (rbi === 4) hrRbiText = 'æº€å¡';
                else if (rbi === 3) hrRbiText = '3ãƒ©ãƒ³';
                else if (rbi === 2) hrRbiText = '2ãƒ©ãƒ³';
            }
            description = `${playerInfo}ãŒ${markPrefix}${strengthPrefix ? strengthPrefix + ' ' : ''}${direction ? direction + 'ã®' : ''}${eventText}${hrRbiText}ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³ã‚’æ”¾ã£ãŸ`;
        
        } else {
            const rbiText = rbiMatch ? (parseInt(rbiMatch[1]) > 1 ? `${rbiMatch[1]}ç‚¹ã‚¿ã‚¤ãƒ ãƒªãƒ¼` : 'ã‚¿ã‚¤ãƒ ãƒªãƒ¼') : '';

            if (tempRes.includes('ä¸‰å¡æ‰“')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefix ? strengthPrefix + ' ' : ''}${direction ? direction + 'ã¸ã®' : ''}${eventText}${rbiText}ä¸‰å¡æ‰“ã‚’æ”¾ã£ãŸ`;
            else if (tempRes.includes('äºŒå¡æ‰“')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefix ? strengthPrefix + ' ' : ''}${direction ? direction + 'ã¸ã®' : ''}${eventText}${rbiText}äºŒå¡æ‰“ã‚’æ”¾ã£ãŸ`;
            
            else if (tempRes.includes('å®‰')) {
                let hitDescription = "ãƒ’ãƒƒãƒˆ";
                let actionDesc = "æ”¾ã£ãŸ";
                let adjective = ""; 

                const isInfieldStr = ['ãƒ”ãƒƒãƒãƒ£ãƒ¼', 'ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼', 'ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ', 'ã‚»ã‚«ãƒ³ãƒ‰', 'ã‚µãƒ¼ãƒ‰', 'ã‚·ãƒ§ãƒ¼ãƒˆ'].some(pos => direction.includes(pos));

                if (isInfieldStr) {
                    if (strengthPrefix === 'é‹­ã„') {
                        hitDescription = "å¼·è¥²ã®å†…é‡å®‰æ‰“";
                        adjective = "å¼·çƒˆãª";
                        strengthPrefix = ""; 
                    } 
                    else if (strengthPrefix === 'è©°ã¾ã‚ŠãªãŒã‚‰ã‚‚') {
                        hitDescription = "ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒ¼ãƒãƒ³ãƒˆ";
                        adjective = "çµ¶å¦™ãª";
                        actionDesc = "æ±ºã‚ãŸ";
                        strengthPrefix = ""; 
                    }
                    else {
                        hitDescription = "å†…é‡å®‰æ‰“";
                        adjective = "ãƒœãƒ†ãƒœãƒ†ã®";
                        actionDesc = "ã‚‚ãå–ã£ãŸ";
                    }
                    
                    description = `${playerInfo}ãŒ${markPrefix}${direction}ã¸ã®${adjective}${hitDescription}ã‚’${actionDesc}`;
                    if (rbiText) {
                         description = `${playerInfo}ãŒ${markPrefix}${direction}ã¸ã®${adjective}${hitDescription}ã‚’${actionDesc}ã€${eventText}${rbiText.replace('ã‚¿ã‚¤ãƒ ãƒªãƒ¼', '')}ç‚¹ã‚’æŒ™ã’ãŸ`;
                    }
                    return description.replace(/ã‚¿ã‚¤ãƒ ãƒªãƒ¼1ç‚¹/g, 'ã‚¿ã‚¤ãƒ ãƒªãƒ¼').replace(/1ç‚¹ã‚’æŒ™ã’ãŸ/g, 'ç‚¹ã‚’æŒ™ã’ãŸ');
                }
                
                description = `${playerInfo}ãŒ${markPrefix}${strengthPrefix ? strengthPrefix + ' ' : ''}${direction ? direction + 'ã¸ã®' : ''}${eventText}${rbiText}ãƒ’ãƒƒãƒˆã‚’æ”¾ã£ãŸ`;
            }
            
            else if (tempRes.includes('çŠ é£›')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å¤–é‡'}ã¸ã®${eventText}çŠ ç‰²ãƒ•ãƒ©ã‚¤${rbiMatch ? `ã§${rbiMatch[1]}ç‚¹` : 'ã§1ç‚¹'}ã‚’æŒ™ã’ãŸ`;
            else if (tempRes.includes('çŠ æ‰“')) {
                if (rbiMatch) description = `${playerInfo}ãŒ${markPrefix}${direction ? direction + 'ã¸' : ''}ã‚¹ã‚¯ã‚¤ã‚ºã‚’æ±ºã‚ã¦${eventText}${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
                else description = `${playerInfo}ãŒ${markPrefix}${direction ? direction + 'ã¸' : ''}é€ã‚Šãƒãƒ³ãƒˆã‚’æ±ºã‚ãŸ`;
            }
            
            else if (tempRes.includes('ã‚´ãƒ­') && rbiMatch) description = `${playerInfo}ã®${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å†…é‡'}ã‚´ãƒ­ã®é–“ã«${eventText}${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
            
            else if ((tempRes.includes('ã‚¨ãƒ©ãƒ¼') || tempRes.includes('å¤±')) && rbiMatch && !tempRes.includes('çŠ å¤±')) {
                const fielder = getFielderStr();
                description = `${playerInfo}ãŒ${markPrefix}ç›¸æ‰‹${direction ? direction + fielder + 'ã®' : ''}ã‚¿ã‚¤ãƒ ãƒªãƒ¼ã‚¨ãƒ©ãƒ¼ã§å‡ºå¡ã€${eventText}${rbiMatch[1]}ç‚¹ã‚’è¨˜éŒ²ã—ãŸ`;
            }
            else if (tempRes.includes('é‡é¸') && rbiMatch) {
                const fielder = getFielderStr();
                description = `${playerInfo}ã®${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å†…é‡'}${fielder}ã¸ã®${eventText}é‡é¸ã®é–“ã«${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
            }

            else if (tempRes.includes('å››çƒ')) {
                if (rbiMatch) description = `${playerInfo}ãŒ${markPrefix}${eventText}æŠ¼ã—å‡ºã—ã®å››çƒã‚’é¸ã³ã€${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
                else description = `${playerInfo}ãŒ${markPrefix}å››çƒã‚’é¸ã‚“ã `;
            }
            else if (tempRes.includes('æ­»çƒ')) {
                if (rbiMatch) description = `${playerInfo}ãŒ${markPrefix}${eventText}æŠ¼ã—å‡ºã—ã®æ­»çƒã‚’å—ã‘ã€${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
                else description = `${playerInfo}ãŒ${markPrefix}æ­»çƒã§å‡ºå¡ã—ãŸ`;
            }
            else if (tempRes.includes('æ•¬é ')) {
                if (rbiMatch) description = `${playerInfo}ãŒ${markPrefix}${eventText}æŠ¼ã—å‡ºã—ã®æ•¬é å››çƒã‚’é¸ã³ã€${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
                else description = `${playerInfo}ãŒ${markPrefix}${eventText}æ•¬é å››çƒã§å‡ºå¡ã—ãŸ`;
            }
            
            else if (tempRes.includes('ä¸‰æŒ¯')) description = `${playerInfo}ãŒ${markPrefix}ä¸‰æŒ¯ã«å€’ã‚ŒãŸ`;
            else if (tempRes.includes('ä½µæ®º')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å†…é‡'}ã‚´ãƒ­ã§ä½µæ®ºæ‰“ã«å€’ã‚ŒãŸ`;
            else if (tempRes.includes('é‚ª')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'ãƒ•ã‚¡ã‚¦ãƒ«ã‚¾ãƒ¼ãƒ³'}ã¸ã®é‚ªé£›ã«å€’ã‚ŒãŸ`;
            else if (tempRes.includes('ã‚´ãƒ­')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å†…é‡'}ã‚´ãƒ­ã«å€’ã‚ŒãŸ`;
            else if (tempRes.includes('é£›')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || 'å¤–é‡'}ãƒ•ãƒ©ã‚¤ã«å€’ã‚ŒãŸ`;
            else if (tempRes.includes('ç›´')) description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction || ''}ãƒ©ã‚¤ãƒŠãƒ¼ã«å€’ã‚ŒãŸ`;
            
            else if (tempRes.includes('çŠ å¤±')) {
                 const fielder = getFielderStr();
                 if (rbiMatch) description = `${playerInfo}ãŒ${markPrefix}${direction ? direction + fielder + 'ã¸ã®' : ''}çŠ ç‰²æ‰“ã‚’æ”¾ã¤ã‚‚å¤±ç­–ã¨ãªã‚Šå‡ºå¡ã€${eventText}${rbiMatch[1]}ç‚¹ã‚’æŒ™ã’ãŸ`;
                 else description = `${playerInfo}ã®${markPrefix}${direction ? direction + fielder + 'ã¸ã®' : ''}çŠ ç‰²ãƒãƒ³ãƒˆãŒç›¸æ‰‹ã®å¤±ç­–ã‚’èª˜ã„ã€å‡ºå¡ã—ãŸ`;
            }
            else if (tempRes.includes('ã‚¨ãƒ©ãƒ¼') || tempRes.includes('å¤±')) {
                const fielder = getFielderStr();
                description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}ç›¸æ‰‹${direction ? direction + fielder + 'ã®' : ''}ã‚¨ãƒ©ãƒ¼ã§å‡ºå¡ã—ãŸ`;
            }
            else if (tempRes.includes('é‡é¸')) {
                const fielder = getFielderStr();
                description = `${playerInfo}ãŒ${markPrefix}${strengthPrefixOut ? strengthPrefixOut + ' ' : ''}${direction ? direction + fielder + 'ã¸ã®' : ''}é‡é¸ã§å‡ºå¡ã—ãŸ`;
            }
            else return null;
        }

        return description.replace(/ã‚¿ã‚¤ãƒ ãƒªãƒ¼1ç‚¹/g, 'ã‚¿ã‚¤ãƒ ãƒªãƒ¼').replace(/1ç‚¹ã‚’æŒ™ã’ãŸ/g, 'ç‚¹ã‚’æŒ™ã’ãŸ');
    };

    // --- åˆæœŸåŒ– ---
    const highlights = []; 
    const keyPlayerNames = new Set(); 
    const winningTeamKey = dbMatch.team1 === winnerName ? 'team1' : 'team2';
    const losingTeamKey = winningTeamKey === 'team1' ? 'team2' : 'team1';
    const numInnings = dbMatch.details.inningScore?.team1?.length || 9;
    const inningScores = dbMatch.details.inningScore || { team1: Array(numInnings).fill(0), team2: Array(numInnings).fill(0) };

    let hasScored = false;
    let isReversed = false;
    let cumulativeScores = { team1: 0, team2: 0 };
    let batterIndices = { team1: 0, team2: 0 };
        
    // --- 1. ã‚¤ãƒ‹ãƒ³ã‚°ã”ã¨ã®ãƒ—ãƒ¬ãƒ¼ã‚’è§£æ ---
    for (let i = 0; i < numInnings; i++) {
        const currentInning = i + 1;
        const scoreBeforeInning = { ...cumulativeScores };

        for (const teamKey of ['team1', 'team2']) {
            const teamName = dbMatch[teamKey];
            const opponentTeamKey = teamKey === 'team1' ? 'team2' : 'team1';
            const topBottom = teamKey === 'team1' ? 'è¡¨' : 'è£';

            const allBattingData = dbMatch.details.batting?.[teamKey] || [];
            if (allBattingData.length === 0) continue;

            const sortedBattingOrder = allBattingData
                .filter(p => p.name) 
                .sort((a,b) => parseFloat(a.order.replace('-sub','.')) - parseFloat(b.order.replace('-sub','.')));
            if (sortedBattingOrder.length === 0) continue;

            let playsInHalfInning = [];
            sortedBattingOrder.forEach(player => {
                const resultString = player.results?.[i];
                if (resultString) {
                    resultString.split('ã€').forEach(atBatString => {
                        if(atBatString) {
                            playsInHalfInning.push({ player, atBatString });
                        }
                    });
                }
            });
            if (playsInHalfInning.length === 0) continue;

            // æ‰“é †ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«åŸºã¥ãä¸¦ã¹æ›¿ãˆ
            const startingBatterIndex = batterIndices[teamKey]; 
            const orderedPlays = []; 
            let currentBatterIndex = startingBatterIndex; 
            let playsFoundCount = 0; 
            const atBatsCountPerPlayer = {}; 

            while (orderedPlays.length < playsInHalfInning.length && playsFoundCount < playsInHalfInning.length * 2) {
                 const currentPlayer = sortedBattingOrder[currentBatterIndex]; 
                 const playerOrderKey = currentPlayer.order; 
                 const currentAtBatOrdinal = atBatsCountPerPlayer[playerOrderKey] || 0; 

                 let foundPlayIndex = -1;
                 let searchCount = 0;
                 for(let k=0; k < playsInHalfInning.length; k++){
                     if(playsInHalfInning[k].player.order === playerOrderKey) {
                         if(searchCount === currentAtBatOrdinal) {
                             if (!orderedPlays.includes(playsInHalfInning[k])) {
                                 foundPlayIndex = k;
                                 break;
                             }
                         }
                         searchCount++;
                     }
                 }

                 if (foundPlayIndex !== -1) {
                     orderedPlays.push(playsInHalfInning[foundPlayIndex]);
                     atBatsCountPerPlayer[playerOrderKey] = currentAtBatOrdinal + 1; 
                     currentBatterIndex = (currentBatterIndex + 1) % sortedBattingOrder.length;
                 } else {
                     currentBatterIndex = (currentBatterIndex + 1) % sortedBattingOrder.length;
                 }
                 playsFoundCount++; 
            }
            const finalOrderedPlays = orderedPlays.length === playsInHalfInning.length ? orderedPlays : playsInHalfInning;

            // ãƒã‚¤ãƒ©ã‚¤ãƒˆç”Ÿæˆ
            finalOrderedPlays.forEach(play => {
                const { player, atBatString } = play;
                const [batterPlay, runnerPlaysString] = atBatString.split(';'); 

                let playerRole = '';
                if (player.order.includes('sub')) {
                    switch(player.sub_type) {
                        case 'PH': playerRole = 'ä»£æ‰“ã®'; break;
                        case 'PR': playerRole = 'ä»£èµ°ã®'; break;
                        case 'DEF': playerRole = 'å®ˆå‚™ã‹ã‚‰é€”ä¸­å‡ºå ´ã®'; break;
                        case 'PITCHER': playerRole = 'ãƒªãƒªãƒ¼ãƒ•ã®'; break;
                        default: playerRole = 'é€”ä¸­å‡ºå ´ã®';
                    }
                } else {
                     playerRole = `${player.order}ç•ª`; 
                }
                const playerInfo = `${playerRole}${player.name}`;

                if (batterPlay && batterPlay.trim() !== '') {
                    let eventType = ''; 
                    const isScorePlay = batterPlay.includes('ç‚¹') || batterPlay.toLowerCase().includes('hr') || batterPlay.includes('æœ¬');

                    if (isScorePlay) {
                        const prevScoreSelf = scoreBeforeInning[teamKey];
                        const prevScoreOpp = scoreBeforeInning[opponentTeamKey];
                        const rbiMatch = batterPlay.match(/(\d+)ç‚¹/);
                        let addedScore = rbiMatch ? parseInt(rbiMatch[1]) : (batterPlay.includes('ç‚¹') ? 1 : 0);
                        if (batterPlay.includes('æœ¬')) addedScore = Math.max(1, addedScore);
                        
                        const newScoreSelf = prevScoreSelf + addedScore;

                        if (prevScoreSelf === 0 && prevScoreOpp === 0) {
                            eventType = 'å…ˆåˆ¶'; 
                            hasScored = true;
                        } 
                        else if (prevScoreSelf < prevScoreOpp && newScoreSelf > prevScoreOpp && !isReversed) {
                            eventType = 'é€†è»¢';
                            isReversed = true; 
                        } 
                        else if (prevScoreSelf === prevScoreOpp && newScoreSelf > prevScoreOpp) {
                            eventType = 'å‹ã¡è¶Šã—';
                        }
                        else if (prevScoreSelf < prevScoreOpp && newScoreSelf === prevScoreOpp) {
                             eventType = 'åŒç‚¹'; 
                        } 
                        else if (prevScoreSelf >= prevScoreOpp) {
                             eventType = 'è¿½åŠ ç‚¹'; 
                        } 
                        else {
                             eventType = 'åæ’ƒ'; 
                        }
                    }

                    const description = translateResult(batterPlay, playerInfo, eventType, opponentTeamKey, currentInning, topBottom);
                    if (description) {
                        highlights.push({ inning: currentInning, team: teamName, player: player.name, description });
                        keyPlayerNames.add(player.name);
                    }
                }

                if (runnerPlaysString) {
                    runnerPlaysString.split(',').forEach(runnerPlay => {
                        if (!runnerPlay) return;
                        const runnerPlayParts = runnerPlay.trim().split(' ');
                        if (runnerPlayParts.length < 2) return;
                        
                        const runnerName = runnerPlayParts[0];
                        const playType = runnerPlayParts[1];
                        const detail = runnerPlayParts.slice(2).join(' ') || '';
                        
                        let description = `${runnerName}ãŒ`;

                        if (playType === 'ç›—å¡') {
                            if (detail.includes('æœ¬å¡')) description += `ãƒ›ãƒ¼ãƒ ã‚¹ãƒãƒ¼ãƒ«ï¼ˆé‡ç›—ï¼‰ã‚’æˆåŠŸã•ã›ãŸ`;
                            else description += `ç›—å¡æˆåŠŸï¼ˆ${detail}ï¼‰`;
                        }
                        else if (playType === 'ã‚¿ãƒƒãƒã‚¢ãƒƒãƒ—') description += `ã‚¿ãƒƒãƒã‚¢ãƒƒãƒ—ã‹ã‚‰${detail}`;
                        else if (playType === 'ç”Ÿé‚„' || (playType === 'é€²å¡' && detail.includes('ç”Ÿé‚„'))) description += `ãƒ›ãƒ¼ãƒ ã‚¤ãƒ³`;
                        
                        else if (playType === 'é€çƒé–“ã«é€²å¡') {
                            if (detail.includes('æœ¬å¡')) description += `ã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼ã®é€çƒã®éš™ã‚’çªãã€ãƒ›ãƒ¼ãƒ ã‚’é™¥ã‚Œã‚‹å¥½èµ°å¡ã‚’è¦‹ã›ãŸ`;
                            else description += `é€çƒã®é–“ã«${detail}é€²å¡ã™ã‚‹å¥½èµ°å¡ã‚’è¦‹ã›ãŸ`;
                        }

                        else if (playType === 'ç›—å¡æ­»') description += `ç›—å¡å¤±æ•—`;
                        else if (playType === 'ç‰½åˆ¶æ­»') description += `ç‰½åˆ¶ã‚¢ã‚¦ãƒˆ`;
                        else if (playType === 'èµ°å¡æ­»') description += `èµ°å¡æ­»`;
                        else if (playType === 'æŒŸæ®ºãƒ—ãƒ¬ãƒ¼ã§ã‚¢ã‚¦ãƒˆ') description += `æŒŸæ®ºã‚¢ã‚¦ãƒˆ`;
                        else if (playType.includes('ã‚¢ã‚¦ãƒˆ')) description += `èµ°å¡ä¸­ã«ã‚¢ã‚¦ãƒˆ`;
                        else description += `${playType} ${detail}`.trim();

                        highlights.push({ type: 'baserunning', inning: currentInning, team: teamName, player: runnerName, description: description });
                        keyPlayerNames.add(runnerName);
                    });
                }
            });

            if (finalOrderedPlays.length > 0) {
                 const lastPlayer = finalOrderedPlays[finalOrderedPlays.length - 1].player;
                 const lastBatterIndexInLineup = sortedBattingOrder.findIndex(p => p.order === lastPlayer.order);
                 if (lastBatterIndexInLineup !== -1) {
                      batterIndices[teamKey] = (lastBatterIndexInLineup + 1) % sortedBattingOrder.length;
                 } else {
                      batterIndices[teamKey] = (startingBatterIndex + finalOrderedPlays.length) % sortedBattingOrder.length;
                 }
            }
        }
        cumulativeScores.team1 += parseInt(inningScores.team1?.[i] || 0);
        cumulativeScores.team2 += parseInt(inningScores.team2?.[i] || 0);
    } 

    // --- 2. è©¦åˆå…¨ä½“ã®å€‹åˆ¥è¦ç´ ã‚’åˆ†æ ---
    // æƒœæ•—æŠ•æ‰‹
    const loserName = dbMatch[losingTeamKey];
    const losingPitchers = dbMatch.details.pitching?.[losingTeamKey] || [];
    if (losingPitchers.length === 1) {
        const ace = losingPitchers[0];
        if (ace.result === 'L' && parseFloat(ace.innings || 0) >= 8 && parseInt(ace.earnedRuns || 0) <= 2) {
             highlights.push({ type: 'tough_loss', team: loserName, player: ace.name, description: `${ace.name}æŠ•æ‰‹ã¯${ace.innings}å›ã‚’${ace.earnedRuns}å¤±ç‚¹ã¨å¥½æŠ•ã—ãŸãŒã€æ‰“ç·šã®æ´è­·ã«æµã¾ã‚Œãªã‹ã£ãŸ` });
             keyPlayerNames.add(ace.name);
        }
    }

    // ä»£æ‰“ãƒ’ãƒƒãƒˆ
    for (const teamKey of ['team1', 'team2']) {
        const teamName = dbMatch[teamKey];
        const opponentTeamKey = teamKey === 'team1' ? 'team2' : 'team1';
        const teamBatting = dbMatch.details.batting?.[teamKey] || [];
        const substitutes = teamBatting.filter(p => p.sub_type && p.sub_type === 'PH');
        substitutes.forEach(subPlayer => {
            for (let i = 0; i < numInnings; i++) {
                const resultInInning = subPlayer.results?.[i];
                if (resultInInning) {
                    if (resultInInning.includes('å®‰') || resultInInning.includes('æœ¬') || resultInInning.includes('äºŒ') || resultInInning.includes('ä¸‰')) {
                         let playerRole = 'ä»£æ‰“ã®';
                         const playerInfo = `${playerRole}${subPlayer.name}`;
                         const description = translateResult(resultInInning, playerInfo, '', opponentTeamKey, i+1, teamKey==='team1'?'è¡¨':'è£'); 
                         if(description){
                              highlights.push({ type: 'substitute_hit', inning: i + 1, team: teamName, player: subPlayer.name, description: `${description}ã€‚è¦‹äº‹èµ·ç”¨ã«å¿œãˆãŸ` });
                              keyPlayerNames.add(subPlayer.name);
                         }
                    }
                    break; 
                }
            }
        });
    }

    // æŠ•æ‰‹æˆç¸¾ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    for (const teamKey of ['team1', 'team2']) {
        const teamName = dbMatch[teamKey];
        const pitchingData = dbMatch.details.pitching?.[teamKey] || [];
        if (!pitchingData) continue;
        let pitchingRelayTextParts = []; 
        pitchingData.forEach((pitcher, pIdx) => {
            if (!pitcher.name || !pitcher.innings) return;
            const resultMark = {'W': 'â—‹', 'L': 'â—', 'S': 'ï¼³', 'H': 'ï¼¨'}[pitcher.result] || '';
            const statsDetail = `(${pitcher.innings}å› æ‰“${pitcher.battersFaced || '-'} çƒ${pitcher.pitches || '-'} è¢«${pitcher.hits || '0'} å¥ª${pitcher.strikeouts || '0'} ä¸${pitcher.walks || '0'} å¤±${pitcher.runs || '0'} è‡ª${pitcher.earnedRuns || '0'})`;
            let description = `${resultMark}${pitcher.name} ${statsDetail}`;

            let inningWhenChanged = '?'; 
            let isMidInningChange = false;
            let outsWhenChanged = 0;
            let situation = ''; 

            if (pIdx > 0) {
                const prevPitcher = pitchingData[pIdx - 1];
                if (prevPitcher.innings) {
                    const prevInningsStr = prevPitcher.innings.toString();
                    if (prevInningsStr.includes('.')) {
                        isMidInningChange = true;
                        const parts = prevInningsStr.split('.');
                        inningWhenChanged = parseInt(parts[0]) + 1;
                        outsWhenChanged = parseInt(parts[1] || 0);
                    } else {
                        isMidInningChange = false;
                        inningWhenChanged = Math.floor(parseFloat(prevInningsStr)) + 1;
                        outsWhenChanged = 0;
                    }
                    if (isNaN(inningWhenChanged)) inningWhenChanged = '?';

                    if (inningWhenChanged !== '?' && isMidInningChange) {
                        const opponentTeamKey = teamKey === 'team1' ? 'team2' : 'team1';
                        const opponentBatting = dbMatch.details.batting?.[opponentTeamKey] || [];
                        if (opponentBatting.length > 0) {
                            const opponentStartingBatterIdx = batterIndices[opponentTeamKey];
                            const simulationResult = simulateHalfInningUntilOuts(opponentBatting, inningWhenChanged - 1, outsWhenChanged, opponentStartingBatterIdx);
                            if (simulationResult) {
                                const runnerCount = simulationResult.runners.filter(r => r !== null).length;
                                if (runnerCount === 3) situation = 'æº€å¡ã®ãƒ”ãƒ³ãƒã§';
                                else if (runnerCount > 0) situation = `${runnerCount}è€…ã‚’èƒŒè² ã„`;
                            }
                        }
                    }
                }
            } else {
                inningWhenChanged = 1; 
            }

            if (pIdx > 0 && inningWhenChanged !== '?') {
                 if (isMidInningChange) description = `${inningWhenChanged}å›${outsWhenChanged}æ­»${situation}ç™»æ¿ã—ãŸ${description}`;
                 else description = `${inningWhenChanged}å›ã‹ã‚‰ç™»æ¿ã—ãŸ${description}`;
            } else if (pIdx === 0) description = `å…ˆç™ºã®${description}`; 

            if (pitcher.runs === '0' && parseFloat(pitcher.innings) >= 7 && pitcher.result === 'W') description += ' è¦‹äº‹ãªå®Œå°å‹åˆ©';
            else if (parseInt(pitcher.strikeouts) >= 10) description += ` ${pitcher.strikeouts}å¥ªä¸‰æŒ¯ã®å¿«æŠ•`;
            else if (pitcher.result === 'L' && parseFloat(pitcher.innings) >= 8 && parseInt(pitcher.earnedRuns) <= 2) description += ' å¥½æŠ•ã‚‚å ±ã‚ã‚Œãš';

            highlights.push({
                type: 'pitching_performance', 
                inning: inningWhenChanged !== '?' ? inningWhenChanged : undefined, 
                team: teamName,
                player: pitcher.name,
                description: description
            });
            keyPlayerNames.add(pitcher.name);
            pitchingRelayTextParts.push(`${pitcher.name}(${pitcher.innings}å›)`);
        }); 
        if (pitchingRelayTextParts.length > 1) {
             highlights.push({ type: 'pitching_relay', team: teamName, description: `æŠ•æ‰‹ãƒªãƒ¬ãƒ¼ã¯ ${pitchingRelayTextParts.join(' â†’ ')} ã ã£ãŸ` });
        }
    }

   // å®ˆå‚™äº¤ä»£ (â˜…ä¿®æ­£æ¸ˆã¿)
    positionChanges.forEach(change => {
        const teamName = dbMatch[change.teamKey];
        if (!teamName || !change.playerName || !change.newPos) return;
        let description = "";
        let situation = "";
        if (change.timing === 'mid') {
            const outs = change.outs || '0';
            const runners = change.runners || {};
            let runnerDesc = [];
            if (runners.r1) runnerDesc.push("1å¡");
            if (runners.r2) runnerDesc.push("2å¡");
            if (runners.r3) runnerDesc.push("3å¡");
            if (runnerDesc.length === 3) situation = `${outs}ã‚¢ã‚¦ãƒˆ æº€å¡`;
            else if (runnerDesc.length > 0) situation = `${outs}ã‚¢ã‚¦ãƒˆ ${runnerDesc.join(', ')}`;
            else situation = `${outs}ã‚¢ã‚¦ãƒˆ ãƒ©ãƒ³ãƒŠãƒ¼ãªã—`;
            situation += "ã®å ´é¢ã§ã€";
        }
        description = `${change.inning}å›${change.topBottom}ã€${situation}${change.playerName}ãŒ${change.newPos}ã®å®ˆå‚™ã«å°±ã„ãŸ`;
        highlights.push({ type: 'substitution', inning: parseInt(change.inning) || null, team: teamName, player: change.playerName, description: description });
        keyPlayerNames.add(change.playerName);
    });

    // å®ˆå‚™ã‚¨ãƒ©ãƒ¼/ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ (å¤‰æ›´ãªã—)
    for (const teamKey of ['team1', 'team2']) {
        const teamName = dbMatch[teamKey];
        const fieldingPlays = dbMatch.details.fielding?.[teamKey] || [];
        const errorKeywords = ['ã‚¨ãƒ©ãƒ¼', 'ãƒˆãƒ³ãƒãƒ«', 'è½çƒ', 'å¾Œé€¸', 'æ‚ªé€çƒ', 'ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«'];
        fieldingPlays.forEach(play => {
            if (play.player && play.play) {
                let description = '';
                const isError = errorKeywords.some(keyword => play.play.includes(keyword));
                if (isError) description = `${play.player}ãŒ${play.play}ã®ç—›æ¨ã®ãƒŸã‚¹ã‚’çŠ¯ã—ãŸ`;
                else description = `${play.player}ãŒ${play.play}ã®ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚’è¦‹ã›ãŸ`;
                highlights.push({ type: isError ? 'fielding_error' : 'fielding_fine_play', inning: play.inning || null, team: teamName, player: play.player, description: description });
                keyPlayerNames.add(play.player);
            }
        });
    }

    // --- 4. ç·æ‹¬ãƒã‚¤ãƒ©ã‚¤ãƒˆç”Ÿæˆ (å¤‰æ›´ãªã—) ---
    let summaryHighlight = null;
    const winnerScore = parseInt(dbMatch[winningTeamKey === 'team1' ? 'score1' : 'score2'] || 0);
    const loserScore = parseInt(dbMatch[losingTeamKey === 'team1' ? 'score1' : 'score2'] || 0);
    const totalRuns = winnerScore + loserScore; 
    const winnerHits = Object.values(dbMatch.details.playerGameStats?.[winningTeamKey] || {}).reduce((sum, s) => sum + (s.h || 0), 0);
    const loserHits = Object.values(dbMatch.details.playerGameStats?.[losingTeamKey] || {}).reduce((sum, s) => sum + (s.h || 0), 0);
    const totalHits = winnerHits + loserHits; 
    let scoreAfter6th = { team1: 0, team2: 0 };
    if(inningScores?.team1 && inningScores?.team2){
        for(let i = 0; i < Math.min(numInnings, 6); i++) {
             scoreAfter6th.team1 += parseInt(inningScores.team1[i] || 0);
             scoreAfter6th.team2 += parseInt(inningScores.team2[i] || 0);
        }
    }
    const winnerScoreAfter6th = scoreAfter6th[winningTeamKey];
    const loserScoreAfter6th = scoreAfter6th[losingTeamKey];
    const lastInning = numInnings - 1; 
    let isSayonara = false;
    if (lastInning >= 8 && winningTeamKey === 'team2') {
        const scoreInLast = parseInt(inningScores?.team2[lastInning] || 0); 
        const scoreBeforeLast = winnerScore - scoreInLast; 
        if (scoreInLast > 0 && scoreBeforeLast <= loserScore) {
            isSayonara = true;
        }
    }

    let mvpPlayer = null; 
    let mvpPerformance = ''; 
    const winnerBattingStats = dbMatch.details.playerGameStats?.[winningTeamKey] || {};
    for (const playerName in winnerBattingStats) {
        const stats = winnerBattingStats[playerName];
        if (!stats || !stats.played) continue; 
        if (stats.hr >= 2) { mvpPlayer = playerName; mvpPerformance = `${stats.hr}æœ¬å¡æ‰“`; break; }
        if (stats.rbi >= 4) { mvpPlayer = playerName; mvpPerformance = `${stats.rbi}æ‰“ç‚¹`; break; }
        if (stats.h >= 4) { mvpPlayer = playerName; mvpPerformance = `${stats.h}å®‰æ‰“`; break; }
    }
    const winnerPitchingData = dbMatch.details.pitching?.[winningTeamKey] || [];
    if (!mvpPlayer && winnerPitchingData.length > 0) {
        winnerPitchingData.forEach(pitcher => {
            if (!pitcher.name || !pitcher.innings) return;
            const innings = parseFloat(pitcher.innings);
            const runs = parseInt(pitcher.runs || 0); 
            const strikeouts = parseInt(pitcher.strikeouts || 0);
            if (pitcher.result === 'W') { 
                 if (runs === 0 && innings >= 7) { mvpPlayer = pitcher.name; mvpPerformance = `å®Œå°å‹åˆ©`; }
                 else if (strikeouts >= 10 && innings >= 6) { mvpPlayer = pitcher.name; mvpPerformance = `${strikeouts}å¥ªä¸‰æŒ¯ã®å¿«æŠ•`; }
                 else if (innings >= 6 && parseInt(pitcher.earnedRuns || 0) <= 1) { mvpPlayer = pitcher.name; mvpPerformance = `å¥½æŠ•ã§è©¦åˆã‚’ä½œã‚‹`; }
            }
             else if (pitcher.result === 'S' && innings >= 2 && parseInt(pitcher.earnedRuns || 0) === 0) { mvpPlayer = pitcher.name; mvpPerformance = `å¥½ãƒªãƒªãƒ¼ãƒ•ã§è©¦åˆã‚’ç· ã‚ã‚‹`; }
        });
    }
    let isRelaySuccess = false;
    if (!mvpPlayer && winnerPitchingData.length > 1) {
        const totalER = winnerPitchingData.reduce((sum, p) => sum + parseInt(p.earnedRuns || 0), 0);
        const totalIP = winnerPitchingData.reduce((sum, p) => sum + parseFloat(p.innings || 0), 0);
        if (totalER <= 2 && totalIP >= (numInnings - 1)) isRelaySuccess = true;
    }

    let lateGameColdSummary = null;
    if (dbMatch.calledGame && dbMatch.calledInning >= 6) {
        const checkInningEnd = dbMatch.calledInning - 1; 
        let scoreBeforeBigInning = { team1: 0, team2: 0 };
        if(inningScores?.team1 && inningScores?.team2){
            for(let i = 0; i < Math.min(numInnings, checkInningEnd); i++) { 
                 scoreBeforeBigInning.team1 += parseInt(inningScores.team1[i] || 0);
                 scoreBeforeBigInning.team2 += parseInt(inningScores.team2[i] || 0);
            }
        }
        const winnerScoreBefore = scoreBeforeBigInning[winningTeamKey];
        const loserScoreBefore = scoreBeforeBigInning[losingTeamKey];
        const scoreDiffBefore = Math.abs(winnerScoreBefore - loserScoreBefore);
        if (scoreDiffBefore <= 3) {
            lateGameColdSummary = { type: 'summary', description: `${checkInningEnd}å›ã¾ã§${scoreDiffBefore}ç‚¹å·®ã®æ¥æˆ¦ã ã£ãŸãŒã€${dbMatch.calledInning}å›ã«${winnerName}ãŒä¸€æŒ™çŒ›æ”»ã§è©¦åˆã‚’æ±ºã‚ã€ã‚³ãƒ¼ãƒ«ãƒ‰å‹ã¡ã‚’åã‚ãŸ` };
        }
    }

    if (mvpPlayer) summaryHighlight = { type: 'summary', description: `${mvpPlayer}ã®${mvpPerformance}ã®æ´»èºã§ã€${winnerName}ãŒå‹åˆ©ã‚’æ´ã‚“ã ` };
    else if (isRelaySuccess) summaryHighlight = { type: 'summary', description: `${winnerName}æŠ•æ‰‹é™£ãŒ${loserName}æ‰“ç·šã‚’${loserScore}å¤±ç‚¹ã«æŠ‘ãˆã‚‹è¦‹äº‹ãªç¶™æŠ•ç­–ã§å‹åˆ©` };
    else if (isSayonara) summaryHighlight = { type: 'summary', description: `åŠ‡çš„ãªã‚µãƒ¨ãƒŠãƒ©å‹ã¡ã§ã€${winnerName}ãŒç†±æˆ¦ã«çµ‚æ­¢ç¬¦ã‚’æ‰“ã£ãŸ` };
    else if (lateGameColdSummary) summaryHighlight = lateGameColdSummary;
    else if (winnerScoreAfter6th < loserScoreAfter6th && winnerScore > loserScore && numInnings >= 7) summaryHighlight = { type: 'summary', description: `${winnerName}ãŒçµ‚ç›¤ã«è¦‹äº‹ãªé€†è»¢åŠ‡ã‚’æ¼”ã˜ã€å‹åˆ©ã‚’æ´ã‚“ã ` };
    else if (totalRuns <= 5 && totalHits <= 12) summaryHighlight = { type: 'summary', description: `ä¸¡ãƒãƒ¼ãƒ åˆã‚ã›ã¦${totalHits}å®‰æ‰“${totalRuns}å¾—ç‚¹ã«çµ‚ã‚ã‚‹ã€æ¯è©°ã¾ã‚‹æŠ•æ‰‹æˆ¦ã¨ãªã£ãŸ` };
    else if (totalRuns >= 13 && totalHits >= 20) summaryHighlight = { type: 'summary', description: `ä¸¡ãƒãƒ¼ãƒ åˆã‚ã›ã¦${totalHits}å®‰æ‰“${totalRuns}å¾—ç‚¹ãŒä¹±ã‚Œé£›ã¶ã€å£®çµ¶ãªæ‰“æ’ƒæˆ¦ã¨ãªã£ãŸ` };
    else if (winnerScore - loserScore >= 7) summaryHighlight = { type: 'summary', description: `${winnerName}ãŒæŠ•æ‰“ã«ç›¸æ‰‹ã‚’åœ§å€’ã—ã€${winnerScore}-${loserScore}ã§å¿«å‹ã—ãŸ` };
    else if (winnerScore - loserScore <= 2) summaryHighlight = { type: 'summary', description: `${winnerName}ãŒ${loserName}ã®ç²˜ã‚Šå¼·ã„è¿½æ’ƒã‚’æŒ¯ã‚Šåˆ‡ã‚Šã€${winnerScore}-${loserScore}ã§æ¥æˆ¦ã‚’åˆ¶ã—ãŸ` };
    else summaryHighlight = { type: 'summary', description: `${winnerName}ãŒ${loserName}ã‚’ä¸‹ã—ã€${winnerScore}-${loserScore}ã§å‹åˆ©ã—ãŸ` };

    if (summaryHighlight) highlights.unshift(summaryHighlight);
    
    return { 
        highlights: highlights, 
        keyPlayerNames: Array.from(keyPlayerNames),
        summaryHighlight: summaryHighlight ? summaryHighlight.description : null 
    };
}

// â–¼â–¼â–¼ ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼šäº¤ä»£çŠ¶æ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ (â˜…è¤‡æ•°æ‰“å¸­å¯¾å¿œãƒ»å…ˆé ­æ‰“è€…æŒ‡å®šç‰ˆâ˜…) â–¼â–¼â–¼
/**
 * æŒ‡å®šã•ã‚ŒãŸã‚¤ãƒ‹ãƒ³ã‚°ã®æ”»æ’ƒã‚’ã€ç‰¹å®šã®ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆã«ãªã‚‹ã¾ã§ç°¡æ˜“çš„ã«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹
 * @param {Array} battingOrder - ç›¸æ‰‹ãƒãƒ¼ãƒ ã®æ‰“é †ãƒ‡ãƒ¼ã‚¿ (ã‚½ãƒ¼ãƒˆæ¸ˆã¿)
 * @param {number} inningIndex - ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯¾è±¡ã‚¤ãƒ‹ãƒ³ã‚°ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (0å§‹ã¾ã‚Š)
 * @param {number} targetOuts - ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢ã™ã‚‹ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆ
 * @param {number} startingBatterIdx - ã“ã®ã‚¤ãƒ‹ãƒ³ã‚°ã®å…ˆé ­æ‰“è€…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
 * @returns {object | null} - { runners: [1B, 2B, 3B], outs: number, scoreSelf: number, scoreOpp: number, nextBatterIdx: number } ã¾ãŸã¯ null
 */
function simulateHalfInningUntilOuts(battingOrder, inningIndex, targetOuts, startingBatterIdx) {
    if (!battingOrder || battingOrder.length === 0 || targetOuts < 0 || targetOuts > 3) return null;

    let outs = 0;
    let runners = [null, null, null]; // 1B, 2B, 3B
    let scoreSelf = 0; // ä»®ã‚¹ã‚³ã‚¢ (å®ˆå‚™å´)
    let scoreOpp = 0;  // ä»®ã‚¹ã‚³ã‚¢ (æ”»æ’ƒå´)

    let currentBatterIndex = startingBatterIdx; // å…ˆé ­æ‰“è€…ã‹ã‚‰é–‹å§‹
    let playsProcessedCount = 0; // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ & ãƒ‡ãƒãƒƒã‚°ç”¨
    const atBatsCountThisInning = {}; // ã“ã®ã‚¤ãƒ‹ãƒ³ã‚°ã§ã®å„æ‰“è€…ã®æ‰“å¸­æ•° { "1": 0, "2": 1, ... }

    // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯¾è±¡ã‚¤ãƒ‹ãƒ³ã‚°ã®å…¨ãƒ—ãƒ¬ãƒ¼ã‚’äº‹å‰ã«åé›†ãƒ»æ‰“å¸­é †ã«ä¸¦ã¹æ›¿ãˆã‚‹
    const playsForInning = [];
     battingOrder.forEach(player => {
         const resultString = player.results?.[inningIndex];
         if (resultString) {
             resultString.split('ã€').forEach(atBat => {
                 if(atBat) playsForInning.push({ player, atBat });
             });
         }
     });
     if (playsForInning.length === 0) return { runners, outs, scoreSelf, scoreOpp, nextBatterIdx: startingBatterIdx };

     // æ‰“é †ä¸¦ã¹æ›¿ãˆ (createHighlightsText ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯)
     const orderedPlays = [];
     let tempBatterIndex = startingBatterIdx;
     let playsCount = 0;
     const processedFlags = new Array(playsForInning.length).fill(false);
     const atBatsTempCount = {};
     while (orderedPlays.length < playsForInning.length && playsCount < playsForInning.length * 2) {
         const currentPlayer = battingOrder[tempBatterIndex];
         const playerOrderKey = currentPlayer.order;
         const currentAtBatOrdinal = atBatsTempCount[playerOrderKey] || 0;
         let foundPlayIndex = -1;
         let searchCount = 0;
         for(let k=0; k < playsForInning.length; k++){
             if(playsForInning[k].player.order === playerOrderKey && !processedFlags[k]) {
                 if(searchCount === currentAtBatOrdinal) {
                     foundPlayIndex = k;
                     break;
                 }
                 searchCount++;
             }
         }
         if (foundPlayIndex !== -1) {
             orderedPlays.push(playsForInning[foundPlayIndex]);
             processedFlags[foundPlayIndex] = true;
             atBatsTempCount[playerOrderKey] = currentAtBatOrdinal + 1;
             tempBatterIndex = (tempBatterIndex + 1) % battingOrder.length;
         } else {
             tempBatterIndex = (tempBatterIndex + 1) % battingOrder.length;
         }
         playsCount++;
     }
     const finalOrderedPlays = orderedPlays.length === playsForInning.length ? orderedPlays : playsForInning;


    // ä¸¦ã¹æ›¿ãˆãŸãƒ—ãƒ¬ãƒ¼ã‚’é †ç•ªã«å‡¦ç†ã—ã€targetOuts ã«é”ã™ã‚‹ã¾ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    for (const playData of finalOrderedPlays) {
        if (outs >= targetOuts) break; // ç›®æ¨™ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆã«é”ã—ãŸã‚‰çµ‚äº†

        const { player, atBat } = playData;
        const [batterPlay] = atBat.split(';');

        // ç°¡æ˜“ã‚¢ã‚¦ãƒˆåˆ¤å®š
        if (batterPlay.includes('ä¸‰æŒ¯') || batterPlay.includes('ã‚´ãƒ­') || batterPlay.includes('é£›') || batterPlay.includes('ç›´') || batterPlay.includes('çŠ ')) {
            outs++;
            if (batterPlay.includes('ä½µæ®º')) outs++;
        }
        if (outs >= targetOuts) break; // ã‚¢ã‚¦ãƒˆãŒç™ºç”Ÿã—ã¦ targetOuts ã«é”ã—ãŸã‚‰å³çµ‚äº†

        // ç°¡æ˜“ãƒ©ãƒ³ãƒŠãƒ¼çŠ¶æ³æ›´æ–°
        if (batterPlay.includes('å®‰') || batterPlay.includes('å¡æ‰“') || batterPlay.includes('å››çƒ') || batterPlay.includes('æ­»çƒ') || batterPlay.includes('ã‚¨ãƒ©ãƒ¼')) {
            if (runners[0] && runners[1] && runners[2] && (batterPlay.includes('å››çƒ') || batterPlay.includes('æ­»çƒ'))) {
                 scoreOpp++; // æŠ¼ã—å‡ºã—
            } else {
                if (runners[1]) runners[2] = 'runner'; // 2å¡â†’3å¡
                if (runners[0]) runners[1] = runners[0]; // 1å¡â†’2å¡
                runners[0] = player.name; // æ‰“è€…â†’1å¡
            }
        }
        // ç°¡æ˜“å¾—ç‚¹è¨ˆç®—
        if (batterPlay.includes('æœ¬å¡æ‰“')) {
            scoreOpp += runners.filter(r => r !== null).length + 1;
            runners = [null, null, null];
        } else if (batterPlay.includes('ç‚¹')) {
             const rbiMatch = batterPlay.match(/(\d+)ç‚¹/);
             scoreOpp += rbiMatch ? parseInt(rbiMatch[1]) : 1;
             // ç°¡æ˜“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã€ã©ã®èµ°è€…ãŒé‚„ã£ãŸã‹ã¯ç„¡è¦–
        }

        playsProcessedCount++; // å‡¦ç†æ¸ˆã¿ãƒ—ãƒ¬ãƒ¼æ•°
    }

    // æ¬¡ã®æ‰“è€…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—ã—ã¦è¿”ã™
    const lastSimulatedPlayer = finalOrderedPlays[playsProcessedCount - 1]?.player;
    let nextBatterIdx = startingBatterIdx; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    if(lastSimulatedPlayer){
        const lastSimIdx = battingOrder.findIndex(p => p.order === lastSimulatedPlayer.order);
        if(lastSimIdx !== -1){
            nextBatterIdx = (lastSimIdx + 1) % battingOrder.length;
        }
    }


    return { runners, outs, scoreSelf, scoreOpp, nextBatterIdx }; // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã¨æ¬¡ã®æ‰“è€…ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿”ã™
}
// â–²â–²â–² ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã“ã“ã¾ã§ â–²â–²â–²

// â–²â–²â–² ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã“ã“ã¾ã§ â–²â–²â–²

/**
 * [ä¿®æ­£ç‰ˆ] 1æ‰“å¸­åˆ†ã®å…¥åŠ›ãƒ–ãƒ­ãƒƒã‚¯HTMLã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…æ–‡å­—æ•°é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ã€ŒçŠ é£›ã€ãŒã€Œé£›ã€ã«èª¤åˆ¤å®šã•ã‚Œã‚‹ã®ã‚’é˜²ã)
 */
function createBattingResultDropdowns(playersOnField, atBatString = '') {
    // 1. ä¿å­˜ã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’ã€Œæ‰“è€…ãƒ—ãƒ¬ãƒ¼ã€ã¨ã€Œèµ°è€…ãƒ—ãƒ¬ãƒ¼ã€ã«åˆ†é›¢
    const [batterPlay, runnerPlaysString] = (atBatString || '').split(';');
    
    let tempResult = (batterPlay || '').trim();

    // 3. å‹¢ã„ã¨æ³¨ç›®ã®ãƒ‘ãƒ¼ã‚¹
    let selectedStrength = '';
    let isMarked = false;

    if (tempResult.startsWith('â˜…:')) {
        isMarked = true;
        tempResult = tempResult.substring(3);
    }
    if (tempResult.startsWith('S:')) {
        selectedStrength = 'S:';
        tempResult = tempResult.substring(2);
    } else if (tempResult.startsWith('W:')) {
        selectedStrength = 'W:';
        tempResult = tempResult.substring(2);
    }

    // 4. æ®‹ã‚Šã®æƒ…å ±ï¼ˆçµæœã€æ–¹å‘ã€æ‰“ç‚¹ãªã©ï¼‰ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
    let selectedResult = '', selectedDirection = '', selectedRbi = '', selectedRunnerPlay = '';
    
    if (tempResult) {
        const rbiMatch = tempResult.match(/(\d+ç‚¹)/);
        if (rbiMatch) {
            selectedRbi = rbiMatch[0];
            tempResult = tempResult.replace(selectedRbi, '').trim();
        }
        if (tempResult.includes('å¥½èµ°å¡')) {
            selectedRunnerPlay = 'å¥½èµ°å¡';
            tempResult = tempResult.replace('å¥½èµ°å¡', '').trim();
        }
        
        // â˜…â˜…â˜… ä¿®æ­£: ã“ã“ã§ã‚‚æ–‡å­—æ•°ã®å¤šã„é †ã«ã‚½ãƒ¼ãƒˆã™ã‚‹ â˜…â˜…â˜…
        const allResultTypes = [ 
            ...BATTING_RESULTS.hits, 
            ...BATTING_RESULTS.outs, 
            ...BATTING_RESULTS.walks, 
            ...BATTING_RESULTS.sacrifices, 
            ...BATTING_RESULTS.other 
        ].sort((a, b) => b.length - a.length);

        for (const type of allResultTypes) {
            if (tempResult.includes(type)) {
                selectedResult = type;
                tempResult = tempResult.replace(type, '').trim(); // è¦‹ã¤ã‹ã£ãŸã‚‰å‰Šé™¤
                break; // æœ€åˆã«è¦‹ã¤ã‹ã£ãŸã‚‚ã®ï¼ˆé•·ã„æ–¹ï¼‰ã§ç¢ºå®š
            }
        }
        
        if (tempResult.length > 0 && DIRECTIONS.includes(tempResult)) {
            selectedDirection = tempResult;
        }
    }

    // 5. HTMLã‚’ç”Ÿæˆã™ã‚‹
    // (ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®é¸æŠè‚¢é †åºã¯å¤‰ãˆãªãã¦è‰¯ã„ãŒã€selectedã®åˆ¤å®šã¯ä¿®æ­£å¾Œã®selectedResultã‚’ä½¿ã†)
    const resultOptions = [ ...BATTING_RESULTS.hits, ...BATTING_RESULTS.outs, ...BATTING_RESULTS.walks, ...BATTING_RESULTS.sacrifices, ...BATTING_RESULTS.other ]
        .map(r => `<option value="${r}" ${selectedResult === r ? 'selected' : ''}>${r}</option>`).join('');
    const directionOptions = DIRECTIONS.map(d => `<option value="${d}" ${selectedDirection === d ? 'selected' : ''}>${d}</option>`).join('');
    const rbiOptions = RBIS.map(r => `<option value="${r}" ${selectedRbi === r ? 'selected' : ''}>${r}</option>`).join('');
    const runnerPlayOptions = ['å¥½èµ°å¡'].map(r => `<option value="${r}" ${selectedRunnerPlay === r ? 'selected' : ''}>${r}</option>`).join('');
    const strengthOptions = `
        <option value="S:" ${selectedStrength === 'S:' ? 'selected' : ''}>å¼·</option>
        <option value="W:" ${selectedStrength === 'W:' ? 'selected' : ''}>å¼±</option>
    `;

    return `
        <div class="at-bat-block border-t border-dashed pt-2 mt-2 first:mt-0 first:pt-0 first:border-t-0">
            <div class="flex items-center gap-1 batting-result-container mb-1">
                <div class="flex-grow flex gap-1">
                    <select class="batting-result-part w-[25%] text-xs p-1 border rounded result-type"><option value="">-çµæœ-</option>${resultOptions}</select>
                    <select class="batting-result-part w-[20%] text-xs p-1 border rounded result-direction"><option value="">-æ–¹å‘-</option>${directionOptions}</select>
                    <select class="batting-result-part w-[20%] text-xs p-1 border rounded result-rbi"><option value="">-æ‰“ç‚¹-</option>${rbiOptions}</select>
                    <select class="batting-result-part w-[15%] text-xs p-1 border rounded result-strength bg-red-50"><option value="">-å‹¢ã„-</option>${strengthOptions}</select>
                    <select class="batting-result-part w-[20%] text-xs p-1 border rounded result-runner-play bg-yellow-50"><option value="">-èµ°å¡-</option>${runnerPlayOptions}</select>
                </div>
                <div class="w-12 flex-shrink-0">
                    <button class="mark-at-bat-btn w-full h-full text-xs font-bold p-1 rounded border ${isMarked ? 'bg-yellow-300 border-yellow-500 text-yellow-900' : 'bg-gray-100 border-gray-300 text-gray-500 hover:bg-gray-200'}"
                            data-marked="${isMarked ? 'true' : 'false'}"
                            title="ã“ã®æ‰“å¸­ã‚’ã€Œæ³¨ç›®ã®æ‰“å¸­ã€ã¨ã—ã¦AIã«ãƒãƒ¼ã‚¯ã—ã¾ã™">
                        â˜… æ³¨ç›®
                    </button>
                </div>
            </div>
            ${createRunnerInputsHTML(playersOnField, runnerPlaysString)}
        </div>
    `;
}

/**
 * ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚’ãŸã©ã‚Šã€æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã®æƒ…å ±ã‚’ç‰¹å®šã™ã‚‹
 * (â˜…ã€Œæº–æ±ºå‹å‹åˆ©æ™‚ã€ã®ç›¸æ‰‹ç‰¹å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ã—ãŸæœ€çµ‚ç‰ˆ)
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 * @param {string} currentMatchId - ãã®ãƒãƒ¼ãƒ ãŒå‹åˆ©ã—ãŸç¾åœ¨ã®è©¦åˆID
 * @returns {object|null} - æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±
 */
function findNextOpponent(teamName, currentMatchId) {
    const allMatches = tournamentState.matches;
    if (!allMatches || !allMatches[currentMatchId]) return null;

    const idParts = currentMatchId.split('-');
    const side = idParts[0];

    if (side === 'F') {
        // æ±ºå‹æˆ¦ã«å‹åˆ©ã—ãŸå ´åˆ
        return { 
            opponentName: 'å„ªå‹', 
            roundName: 'å¤§ä¼šçµ‚äº†',
            opponentRank: '',
            nextMatchSchedule: null
        };
    }

    const roundNum = parseInt(idParts[1].slice(1));
    const matchNum = parseInt(idParts[2].slice(1));
    const numTeams = tournamentState.teams.length;
    const finalRound = Math.log2(numTeams);

    let nextMatchId, roundName;
    if (roundNum === finalRound - 1) {
        // â˜… æº–æ±ºå‹ (R5) -> æ±ºå‹ (F-R1-M1)
        nextMatchId = 'F-R1-M1';
        roundName = 'æ±ºå‹';
    } else if (roundNum < finalRound - 1) {
        const nextRoundNum = roundNum + 1;
        nextMatchId = `${side}-R${nextRoundNum}-M${Math.ceil(matchNum / 2)}`;
        const roundNameMap = { [finalRound - 1]: "æº–æ±ºå‹", [finalRound - 2]: "æº–ã€…æ±ºå‹" };
        roundName = roundNameMap[nextRoundNum] || `${nextRoundNum}å›æˆ¦`;
    } else {
        return null; // æ—¢ã«æ±ºå‹ã‚ˆã‚Šå¾Œ (ã‚ã‚Šãˆãªã„ãŒ)
    }

    const nextMatch = allMatches[nextMatchId];
    if (!nextMatch) return null;

    let opponentName = null;
    if (nextMatch.team1 && nextMatch.team1 !== teamName) opponentName = nextMatch.team1;
    else if (nextMatch.team2 && nextMatch.team2 !== teamName) opponentName = nextMatch.team2;

    if (opponentName) {
        // ç›¸æ‰‹ãŒæ—¢ã«æ±ºã¾ã£ã¦ã„ã‚‹å ´åˆ
        return {
            opponentName: opponentName,
            opponentRank: calculateRank(opponentName, tournamentState),
            roundName: roundName,
            nextMatchSchedule: nextMatch.schedule
        };
    } else {
        // ç›¸æ‰‹ãŒæœªå®šã®å ´åˆ
        
        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä»Šå›ã®ä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
        let feederMatchId;
        
        // 1. æ¬¡ã®è©¦åˆãŒæ±ºå‹æˆ¦ (F-R1-M1) ã‹ã¤ã€ç›¸æ‰‹ãŒã¾ã æ±ºã¾ã£ã¦ã„ãªã„å ´åˆ
        if (nextMatchId === 'F-R1-M1') {
            // åå¯¾å´ã®å±±ã®æº–æ±ºå‹IDã‚’ç‰¹å®šã™ã‚‹ (side ã¯ 'L' ã¾ãŸã¯ 'R')
            const opponentFeederSide = (side === 'L' ? 'R' : 'L');
            feederMatchId = `${opponentFeederSide}-R${roundNum}-M1`; // æº–æ±ºå‹ã¯M1ã—ã‹ãªã„
        }
        // 2. (æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯) æ±ºå‹æˆ¦ä»¥å¤–ã§ã€ç›¸æ‰‹ãŒæœªå®šã®å ´åˆ
        else {
            const feederMatchNumber = matchNum % 2 === 1 ? matchNum + 1 : matchNum - 1;
            feederMatchId = `${side}-R${roundNum}-M${feederMatchNumber}`;
        }
        // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

        const feederMatch = allMatches[feederMatchId];

        if (feederMatch && feederMatch.team1 && feederMatch.team2) {
            // ç›¸æ‰‹ã‚’æ±ºã‚ã‚‹è©¦åˆã®ã‚«ãƒ¼ãƒ‰ãŒæƒã£ã¦ã„ã‚‹å ´åˆ
            return {
                opponentName: 'ï¼ˆæœªå®šï¼‰',
                roundName: roundName,
                decidingMatch: {
                    team1: feederMatch.team1,
                    rank1: calculateRank(feederMatch.team1, tournamentState),
                    team2: feederMatch.team2,
                    rank2: calculateRank(feederMatch.team2, tournamentState)
                },
                nextMatchSchedule: nextMatch.schedule
            };
        }
        
        // (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯) ç›¸æ‰‹ã‚’æ±ºã‚ã‚‹è©¦åˆã®ã‚«ãƒ¼ãƒ‰ã‚‚ã¾ã æƒã£ã¦ã„ãªã„å ´åˆ
        return { 
            opponentName: 'ï¼ˆæœªå®šï¼‰', 
            opponentRank: '?', 
            roundName: roundName,
            nextMatchSchedule: nextMatch.schedule
        };
    }
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * è¤‡æ•°èµ°è€…ã«å¯¾å¿œã—ãŸèµ°å¡å…¥åŠ›æ¬„ã®HTMLã‚’ç”Ÿæˆã™ã‚‹
 * @param {Array<object>} playersOnField - ç¾åœ¨å‡ºå ´ä¸­ã®é¸æ‰‹ãƒªã‚¹ãƒˆ
 * @param {string} currentResult - ä¿å­˜æ¸ˆã¿ã®æ‰“å¸­çµæœæ–‡å­—åˆ—
 * @returns {string} - ç”Ÿæˆã•ã‚ŒãŸHTML
 */
/**
 * è¤‡æ•°èµ°è€…ã«å¯¾å¿œã—ãŸèµ°å¡å…¥åŠ›æ¬„ã®HTMLã‚’ç”Ÿæˆã™ã‚‹ï¼ˆåŒºåˆ‡ã‚Šæ–‡å­—ãƒã‚°ä¿®æ­£ç‰ˆï¼‰
 */
function createRunnerInputsHTML(playersOnField, runnerPlaysString = '') {
    // â–¼â–¼â–¼ ä¿®æ­£ï¼šã€Œé€çƒé–“ã«é€²å¡ã€ã‚’è¿½åŠ  â–¼â–¼â–¼
    const baserunningPlays = ['ç›—å¡', 'ç›—å¡æ­»', 'ã‚¿ãƒƒãƒã‚¢ãƒƒãƒ—', 'é€²å¡', 'é€çƒé–“ã«é€²å¡', 'ç”Ÿé‚„', 'èµ°å¡æ­»', 'ç‰½åˆ¶æ­»', 'æŒŸæ®ºãƒ—ãƒ¬ãƒ¼ã§ã‚¢ã‚¦ãƒˆ'];
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²    

const bases = ['ä¸€å¡ã¸', 'äºŒå¡ã¸', 'ä¸‰å¡ã¸', 'æœ¬å¡ã¸(ç”Ÿé‚„)'];
    
    // â–¼â–¼â–¼ã€é‡è¦ä¿®æ­£ã€‘åŒºåˆ‡ã‚Šæ–‡å­—ã‚’ã€Œã€ã€ã‹ã‚‰ã€Œ,ã€ã«å¤‰æ›´â–¼â–¼â–¼
    const runnerEvents = runnerPlaysString ? runnerPlaysString.split(',') : [];
    // â–²â–²â–²

    let html = '<div class="runner-plays-container space-y-1 mt-1">';
    
    runnerEvents.forEach(event => {
        const parts = event.trim().split(' ');
        const name = parts[0] || '';
        const play = parts[1] || '';
        const base = parts.slice(2).join(' ') || '';
        
        const nameOptions = playersOnField.map(p => `<option value="${p.name}" ${p.name === name ? 'selected' : ''}>${p.name}</option>`).join('');
        const playOptions = baserunningPlays.map(p => `<option value="${p}" ${p === play ? 'selected' : ''}>${p}</option>`).join('');
        const baseOptions = bases.map(b => `<option value="${b}" ${b === base ? 'selected' : ''}>${b}</option>`).join('');

        html += `
            <div class="runner-play-input flex gap-1 items-center mt-1">
                <select class="runner-name w-1/3 text-xs p-1 border rounded"><option value="">-èª°ãŒ-</option>${nameOptions}</select>
                <select class="runner-play w-1/3 text-xs p-1 border rounded bg-green-50"><option value="">-ä½•ã‚’ã—ãŸ-</option>${playOptions}</select>
                <select class="runner-base w-1/3 text-xs p-1 border rounded bg-green-50"><option value="">-ã©ã“ã¸-</option>${baseOptions}</select>
                <button class="remove-runner-play-btn text-red-500 hover:text-red-700 font-bold text-lg leading-none p-1">Ã—</button>
            </div>
        `;
    });

    html += '</div>';
    html += '<button class="add-runner-play-btn text-xs mt-1 bg-gray-200 px-2 py-0.5 rounded hover:bg-gray-300">+ èµ°è€…ãƒ—ãƒ¬ãƒ¼ã‚’è¿½åŠ </button>';
    return html;
}

/**
 * é¸æ‰‹ã®å¤§ä¼šé€šç®—æˆç¸¾ã‚’ã€AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã®çŸ­ã„æ–‡ç« ã«è¦ç´„ã™ã‚‹
 * (â˜…ç›—å¡(SB)ã®è¡¨ç¤ºã‚’è¿½åŠ ã—ãŸæœ€çµ‚ç‰ˆ)
 * @param {string} playerName - é¸æ‰‹å
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 * @returns {string | null} - "å§«å·: æ‰“ç‡.500, 3æœ¬å¡æ‰“, 10æ‰“ç‚¹, 5ç›—å¡" ã®ã‚ˆã†ãªè¦ç´„æ–‡ã€‚æˆç¸¾ãŒãªã‘ã‚Œã°nullã€‚
 */
function getPlayerTournamentStatsSummary(playerName, teamName) {
    const teamRecord = tournamentState.teamRecords[teamName];
    if (!teamRecord || !teamRecord.playerStats) return null;

    const battingStats = teamRecord.playerStats.batting[playerName];
    const pitchingStats = teamRecord.playerStats.pitching[playerName];
    
    let summaries = [];

    if (battingStats && battingStats.ab > 0) {
        const avg = (battingStats.h / battingStats.ab).toFixed(3);
        // â–¼â–¼â–¼ ã“ã®è¡Œã‚’ä¿®æ­£ â–¼â–¼â–¼
        summaries.push(`æ‰“ç‡${avg}, ${battingStats.hr || 0}æœ¬å¡æ‰“, ${battingStats.rbi || 0}æ‰“ç‚¹, ${battingStats.sb || 0}ç›—å¡`);
        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
    }

    if (pitchingStats && pitchingStats.ip > 0) {
        const era = pitchingStats.er > 0 ? ((pitchingStats.er * 9) / pitchingStats.ip).toFixed(2) : "0.00";
        summaries.push(`${pitchingStats.w}å‹${pitchingStats.l}æ•—, é˜²å¾¡ç‡${era}, ${pitchingStats.so}å¥ªä¸‰æŒ¯`);
    }

    if (summaries.length > 0) {
        return `${playerName}: ${summaries.join(' / ')}`;
    }
    
    return null;
}
/**
 * Analyzes the results of a half-inning, counts outs, and updates the UI (colors and disabled state).
 */
function updateInningState(teamKey, inningIndex) {
    const battingTable = document.getElementById(`batting-table-${teamKey}`);
    if (!battingTable) return;

    let outCount = 0;
    
    // --- 1. Analyze Batting Results ---
    battingTable.querySelectorAll('tbody tr').forEach(row => {
        const resultCell = row.children[5 + inningIndex];
        if (!resultCell) return;
        
        const atBatContainers = resultCell.querySelectorAll('.batting-result-container');
        atBatContainers.forEach(container => {
            const resultTypeSelect = container.querySelector('.result-type');
            const resultText = resultTypeSelect.value;
            
            // Count outs
            if (BATTING_RESULTS.outs.includes(resultText)) {
                outCount += (resultText === 'ä½µæ®º') ? 2 : 1;
            }

            // Color-code the dropdowns
            const dropdowns = container.querySelectorAll('select');
            dropdowns.forEach(dd => dd.classList.remove('result-hit', 'result-out', 'result-on-base'));

            if (BATTING_RESULTS.hits.includes(resultText)) {
                dropdowns.forEach(dd => dd.classList.add('result-hit'));
            } else if (BATTING_RESULTS.walks.includes(resultText) || BATTING_RESULTS.other.includes(resultText)) {
                dropdowns.forEach(dd => dd.classList.add('result-on-base'));
            } else if (BATTING_RESULTS.outs.includes(resultText) || BATTING_RESULTS.sacrifices.includes(resultText)) {
                dropdowns.forEach(dd => dd.classList.add('result-out'));
            }
        });
    });

    // --- 2. Count Outs from "Inning Events" (Baserunning) ---
    const eventsInput = document.querySelector(`.inning-events-input[data-team-key="${teamKey}"][data-inning-index="${inningIndex}"]`);
    if (eventsInput && eventsInput.value) {
        const events = eventsInput.value.split('ã€');
        events.forEach(event => {
            if (event.includes('ç›—å¡æ­»') || event.includes('èµ°å¡æ­»')) {
                outCount++;
            }
        });
    }

    // --- 3. Lock the Inning if 3 Outs are Reached ---
    const isLocked = outCount >= 3;
    battingTable.querySelectorAll('tbody tr').forEach(row => {
        const resultCell = row.children[5 + inningIndex];
        if (!resultCell) return;
        
        const dropdowns = resultCell.querySelectorAll('.batting-result-container select');
        const addButtons = resultCell.querySelectorAll('.add-at-bat-btn');
        
        dropdowns.forEach(dd => {
            dd.disabled = isLocked;
            if (isLocked) dd.classList.add('bg-gray-100');
        });
        addButtons.forEach(btn => {
            btn.disabled = isLocked;
            if (isLocked) btn.style.visibility = 'hidden';
        });
    });
     if (eventsInput) {
        eventsInput.disabled = isLocked;
        if (isLocked) eventsInput.classList.add('bg-gray-100');
     }
}

// â–¼â–¼â–¼ é©æ­£æ‰“é †åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ â–¼â–¼â–¼


/**
 * [FIXED] åˆ†æçµæœã‚’å°‚ç”¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã§è¡¨ç¤ºã™ã‚‹ (æ‰“ç‡ã‚’è¿½åŠ ç‰ˆ)
 */
function renderOptimalLineupModal(teamName, lineup) {
    const contentEl = document.getElementById('contribution-content');
    const teamRecord = tournamentState.teamRecords[teamName];

    // --- 1. ã‚°ãƒ©ãƒ•è¦ç´ ã®ç ´æ£„ (ãƒ¡ãƒ¢ãƒªè§£æ”¾) ---
    const pieChart = Chart.getChart('rc-pie-chart');
    const barChart = Chart.getChart('rc-bar-chart');
    const scatterChart = Chart.getChart('stellar-scatter-chart');
    
    if (pieChart) pieChart.destroy();
    if (barChart) barChart.destroy();
    if (scatterChart) scatterChart.destroy();

    // --- 2. æ‰“é †è¡¨ã®HTMLã‚’å®šç¾© ---
    let lineupHtml = `
        <div id="optimal-lineup-table" class="bg-white p-6 rounded-lg shadow-xl mt-4">
            <h4 class="text-xl font-bold text-blue-700 mb-4">âš¾ æ¨å¥¨æ‰“é † (OPSãƒ»RC/GåŸºæº–)</h4>
            <div class="overflow-x-auto">
                <table class="career-stats-table">
                    <thead>
                        <tr>
                            <th>æ‰“é †</th>
                            <th>é¸æ‰‹å</th>
                            <th>å½¹å‰²</th>
                            <th>æ‰“ç‡</th> <th>OPS</th>
                            <th>RC/G</th>
                            <th>HR/SB</th>
                            <th>è©•ä¾¡ç†ç”±</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${lineup.map(p => {
                            const stats = teamRecord.playerStats.batting[p.name];
                            const ops = parseFloat(calculateOps(stats)).toFixed(3);
                            
                            // â˜… æ‰“ç‡ã®è¨ˆç®—ã‚’è¿½åŠ 
                            const avg = (stats.ab > 0) ? (stats.h / stats.ab).toFixed(3) : ".000";

                            // p.rcg ãŒNaNã§ã‚ã‚Œã° '0.00' ã«ã™ã‚‹å®‰å…¨ç­–
                            const rcg = (p.rcg && !isNaN(p.rcg)) ? p.rcg.toFixed(2) : '0.00'; 

                            let role = '';
                            let reason = '';
                            if (p.order === 1) { role = 'ãƒªãƒ¼ãƒ‰ã‚ªãƒ•'; reason = 'æœ€é«˜ã®å‡ºå¡èƒ½åŠ›ã¨ä¿Šè¶³'; }
                            else if (p.order === 2) { role = 'ã¤ãªãå½¹'; reason = 'RC/GãŒæœ€ã‚‚é«˜ãã€åŠ¹ç‡çš„ãªæ‰“è€…'; }
                            else if (p.order === 3) { role = 'ç¢ºå®Ÿæ€§/ä¸»è»¸'; reason = 'OPSã¨æ‰“ç‡ã®ãƒãƒ©ãƒ³ã‚¹ãŒå„ªã‚Œã¦ã„ã‚‹'; }
                            else if (p.order === 4) { role = 'ä¸»ç ²/æ‰“ç‚¹'; reason = 'æœ€ã‚‚é•·æ‰“åŠ›ã¨æ‰“ç‚¹èƒ½åŠ›ãŒé«˜ã„'; }
                            else if (p.order === 5) { role = 'å¾Œç¶šã®æ‰“ç‚¹å½¹'; reason = '4ç•ªã«æ¬¡ããƒ‘ãƒ¯ãƒ¼ã¨RCã‚’å…¼ã­å‚™ãˆã‚‹'; }
                            else if (p.order === 9) { role = 'ä¸‹ä½ã®ãƒªãƒ¼ãƒ‰ã‚ªãƒ•'; reason = 'æ®‹ã‚Šã®é¸æ‰‹ã®ä¸­ã§æœ€ã‚‚å‡ºå¡ç‡ãŒé«˜ã„'; }
                            else { role = 'ä¸‹ä½æ‰“ç·š'; reason = 'ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„æ”»æ’ƒåŠ›'; }
                            
                            return `
                                <tr>
                                    <td><strong>${p.order}ç•ª</strong></td>
                                    <td>${p.name}</td>
                                    <td>${role}</td>
                                    <td class="font-bold text-blue-700">${avg}</td> <td>${ops}</td>
                                    <td>${rcg}</td>
                                    <td>${stats.hr || 0}HR/${stats.sb || 0}SB</td>
                                    <td>${reason}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            <div class="mt-4 p-3 bg-gray-50 rounded text-sm">
                <p>â€»æ¨å¥¨æ‰“é †ã¯ã€OPSã‚„RC(Run Created)ãªã©ã‚»ã‚¤ãƒãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®æŒ‡æ¨™ã«åŸºã¥ãã€å„æ‰“é †ã®ã€Œå½¹å‰²ã€ã«æœ€é©ãªé¸æ‰‹ã‚’é…ç½®ã—ãŸè«–ç†çš„æ‰“ç·šã§ã™ã€‚</p>
            </div>
        </div>
    `;

    // --- 3. ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã¨æ‰“é †è¡¨ã®æ’ä»–è¡¨ç¤º ---

    // A. ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ï¼ˆè²¢çŒ®åº¦åˆ†æã®ãƒ‘ãƒ¼ãƒ„ï¼‰ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    const graphAreas = contentEl.querySelectorAll('.bg-white.p-6.rounded-lg.shadow-md');
    graphAreas.forEach(el => el.classList.add('hidden'));

    // B. æ‰“é †è¡¨ã‚’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã«æŒ¿å…¥
    contentEl.innerHTML = `
        <div class="archive-header">
            <span class="archive-school-name">é©æ­£æ‰“é †åˆ†æ: ${teamName}</span>
            <span class="archive-pref">OPSãƒ»RC/Gã«åŸºã¥ãæ¨å¥¨æ‰“é †</span>
        </div>
        ${lineupHtml}
    `;

    contentEl.classList.remove('hidden');
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * [NEW HELPER] ä¼šè©±ã®ä¸­ã§è¨€åŠã•ã‚ŒãŸé¸æ‰‹ã®Gamelogã‚’åé›†ãƒ»æ•´å½¢ã™ã‚‹
 * (â˜…ç™»æ¿é–“éš”ã®è¨ˆç®—ã‚’ä¿®æ­£ã—ãŸæœ€çµ‚ç‰ˆ)
 * @param {Set<string>} mentionedTeams - è¨€åŠã•ã‚ŒãŸãƒãƒ¼ãƒ åã®ã‚»ãƒƒãƒˆ
 * @param {string} conversationText - ä¼šè©±ãƒ†ã‚­ã‚¹ãƒˆ
 * @param {string|null} referenceDate - åŸºæº–ã¨ãªã‚‹æ—¥ä»˜ (nullã®å ´åˆã¯æœ€çµ‚è©¦åˆã®æ—¥ä»˜ã‚’ä½¿ç”¨)
 * @returns {string} - æ•´å½¢ã•ã‚ŒãŸGamelogãƒ†ã‚­ã‚¹ãƒˆ
 */
function formatPlayerGamelogsForPrompt(mentionedTeams, conversationText, referenceDate = null) {
    let logInfo = "";
    let relevantLogsFound = false;
    
    // åŸºæº–æ—¥ã®æ±ºå®š: å¼•æ•°ãŒã‚ã‚Œã°ãã‚Œã€ãªã‘ã‚Œã°ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®æœ€æ–°è©¦åˆã®æ—¥ä»˜
    let todayStr = referenceDate;
    if (!todayStr) {
        const allMatches = Object.values(tournamentState.matches);
        // å®Ÿæ–½æ¸ˆã¿ã®æœ€å¾Œã®è©¦åˆã‚’æ¢ã™
        for (let i = allMatches.length - 1; i >= 0; i--) {
            if (allMatches[i].winner && allMatches[i].schedule?.date) {
                todayStr = allMatches[i].schedule.date;
                break;
            }
        }
        if (!todayStr) todayStr = "7/25"; // å®Œå…¨ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    }

    // æ—¥ä»˜ã‚½ãƒ¼ãƒˆç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
    const parseForSort = (dStr) => {
        if(!dStr || !dStr.includes('/')) return 0;
        const [m, d] = dStr.split('/').map(Number);
        return m * 100 + d;
    };

    mentionedTeams.forEach(teamName => {
        const teamRecord = tournamentState.teamRecords[teamName];
        if (!teamRecord || !teamRecord.playerStats) return;

        // 1. æ‰“è€…ãƒ­ã‚°
        const battingStats = teamRecord.playerStats.batting;
        if (battingStats) {
            for (const playerName in battingStats) {
                if (conversationText.includes(playerName)) {
                    const bStats = battingStats[playerName];
                    if (bStats.gamelogs && bStats.gamelogs.length > 0) {
                        if (!relevantLogsFound) logInfo += `\n### å‚è€ƒæƒ…å ±ï¼šä»Šå¤§ä¼šã®ä¸»ãªé¸æ‰‹æˆç¸¾å±¥æ­´\n`;
                        relevantLogsFound = true;
                        logInfo += `- ${playerName} (${teamName}, æ‰“è€…):\n`;
                        
                        bStats.gamelogs.sort((a, b) => parseForSort(a.date) - parseForSort(b.date));
                        
                        bStats.gamelogs.forEach(log => {
                            const dateInfo = log.date || 'æ—¥ä»˜ä¸æ˜';
                            const opponentRank = log.opponentRank || 'E';
                            const stats = log.stats || { ab: 0, h: 0, hr: 0, rbi: 0, sb: 0 };
                            let role = "";
                            if (log.sub_type === 'PH') role = "ä»£æ‰“";
                            else if (log.order && log.order.includes('sub')) role = "é€”ä¸­å‡ºå ´";
                            else if (log.order) role = `${log.order}ç•ª`;
                            
                            const statsLine = `${stats.ab}æ‰“æ•°${stats.h}å®‰æ‰“ ${stats.hr}HR ${stats.rbi}æ‰“ç‚¹ ${stats.sb}ç›—å¡`;
                            logInfo += `  - ${log.round} (${dateInfo}) (å¯¾ ${log.opponent} [${opponentRank}]) (${role}): ${statsLine}\n`;
                        });
                    }
                }
            }
        }

        // 2. æŠ•æ‰‹ãƒ­ã‚° (â˜…ã“ã“ã‚’ä¿®æ­£)
        const pitchingStats = teamRecord.playerStats.pitching;
        if (pitchingStats) {
            for (const playerName in pitchingStats) {
                if (conversationText.includes(playerName)) {
                    const pStats = pitchingStats[playerName];
                    if (pStats.gamelogs && pStats.gamelogs.length > 0) {
                        if (!relevantLogsFound) logInfo += `\n### å‚è€ƒæƒ…å ±ï¼šä»Šå¤§ä¼šã®ä¸»ãªé¸æ‰‹æˆç¸¾å±¥æ­´\n`;
                        relevantLogsFound = true;
                        logInfo += `- ${playerName} (${teamName}, æŠ•æ‰‹):\n`;

                        pStats.gamelogs.sort((a, b) => parseForSort(a.date) - parseForSort(b.date));

                        pStats.gamelogs.forEach(log => {
                            // â˜… ã“ã“ã§æ–°ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½¿ç”¨
                            const intervalInfo = getRestDaysString(todayStr, log.date, tournamentState.tournamentYear);
                            const dateInfo = log.date + intervalInfo;

                            const opponentRank = log.opponentRank || 'E';
                            const resultMark = {'W': 'â—‹', 'L': 'â—', 'S': 'ï¼³', 'H': 'ï¼¨'}[log.result] || '';
                            logInfo += `  - ${log.round} (${dateInfo}) (å¯¾ ${log.opponent} [${opponentRank}]): ${resultMark}${log.ip}å› ${log.h}è¢«å®‰æ‰“ ${log.bb}å››çƒ ${log.so}å¥ªä¸‰æŒ¯ ${log.r}å¤±ç‚¹(è‡ªè²¬${log.er})\n`;
                        });
                    }
                }
            }
        }
    });

    if (!relevantLogsFound) {
        logInfo = "\n### å‚è€ƒæƒ…å ±ï¼šä»Šå¤§ä¼šã®ä¸»ãªé¸æ‰‹æˆç¸¾å±¥æ­´\n- è¨€åŠã•ã‚ŒãŸé¸æ‰‹ã®è©³ç´°ãªè©¦åˆå±¥æ­´ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n";
    }
    return logInfo;
}

// â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
/**
 * æŒ‡å®šã•ã‚ŒãŸmatchIdã«é–¢é€£ã™ã‚‹ã€éå»ã«ç”Ÿæˆã•ã‚ŒãŸAIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å…¨ã¦å‰Šé™¤ã™ã‚‹
 * @param {string} matchId - å¯¾è±¡ã®è©¦åˆID
 */
function clearPreviousAiContent(matchId) {
    if (!matchId) return;

    // 1. ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ (é€šå¸¸è¨˜äº‹ã€ç¾½ç”°ãƒ¬ãƒãƒ¼ãƒˆã€ã‚¨ãƒ©ãƒ¼) ã‚’å‰Šé™¤
    // (context.matchId ã¾ãŸã¯ errorId ãŒ matchId ã¨ä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’å‰Šé™¤)
    tournamentState.news = tournamentState.news.filter(article => {
        if (article.context && article.context.matchId === matchId) return false;
        if (article.errorId === matchId) return false;
        return true;
    });

    // 2. æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆ (é€šå¸¸BBS) ã‚’å‰Šé™¤
    // (BBSã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã¯ãªãå€‹ã€…ã®ã‚³ãƒ¡ãƒ³ãƒˆãªã®ã§ã€context.matchId ã§å‰Šé™¤)
    tournamentState.bbsComments = tournamentState.bbsComments.filter(comment => {
        if (comment.context && comment.context.matchId === matchId) return false;
        if (comment.errorId && comment.errorId.includes(matchId)) return false;
        return true;
    });

    // 3. ã¾ã¨ã‚ã‚¹ãƒ¬ãƒƒãƒ‰ (matomeThreads) ã‚’å‰Šé™¤
    if (tournamentState.matomeThreads && tournamentState.matomeThreads[matchId]) {
        delete tournamentState.matomeThreads[matchId];
    }
}
// â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

/**
 * è©¦åˆã®å‹è€…ã‚’å‡¦ç†ã™ã‚‹ä¸­å¿ƒçš„é–¢æ•°ï¼ˆå…¨æ©Ÿèƒ½çµ±åˆï¼‰
 * (â˜…å¿«é€²æ’ƒè¨˜äº‹ã¨é€šå¸¸è¨˜äº‹ãŒã€Œä¸¡æ–¹ã€ç”Ÿæˆã•ã‚Œã‚‹ã‚ˆã†ä¿®æ­£)
 * (â˜…â˜…ã‚¢ã‚¯ã‚·ãƒ‡ãƒ³ãƒˆè¨˜äº‹ãŒ283å­¦åœ’ã«ã®ã¿ç™ºç”Ÿã™ã‚‹ã‚ˆã†ä¿®æ­£)
 * (â˜…â˜…â˜…ã‚¢ã‚¯ã‚·ãƒ‡ãƒ³ãƒˆæŠ½é¸ã‚’é¸æ‰‹ã®é‡è¦åº¦ï¼ˆä¸»åŠ›/æ§ãˆï¼‰ã«å¿œã˜ã¦å¤‰æ›´â˜…â˜…â˜…)
 */
async function processMatchWin(matchId, winnerName) {
    let dbMatch = findMatchById(matchId);
    if (!dbMatch || !dbMatch.team1 || !dbMatch.team2) return;
    
    if (dbMatch.team1 === '(BYE)' || dbMatch.team2 === '(BYE)') {
        console.log("BYE match processing skipped by AI.");
        return;
    }

    // --- 1. å†å‡¦ç†ï¼ˆå†ç”Ÿæˆï¼‰ã®ç¢ºèª ---
    if (dbMatch.winner) {
        const confirmed = await showConfirm(
            `ã“ã®è©¦åˆï¼ˆ${dbMatch.team1} vs ${dbMatch.team2}ï¼‰ã¯æ—¢ã«ã€Œ${dbMatch.winner}ã€ã®å‹åˆ©ã§å‡¦ç†æ¸ˆã¿ã§ã™ã€‚\n\n` +
            "ã€Œè©³ç´°å…¥åŠ›ã€ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£ã—ã¾ã—ãŸã‹ï¼Ÿ\n" +
            "ã€Œã¯ã„ã€ã‚’æŠ¼ã™ã¨ã€ç¾åœ¨ã®è©³ç´°å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã€AIè¨˜äº‹ã¨æ²ç¤ºæ¿ã‚’ã™ã¹ã¦å†ç”Ÿæˆã—ã¾ã™ã€‚\n\n" +
            "ï¼ˆæ³¨æ„ï¼šã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰"
        );
        if (!confirmed) return;
        clearPreviousAiContent(matchId);
        dbMatch.winner = null; 
    } else {
        // (åˆå›å‡¦ç†ã®å ´åˆã€ä¸€æ™‚ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ)
        for (const teamName of [dbMatch.team1, dbMatch.team2]) {
            const teamRecord = tournamentState.teamRecords[teamName];
            if (!teamRecord || !teamRecord.playerStats) continue;
            for (const playerName in teamRecord.playerStats.batting) {
                if(teamRecord.playerStats.batting[playerName]) teamRecord.playerStats.batting[playerName].narrative_flag = null;
            }
            for (const playerName in teamRecord.playerStats.pitching) {
                if(teamRecord.playerStats.pitching[playerName]) teamRecord.playerStats.pitching[playerName].narrative_flag = null;
            }
        }
    }

    const loserName = dbMatch.team1 === winnerName ? dbMatch.team2 : dbMatch.team1;
    dbMatch.winner = winnerName;
    const idParts = matchId.split('-');
    const side = idParts[0];

    // --- ã‚¹ã‚³ã‚¢ã®èª­ã¿å–ã‚Š ---
    const scoresAlreadySetBySkip = (dbMatch.score1 !== '' && dbMatch.score2 !== '' && (dbMatch.score1 != null) && (dbMatch.score2 != null));
    if (!scoresAlreadySetBySkip) {
        const matchEl = document.querySelector(`.matchup[data-match-id="${matchId}"]`);
        if (matchEl) {
            const score1El = matchEl.querySelector('[data-team-pos="1"]');
            const score2El = matchEl.querySelector('[data-team-pos="2"]');
            if (score1El && score2El && score1El.value !== '' && score2El.value !== '') {
                dbMatch.score1 = score1El.value;
                dbMatch.score2 = score2El.value;
            } else {
                dbMatch.score1 = '0';
                dbMatch.score2 = '0';
            }
            dbMatch.summary = matchEl.querySelector('.match-summary-input')?.value || '';
        }
    }
    
   // â–¼â–¼â–¼ ã€ä¿®æ­£ã€‘æ‰‹å‹•è¨­å®šãŒãªã‘ã‚Œã°ã€è‡ªå‹•åˆ¤å®šã‚’è¡Œã† â–¼â–¼â–¼
    if (dbMatch.calledGame === undefined) { // æ‰‹å‹•è¨­å®šãŒã¾ã ãªã„å ´åˆã®ã¿
        dbMatch.calledGame = false;
        dbMatch.calledInning = null;
        let earliestCalledInning = null;
        
        if (dbMatch.details && dbMatch.details.inningScore && dbMatch.details.inningScore.team1.length >= 5) {
            const inningScores1 = dbMatch.details.inningScore.team1;
            const inningScores2 = dbMatch.details.inningScore.team2;
            const actualNumInningsRecorded = inningScores1.length;
            let cumulativeScore1 = 0;
            let cumulativeScore2 = 0;
            for (let i = 0; i < actualNumInningsRecorded; i++) {
                cumulativeScore1 += parseInt(inningScores1[i] || 0);
                cumulativeScore2 += parseInt(inningScores2[i] || 0);
                const currentInning = i + 1;
                const scoreDiff = Math.abs(cumulativeScore1 - cumulativeScore2);
                if (currentInning === 5 && scoreDiff >= 10) { earliestCalledInning = 5; break; }
                if (currentInning === 6 && scoreDiff >= 10) { earliestCalledInning = 6; break; }
                if (currentInning === 7 && scoreDiff >= 7) { earliestCalledInning = 7; break; }
                if (currentInning === 8 && scoreDiff >= 7) { earliestCalledInning = 8; break; }
            }
            if (earliestCalledInning !== null) {
                dbMatch.calledGame = true;
                dbMatch.calledInning = earliestCalledInning;
            }
        }
    }
    // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

    // --- å‹è€…ã‚’æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚ã‚‹å‡¦ç† (å…¨å¤§ä¼šå…±é€š) ---
    if(tournamentState.teamRecords[winnerName]) tournamentState.teamRecords[winnerName].wins++;
    if(tournamentState.teamRecords[loserName]) tournamentState.teamRecords[loserName].losses++;
    if (side !== 'F') {
        const roundNum = parseInt(idParts[1].slice(1));
        const numTeamsInTournament = tournamentState.teams.length;
        const finalRound = Math.log2(numTeamsInTournament);
        if (roundNum < finalRound) {
            const matchNum = parseInt(idParts[2].slice(1));
            const nextRoundNum = roundNum + 1;
            let nextMatchId = (nextRoundNum === finalRound) ? 'F-R1-M1' : `${side}-R${nextRoundNum}-M${Math.ceil(matchNum / 2)}`;
            if (!tournamentState.matches[nextMatchId]) {
                tournamentState.matches[nextMatchId] = { id: nextMatchId, team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '' };
            }
            let slot = (nextRoundNum === finalRound) ? (side === 'L' ? 1 : 2) : (matchNum % 2 !== 0 ? 1 : 2);
            tournamentState.matches[nextMatchId][`team${slot}`] = winnerName;
            const nextMatch = tournamentState.matches[nextMatchId];
            if (nextMatch.team1 && nextMatch.team2) {
                nextMatch.rivalryType = checkRivalry(nextMatch.team1, nextMatch.team2);
            }
        }
    }
    // (æ±ºå‹æˆ¦çµ‚äº†æ™‚ã®å¾Œå‡¦ç†)
    if (matchId.startsWith('F-R1-M1')) {
        updateTournamentFinishRecords(); // çœŒå¤§ä¼šã®æˆç¸¾ã‚’è¨˜éŒ²

        if (tournamentState.currentTournament === 'summer') {
            // â˜…â˜…â˜… ã€ä¿®æ­£ã€‘ç”²å­åœ’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ãªãã€å®Ÿéš›ã®ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰ã¸ç§»è¡Œ â˜…â˜…â˜…
            
            // 1. å„ªå‹è¨˜äº‹ï¼ˆçœŒå¤§ä¼šï¼‰ã‚’ç”Ÿæˆ
            // (ä¸€æ—¦ã“ã“ã§çœŒå¤§ä¼šã®åŒºåˆ‡ã‚Šã‚’ã¤ã‘ã‚‹)
            
            // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
            alert(`ã€ç¥ã€‘${winnerName}ãŒå¤ã®é™å²¡å¤§ä¼šã‚’åˆ¶è¦‡ï¼\n\nç¶šã„ã¦ã€Œå…¨å›½é«˜ç­‰å­¦æ ¡é‡çƒé¸æ‰‹æ¨©å¤§ä¼šï¼ˆç”²å­åœ’ï¼‰ã€ã¸é€²å‡ºã—ã¾ã™ï¼\nåˆæˆ¦ã®ç›¸æ‰‹ã¯ã€å²©æ‰‹ã®æ€ªç‰©ç”£å‡ºæ ¡ã€ŒèŠ±å·»æ±ã€ã§ã™ï¼`);

            // 3. ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
            await setupKoshienTournament(winnerName);
            return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†ï¼ˆä»¥å¾Œã®è¨˜äº‹ç”Ÿæˆãªã©ã¯ setupKoshienTournament å†…ã§è¡Œã†ã‹ã€ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ï¼‰

        } else if (tournamentState.currentTournament === 'summer_koshien') {
            // â˜…â˜…â˜… ç”²å­åœ’æ±ºå‹å¾Œã®å‡¦ç† â˜…â˜…â˜…
            const koshienRank = winnerName ? 'å…¨å›½å„ªå‹' : 'æº–å„ªå‹';
            alert(`ã€å·å¤–ã€‘${winnerName}ãŒå¤ã®ç”²å­åœ’ã§å…¨å›½åˆ¶è¦‡ï¼\nä¼èª¬ã®æ¿€é—˜ã‚’åˆ¶ã—ã€é ‚ç‚¹ã«ç«‹ã¡ã¾ã—ãŸï¼`);
            // (å¿…è¦ãªã‚‰ã“ã“ã§ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°æ¼”å‡ºã‚„æ®¿å ‚å…¥ã‚Šå‡¦ç†ãªã©)
        } else if (tournamentState.currentTournament === 'autumn') {
            tournamentState.senbatsuTeams = [];
            const finalists = [winnerName, loserName];
            const numTeamsInTournament = tournamentState.teams.length;
            const finalRound = Math.log2(numTeamsInTournament);
            const semiFinalLosers = Object.values(tournamentState.matches)
                .filter(m => m.id.includes(`-R${finalRound-1}-M`))
                .map(m => m.winner === m.team1 ? m.team2 : m.team1)
                .filter(Boolean);
            const candidates = [...finalists, ...semiFinalLosers];
            const selectionPromises = candidates.map(async (teamName, index) => {
                let selectionChance = 0.3; if (index < 2) selectionChance = 0.7;
                if (Math.random() < selectionChance) {
                    tournamentState.senbatsuTeams.push(teamName);
                    const senbatsuArticle = await generateKoshienSummaryArticle(teamName, 'ã‚»ãƒ³ãƒãƒ„å‡ºå ´æ±ºå®š', 'tokai');
                    if (senbatsuArticle) { tournamentState.news.push(senbatsuArticle); }
                }
            });
            await Promise.all(selectionPromises);
            renderNews(tournamentState.news);
            saveState();
        }
    }
    
    // --- 2. è©¦åˆå¾Œã®ãƒ‡ãƒ¼ã‚¿æ›´æ–° (ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã€ç§°å·) ---
    const newHeadline = generateTickerHeadline({ winnerName, loserName, score1: dbMatch.score1, score2: dbMatch.score2 });
    if (newHeadline) {
        tournamentState.tickerHeadlines.unshift(newHeadline);
        if (tournamentState.tickerHeadlines.length > 20) tournamentState.tickerHeadlines.pop();
        updateTicker();
    }
    const winnerRank = calculateRank(winnerName, tournamentState);
    const loserRank = calculateRank(loserName, tournamentState);
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
    if ((rankValues[loserRank] - rankValues[winnerRank]) >= 2) {
        const winnerRecord = tournamentState.teamRecords[winnerName];
        if (winnerRecord && !winnerRecord.teamTraits.includes('giant_killer')) {
            winnerRecord.teamTraits.push('giant_killer');
        }
    }
    let team1QualityText = "ï¼ˆæ‰“çƒå“è³ªãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰";
    let team2QualityText = "ï¼ˆæ‰“çƒå“è³ªãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰";
    if (dbMatch.details && dbMatch.details.playerGameStats) {
        const calculateQuality = (teamKey) => {
            const quality = { sH: 0, wH: 0, sO: 0, wO: 0, totalAB: 0 };
            const statsTeam = dbMatch.details.playerGameStats[teamKey] || {};
            for (const playerName in statsTeam) {
                const stats = statsTeam[playerName];
                quality.sH += stats.strongHits || 0;
                quality.wH += stats.weakHits || 0;
                quality.sO += stats.strongOuts || 0;
                quality.wO += stats.weakOuts || 0;
                quality.totalAB += stats.ab || 0;
            }
            return quality;
        };
        const team1Quality = calculateQuality('team1');
        const team2Quality = calculateQuality('team2');
        const formatQualityText = (teamName, quality) => {
            if (quality.totalAB === 0) return `(${teamName}: ãƒ‡ãƒ¼ã‚¿ãªã—)`;
            const totalHits = quality.sH + quality.wH;
            const totalOuts = quality.sO + quality.wO;
            return `(${teamName}: å®‰æ‰“${totalHits} (ã†ã¡é‹­ã„å½“ãŸã‚Š${quality.sH}æœ¬, è©°ã¾ã£ãŸå½“ãŸã‚Š${quality.wH}æœ¬) / å‡¡é€€${totalOuts} (ã†ã¡é‹­ã„å‡¡é€€${quality.sO}æœ¬, è©°ã¾ã£ãŸå‡¡é€€${quality.wO}æœ¬))`;
        };
        team1QualityText = formatQualityText(dbMatch.team1, team1Quality);
        team2QualityText = formatQualityText(dbMatch.team2, team2Quality);
    }

    // --- 3. AIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆã®æº–å‚™ã¨å®Ÿè¡Œ ---
    const matchContext = createMatchContext(matchId, winnerName, team1QualityText, team2QualityText);
    if (!matchContext) {
        console.error("AIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆã«å¿…è¦ãªmatchContextã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        renderTournament(tournamentState);
        saveState();
        return;
    }

// â–¼â–¼â–¼ ã€è¿½åŠ ãƒ»ä¿®æ­£ã€‘283å­¦åœ’å‹åˆ©æ™‚ã®ã¿ã€ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚’ç™ºå‹• â–¼â–¼â–¼
    let interviewData = null;
    const is283Win = (winnerName === "283å­¦åœ’" || winnerName === "283å­¦åœ’B");
    
    // è¨˜äº‹ç”ŸæˆON ã‹ã¤ 283å­¦åœ’å‹åˆ©ã®å ´åˆ
    if (tournamentState.settings.enableArticleGeneration && is283Win) {
        // ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ (å›ç­”ãŒçµ‚ã‚ã‚‹ã¾ã§å¾…æ©Ÿ)
        try {
            interviewData = await startHeroInterview(matchContext);
        } catch (e) { console.error(e); }
        
        // çµæœã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ä¿å­˜ï¼ˆè¨˜äº‹ç”ŸæˆAIã«æ¸¡ã™ãŸã‚ï¼‰
        if (interviewData) {
            matchContext.interview = interviewData;
        }
    }
    // â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²

    let articlePromise = Promise.resolve(null);
    let commentsPromise = Promise.resolve(null);
    let hadaReportPromise = Promise.resolve(null);
    let matomeThreadPromise = Promise.resolve(null);
    let homepageNewsPromise = Promise.resolve(null);
    let cinderellaArticlePromise = Promise.resolve(null);
    let accidentArticlePromise = Promise.resolve(null);
let scoutReportPromise = Promise.resolve(null);
let snsPromise = Promise.resolve(null);

    // â˜…â˜…â˜… ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã®åˆ¤å®š â˜…â˜…â˜…
    const isKoshienMode = tournamentState.currentTournament === 'summer_koshien';
    const playerTeam = tournamentState.teams[0]; // 283å­¦åœ’(ã¾ãŸã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒãƒ¼ãƒ )
    const isPlayerMatch = (dbMatch.team1 === playerTeam || dbMatch.team2 === playerTeam);

    if (tournamentState.settings.enableArticleGeneration) {
        newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒè¨˜äº‹ã‚’åŸ·ç­†ä¸­...</div>`;
        
        // â˜…â˜…â˜… ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰ã®åˆ†å² â˜…â˜…â˜…
        if (isKoshienMode && isPlayerMatch) {
            // ç”²å­åœ’ï¼šåœ°å…ƒç´™é¢¨ã®å¿œæ´è¨˜äº‹
            articlePromise = generateKoshienNewsArticle(matchContext);
        } else {
            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šæ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯
            const documentary = tournamentState.documentary;
            const loserRank = calculateRank(loserName, tournamentState);
            
            // 1. å¿«é€²æ’ƒ(Cinderella)ã®åˆ¤å®š
            let cinderellaType = null;
            let roundNumForCinderella = 0;
            if (idParts[0] !== 'F' && tournamentState.currentTournament === 'summer') { 
                const roundNum = parseInt(idParts[1].slice(1));
                roundNumForCinderella = roundNum;
                if (loserRank === 'E' && roundNum === 3) cinderellaType = 'E_Rank_Top_32';
                else if (loserRank === 'D' && roundNum === 4) cinderellaType = 'D_Rank_Top_16';
                else if (loserRank === 'C' && roundNum === 5) cinderellaType = 'C_Rank_Top_8';
            }
            


            // 2. å¿«é€²æ’ƒè¨˜äº‹ã®ç”Ÿæˆ
            if (cinderellaType) {
                cinderellaArticlePromise = generateCinderellaArticle(loserName, loserRank, roundNumForCinderella, matchContext);
            }
            
// â˜…â˜…â˜… è¿½åŠ ç®‡æ‰€: 283å­¦åœ’æˆ¦ãªã‚‰ã‚¹ã‚«ã‚¦ãƒ†ã‚£ãƒ³ã‚°ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ â˜…â˜…â˜…
        if (winnerName === "283å­¦åœ’" || loserName === "283å­¦åœ’") {
            scoutReportPromise = generateKuriyamaReport(matchContext);
        }
// â˜…â˜…â˜… è¿½åŠ : 283å­¦åœ’æˆ¦ãªã‚‰SNSãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç”Ÿæˆ â˜…â˜…â˜…
        if (winnerName === "283å­¦åœ’" || loserName === "283å­¦åœ’") {
             // 283å­¦åœ’æˆ¦ä»¥å¤–ã§ã‚‚ã€Œæ±ºå‹ã€ãªã©ã¯ç”Ÿæˆã—ã¦ã‚‚è‰¯ã„ã§ã™ãŒã€APIç¯€ç´„ã®ãŸã‚çµã‚Šã¾ã™
             snsPromise = generateSnsPosts(matchContext);
        }
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

            // 3. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ or é€šå¸¸è¨˜äº‹
            if (documentary && documentary.target && (documentary.target === winnerName || documentary.target === loserName)) {
                 const isWin = documentary.target === winnerName;
                 const opponentName = isWin ? loserName : winnerName;
                 const opponentData = TEAM_DATA[opponentName];
                 const matchInfoForArticle = {
                    round: matchId.includes('-R') ? parseInt(matchId.split('-R')[1].split('-')[0]) : 1,
                    opponent: opponentName,
                    score: isWin ? `${dbMatch.score1}-${dbMatch.score2}` : `${dbMatch.score2}-${dbMatch.score1}`,
                    highlights: matchContext.highlights,
                    summary: dbMatch.summary,
                    opponentInfo: opponentData?.info || 'å¯¾æˆ¦ç›¸æ‰‹ã®æƒ…å ±ãªã—'
                };
                articlePromise = generateDocumentaryArticle(isWin ? 'win' : 'lose', documentary.type, documentary.target, matchInfoForArticle);
                if (!isWin) tournamentState.documentary = { target: null, type: null };
            } else {
                articlePromise = generateNewsArticle(matchContext);
            }
        }
    }
    
    const isNotableGame = (winnerRank === 'A' || winnerRank === 'B' || loserRank === 'A' || loserRank === 'B');
    // ç”²å­åœ’ã§ã¯ç¾½ç”°ãƒ¬ãƒãƒ¼ãƒˆã¯å‡ºã•ãªã„ï¼ˆåœ°å…ƒç´™ãŒå‡ºã‚‹ãŸã‚ï¼‰
    if (tournamentState.settings.enableArticleGeneration && isNotableGame && Math.random() < 0.25 && !isKoshienMode) {
        hadaReportPromise = generateHadaReport(matchContext);
    }

    if (tournamentState.settings.enableBbsGeneration) {
        bbsCommentsContainer.innerHTML = `<div class="loader">AIãŒæ²ç¤ºæ¿ã‚’ç›£è¦–ä¸­...</div>`;
        
        // â˜…â˜…â˜… ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰ã®åˆ†å² â˜…â˜…â˜…
        if (isKoshienMode && isPlayerMatch) {
            commentsPromise = generateKoshienBbsComments(matchContext);      // å¿œæ´BBS
            matomeThreadPromise = generateKoshienMatomeThread(matchContext); // å¿œæ´ã¾ã¨ã‚ã‚¹ãƒ¬
        } else {
            commentsPromise = generateBbsComments(matchContext);             // é€šå¸¸ãªã‚“J
            matomeThreadPromise = generateGameMatchBbsComments(matchContext);// é€šå¸¸ã¾ã¨ã‚
        }
    }
    
    if (tournamentState.settings.enableArticleGeneration && (winnerName === "283å­¦åœ’" || loserName === "283å­¦åœ’")) {
        homepageNewsPromise = generateHomepageNewsUpdate(matchContext);
    }

    // --- 5. AIã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å‡¦ç†ã¨æœ€çµ‚çš„ãªç”»é¢æ›´æ–° ---
    const [generatedArticle, generatedComments, generatedHadaReport, generatedMatomeThread, generatedHomepageNews, generatedCinderellaArticle, generatedScoutReport, generatedSns] = await Promise.all([
        articlePromise, 
        commentsPromise,
        hadaReportPromise,
        matomeThreadPromise,
        homepageNewsPromise,
        cinderellaArticlePromise,
        scoutReportPromise,
        snsPromise // <--- ã“ã“ã«è¿½åŠ 
    ]);

    if (generatedComments) {
        if (Array.isArray(generatedComments) && !generatedComments.some(c => c.error)) {
            const validComments = generatedComments.filter(comment => !comment.error);
            if (validComments.length > 0) {
                tournamentState.bbsComments.push(...validComments);
            }
        } else if (Array.isArray(generatedComments)) {
            const errorCommentData = generatedComments.find(comment => comment.error);
            if (errorCommentData && errorCommentData.context) {
                tournamentState.bbsComments.push({
                    title: "æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼",
                    body: "AIã«ã‚ˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã«ä¸€éƒ¨å¤±æ•—ã—ã¾ã—ãŸã€‚",
                    timestamp: Date.now(),
                    error: true,
                    errorId: `error-${matchId}-bbs-partial`,
                    context: errorCommentData.context
                });
            }
        } else if (generatedComments.error) {
            tournamentState.bbsComments.push({
                title: generatedComments.title || "æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼",
                body: generatedComments.body || "AIã«ã‚ˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(),
                error: true,
                errorId: generatedComments.errorId || `error-${matchId}-bbs`,
                context: generatedComments.context || matchContext
            });
        }
    }
    
// â˜…â˜…â˜… è¿½åŠ : SNSãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã¨é€šçŸ¥è¡¨ç¤º â˜…â˜…â˜…
    if (generatedSns) {
        // 1. å±¥æ­´é…åˆ—ãŒå­˜åœ¨ã—ãªã‘ã‚Œã°ä½œæˆ
        if (!tournamentState.snsLogs) tournamentState.snsLogs = [];
        
        // 2. ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨è©¦åˆæƒ…å ±ã‚’ä»˜ä¸ã—ã¦ä¿å­˜
        const snsLogEntry = {
            id: matchId,
            roundName: getRoundNameFromMatchId(matchId),
            matchTitle: `${winnerName} vs ${loserName}`,
            score: `${dbMatch.score1}-${dbMatch.score2}`,
            timestamp: Date.now(),
            data: generatedSns // posts ã¨ trends ã‚’å«ã‚€
        };
        
        // 3. å…ˆé ­ã«è¿½åŠ ï¼ˆæœ€æ–°ãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«ï¼‰
        tournamentState.snsLogs.unshift(snsLogEntry);
        
        // 4. ç¾åœ¨è¡¨ç¤ºç”¨ã®ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ã‚»ãƒƒãƒˆ
        currentSnsData = generatedSns; 
        
        // 5. é€šçŸ¥ãƒãƒŠãƒ¼ã‚’è¡¨ç¤º (ã‚¯ãƒªãƒƒã‚¯ã§é–‹ãç”¨)
        const notif = document.getElementById('trend-notification');
        const wordEl = document.getElementById('trend-notification-word');
        wordEl.textContent = generatedSns.trends[0];
        notif.classList.add('show');
        // â€»è‡ªå‹•ã§æ¶ˆã™setTimeoutã¯å‰Šé™¤æ¸ˆã¿
    }
    if (generatedCinderellaArticle) {
        tournamentState.news.push(generatedCinderellaArticle);
    }
    if (generatedArticle) {
        if (!generatedArticle.error) {
             generatedArticle.context = matchContext;
             // ç”²å­åœ’è¨˜äº‹ã‚„å¿«é€²æ’ƒè¨˜äº‹ã¯ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‡ºã•ãªã„ï¼ˆå³æ™‚åæ˜ ï¼‰
             if (!isKoshienMode) {
                showArticleReviewModal(generatedArticle);
             } else {
                tournamentState.news.push(generatedArticle);
             }
        } else {
            const errorArticle = {
                title: generatedArticle.title || "è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼",
                body: generatedArticle.body || "AIè¨˜è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(),
                error: true,
                errorId: matchContext.matchId || 'error',
                context: matchContext
            };
            tournamentState.news.push(errorArticle);
        }
    }

    if (generatedHadaReport) {
        tournamentState.news.push(generatedHadaReport);
    }
// â˜…â˜…â˜… è¿½åŠ ç®‡æ‰€: ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«è¿½åŠ  â˜…â˜…â˜…
    if (generatedScoutReport) {
        tournamentState.news.push(generatedScoutReport);
    }
    // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    if (generatedMatomeThread) {
        tournamentState.matomeThreads[matchId] = {
            thread: generatedMatomeThread,
            context: matchContext
        };
    }
    if (generatedHomepageNews && !generatedHomepageNews.error) {
        if (!tournamentState.homepageNews) tournamentState.homepageNews = [];
        tournamentState.homepageNews.unshift(generatedHomepageNews);
    }
    if (!tournamentState.activeScandal && Math.random() < 0.1) {
        triggerScandalEvent(winnerName, loserName);
    }

    // --- 6. ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢HTMLã®è‡ªå‹•ç”Ÿæˆ ---
    if (dbMatch.details) {
        try {
            dbMatch.boxScoreHtml = generateBoxScoreHTML(dbMatch);
        } catch (e) {
            console.error("ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢HTMLã®è‡ªå‹•ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
            dbMatch.boxScoreHtml = null;
        }
    }

    // --- 7. [NEW] ã‚¢ã‚¯ã‚·ãƒ‡ãƒ³ãƒˆæŠ½é¸ (283å­¦åœ’ãƒ™ãƒ³ãƒå…¥ã‚Šå…¨å“¡) ---
    const involvedTeams = [dbMatch.team1, dbMatch.team2];
    const opponentName = involvedTeams.find(t => t !== "283å­¦åœ’");

    if (involvedTeams.includes("283å­¦åœ’")) {
        const teamName = "283å­¦åœ’";
        const teamRecord = tournamentState.teamRecords[teamName];
        const staticRoster = TEAM_ROSTER_MASTER[teamName]; // ãƒ™ãƒ³ãƒå…¥ã‚Š20å
        const lastGameRoster = teamRecord.roster || []; // 1è©¦åˆå‰ã®ãƒ­ã‚¹ã‚¿ãƒ¼(ã‚¹ã‚¿ãƒ¡ãƒ³+æ§ãˆ)

        if (teamRecord && staticRoster) {
            
            // è©¦åˆã«å‡ºå ´ã—ãŸé¸æ‰‹ã‚’ç‰¹å®š
            const playersInGame = new Set();
            if (dbMatch.details) {
                const teamKey = (dbMatch.team1 === teamName) ? 'team1' : 'team2';
                (dbMatch.details.batting?.[teamKey] || []).forEach(p => { if (p.name) playersInGame.add(p.name); });
                (dbMatch.details.pitching?.[teamKey] || []).forEach(p => { if (p.name) playersInGame.add(p.name); });
            }

            staticRoster.forEach(player => { // 20åå…¨å“¡ã‚’ãƒ«ãƒ¼ãƒ—
                const playerName = player.name;
                if (!playerName) return;

                // 1. é¸æ‰‹ã®é€šç®—æˆç¸¾ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾— (ãªã‘ã‚Œã°åˆæœŸåŒ–)
                if (!teamRecord.playerStats.batting[playerName]) {
                    teamRecord.playerStats.batting[playerName] = { games: 0, pa: 0, ab: 0, h: 0, hr: 0, rbi: 0, sb: 0, bb: 0, hbp: 0, sf: 0, tb: 0, r: 0, so: 0, gamelogs: [] };
                }
                if (!teamRecord.playerStats.pitching[playerName]) {
                     teamRecord.playerStats.pitching[playerName] = { 
                        career: { games: 0, w: 0, l: 0, ip: 0, so: 0, er: 0, h: 0, bb: 0 },
                        gamelogs: []
                    };
                }
                
                const careerBattingStats = teamRecord.playerStats.batting[playerName];
                const careerPitchingStats = teamRecord.playerStats.pitching[playerName];

                // 2. æ—¢ã«æ•…éšœä¸­/ä½“èª¿ä¸è‰¯/è»½å‚·ã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
                const currentBattingFlag = careerBattingStats.narrative_flag;
                const currentPitchingFlag = careerPitchingStats.narrative_flag;
                
                if (currentBattingFlag === 'injured' || currentBattingFlag === 'sick' || currentBattingFlag === 'minor_injury' ||
                    currentPitchingFlag === 'injured' || currentPitchingFlag === 'sick' || currentPitchingFlag === 'minor_injury') {
                    return; 
                }

                // 3. â˜…â˜…â˜… é‡è¦åº¦ (Importance) ã®åˆ¤å®š â˜…â˜…â˜…
                let importance = 'Hikae'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (æ§ãˆ)
                const staticData = player; 
                const lastGameData = lastGameRoster.find(p => p.name === playerName);

                // (A) é™çš„ãƒ­ã‚¹ã‚¿ãƒ¼ã§ä¸»åŠ›ã‹ï¼Ÿ (ã‚¨ãƒ¼ã‚¹, æ•æ‰‹, ä¸»å°†)
                if (staticData.number === 1 || staticData.position.includes('æ•æ‰‹') || staticData.isCaptain) {
                    importance = 'Shuryoku_Static';
                }
                
                // (B) å‰å›ã®è©¦åˆã§ä¸»åŠ›ã ã£ãŸã‹ï¼Ÿ (ã‚¹ã‚¿ãƒ¡ãƒ³ã€ç‰¹ã«ã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—)
                if (lastGameData && !importance.startsWith('Shuryoku')) {
                    if (lastGameData.order && !lastGameData.order.toString().includes('sub')) {
                        importance = 'Regular_Dynamic'; // ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼
                        const orderNum = parseInt(lastGameData.order);
                        if (orderNum >= 3 && orderNum <= 5) {
                            importance = 'Shuryoku_Dynamic'; // ã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—
                        }
                        if (lastGameData.pos === 'æŠ•') {
                            importance = 'Shuryoku_Dynamic'; // å…ˆç™ºæŠ•æ‰‹
                        }
                    }
                }
                
                // (C) ä»Šå¤§ä¼šã®æˆç¸¾ãŒã‚ºãƒæŠœã‘ã¦ã„ã‚‹ã‹ï¼Ÿ (éš ã‚ŒãŸä¸»åŠ›åˆ¤å®š)
                if (!importance.startsWith('Shuryoku')) {
                    // â˜… æ–°ã—ã„ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½¿ç”¨
                    const tourneyStats = calculateCurrentTournamentStats(
                        careerBattingStats.gamelogs, 
                        careerPitchingStats.gamelogs, 
                        matchId
                    );
                    
                    if (tourneyStats.AVG > 0.400 && tourneyStats.AB >= 5) {
                        importance = 'Shuryoku_Dynamic'; // æ‰“ç‡4å‰²è¶…
                    }
                    if (tourneyStats.IP >= 5.0 && tourneyStats.ERA < 2.00) {
                        importance = 'Shuryoku_Dynamic'; // é˜²å¾¡ç‡1ç‚¹å°
                    }
                }
                // â˜…â˜…â˜… é‡è¦åº¦åˆ¤å®šã“ã“ã¾ã§ â˜…â˜…â˜…

                // 4. ã‚¢ã‚¯ã‚·ãƒ‡ãƒ³ãƒˆæŠ½é¸ (é‡è¦åº¦ã«å¿œã˜ã¦ç¢ºç‡å¤‰å‹•)
                let accidentOccurred = false;
                const isImportant = importance.startsWith('Shuryoku') || importance.startsWith('Regular');
                
                const sickChance = isImportant ? 0.005 : 0.005; // ä½“èª¿ä¸è‰¯ (ä¸»åŠ›3%, æ§ãˆ1%)
                const minorInjuryChance = isImportant ? 0.005 : 0.005; // è»½å‚· (ä¸»åŠ›5%, æ§ãˆ1%)

                // 4-1. ãƒ©ãƒ³ãƒ€ãƒ ã‚¢ã‚¯ã‚·ãƒ‡ãƒ³ãƒˆ (ä½“èª¿ä¸è‰¯)
                if (Math.random() < sickChance) {
                    careerBattingStats.narrative_flag = "sick";
                    careerPitchingStats.narrative_flag = "sick";
                    accidentArticlePromise = generateAccidentArticle(teamName, playerName, "accident_sickness", {}, importance);
                    accidentOccurred = true;
                }
                // 4-2. è»½å‚·
                else if (Math.random() < minorInjuryChance) {
                    careerBattingStats.narrative_flag = "minor_injury";
                    careerPitchingStats.narrative_flag = "minor_injury";
                    accidentArticlePromise = generateAccidentArticle(teamName, playerName, "accident_minor_injury", { 
                        log: `ç·´ç¿’ä¸­ï¼ˆã¾ãŸã¯${getRoundNameFromMatchId(matchId)}ã®${opponentName}æˆ¦ã§ã®ãƒ—ãƒ¬ãƒ¼ï¼‰`
                    }, importance);
                    accidentOccurred = true;
                }
                
                // 4-3. é…·ä½¿ãƒ»HBP (è©¦åˆå‡ºå ´é¸æ‰‹ã®ã¿)
                if (!accidentOccurred && dbMatch.details && playersInGame.has(playerName)) {
                    // æ‰“è€…å‡ºå ´ãƒã‚§ãƒƒã‚¯
                    const battingStats = dbMatch.details.playerGameStats?.[involvedTeams.indexOf(teamName) === 0 ? 'team1' : 'team2']?.[playerName];
                    if (battingStats) {
                        if (battingStats.hbp > 0 && Math.random() < 0.70) {
                            careerBattingStats.narrative_flag = "injured";
                            careerPitchingStats.narrative_flag = "injured";
                            accidentArticlePromise = generateAccidentArticle(teamName, playerName, "accident_hbp", { 
                                log: `${getRoundNameFromMatchId(matchId)}ã®${opponentName}æˆ¦ã§æ­»çƒã‚’å—ã‘ã‚‹` 
                            }, importance);
                            accidentOccurred = true;
                        }
                    }
                    // æŠ•æ‰‹å‡ºå ´ãƒã‚§ãƒƒã‚¯
                    const pitchingData = dbMatch.details.pitching?.[involvedTeams.indexOf(teamName) === 0 ? 'team1' : 'team2'];
                    const pitcherData = pitchingData?.find(p => p.name === playerName);
                    if (pitcherData) {
                        const pitches = parseInt(pitcherData.pitches || 0);
                        let overuseLog = "";
                        let setInjury = false;
                        
                        if (careerPitchingStats.gamelogs && careerPitchingStats.gamelogs.length >= 1) {
                            const today = parseDate(dbMatch.schedule?.date);
                            const recentLogs = careerPitchingStats.gamelogs
                                .filter(log => log.matchId !== matchId)
                                .sort((a, b) => (parseDate(b.date) || 0) - (parseDate(a.date) || 0))
                                .slice(0, 2);
                            
                            if (today && recentLogs.length > 0) {
                                const lastGame = recentLogs[0];
                                const lastDate = parseDate(lastGame.date);
                                const daysRest = lastDate ? Math.ceil(Math.abs(today - lastDate) / (1000 * 60 * 60 * 24)) - 1 : 99;
                                
                                if (daysRest === 0 && Math.random() < 0.10) { 
                                    setInjury = true; overuseLog = "é€£æŠ•";
                                } else if (daysRest === 1 && pitches >= 80 && Math.random() < 0.20) { 
                                    setInjury = true; overuseLog = "ä¸­1æ—¥ã§ã®80çƒä»¥ä¸Šã®ç™»æ¿";
                                }
                            }
                        }
                        if (setInjury) {
                            careerBattingStats.narrative_flag = "injured";
                            careerPitchingStats.narrative_flag = "injured";
                            accidentArticlePromise = generateAccidentArticle(teamName, playerName, "injury_overuse", { log: overuseLog, round: getRoundNameFromMatchId(matchId) }, importance);
                            accidentOccurred = true;
                        }
                    }
                }

                // 5. é€šå¸¸ã®èª¿å­åˆ¤å®š (è©¦åˆå‡ºå ´é¸æ‰‹ã®ã¿)
                if (!accidentOccurred && dbMatch.details && playersInGame.has(playerName)) {
                    const battingStats = dbMatch.details.playerGameStats?.[involvedTeams.indexOf(teamName) === 0 ? 'team1' : 'team2']?.[playerName];
                    if (battingStats) {
                         if (battingStats.pa > 0) {
                            if (battingStats.h >= 4 || battingStats.hr >= 2 || battingStats.rbi >= 5) careerBattingStats.narrative_flag = "peak";
                            else if (battingStats.h >= 3 || battingStats.hr >= 1 || battingStats.rbi >= 3) careerBattingStats.narrative_flag = "hot";
                            else if (battingStats.ab >= 3 && battingStats.h === 0) {
                                if (battingStats.strongOuts >= 2) careerBattingStats.narrative_flag = "cold";
                                else careerBattingStats.narrative_flag = "slump";
                            } else careerBattingStats.narrative_flag = "normal";
                        } else {
                            careerBattingStats.narrative_flag = "normal";
                        }
                    }
                    const pitchingData = dbMatch.details.pitching?.[involvedTeams.indexOf(teamName) === 0 ? 'team1' : 'team2'];
                    const pitcherData = pitchingData?.find(p => p.name === playerName);
                    if (pitcherData) {
                        const opponentTeamKey = teamName === dbMatch.team1 ? 'team2' : 'team1';
                        const opponentBattingStats = dbMatch.details.playerGameStats[opponentTeamKey] || {};
                        let totalStrongOuts = 0, totalWeakOuts = 0, totalStrongHits = 0;
                        for (const oppPlayerName in opponentBattingStats) {
                            const oppStats = opponentBattingStats[oppPlayerName];
                            totalStrongOuts += oppStats.strongOuts || 0;
                            totalWeakOuts += oppStats.weakOuts || 0;
                            totalStrongHits += oppStats.strongHits || 0;
                        }
                        const innings = parseFloat(pitcherData.innings || 0);
                        const earnedRuns = parseInt(pitcherData.earnedRuns || 0);
                        const strikeouts = parseInt(pitcherData.strikeouts || 0);
                        const walks = parseInt(pitcherData.walks || 0);
                        const hits = parseInt(pitcherData.hits || 0);
                        const pitches = parseInt(pitcherData.pitches || 0);
                        
                        if (innings >= 5) {
                            if ((innings >= 7 && earnedRuns === 0) || strikeouts >= 10) careerPitchingStats.narrative_flag = "peak";
                            else if (innings >= 6 && earnedRuns <= 2 && pitcherData.result !== 'L') careerPitchingStats.narrative_flag = "hot";
                            else if (totalWeakOuts >= 5 && earnedRuns <= 3) careerPitchingStats.narrative_flag = "hot";
                            else if (earnedRuns >= 5) careerPitchingStats.narrative_flag = "slump";
                            else if (walks >= 5 || (hits >= 8 && innings <= 6)) careerPitchingStats.narrative_flag = "cold";
                            else careerPitchingStats.narrative_flag = "normal";
                            if (pitcherData.result === 'L' && totalStrongHits >= 5) careerPitchingStats.narrative_flag = "unlucky";
                            if (pitcherData.result === 'L' && innings >= 7 && earnedRuns <= 2) careerPitchingStats.narrative_flag = "tough_loss";
                        } else if (pitches >= 100) {
                            careerPitchingStats.narrative_flag = "fatigued";
                        } else {
                            careerPitchingStats.narrative_flag = "normal";
                        }
                    }
                }
            }); // roster loop
        }
    }
    // â˜…â˜…â˜… ã‚¢ã‚¯ã‚·ãƒ‡ãƒ³ãƒˆæŠ½é¸ã“ã“ã¾ã§ â˜…â˜…â˜…
    
    // --- 8. ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†ãƒã‚§ãƒƒã‚¯ã¨ç·æ‹¬ã‚¹ãƒ¬ãƒƒãƒ‰ç”Ÿæˆ ---
    if (side !== 'F' && idParts[1] && idParts[1].startsWith('R')) {
        const roundNum = parseInt(idParts[1].slice(1));
        checkAndTriggerRoundSummary(roundNum);
    }

    // --- 9. ã‚¢ã‚¯ã‚·ãƒ‡ãƒ³ãƒˆè¨˜äº‹ã®å‡¦ç† ---
    if (accidentArticlePromise) {
        const accidentArticle = await accidentArticlePromise;
        if (accidentArticle) {
            tournamentState.news.push(accidentArticle);
        }
    }

    saveState();

    // --- 10. ãƒ­ã‚¹ã‚¿ãƒ¼æƒ…å ±ï¼ˆèƒŒç•ªå·ã€ãƒã‚¸ã‚·ãƒ§ãƒ³ã€æŠ•æ‰“ï¼‰ã‚’è¨˜éŒ² ---
    if (dbMatch.details && dbMatch.details.batting) {
        for (const teamKey of ['team1', 'team2']) {
            const teamName = dbMatch[teamKey];
            const teamRecord = tournamentState.teamRecords[teamName];
            const battingData = dbMatch.details.batting[teamKey];
            if (teamRecord && battingData && battingData.length > 0) {
                teamRecord.previousStarters = battingData
                    .filter(p => p.order && !p.order.toString().includes('sub'))
                    .map(p => ({ order: p.order, name: p.name, pos: p.pos }));
                teamRecord.roster = battingData.map(p => ({
                    order: p.order,
                    name: p.name,
                    number: p.number,
                    pos: p.currentPos || p.pos,
                    throwBat: p.throwBat,
                    sub_type: p.sub_type
                }));
            }
        }
    }

// â–¼â–¼â–¼ ã€ã“ã“ã«è¿½åŠ ã€‘ â–¼â–¼â–¼
    // è¨˜äº‹ç”Ÿæˆã®è£ã§éåŒæœŸã«å®Ÿè¡Œã•ã›ã‚‹ï¼ˆawaitã—ãªãã¦è‰¯ã„ï¼‰
    if (matchContext) {
        updateNarrativeImmediate(winnerName, loserName, matchContext);
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
    
    // --- 11. æœ€çµ‚æç”» ---
    renderTournament(tournamentState);
}
// â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
/**
 * ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç”Ÿã•ã›ã‚‹
 * @param {string} winnerName 
 * @param {string} loserName 
 */
function triggerScandalEvent(winnerName, loserName) {
    const potentialTargets = [winnerName, loserName];
    const eligibleScandals = [];

    for (const team of potentialTargets) {
        for (const scandal of SCANDAL_DEFINITIONS) {
            if (scandal.condition(team)) {
                eligibleScandals.push({ team, scandal });
            }
        }
    }

    if (eligibleScandals.length > 0) {
        const selected = eligibleScandals[Math.floor(Math.random() * eligibleScandals.length)];
        
        tournamentState.activeScandal = {
            teamName: selected.team,
            scandalId: selected.scandal.id
        };

        // â–¼â–¼â–¼ ã“ã®éƒ¨åˆ†ã‚’ä¿®æ­£ â–¼â–¼â–¼
        const rumorArticle = {
            title: selected.scandal.rumorTitle(selected.team), // é–¢æ•°ã¨ã—ã¦å‘¼ã³å‡ºã—ã€teamNameã‚’æ¸¡ã™
            body: selected.scandal.rumorBody(selected.team),   // é–¢æ•°ã¨ã—ã¦å‘¼ã³å‡ºã—ã€teamNameã‚’æ¸¡ã™
            timestamp: Date.now(),
            isScandalRumor: true
        };
        // â–²â–²â–² ã“ã“ã¾ã§ä¿®æ­£ â–²â–²â–²

        tournamentState.news.push(rumorArticle);
        renderNews(tournamentState.news);
        saveState();
    }
}
// â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–²

// --- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
let articleForReview = null; // ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚çš„ã«ä¿æŒã™ã‚‹

/**
 * AIãŒç”Ÿæˆã—ãŸè¨˜äº‹ã‚’ç¢ºèªãƒ»ç·¨é›†ã™ã‚‹ãŸã‚ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
 * @param {object} article - AIãŒç”Ÿæˆã—ãŸè¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function showArticleReviewModal(article) {
    articleForReview = article; // è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ä¿å­˜

    document.getElementById('review-title').value = article.title;
    document.getElementById('review-body').value = article.body.replace(/\\n/g, '\n');
    
    document.getElementById('review-modal').classList.remove('hidden');
}

/**
 * ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
 */
function closeReviewModal() {
    articleForReview = null;
    document.getElementById('review-modal').classList.add('hidden');
}

// --- éŠã³æ–¹èª¬æ˜æ›¸ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('help-modal');
    const helpModalClose = document.getElementById('help-modal-close');

    helpBtn.addEventListener('click', () => {
        helpModal.classList.remove('hidden');
    });
    helpModalClose.addEventListener('click', () => {
        helpModal.classList.add('hidden');
    }); 


// â–¼â–¼â–¼ æŠ½é¸ä¼šã‚¤ãƒ™ãƒ³ãƒˆé–¢é€£ã®é–¢æ•°ç¾¤ â–¼â–¼â–¼

const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

/**
 * åŠ¹æœéŸ³ã‚’èª­ã¿è¾¼ã‚€
 */
async function loadSoundEffects() {
    try {
        const drumroll = new Audio("https://actions.google.com/sounds/v1/sports/drum_roll_long.ogg");
        const cheer = new Audio("https://actions.google.com/sounds/v1/crowds/battle_crowd_cheer_med.ogg");
        const gasp = new Audio("https://actions.google.com/sounds/v1/human_sounds/gasp.ogg");
        soundEffects = { drumroll, cheer, gasp };
    } catch (e) {
        console.error("åŠ¹æœéŸ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
    }
}

// â–¼â–¼â–¼ ã“ã®2ã¤ã®é–¢æ•°ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨ã€Œæ–°è¦è¿½åŠ ã€(13058è¡Œç›®ã‚ãŸã‚Šã€startLotteryEvent ã®ç›´å‰) â–¼â–¼â–¼

/**
 * [NEW] ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«å°‚ç”¨ã®ã€æœ€æ–°ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨HTMLã‚’ç”Ÿæˆã™ã‚‹
 * (283å­¦åœ’ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆä»˜ãã€è¡¨ç¤ºå°‚ç”¨)
 * @param {object} state - tournamentState
 * @returns {string} - ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨å…¨ä½“ã®HTML
 */
function generateHomepageBracketHTML(state) {
    const { matches, teams, seeds } = state;
    if (!teams || teams.length < 32) { // 64ãƒãƒ¼ãƒ åˆ¶ã®ã¿å¯¾å¿œ
        return '<p class="text-center text-gray-500">ï¼ˆ64ãƒãƒ¼ãƒ åˆ¶ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰</p>';
    }

    const bracketContentWrapper = document.createElement('div');
    bracketContentWrapper.className = 'tournament-container'; // ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ç”¨ã®ã‚¯ãƒ©ã‚¹

    const leftBracketEl = document.createElement('div');
    leftBracketEl.className = 'bracket-half left';

    const rightBracketEl = document.createElement('div');
    rightBracketEl.className = 'bracket-half right';
    
    // æ±ºå‹æˆ¦ã®æº–å‚™ (renderMainBracketã¨åŒæ§˜)
    const finalRound = 6;
    const semiFinalRound = 5;
    const leftChampion = state.matches[`L-R${semiFinalRound}-M1`]?.winner ?? null;
    const rightChampion = state.matches[`R-R${semiFinalRound}-M1`]?.winner ?? null;
    const finalMatch = state.matches['F-R1-M1'] || {};
    const finalTeam1 = finalMatch.team1 ?? leftChampion;
    const finalTeam2 = finalMatch.team2 ?? rightChampion;
    const finalEl = document.createElement('div');
    finalEl.className = 'bracket-final';
    finalEl.innerHTML = `
        <div class="round-title">æ±ºå‹</div>
        <div class="final-matchup">
            ${createHomepageMatchHTML('F-R1-M1', finalTeam1, finalTeam2, finalMatch, seeds)}
        </div>
        <div class="winner-box">
            <h2>${finalMatch.winner ? `ğŸ† å„ªå‹ ${finalMatch.winner}` : 'ğŸ†'}</h2>
        </div>
    `;

    // --- å·¦å³ã®ãƒãƒ¼ãƒ•ã‚’ç”Ÿæˆ ---
    const roundNameMap = { 1: "1å›æˆ¦", 2: "2å›æˆ¦", 3: "3å›æˆ¦", 4: "æº–ã€…æ±ºå‹", 5: "æº–æ±ºå‹" };
    
    // å·¦ãƒãƒ¼ãƒ•
    let parentEl = leftBracketEl;
    for (let r = 1; r <= semiFinalRound; r++) {
        const roundEl = document.createElement('div');
        roundEl.className = `round r${r}`;
        roundEl.innerHTML = `<div class="round-title">${roundNameMap[r]}</div>`;
        const numMatchesInRound = 32 / Math.pow(2, r);
        for (let m = 1; m <= numMatchesInRound; m++) {
            const matchId = `L-R${r}-M${m}`;
            const dbMatch = matches[matchId] || {};
            const team1 = dbMatch.team1 || (r > 1 ? matches[`L-R${r-1}-M${(m*2)-1}`]?.winner : teams[(m-1)*2]) || null;
            const team2 = dbMatch.team2 || (r > 1 ? matches[`L-R${r-1}-M${(m*2)}`]?.winner : teams[(m-1)*2 + 1]) || null;
            roundEl.innerHTML += createHomepageMatchHTML(matchId, team1, team2, dbMatch, seeds);
        }
        parentEl.appendChild(roundEl);
    }

    // å³ãƒãƒ¼ãƒ•
    parentEl = rightBracketEl;
    for (let r = 1; r <= semiFinalRound; r++) {
        const roundEl = document.createElement('div');
        roundEl.className = `round r${r}`;
        roundEl.innerHTML = `<div class="round-title">${roundNameMap[r]}</div>`;
        const numMatchesInRound = 32 / Math.pow(2, r);
        for (let m = 1; m <= numMatchesInRound; m++) {
            const matchId = `R-R${r}-M${m}`;
            const dbMatch = matches[matchId] || {};
            const baseIndex = 32; // å³ãƒãƒ¼ãƒ•ã®é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            const team1 = dbMatch.team1 || (r > 1 ? matches[`R-R${r-1}-M${(m*2)-1}`]?.winner : teams[baseIndex + (m-1)*2]) || null;
            const team2 = dbMatch.team2 || (r > 1 ? matches[`R-R${r-1}-M${(m*2)}`]?.winner : teams[baseIndex + (m-1)*2 + 1]) || null;
            roundEl.innerHTML += createHomepageMatchHTML(matchId, team1, team2, dbMatch, seeds);
        }
        parentEl.appendChild(roundEl);
    }
    
    bracketContentWrapper.append(leftBracketEl, finalEl, rightBracketEl);
    return bracketContentWrapper.outerHTML;
}

// â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚’ã€Œæ–°è¦è¿½åŠ ã€(11984è¡Œç›®ã‚ãŸã‚Š) â–¼â–¼â–¼
/**
 * [NEW] ãƒãƒ¼ãƒ ã®å…¨æŠ•æ‰‹ã®é€šç®—æˆç¸¾ã‚’é›†è¨ˆã—ã€ãƒãƒ¼ãƒ é˜²å¾¡ç‡ã¨WHIPã‚’è¨ˆç®—ã™ã‚‹
 * @param {string} teamName - ãƒãƒ¼ãƒ å
 * @returns {object} - { era: string, whip: string }
 */
function calculateTeamPitchingStats(teamName) {
    const teamRecord = tournamentState.teamRecords[teamName];
    if (!teamRecord || !teamRecord.playerStats || !teamRecord.playerStats.pitching) {
        return { era: "----", whip: "----" };
    }

    const pitchingStats = teamRecord.playerStats.pitching;
    let totalER = 0;
    let totalIP = 0;
    let totalHits = 0;
    let totalWalks = 0;

    for (const playerName in pitchingStats) {
        const career = pitchingStats[playerName].career;
        if (career) {
            totalER += career.er || 0;
            totalIP += career.ip || 0;
            totalHits += career.h || 0;
            totalWalks += career.bb || 0;
        }
    }

    const era_val = (totalIP > 0) ? ((totalER * 9) / totalIP) : Infinity;
    const whip_val = (totalIP > 0) ? ((totalHits + totalWalks) / totalIP) : Infinity;

    return {
        era: (era_val === Infinity) ? "----" : era_val.toFixed(2),
        whip: (whip_val === Infinity) ? "----" : whip_val.toFixed(2)
    };
}
// â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// â–¼â–¼â–¼ æ—¢å­˜ã®ã€ŒcreateHomepageMatchHTMLã€é–¢æ•° (13115è¡Œç›®ã‚ãŸã‚Š) ã‚’ã€ä»¥ä¸‹ã§ã€Œç½®ãæ›ãˆã€ â–¼â–¼â–¼

/**
 * [NEW] ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«å°‚ç”¨ã®ã€1è©¦åˆåˆ†ã®HTMLã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…ã€Œä¸€çƒé€Ÿå ±ã€ãƒœã‚¿ãƒ³ ï¼‹ ã€Œèª¿å­ã€ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºã‚’è¿½åŠ ã—ãŸæœ€çµ‚ç‰ˆ)
 */
function createHomepageMatchHTML(matchId, team1, team2, dbMatch, seeds = []) {
    const is283Team = (name) => name === "283å­¦åœ’" || name === "283å­¦åœ’B";

    const t1Empty = !team1;
    const t2Empty = !team2;
    
    // 283å­¦åœ’ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¯ãƒ©ã‚¹
    const team1Class = is283Team(team1) ? 'hp-team-283' : '';
    const team2Class = is283Team(team2) ? 'hp-team-283' : '';
    
    // å‹æ•—ã‚¯ãƒ©ã‚¹
    const winnerClass1 = (dbMatch.winner === team1 && !t1Empty) ? 'winner' : '';
    const loserClass1 = (dbMatch.winner && dbMatch.winner !== team1 && !t1Empty) ? 'loser' : '';
    const winnerClass2 = (dbMatch.winner === team2 && !t2Empty) ? 'winner' : '';
    const loserClass2 = (dbMatch.winner && dbMatch.winner !== team2 && !t2Empty) ? 'loser' : '';
    
    // ã‚·ãƒ¼ãƒ‰è¡¨ç¤º
    const seedInfo1 = seeds.find(s => s.team === team1);
    const seedInfo2 = seeds.find(s => s.team === team2);
    const seedLabel1 = seedInfo1 ? `[${seedInfo1.rank}] ` : '';
    const seedLabel2 = seedInfo2 ? `[${seedInfo2.rank}] ` : '';

    const roundClassMatch = matchId.includes('-R1-M') ? 'r1' : '';

    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
    // é¸æ‰‹ã®èª¿å­ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
    const getConditionIconForTeam = (teamName) => {
        if (!teamName) return ""; 
        
        const teamRecord = tournamentState.teamRecords[teamName];
        if (!teamRecord || !teamRecord.playerStats) return "";

        let icons = [];
        // (æ³¨: ã“ã®é–¢æ•°ã¯ã€Œè©¦åˆå‰ã€ã«æç”»ã•ã‚Œã‚‹ãŸã‚ã€ã‚¢ã‚¤ã‚³ãƒ³ã¯ã€Œå‰ã®è©¦åˆã€ã®çµæœã§ã™)
        // æ‰“è€…ã®èª¿å­
        if (teamRecord.playerStats.batting) {
            for (const playerName in teamRecord.playerStats.batting) {
                const flag = teamRecord.playerStats.batting[playerName].narrative_flag;
                const icon = getPlayerConditionIcon(flag);
                if (icon) icons.push(icon);
            }
        }
        // æŠ•æ‰‹ã®èª¿å­
        if (teamRecord.playerStats.pitching) {
            for (const playerName in teamRecord.playerStats.pitching) {
                const flag = teamRecord.playerStats.pitching[playerName].narrative_flag;
                const icon = getPlayerConditionIcon(flag);
                if (icon) icons.push(icon);
            }
        }
        // é‡è¤‡ã‚’é™¤å»ã—ã¦è¿”ã™
        return [...new Set(icons)].join('');
    };

    const team1ConditionIcons = getConditionIconForTeam(team1);
    const team2ConditionIcons = getConditionIconForTeam(team2);

    let footerButtonHTML = '';
    if (dbMatch.winner && dbMatch.boxScoreHtml) {
        footerButtonHTML = `
            <div class="matchup-footer mt-1 text-center">
                <button class="boxscore-btn text-xs bg-blue-600 text-white font-bold px-3 py-1 rounded hover:bg-blue-700" data-match-id="${matchId}">
                    ä¸€çƒé€Ÿå ±
                </button>
            </div>
        `;
    }
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    return `
        <div class="matchup ${roundClassMatch}">
            <div class="match">
                <div class="team ${team1Class} ${winnerClass1} ${loserClass1}">
                    <span class="name">${seedLabel1}${team1 || '---'} ${team1ConditionIcons}</span>
                    <span class="score">${dbMatch.score1 ?? ''}</span>
                </div>
                <div class="team ${team2Class} ${winnerClass2} ${loserClass2}">
                    <span class="name">${seedLabel2}${team2 || '---'} ${team2ConditionIcons}</span>
                    <span class="score">${dbMatch.score2 ?? ''}</span>
                </div>
            </div>
            ${footerButtonHTML}
            ${matchId.includes('-R1-M') ? '' : '<div class="connector-line"></div>'}
            ${matchId.includes('-R2-M') ? '<div class="connector-path"></div>' : ''}
            ${matchId.includes('-R3-M') ? '<div class="connector-path"></div>' : ''}
            ${matchId.includes('-R4-M') ? '<div class="connector-path"></div>' : ''}
            ${matchId.includes('-R5-M') ? '<div class="connector-path"></div>' : ''}
        </div>
    `;
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²


/**
 * æŠ½é¸ä¼šã‚¤ãƒ™ãƒ³ãƒˆã‚’é–‹å§‹ã™ã‚‹
 * (â˜…128ãƒãƒ¼ãƒ åˆ¶ï¼128ã‚¹ãƒ­ãƒƒãƒˆã«å¯¾å¿œ)
 */
async function startLotteryEvent() {
    const lotteryModal = document.getElementById('lottery-modal');
    lotteryModal.classList.remove('hidden');
    lotteryModal.classList.add('flex');

    // (ã‚·ãƒ¼ãƒ‰æ ¡æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
    const historicalRanks = INITIAL_TEAM_POOL.map(teamName => ({ name: teamName, rank: getRankFromHistoryString(TEAM_DATA[teamName].last) }));
    historicalRanks.sort((a, b) => a.rank - b.rank);
    const seeds = historicalRanks.slice(0, 8).map((t, i) => ({ team: t.name, rank: i + 1 })); 
    
    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
    // ç°¡æ˜“ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚’ä½œæˆ (128ãƒãƒ¼ãƒ åˆ†)
    const leftBracket = document.getElementById('lottery-bracket-left');
    const rightBracket = document.getElementById('lottery-bracket-right');
    leftBracket.innerHTML = '';
    rightBracket.innerHTML = '';
    for(let i=0; i<128; i++){ // 64 -> 128
        const slot = document.createElement('div');
        slot.className = 'lottery-slot';
        slot.dataset.index = i;
        slot.innerHTML = `<span>${i+1}.</span> <span class="team-name-placeholder">---</span>`;
        // 64æœªæº€ã¯å·¦ã€64ä»¥ä¸Šã¯å³
        document.getElementById(i < 64 ? 'lottery-bracket-left' : 'lottery-bracket-right').appendChild(slot);
    }
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    // (ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯å¤‰æ›´ãªã—)
    document.getElementById('start-lottery-btn').onclick = () => runLotteryAnimation(lotteryOrder, seeds);
    document.getElementById('skip-lottery-btn').onclick = () => {
        lotteryModal.classList.add('hidden');
        SoundManager.stopBgm();
        createNewTournament(false, 'summer');
    };

    // (æŠ½é¸é †ã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
    const seedTeamsList = seeds.map(s => s.team);
    const nonSeeds = INITIAL_TEAM_POOL.filter(t => !seedTeamsList.includes(t));
    
    // â˜… ä¸æˆ¦å‹(BYE)ã‚’æŠ½é¸å¯¾è±¡ã«è¿½åŠ 
    const byesNeeded = 128 - nonSeeds.length - seeds.length;
    const byes = Array(byesNeeded).fill('(BYE)');
    const lotteryOrder = [...seedTeamsList, ...shuffleArray([...nonSeeds, ...byes])];

    SoundManager.startBgm();
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * æŠ½é¸ä¼šã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹
 * (â˜…128ãƒãƒ¼ãƒ åˆ¶ãƒ»7ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¶ã«å¯¾å¿œã—ãŸæœ€çµ‚ç‰ˆ)
 * @param {Array<string>} lotteryOrder - å…¨ãƒãƒ¼ãƒ ã®æŠ½é¸é † (ã‚·ãƒ¼ãƒ‰æ ¡ãŒå…ˆ)
 * @param {Array<object>} seeds - ã‚·ãƒ¼ãƒ‰æ ¡8ãƒãƒ¼ãƒ ã®ãƒ©ãƒ³ã‚¯ä»˜ãã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—
 */
async function runLotteryAnimation(lotteryOrder, seeds) {
    // --- 1. åˆæœŸè¨­å®š ---
    document.getElementById('lottery-pot').onclick = null;
    document.getElementById('skip-lottery-btn').style.display = 'none';
    
    const initialAiEnabled = document.getElementById('initial-ai-generation-toggle').checked;

    const commentaryEl = document.getElementById('lottery-commentary').querySelector('p');
    const drawnTeamContainer = document.getElementById('drawn-team-container');
    const drawnTeamEl = document.getElementById('drawn-team');
    const potEl = document.getElementById('lottery-pot');
    const potNameEl = document.getElementById('pot-name');
    
    // â˜…â˜…â˜… ä¿®æ­£ç‚¹ â˜…â˜…â˜…
    const teamPositions = Array(128).fill(null); // 64 -> 128
    const seedPositionsTemplate = [0, 64, 32, 96, 16, 80, 48, 112]; // 128ãƒãƒ¼ãƒ ç”¨ã®é…ç½®
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…
    
    // (ã‚·ãƒ¼ãƒ‰é…ç½®ã‚¹ãƒ­ãƒƒãƒˆã®æº–å‚™ãƒ­ã‚¸ãƒƒã‚¯ ... å¤‰æ›´ãªã—)
    const rank1_4_teams_sorted = seeds.filter(s => s.rank <= 4).sort((a, b) => a.rank - b.rank);
    const rank1_4_teams = [
        rank1_4_teams_sorted[0], // ç¬¬1ã‚·ãƒ¼ãƒ‰
        rank1_4_teams_sorted[1], // ç¬¬2ã‚·ãƒ¼ãƒ‰
        rank1_4_teams_sorted[3], // ç¬¬4ã‚·ãƒ¼ãƒ‰
        rank1_4_teams_sorted[2]  // ç¬¬3ã‚·ãƒ¼ãƒ‰
    ].filter(Boolean);
    const rank5_8_teams = shuffleArray(seeds.filter(s => s.rank > 4));
    const rank1_4_positions = seedPositionsTemplate.slice(0, 4); // [0, 64, 32, 96]
    const rank5_8_positions = shuffleArray(seedPositionsTemplate.slice(4)); // [16, 80, 48, 112] ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    
    // â˜…â˜…â˜… ä¿®æ­£ç‚¹ â˜…â˜…â˜…
    let availableNonSeedSlots = Array.from({length: 128}, (_, i) => i).filter(p => !seedPositionsTemplate.includes(p)); // 64 -> 128
    const blockDeathAnnounced = { A: false, B: false, C: false, D: false };

    // (å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: playSound, isStrongRank ... å¤‰æ›´ãªã—)
    const playSound = (id) => {
        const soundElement = document.getElementById(id);
        if (soundElement) {
            soundElement.currentTime = 0;
            soundElement.play().catch(e => console.warn(`Audio play failed for ${id}:`, e));
        }
    };
    const isStrongRank = (team) => ['A'].includes(calculateRank(team, {}));

    // (å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: checkDeathBlock ... â˜…ä¿®æ­£â˜…)
    const checkDeathBlock = (position) => {
        // 128ãƒãƒ¼ãƒ  / 4ãƒ–ãƒ­ãƒƒã‚¯ = 1ãƒ–ãƒ­ãƒƒã‚¯32ãƒãƒ¼ãƒ 
        const blockName = position < 32 ? 'A' : position < 64 ? 'B' : position < 96 ? 'C' : 'D';
        const startIdx = position < 32 ? 0 : position < 64 ? 32 : position < 96 ? 64 : 96;
        constblockSize = 32; // â˜… 16 -> 32
        
        if (blockDeathAnnounced[blockName]) return false;
        
        const teamsInBlock = teamPositions.slice(startIdx, startIdx + blockSize);
        // â˜… 3ãƒãƒ¼ãƒ  -> 4ãƒãƒ¼ãƒ  ã«å¤‰æ›´
        const strongTeamsCount = teamsInBlock.filter(team => team && ['A', 'B'].includes(calculateRank(team, {}))).length; 
        if (strongTeamsCount >= 4) { // â˜… 3 -> 4
            commentaryEl.textContent = `ã“ã‚Œã¯...ï¼ ${blockName}ãƒ–ãƒ­ãƒƒã‚¯ã¯æœ‰åŠ›æ ¡ãŒé›†ä¸­ã™ã‚‹ã€Œæ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã€ã«ãªã‚Šã¾ã—ãŸï¼`;
            blockDeathAnnounced[blockName] = true;
            playSound('sound-gasp');
            return true;
        }
        return false;
    };
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…


    // --- 2. æŠ½é¸ä¼šãƒ•ã‚§ãƒ¼ã‚º1ï¼šã‚·ãƒ¼ãƒ‰æ ¡ã®é…ç½® ---
    potNameEl.textContent = "ã‚·ãƒ¼ãƒ‰æ ¡";
    
    // (ç¬¬1ã€œç¬¬4ã‚·ãƒ¼ãƒ‰ã®é…ç½® (å›ºå®šä½ç½®ãƒ»å±±åˆ†ã‘) ... å¤‰æ›´ãªã—)
    for (let i = 0; i < rank1_4_teams.length; i++) {
        const teamName = rank1_4_teams[i].team;
        const teamRank = rank1_4_teams[i].rank;
        const position = rank1_4_positions[i]; 

        let dreadBg = null;
        if (isStrongRank(teamName) && initialAiEnabled) {
            dreadBg = document.createElement('div');
            dreadBg.className = 'dread-mode-bg';
            document.body.appendChild(dreadBg);
            potEl.classList.add('dread');
            commentaryEl.textContent = `ä¼šå ´ãŒé™ã¾ã‚Šè¿”ã‚‹... ç¬¬${teamRank}ã‚·ãƒ¼ãƒ‰ã€ ${teamName} ã§ã™...`;
            await sleep(2500);
        }

        commentaryEl.textContent = `ç¬¬${teamRank}ã‚·ãƒ¼ãƒ‰ã€${teamName}ãŒã‚¯ã‚¸ã‚’å¼•ãã¾ã™...`;
        playSound('sound-drumroll');
        await sleep(1500);
        drawnTeamEl.textContent = teamName;
        drawnTeamContainer.classList.add('fade-in-out');
        teamPositions[position] = teamName;
        await sleep(1250);
        const targetSlot = document.querySelector(`.lottery-slot[data-index="${position}"]`);
        targetSlot.querySelector('.team-name-placeholder').textContent = `[${teamRank}] ${teamName}`;
        targetSlot.classList.add('filled', 'highlight'); 
        playSound('sound-cymbal');
        if (dreadBg) {
            dreadBg.remove();
            potEl.classList.remove('dread');
            playSound('sound-gasp');
        }
        commentaryEl.textContent = `ç¬¬${teamRank}ã‚·ãƒ¼ãƒ‰ã€${teamName}ã¯ ${position + 1}ç•ªã«æ±ºå®šï¼`;
        await sleep(1500);
        drawnTeamContainer.classList.remove('fade-in-out');
        targetSlot.classList.remove('highlight');
    }

    // (ç¬¬5ã€œç¬¬8ã‚·ãƒ¼ãƒ‰ã®é…ç½® (ãƒ©ãƒ³ãƒ€ãƒ ä½ç½®) ... å¤‰æ›´ãªã—)
    for (let i = 0; i < rank5_8_teams.length; i++) {
        const teamName = rank5_8_teams[i].team;
        const teamRank = rank5_8_teams[i].rank;
        const position = rank5_8_positions[i]; 
        commentaryEl.textContent = `ç¬¬${teamRank}ã‚·ãƒ¼ãƒ‰ã€${teamName}ãŒã‚¯ã‚¸ã‚’å¼•ãã¾ã™...`;
        playSound('sound-drumroll');
        await sleep(1500);
        drawnTeamEl.textContent = teamName;
        drawnTeamContainer.classList.add('fade-in-out');
        teamPositions[position] = teamName;
        await sleep(1250);
        const targetSlot = document.querySelector(`.lottery-slot[data-index="${position}"]`);
        targetSlot.querySelector('.team-name-placeholder').textContent = `[${teamRank}] ${teamName}`;
        targetSlot.classList.add('filled', 'highlight');
        playSound('sound-cymbal');
        commentaryEl.textContent = `ç¬¬${teamRank}ã‚·ãƒ¼ãƒ‰ã€${teamName}ã¯ ${position + 1}ç•ªã«æ±ºå®šï¼`;
        await sleep(1500);
        drawnTeamContainer.classList.remove('fade-in-out');
        targetSlot.classList.remove('highlight');
    }


    // --- 3. æŠ½é¸ä¼šãƒ•ã‚§ãƒ¼ã‚º2ï¼šãƒãƒ¼ã‚·ãƒ¼ãƒ‰æ ¡ã®é…ç½® (ãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´ãªã—) ---
    potNameEl.textContent = "ãƒãƒ¼ã‚·ãƒ¼ãƒ‰æ ¡";
    const nonSeeds = lotteryOrder.filter(t => !seeds.map(s => s.team).includes(t));
    for (const teamName of nonSeeds) {
        let dreadBg = null;
        if (isStrongRank(teamName) && initialAiEnabled) {
            dreadBg = document.createElement('div');
            dreadBg.className = 'dread-mode-bg';
            document.body.appendChild(dreadBg);
            potEl.classList.add('dread');
            commentaryEl.textContent = `ä¼šå ´ãŒé™ã¾ã‚Šè¿”ã‚‹... ãƒãƒ¼ã‚·ãƒ¼ãƒ‰ã®å¼·è±ª ${teamName} ãŒç™»å ´...`;
            await sleep(2500);
        }

        commentaryEl.textContent = `${teamName}ãŒã‚¯ã‚¸ã‚’å¼•ãã¾ã™...`;
        playSound('sound-drumroll');
        await sleep(250);
        drawnTeamEl.textContent = teamName;
        drawnTeamContainer.classList.add('fade-in-out');
        const slotIndex = Math.floor(Math.random() * availableNonSeedSlots.length);
        const position = availableNonSeedSlots.splice(slotIndex, 1)[0];
        teamPositions[position] = teamName;
        await sleep(200);
        const targetSlot = document.querySelector(`.lottery-slot[data-index="${position}"]`);
        targetSlot.querySelector('.team-name-placeholder').textContent = teamName;
        targetSlot.classList.add('filled');
        playSound('sound-cymbal');
        if (dreadBg) {
            dreadBg.remove();
            potEl.classList.remove('dread');
            playSound('sound-gasp');
        }
        commentaryEl.textContent = `${teamName}ã¯ ${position + 1}ç•ª ã«æ±ºå®šï¼`;
        
        let didComment = false;
        if (initialAiEnabled) {
             didComment = checkDeathBlock(position);
        }

        if (!didComment) {
            const opponentIndex = position % 2 === 0 ? position + 1 : position - 1;
            if(teamPositions[opponentIndex]) {
                const opponentName = teamPositions[opponentIndex];
                const opponentIsSeed = seeds.some(s => s.team === opponentName);
                const isRival = (isStrongRank(teamName) && opponentIsSeed) || 
                              (['A','B'].includes(calculateRank(teamName, {})) && ['A','B'].includes(calculateRank(opponentName, {})));
                if (isRival && initialAiEnabled) {
                    commentaryEl.textContent = `æ±ºã¾ã£ãŸãƒ¼ï¼1å›æˆ¦ã‹ã‚‰å±ˆæŒ‡ã®å¥½ã‚«ãƒ¼ãƒ‰ï¼ ${teamName} vs ${opponentName}`;
                    playSound('sound-gasp');
                    document.querySelector(`.lottery-slot[data-index="${opponentIndex}"]`).classList.add('highlight');
                    targetSlot.classList.add('highlight');
                    await sleep(1500);
                    document.querySelector(`.lottery-slot[data-index="${opponentIndex}"]`).classList.remove('highlight');
                    targetSlot.classList.remove('highlight');
                }
            }
        }
        await sleep(250);
        drawnTeamContainer.classList.remove('fade-in-out');
    }

    // --- 4. çµ‚äº†å‡¦ç† ---
    commentaryEl.textContent = 'å…¨ã¦ã®çµ„ã¿åˆã‚ã›ãŒæ±ºå®šã—ã¾ã—ãŸï¼';
    await sleep(2000);
    
    if (initialAiEnabled) {
        await generateCaptainInterviews(teamPositions);
    } else {
        document.getElementById('lottery-modal').classList.add('hidden');
        SoundManager.stopBgm();
        createNewTournament(false, 'summer', teamPositions);
    }
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
/**
 * [UPDATED] æŠ½é¸ä¼šå¾Œã®ä¸»å°†ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆãƒ»è¡¨ç¤ºã™ã‚‹
 * (â˜…ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰ã«å¯¾å¿œ)
 */
async function generateCaptainInterviews(teamPositions) {
    const interviewModal = document.getElementById('interview-modal');
    const interviewContent = document.getElementById('interview-content');
    interviewContent.innerHTML = `<div class="loader">AIè¨˜è€…ãŒä¸»å°†ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆä¸­...</div>`;
    interviewModal.classList.remove('hidden');

    const matchups = [];
    // 128ãƒãƒ¼ãƒ åˆ¶(çœŒ) or 64ãƒãƒ¼ãƒ åˆ¶(ç”²å­åœ’)
    const numTeams = teamPositions.length;
    for(let i=0; i<numTeams; i+=2){
        if (teamPositions[i] && teamPositions[i+1]) {
            matchups.push({team1: teamPositions[i], team2: teamPositions[i+1]});
        }
    }

    const notableMatchups = shuffleArray(matchups).slice(0, 5);

    const matchupsWithRanks = notableMatchups.map(m => ({
        team1: m.team1,
        rank1: calculateRank(m.team1, tournamentState),
        team2: m.team2,
        rank2: calculateRank(m.team2, tournamentState)
    }));
    const promptDataText = matchupsWithRanks.map(m => 
        `- ${m.team1} (ãƒ©ãƒ³ã‚¯: ${m.rank1}) vs ${m.team2} (ãƒ©ãƒ³ã‚¯: ${m.rank2})`
    ).join('\n');

    // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®åˆ‡ã‚Šæ›¿ãˆ â˜…â˜…â˜…
    const isKoshien = tournamentState.currentTournament === 'summer_koshien';
    const contextText = isKoshien ? "å¤ã®ç”²å­åœ’ï¼ˆå…¨å›½å¤§ä¼šï¼‰" : "å¤ã®çœŒå¤§ä¼š";
    const extraInstruction = isKoshien 
        ? "- ç”²å­åœ’ã¨ã„ã†å¤§èˆå°ã¸ã®ç·Šå¼µæ„Ÿã‚„ã€å…¨å›½åˆ¶è¦‡ã¸ã®æ„æ°—è¾¼ã¿ã‚’å«ã‚ã¦ãã ã•ã„ã€‚" 
        : "- ãƒãƒ¼ãƒ ã®èƒŒæ™¯ï¼ˆä¾‹ï¼šç‹è€…ã€å¤è±ªï¼‰ã‚‚å°‘ã—ã ã‘ã‚³ãƒ¡ãƒ³ãƒˆã«åæ˜ ã•ã›ã¦ãã ã•ã„ã€‚";
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    const prompt = `ã‚ãªãŸã¯é«˜æ ¡é‡çƒå°‚é–€ã®AIè¨˜è€…ã§ã™ã€‚${contextText}ã®çµ„ã¿åˆã‚ã›æŠ½é¸ä¼šãŒçµ‚äº†ã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®æ³¨ç›®ã‚«ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã€ä¸¡ãƒãƒ¼ãƒ ã®ä¸»å°†ã«ãªã‚Šãã£ã¦ã€æŠ½é¸çµæœã«å¯¾ã™ã‚‹ãƒªã‚¢ãƒ«ãªåå¿œã‚’èªã£ã¦ãã ã•ã„ã€‚

### æ³¨ç›®ã‚«ãƒ¼ãƒ‰ã¨å„ãƒãƒ¼ãƒ ã®ãƒ©ãƒ³ã‚¯
${promptDataText}

### ã‚ãªãŸãŒãªã‚Šãã‚‹ã€Œé«˜æ ¡ç”Ÿã®ä¸»å°†ã€ã®æ€è€ƒãƒ‘ã‚¿ãƒ¼ãƒ³
- **(BYE) ä¸æˆ¦å‹ã¨å½“ãŸã£ãŸå ´åˆ:**
  - ã€Œåˆæˆ¦ãŒä¸æˆ¦å‹ãªã®ã¯ãƒ©ãƒƒã‚­ãƒ¼ã ã€ã€Œã¾ãšã¯2å›æˆ¦ã«å‘ã‘ã¦ã—ã£ã‹ã‚Šæº–å‚™ã—ãŸã„ã€ã¨ã€å®‰å µã¨æ²¹æ–­ã®ãªã•ã‚’è¡¨æ˜ã™ã‚‹ã€‚
- **æ ¼ä¸‹ã®ç›¸æ‰‹ã¨å½“ãŸã£ãŸå ´åˆ (ä¾‹: Aãƒ©ãƒ³ã‚¯ vs Dãƒ©ãƒ³ã‚¯):**
  - å°‘ã—å®‰å µã—ãŸæ§˜å­ã‚’è¦‹ã›ã‚‹ã€‚ã€Œè‡ªåˆ†ãŸã¡ã®é‡çƒã‚’ã™ã‚Œã°è² ã‘ãªã„ã€
  - ã—ã‹ã—æ²¹æ–­ã¯ç¦ç‰©ã ã¨ä»˜ã‘åŠ ãˆã‚‹ã€‚ã€Œä¸€æˆ¦å¿…å‹ã§æˆ¦ã„ãŸã„ã€
- **æ ¼ä¸Šã®ç›¸æ‰‹ã¨å½“ãŸã£ãŸå ´åˆ (ä¾‹: Eãƒ©ãƒ³ã‚¯ vs Aãƒ©ãƒ³ã‚¯):**
  - ã€Œã¾ã•ã‹åˆæˆ¦ã§å½“ãŸã‚‹ã¨ã¯â€¦ã€ã¨é©šãã¤ã¤ã€ã€Œèƒ¸ã‚’å€Ÿã‚Šã‚‹ã¤ã‚‚ã‚Šã§å…¨åŠ›ã§ã¶ã¤ã‹ã‚ŠãŸã„ã€ã¨é—˜å¿—ã‚’è¦‹ã›ã‚‹ã€‚
- **å®ŸåŠ›ãŒæ‹®æŠ—ã—ã¦ã„ã‚‹ç›¸æ‰‹ã¨å½“ãŸã£ãŸå ´åˆ (ä¾‹: Cãƒ©ãƒ³ã‚¯ vs Cãƒ©ãƒ³ã‚¯):**
  - ã€Œã“ã“ãŒæœ€åˆã®å±±å ´ã«ãªã‚‹ã€ã€Œæœ€é«˜ã®è©¦åˆã‚’ã—ãŸã„ã€ã¨ã€ãƒ©ã‚¤ãƒãƒ«ã¨ã®å¯¾æˆ¦ã‚’å¿ƒå¾…ã¡ã«ã—ã¦ã„ã‚‹æ§˜å­ã‚’è¦‹ã›ã‚‹ã€‚

### æŒ‡ç¤º
- ä¸Šè¨˜ã®æ€è€ƒãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ãã€å„ã‚«ãƒ¼ãƒ‰ã®ä¸¡ä¸»å°†ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
${extraInstruction}

### å‡ºåŠ›å½¢å¼ (JSONé…åˆ—)
[
    {"team": "ã€‡ã€‡é«˜æ ¡", "captain_comment": "ï¼ˆä¸»å°†ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"},
    {"team": "â–³â–³é«˜æ ¡", "captain_comment": "ï¼ˆä¸»å°†ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"}
]`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        const interviews = parseJsonFromText(result.candidates[0].content.parts[0].text);

        if (interviews && Array.isArray(interviews)) {
            interviewContent.innerHTML = interviews.map(iv => `
                <div class="p-4 bg-gray-50 rounded-lg mb-2">
                    <h4 class="font-bold text-lg text-gray-800">${iv.team} ä¸»å°†</h4>
                    <p class="mt-1 text-gray-700">ã€Œ${iv.captain_comment}ã€</p>
                </div>
            `).join('');
        } else {
            throw new Error("Parsed JSON is not an array or is null.");
        }
    } catch (e) {
        interviewContent.innerHTML = `<p class="text-center text-red-500">ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
        console.error(e);
    }
    
    // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç† (ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦å†é–‹å‡¦ç†ã‚’å¤‰ãˆã‚‹)
    document.getElementById('close-interview-btn').onclick = () => {
        interviewModal.classList.add('hidden');
        document.getElementById('lottery-modal').classList.add('hidden');
        SoundManager.stopBgm();
        
        if (isKoshien) {
            // ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ setupKoshienTournament ã¯æ—¢ã«å®Œäº†ã—ã¦ã„ã‚‹ã®ã§ã€å†æç”»ã®ã¿ã§OKã ãŒã€
            // å®Ÿéš›ã«ã¯æŠ½é¸ä¼šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯çœŒå¤§ä¼šã§ã—ã‹å‘¼ã°ã‚Œãªã„æƒ³å®šã®UIã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€
            // ã‚‚ã—ç”²å­åœ’ã§æŠ½é¸ä¼šã‚’ã™ã‚‹ãªã‚‰ã“ã“ã‚’èª¿æ•´ã€‚
            // ç¾çŠ¶ã®ãƒ•ãƒ­ãƒ¼ã§ã¯ç”²å­åœ’ã¯æŠ½é¸ã‚¢ãƒ‹ãƒ¡ãªã—ã§é–‹å§‹ã•ã‚Œã‚‹ã®ã§ã€ã“ã“ã¯ä¸»ã«çœŒå¤§ä¼šç”¨ã€‚
            createNewTournament(false, 'summer', teamPositions);
        } else {
            createNewTournament(false, 'summer', teamPositions);
        }
    };
}
     
/**
 * [NEW] ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€£å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®Intersection Observer
 */
function setupScrollAnimation() {
    const scrollContainer = document.getElementById('homepage-scroll-container');
    if (!scrollContainer) return;

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('is-visible');
                // ä¸€åº¦è¡¨ç¤ºã•ã‚ŒãŸã‚‰ç›£è¦–ã‚’è§£é™¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                // observer.unobserve(entry.target);
            } else {
                 // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã—ãŸã‚‰éè¡¨ç¤ºã«æˆ»ã™å ´åˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                 // entry.target.classList.remove('is-visible');
            }
        });
    }, {
        root: scrollContainer, // ç›£è¦–å¯¾è±¡ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã«è¨­å®š
        rootMargin: '0px',
        threshold: 0.1 // 10%è¦‹ãˆãŸã‚‰ãƒˆãƒªã‚¬ãƒ¼
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç›£è¦–å¯¾è±¡ã«è¿½åŠ 
    scrollContainer.querySelectorAll('.fade-in-section').forEach(section => {
        observer.observe(section);
    });
}

/**
 * [NEW] ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã/é–‰ã˜ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒˆãƒªã‚¬ãƒ¼
 */
function toggleHomepageModal(show) {
    const modal = document.getElementById('homepage-modal');
    if (!modal) return;

    if (show) {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆï¼†ãƒˆãƒªã‚¬ãƒ¼
        const slogan = modal.querySelector('.slogan');
        const subtitle = modal.querySelector('.animate-fade-in-up');
        if (slogan) slogan.classList.remove('animate-fade-in-down');
        if (subtitle) subtitle.classList.remove('is-visible');
        
        // requestAnimationFrame ã‚’æŒŸã‚€ã“ã¨ã§ã€ã‚¯ãƒ©ã‚¹ã®å†é©ç”¨ã‚’ç¢ºå®Ÿã«ã™ã‚‹
        requestAnimationFrame(() => {
            if (slogan) slogan.classList.add('animate-fade-in-down');
            if (subtitle) subtitle.classList.add('is-visible');
        });

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€£å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        setupScrollAnimation();
        
    } else {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        
        // é–‰ã˜ã‚‹æ™‚ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ¬¡å›é–‹ãã¨ãã®ãŸã‚ï¼‰
        modal.querySelectorAll('.fade-in-section').forEach(section => {
            section.classList.remove('is-visible');
        });
        modal.querySelector('.slogan')?.classList.remove('animate-fade-in-down');
        modal.querySelector('.animate-fade-in-up')?.classList.remove('is-visible');
    }
}
// â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²


// â–¼â–¼â–¼ ç”²å­åœ’ãƒ»æ¿€é—˜ã‚·ãƒŠãƒªã‚ªãƒ¢ãƒ¼ãƒ‰ã®å®Ÿè£… â–¼â–¼â–¼

/**
 * [UPDATED] å¤ã®çœŒå¤§ä¼šå„ªå‹ãƒãƒ¼ãƒ ã‚’è¿ãˆã€ç”²å­åœ’æ¿€é—˜ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
 * (â˜…çœŒå¤§ä¼šæˆç¸¾ä¿å­˜ã€å·å¤–ã€ãã—ã¦ã€Œä»£è¡¨æ ¡ç´¹ä»‹è¨˜äº‹ã€ã®ç”Ÿæˆã‚’è¿½åŠ )
 */
async function setupKoshienTournament(winnerName) {
    console.log(`ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰èµ·å‹•: ä»£è¡¨æ ¡ ${winnerName}`);
    
    // 1. å¼·è±ªæ ¡ãƒ‡ãƒ¼ã‚¿ã®æ³¨å…¥
    addLegendaryTeamsData();

    // 2. çœŒå¤§ä¼šæˆç¸¾ã®ä¿å­˜ã¨ãƒªã‚»ãƒƒãƒˆ
    const championRecord = tournamentState.teamRecords[winnerName];
    if (championRecord && championRecord.tournamentStats) {
        championRecord.prefecturalStats = JSON.parse(JSON.stringify(championRecord.tournamentStats));
        championRecord.tournamentStats = { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0, sb: 0, r: 0, so: 0, bb: 0, hbp: 0, sf: 0 };
    }

    // 3. ã‚¹ãƒ†ãƒ¼ãƒˆã®æ›´æ–°
    tournamentState.currentTournament = 'summer_koshien';
    tournamentState.matches = {}; 

    // 4. å‚åŠ ãƒãƒ¼ãƒ ã®ç”Ÿæˆ
    const playerTeam = winnerName;
    const bossTeams = ["èŠ±å·»æ±", "æ¨ªæµœ", "å ±å¾³å­¦åœ’", "æµ¦å’Œå­¦é™¢", "å¤§é˜ªæ¡è”­", "æ—¥å¤§ä¸‰"];
    const dummyTeams = generateDummyTeams(57, [playerTeam, ...bossTeams]);

    // 5. ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã¸ã®é…ç½®
    const teams = Array(64).fill(null);
    teams[0] = playerTeam;      
    teams[1] = bossTeams[0];    
    teams[2] = bossTeams[1];    
    teams[4] = bossTeams[2];    
    teams[8] = bossTeams[3];    
    teams[16] = bossTeams[4];   
    teams[32] = bossTeams[5];   
    
    let dummyIdx = 0;
    for (let i = 0; i < 64; i++) {
        if (!teams[i]) {
            teams[i] = dummyTeams[dummyIdx++];
        }
        if (!tournamentState.teamRecords[teams[i]]) {
            tournamentState.teamRecords[teams[i]] = {
                wins: 0, losses: 0, best: null, history: [], lastFinish: 64,
                playerStats: { batting: {}, pitching: {} },
                tournamentStats: { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0, sb: 0, r: 0, so: 0 }
            };
        }
    }
    tournamentState.teams = teams;
    tournamentState.seeds = []; 

    // 6. è©¦åˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç”Ÿæˆ
    const round1Setup = teams.reduce((acc, team, i) => {
        if (i % 2 === 0) acc.push({ team1: team, team2: null });
        else acc[acc.length - 1].team2 = team;
        return acc;
    }, []);
    
    round1Setup.forEach((match, index) => {
        const side = index < 16 ? 'L' : 'R';
        const matchNum = index < 16 ? index + 1 : index - 15;
        const matchId = `${side}-R1-M${matchNum}`;
        let rivalry = null;
        // æµ¦å’Œå­¦é™¢ã¨ã®å› ç¸è¨­å®š
        if ((match.team1.includes("283") && match.team2 === "æµ¦å’Œå­¦é™¢") || (match.team1 === "æµ¦å’Œå­¦é™¢" && match.team2.includes("283"))) {
            rivalry = "æ˜¨å¤ã®é›ªè¾±æˆ¦";
        }
        tournamentState.matches[matchId] = { 
            id: matchId, team1: match.team1, team2: match.team2, winner: null, 
            score1: '', score2: '', details: null, summary: '', rivalryType: rivalry 
        };
    });

    const finalRound = 6;
    for (let r = 2; r < finalRound; r++) {
        const numMatchesInRound = 64 / Math.pow(2, r);
        for (let m = 1; m <= numMatchesInRound / 2; m++) {
            const matchIdL = `L-R${r}-M${m}`;
            tournamentState.matches[matchIdL] = { id: matchIdL, team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '' };
            const matchIdR = `R-R${r}-M${m}`;
            tournamentState.matches[matchIdR] = { id: matchIdR, team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '' };
        }
    }
    tournamentState.matches['F-R1-M1'] = { id: 'F-R1-M1', team1: null, team2: null, winner: null, score1: '', score2: '', details: null, summary: '' };

    // 7. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦
    const koshienStadium = [{ name: "é˜ªç¥ç”²å­åœ’çƒå ´", abbr: "ç”²", region: "å…¨å›½" }];
    
    // 1å›æˆ¦ (32è©¦åˆ): 8æ—¥é–“ (1æ—¥4è©¦åˆ)
    const r1Ids = Object.keys(tournamentState.matches).filter(id => id.includes('-R1-'));
    scheduleRoundMatches(r1Ids, [
        "8/6", "8/7", "8/8", "8/9", "8/10", "8/11", "8/12", "8/13"
    ], koshienStadium, 4);

    // 2å›æˆ¦ (16è©¦åˆ): 4æ—¥é–“ (1æ—¥4è©¦åˆ)
    const r2Ids = Object.keys(tournamentState.matches).filter(id => id.includes('-R2-'));
    scheduleRoundMatches(r2Ids, [
        "8/14", "8/15", "8/16", "8/17"
    ], koshienStadium, 4);

    // 3å›æˆ¦ (8è©¦åˆ): 2æ—¥é–“ (1æ—¥4è©¦åˆ) â€»8/18ã¯ä¼‘é¤Šæ—¥æƒ³å®š
    const r3Ids = Object.keys(tournamentState.matches).filter(id => id.includes('-R3-'));
    scheduleRoundMatches(r3Ids, [
        "8/19", "8/20"
    ], koshienStadium, 4);

    // æº–ã€…æ±ºå‹ (4è©¦åˆ): 1æ—¥ (ä¸€æ–‰é–‹å‚¬) â€»8/21ã¯ä¼‘é¤Šæ—¥æƒ³å®š
    const r4Ids = Object.keys(tournamentState.matches).filter(id => id.includes('-R4-'));
    scheduleRoundMatches(r4Ids, ["8/22"], koshienStadium, 4);

    // æº–æ±ºå‹ (2è©¦åˆ): 1æ—¥ â€»8/23ã¯ä¼‘é¤Šæ—¥æƒ³å®š
    const r5Ids = Object.keys(tournamentState.matches).filter(id => id.includes('-R5-'));
    scheduleRoundMatches(r5Ids, ["8/24"], koshienStadium, 2);

    // æ±ºå‹ (1è©¦åˆ) â€»8/25ã¯ä¼‘é¤Šæ—¥æƒ³å®š
    const finalId = Object.keys(tournamentState.matches).filter(id => id.startsWith('F-R1-'));
    scheduleRoundMatches(finalId, ["8/26"], koshienStadium, 1);
    mainBracketWrapper.classList.remove('hidden');
    renderTournament(tournamentState);
    
    // ãƒ‹ãƒ¥ãƒ¼ã‚¹ç”Ÿæˆã‚­ãƒ¥ãƒ¼
    const newsQueue = [];

    // 1. å·å¤–
    newsQueue.push({
        title: "ã€å·å¤–ã€‘å¤ã®ç”²å­åœ’ çµ„ã¿åˆã‚ã›æ±ºå®šï¼ ä»£è¡¨æ ¡ã¯ã€Œæ­»ã®ãƒ–ãƒ­ãƒƒã‚¯ã€ã¸",
        body: `${winnerName}ã®ç”²å­åœ’åˆæˆ¦ã®ç›¸æ‰‹ã¯ã€å²©æ‰‹ã®æ€ªç‰©ç”£å‡ºæ ¡ã€ŒèŠ±å·»æ±ã€ã«æ±ºå®šã—ã¾ã—ãŸã€‚\nã•ã‚‰ã«å‹ã¡ä¸ŠãŒã‚Œã°æ¨ªæµœã€å ±å¾³å­¦åœ’ã¨ç¶šãæ¿€æˆ¦åŒºã«å…¥ã£ã¦ãŠã‚Šã€æº–ã€…æ±ºå‹ã§ã¯å› ç¸ã®æµ¦å’Œå­¦é™¢ã€æº–æ±ºå‹ã§ã¯å¤§é˜ªæ¡è”­ã¨ã®å¯¾æˆ¦ãŒäºˆæƒ³ã•ã‚Œã‚‹ã€Œåœ°ç„ã®ãƒ­ãƒ¼ãƒ‰ã€ã¨ãªã‚Šã¾ã—ãŸã€‚`,
        timestamp: Date.now(),
        context: { isBracketAnalysis: true }
    });

    // 2. ä»£è¡¨æ ¡ç´¹ä»‹
    newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒç”²å­åœ’ç‰¹é›†è¨˜äº‹ã‚’åŸ·ç­†ä¸­...</div>`;
    const introArticle = await generateKoshienTeamIntro(winnerName);
    if (introArticle) newsQueue.push(introArticle);

    // 3. â˜…â˜…â˜… æ³¨ç›®é¸æ‰‹10é¸ â˜…â˜…â˜…
    const top10Article = await generateTopPlayersArticle();
    if (top10Article) newsQueue.push(top10Article);

    // ã¾ã¨ã‚ã¦è¿½åŠ 
    tournamentState.news.push(...newsQueue);
    renderNews(tournamentState.news);
    saveState();
}

/**
 * [UPDATED] å¼·è±ª6æ ¡ã®ãƒ‡ãƒ¼ã‚¿ã¨ã€ãã®ä¸»åŠ›é¸æ‰‹ã®ã€Œäºˆé¸æˆç¸¾ã€ã‚’ç”Ÿæˆã—ã¦ç™»éŒ²ã™ã‚‹
 * (â˜…å…¨ãƒãƒ¼ãƒ Aãƒ©ãƒ³ã‚¯ã«ãªã‚‹ã‚ˆã†åå·®å€¤ã‚’å¼·åŒ–)
 */
function addLegendaryTeamsData() {
    // 1. ãƒãƒ¼ãƒ åŸºæœ¬æƒ…å ±ã®ç™»éŒ² (åå·®å€¤ã‚’80ä»¥ä¸Šã«è¨­å®š)
    const newTeams = {
        "èŠ±å·»æ±": { region: "æ±åŒ—", type: "ç§ç«‹", deviation: 88, info: "å²©æ‰‹ã®æ€ªç‰©ç”£å‡ºæ ¡ã€‚", coach: { name: 'ä½ã€…æœ¨ æ´‹', style: 'å¸¸è­˜æ‰“ç ´' }, best: "ç”²å­åœ’ãƒ™ã‚¹ãƒˆ4", last: "ç”²å­åœ’å‡ºå ´" },
        "æ¨ªæµœ": { region: "é–¢æ±", type: "ç§ç«‹", deviation: 89, info: "ç¥å¥ˆå·ã®åé–€ã€‚", coach: { name: 'æ‘ç”° æµ©æ˜', style: 'è‚²æˆä¸Šæ‰‹' }, best: "ç”²å­åœ’å„ªå‹", last: "ç”²å­åœ’å‡ºå ´" },
        "å ±å¾³å­¦åœ’": { region: "è¿‘ç•¿", type: "ç§ç«‹", deviation: 87, info: "é€†è»¢ã®å ±å¾³ã€‚", coach: { name: 'å¤§è§’ å¥äºŒ', style: 'å…¨å“¡é‡çƒ' }, best: "ç”²å­åœ’å„ªå‹", last: "ã‚»ãƒ³ãƒãƒ„æº–å„ªå‹" },
        "æµ¦å’Œå­¦é™¢": { region: "é–¢æ±", type: "ç§ç«‹", deviation: 86, info: "è¶…å¼·åŠ›æ‰“ç·šã€‚", coach: { name: 'æ£® å¤§', style: 'è¶…æ”»æ’ƒå‹' }, best: "ç”²å­åœ’å„ªå‹", last: "ç”²å­åœ’ãƒ™ã‚¹ãƒˆ8" },
        "å¤§é˜ªæ¡è”­": { region: "è¿‘ç•¿", type: "ç§ç«‹", deviation: 95, info: "çµ¶å¯¾ç‹è€…ã€‚", coach: { name: 'è¥¿è°· æµ©ä¸€', style: 'ç‹é“é‡çƒ' }, best: "ç”²å­åœ’å„ªå‹", last: "ç”²å­åœ’å„ªå‹" },
        "æ—¥å¤§ä¸‰": { region: "é–¢æ±", type: "ç§ç«‹", deviation: 88, info: "å¼·æ‰“ã®æ—¥ä¸‰ã€‚", coach: { name: 'ä¸‰æœ¨ æœ‰é€ ', style: 'ç©æ¥µæ‰“æ’ƒ' }, best: "ç”²å­åœ’å„ªå‹", last: "ç”²å­åœ’ãƒ™ã‚¹ãƒˆ4" }
    };
    Object.assign(TEAM_DATA, newTeams);

    // 2. è©³ç´°é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¹ã‚¿ãƒ¼é¸æ‰‹ï¼‰ã®ç™»éŒ²
    const legendaryPlayers = {
        "èŠ±å·»æ±": [
            { name: "ä½ã€…æœ¨(éºŸ)", year: 3, position: "ä¸€å¡æ‰‹", stats: { avg: .480, hr: 8, rbi: 25, sb: 5 }, desc: "é«˜æ ¡é€šç®—140ç™ºã®æ€ªç‰©ã‚¹ãƒ©ãƒƒã‚¬ãƒ¼" },
            { name: "å¤§è°·(ç¿”)", year: 3, position: "æŠ•æ‰‹", stats: { era: 0.80, w: 5, so: 60, k9: 12.5 }, desc: "æœ€é€Ÿ160kmã‚’èª‡ã‚‹äºŒåˆ€æµã®å¤©æ‰" }
        ],
        "æ¨ªæµœ": [
            { name: "æ¾å‚", year: 3, position: "æŠ•æ‰‹", stats: { era: 1.10, w: 6, so: 55, k9: 10.2 }, desc: "ã€Œå¹³æˆã®æ€ªç‰©ã€ã®å†æ¥ã€‚ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒæ­¦å™¨" },
            { name: "ç­’é¦™", year: 3, position: "å³ç¿¼æ‰‹", stats: { avg: .450, hr: 6, rbi: 20, sb: 2 }, desc: "ãƒãƒã®ã‚´ã‚¸ãƒ©ã€‚åºƒè§’ã«æ‰“ã¡åˆ†ã‘ã‚‹é•·è·é›¢ç ²" }
        ],
        "å ±å¾³å­¦åœ’": [
            { name: "å°åœ’", year: 3, position: "éŠæ’ƒæ‰‹", stats: { avg: .510, hr: 3, rbi: 15, sb: 12 }, desc: "è¶…é«˜æ ¡ç´šã®å®ˆå‚™ã¨ä¿Šè¶³ã€æ‰“æ’ƒã‚»ãƒ³ã‚¹ã‚’å…¼å‚™" }
        ],
        "æµ¦å’Œå­¦é™¢": [
            { name: "æ£®(å£«)", year: 3, position: "æŠ•æ‰‹", stats: { era: 1.50, w: 5, so: 40, k9: 8.5 }, desc: "é–¢æ±No.1å·¦è…•ã€‚ç²¾å¯†æ©Ÿæ¢°ã®ã‚ˆã†ãªåˆ¶çƒåŠ›" },
            { name: "è¥¿å·", year: 3, position: "ä¸­å …æ‰‹", stats: { avg: .390, hr: 4, rbi: 18, sb: 8 }, desc: "å¤©æ‰çš„ãªãƒãƒƒãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«" }
        ],
        "å¤§é˜ªæ¡è”­": [
            { name: "ä¸­ç”°", year: 3, position: "ä¸€å¡æ‰‹", stats: { avg: .550, hr: 9, rbi: 30, sb: 3 }, desc: "ã€Œæ€ªç‰©ã€ã®åã‚’ã»ã—ã„ã¾ã¾ã«ã™ã‚‹å¤§ä¼šæœ€å¼·æ‰“è€…" },
            { name: "è—¤æµª", year: 3, position: "æŠ•æ‰‹", stats: { era: 0.50, w: 6, so: 70, k9: 13.0 }, desc: "197cmã‹ã‚‰æŠ•ã’ä¸‹ã‚ã™å‰›é€Ÿçƒã¯ã‚¢ãƒ³ã‚¿ãƒƒãƒãƒ£ãƒ–ãƒ«" },
            { name: "æ£®(å‹)", year: 2, position: "æ•æ‰‹", stats: { avg: .420, hr: 5, rbi: 22, sb: 1 }, desc: "å¤©æ‰çš„ãªæ‰“æ’ƒæŠ€è¡“ã‚’æŒã¤å¸ä»¤å¡”" }
        ],
        "æ—¥å¤§ä¸‰": [
            { name: "ç•”ä¸Š", year: 3, position: "å³ç¿¼æ‰‹", stats: { avg: .410, hr: 5, rbi: 24, sb: 4 }, desc: "å¼·æ‰“ã®æ—¥ä¸‰ã‚’è±¡å¾´ã™ã‚‹ä¸»å°†" }
        ]
    };

    // 3. teamRecords ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ³¨å…¥
    for (const [teamName, players] of Object.entries(legendaryPlayers)) {
        DETAILED_TEAM_DATA[teamName] = {
            summary: TEAM_DATA[teamName].info,
            players: players.map(p => ({ name: p.name, year: p.year, position: p.position, desc: p.desc }))
        };

        if (!tournamentState.teamRecords[teamName]) {
            tournamentState.teamRecords[teamName] = {
                playerStats: { batting: {}, pitching: {} },
                tournamentStats: { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0, sb: 0, r: 0, so: 0 }
            };
        }
        
        players.forEach(p => {
            const record = tournamentState.teamRecords[teamName];
            if (p.position === "æŠ•æ‰‹") {
                const ip = 40.0;
                const er = Math.round((p.stats.era * ip) / 9);
                record.playerStats.pitching[p.name] = {
                    career: { ip: ip, w: p.stats.w, l: 0, er: er, so: p.stats.so, h: 20, bb: 10 },
                    narrative_flag: 'peak'
                };
            } else {
                const ab = 25;
                const h = Math.round(ab * p.stats.avg);
                record.playerStats.batting[p.name] = {
                    ab: ab, h: h, hr: p.stats.hr, rbi: p.stats.rbi, sb: p.stats.sb,
                    narrative_flag: 'peak'
                };
            }
        });
    }
}

/**
 * [ä¿®æ­£ç‰ˆ] ç”²å­åœ’é–‹å¹•ç‰¹åˆ¥ä¼ç”»ï¼šå¤§ä¼šæ³¨ç›®é¸æ‰‹10é¸ã®è¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…å‚åŠ ãƒãƒ¼ãƒ ã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹ã‚ˆã†ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¿½åŠ )
 */
async function generateTopPlayersArticle() {
    const allPlayers = [];

    // â˜… 1. ç¾åœ¨ã®å¤§ä¼šã«å‚åŠ ã—ã¦ã„ã‚‹ãƒãƒ¼ãƒ ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
    // (ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã€tournamentState.teams ã«ã¯å‡ºå ´64æ ¡ãŒå…¥ã£ã¦ã„ã‚‹ã¯ãš)
    const participatingTeams = new Set(tournamentState.teams);

    // 2. å…¨ãƒãƒ¼ãƒ è¨˜éŒ²ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ãŒã€å‚åŠ ãƒãƒ¼ãƒ ã®ã¿å‡¦ç†ã™ã‚‹
    Object.keys(tournamentState.teamRecords).forEach(teamName => {
        // â˜… ã“ã“ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼šä¸å‚åŠ ãƒãƒ¼ãƒ ã¨BYEã¯é™¤å¤–
        if (!participatingTeams.has(teamName) || teamName === '(BYE)') return;

        const record = tournamentState.teamRecords[teamName];
        if (!record.playerStats) return;

        // æ‰“è€…
        if (record.playerStats.batting) {
            Object.entries(record.playerStats.batting).forEach(([name, stats]) => {
                // äºˆé¸æˆç¸¾ (prefecturalStatsãŒã‚ã‚‹å ´åˆã¯ãã¡ã‚‰ã‚’å„ªå…ˆã—ãŸã„ãŒã€
                // å€‹äººæˆç¸¾ã¯playerStatsã«é€šç®—ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãã‚Œã‚’ä½¿ç”¨)
                if (stats.ab >= 10) { // è¦å®šæ‰“å¸­(ä»®)
                    const avg = stats.h / stats.ab;
                    // è©•ä¾¡ã‚¹ã‚³ã‚¢ (æ‰“ç‡ + HRé‡è¦–)
                    const score = (avg * 100) + (stats.hr * 5) + (stats.rbi * 2) + (stats.sb * 1);
                    allPlayers.push({
                        name: name, team: teamName, type: 'batter',
                        value: score,
                        desc: `æ‰“ç‡${avg.toFixed(3)} ${stats.hr}æœ¬ ${stats.rbi}æ‰“ç‚¹`
                    });
                }
            });
        }
        // æŠ•æ‰‹
        if (record.playerStats.pitching) {
            Object.entries(record.playerStats.pitching).forEach(([name, stats]) => {
                const s = stats.career;
                if (s.ip >= 15) { // è¦å®šæŠ•çƒå›(ä»®)
                    const era = (s.er * 9) / s.ip;
                    // è©•ä¾¡ã‚¹ã‚³ã‚¢ (é˜²å¾¡ç‡ãŒä½ã„ã»ã©é«˜å¾—ç‚¹ + å¥ªä¸‰æŒ¯)
                    const score = (10 - era) * 10 + (s.so * 2) + (s.w * 5);
                    allPlayers.push({
                        name: name, team: teamName, type: 'pitcher',
                        value: score,
                        desc: `é˜²å¾¡ç‡${era.toFixed(2)} ${s.w}å‹ ${s.so}å¥ªä¸‰æŒ¯`
                    });
                }
            });
        }
    });

    // 3. ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ãƒˆãƒƒãƒ—10ã‚’æŠ½å‡º
    const top10 = allPlayers.sort((a, b) => b.value - a.value).slice(0, 10);

    // 4. è¨˜äº‹ç”Ÿæˆ
    if (top10.length === 0) return null;

    const rankingText = top10.map((p, i) => 
        `${i + 1}ä½: ${p.name} (${p.team}) - ${p.desc}`
    ).join('\n');

    const prompt = `ã‚ãªãŸã¯ã‚¹ãƒãƒ¼ãƒ„é›‘èªŒã€ŒNumberã€ã®è¨˜è€…ã§ã™ã€‚
ã¾ã‚‚ãªãé–‹å¹•ã™ã‚‹å¤ã®ç”²å­åœ’ã«å‘ã‘ã¦ã€ã€Œå¤§ä¼šæ³¨ç›®ã®ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼10é¸ã€ã¨ã„ã†ç‰¹é›†è¨˜äº‹ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®ãƒªã‚¹ãƒˆã¯ã€å„éƒ½é“åºœçœŒäºˆé¸ã§åœ§å€’çš„ãªæˆç¸¾ã‚’æ®‹ã—ãŸãƒˆãƒƒãƒ—10é¸æ‰‹ã§ã™ã€‚

### æ³¨ç›®é¸æ‰‹ãƒ©ãƒ³ã‚­ãƒ³ã‚° (äºˆé¸æˆç¸¾ã«åŸºã¥ã)
${rankingText}

### åŸ·ç­†æŒ‡ç¤º
- ã‚¿ã‚¤ãƒˆãƒ«ã¯ã€Œã€ç”²å­åœ’é–‹å¹•ã€‘ã‚¹ã‚«ã‚¦ãƒˆã‚‚ç†±è¦–ç·šï¼ ä»Šå¤§ä¼šã®"BIG10"ã‚’ä¸€æŒ™ç´¹ä»‹ã€ã®ã‚ˆã†ãªãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ã‚‚ã®ã«ã€‚
- 1ä½ã‹ã‚‰é †ã«ã€é¸æ‰‹ã‚’ç´¹ä»‹ã—ã¦ãã ã•ã„ã€‚
- **ã‚ãªãŸã®ãƒãƒ¼ãƒ ï¼ˆ${tournamentState.teams[0]}ï¼‰ã®é¸æ‰‹ãŒãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆã¯ã€ç‰¹ã«ç†±ãã€ã€Œåœ°å…ƒã®æœŸå¾…ã®æ˜Ÿã€ã¨ã—ã¦ç´¹ä»‹ã—ã¦ãã ã•ã„ã€‚**
- å¤§é˜ªæ¡è”­ã‚„èŠ±å·»æ±ãªã©ã®æœ‰åé¸æ‰‹ã«ã¤ã„ã¦ã¯ã€ã€Œä¸–ä»£æœ€å¼·ã€ã€Œæ€ªç‰©ã®å†æ¥ã€ã¨ã„ã£ãŸç•°åã‚’ã¤ã‘ã¦ç››ã‚Šä¸Šã’ã¦ãã ã•ã„ã€‚
- äºˆé¸ã®æˆç¸¾ãƒ‡ãƒ¼ã‚¿(${rankingText})ã‚’å¿…ãšå¼•ç”¨ã—ã¦ã€å‡„ã¿ã‚’ä¼ãˆã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼ (JSON)
{"title": "è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«", "body": "è¨˜äº‹æœ¬æ–‡"}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (article) {
                return { 
                    ...article, 
                    timestamp: Date.now(),
                    context: { isFeatureArticle: true }
                };
            }
        }
        return null;
    } catch (error) {
        console.error("æ³¨ç›®é¸æ‰‹è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
        return null;
    }
}

/**
 * [FIXED] ãƒ€ãƒŸãƒ¼ãƒãƒ¼ãƒ ã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…å…¨ãƒãƒ¼ãƒ Aãƒ©ãƒ³ã‚¯ã«ãªã‚‹ã‚ˆã†åå·®å€¤ã‚’80ã«è¨­å®š)
 */
function generateDummyTeams(count, excludeNames) {
    const prefixes = ["åŒ—æµ·", "ä»™å°", "å‰æ©‹", "æ™ºå¼", "åºƒå³¶", "ç¦å²¡", "é¹¿å…å³¶", "æ²–ç¸„", "äº¬éƒ½", "æ„›å·¥å¤§", "å¤©ç†", "æ˜Ÿç¨œ", "æ˜å¾³", "åºƒé™µ", "ä½œæ–°", "é–¢æ±"];
    const suffixes = ["å­¦åœ’", "å®Ÿæ¥­", "å¤§ä»˜å±", "å•†æ¥­", "å·¥æ¥­", "å­¦é™¢", "ç¬¬ä¸€"];
    const dummies = [];
    let attempts = 0;
    
    // 1. ãƒ©ãƒ³ãƒ€ãƒ ãªåå‰ã§ç”Ÿæˆ
    while (dummies.length < count && attempts < 1000) {
        const name = prefixes[Math.floor(Math.random() * prefixes.length)] + suffixes[Math.floor(Math.random() * suffixes.length)];
        if (!excludeNames.includes(name) && !dummies.includes(name) && !TEAM_DATA[name]) {
            dummies.push(name);
            TEAM_DATA[name] = { 
                name_yomi: "ã ã¿ãƒ¼", region: "å…¨å›½", type: "ç§ç«‹", deviation: 80, // â˜…åå·®å€¤80
                best: "ç”²å­åœ’å‡ºå ´", last: "äºˆé¸çªç ´", 
                info: "å„éƒ½é“åºœçœŒã®ä»£è¡¨æ ¡ã€‚éå¸¸ã«å¼·åŠ›ãªæˆ¦åŠ›ã‚’æœ‰ã™ã‚‹ã€‚", 
                coach: { name: "ãƒ¢ãƒ–ç›£ç£", style: "å …å®Ÿ", experience: "ä¸­å …" } 
            };
        }
        attempts++;
    }
    
    // 2. è¶³ã‚Šãªã„åˆ†ã‚’é€£ç•ªã§åŸ‹ã‚ã‚‹
    while (dummies.length < count) {
        const name = `ä»£è¡¨é«˜æ ¡${dummies.length + 1}`;
        if (!dummies.includes(name)) {
            dummies.push(name);
            TEAM_DATA[name] = { 
                name_yomi: "ã ã„ã²ã‚‡ã†ã“ã†", region: "å…¨å›½", type: "å…¬ç«‹", deviation: 80, // â˜…åå·®å€¤80
                best: "ç”²å­åœ’å‡ºå ´", last: "äºˆé¸çªç ´",
                info: "å„éƒ½é“åºœçœŒã®ä»£è¡¨æ ¡ã€‚", 
                coach: { name: "ç›£ç£", style: "æ™®é€š", experience: "ä¸­å …" } 
            };
        }
    }
    return dummies;
}
/**
 * [NEW] ç”²å­åœ’ç”¨ï¼šåœ°å…ƒç´™é¢¨ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…çœŒå¤§ä¼šåŒæ§˜ã®ãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ³¨å…¥)
 * (â˜…â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å†ç”ŸæˆæŒ‡ç¤º(userFeedback)ã«å¯¾å¿œ â˜…â˜…)
 */
async function generateKoshienNewsArticle(matchContext, userFeedback = null) {
    const {
        winnerName, loserName, dbMatch, matchId,
        winnerData, loserData, winnerDetailedData, loserDetailedData,
        winnerLineupChanges, loserLineupChanges,
        winnerJourney, loserJourney,
        nextOpponent, nextOpponentJourney, 
        pitcherGamelogInfo, batterGamelogInfo,
        injuryReport, playerStatsText, highlights,
        prefecturalStatsText // â˜…è¿½åŠ 
    } = matchContext;

    const myTeam = tournamentState.teams[0]; 
    const isWin = (winnerName === myTeam);
    const opponentName = isWin ? loserName : winnerName;
    const score = `${dbMatch.score1}-${dbMatch.score2}`;
    const roundName = getRoundNameFromMatchId(matchId);
    
    // ãƒ‡ãƒ¼ã‚¿æ•´å½¢
    const winnerRecord = tournamentState.teamRecords[winnerName];
    const loserRecord = tournamentState.teamRecords[loserName];
    const winnerDynamicInfo = generateDynamicTeamInfo(winnerName, winnerData, winnerRecord);
    const loserDynamicInfo = generateDynamicTeamInfo(loserName, loserData, loserRecord);
    const highlightsText = highlights.map(fact => `- ${fact.inning || ''}å› ${fact.team || ''} ${fact.player || ''}: ${fact.description}`).join('\n');
    const lineupChangesText = `- ${winnerName}: ${winnerLineupChanges}\n- ${loserName}: ${loserLineupChanges}`;
    const calledGameText = matchContext.calledGame ? `\n- **ç‰¹è¨˜äº‹é …:** ${matchContext.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ` : '';
    const rivalryText = matchContext.rivalryType ? `\n- **ç‰¹è¨˜äº‹é …:** ã“ã®è©¦åˆã¯ã€Œ${matchContext.rivalryType}ã€ã¨ã„ã†å› ç¸ã®å¯¾æ±ºã§ã—ãŸã€‚` : '';

    let scheduleText = '';
    if (matchContext.schedule) {
        const sched = matchContext.schedule;
        scheduleText = `\n- **è©¦åˆä¼šå ´:** ${sched.stadiumFull} (è–åœ°ãƒ»ç”²å­åœ’)\n`;
    }
    
    let atmosphereText = '';
    if (matchContext.atmosphere_team1 || matchContext.atmosphere_team2) {
        atmosphereText = '\n### ãƒ‡ãƒ¼ã‚¿5ï¼šè©¦åˆå‰ã®é›°å›²æ°—ãƒ»å…¬ç´„\n';
        if (matchContext.atmosphere_team1) atmosphereText += `- ${dbMatch.team1}: ${matchContext.atmosphere_team1}\n`;
        if (matchContext.atmosphere_team2) atmosphereText += `- ${dbMatch.team2}: ${matchContext.atmosphere_team2}\n`;
    }

    let ballQualityText = '';
    if (matchContext.team1BallQuality && matchContext.team2BallQuality) {
        ballQualityText = `\n### ãƒ‡ãƒ¼ã‚¿4ï¼šãƒãƒ¼ãƒ åˆ¥ æ‰“çƒå“è³ªãƒ¬ãƒãƒ¼ãƒˆ\n- ${matchContext.team1BallQuality}\n- ${matchContext.team2BallQuality}\n`;
    }

    // æ¬¡æˆ¦æƒ…å ±
    let nextOpponentText = 'æ¬¡æˆ¦ã®ç›¸æ‰‹ã¯æœªå®šã§ã™ã€‚';
    let nextOpponentJourneyText = '';
    if (nextOpponent) {
        if (nextOpponent.opponentName === 'å„ªå‹') {
            nextOpponentText = 'æ‚²é¡˜ã®å…¨å›½åˆ¶è¦‡ã‚’æˆã—é‚ã’ã¾ã—ãŸï¼';
        } else if (nextOpponent.opponentName && nextOpponent.opponentName !== 'ï¼ˆæœªå®šï¼‰') {
            nextOpponentText = `æ¬¡æˆ¦ã¯${nextOpponent.roundName}ã€å¼·è±ªãƒ»${nextOpponent.opponentName}ã¨å¯¾æˆ¦ã—ã¾ã™ã€‚`;
            if (matchContext.nextOpponentJourney) {
                 nextOpponentJourneyText = `(ç›¸æ‰‹ã®è»Œè·¡: ${matchContext.nextOpponentJourney})`;
            }
        }
    }

    // â˜…â˜…â˜… ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æŒ‡ç¤ºã®æ§‹ç¯‰ â˜…â˜…â˜…
    let feedbackPrompt = '';
    if (userFeedback) {
        if (userFeedback.include) feedbackPrompt += `\n- **ã€ãƒ‡ã‚¹ã‚¯ã‹ã‚‰ã®è¿½åŠ æŒ‡ç¤º(å¿…é ˆ)ã€‘**: ${userFeedback.include}`;
        if (userFeedback.exclude) feedbackPrompt += `\n- **ã€ãƒ‡ã‚¹ã‚¯ã‹ã‚‰ã®ç¦æ­¢äº‹é …ã€‘**: ${userFeedback.exclude}`;
    }
    // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

    const prompt = `ã‚ãªãŸã¯ã€Œé™å²¡æ–°èã€ã®ã‚¹ãƒãƒ¼ãƒ„æ‹…å½“è¨˜è€…ã§ã™ã€‚
éƒ·åœŸã®ä»£è¡¨ã€Œ${myTeam}ã€ã®ç”²å­åœ’ã§ã®è©¦åˆè¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚
**å…¨å›½ç´™ã®ã‚ˆã†ãªä¸­ç«‹ãªè¦–ç‚¹ã§ã¯ãªãã€é™å²¡çœŒæ°‘ã®è¦–ç‚¹ã«ç«‹ã¡ã€è©³ç´°ãªãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦é¸æ‰‹ãŸã¡ã‚’ç§°ãˆã‚‹æ¸©ã‹ã„è¨˜äº‹**ã«ã—ã¦ãã ã•ã„ã€‚

### è©¦åˆæƒ…å ±
- ãƒ©ã‚¦ãƒ³ãƒ‰: ${roundName}
- çµæœ: ${myTeam}ã®${isWin ? 'å‹åˆ©' : 'æ•—åŒ—'} (${score})
- å¯¾æˆ¦ç›¸æ‰‹: ${opponentName}
${injuryReport || ''}

### è©¦åˆã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ (ã‚ãªãŸã®å–æãƒ¡ãƒ¢)
- **è©¦åˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ**:
${highlightsText}
- **å€‹äººæˆç¸¾ (ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢)**:
${playerStatsText}
- **çœŒå¤§ä¼š(äºˆé¸)ã®æˆç¸¾**:
${prefecturalStatsText || 'æƒ…å ±ãªã—'}
- **ãƒãƒ¼ãƒ çŠ¶æ³**:
  - ${winnerName}: ${winnerDynamicInfo}
  - ${loserName}: ${loserDynamicInfo}
- **ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´**:
${lineupChangesText}
- **ã“ã‚Œã¾ã§ã®æ´»èº (Gamelog)**:
${pitcherGamelogInfo}
${batterGamelogInfo}
${ballQualityText}
${atmosphereText}
${scheduleText}

### åŸ·ç­†æŒ‡ç¤º
1.  **ã‚¿ã‚¤ãƒˆãƒ«**: ã€Œã‚„ã£ãŸã${myTeam}ï¼ã€ã€Œå¤¢ã‚’ã‚ã‚ŠãŒã¨ã†${myTeam}ã€ã®ã‚ˆã†ã«æ„Ÿæƒ…ã‚’è¾¼ã‚ã¤ã¤ã€è©¦åˆã®æ±ºå®šçš„ãªå ´é¢ï¼ˆã‚µãƒ¨ãƒŠãƒ©ã€å®Œå°ãªã©ï¼‰ã‚‚å«ã‚ã¦ãã ã•ã„ã€‚
2.  **æœ¬æ–‡**:
    - **ã€Œè©³ç´°ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆã€å€‹äººæˆç¸¾ã€Gamelogï¼‰ã€**ã«åŸºã¥ã„ã¦ã€è©¦åˆçµŒéã‚’å…·ä½“çš„ã«æå†™ã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€Œã€‡å›ã€â–³â–³ãã‚“ã®ï¼ˆâ˜…æ³¨ç›®ï¼‰å‹ã¡è¶Šã—ã‚¿ã‚¤ãƒ ãƒªãƒ¼ã§...ã€ã€Œã‚¨ãƒ¼ã‚¹â–¡â–¡ãã‚“ãŒGamelogé€šã‚Šã®ç²˜ã‚Šã®æŠ•çƒã§...ã€ï¼‰
    - æ´»èºã—ãŸé¸æ‰‹ã‚’å…·ä½“åã§æŒ™ã’ã€ãã®ãƒ—ãƒ¬ãƒ¼ã‚’æœ€å¤§é™ã«ç§°è³›ã—ã¦ãã ã•ã„ã€‚
    - **ã€æ¯”è¼ƒåˆ†æã€‘**: çœŒå¤§ä¼šã®æˆç¸¾(${prefecturalStatsText})ã‚„éå»ã®Gamelogã¨æ¯”è¼ƒã—ã€ã€ŒçœŒå¤§ä¼šã‹ã‚‰å¥½èª¿ã‚’ç¶­æŒã€ã€Œäºˆé¸ã§è‹¦ã—ã‚“ã ã‚¨ãƒ¼ã‚¹ãŒç”²å­åœ’ã§è¦šé†’ã€ã¨ã„ã£ãŸåˆ†æã‚’åŠ ãˆã¦ãã ã•ã„ã€‚
    - ã‚‚ã—ã€Œæ•…éšœè€…ãƒªã‚¹ãƒˆã€(${injuryReport})ã«è¨˜è¼‰ã®ã‚ã‚‹é¸æ‰‹ãŒã„ã‚Œã°ã€ã€Œï¼ˆä¸»åŠ›ï¼‰ã€‡ã€‡ãã‚“ã®ä¸åœ¨ã‚’æ„Ÿã˜ã•ã›ãªã„æˆ¦ã„ã ã£ãŸã€ã€Œæº€èº«å‰µç—ã®ä¸­ã§ã‚ˆãæˆ¦ã£ãŸã€ã¨ã€ãã®é¸æ‰‹ã®é‡è¦åº¦ã‚‚è€ƒæ…®ã—ã¦åŠ´ã£ã¦ãã ã•ã„ã€‚
    - **å‹åˆ©æ™‚**: ã€ŒçœŒå‹¢ã€‡ã€‡å¹´ã¶ã‚Šã®å¿«æŒ™ã€ã€Œæ¬¡æˆ¦ã®${nextOpponentText}ã‚‚ã“ã®å‹¢ã„ã§ã€ã¨ç››ã‚Šä¸Šã’ã¦ãã ã•ã„ã€‚
    - **æ•—æˆ¦æ™‚**: ã€Œèƒ¸ã‚’å¼µã£ã¦é™å²¡ã«å¸°ã£ã¦ãã¦ã»ã—ã„ã€ã€Œã“ã®å¤ã€ç§ãŸã¡ã«å¤¢ã‚’è¦‹ã›ã¦ãã‚ŒãŸã€ã¨æ„Ÿè¬ã§ç· ã‚ããã£ã¦ãã ã•ã„ã€‚
    - æœ€å¾Œã«ã€æ¬¡ã®å¯¾æˆ¦ç›¸æ‰‹ï¼ˆ${nextOpponentText}ï¼‰ã«è§¦ã‚Œã¦ãã ã•ã„ã€‚
${feedbackPrompt}

### å‡ºåŠ›å½¢å¼ (JSON)
{"title": "è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«", "body": "è¨˜äº‹æœ¬æ–‡"}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (article) {
                article.body += "\n\nã€€ï¼ˆé™å²¡æ–°è ç‰¹è¨­å–æç­ï¼‰";
                return { 
                    ...article, 
                    timestamp: Date.now(), 
                    context: matchContext,
                    isKoshienNews: true // ãƒ•ãƒ©ã‚°ç¶­æŒ
                };
            }
        }
        return null;
    } catch (error) {
        console.error("ç”²å­åœ’è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
        return null;
    }
}

/**
 * [NEW] ç”²å­åœ’ç”¨ï¼šçœŒæ°‘å¿œæ´æ²ç¤ºæ¿ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…çœŒå¤§ä¼šåŒæ§˜ã®ãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ³¨å…¥)
 */
async function generateKoshienBbsComments(matchContext) {
    const { 
        winnerName, loserName, dbMatch, matchId, injuryReport,
        playerStatsText, highlights, pitcherGamelogInfo, batterGamelogInfo,
        nextOpponent, nextOpponentJourney,
        winnerLineupChanges, loserLineupChanges,
        winnerData, loserData, winnerDetailedData, loserDetailedData,
        winnerJourney, loserJourney,
        hadaReportSummary, prefecturalStatsText // â˜…è¿½åŠ 
    } = matchContext;

    const myTeam = tournamentState.teams[0]; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒãƒ¼ãƒ (çœŒä»£è¡¨)
    const isWin = (winnerName === myTeam);
    const opponentName = isWin ? loserName : winnerName;
    const score = `${dbMatch.score1}-${dbMatch.score2}`;
    const roundName = getRoundNameFromMatchId(matchId);

    // --- è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ ---
    const tournamentYear = tournamentState.tournamentYear;
    const tournamentName = "å…¨å›½é«˜ç­‰å­¦æ ¡é‡çƒé¸æ‰‹æ¨©å¤§ä¼š";
    const winnerRank = calculateRank(winnerName, tournamentState);
    const loserRank = calculateRank(loserName, tournamentState);
    const winnerSeedRank = ""; 
    const loserSeedRank = "";
    
    const winnerRecord = tournamentState.teamRecords[winnerName];
    const loserRecord = tournamentState.teamRecords[loserName];
    const winnerDynamicInfo = generateDynamicTeamInfo(winnerName, winnerData, winnerRecord);
    const loserDynamicInfo = generateDynamicTeamInfo(loserName, loserData, loserRecord);
    
    const highlightsText = highlights.map(fact => `- ${fact.inning || ''}å› ${fact.team || ''} ${fact.player || ''}: ${fact.description}`).join('\n');
    const lineupChangesText = `- ${winnerName}: ${winnerLineupChanges}\n- ${loserName}: ${loserLineupChanges}`;
    const calledGameText = matchContext.calledGame ? `\n- **ç‰¹è¨˜äº‹é …:** ${matchContext.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ` : '';
    const rivalryText = matchContext.rivalryType ? `\n- **ç‰¹è¨˜äº‹é …:** ã“ã®è©¦åˆã¯ã€Œ${matchContext.rivalryType}ã€ã¨ã„ã†å› ç¸ã®å¯¾æ±ºã§ã—ãŸã€‚` : '';
    
    let scheduleText = '';
    if (matchContext.schedule) {
        const sched = matchContext.schedule;
        scheduleText = `\n- **è©¦åˆä¼šå ´:** ${sched.stadiumFull}\n`;
    }
    
    let atmosphereText = '';
    if (matchContext.atmosphere_team1 || matchContext.atmosphere_team2) {
        atmosphereText = '\n### ãƒ‡ãƒ¼ã‚¿6ï¼šè©¦åˆå‰ã®é›°å›²æ°—ãƒ»å…¬ç´„\n';
        if (matchContext.atmosphere_team1) atmosphereText += `- ${dbMatch.team1}: ${matchContext.atmosphere_team1}\n`;
        if (matchContext.atmosphere_team2) atmosphereText += `- ${dbMatch.team2}: ${matchContext.atmosphere_team2}\n`;
    }

    let ballQualityText = '';
    if (matchContext.team1BallQuality && matchContext.team2BallQuality) {
        ballQualityText = `\n### ãƒ‡ãƒ¼ã‚¿4ï¼šãƒãƒ¼ãƒ åˆ¥ æ‰“çƒå“è³ªãƒ¬ãƒãƒ¼ãƒˆ\n- ${matchContext.team1BallQuality}\n- ${matchContext.team2BallQuality}\n`;
    }

    // æ¬¡æˆ¦æƒ…å ±
    let nextOpponentText = 'æ¬¡æˆ¦ã®ç›¸æ‰‹ã¯æœªå®šã§ã™ã€‚';
    let nextOpponentJourneyText = '';
    if (nextOpponent) {
        if (nextOpponent.opponentName === 'å„ªå‹') {
            nextOpponentText = 'æ‚²é¡˜ã®å…¨å›½åˆ¶è¦‡ã‚’æˆã—é‚ã’ã¾ã—ãŸï¼';
        } else if (nextOpponent.opponentName && nextOpponent.opponentName !== 'ï¼ˆæœªå®šï¼‰') {
            nextOpponentText = `æ¬¡æˆ¦ã¯${nextOpponent.roundName}ã€å¼·è±ªãƒ»${nextOpponent.opponentName}ã¨å¯¾æˆ¦ã—ã¾ã™ã€‚`;
            if (matchContext.nextOpponentJourney) {
                 nextOpponentJourneyText = `(ç›¸æ‰‹ã®è»Œè·¡: ${matchContext.nextOpponentJourney})`;
            }
        }
    }

    const hadaReportText = hadaReportSummary ? `\n### ãƒ‡ãƒ¼ã‚¿6ï¼šè¨˜è€…ã®è¦–ç‚¹\n${hadaReportSummary}\n` : '';

    const prompt = `ã‚ãªãŸã¯ã€é™å²¡çœŒä»£è¡¨ã€Œ${myTeam}ã€ã‚’å¿œæ´ã™ã‚‹åœ°å…ƒã®ãƒ•ã‚¡ãƒ³ãŸã¡ãŒé›†ã¾ã‚‹æ²ç¤ºæ¿ã®ä½äººã§ã™ã€‚
ç”²å­åœ’ ${roundName}ã€${opponentName}æˆ¦ã®çµæœã«ã¤ã„ã¦ã€**æä¾›ã•ã‚ŒãŸè©³ç´°ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã**ã€æ¸©ã‹ãç†±ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’20å€‹ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### ç¾åœ¨ã®è©¦åˆçŠ¶æ³
- **å¤§ä¼š:** ${tournamentYear}å¹´åº¦ ${tournamentName}
- **æ–‡è„ˆ:** åœ°å…ƒã®èª‡ã‚Šã€çœŒä»£è¡¨ã‚’å…¨åŠ›å¿œæ´
- **ãƒ©ã‚¦ãƒ³ãƒ‰:** ${roundName}
${scheduleText}

### ãƒ‡ãƒ¼ã‚¿1ï¼šè©¦åˆçµæœ
- **å‹åˆ©:** ${winnerName} ${winnerSeedRank} (ãƒ©ãƒ³ã‚¯: ${winnerRank})
- **æ•—åŒ—:** ${loserName} ${loserSeedRank} (ãƒ©ãƒ³ã‚¯: ${loserRank})
- **ã‚¹ã‚³ã‚¢:** ${score}
- **ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´:**
${lineupChangesText}
${calledGameText}
${rivalryText}
${injuryReport || ''}

### ãƒ‡ãƒ¼ã‚¿2ï¼šãƒãƒ¼ãƒ ã®èƒŒæ™¯
- **${winnerName}**: ${winnerDynamicInfo}
  - **è»Œè·¡**: ${winnerJourney}
- **${loserName}**: ${loserDynamicInfo}
  - **è»Œè·¡**: ${loserJourney}

### ãƒ‡ãƒ¼ã‚¿3ï¼šã“ã®è©¦åˆã®å€‹äººæˆç¸¾ (æœ€çµ‚çµæœã®è¦ç´„)
${playerStatsText || 'å€‹äººæˆç¸¾ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}
- **çœŒå¤§ä¼š(äºˆé¸)ã®æˆç¸¾**:
${prefecturalStatsText || 'æƒ…å ±ãªã—'}

### ãƒ‡ãƒ¼ã‚¿4ï¼šè©¦åˆã®ä¸»ãªå‡ºæ¥äº‹ (ãƒã‚¤ãƒ©ã‚¤ãƒˆ)
${highlightsText}
${ballQualityText}

### ãƒ‡ãƒ¼ã‚¿5ï¼šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆå…¨ä½“ã®çŠ¶æ³
- **æ¬¡ã®è©¦åˆ**: ${nextOpponentText} ${nextOpponentJourneyText}
${atmosphereText}
${hadaReportText}

### ãƒ‡ãƒ¼ã‚¿6ï¼šä»Šå¤§ä¼šã®ä¸»ãªæŠ•æ‰‹ç™»æ¿å±¥æ­´ (ã“ã®è©¦åˆã‚ˆã‚Šå‰)
${pitcherGamelogInfo || 'ä»Šå¤§ä¼šã€ã“ã‚ŒãŒåˆç™»æ¿ã§ã™ã€‚'}

### ãƒ‡ãƒ¼ã‚¿7ï¼šä»Šå¤§ä¼šã®ä¸»ãªæ‰“è€…æˆç¸¾å±¥æ­´ (ã“ã®è©¦åˆã‚ˆã‚Šå‰)
${batterGamelogInfo || 'æ‰“è€…ã®è©¦åˆå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}

### ã‚ãªãŸãŒæ¼”ã˜ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ (ã‚¢ãƒ³ãƒã¯ã„ã¾ã›ã‚“)
- **åœ°å…ƒã®ãŠã£ã¡ã‚ƒã‚“**: ãƒ—ãƒ¬ãƒ¼å†…å®¹ã‚’å…·ä½“çš„ã«è¤’ã‚ã‚‹ã€‚ã€Œã€‡ã€‡ã®ã‚ã®ï¼ˆâ˜…æ³¨ç›®ï¼‰ãƒ’ãƒƒãƒˆãŒå¤§ãã‹ã£ãŸãªï¼ã€
- **OB/OG**: å¾Œè¼©ãŸã¡ã®æ´»èºã«æ¶™ã™ã‚‹ã€‚ã€Œä¿ºãŸã¡ã®æ™‚ã¨ã¯æ¯”ã¹ç‰©ã«ãªã‚‰ã‚“...ã€
- **ãƒ‡ãƒ¼ã‚¿å¥½ãã®ãƒ•ã‚¡ãƒ³**: ã€Œä»Šæ—¥ã®ã€‡ã€‡ã¯æ‰“ç‡5å‰²è¶…ãˆã¦ã‚‹ãã€ã€ŒçœŒå¤§ä¼šã®æˆç¸¾ã‚ˆã‚Šã•ã‚‰ã«é€²åŒ–ã—ã¦ã‚‹ãªã€
- **å¿ƒé…æ€§ãªãƒ•ã‚¡ãƒ³**: æ€ªæˆ‘äºº(${injuryReport})ã‚’æ°—é£ã†ã€‚ã€Œã€‡ã€‡ãã‚“(ä¸»åŠ›)ãŒ[ğŸ¥]ã§ã„ãªã„ã®ã«å‹ã¤ãªã‚“ã¦ï¼ã€ã€Œâ–³â–³ãã‚“(æ§ãˆ)[ğŸ©¹]ã€ç„¡ç†ã—ãªã„ã§ã€

### æŒ‡ç¤º
- **èª¹è¬—ä¸­å‚·ã€ç…½ã‚Šã€ã€Œæˆ¦çŠ¯ã€ãªã©ã®è¨€è‘‰ã¯ç¦æ­¢ã§ã™ã€‚**
- **ã€Œè©³ç´°ãƒ‡ãƒ¼ã‚¿ã€**ã«ã‚ã‚‹å…·ä½“çš„ãªãƒ—ãƒ¬ãƒ¼ï¼ˆç‰¹ã«ã€Œâ˜…æ³¨ç›®ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆã€å€‹äººæˆç¸¾ã€Gamelogï¼‰ã«è¨€åŠã—ã¦ãã ã•ã„ã€‚
- **çœŒå¤§ä¼šã®æˆç¸¾ã¨æ¯”è¼ƒ**ã—ã¦ã€ãƒãƒ¼ãƒ ã‚„é¸æ‰‹ã®æˆé•·ï¼ˆã¾ãŸã¯ä¸èª¿ï¼‰ã«è¨€åŠã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¿…ãš1ã¤ä»¥ä¸Šå…¥ã‚Œã¦ãã ã•ã„ã€‚
- è² ã‘ãŸå ´åˆã§ã‚‚ã€ã€Œã‚ˆãé ‘å¼µã£ãŸã€ã€Œèƒ¸ã‚’å¼µã£ã¦å¸°ã£ã¦ã“ã„ã€ã¨é¸æ‰‹ã‚’åŠ´ã£ã¦ãã ã•ã„ã€‚
- å‹ã£ãŸå ´åˆã¯ã€æ‰‹æ”¾ã—ã§ç§°è³›ã—ã€æ¬¡æˆ¦ã¸ã®æœŸå¾…ã‚’èªã£ã¦ãã ã•ã„ã€‚
- **${injuryReport}** ã«è¨˜è¼‰ã®ã‚ã‚‹é¸æ‰‹ï¼ˆç‰¹ã«ä¸»åŠ›ã‹æ§ãˆã‹ï¼‰ã‚’è¦‹ã¦ã€ãã®å½±éŸ¿ã‚„å¾©å¸°ã‚’é¡˜ã†ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼ (JSONé…åˆ—)
[
  {"personality": "åœ°å…ƒã®ãŠã£ã¡ã‚ƒã‚“", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰"},
  {"personality": "283å­¦åœ’OB", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰"},
  {"personality": "é™å²¡çœŒæ°‘", "comment": "ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰"}
]`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const commentsJson = parseJsonFromText(rawText);
            if (Array.isArray(commentsJson)) {
                return commentsJson.map((c, index) => ({
                    id: crypto.randomUUID(),
                    personality: c.personality,
                    text: c.comment,
                    timestamp: Date.now() + index * 10,
                    replies: []
                }));
            }
        }
        return [];
    } catch (error) {
        console.error("ç”²å­åœ’BBSç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
        return [];
    }
}

/**
 * [NEW] ç”²å­åœ’ç”¨ï¼šã¾ã¨ã‚ã‚µã‚¤ãƒˆé¢¨ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…çœŒå¤§ä¼šåŒæ§˜ã®ãƒ•ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ³¨å…¥ã—ã€åœ§å€’çš„ãªæƒ…å ±é‡ã‚’æŒãŸã›ã‚‹)
 */
async function generateKoshienMatomeThread(matchContext) {
    const { 
        winnerName, loserName, dbMatch, matchId, injuryReport,
        playerStatsText, highlights, pitcherGamelogInfo, batterGamelogInfo,
        nextOpponent, nextOpponentJourney,
        winnerLineupChanges, loserLineupChanges,
        winnerData, loserData, winnerDetailedData, loserDetailedData,
        winnerJourney, loserJourney,
        hadaReportSummary, prefecturalStatsText // â˜…è¿½åŠ 
    } = matchContext;

    const myTeam = tournamentState.teams[0]; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒãƒ¼ãƒ 
    const isWin = (winnerName === myTeam);
    const opponentName = isWin ? loserName : winnerName;
    const score = `${dbMatch.score1}-${dbMatch.score2}`;
    const roundName = getRoundNameFromMatchId(matchId);

    // --- è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ ---
    const tournamentYear = tournamentState.tournamentYear;
    const tournamentName = "å…¨å›½é«˜ç­‰å­¦æ ¡é‡çƒé¸æ‰‹æ¨©å¤§ä¼š";
    const winnerRank = calculateRank(winnerName, tournamentState);
    const loserRank = calculateRank(loserName, tournamentState);
    
    const winnerRecord = tournamentState.teamRecords[winnerName];
    const loserRecord = tournamentState.teamRecords[loserName];
    const winnerDynamicInfo = generateDynamicTeamInfo(winnerName, winnerData, winnerRecord);
    const loserDynamicInfo = generateDynamicTeamInfo(loserName, loserData, loserRecord);
    
    const highlightsText = highlights.map(fact => `- ${fact.inning || ''}å›: ${fact.description}`).join('\n');
    const lineupChangesText = `- ${winnerName}: ${winnerLineupChanges}\n- ${loserName}: ${loserLineupChanges}`;
    const calledGameText = matchContext.calledGame ? `\n- **ç‰¹è¨˜äº‹é …:** ${matchContext.calledInning}å›ã‚³ãƒ¼ãƒ«ãƒ‰ã‚²ãƒ¼ãƒ ` : '';
    const rivalryText = matchContext.rivalryType ? `\n- **ç‰¹è¨˜äº‹é …:** ã“ã®è©¦åˆã¯ã€Œ${matchContext.rivalryType}ã€ã¨ã„ã†å› ç¸ã®å¯¾æ±ºã§ã—ãŸã€‚` : '';
    
    let scheduleText = '';
    if (matchContext.schedule) {
        const sched = matchContext.schedule;
        scheduleText = `\n- **è©¦åˆä¼šå ´:** ${sched.stadiumFull}\n`;
    }
    
    let atmosphereText = '';
    if (matchContext.atmosphere_team1 || matchContext.atmosphere_team2) {
        atmosphereText = '\n### ãƒ‡ãƒ¼ã‚¿6ï¼šè©¦åˆå‰ã®é›°å›²æ°—ãƒ»å…¬ç´„\n';
        if (matchContext.atmosphere_team1) atmosphereText += `- ${dbMatch.team1}: ${matchContext.atmosphere_team1}\n`;
        if (matchContext.atmosphere_team2) atmosphereText += `- ${dbMatch.team2}: ${matchContext.atmosphere_team2}\n`;
    }

    let ballQualityText = '';
    if (matchContext.team1BallQuality && matchContext.team2BallQuality) {
        ballQualityText = `\n### ãƒ‡ãƒ¼ã‚¿4ï¼šãƒãƒ¼ãƒ åˆ¥ æ‰“çƒå“è³ªãƒ¬ãƒãƒ¼ãƒˆ\n- ${matchContext.team1BallQuality}\n- ${matchContext.team2BallQuality}\n`;
    }

    // æ¬¡æˆ¦æƒ…å ±
    let nextOpponentText = 'æ¬¡æˆ¦ã®ç›¸æ‰‹ã¯æœªå®š';
    if (nextOpponent) {
        if (nextOpponent.opponentName === 'å„ªå‹') nextOpponentText = 'å…¨å›½åˆ¶è¦‡ï¼';
        else if (nextOpponent.opponentName && nextOpponent.opponentName !== 'ï¼ˆæœªå®šï¼‰') {
            nextOpponentText = `æ¬¡æˆ¦: ${nextOpponent.opponentName}`;
            if (matchContext.nextOpponentJourney) {
                 nextOpponentText += ` (ç›¸æ‰‹ã®è»Œè·¡: ${matchContext.nextOpponentJourney})`;
            }
        }
    }

    const prompt = `ã‚ãªãŸã¯ã€é™å²¡çœŒä»£è¡¨ã€Œ${myTeam}ã€ã‚’å…¨åŠ›ã§å¿œæ´ã™ã‚‹ãƒãƒƒãƒˆæ²ç¤ºæ¿ï¼ˆãªã‚“Jï¼‰ã®ä½æ°‘ã§ã™ã€‚
ç”²å­åœ’ ${roundName}ã€${opponentName}æˆ¦ã®çµæœã‚’å—ã‘ã¦ã€**æä¾›ã•ã‚ŒãŸè†¨å¤§ãªè©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«**ã€å–œã³ï¼ˆã¾ãŸã¯å¥é—˜ã‚’ç§°ãˆã‚‹ï¼‰ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

### ç¾åœ¨ã®è©¦åˆçŠ¶æ³
- **å¤§ä¼š:** ${tournamentYear}å¹´åº¦ ${tournamentName}
- **ãƒ©ã‚¦ãƒ³ãƒ‰:** ${roundName}
${scheduleText}

### ãƒ‡ãƒ¼ã‚¿1ï¼šè©¦åˆçµæœ
- **çµæœ:** ${myTeam}ã®${isWin ? 'å‹åˆ©' : 'æ•—åŒ—'} (${score}) vs ${opponentName}
- **ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´:**
${lineupChangesText}
${calledGameText}
${rivalryText}
${injuryReport || ''}

### ãƒ‡ãƒ¼ã‚¿2ï¼šãƒãƒ¼ãƒ ã®èƒŒæ™¯
- **${winnerName}**: ${winnerDynamicInfo}
  - **è»Œè·¡**: ${winnerJourney}
- **${loserName}**: ${loserDynamicInfo}
  - **è»Œè·¡**: ${loserJourney}

### ãƒ‡ãƒ¼ã‚¿3ï¼šã“ã®è©¦åˆã®å€‹äººæˆç¸¾ (æœ€çµ‚çµæœã®è¦ç´„)
${playerStatsText || 'å€‹äººæˆç¸¾ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}
- **çœŒå¤§ä¼š(äºˆé¸)ã®æˆç¸¾**:
${prefecturalStatsText || 'æƒ…å ±ãªã—'}

### ãƒ‡ãƒ¼ã‚¿4ï¼šè©¦åˆã®ä¸»ãªå‡ºæ¥äº‹ (ãƒã‚¤ãƒ©ã‚¤ãƒˆ)
${highlightsText}
${ballQualityText}

### ãƒ‡ãƒ¼ã‚¿5ï¼šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆå…¨ä½“ã®çŠ¶æ³
- **æ¬¡ã®è©¦åˆ**: ${nextOpponentText}
${atmosphereText}

### ãƒ‡ãƒ¼ã‚¿6ï¼šä»Šå¤§ä¼šã®ä¸»ãªæŠ•æ‰‹ç™»æ¿å±¥æ­´ (ã“ã®è©¦åˆã‚ˆã‚Šå‰)
${pitcherGamelogInfo || 'ä»Šå¤§ä¼šã€ã“ã‚ŒãŒåˆç™»æ¿ã§ã™ã€‚'}

### ãƒ‡ãƒ¼ã‚¿7ï¼šä»Šå¤§ä¼šã®ä¸»ãªæ‰“è€…æˆç¸¾å±¥æ­´ (ã“ã®è©¦åˆã‚ˆã‚Šå‰)
${batterGamelogInfo || 'æ‰“è€…ã®è©¦åˆå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'}

### æŒ‡ç¤º
- ã‚¹ãƒ¬ã‚¿ã‚¤ã¯ã€Œã€é€Ÿå ±ã€‘${myTeam}ã€å¼·è±ª${opponentName}ã‚’æ’ƒç ´ï¼ï¼ã€ã€Œã€æ‚²å ±ã€‘${myTeam}æ•£ã‚‹...ã—ã‹ã—ã‚ˆãã‚„ã£ãŸï¼ã€ã®ã‚ˆã†ã«ã€çµæœã¨ç›¸æ‰‹ã®å¼·ã•ã‚’åæ˜ ã•ã›ã¦ãã ã•ã„ã€‚
- ãƒ¬ã‚¹å†…å®¹ã¯ã€å…¨å“¡ãŒå‘³æ–¹ã§ã‚¢ãƒ³ãƒãªã—ã€‚
- **ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã«å¿…ãšè¨€åŠã—ã¦ãã ã•ã„ï¼š**
    1. **å…·ä½“çš„ãªãƒ—ãƒ¬ãƒ¼:** ã€Œãƒ‡ãƒ¼ã‚¿4(ãƒã‚¤ãƒ©ã‚¤ãƒˆ)ã€ã«ã‚ã‚‹æ±ºå®šæ‰“ã‚„ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã€‚
    2. **å€‹äººã®ã‚¹ã‚¿ãƒƒãƒ„:** ã€Œãƒ‡ãƒ¼ã‚¿3(å€‹äººæˆç¸¾)ã€ã‚’è¦‹ã¦ã€çŒ›æ‰“è³ã‚„å®Œå°ãªã©ã®æ•°å­—ã€‚
    3. **ã“ã‚Œã¾ã§ã®æ–‡è„ˆ:** ã€Œãƒ‡ãƒ¼ã‚¿6,7(Gamelog)ã€ã‚’è¦‹ã¦ã€ã€Œé€£æŠ•ãŠç–²ã‚Œã€ã€Œä¸æŒ¯è„±å‡ºã‹ï¼Ÿã€ãªã©ã®ã‚³ãƒ¡ãƒ³ãƒˆã€‚
    4. **çœŒå¤§ä¼šã¨ã®æ¯”è¼ƒ:** ã€Œãƒ‡ãƒ¼ã‚¿3(çœŒå¤§ä¼šæˆç¸¾)ã€ã¨æ¯”è¼ƒã—ã€ã€Œäºˆé¸ã‚ˆã‚Šæ‰“ã£ã¦ã‚‹ã€ã€Œç”²å­åœ’ã«æ¥ã¦è¦šé†’ã—ãŸãªã€ãªã©ã®ã‚³ãƒ¡ãƒ³ãƒˆã€‚
    5. **æ€ªæˆ‘äººæƒ…å ±:** ã€Œ${injuryReport}ã€ãŒã‚ã‚‹å ´åˆã€ãã®é¸æ‰‹ã®é‡è¦åº¦ï¼ˆä¸»åŠ›/æ§ãˆï¼‰ã‚‚è€ƒæ…®ã—ã€å¿ƒé…ã‚„åŠ´ã„ã®ãƒ¬ã‚¹ã‚’å«ã‚ã‚‹ã“ã¨ã€‚
    6. **æ¬¡æˆ¦ã¸ã®å±•æœ›:** å‹ã£ãŸå ´åˆã€ã€Œãƒ‡ãƒ¼ã‚¿5(æ¬¡æˆ¦æƒ…å ±)ã€ã®ç›¸æ‰‹ã«ã¤ã„ã¦èªã‚‹ã“ã¨ã€‚

### å‡ºåŠ›å½¢å¼ (JSON)
{
  "threadTitle": "ï¼ˆã‚¹ãƒ¬ã‚¿ã‚¤ï¼‰",
  "comments": [
    {"personality": "1: é™å²¡ã®èª‡ã‚Š", "comment": "ï¼ˆã‚¹ãƒ¬ä¸»ã®ç†±ã„ã‚³ãƒ¡ãƒ³ãƒˆã€‚ã‚¹ã‚³ã‚¢ã‚„å‹å› ã«è§¦ã‚Œã‚‹ï¼‰"},
    {"personality": "2: åç„¡ã—ã•ã‚“", "comment": "ï¼ˆå…·ä½“çš„ãªãƒã‚¤ãƒ©ã‚¤ãƒˆã¸ã®åå¿œï¼‰"},
    {"personality": "3: ãƒ‡ãƒ¼ã‚¿å¨", "comment": "ï¼ˆGamelogã‚„ã‚¹ã‚¿ãƒƒãƒ„ã«åŸºã¥ã„ãŸåˆ†æçš„ç§°è³›ï¼‰"},
    {"personality": "4: å¿ƒé…æ€§", "comment": "ï¼ˆæ€ªæˆ‘äººã‚„æ¬¡æˆ¦ã®ç›¸æ‰‹ã‚’æ°—ã«ã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆï¼‰"}
    // ... åˆè¨ˆ20å€‹ç¨‹åº¦
  ]
}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const bbsJson = parseJsonFromText(rawText);
            if (bbsJson && bbsJson.threadTitle && Array.isArray(bbsJson.comments)) {
                return {
                    id: `koshien-thread-${Date.now()}`,
                    title: bbsJson.threadTitle,
                    matchId: 'koshien',
                    comments: bbsJson.comments.map((c, index) => ({
                        id: crypto.randomUUID(),
                        personality: c.personality,
                        text: c.comment,
                        timestamp: Date.now() + index * 10,
                        replies: []
                    })),
                    timestamp: Date.now(),
                    context: { ...matchContext, isKoshien: true } // â˜…ãƒ•ãƒ«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
                };
            }
        }
        return null;
    } catch (error) {
        console.error("ç”²å­åœ’ã¾ã¨ã‚ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
        return null;
    }
}

/**
 * [UPDATED] ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰ã®ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹
 * (â˜…å†èª­ã¿è¾¼ã¿æ™‚ã‚‚ã€ãƒ€ãƒŸãƒ¼ãƒãƒ¼ãƒ ã‚’å«ã‚ã¦å…¨å“¡Aãƒ©ãƒ³ã‚¯(åå·®å€¤80ä»¥ä¸Š)ã¨ã—ã¦å¾©å…ƒã™ã‚‹)
 */
function restoreKoshienData(teams) {
    // 1. ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰æ ¡ï¼ˆãƒœã‚¹ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†ç™»éŒ² (åå·®å€¤88ã€œ95ã®æœ€å¼·ãƒ‡ãƒ¼ã‚¿)
    addLegendaryTeamsData();

    // 2. ãƒ€ãƒŸãƒ¼ãƒãƒ¼ãƒ ï¼ˆãã®ä»–ã®ä»£è¡¨æ ¡ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†ç™»éŒ²
    teams.forEach(teamName => {
        // ã¾ã TEAM_DATAã«ãªã„ï¼ˆï¼ãƒ€ãƒŸãƒ¼ãƒãƒ¼ãƒ ã®ï¼‰å ´åˆ
        if (teamName !== '(BYE)' && !TEAM_DATA[teamName]) {
            TEAM_DATA[teamName] = { 
                name_yomi: "ã ã„ã²ã‚‡ã†ã“ã†", 
                region: "å…¨å›½", 
                type: "å…¬ç«‹", 
                deviation: 85, // â˜…â˜…â˜… ä¿®æ­£: åå·®å€¤ã‚’85ã«è¨­å®šã—ã€ç¢ºå®Ÿã«Aãƒ©ãƒ³ã‚¯ã«ã™ã‚‹ â˜…â˜…â˜…
                best: "ç”²å­åœ’å‡ºå ´", 
                last: "äºˆé¸çªç ´", 
                info: "å„éƒ½é“åºœçœŒã®ä»£è¡¨æ ¡ã€‚éå¸¸ã«å¼·åŠ›ãªæˆ¦åŠ›ã‚’æœ‰ã™ã‚‹ã€‚", 
                coach: { name: "ãƒ¢ãƒ–ç›£ç£", style: "å …å®Ÿ", experience: "ä¸­å …" } 
            };
        }
    });
}

/**
 * [UPDATED] ç”²å­åœ’é–‹å¹•ç›´å‰ï¼šé™å²¡ä»£è¡¨ãƒãƒ¼ãƒ ã®ç´¹ä»‹è¨˜äº‹ã‚’ç”Ÿæˆã™ã‚‹
 * (â˜…Info, 283å­¦åœ’ã®ãƒªãƒ™ãƒ³ã‚¸, äºˆé¸æˆç¸¾, æ³¨ç›®é¸æ‰‹(è©³ç´°æ•°å€¤ä»˜ã), å„ªå‹äºˆæƒ³ãƒ©ãƒ³ã‚¯A-E)
 */
async function generateKoshienTeamIntro(teamName) {
    const teamData = TEAM_DATA[teamName];
    const teamRecord = tournamentState.teamRecords[teamName];
    const rank = calculateRank(teamName, tournamentState); // å†…éƒ¨ãƒ©ãƒ³ã‚¯(A~E)
    
    // 1. 283å­¦åœ’ã®å ´åˆã®ç‰¹åˆ¥ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
    let specialContext = "";
    if (teamName === "283å­¦åœ’") {
        specialContext = "ã€ç‰¹è¨˜äº‹é …ã€‘æ˜¨å¤ã®ç”²å­åœ’åˆæˆ¦ã§æµ¦å’Œå­¦é™¢ã«æ•—ã‚Œã¦ãŠã‚Šã€é¸æ‰‹ãŸã¡ã¯ã€Œæ‰“å€’ãƒ»æµ¦å­¦ã€ã‚’æ²ã’ã€ãƒªãƒ™ãƒ³ã‚¸ã«ç‡ƒãˆã¦ã„ã‚‹ã€‚";
    }

    // 2. çœŒå¤§ä¼šæˆç¸¾ã®æ•´å½¢ (ãƒãƒ¼ãƒ å…¨ä½“)
    let statsText = "æƒ…å ±ãªã—";
    if (teamRecord.prefecturalStats) {
        const p = teamRecord.prefecturalStats;
        const avg = p.ab > 0 ? (p.h / p.ab).toFixed(3) : '.---';
        statsText = `çœŒå¤§ä¼šæˆç¸¾: ãƒãƒ¼ãƒ æ‰“ç‡${avg}, æœ¬å¡æ‰“${p.hr}, ç·å¾—ç‚¹${p.r}, ç›—å¡${p.sb}, å¤±ç­–${p.e || 0}`;
    }

    // 3. â˜…â˜…â˜… æ³¨ç›®é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ (è©³ç´°æ•°å€¤ä»˜ã) ã®ç”Ÿæˆ â˜…â˜…â˜…
    let keyPlayersList = [];
    
    if (teamRecord.playerStats) {
        // æ‰“è€… (æ‰“ç‡3å‰²5åˆ†ä»¥ä¸Š ã¾ãŸã¯ æœ¬å¡æ‰“1æœ¬ä»¥ä¸Š ã¾ãŸã¯ ç›—å¡3ä»¥ä¸Š)
        if (teamRecord.playerStats.batting) {
            Object.entries(teamRecord.playerStats.batting).forEach(([name, stats]) => {
                // â€»ã“ã“ã§ã¯é€šç®—æˆç¸¾(=äºˆé¸æˆç¸¾)ã‚’ä½¿ç”¨
                const avgVal = stats.ab > 0 ? (stats.h / stats.ab) : 0;
                
                if (avgVal >= 0.35 || stats.hr >= 1 || stats.sb >= 3 || stats.narrative_flag === 'peak') {
                    const avg = avgVal.toFixed(3);
                    keyPlayersList.push(`- æ‰“è€…ãƒ»${name}: æ‰“ç‡${avg}, ${stats.hr}æœ¬å¡æ‰“, ${stats.rbi}æ‰“ç‚¹, ${stats.sb}ç›—å¡`);
                }
            });
        }
        
        // æŠ•æ‰‹ (é˜²å¾¡ç‡2.50ä»¥ä¸‹ ã¾ãŸã¯ å¥ªä¸‰æŒ¯ç‡ãŒé«˜ã„é¸æ‰‹)
        if (teamRecord.playerStats.pitching) {
            Object.entries(teamRecord.playerStats.pitching).forEach(([name, stats]) => {
                const career = stats.career;
                const ip = parseFloat(career.ip);
                if (ip >= 5) { // 5å›ä»¥ä¸ŠæŠ•ã’ã¦ã„ã‚‹ã“ã¨
                    const eraVal = ip > 0 ? ((career.er * 9) / ip) : 99.99;
                    const k9 = ip > 0 ? ((career.so * 9) / ip).toFixed(2) : 0;
                    
                    if (eraVal <= 2.50 || career.so >= 10 || stats.narrative_flag === 'peak') {
                        const era = eraVal.toFixed(2);
                        keyPlayersList.push(`- æŠ•æ‰‹ãƒ»${name}: é˜²å¾¡ç‡${era}, ${career.w}å‹${career.l}æ•—, å¥ªä¸‰æŒ¯${career.so} (K/9: ${k9})`);
                    }
                }
            });
        }
    }
    
    // AIã«æ¸¡ã™ãƒªã‚¹ãƒˆï¼ˆå¤šã™ãã‚‹ã¨ã‚ãµã‚Œã‚‹ã®ã§ã€æ´»èºåº¦ãŒé«˜ã„é †ãªã©ã§ã‚½ãƒ¼ãƒˆã™ã‚‹ã®ãŒç†æƒ³ã ãŒã€ã“ã“ã§ã¯ä¸Šä½7åç¨‹åº¦ã«çµã‚‹ï¼‰
    const keyPlayersText = keyPlayersList.slice(0, 7).join('\n') || "ï¼ˆç‰¹ç­†ã™ã¹ãå€‹äººæˆç¸¾ãªã—ã€‚å…¨å“¡é‡çƒã§å‹ã¡ä¸ŠãŒã£ãŸï¼‰";

    const prompt = `ã‚ãªãŸã¯ã€Œé€±åˆŠãƒ™ãƒ¼ã‚¹ãƒœãƒ¼ãƒ«ã€ã®é«˜æ ¡é‡çƒæ‹…å½“è¨˜è€…ã§ã™ã€‚
å¤ã®ç”²å­åœ’ã«å‡ºå ´ã™ã‚‹é™å²¡ä»£è¡¨ã€Œ${teamName}ã€ã®ãƒãƒ¼ãƒ ç´¹ä»‹è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

### ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
- **ãƒãƒ¼ãƒ å:** ${teamName}
- **å†…éƒ¨è©•ä¾¡ãƒ©ãƒ³ã‚¯:** ${rank}
- **ãƒãƒ¼ãƒ èƒŒæ™¯:** ${teamData.info}
- **${specialContext}**
- **äºˆé¸(çœŒå¤§ä¼š)æˆç¸¾:** ${statsText}

### æ³¨ç›®é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ (äºˆé¸æˆç¸¾)
${keyPlayersText}

### åŸ·ç­†æŒ‡ç¤º
- ã‚¿ã‚¤ãƒˆãƒ«ã¯ã€Œã€ä»£è¡¨æ ¡ç´¹ä»‹ï¼šé™å²¡ã€‘${teamName}ã€ã‹ã‚‰å§‹ã‚ã¦ã€ã‚­ãƒ£ãƒƒãƒãƒ¼ãªãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ç¶šã‘ã¦ãã ã•ã„ã€‚
- æœ¬æ–‡ã§ã¯ã€ãƒãƒ¼ãƒ ã®ç‰¹å¾´ï¼ˆèƒŒæ™¯æƒ…å ±ï¼‰ã¨äºˆé¸ã§ã®æˆ¦ã„ã¶ã‚Šï¼ˆãƒãƒ¼ãƒ æˆç¸¾ï¼‰ã‚’çµ„ã¿åˆã‚ã›ã¦ç´¹ä»‹ã—ã¦ãã ã•ã„ã€‚
- **ã€é¸æ‰‹ç´¹ä»‹ã‚³ãƒ¼ãƒŠãƒ¼ã€‘ã‚’å¿…ãšè¨­ã‘ã€ä¸Šè¨˜ã®ã€Œæ³¨ç›®é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ã€ã«ã‚ã‚‹å…·ä½“çš„ãªæ•°å€¤ï¼ˆæ‰“ç‡ã€æœ¬å¡æ‰“æ•°ã€é˜²å¾¡ç‡ãªã©ï¼‰ã‚’å¼•ç”¨ã—ã¦ã€ä¸»åŠ›é¸æ‰‹ãŸã¡ã®æ´»èºã¶ã‚Šã‚’è©³ã—ãç´¹ä»‹ã—ã¦ãã ã•ã„ã€‚**
- **ã€Œå„ªå‹äºˆæƒ³ãƒ©ãƒ³ã‚¯ã€**ã‚’ã€æˆ¦åŠ›ã«åŸºã¥ã„ã¦ **E, D, C, B, A** ã®5æ®µéšã§ç‹¬è‡ªã«æ ¼ä»˜ã‘ã—ã€è¨˜äº‹ã®æœ€å¾Œã«ç†ç”±ã¨ã¨ã‚‚ã«æ˜è¨˜ã—ã¦ãã ã•ã„ã€‚ï¼ˆâ€»å†…éƒ¨è©•ä¾¡ãƒ©ãƒ³ã‚¯ ${rank} ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ï¼‰
- **${teamName}ãŒ283å­¦åœ’ã®å ´åˆ**ã¯ã€å¿…ãšã€Œæµ¦å’Œå­¦é™¢ã¸ã®ãƒªãƒ™ãƒ³ã‚¸ã€ã«ã¤ã„ã¦ç†±ãè§¦ã‚Œã¦ãã ã•ã„ã€‚

### å‡ºåŠ›å½¢å¼ (JSON)
{"title": "è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«", "body": "è¨˜äº‹æœ¬æ–‡"}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const article = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (article) {
                return { 
                    ...article, 
                    timestamp: Date.now(),
                    context: { isKoshienIntro: true, teamName: teamName }
                };
            }
        }
        return null;
    } catch (error) {
        console.error("ç”²å­åœ’ãƒãƒ¼ãƒ ç´¹ä»‹è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
        return null;
    }
}

/**
 * [NEW] AIãƒŠãƒ©ãƒ†ã‚£ãƒ–ãƒ»ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ 
 * å¤§ä¼šçµ‚äº†å¾Œã€ãƒ‰ãƒ©ãƒãŒã‚ã£ãŸãƒãƒ¼ãƒ ã®ç´¹ä»‹æ–‡(info)ã‚’AIã«æ›¸ãç›´ã•ã›ã‚‹
 */
async function updateNarrativesWithAI(state) {
    const updates = [];
    const historySummary = []; // AIã¸ã®å…¥åŠ›ç”¨ï¼ˆå…¨ä½“ã®æ–‡è„ˆï¼‰

    // 1. æ›´æ–°å¯¾è±¡ã®ãƒãƒ¼ãƒ ã‚’ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—
    const teamRecords = state.teamRecords;
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };

    Object.keys(teamRecords).forEach(teamName => {
        const record = teamRecords[teamName];
        const history = record.history || [];
        if (history.length === 0) return;

        const lastRank = history[0].rank; // ä»Šå›ã®é †ä½
        const baseRank = calculateRank(teamName, state); // æœ¬æ¥ã®ãƒ©ãƒ³ã‚¯
        const originalInfo = TEAM_DATA[teamName].info;

        let reason = null;

        // (A) å„ªå‹ãƒ»æº–å„ªå‹æ ¡ (å¿…ãšæ›´æ–°)
        if (lastRank === 1) reason = "champion";
        else if (lastRank === -1) reason = "koshien_champion"; // ç”²å­åœ’å„ªå‹
        else if (lastRank === 2) reason = "runner_up";
        
        // (B) ä¸‹å‰‹ä¸Š (E/Dãƒ©ãƒ³ã‚¯ãŒãƒ™ã‚¹ãƒˆ8ä»¥ä¸Š)
        else if (['D', 'E'].includes(baseRank) && lastRank <= 8 && lastRank > 0) {
            reason = "cinderella";
        }
        
        // (C) æ²¡è½ (Aãƒ©ãƒ³ã‚¯ãŒåˆæˆ¦æ•—é€€)
        else if (baseRank === 'A' && lastRank >= 32) {
            reason = "slump";
        }

        if (reason) {
            updates.push({ teamName, reason, lastRank, baseRank, originalInfo });
            historySummary.push(`- ${teamName} (${baseRank}ãƒ©ãƒ³ã‚¯): ${getRankString(lastRank)}`);
        }
    });

    // æ›´æ–°å¯¾è±¡ãŒã„ãªã‘ã‚Œã°çµ‚äº†
    if (updates.length === 0) return;

    // 2. AIã¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
    // ãƒãƒ¼ãƒ ã”ã¨ã«å€‹åˆ¥ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã¨é…ã„ã®ã§ã€ã¾ã¨ã‚ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹
    const updateRequestText = updates.map(u => 
        `â– ãƒãƒ¼ãƒ å: ${u.teamName}\n` +
        `ãƒ»ç¾åœ¨ã®ç´¹ä»‹æ–‡: "${u.originalInfo}"\n` +
        `ãƒ»ä»Šå¤§ä¼šã®çµæœ: ${getRankString(u.lastRank)}\n` +
        `ãƒ»æœ¬æ¥ã®è©•ä¾¡: ${u.baseRank}ãƒ©ãƒ³ã‚¯\n` +
        `ãƒ»æ›´æ–°ç†ç”±: ${u.reason}`
    ).join('\n\n');

    const prompt = `ã‚ãªãŸã¯ã€Œé«˜æ ¡é‡çƒã‚¬ã‚¤ãƒ‰ãƒ–ãƒƒã‚¯ã€ã®ç·¨é›†è€…ã§ã™ã€‚
æœ€æ–°ã®å¤§ä¼šçµæœã‚’å—ã‘ã¦ã€ä»¥ä¸‹ã®æ³¨ç›®ãƒãƒ¼ãƒ ã®ã€Œãƒãƒ¼ãƒ ç´¹ä»‹æ–‡ï¼ˆinfoï¼‰ã€ã‚’åˆ·æ–°ã—ã¦ãã ã•ã„ã€‚

### æŒ‡ç¤º
- **æ–‡è„ˆã®ç¶™æ‰¿:** ã€Œç¾åœ¨ã®ç´¹ä»‹æ–‡ã€ã®å†…å®¹ï¼ˆå‰µéƒ¨å¹´æ•°ã‚„ç‰¹å¾´ãªã©ï¼‰ã‚’æ´»ã‹ã—ã¤ã¤ã€ã€Œä»Šå¤§ä¼šã®çµæœã€ã¨ã„ã†æ–°ã—ã„æ­´å²ã‚’çµ„ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚
- **ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«:** - å„ªå‹æ ¡ãªã‚‰ç‹è€…ã®é¢¨æ ¼ã‚’ã€‚
    - ä¸‹å‰‹ä¸Šãªã‚‰ãã®è¡æ’ƒã¨æœŸå¾…ã‚’ã€‚
    - æ²¡è½ãªã‚‰å¾©æ´»ã¸ã®èª²é¡Œã‚„ãƒ•ã‚¡ãƒ³ã®å˜†ãã‚’ã€‚
- **é•·ã•:** å„ãƒãƒ¼ãƒ  80ã€œ100æ–‡å­—ç¨‹åº¦ã€‚
- **å‡ºåŠ›:** JSONå½¢å¼ã§ã€ãƒãƒ¼ãƒ åã‚’ã‚­ãƒ¼ã€æ–°ã—ã„ç´¹ä»‹æ–‡ã‚’å€¤ã«ã—ã¦ãã ã•ã„ã€‚

### æ›´æ–°å¯¾è±¡ãƒªã‚¹ãƒˆ
${updateRequestText}

### å‡ºåŠ›å½¢å¼ (JSON)
{
  "ãƒãƒ¼ãƒ A": "æ–°ã—ã„ç´¹ä»‹æ–‡...",
  "ãƒãƒ¼ãƒ B": "æ–°ã—ã„ç´¹ä»‹æ–‡..."
}`;

    // 3. AIãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œ
    // ç”»é¢ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤ºï¼ˆãƒ‹ãƒ¥ãƒ¼ã‚¹æ¬„ã‚’å€Ÿç”¨ï¼‰
    const newsContainer = document.getElementById('news-articles');
    const loadingMsg = document.createElement('div');
    loadingMsg.className = "bg-yellow-100 p-4 rounded text-center text-yellow-800 font-bold animate-pulse";
    loadingMsg.textContent = `ğŸ“¢ AIãŒæœ€æ–°ã®æˆ¦ç¸¾ã‚’åˆ†æã—ã€ãƒãƒ¼ãƒ ç´¹ä»‹æ–‡ã‚’æ›¸ãæ›ãˆã¦ã„ã¾ã™... (${updates.length}æ ¡)`;
    if(newsContainer) newsContainer.prepend(loadingMsg);

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const newInfos = parseJsonFromText(result.candidates[0].content.parts[0].text);
            
            if (newInfos) {
                let updateCount = 0;
                for (const [teamName, newInfo] of Object.entries(newInfos)) {
                    if (TEAM_DATA[teamName]) {
                        console.log(`[Info Update] ${teamName}: ${newInfo}`);
                        TEAM_DATA[teamName].info = newInfo; // ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ã
                        updateCount++;
                    }
                }
                
                // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                loadingMsg.className = "bg-green-100 p-4 rounded text-center text-green-800 font-bold";
                loadingMsg.textContent = `âœ… ãƒãƒ¼ãƒ ç´¹ä»‹æ–‡ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼ (${updateCount}æ ¡)`;
                setTimeout(() => loadingMsg.remove(), 5000);
            }
        }
    } catch (error) {
        console.error("AIãƒãƒ¼ãƒ ç´¹ä»‹æ–‡æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
        loadingMsg.textContent = "âš ï¸ ç´¹ä»‹æ–‡ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        setTimeout(() => loadingMsg.remove(), 3000);
    }
}

// â–¼â–¼â–¼ éŸ³å£°èªè­˜ï¼†ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ»ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ â–¼â–¼â–¼

const interviewModal = document.getElementById('hero-interview-modal');
const interviewerText = document.getElementById('interviewer-text');
const answerInput = document.getElementById('interview-answer-input');
const voiceBtn = document.getElementById('voice-rec-btn');
const recIndicator = document.getElementById('rec-indicator');
const voiceStatus = document.getElementById('voice-status');
const submitInterviewBtn = document.getElementById('submit-interview-btn');
const flashEffect = document.getElementById('camera-flash');

let recognition = null;
let isRecording = false;
let interviewResolve = null; // Promiseè§£æ±ºç”¨

// 1. éŸ³å£°èªè­˜ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
function setupSpeechRecognition() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        voiceBtn.style.display = 'none'; // éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ãƒã‚¤ã‚¯ã‚’éš ã™
        return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.interimResults = true; // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¤‰æ›
    recognition.continuous = true;     // é€£ç¶šèªè­˜

    recognition.onstart = () => {
        isRecording = true;
        voiceBtn.classList.add('bg-red-600', 'animate-pulse');
        recIndicator.classList.remove('hidden');
        voiceStatus.textContent = "èã„ã¦ã„ã¾ã™...";
        voiceStatus.classList.add('text-red-400');
    };

    recognition.onend = () => {
        isRecording = false;
        voiceBtn.classList.remove('bg-red-600', 'animate-pulse');
        recIndicator.classList.add('hidden');
        voiceStatus.textContent = "å¾…æ©Ÿä¸­";
        voiceStatus.classList.remove('text-red-400');
    };

    recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript;
            } else {
                interimTranscript += event.results[i][0].transcript;
            }
        }

        // æ—¢å­˜ã®ãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹ã®ã§ã¯ãªãã€ç¾åœ¨ã®ç™ºè©±å†…å®¹ã‚’è¡¨ç¤º
        if (finalTranscript) {
            const currentVal = answerInput.value;
            answerInput.value = currentVal + (currentVal ? " " : "") + finalTranscript;
        }
    };

    // ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®æŒ™å‹•
    voiceBtn.addEventListener('click', () => {
        if (isRecording) {
            recognition.stop();
        } else {
            recognition.start();
            answerInput.focus();
        }
    });
}

// 2. éŸ³å£°åˆæˆï¼ˆAIè¨˜è€…ã®èª­ã¿ä¸Šã’ï¼‰
function speakText(text) {
    if (!('speechSynthesis' in window)) return;
    
    // ä»¥å‰ã®ç™ºè©±ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'ja-JP';
    utterance.rate = 1.0; // é€Ÿåº¦
    utterance.pitch = 0.8; // å°‘ã—ä½ã‚ã®å£°ã§è¨˜è€…ã£ã½ã
    
    window.speechSynthesis.speak(utterance);
}

// 3. ã‚«ãƒ¡ãƒ©ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ¼”å‡º
function triggerFlash() {
    flashEffect.classList.remove('opacity-0');
    flashEffect.classList.add('opacity-50');
    setTimeout(() => {
        flashEffect.classList.remove('opacity-50');
        flashEffect.classList.add('opacity-0');
    }, 100);
}

// â–¼â–¼â–¼ 4. ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆä¿®æ­£ç‰ˆï¼šç¢ºå®Ÿã«é–‰ã˜ã‚‹ï¼‰ â–¼â–¼â–¼
async function startHeroInterview(matchContext) {
    // 1. MVPï¼ˆãƒ’ãƒ¼ãƒ­ãƒ¼é¸æ‰‹ï¼‰ã‚’ç‰¹å®šã™ã‚‹
    const mvpPlayerName = identifyMvpPlayer(matchContext);
    const heroName = mvpPlayerName || "ä¸»å°†";

    // ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼çµæœã‚’æ ¼ç´ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    const interviewResult = {
        manager: null,
        hero: null
    };

    try {
        // --- ç¬¬ä¸€éƒ¨ï¼šç›£ç£ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ ---
        await showInterviewModal("ç›£ç£", "å‹åˆ©ç›£ç£ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼");
        const managerQ = await generateInterviewQuestion(matchContext, "manager", "ç›£ç£");
        interviewResult.manager = await runInterviewSession(managerQ);

        // --- ç¬¬äºŒéƒ¨ï¼šãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ ---
        // å°‘ã—é–“ã‚’ç©ºã‘ã‚‹
        await new Promise(r => setTimeout(r, 500));
        
        await showInterviewModal(heroName, `æœ¬æ—¥ã®ãƒ’ãƒ¼ãƒ­ãƒ¼ï¼š${heroName}é¸æ‰‹`);
        const heroQ = await generateInterviewQuestion(matchContext, "hero", heroName);
        interviewResult.hero = await runInterviewSession(heroQ);

    } catch (e) {
        console.error("ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", e);
    } finally {
        // ã€é‡è¦ã€‘ã©ã‚“ãªçŠ¶æ³ã§ã‚‚æœ€å¾Œã¯å¿…ãšãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦éŸ³å£°åœæ­¢ã™ã‚‹
        closeInterviewModalForcefully();
    }

    return interviewResult;
}

// å¼·åˆ¶çµ‚äº†ãƒ˜ãƒ«ãƒ‘ãƒ¼
function closeInterviewModalForcefully() {
    if (interviewModal) {
        interviewModal.classList.add('hidden');
        interviewModal.classList.remove('flex');
    }
    // éŸ³å£°å‘¨ã‚Šã®åœæ­¢
    if (window.speechSynthesis) window.speechSynthesis.cancel();
    if (recognition) {
        try { recognition.stop(); } catch(e){}
    }
    isRecording = false;
    if (voiceBtn) voiceBtn.classList.remove('bg-red-600', 'animate-pulse');
    if (recIndicator) recIndicator.classList.add('hidden');
    if (voiceStatus) {
        voiceStatus.textContent = "å¾…æ©Ÿä¸­";
        voiceStatus.classList.remove('text-red-400');
    }
}

// ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã®1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆä¿®æ­£ç‰ˆï¼‰
async function runInterviewSession(questionText) {
    return new Promise((resolve) => {
        // UIãƒªã‚»ãƒƒãƒˆ
        if(answerInput) answerInput.value = '';
        
        // è³ªå•è¡¨ç¤ºï¼†èª­ã¿ä¸Šã’
        if(interviewerText) interviewerText.textContent = questionText;
        triggerFlash();
        speakText(questionText);

        // é€ä¿¡ãƒãƒ³ãƒ‰ãƒ©ã‚’ä½œæˆ
        const handleSubmit = () => {
            const answer = answerInput.value.trim();
            if (!answer) { 
                alert("å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); 
                return; 
            }
            
            // éŸ³å£°èªè­˜åœæ­¢
            if (isRecording && recognition) {
                try { recognition.stop(); } catch(e){}
            }
            if (window.speechSynthesis) window.speechSynthesis.cancel();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è§£é™¤ï¼ˆé‡è¤‡é˜²æ­¢ã®ãŸã‚nullã«ã™ã‚‹ï¼‰
            submitInterviewBtn.onclick = null;

            // â˜…ã“ã“ã§ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ãªã„ï¼ˆæ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¾ãŸã¯finallyã§é–‰ã˜ã‚‹ãŸã‚ï¼‰
            // ãŸã ã—ã€è¦–è¦šçš„ãªå®Œäº†ã‚’ç¤ºã™ãŸã‚ã«ä¸€æ—¦éš ã™ã®ã¯OK
            interviewModal.classList.add('hidden');
            interviewModal.classList.remove('flex');
            
            resolve({ question: questionText, answer: answer });
        };

        // ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆ (onclickã§ä¸Šæ›¸ãã—ã¦ä»¥å‰ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’æ¶ˆã™)
        if(submitInterviewBtn) submitInterviewBtn.onclick = handleSubmit;
    });
}

// MVPç‰¹å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå¤‰æ›´ãªã—ï¼‰
function identifyMvpPlayer(matchContext) {
    const { dbMatch, winnerName } = matchContext;
    const teamKey = (dbMatch.team1 === winnerName) ? 'team1' : 'team2';
    
    if (!dbMatch.details || !dbMatch.details.playerGameStats) return null;

    const stats = dbMatch.details.playerGameStats[teamKey];
    let bestPlayer = null;
    let maxScore = -1;

    for (const [name, s] of Object.entries(stats)) {
        let score = (s.hr || 0) * 10 + (s.rbi || 0) * 3 + (s.h || 0) * 2;
        const pData = dbMatch.details.pitching?.[teamKey]?.find(p => p.name === name);
        if (pData) {
            if (pData.result === 'W') score += 10;
            if (pData.runs === '0' && parseFloat(pData.innings) >= 5) score += 15; 
            score += (parseInt(pData.strikeouts) || 0);
        }
        if (score > maxScore) {
            maxScore = score;
            bestPlayer = name;
        }
    }
    return bestPlayer;
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºè¨­å®šãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆå¤‰æ›´ãªã—ï¼‰
async function showInterviewModal(targetName, titleText) {
    interviewModal.classList.add('hidden');
    interviewModal.classList.remove('flex');
    await new Promise(r => setTimeout(r, 300)); 

    // èª°ã¸ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‹ã‚’è¡¨ç¤º
    if(interviewerText) interviewerText.textContent = "ï¼ˆè³ªå•ã‚’ç”Ÿæˆä¸­...ï¼‰";
    const roleText = document.querySelector('#hero-interview-modal .text-blue-400');
    if(roleText) roleText.textContent = `YOUR ANSWER as ${targetName}`;
    
    interviewModal.classList.remove('hidden');
    interviewModal.classList.add('flex');
}

// 5. è³ªå•ç”ŸæˆAIï¼ˆå¤‰æ›´ãªã—ï¼‰
async function generateInterviewQuestion(matchContext, type, targetName) {
    const { winnerName, highlights } = matchContext;
    const role = type === 'manager' ? 'ç›£ç£' : `${targetName}é¸æ‰‹`;
    
    const prompt = `ã‚ãªãŸã¯ã‚¹ãƒãƒ¼ãƒ„è¨˜è€…ã§ã™ã€‚
é«˜æ ¡é‡çƒã€Œ${winnerName}ã€ã®${role}ã¸ã®å‹åˆ©ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã§ã€**æœ€ã‚‚èãã¹ãé‹­ã„è³ªå•ã‚’1ã¤ã ã‘**ä½œæˆã—ã¦ãã ã•ã„ã€‚
### ç›¸æ‰‹
${role}
### è©¦åˆãƒã‚¤ãƒ©ã‚¤ãƒˆ
${highlights.slice(0, 4).map(h => h.description).join('ã€')}
### æŒ‡ç¤º
- ç›¸æ‰‹ãŒç›£ç£ãªã‚‰é‡‡é…ã‚„è©¦åˆå±•é–‹ã«ã¤ã„ã¦ã€‚
- ç›¸æ‰‹ãŒé¸æ‰‹ãªã‚‰ã€è‡ªèº«ã®æ±ºå®šçš„ãªãƒ—ãƒ¬ãƒ¼ã‚„æ°—æŒã¡ã«ã¤ã„ã¦ã€‚
- ã§ã™ãƒ»ã¾ã™èª¿ã€40æ–‡å­—ä»¥å†…ã€‚
### å‡ºåŠ›å½¢å¼(JSON): {"question": "è³ªå•æœ¬æ–‡"}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        const json = parseJsonFromText(result.candidates[0].content.parts[0].text);
        return json.question;
    } catch (e) {
        return type === 'manager' 
            ? "ãƒŠã‚¤ã‚¹ã‚²ãƒ¼ãƒ ã§ã—ãŸã€‚ä»Šã®ç‡ç›´ãªæ°—æŒã¡ã‚’ãŠèã‹ã›ãã ã•ã„ã€‚"
            : "ç´ æ™´ã‚‰ã—ã„æ´»èºã§ã—ãŸï¼ä»Šã®æ°—æŒã¡ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚";
    }
}
// â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²
// åˆæœŸåŒ–æ™‚ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
setupSpeechRecognition();

// â–²â–²â–² ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã“ã“ã¾ã§ â–²â–²â–²

    /**
     * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ï¼ˆå®Œå…¨ç‰ˆï¼‰
     * - ç”»åƒãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
     * - ã‚µã‚¦ãƒ³ãƒ‰åˆæœŸåŒ–
     * - ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ï¼ˆåœ§ç¸®ãƒ‡ãƒ¼ã‚¿å„ªå…ˆ -> æ—§ãƒ‡ãƒ¼ã‚¿ï¼‰
     * - äº’æ›æ€§ãƒ‘ãƒƒãƒé©ç”¨
     */
    async function initializeApp() {
        SoundManager.init();
setupTeamTracker();
        
        // --- 1. èƒŒæ™¯ç”»åƒã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã¨é©ç”¨ ---
        const bgContainer = document.querySelector('.ballpark-background');
        if (bgContainer) {
            const img = new Image();
            const imageUrl = 'ballpark.jpg'; // ãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒãƒ‘ã‚¹
            
            img.onload = function() {
                bgContainer.style.backgroundImage = `url(${imageUrl})`;
                createDustEffect(); // ç”»åƒãƒ­ãƒ¼ãƒ‰å¾Œã«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–‹å§‹
            };
            img.onerror = function() {
                console.error('èƒŒæ™¯ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                createDustEffect(); // ç”»åƒãªã—ã§ã‚‚ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¯é–‹å§‹
            };
            
            img.src = imageUrl; 
        } else {
            createDustEffect();
        }

        // --- 2. ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿å‡¦ç† ---
        // æ–°ã—ã„ã€Œåœ§ç¸®ãƒ‡ãƒ¼ã‚¿ã€ã‚’å„ªå…ˆã—ã¦æ¢ã™
        const savedStateCompressed = localStorage.getItem('tournamentState_compressed');
        // å¤ã„ã€Œéåœ§ç¸®ãƒ‡ãƒ¼ã‚¿ã€ã‚‚æ¢ã™ï¼ˆç§»è¡Œç”¨ï¼‰
        const savedStateRaw = localStorage.getItem('tournamentState');
        
        let loadedData = null;

        // A. åœ§ç¸®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ -> è§£å‡ã—ã¦ãƒ­ãƒ¼ãƒ‰
        if (savedStateCompressed) {
            try {
                loadedData = decompressData(savedStateCompressed);
            } catch(e) {
                console.error("åœ§ç¸®ãƒ‡ãƒ¼ã‚¿ã®è§£å‡ã«å¤±æ•—:", e);
            }
        } 
        // B. åœ§ç¸®ãƒ‡ãƒ¼ã‚¿ãŒãªãã€æ—§ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ -> ãã®ã¾ã¾ãƒ­ãƒ¼ãƒ‰
        else if (savedStateRaw) {
            try {
                loadedData = JSON.parse(savedStateRaw);
                console.log("æ—§å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚æ¬¡å›ä¿å­˜æ™‚ã«åœ§ç¸®ã•ã‚Œã¾ã™ã€‚");
            } catch(e) {
                console.error("æ—§ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:", e);
            }
        }

        // --- 3. ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®å¾©å¸°å‡¦ç† ---
        if (loadedData && loadedData.tournamentYear) {
            try {
                const confirmed = await showConfirm("å‰å›ã®ç¶šãã‹ã‚‰å†é–‹ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã€Œã„ã„ãˆã€ã§æœ€åˆã‹ã‚‰ã€ã¾ãŸã¯ã€Œåˆã„è¨€è‘‰ã€ã§å†é–‹ï¼‰");
                
                if (confirmed) { 
                    // --- [ã¯ã„] ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨ã—ã¦å†é–‹ ---
                    tournamentState = loadedData;

                    // ç”²å­åœ’ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒï¼ˆãƒ€ãƒŸãƒ¼ãƒãƒ¼ãƒ ç­‰ã®å†è¨­å®šï¼‰
                    if (tournamentState.currentTournament === 'summer_koshien') {
                        restoreKoshienData(tournamentState.teams);
                    }

                    // --- å¤ã„ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¸ã®ã€Œäº’æ›æ€§ãƒ‘ãƒƒãƒã€ ---
                    if (tournamentState.teamRecords) {
                        for (const teamName in tournamentState.teamRecords) {
                            const record = tournamentState.teamRecords[teamName];
                            
                            // ãƒãƒ¼ãƒ æ‰“ç‡(tournamentStats)ãŒãªã‘ã‚Œã°åˆæœŸåŒ–
                            if (!record.tournamentStats) {
                                record.tournamentStats = { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0 };
                            }
                            // ãƒ­ã‚¹ã‚¿ãƒ¼(roster)ãŒãªã‘ã‚Œã°åˆæœŸåŒ–
                            if (!record.roster) {
                                record.roster = null;
                            }
                        }
                    }
                    // å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆ(preGameComments)ãŒãªã‘ã‚Œã°åˆæœŸåŒ–
                    if (!tournamentState.preGameComments) {
                        tournamentState.preGameComments = {};
                    }
                    // ã¾ã¨ã‚ã‚¹ãƒ¬ãƒƒãƒ‰(matomeThreads)ãŒãªã‘ã‚Œã°åˆæœŸåŒ–
                    if (!tournamentState.matomeThreads) {
                        tournamentState.matomeThreads = {};
                    }
                    // SNSãƒ­ã‚°ãŒãªã‘ã‚Œã°åˆæœŸåŒ–
                    if (!tournamentState.snsLogs) {
                        tournamentState.snsLogs = [];
                    }

                    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
                    setupEl.classList.add('hidden');
                    tournamentDisplayEl.classList.remove('hidden');
                    renderTournament(tournamentState);
                    
                    // ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–è¡¨ç¤ºã®æ›´æ–°
                    updateAutosaveDisplay();
                    return; // åˆæœŸåŒ–çµ‚äº†

                } else { 
                    // --- [ã„ã„ãˆ] ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒˆãƒƒãƒ—ã¸ ---
                    localStorage.removeItem('tournamentState');            // æ—§ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
                    localStorage.removeItem('tournamentState_compressed'); // æ–°ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
                }
            } catch (e) {
                console.error("ãƒ‡ãƒ¼ã‚¿å¾©å…ƒãƒ—ãƒ­ã‚»ã‚¹ä¸­ã«ã‚¨ãƒ©ãƒ¼:", e);
                alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆæœŸçŠ¶æ…‹ã«æˆ»ã‚Šã¾ã™ã€‚");
                localStorage.removeItem('tournamentState');
                localStorage.removeItem('tournamentState_compressed');
            }
        }

        // --- 4. æ–°è¦é–‹å§‹ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€é¸æŠæ™‚ï¼‰ ---
        setupEl.classList.remove('hidden');
        tournamentDisplayEl.classList.add('hidden');
        
        if (teamsTextarea) {
            teamsTextarea.value = INITIAL_TEAM_POOL.join('\n');
        }

        updateTicker();
        updateAutosaveDisplay();
    }

    // --- Event Listeners ---
    
    generateBtn.addEventListener('click', async () => {
    const confirmed = await showConfirm("æ–°ã—ã„ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’é–‹å§‹ã™ã‚‹ã¨ã€ç¾åœ¨ã®é€²è¡ŒçŠ¶æ³ã¯å¤±ã‚ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
    if (confirmed) startLotteryEvent();
});
    resumeBtn.addEventListener('click', () => {
        saveLoadModal.classList.remove('hidden');
        loadTabBtn.click();
    });

    nextTournamentBtn.addEventListener('click', async () => {
        const confirmed = await showConfirm("ç¾åœ¨ã®å¤§ä¼šã‚’çµ‚äº†ã—ã€æ¬¡ã®å¤§ä¼šã¸é€²ã¿ã¾ã™ã‹ï¼Ÿ");
        if(confirmed) {

await updateNarrativesWithAI(tournamentState);

            let nextTournamentType;
            
            // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€: ç”²å­åœ’ -> ç§‹å¤§ä¼š ã®é·ç§»ã‚’è¿½åŠ  â˜…â˜…â˜…
            if (tournamentState.currentTournament === 'summer') {
                 // (é€šå¸¸ã¯ã“ã“ã§ç”²å­åœ’ã«è¡Œã‹ãšç§‹ã«è¡Œãå ´åˆã‚‚ã‚ã‚‹ãŒã€
                 // processMatchWinã§è‡ªå‹•ç§»è¡Œã—ãªã‹ã£ãŸå ´åˆã®äºˆå‚™ã¨ã—ã¦)
                 nextTournamentType = 'autumn';
            }
            else if (tournamentState.currentTournament === 'summer_koshien') {
                 nextTournamentType = 'autumn';
            }
            else if (tournamentState.currentTournament === 'autumn') {
                 nextTournamentType = 'spring';
            }
            else { // spring -> summer
                 nextTournamentType = 'summer';
            }
            // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…
            
            createNewTournament(true, nextTournamentType);
        }
    });

    resetBtn.addEventListener('click', async () => {
        const confirmed = await showConfirm("ã™ã¹ã¦ã®å¤§ä¼šè¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã€æœ€åˆã®çŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ");
        if(confirmed){
            localStorage.clear();
            location.reload();
        }
    });

        
    startRankingPlayoffsBtn.addEventListener('click', async () => {
         const confirmed = await showConfirm("å…¨ãƒ–ãƒ­ãƒƒã‚¯ã®äºˆé¸ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚åœ°åŒºå†…é †ä½æ±ºå®šæˆ¦ã«é€²ã¿ã¾ã™ã‹ï¼Ÿ");
         if(confirmed) setupAutumnRankingTournaments();
    });
    
    // startMainTournamentBtn ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å†…

startMainTournamentBtn.addEventListener('click', async () => {
    // â˜…â˜…â˜… æ˜¥å­£å¤§ä¼šç”¨ã®åˆ†å²ã‚’è¿½åŠ  â˜…â˜…â˜…
    if (tournamentState.currentTournament === 'spring') {
        const confirmed = await showConfirm("å…¨ä»£è¡¨æ ¡ãŒæ±ºå®šã—ã¾ã—ãŸã€‚çœŒå¤§ä¼šæœ¬æˆ¦ã«é€²ã¿ã¾ã™ã‹ï¼Ÿ");
        if (confirmed) setupSpringMainTournament_Round1();
    } 
    // â˜…â˜…â˜… ã“ã“ã¾ã§è¿½åŠ  â˜…â˜…â˜…
    else { // ç§‹å­£å¤§ä¼šã®æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯
        const confirmed = await showConfirm("å…¨ä»£è¡¨æ ¡ãŒæ±ºå®šã—ã¾ã—ãŸã€‚çœŒå¤§ä¼šæœ¬æˆ¦ã«é€²ã¿ã¾ã™ã‹ï¼Ÿ");
        if (confirmed) setupAutumnMainTournament();
    }
});
// --- ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ãƒ»ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å®£è¨€ ---
    
    skipR1Btn.addEventListener('click', async () => {
        const confirmed = await showConfirm("1å›æˆ¦ã‚’è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
        if (confirmed) skipRound(1);
    });
    skipR2Btn.addEventListener('click', async () => {
        const confirmed = await showConfirm("2å›æˆ¦ã‚’è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
        if (confirmed) skipRound(2);
    });
    skipR3Btn.addEventListener('click', async () => {
        const confirmed = await showConfirm("3å›æˆ¦ã‚’è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
        if (confirmed) skipRound(3);
    });

skipR4Btn.addEventListener('click', async () => {
    const confirmed = await showConfirm("4å›æˆ¦ã‚’è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
    if (confirmed) skipRound(4);
});

skipR5Btn.addEventListener('click', async () => {
    const confirmed = await showConfirm("æº–ã€…æ±ºå‹ã‚’è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
    if (confirmed) skipRound(5);
});

skipR6Btn.addEventListener('click', async () => {
    const confirmed = await showConfirm("æº–æ±ºå‹ã‚’è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
    if (confirmed) skipRound(6);
});

skipFinalBtn.addEventListener('click', async () => {
    const confirmed = await showConfirm("æ±ºå‹æˆ¦ã‚’è‡ªå‹•ã§é€²è¡Œã—ã¾ã™ã‹ï¼Ÿ");
    if (confirmed) skipFinal();
});


    generateSummaryBtn.addEventListener('click', async () => {
        generateSummaryBtn.disabled = true;
        generateSummaryBtn.textContent = 'è¨˜äº‹ã‚’ç”Ÿæˆä¸­...';
        newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒæº–ã€…æ±ºå‹ã®å±•æœ›è¨˜äº‹ã‚’åŸ·ç­†ä¸­...</div>`;
        
        // â˜…â˜…â˜… æ–°ã—ã„é–¢æ•°ã‚’å‘¼ã³å‡ºã™ â˜…â˜…â˜…
        const summaryArticle = await generateBest16PreviewArticle();
        // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

        if (summaryArticle) {
            tournamentState.news.push(summaryArticle);
            saveState();
            renderNews(tournamentState.news);
        }
        generateSummaryBtn.classList.add('hidden');
        generateSummaryBtn.disabled = false;
        generateSummaryBtn.textContent = 'æº–ã€…æ±ºå‹ å±•æœ›è¨˜äº‹ã‚’ç”Ÿæˆ';
    });


/**
 * [NEW] 283å­¦åœ’ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ç”¨ã®ã€ŒãŠçŸ¥ã‚‰ã›ã€è¨˜äº‹ã‚’AIã«ç”Ÿæˆã•ã›ã‚‹
 * @param {object} matchContext - è©¦åˆã®å…¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
 * @returns {Promise<object|null>} - { title, body, timestamp }
 */
async function generateHomepageNewsUpdate(matchContext) {
    const { winnerName, loserName, dbMatch, matchId, nextOpponent } = matchContext;
    
    // 283å­¦åœ’ãŒå‹ã£ãŸã‹ã©ã†ã‹
    const is283Match = (winnerName === "283å­¦åœ’" || loserName === "283å­¦åœ’");
    if (!is283Match) return null;
    
    const teamName = "283å­¦åœ’";
    const result = (winnerName === teamName) ? 'å‹åˆ©' : 'æ•—åŒ—';
    const opponentName = (winnerName === teamName) ? loserName : winnerName;
    const score = (winnerName === teamName) 
        ? `${dbMatch.score1} - ${dbMatch.score2}` 
        : `${dbMatch.score2} - ${dbMatch.score1}`;
    const roundName = getRoundNameFromMatchId(matchId);

    // 1. æˆ¦è©•ã®ç”Ÿæˆ
    let summary = dbMatch.summary || matchContext.highlights?.[0]?.description || "ç†±æˆ¦ãŒç¹°ã‚Šåºƒã’ã‚‰ã‚Œã¾ã—ãŸã€‚";
    if (result === 'æ•—åŒ—') {
        summary = `æƒœã—ãã‚‚${opponentName}ã«æ•—ã‚Œã€ä»Šå¤§ä¼šã®æŒ‘æˆ¦ã¯çµ‚äº†ã¨ãªã‚Šã¾ã—ãŸã€‚`;
    }

    // 2. æ¬¡ã®è©¦åˆæƒ…å ±ã®ç”Ÿæˆ
    let nextMatchText = "";
    if (result === 'å‹åˆ©' && nextOpponent) {
        if (nextOpponent.opponentName === 'å„ªå‹') {
            nextMatchText = "æ¬¡æˆ¦ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆçœŒå¤§ä¼šå„ªå‹ï¼‰ã€‚ãŸãã•ã‚“ã®ã”å£°æ´ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼";
        } else {
            const opponent = nextOpponent.decidingMatch 
                ? `${nextOpponent.decidingMatch.team1} ã¨ ${nextOpponent.decidingMatch.team2} ã®å‹è€…`
                : (nextOpponent.opponentName || 'ï¼ˆæœªå®šï¼‰');
            
            const schedule = nextOpponent.nextMatchSchedule;
            const location = schedule?.stadiumFull || 'æœªå®š';
            const date = schedule?.date || 'æœªå®š';
            const gameNum = schedule?.game ? `ç¬¬${schedule.game}è©¦åˆ` : '';

            nextMatchText = `æ¬¡æˆ¦ï¼ˆ${nextOpponent.roundName}ï¼‰ã¯ã€${opponent}ã¨å¯¾æˆ¦ã—ã¾ã™ã€‚\n` +
                            `æ—¥æ™‚: ${date} ${gameNum}\n` +
                            `å ´æ‰€: ${location}\n\n` +
                            `å¼•ãç¶šãã®ã”å£°æ´ã‚’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;
        }
    } else if (result === 'æ•—åŒ—') {
        nextMatchText = "çš†æ§˜ã®ç†±ã„å£°æ´ãŒã€é¸æ‰‹ã®åŠ›ã¨ãªã‚Šã¾ã—ãŸã€‚å¿ƒã‚ˆã‚Šæ„Ÿè¬ç”³ã—ä¸Šã’ã¾ã™ã€‚\næ–°ãƒãƒ¼ãƒ ã§ã®å†èµ·ã«ã”æœŸå¾…ãã ã•ã„ã€‚";
    }

    // 3. AIã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é€ä¿¡
    const prompt = `ã‚ãªãŸã¯ã€Œ283å­¦åœ’ã€é‡çƒéƒ¨ã®åºƒå ±æ‹…å½“è€…ã§ã™ã€‚
ä»¥ä¸‹ã®è©¦åˆçµæœãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€å­¦åœ’ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«æ²è¼‰ã™ã‚‹ã€ŒãŠçŸ¥ã‚‰ã›ã€è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’ã€ä¸å¯§ãªã€Œã§ã™ãƒ»ã¾ã™èª¿ã€ã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### è©¦åˆãƒ‡ãƒ¼ã‚¿
- **å¤§ä¼šå:** ${tournamentNameMap[tournamentState.currentTournament] || 'å¤§ä¼š'} ${roundName}
- **è‡ªãƒãƒ¼ãƒ :** ${teamName}
- **å¯¾æˆ¦ç›¸æ‰‹:** ${opponentName}
- **çµæœ:** ${teamName} ã® ${result}
- **ã‚¹ã‚³ã‚¢:** ${score}
- **ç°¡å˜ãªæˆ¦è©•(AIç”Ÿæˆ):** ${summary}
- **æ¬¡ã®è©¦åˆæƒ…å ±(ãƒ†ã‚­ã‚¹ãƒˆ):** ${nextMatchText}

### æŒ‡ç¤º
1.  **ã‚¿ã‚¤ãƒˆãƒ«:** ã€Œã€é‡çƒéƒ¨ã€‘ï¼ˆå¤§ä¼šå ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰ è©¦åˆçµæœã®ãŠçŸ¥ã‚‰ã›ã€ã¨ã„ã†å½¢å¼ã«ã—ã¦ãã ã•ã„ã€‚
2.  **æœ¬æ–‡:**
    - è©¦åˆãŒè¡Œã‚ã‚ŒãŸã“ã¨ã€å¯¾æˆ¦ç›¸æ‰‹ã€ã‚¹ã‚³ã‚¢ã€å‹æ•—ã‚’å ±å‘Šã—ã¦ãã ã•ã„ã€‚
    - ã€Œç°¡å˜ãªæˆ¦è©•ã€ã‚’è‡ªç„¶ãªæ–‡ç« ã«ç›´ã—ã¦æŒ¿å…¥ã—ã¦ãã ã•ã„ã€‚
    - æœ€å¾Œã«ã€Œæ¬¡ã®è©¦åˆæƒ…å ±ã€ã‚’ãã®ã¾ã¾æŒ¿å…¥ã—ã¦ãã ã•ã„ã€‚
    - å…¨ä½“ã‚’ã€ä¼æ¥­ã®å…¬å¼ç™ºè¡¨ã¨ã—ã¦ãµã•ã‚ã—ã„ã€ä¸å¯§ã§ãƒ•ã‚©ãƒ¼ãƒãƒ«ãªæ–‡ä½“ã«ã™ã‚‹ã“ã¨ã€‚

### å‡ºåŠ›å½¢å¼ (JSON)
{"title": "ï¼ˆã“ã“ã«è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼‰", "body": "ï¼ˆã“ã“ã«è¨˜äº‹ã®æœ¬æ–‡ã€æ”¹è¡Œã¯\\nã‚’ä½¿ç”¨ï¼‰"}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const rawText = result.candidates[0].content.parts[0].text;
            const newsJson = parseJsonFromText(rawText);
            if (newsJson && newsJson.title && newsJson.body) {
                return { ...newsJson, timestamp: Date.now() };
            }
        }
        throw new Error("AIã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã—ãŸå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    } catch (error) {
        console.error("283å­¦åœ’ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        return {
            title: "è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼",
            body: "AIåºƒå ±æ‹…å½“è€…ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
            timestamp: Date.now(),
            error: true
        };
    }
}

document.getElementById('contribution-close-btn').addEventListener('click', () => {

    // 1. è²¢çŒ®åº¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éš ã™å‡¦ç†

    document.getElementById('contribution-modal').classList.add('hidden');

    document.getElementById('contribution-modal').classList.remove('flex');



    // 2. â˜… Chart.jsã®ã‚°ãƒ©ãƒ•è¦ç´ ã‚’ç ´æ£„ã—ã€ãƒ¡ãƒ¢ãƒªã‚’è§£æ”¾ã™ã‚‹

    const pieChart = Chart.getChart('rc-pie-chart');

    const barChart = Chart.getChart('rc-bar-chart');

    const scatterChart = Chart.getChart('stellar-scatter-chart');

    

    if (pieChart) pieChart.destroy();

    if (barChart) barChart.destroy();

    if (scatterChart) scatterChart.destroy();



    // 3. é–‰ã˜ãŸéš›ã«ã€è²¢çŒ®åº¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆã‚°ãƒ©ãƒ•ï¼‰ã‚’éš ã™

    document.getElementById('contribution-content').classList.add('hidden');

});


document.body.addEventListener('click', async (e) => {




    // --- è©¦åˆé€²è¡Œãƒœã‚¿ãƒ³ (â–¶) ---
    if (e.target.matches('.win-btn')) {
        const teamSlot = e.target.closest('.team-slot');
        const matchEl = e.target.closest('[data-match-id]');
        if (!teamSlot || !matchEl || teamSlot.classList.contains('empty')) return;

        const matchId = matchEl.dataset.matchId;
        const winnerName = teamSlot.dataset.teamName;
        if (!winnerName) return;

        const score1El = matchEl.querySelector('[data-team-pos="1"]');
        const score2El = matchEl.querySelector('[data-team-pos="2"]');

        if(!score1El || !score2El || score1El.value === '' || score2El.value === '') {
            showAlert('ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        let dbMatch = findMatchById(matchId);
        if (dbMatch) {
            dbMatch.score1 = score1El.value;
            dbMatch.score2 = score2El.value;
            dbMatch.summary = matchEl.querySelector('.match-summary-input')?.value || '';
        }

        await processMatchWin(matchId, winnerName);
    }

// --- ä½œæˆ¦ãƒœãƒ¼ãƒ‰ã‚’é–‹ããƒœã‚¿ãƒ³ ---
    else if (e.target.closest('.open-lineup-manager-btn')) {
        e.preventDefault();
        const btn = e.target.closest('.open-lineup-manager-btn');
        openLineupManager(btn.dataset.matchId, btn.dataset.teamKey);
    }

    // --- ã€Œå‹¢åŠ›å›³ã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('.view-analysis-btn')) {
        document.getElementById('analysis-modal').classList.remove('hidden');
        currentBlock = 'A';
        playBlockAnimation(currentBlock);
    }
    
    // --- å‹¢åŠ›å›³ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('.analysis-block-tab-btn')) {
        const blockId = e.target.dataset.block;
        if (blockId && blockId !== currentBlock) {
            currentBlock = blockId;
            playBlockAnimation(blockId);
        }
    }
    
    // --- å‹¢åŠ›å›³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('#analysis-modal-close-btn')) {
        document.getElementById('analysis-modal').classList.add('hidden');
    }

    // --- è©¦åˆè©³ç´°å…¥åŠ›ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('.details-btn')) {
        openDetailsModal(e.target.dataset.matchId);
    }

    // --- ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã€‘ã‚¤ãƒ‹ãƒ³ã‚°è¿½åŠ ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('.add-inning-btn') || e.target.matches('#add-inning-score-btn')) {
        e.preventDefault();
        addExtraInning();
    }

    // --- ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã€‘å®ˆå‚™ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚’è¿½åŠ ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('.add-fielding-play-btn')) {
        e.preventDefault();
        const teamKey = e.target.dataset.teamKey;
        const fieldingTableEl = document.getElementById(`fielding-table-${teamKey}`);
        const battingTableEl = document.getElementById(`batting-table-${teamKey}`);
        
        if (!fieldingTableEl || !battingTableEl) {
            console.error(`ã‚¨ãƒ©ãƒ¼: ${teamKey} ã® fielding-table ã¾ãŸã¯ batting-table ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
            alert("è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ï¼šãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        
        const tableBody = fieldingTableEl.querySelector('tbody');
        const playersOnField = Array.from(battingTableEl.querySelectorAll('.player-name')).map(input => ({name: input.value.trim()})).filter(p => p.name);
        const playerOptions = playersOnField.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        
        const newRow = tableBody.insertRow();
        newRow.dataset.fieldingIndex = tableBody.rows.length;
        newRow.innerHTML = `
            <td class="w-16"><input type="number" class="fielding-inning" min="1"></td>
            <td>
                <select class="player-name w-full">
                    <option value="">- é¸æ‰‹ -</option>
                    ${playerOptions}
                </select>
            </td>
            <td><input type="text" class="fielding-play" placeholder="ä¾‹: ãƒ€ã‚¤ãƒ“ãƒ³ã‚°ã‚­ãƒ£ãƒƒãƒ"></td>
            <td class="w-12 text-center">
                <button class="remove-fielding-play-btn text-red-500 hover:text-red-700 font-bold text-lg leading-none p-1">Ã—</button>
            </td>
        `;
    }

    // --- ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã€‘å®ˆå‚™ãƒ•ã‚¡ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚’å‰Šé™¤ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('.remove-fielding-play-btn')) {
        e.preventDefault();
        e.target.closest('tr').remove();
    }

    // --- å¤©å€™ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('.weather-btn')) {
        const weatherType = e.target.dataset.weather;
        setWeather(weatherType);
    }

// â–¼â–¼â–¼ è¿½åŠ : ã‚¹ã‚«ã‚¦ãƒ†ã‚£ãƒ³ã‚°ãƒ¬ãƒãƒ¼ãƒˆé–²è¦§ãƒœã‚¿ãƒ³ â–¼â–¼â–¼
    if (e.target.closest('.scout-view-btn')) {
        e.preventDefault();
        const btn = e.target.closest('.scout-view-btn');
        const index = parseInt(btn.dataset.index, 10);
        const article = tournamentState.news[index];
        
        if (article && article.body) {
            const modal = document.getElementById('scout-report-view-modal');
            const bodyEl = document.getElementById('scout-report-view-body');
            
            // æœ¬æ–‡ã®æ”¹è¡Œã‚’åæ˜ ã—ã¦æµã—è¾¼ã‚€
            bodyEl.innerHTML = article.body.replace(/\n/g, '<br>');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ (ã‚¹ã‚«ã‚¦ãƒ†ã‚£ãƒ³ã‚°ãƒ¬ãƒãƒ¼ãƒˆ)
    if (e.target.closest('#scout-report-view-close')) {
        document.getElementById('scout-report-view-modal').classList.add('hidden');
        document.getElementById('scout-report-view-modal').classList.remove('flex');
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç† â–¼â–¼â–¼
    if (e.target.matches('.captain-btn')) {
        e.preventDefault();
        const btn = e.target;
        
        // æ—¢ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚‰OFFã«ã™ã‚‹ï¼ˆã‚­ãƒ£ãƒ—ãƒ†ãƒ³ãªã—ã®çŠ¶æ…‹ã‚‚è¨±å®¹ã™ã‚‹å ´åˆï¼‰
        if (btn.classList.contains('active')) {
            btn.classList.remove('active');
        } else {
            // åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒãƒ¼ãƒ ï¼‰å†…ã®ä»–ã®ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ãƒœã‚¿ãƒ³ã‚’å…¨ã¦OFFã«ã™ã‚‹
            const table = btn.closest('table');
            if (table) {
                table.querySelectorAll('.captain-btn.active').forEach(activeBtn => {
                    activeBtn.classList.remove('active');
                });
            }
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ONã«ã™ã‚‹
            btn.classList.add('active');
        }
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    // --- ã€Œãƒãƒ¼ãƒ é€šç®—æˆç¸¾ã€ãƒœã‚¿ãƒ³ï¼ˆãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã® ğŸ“Š ãƒœã‚¿ãƒ³ï¼‰ ---
    if (e.target.matches('.show-team-stats-btn')) {
        e.preventDefault();
        const teamName = e.target.dataset.teamName;
        if (!teamName) return;
        renderTeamStatsModal(teamName); // çµ±è¨ˆã‚¿ãƒ–ã®ä¸­èº«ã ã‘å…ˆã«æç”»
        document.getElementById('team-stats-modal').classList.remove('hidden');
        document.getElementById('team-stats-modal').classList.add('flex');
    }

    // --- ãƒãƒ¼ãƒ é€šç®—æˆç¸¾ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('#team-stats-modal-close')) {
        e.preventDefault();
        document.getElementById('team-stats-modal').classList.add('hidden');
        document.getElementById('team-stats-modal').classList.remove('flex');
    }

    // --- [æ–°æ©Ÿèƒ½] ãƒãƒ¼ãƒ é€šç®—æˆç¸¾ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
    if (e.target.matches('.team-stats-tab-btn')) {
        e.preventDefault();
        const btn = e.target;
        if (btn.classList.contains('active')) return;
        const modal = btn.closest('#team-stats-modal');
        const tabId = btn.dataset.tab;
        const teamName = modal.querySelector('#team-stats-modal-title').textContent.split(' ')[0];
        modal.querySelectorAll('.team-stats-tab-btn').forEach(b => b.classList.remove('active'));
        modal.querySelectorAll('.team-stats-tab-content').forEach(c => c.classList.add('hidden'));
        btn.classList.add('active');
        const contentEl = document.getElementById(`team-stats-tab-content-${tabId}`);
        contentEl.classList.remove('hidden');
        if (tabId === 'lineups') {
            if (contentEl.querySelector('.loader')) {
                renderStartingLineupHistory(teamName);
            }
        }
    }

// --- [NEW] æŠ•æ‰‹æˆç¸¾ã®è‡ªå‹•è¨ˆç®—ãƒœã‚¿ãƒ³ ---
        else if (e.target.closest('.calc-pitcher-stats-btn')) {
            e.preventDefault();
            const btn = e.target.closest('.calc-pitcher-stats-btn');
            
            // é€£æ‰“é˜²æ­¢ & ã‚¿ãƒƒãƒ—ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = "è¨ˆç®—ä¸­...";

            const pitchingTeamKey = btn.dataset.pitchingTeam;
            const battingTeamKey = btn.dataset.battingTeam;
            
            // éåŒæœŸå‡¦ç†ã‚’å®Ÿè¡Œ
            (async () => {
                try {
                    // è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯å‘¼ã³å‡ºã—
                    await fillPitcherStatsFromBatting(pitchingTeamKey, battingTeamKey);
                } catch (err) {
                    console.error("è‡ªå‹•è¨ˆç®—ã‚¨ãƒ©ãƒ¼:", err);
                    // ã‚¹ãƒãƒ›ã§ã‚‚ã‚¨ãƒ©ãƒ¼å†…å®¹ãŒã‚ã‹ã‚‹ã‚ˆã†ã«ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™
                    alert("è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n" + err.message);
                } finally {
                    // å‡¦ç†ãŒçµ‚ã‚ã£ãŸã‚‰ï¼ˆæˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšï¼‰ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            })();
        }
// --- [NEW] ã‚¤ãƒ‹ãƒ³ã‚°æ¬„ã‹ã‚‰ã®ã€Œä»£æ‰“ã€ãƒœã‚¿ãƒ³ ---
        else if (e.target.closest('.inning-add-sub-btn')) {
            e.preventDefault();
            const btn = e.target.closest('.inning-add-sub-btn');
            const teamKey = btn.dataset.teamKey;
            const inningIndex = parseInt(btn.dataset.inning, 10);
            const currentOrder = btn.dataset.order;
            const baseOrder = currentOrder.split('-')[0];
            const row = btn.closest('tr');
            const tableBody = row.closest('tbody');

            // 1. æœ¬æ¥ã®ã€Œ+ äº¤ä»£ã€ãƒœã‚¿ãƒ³ã‚’æ¢ã—ã¦ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
            // (â€»æ³¨: data-orderãŒ "1" ã‚„ "1-sub-1" ãªã©ã€å¯å¤‰ãªãŸã‚ã€
            // ã€€ã‚ªãƒªã‚¸ãƒŠãƒ«ã® "1" ã‚„ "2" ã‚’æŒã¤ãƒœã‚¿ãƒ³ã‚’æ¢ã™å¿…è¦ãŒã‚ã‚‹)
            // (â€»[data-order="${baseOrder}"] ã§ã€ "1" ã‚„ "2" ã®ã‚¹ã‚¿ãƒ¡ãƒ³è¡Œã®ãƒœã‚¿ãƒ³ã‚’æ¢ã™)
            const mainSubButton = tableBody.querySelector(`tr[data-order="${baseOrder}"] .add-sub-row-btn`);
            
            if (!mainSubButton) {
                console.error("ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ã€Œ+ äº¤ä»£ã€ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }
            
            // 2. ãƒ¡ã‚¤ãƒ³ã®ã€Œ+ äº¤ä»£ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æ–°ã—ã„è¡Œã‚’è¿½åŠ ã•ã›ã‚‹
            mainSubButton.click();

            // 3. æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸè¡Œï¼ˆï¼ãã®æ‰“é †ã®æœ€å¾Œã®è¡Œï¼‰ã‚’å–å¾—
            const allOrderRows = Array.from(tableBody.querySelectorAll(`tr[data-order^="${baseOrder}"]`));
            const newRow = allOrderRows[allOrderRows.length - 1];

            if (newRow) {
                // 4. æ–°ã—ã„è¡Œã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ã€ŒPH (ä»£æ‰“)ã€ã«è¨­å®š
                const subTypeSelect = newRow.querySelector('.sub-type-select');
                if (subTypeSelect) {
                    subTypeSelect.value = 'PH';
                }
                
                // 5. æ–°ã—ã„è¡Œã®ã€ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¤ãƒ‹ãƒ³ã‚°ã®ã‚»ãƒ«ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å½“ã¦ã‚‹
                const inningCell = newRow.querySelectorAll('td.col-inning')[inningIndex];
                if (inningCell) {
                    // ãã®ã‚»ãƒ«å†…ã®æœ€åˆã®å…¥åŠ›å¯èƒ½ãªè¦ç´ ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã™ã‚‹
                    const firstInput = inningCell.querySelector('select, input');
                    if (firstInput) {
                        firstInput.focus();
                    }
                }
            }
        }


// --- [NEW] ç°¡æ˜“å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã ---
    else if (e.target.closest('.scorecard-open-btn')) {
        e.preventDefault();
        openScorecardModal(e.target.closest('.scorecard-open-btn').dataset.matchId);
    }
    // --- [NEW] ç°¡æ˜“å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ ---
    else if (e.target.closest('#scorecard-close-btn')) {
        e.preventDefault();
        if (confirm("å…¥åŠ›å†…å®¹ã‚’ä¿å­˜ã›ãšã«é–‰ã˜ã¾ã™ã‹ï¼Ÿ")) {
            document.getElementById('scorecard-modal').classList.add('hidden');
            document.getElementById('scorecard-modal').classList.remove('flex');
            activeScorecardState = {};
        }
    }
    
    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ (é †åºå…¥ã‚Œæ›¿ãˆ) â˜…â˜…â˜…

    // --- [NEW] ç°¡æ˜“å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã€Œæ‰“ç‚¹ã€ã¾ãŸã¯ã€Œä½µæ®º/çŠ é£›/çŠ æ‰“ã€ãƒœã‚¿ãƒ³ (å„ªå…ˆåº¦ 1) ---
    else if (e.target.closest('.rbi-btn, .result-btn[data-action="out-dp"], .result-btn[data-action="out-sac-f"], .result-btn[data-action="out-sac-b"]')) {
        e.preventDefault();
        
        // 1. ã‚‚ã—ã€Œçµæœå…¥åŠ›å¾…ã¡(STEP 1)ã€ãªã‚‰ã€ã¾ãšçµæœã‚’ã‚»ãƒƒãƒˆ
        if (activeScorecardState.currentStep === "waiting_for_result") {
            const action = e.target.closest('button').dataset.action;
            if (action) {
                handleScorecardAction(action); // ã“ã‚Œã§ pendingPlay ãŒã‚»ãƒƒãƒˆã•ã‚Œã€stepãŒ "waiting_for_direction" ã«é€²ã‚€
                return; // ã“ã®ã‚¯ãƒªãƒƒã‚¯ã§ã®å‡¦ç†ã¯ã“ã“ã¾ã§
            }
        }
        
        // 2. ã‚‚ã—ã€Œæ‰“ç‚¹å…¥åŠ›å¾…ã¡(STEP 3)ã€ãªã‚‰ã€æ‰“ç‚¹ã‚’ã‚»ãƒƒãƒˆã—ã¦ãƒ—ãƒ¬ãƒ¼ç¢ºå®š
        if (activeScorecardState.currentStep === "waiting_for_rbi") {
            const btn = e.target.closest('button');
            const rbiValue = btn.dataset.rbi; // "0", "1", "2"...
            
            // (ä½µæ®ºãƒ»çŠ é£›ãƒ»çŠ æ‰“ã¯ data-rbi å±æ€§ã‚’æŒãŸãªã„ã®ã§ã€actionã‹ã‚‰åˆ¤æ–­)
            const action = btn.dataset.action;
            if (action === 'out-dp') activeScorecardState.pendingPlay.rbi = 'dp';
            else if (action === 'out-sac-f') activeScorecardState.pendingPlay.rbi = 'sf';
            else if (action === 'out-sac-b') activeScorecardState.pendingPlay.rbi = 'sh';
            else activeScorecardState.pendingPlay.rbi = rbiValue; // "0", "1" ãªã©
            
            processPlay(); // ãƒ—ãƒ¬ãƒ¼ã‚’ç¢ºå®š
        }
    }

    // --- [NEW] ç°¡æ˜“å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã€Œçµæœã€ã¾ãŸã¯ã€Œèµ°å¡ã€ãƒœã‚¿ãƒ³ (å„ªå…ˆåº¦ 2) ---
    // (ä½µæ®ºãƒ»çŠ é£›ãƒ»çŠ æ‰“ãƒœã‚¿ãƒ³ã¯ä¸Šã®ifã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã¯ãã‚Œä»¥å¤–ãŒå¯¾è±¡)
    else if (e.target.closest('.result-btn')) {
        e.preventDefault();
        // action ã¯ 'hit-1b' ã‚„ 'run-sb' ãªã©
        handleScorecardAction(e.target.closest('.result-btn').dataset.action);
    }
    
    // --- [NEW] ç°¡æ˜“å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã€Œæ‰“çƒæ–¹å‘ã€ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ ---
    else if (e.target.closest('.direction-hotspot')) {
        e.preventDefault();
        if (activeScorecardState.currentStep !== "waiting_for_direction") return;
        
        const direction = e.target.closest('.direction-hotspot').dataset.direction;
        activeScorecardState.pendingPlay.direction = direction; // æ–¹å‘ã‚’ã‚»ãƒƒãƒˆ
        
        // â˜… æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ‰“ç‚¹å…¥åŠ›ï¼‰ã¸
        activeScorecardState.currentStep = "waiting_for_rbi";
        renderScorecard(); // UIã‚’ã€Œæ‰“ç‚¹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã€ã«æ›´æ–°
    }

    // --- [NEW] ç°¡æ˜“å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã€Œãƒ©ãƒ³ãƒŠãƒ¼ã€ã‚¯ãƒªãƒƒã‚¯ (èµ°å¡å‡¦ç†) ---
    else if (e.target.closest('.base.runner')) {
        e.preventDefault();
        const state = activeScorecardState;
        if (!state.currentStep.startsWith("waiting_for_runner_")) return;

        const baseEl = e.target.closest('.base.runner');
        let baseIndex = -1; // 0=1B, 1=2B, 2=3B
        if (baseEl.id === 'base-1b') baseIndex = 0;
        else if (baseEl.id === 'base-2b') baseIndex = 1;
        else if (baseEl.id === 'base-3b') baseIndex = 2;
        
        if (baseIndex === -1 || !state.runners[baseIndex]) return; // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå¡ã«ãƒ©ãƒ³ãƒŠãƒ¼ãŒã„ãªã„

        const runnerName = state.runners[baseIndex];
        let resultString = "";
        let newOuts = state.outs;
        
        if (state.currentStep === "waiting_for_runner_sb") {
            // ç›—å¡
            if (baseIndex === 2) { // 3å¡ãƒ©ãƒ³ãƒŠãƒ¼
                state.runners[2] = null;
                state.score[state.topBottom === 'è¡¨' ? 'team1' : 'team2']++; // ãƒ›ãƒ¼ãƒ ã‚¹ãƒãƒ¼ãƒ«
                resultString = `${runnerName} ãƒ›ãƒ¼ãƒ ã‚¹ãƒãƒ¼ãƒ«æˆåŠŸ`;
            } else if (baseIndex === 1) { // 2å¡ãƒ©ãƒ³ãƒŠãƒ¼
                state.runners[1] = null;
                state.runners[2] = runnerName;
                resultString = `${runnerName} ç›—å¡ (ä¸‰å¡ã¸)`;
            } else { // 1å¡ãƒ©ãƒ³ãƒŠãƒ¼
                state.runners[0] = null;
                state.runners[1] = runnerName;
                resultString = `${runnerName} ç›—å¡ (äºŒå¡ã¸)`;
            }
        } 
        else if (state.currentStep === "waiting_for_runner_cs") {
            // ç›—å¡æ­»
            state.runners[baseIndex] = null;
            newOuts++;
            resultString = `${runnerName} ç›—å¡æ­»`;
        }
        else if (state.currentStep === "waiting_for_runner_out") {
            // èµ°å¡æ­»
            state.runners[baseIndex] = null;
            newOuts++;
            resultString = `${runnerName} èµ°å¡æ­»`;
        }

        // ãƒ­ã‚°ã‚’è¨˜éŒ² (æ‰“å¸­ã¨ã¯ç‹¬ç«‹ã—ãŸãƒ—ãƒ¬ãƒ¼ã¨ã—ã¦)
        state.playLog.push({
            inning: state.inning,
            topBottom: state.topBottom,
            batterName: `(èµ°è€… ${runnerName})`,
            batterOrder: '-',
            resultString: resultString,
            outs: newOuts
        });
        state.outs = newOuts; // ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°

        // 3ã‚¢ã‚¦ãƒˆã«ãªã£ãŸã‹ï¼Ÿ
        if (state.outs >= 3) {
            if (state.topBottom === 'è¡¨') {
                state.topBottom = 'è£';
            } else {
                state.topBottom = 'è¡¨';
                state.inning++;
            }
            state.outs = 0;
            state.runners = [null, null, null];
        }

        // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        state.currentStep = "waiting_for_result";
        renderScorecard();
    }
    
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    // --- [NEW] ç°¡æ˜“å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¿å­˜ãƒœã‚¿ãƒ³ ---
    else if (e.target.closest('#scorecard-save-btn')) {
        e.preventDefault();
        saveScorecardAndClose();
    }
    // --- [NEW] ç°¡æ˜“å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ ---
    else if (e.target.closest('#scorecard-undo-btn')) {
        e.preventDefault();
        alert("ã€Œ1ãƒ—ãƒ¬ãƒ¼æˆ»ã™ã€æ©Ÿèƒ½ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚");
    }
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
// --- [NEW] (ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸å†…) ã‚¹ãƒãƒ›ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é–‹é–‰ ---
    else if (e.target.closest('#mobile-menu-button')) {
        e.preventDefault();
        const menu = document.getElementById('mobile-menu');
        menu.classList.toggle('hidden');
    }
    // --- [NEW] (ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸å†…) ã‚¹ãƒãƒ›ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯æ™‚ã«é–‰ã˜ã‚‹ ---
    else if (e.target.closest('.mobile-nav-link')) {
        const menu = document.getElementById('mobile-menu');
        menu.classList.add('hidden');
    }
// â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// --- [NEW] (ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸å†…) ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ»ãƒãƒƒãƒ— ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ ---
    else if (e.target.closest('.hotspot')) {
        e.preventDefault();
        const hotspot = e.target.closest('.hotspot');
        const popup = document.getElementById('hotspot-popup');
        const dataId = hotspot.dataset.id;
        const data = FACILITY_DATA[dataId];

        if (!data || !popup) return;

        // 1. ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«æ³¨å…¥
        document.getElementById('hotspot-popup-title').textContent = data.title;
        document.getElementById('hotspot-popup-text').textContent = data.text;
        document.getElementById('hotspot-popup-image').src = data.imgSrc;
        
        // 2. ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ä½ç½®ã‚’ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆã®è¿‘ãã«èª¿æ•´
        const hotspotRect = hotspot.getBoundingClientRect();
        const mapRect = document.getElementById('campus-map-container').getBoundingClientRect();
        
        // ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆã®ã€Œãƒãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®ã€ç›¸å¯¾Yåº§æ¨™
        const hotspotYInMap = hotspotRect.top - mapRect.top; 
        
        // ãƒãƒƒãƒ—ã®ä¸‹åŠåˆ†ã«ã‚ã‚‹å ´åˆã¯ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ã€Œä¸Šã€ã«ã€ä¸ŠåŠåˆ†ãªã‚‰ã€Œä¸‹ã€ã«å‡ºã™
        if (hotspotYInMap > (mapRect.height / 2)) {
            popup.style.top = 'auto';
            popup.style.bottom = `${mapRect.height - hotspotYInMap + 20}px`; // ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆã®çœŸä¸Š (20pxã‚ªãƒ•ã‚»ãƒƒãƒˆ)
        } else {
            popup.style.top = `${hotspotYInMap + hotspotRect.height + 20}px`; // ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆã®çœŸä¸‹ (20pxã‚ªãƒ•ã‚»ãƒƒãƒˆ)
            popup.style.bottom = 'auto';
        }
        
        // Xåº§æ¨™ã¯ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆã®å·¦ç«¯ã«åˆã‚ã›ã‚‹ (CSSã®transformã¯ä½¿ã‚ãªã„æ–¹ãŒã‚·ãƒ³ãƒ—ãƒ«)
        popup.style.left = `${hotspot.offsetLeft}px`;
        // transform ã‚’ãƒªã‚»ãƒƒãƒˆ
        popup.style.transform = 'translateY(-10px)'; // ä¸Šã«æµ®ãä¸ŠãŒã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨

        // 3. è¡¨ç¤º
        popup.classList.remove('hidden');
        // 'visible' ã‚¯ãƒ©ã‚¹ã‚’å°‘ã—é…ã‚Œã¦è¿½åŠ ã—ã¦CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç™ºç«
        setTimeout(() => popup.classList.add('visible'), 10);
    }
    
    // --- [NEW] (ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸å†…) ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆãƒ»ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹ ---
    else if (e.target.closest('#hotspot-popup-close-btn')) {
        e.preventDefault();
        const popup = document.getElementById('hotspot-popup');
        popup.classList.remove('visible');
        popup.style.transform = 'translateY(0)'; // å…ƒã®ä½ç½®ã«æˆ»ã‚‹
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒçµ‚ã‚ã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰éš ã™
        setTimeout(() => popup.classList.add('hidden'), 300);
    }
// â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// â–¼â–¼â–¼ [NEW] ã‚¹ãƒ¬ç«‹ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ããƒœã‚¿ãƒ³ â–¼â–¼â–¼
    else if (e.target.closest('#open-new-thread-modal-btn')) {
        e.preventDefault();
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('new-thread-title').value = '';
        document.getElementById('new-thread-comment').value = '';
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        document.getElementById('new-thread-modal').classList.remove('hidden');
    }
    // â–²â–²â–² æŒ¿å…¥ã“ã“ã¾ã§ â–²â–²â–²
// â–¼â–¼â–¼ [NEW] ã‚¹ãƒ¬ç«‹ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ (ã‚­ãƒ£ãƒ³ã‚»ãƒ«) â–¼â–¼â–¼
    else if (e.target.closest('#new-thread-cancel')) {
        e.preventDefault();
        document.getElementById('new-thread-modal').classList.add('hidden');
    }

/// --- [NEW] 283å­¦åœ’ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ããƒœã‚¿ãƒ³ ---
   else if (e.target.closest('#status-modal-homepage-link')) {
        e.preventDefault();
        const modalId = e.target.closest('#status-modal-homepage-link').dataset.target;
        if (modalId === 'homepage-modal') {
            
            // 1. æœ€æ–°ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚’æç”»
            const homepageBracketPlaceholder = document.getElementById('current-tournament-bracket-container');
            if (homepageBracketPlaceholder) {
                const currentBracketHTML = generateHomepageBracketHTML(tournamentState);
                if(currentBracketHTML.trim() !== "") {
                    homepageBracketPlaceholder.innerHTML = currentBracketHTML;
                } else {
                    homepageBracketPlaceholder.innerHTML = '<p class="text-center text-gray-500">ï¼ˆãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆãŒã¾ã é–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰</p>';
                }
            }

            // 2. æœ€æ–°ã®ã€ŒãŠçŸ¥ã‚‰ã›ã€ã‚’å‹•çš„ã«æç”»
            const dynamicNewsListEl = document.getElementById('homepage-dynamic-news-list');
            if (dynamicNewsListEl) {
                const homepageNews = tournamentState.homepageNews || [];
                if (homepageNews.length > 0) {
                    dynamicNewsListEl.innerHTML = homepageNews.map(article => {
                        if (article.error) return '';
                        const bodyForAttr = article.body.replace(/\n/g, '&#10;').replace(/"/g, '&quot;');
                        
                        return `
                            <li class="border-b border-gray-200 pb-3 mb-3 last:border-b-0">
                                <span class="text-sm text-red-600 font-bold">NEW!</span>
                                <span class="text-sm text-gray-500">${new Date(article.timestamp).toLocaleDateString('ja-JP')}</span>
                                <p class-"font-semibold text-gray-800 hover:text-blue-600 cursor-pointer homepage-news-item" 
                                   data-article-body="${bodyForAttr}" 
                                   data-article-title="${article.title.replace(/"/g, '&quot;')}">
                                    ${article.title}
                                </p>
                            </li>
                        `;
                    }).join('');
                    dynamicNewsListEl.classList.remove('hidden');
                } else {
                    dynamicNewsListEl.innerHTML = '';
                    dynamicNewsListEl.classList.add('hidden');
                }
            }

            // â˜…â˜…â˜… 3. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã â˜…â˜…â˜…
            toggleHomepageModal(true);
            
            // ãƒãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯é–‰ã˜ãªã„ï¼ˆä¸Šã«é‡ã­ã‚‹ï¼‰
        }
    }
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

// --- [NEW] (ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸å†…) å‹•çš„ãŠçŸ¥ã‚‰ã›ã‚¯ãƒªãƒƒã‚¯ ---
    else if (e.target.closest('.homepage-news-item')) {
        e.preventDefault();
        const p = e.target.closest('p');
        const title = p.dataset.articleTitle;
        const body = p.dataset.articleBody.replace(/&#10;/g, '\n'); // æ”¹è¡Œã‚’å…ƒã«æˆ»ã™
        
        // æ—¢å­˜ã®ä¸€çƒé€Ÿå ±ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æµç”¨ã—ã¦è¡¨ç¤º
        const modal = document.getElementById('boxscore-modal');
        const modalTitle = document.getElementById('boxscore-modal-title');
        const modalBody = document.getElementById('boxscore-modal-body');
        
        modalTitle.textContent = title;
        // æœ¬æ–‡ã‚’ <pre> ã‚¿ã‚°ã§å›²ã‚€ã“ã¨ã§ã€\n ã®æ”¹è¡Œã‚’ãã®ã¾ã¾è¡¨ç¤ºã™ã‚‹
        modalBody.innerHTML = `<pre class="p-4 whitespace-pre-wrap leading-relaxed text-sm">${body}</pre>`;
        
        modal.classList.remove('modal-hidden');
        modal.classList.add('flex');
    }
// â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// â–¼ boxscore-btn ã®å‡¦ç†ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¿®æ­£ â–¼

// --- [ä¿®æ­£ç‰ˆ] è©¦åˆå¾Œ ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢è¡¨ç¤ºãƒœã‚¿ãƒ³ (ä¸€çƒé€Ÿå ±) ---
    // â˜…é‡è¤‡ã—ã¦ã„ã‚‹å ´åˆã¯ã€å¤ã„æ–¹ã‚’å‰Šé™¤ã—ã¦ã€ã“ã®ãƒ–ãƒ­ãƒƒã‚¯1ã¤ã«çµ±ä¸€ã—ã¦ãã ã•ã„
    else if (e.target.closest('.boxscore-btn')) {
        e.preventDefault();
        const btn = e.target.closest('.boxscore-btn');
        const matchId = btn.dataset.matchId;
        
        // è©¦åˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const dbMatch = findMatchById(matchId);
        
        if (!dbMatch || !dbMatch.details) {
            alert("è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }
        
        // HTMLã‚’å†ç”Ÿæˆï¼ˆã‚°ãƒ©ãƒ•ç”¨ã‚¿ã‚°ã‚’ç¢ºå®Ÿã«å«ã‚ã‚‹ãŸã‚ï¼‰
        const freshHtml = generateBoxScoreHTML(dbMatch);
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modal = document.getElementById('boxscore-modal');
        const modalTitle = document.getElementById('boxscore-modal-title');
        const modalBody = document.getElementById('boxscore-modal-body');
        
        // ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
        const roundName = getRoundNameFromMatchId(matchId);
        modalTitle.textContent = `ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢: ${dbMatch.team1} vs ${dbMatch.team2} (${roundName})`;
        
        // HTMLã‚’æ³¨å…¥
        modalBody.innerHTML = freshHtml;
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        modal.classList.remove('modal-hidden');
        modal.classList.remove('hidden'); 
        modal.classList.add('flex');

        // â–¼â–¼â–¼ ã‚°ãƒ©ãƒ•æç”»å‡¦ç†ï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰ â–¼â–¼â–¼
        setTimeout(() => {
            // 1. å‹ç‡ã‚°ãƒ©ãƒ• (Win Probability)
            const canvasProb = document.getElementById('win-prob-chart');
            if (canvasProb) {
                // â˜…ä¿®æ­£: getContext('2d') ã‚’å–å¾—ã™ã‚‹
                const ctxProb = canvasProb.getContext('2d');
                
                if (dbMatch.details && dbMatch.details.inningScore) {
                    const scores1 = dbMatch.details.inningScore.team1;
                    const scores2 = dbMatch.details.inningScore.team2;
                    const { labels, dataPoints } = calculateWinProbData(dbMatch.team1, dbMatch.team2, scores1, scores2, tournamentState, dbMatch);

                    renderWinProbChart(ctxProb, dbMatch.team1, dbMatch.team2, labels, dataPoints);
                }
            } else {
                console.warn("å‹ç‡ã‚°ãƒ©ãƒ•ã®CanvasãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (ID: win-prob-chart)");
            }

            // 2. ç†±ç‹‚åº¦ã‚°ãƒ©ãƒ• (Excitement)
            const canvasExcitement = document.getElementById('excitement-chart');
            if (canvasExcitement) {
                // â˜…ä¿®æ­£: getContext('2d') ã‚’å–å¾—ã™ã‚‹
                // ã“ã‚ŒãŒãªã„ã¨ createLinearGradient ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™
                const ctxExcitement = canvasExcitement.getContext('2d');

                const exData = calculateExcitementData(dbMatch);
                if (exData) {
                    renderExcitementChart(ctxExcitement, exData);
                    
                    // ãƒ©ãƒ³ã‚¯ãƒãƒƒã‚¸ã®æ›´æ–°
                    const badge = document.getElementById('excitement-rank-badge');
                    if (badge) {
                        badge.textContent = `ãƒ©ãƒ³ã‚¯: ${exData.rank}`;
                        if (exData.rank.startsWith('S')) {
                            badge.className = "text-xs bg-red-100 text-red-800 px-2 py-1 rounded font-bold border border-red-500";
                        } else if (exData.rank.startsWith('A')) {
                             badge.className = "text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded font-bold";
                        } else {
                            badge.className = "text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded";
                        }
                    }
                }
            } else {
                console.warn("ç†±ç‹‚åº¦ã‚°ãƒ©ãƒ•ã®CanvasãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (ID: excitement-chart)");
            }
        }, 300); // æç”»å¾…ã¡æ™‚é–“
    }

// --- [NEW] ãƒ©ãƒ³ã‚¯åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¤œç´¢ãƒœã‚¿ãƒ³ ---
    if (e.target.closest('.rank-filter-btn')) {
        e.preventDefault();
        const rank = e.target.closest('.rank-filter-btn').dataset.rank;
        
        // å…¨ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— (TEAM_DATAã«ã‚ã‚‹ã™ã¹ã¦ã®ãƒãƒ¼ãƒ )
        const allTeams = Object.keys(TEAM_DATA);
        
        // æŒ‡å®šã•ã‚ŒãŸãƒ©ãƒ³ã‚¯ã®ãƒãƒ¼ãƒ ã ã‘ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        const filteredTeams = allTeams.filter(teamName => {
            // calculateRanké–¢æ•°ã‚’ä½¿ã£ã¦ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯ã‚’åˆ¤å®š
            return calculateRank(teamName, tournamentState) === rank;
        });

        // åå‰é †ï¼ˆã‚ã„ã†ãˆãŠé †ï¼‰ã¾ãŸã¯åå·®å€¤é †ã«ã‚½ãƒ¼ãƒˆ
        filteredTeams.sort((a, b) => {
            const devA = TEAM_DATA[a].deviation || 50;
            const devB = TEAM_DATA[b].deviation || 50;
            return devB - devA; // åå·®å€¤ãŒé«˜ã„é †
        });

        if (filteredTeams.length > 0) {
            // æ—¢å­˜ã®æ¤œç´¢çµæœè¡¨ç¤ºé–¢æ•°ã‚’ä½¿ã£ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            showSearchResultsList(filteredTeams, `${rank}ãƒ©ãƒ³ã‚¯é«˜æ ¡ ä¸€è¦§`);
        } else {
            alert(`ç¾åœ¨ã€${rank}ãƒ©ãƒ³ã‚¯ã®ãƒãƒ¼ãƒ ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚`);
        }
    }

    // --- [NEW] 283å­¦åœ’ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ ---
   else if (e.target.closest('#homepage-modal-close')) {
        e.preventDefault();
        // â˜…â˜…â˜… 4. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ â˜…â˜…â˜…
        toggleHomepageModal(false);
    }
    // --- [NEW] (ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸å†…) ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢è¡¨ç¤ºãƒœã‚¿ãƒ³ ---
    else if (e.target.closest('#show-boxscore-btn-2024')) {
        e.preventDefault();
        const modal = document.getElementById('boxscore-modal');
        const modalBody = document.getElementById('boxscore-modal-body');
        
        // æ¶ç©ºã®ã‚¹ã‚³ã‚¢è¡¨HTMLã‚’ç”Ÿæˆ
        const boxScoreHtml = generate2024FinalBoxScore(); 
        
        document.getElementById('boxscore-modal-title').textContent = "ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢: 283å­¦åœ’ vs å¸¸è‘‰èŠå· (2024å¹´ æ±ºå‹)";
        modalBody.innerHTML = boxScoreHtml;
        modal.classList.remove('modal-hidden');
        modal.classList.add('flex'); // hidden ã§ã¯ãªã flex ã§è¡¨ç¤º
    }

    // --- [NEW] ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ ---
    else if (e.target.closest('#boxscore-modal-close')) {
        e.preventDefault();
        const modal = document.getElementById('boxscore-modal');
        modal.classList.add('modal-hidden');
        modal.classList.remove('flex');
    }

    // --- [NEW] (ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸å†…) å‹•çš„ãŠçŸ¥ã‚‰ã›ã‚¯ãƒªãƒƒã‚¯ ---
    else if (e.target.closest('#homepage-dynamic-news-list p')) {
        e.preventDefault();
        const p = e.target.closest('p');
        const title = p.dataset.articleTitle;
        const body = p.dataset.articleBody.replace(/&#10;/g, '\n'); // æ”¹è¡Œã‚’å…ƒã«æˆ»ã™
        
        // æ—¢å­˜ã®ä¸€çƒé€Ÿå ±ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æµç”¨ã—ã¦è¡¨ç¤º
        const modal = document.getElementById('boxscore-modal');
        const modalTitle = document.getElementById('boxscore-modal-title');
        const modalBody = document.getElementById('boxscore-modal-body');
        
        modalTitle.textContent = title;
        // æœ¬æ–‡ã‚’ <pre> ã‚¿ã‚°ã§å›²ã‚€ã“ã¨ã§ã€\n ã®æ”¹è¡Œã‚’ãã®ã¾ã¾è¡¨ç¤ºã™ã‚‹
        modalBody.innerHTML = `<pre class="p-4 whitespace-pre-wrap leading-relaxed text-sm">${body}</pre>`;
        
        modal.classList.remove('modal-hidden');
        modal.classList.add('flex');
    }

// â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    // â–¼â–¼â–¼ æ—¢å­˜ã®ã€Œ#new-thread-submitã€ã® else if ãƒ–ãƒ­ãƒƒã‚¯ã¨ã€ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã€Œç½®ãæ›ãˆã€ â–¼â–¼â–¼
    else if (e.target.closest('#new-thread-submit')) {
        e.preventDefault();
        
        // â˜… AIãŒå‹•ä½œä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¤ºã™
        const submitBtn = e.target.closest('#new-thread-submit');
        submitBtn.disabled = true;
        submitBtn.textContent = 'AIãŒãƒ¬ã‚¹ä½œæˆä¸­...';

        const title = document.getElementById('new-thread-title').value.trim();
        const comment = document.getElementById('new-thread-comment').value.trim();
        const fullUserText = `${title} ${comment}`; // â˜… ã‚¹ã‚­ãƒ£ãƒ³ç”¨ã®çµåˆãƒ†ã‚­ã‚¹ãƒˆ

        if (!title || !comment) {
            alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            submitBtn.disabled = false;
            submitBtn.textContent = 'ã‚¹ãƒ¬ã‚’ç«‹ã¦ã‚‹';
            return;
        }

        const threadId = 'user-' + Date.now();
        const timestamp = Date.now();

        // 1. è¨˜äº‹ä¸€è¦§ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã€Œè¨˜äº‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã‚’ä½œæˆ
        const threadArticle = {
            id: threadId,
            headline: title,
            type: 'game', // AIã‚¹ãƒ¬ã¨åŒã˜ 'game' ã‚¿ã‚¤ãƒ—ã¨ã—ã¦æ‰±ã†
            matchId: threadId, // matomeThreads ã¨ã®é€£æºã‚­ãƒ¼
            timestamp: timestamp,
            category: 'è‡ªã‚¹ãƒ¬' // å°‚ç”¨ã‚«ãƒ†ã‚´ãƒª
        };
        
        if (!tournamentState.userThreads) tournamentState.userThreads = [];
        tournamentState.userThreads.push(threadArticle);

        // 2. ã‚¹ãƒ¬ä¸»(>>1)ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
        const firstComment = {
            id: crypto.randomUUID(),
            personality: '1: é¢¨å¹ã‘ã°åç„¡ã— (ã‚¹ãƒ¬ä¸»)',
            text: comment,
            timestamp: timestamp,
            replies: []
        };
        
        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
        // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰é–¢é€£æƒ…å ±ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€AIç”¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
        
        const mentionedTeams = new Set();
        INITIAL_TEAM_POOL.forEach(team => {
            if (fullUserText.includes(team)) {
                mentionedTeams.add(team);
            }
        });

        let gameContext = ""; // AIã«æ¸¡ã™ãŸã‚ã®æƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆ
        if (mentionedTeams.size > 0) {
            // ãƒãƒ¼ãƒ æƒ…å ± (æ‰“ç‡, ç›—å¡, è»Œè·¡)
            mentionedTeams.forEach(teamName => {
                const teamData = TEAM_DATA[teamName];
                const teamRecord = tournamentState.teamRecords[teamName];
                const dynamicInfo = generateDynamicTeamInfo(teamName, teamData, teamRecord); 
                const fate = getTeamFateSummary(teamName);
                gameContext += `\n- **${teamName}**: ${dynamicInfo} (ä»Šå¤§ä¼šã®çŠ¶æ³: ${fate})\n`;
            });

            // é¸æ‰‹æƒ…å ± (Gamelog)
            // formatPlayerGamelogsForPrompt ã¯ã€Œè¨€åŠã•ã‚ŒãŸãƒãƒ¼ãƒ ã€ã«æ‰€å±ã™ã‚‹ã€Œè¨€åŠã•ã‚ŒãŸé¸æ‰‹ã€ã®ãƒ­ã‚°ã‚’è¿”ã™
            gameContext += formatPlayerGamelogsForPrompt(mentionedTeams, fullUserText);
        }
        
        // 4. AIã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆã•ã›ã‚‹ (â˜… gameContext ã‚’æ¸¡ã™)
        const aiComments = await generateUserThreadBbsComments(title, comment, gameContext);
        // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

        if (!tournamentState.matomeThreads) tournamentState.matomeThreads = {};
        
        // 5. ã‚¹ãƒ¬ä¸»ã®ã‚³ãƒ¡ãƒ³ãƒˆã¨AIã®ãƒ¬ã‚¹ã‚’çµåˆã—ã¦ä¿å­˜
        if (aiComments && Array.isArray(aiComments)) {
            tournamentState.matomeThreads[threadId] = {
                thread: [firstComment, ...aiComments], // â˜… AIã®ãƒ¬ã‚¹ã‚’çµåˆ
                context: { isUserThread: true, title: title } 
            };
        } else {
             // AIç”Ÿæˆå¤±æ•—æ™‚ã‚‚ã€ã‚¹ãƒ¬ä¸»ã®ã‚³ãƒ¡ãƒ³ãƒˆã ã‘ã§ã‚¹ãƒ¬ã¯ç«‹ã¦ã‚‹
            tournamentState.matomeThreads[threadId] = {
                thread: [firstComment], 
                context: { isUserThread: true, title: title } 
            };
             alert('AIã«ã‚ˆã‚‹ãƒ¬ã‚¹ã®è‡ªå‹•ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ä½œæˆã•ã‚Œã¾ã™ã€‚');
        }


        // 6. ä¿å­˜ã—ã¦UIã‚’æ›´æ–°
        saveState();
        document.getElementById('new-thread-modal').classList.add('hidden');
        
        // 7. ã¾ã¨ã‚ã‚µã‚¤ãƒˆã®è¨˜äº‹ä¸€è¦§ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
        const articlesContainer = document.getElementById('matome-articles-container');
        articlesContainer.innerHTML = `<div class="loader text-center py-8">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç«‹ã¦ã¦ã„ã¾ã™...</div>`;
        (async () => {
            const matomeHtml = await generateMatomeSiteHtml();
            articlesContainer.innerHTML = matomeHtml;
        })();

        // 8. ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å…ƒã«æˆ»ã™
        submitBtn.disabled = false;
        submitBtn.textContent = 'ã‚¹ãƒ¬ã‚’ç«‹ã¦ã‚‹';
    }
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

    // --- â˜…â˜…â˜… ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼THã‚¯ãƒªãƒƒã‚¯ï¼‰ â˜…â˜…â˜… ---
    if (e.target.matches('.sortable-header')) {
        e.preventDefault();
        const header = e.target.closest('.sortable-header');
        const modal = e.target.closest('#team-stats-modal');
        const tableType = header.dataset.tableType;
        const newSortKey = header.dataset.sortKey;
        const teamName = document.getElementById('team-stats-modal-title').textContent.split(' ')[0];
        let currentKey, currentDir;
        if (tableType === 'batting') {
            currentKey = modal.dataset.sortKeyBatting;
            currentDir = modal.dataset.sortDirBatting;
        } else {
            currentKey = modal.dataset.sortKeyPitching;
            currentDir = modal.dataset.sortDirPitching;
        }
        let newSortDir = 'desc';
        if (newSortKey === currentKey && currentDir === 'desc') {
            newSortDir = 'asc';
        }
        if (tableType === 'batting') {
            modal.dataset.sortKeyBatting = newSortKey;
            modal.dataset.sortDirBatting = newSortDir;
        } else {
            modal.dataset.sortKeyPitching = newSortKey;
            modal.dataset.sortDirPitching = newSortDir;
        }
        renderTeamStatsModal(teamName);
    }

    // --- ã€Œå€‹äººé€šç®—æˆç¸¾ã€ãƒœã‚¿ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼‰ ---
    if (e.target.matches('.show-player-stats-btn')) {
        e.preventDefault();
        const btn = e.target;
        const teamName = btn.dataset.teamName;
        const row = btn.closest('tr');
        const playerNameInput = row.querySelector('.player-name');
        if (!playerNameInput) { alert('ã‚¨ãƒ©ãƒ¼: é¸æ‰‹åå…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'); return; }
        const playerName = playerNameInput.value.trim();
        if (!playerName) { alert('é¸æ‰‹åãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }
        renderCareerStatsModal(playerName, teamName);
        document.getElementById('player-stats-modal').classList.remove('hidden');
        document.getElementById('player-stats-modal').classList.add('flex');
    }

    // --- å€‹äººé€šç®—æˆç¸¾ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('#player-stats-modal-close')) {
        e.preventDefault();
        document.getElementById('player-stats-modal').classList.add('hidden');
        document.getElementById('player-stats-modal').classList.remove('flex');
    }

    // --- ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã€‘ã€Œæ‰“é †ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã€ãƒœã‚¿ãƒ³ï¼ˆæŠ•æ‰‹ï¼‰ ---
    if (e.target.matches('.copy-pitchers-from-batting-btn')) {
        e.preventDefault();
        const teamKey = e.target.dataset.teamKey;
        const battingTable = document.getElementById(`batting-table-${teamKey}`);
        if (!battingTable) { alert('æ‰“æ’ƒãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'); return; }
        const pitchingTableBody = document.getElementById(`pitching-table-${teamKey}`)?.querySelector('tbody');
        if (!pitchingTableBody) { alert('æŠ•æ‰‹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'); return; }
        const pitchersInBatting = [];
        battingTable.querySelectorAll('tbody tr').forEach(row => {
            const posSelect = row.querySelector('.player-pos');
            const nameInput = row.querySelector('.player-name');
            const throwBatSelect = row.querySelector('.player-throw-bat');
            if (posSelect && posSelect.value === 'æŠ•' && nameInput && nameInput.value.trim() !== '') {
                pitchersInBatting.push({ name: nameInput.value.trim(), throwBat: throwBatSelect ? throwBatSelect.value : '' });
            }
        });
        if (pitchersInBatting.length === 0) {
            alert('æ‰“æ’ƒãƒ†ãƒ¼ãƒ–ãƒ«ã«ã€ŒæŠ•ã€ã¨è¨­å®šã•ã‚ŒãŸé¸æ‰‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\nå…ˆã«æ‰“æ’ƒãƒ†ãƒ¼ãƒ–ãƒ«ã®ã€Œå®ˆå‚™ã€æ¬„ã‚’ã€ŒæŠ•ã€ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        const pitchingRows = pitchingTableBody.querySelectorAll('tr');
        let updatedCount = 0;
        pitchersInBatting.forEach((pitcher, index) => {
            if (pitchingRows[index]) {
                const nameInput = pitchingRows[index].querySelector('.pitcher-name');
                const throwBatSelect = pitchingRows[index].querySelector('.pitcher-throw-bat');
                if (nameInput) nameInput.value = pitcher.name;
                if (throwBatSelect) throwBatSelect.value = pitcher.throwBat;
                updatedCount++;
            }
        });
        alert(`${updatedCount}äººã®æŠ•æ‰‹ã‚’æ‰“æ’ƒãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚`);
    }

    // --- ã€ã¾ã¨ã‚ã‚µã‚¤ãƒˆã€‘ã‚¹ãƒ¬ãƒƒãƒ‰å†ç”Ÿæˆãƒœã‚¿ãƒ³ ---
    if (e.target.matches('#retry-matome-thread-btn')) {
        e.preventDefault();
        const btn = e.target;
        const matchId = btn.dataset.matchId;
        const originalData = tournamentState.matomeThreads[matchId];
        
        if (!originalData || !originalData.context) {
            alert("å†ç”Ÿæˆã«å¿…è¦ãªã€Œè©¦åˆçµ‚äº†æ™‚ã®æƒ…å ±ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }
        
        const matchContext = originalData.context;
        const threadContentEl = document.getElementById('bbs-thread-content');
        btn.disabled = true;
        btn.textContent = 'ç”Ÿæˆä¸­...';
        threadContentEl.innerHTML = `<div class="loader text-center py-8">AIãŒã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å†ç”Ÿæˆä¸­ã§ã™...ï¼ˆ${matchContext.winnerLineupChanges || 'ã‚¹ã‚¿ãƒ¡ãƒ³å¤‰æ›´ãªã—'}ï¼‰</div>`;
        
        let newCommentsArray = null;
        
        try {
            // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ (ç”²å­åœ’åˆ†å²) â˜…â˜…â˜…
            const isKoshien = tournamentState.currentTournament === 'summer_koshien';
            const playerTeam = tournamentState.teams[0];
            const isPlayerMatch = (matchContext.winnerName === playerTeam || matchContext.loserName === playerTeam);

            if (isKoshien && isPlayerMatch) {
                // ç”²å­åœ’ãƒ¢ãƒ¼ãƒ‰ & ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æˆ¦ -> å¿œæ´ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å†ç”Ÿæˆ
                const result = await generateKoshienMatomeThread(matchContext);
                // generateKoshienMatomeThread ã¯ { comments: [...] } ã‚’è¿”ã™
                newCommentsArray = result ? result.comments : null;
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ -> ãªã‚“Jã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å†ç”Ÿæˆ
                const result = await generateGameMatchBbsComments(matchContext);
                // generateGameMatchBbsComments ã¯ [...] (é…åˆ—) ã¾ãŸã¯ { comments: [...] } ã‚’è¿”ã™å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ä¸¡å¯¾å¿œ
                if (Array.isArray(result)) {
                    newCommentsArray = result;
                } else if (result && result.comments) {
                    newCommentsArray = result.comments;
                }
            }
            // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

            if (newCommentsArray && Array.isArray(newCommentsArray)) {
                // ä¿å­˜
                tournamentState.matomeThreads[matchId].thread = newCommentsArray;
                saveState();
                
                // æç”»
                threadContentEl.innerHTML = '';
                for (const comment of newCommentsArray) {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'bbs-comment opacity-0 transition-opacity duration-500';
                    commentEl.innerHTML = `<p class="font-semibold text-gray-700 text-sm">${comment.personality}</p><p class="text-gray-800 my-1 whitespace-pre-wrap">${comment.text}</p>`;
                    threadContentEl.appendChild(commentEl);
                    setTimeout(() => { commentEl.classList.remove('opacity-0'); }, 50);
                    await new Promise(resolve => setTimeout(resolve, 50));
                    threadContentEl.scrollTop = threadContentEl.scrollHeight;
                }
            } else {
                threadContentEl.innerHTML = `<p class="text-center text-red-500">ã‚¹ãƒ¬ãƒƒãƒ‰ã®å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
            }
        } catch (err) {
            console.error("ã¾ã¨ã‚ã‚¹ãƒ¬ãƒƒãƒ‰å†ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼:", err);
            threadContentEl.innerHTML = `<p class="text-center text-red-500">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}</p>`;
        }
        
        btn.disabled = false;
        btn.textContent = 'å†ç”Ÿæˆ';
    }

    // --- ã€Œã¾ã¨ã‚ã‚µã‚¤ãƒˆã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ ---
    const showMatomeBtn = e.target.closest('#show-matome-site-btn');
    if (showMatomeBtn) {
        const modal = document.getElementById('integrated-matome-modal');
        const articlesContainer = document.getElementById('matome-articles-container');
        modal.classList.remove('hidden');
        articlesContainer.innerHTML = `<div class="loader text-center py-8">è¨˜äº‹ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>`;
        document.querySelectorAll('.matome-tab-content').forEach(tab => tab.classList.add('hidden'));
        document.getElementById('matome-tab-top').classList.remove('hidden');
        document.querySelectorAll('.matome-tab-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-600', 'text-white'));
        document.querySelector('.matome-tab-btn[data-tab="top"]').classList.add('active', 'bg-blue-600', 'text-white');
        (async () => {
            const matomeHtml = await generateMatomeSiteHtml();
            articlesContainer.innerHTML = matomeHtml;
        })();
    }

    // --- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã/é–‰ã˜ã‚‹ ---
   // --- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã/é–‰ã˜ã‚‹ ---
if (e.target.closest('#open-settings-btn')) {
    document.getElementById('toggle-article-generation').checked = tournamentState.settings.enableArticleGeneration;
    document.getElementById('toggle-bbs-generation').checked = tournamentState.settings.enableBbsGeneration;
    
    // â–¼â–¼â–¼ ã€è¿½åŠ ã€‘ ãƒ”ãƒ©ãƒŸãƒƒãƒ‰ã‚’æç”» â–¼â–¼â–¼
    renderRankPyramid();
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    document.getElementById('settings-modal').classList.remove('hidden');
    
    document.getElementById('settings-modal').classList.add('flex'); 
}

// --- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
document.getElementById('settings-modal-close-btn').addEventListener('click', () => {
    const modal = document.getElementById('settings-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex'); // flexã§è¡¨ç¤ºã—ã¦ã„ãŸå ´åˆã®å¯¾ç­–
});

    // --- çµ±åˆå‹ã¾ã¨ã‚ã‚µã‚¤ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ ---
    if (e.target.closest('#matome-modal-close-btn')) {
        document.getElementById('integrated-matome-modal').classList.add('hidden');
        document.getElementById('bbs-thread-display-area').classList.add('hidden');
    }

    // --- ã¾ã¨ã‚ã‚µã‚¤ãƒˆå†…ã®ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
    const tabBtn = e.target.closest('.matome-tab-btn');
    if (tabBtn) {
        document.querySelectorAll('.matome-tab-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-blue-600', 'text-white', 'hover:bg-blue-700');
            btn.classList.add('text-gray-700', 'hover:bg-gray-100');
        });
        tabBtn.classList.add('active', 'bg-blue-600', 'text-white');
        tabBtn.classList.remove('text-gray-700', 'hover:bg-gray-100');
        const tabId = tabBtn.dataset.tab;
        document.querySelectorAll('.matome-tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(`matome-tab-${tabId}`).classList.remove('hidden');
        document.getElementById('bbs-thread-display-area').classList.add('hidden');
        if (tabId === 'top') {
            const articlesContainer = document.getElementById('matome-articles-container');
            articlesContainer.innerHTML = `<div class="loader text-center py-8">è¨˜äº‹ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>`;
            (async () => {
                const matomeHtml = await generateMatomeSiteHtml();
                articlesContainer.innerHTML = matomeHtml;
            })();
        }
    }
    
    // --- ã¾ã¨ã‚ã‚µã‚¤ãƒˆå†…ã®è¨˜äº‹ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯ ---
    const matomeLink = e.target.closest('.matome-article-link');
    if (matomeLink) {
        e.preventDefault();
        const headline = matomeLink.dataset.headline;
        const type = matomeLink.dataset.type;
        const category = matomeLink.dataset.category;
        const matchId = matomeLink.dataset.matchId;
        const threadDisplayArea = document.getElementById('bbs-thread-display-area');
        const threadTitleEl = document.getElementById('bbs-thread-title');
        const threadContentEl = document.getElementById('bbs-thread-content');
        document.querySelectorAll('.matome-tab-content').forEach(content => content.classList.add('hidden'));
        threadDisplayArea.classList.remove('hidden');
        threadTitleEl.textContent = headline;
        threadContentEl.innerHTML = `<div class="loader text-center py-8">AIãŒæ²ç¤ºæ¿ã®åå¿œã‚’ç”Ÿæˆä¸­...</div>`;
        (async () => {
            let commentsArray;
            const retryBtn = document.getElementById('retry-matome-thread-btn');
            if (type === 'game' && matchId) {
                const preGeneratedData = tournamentState.matomeThreads[matchId];
                const preGeneratedThread = preGeneratedData ? preGeneratedData.thread : null;
                if (preGeneratedData && preGeneratedData.context) {
                    retryBtn.dataset.matchId = matchId;
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }
                if (preGeneratedThread) {
                    if (Array.isArray(preGeneratedThread)) {
                        commentsArray = preGeneratedThread;
                    } else if (preGeneratedThread.error) {
                        threadContentEl.innerHTML = `<p class="text-center text-red-500">ã‚¹ãƒ¬ãƒƒãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚(ã‚¨ãƒ©ãƒ¼: ${preGeneratedThread.body || 'ä¸æ˜'})</p>`;
                        return;
                    }
                } else {
                    threadContentEl.innerHTML = `<p class="text-center text-gray-500">ã“ã®è©¦åˆã®ã¾ã¨ã‚ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                    retryBtn.classList.add('hidden');
                    return;
                }
            } else if (type === 'real') {
                retryBtn.classList.add('hidden');
                commentsArray = await generateRealNewsBbsComments(headline, category);
            }
            if (commentsArray && Array.isArray(commentsArray)) {
                threadContentEl.innerHTML = '';
                for (const comment of commentsArray) {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'bbs-comment opacity-0 transition-opacity duration-500';
                    commentEl.innerHTML = `<p class="font-semibold text-gray-700 text-sm">${comment.personality}</p><p class="text-gray-800 my-1 whitespace-pre-wrap">${comment.text}</p>`;
                    threadContentEl.appendChild(commentEl);
                    setTimeout(() => { commentEl.classList.remove('opacity-0'); }, 50);
                    const delay = Math.random() * 800 + 200;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    threadContentEl.scrollTop = threadContentEl.scrollHeight;
                }
            } else if (!commentsArray) {
                threadContentEl.innerHTML = `<p class="text-center text-red-500">ã‚¹ãƒ¬ãƒƒãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
            }
        })();
    }

    // --- BBSã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰ä¸€è¦§ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ ---
    if (e.target.closest('#bbs-thread-back-btn')) {
        document.getElementById('bbs-thread-display-area').classList.add('hidden');
        document.getElementById('matome-tab-top').classList.remove('hidden');
    }

    // --- ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«å‘Šç™º/ç„¡è¦–ãƒœã‚¿ãƒ³ ---
    const scandalBtn = e.target.closest('.report-scandal-btn, .ignore-scandal-btn');
    if (scandalBtn && tournamentState.activeScandal) {
        const { teamName, scandalId } = tournamentState.activeScandal;
        const scandalDef = SCANDAL_DEFINITIONS.find(s => s.id === scandalId);
        if (!scandalDef) return;
        const choice = scandalBtn.classList.contains('report-scandal-btn') ? 'report' : 'ignore';
        const consequence = scandalDef.consequences[choice];
        consequence.applyEffect(teamName, tournamentState);
        const outcomeArticle = {
            title: consequence.outcomeTitle(teamName),
            body: consequence.outcomeBody(teamName),
            timestamp: Date.now()
        };
        tournamentState.news = tournamentState.news.filter(n => !n.isScandalRumor);
        tournamentState.news.push(outcomeArticle);
        tournamentState.activeScandal = null;
        renderTournament(tournamentState);
        saveState();
    }

    // --- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼å¯†ç€å–æãƒœã‚¿ãƒ³ï¼ˆå„ç¨®ï¼‰ ---
    if (e.target.matches('.underdog-doc-btn')) {
        const teamName = e.target.dataset.teamName;
        const confirmed = await showConfirm(`ã€Œ${teamName}ã€ã®å¯†ç€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ...`);
        if (confirmed) startDocumentary('underdog', teamName);
    }
    if (e.target.matches('.powerhouse-doc-btn')) {
        const teamName = e.target.dataset.teamName;
        const confirmed = await showConfirm(`ã€Œ${teamName}ã€ã®å¯†ç€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®å¤§ä¼šä¸­ã€ä»–ã®ãƒãƒ¼ãƒ ã¯é¸æŠã§ããªããªã‚Šã¾ã™ã€‚`);
        if (confirmed) startDocumentary('powerhouse', teamName);
    }
    if (e.target.matches('.powerhouse-revival-doc-btn')) {
        const teamName = e.target.dataset.teamName;
        const confirmed = await showConfirm(`ã€Œ${teamName}ã€ã®å¯†ç€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®å¤§ä¼šä¸­ã€ä»–ã®ãƒãƒ¼ãƒ ã¯é¸æŠã§ããªããªã‚Šã¾ã™ã€‚`);
        if (confirmed) startDocumentary('powerhouse_revival', teamName);
    }
    if (e.target.matches('.one-man-team-doc-btn')) {
        const teamName = e.target.dataset.teamName;
        const confirmed = await showConfirm(`ã€Œ${teamName}ã€ã®å¯†ç€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚¿ãƒªãƒ¼ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®å¤§ä¼šä¸­ã€ä»–ã®ãƒãƒ¼ãƒ ã¯é¸æŠã§ããªããªã‚Šã¾ã™ã€‚`);
        if (confirmed) startDocumentary('one_man_team', teamName);
    }

    // --- èµ°è€…ãƒ—ãƒ¬ãƒ¼ã€Œè¿½åŠ ã€ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('.add-runner-play-btn')) {
        e.preventDefault();
        const container = e.target.closest('.at-bat-block').querySelector('.runner-plays-container');
        if (!container) return;
        if (container.children.length >= 3) {
            alert('ä¸€åº¦ã«è¿½åŠ ã§ãã‚‹èµ°è€…ãƒ—ãƒ¬ãƒ¼ã¯3ã¤ã¾ã§ã§ã™ã€‚');
            return;
        }
        const table = e.target.closest('.batting-table');
        const playersOnField = Array.from(table.querySelectorAll('.player-name')).map(input => ({name: input.value.trim()})).filter(p => p.name);
        const nameOptions = playersOnField.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        const baserunningPlays = ['ç›—å¡', 'ç›—å¡æ­»', 'ã‚¿ãƒƒãƒã‚¢ãƒƒãƒ—', 'é€²å¡', 'ç”Ÿé‚„', 'èµ°å¡æ­»', 'ç‰½åˆ¶æ­»', 'æŒŸæ®ºãƒ—ãƒ¬ãƒ¼ã§ã‚¢ã‚¦ãƒˆ'];
        const bases = ['ä¸€å¡ã¸', 'äºŒå¡ã¸', 'ä¸‰å¡ã¸', 'æœ¬å¡ã¸(ç”Ÿé‚„)'];
        const playOptions = baserunningPlays.map(p => `<option value="${p}">${p}</option>`).join('');
        const baseOptions = bases.map(b => `<option value="${b}">${b}</option>`).join('');
        const newPlayHTML = `
            <div class="runner-play-input flex gap-1 items-center mt-1">
                <select class="runner-name w-1/3 text-xs p-1 border rounded"><option value="">-èª°ãŒ-</option>${nameOptions}</select>
                <select class="runner-play w-1/3 text-xs p-1 border rounded bg-green-50"><option value="">-ä½•ã‚’ã—ãŸ-</option>${playOptions}</select>
                <select class="runner-base w-1/3 text-xs p-1 border rounded bg-green-50"><option value="">-ã©ã“ã¸-</option>${baseOptions}</select>
                <button class="remove-runner-play-btn text-red-500 hover:text-red-700 font-bold text-lg leading-none p-1">Ã—</button>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', newPlayHTML);
    }
    
    // --- èµ°è€…ãƒ—ãƒ¬ãƒ¼ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('.remove-runner-play-btn')) {
        e.target.closest('.runner-play-input').remove();
    }

    // --- ãŠã¾ã‹ã›å…¥åŠ›ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('.quick-sim-btn')) {
        e.preventDefault();
        autoFillMatchDetails(e.target.dataset.matchId);
    }

    // --- 1ã‚¤ãƒ‹ãƒ³ã‚°ã«è¤‡æ•°æ‰“å¸­ã‚’è¿½åŠ ã™ã‚‹ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('.add-at-bat-btn')) {
        e.preventDefault();
        const table = e.target.closest('.batting-table');
        const playersOnField = Array.from(table.querySelectorAll('.player-name')).map(input => ({ name: input.value.trim() })).filter(p => p.name);
        const newAtBatHTML = createBattingResultDropdowns(playersOnField, '');
        e.target.insertAdjacentHTML('beforebegin', newAtBatHTML);
    }

    // --- äº¤ä»£é¸æ‰‹è¿½åŠ ãƒœã‚¿ãƒ³ ---
    // --- äº¤ä»£é¸æ‰‹è¿½åŠ ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('.add-sub-row-btn')) {
        e.preventDefault();
        const btn = e.target;
        const teamKey = btn.dataset.teamKey;

        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
        // ã‚¨ãƒ©ãƒ¼ã®åŸå› : dbMatch ãŒæœªå®šç¾©ã ã£ãŸãŸã‚ã€ã“ã“ã§ match ã‚’å†å–å¾—ã—ã¾ã™
        const match = findMatchById(currentMatchIdForDetails);
        if (!match) {
            console.error("Could not find match to add substitute player.");
            return; 
        }
        // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

        const currentOrder = btn.dataset.order;
        const baseOrder = currentOrder.split('-')[0];
        const tableBody = btn.closest('tbody');
        if (!tableBody) return;
        const allOrderRows = Array.from(tableBody.querySelectorAll(`tr[data-order^="${baseOrder}"]`));
        const targetRow = allOrderRows[allOrderRows.length - 1];
        const subCount = allOrderRows.filter(row => row.dataset.order.includes('sub')).length + 1;
        const newOrder = `${baseOrder}-sub-${subCount}`;
        const newRow = document.createElement('tr');
        newRow.dataset.order = newOrder;
        const throwBatOptionsList = [
            { val: "R/R", label: "å³/å³" }, { val: "R/L", label: "å³/å·¦" }, { val: "R/S", label: "å³/ä¸¡" },
            { val: "L/L", label: "å·¦/å·¦" }, { val: "L/R", label: "å·¦/å³" }, { val: "L/S", label: "å·¦/ä¸¡" }
        ];
        const tbOptionsHtml = throwBatOptionsList.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        const subThrowBatSelect = `<select class="player-throw-bat w-full bg-transparent"><option value="">-æŠ•/æ‰“-</option>${tbOptionsHtml}</select>`;
        const numberOptions = Array.from({length: 20}, (_, i) => `<option value="${i + 1}">${i + 1}</option>`).join('');
        const posOptions = ['æŠ•', 'æ•', 'ä¸€', 'äºŒ', 'ä¸‰', 'éŠ', 'å·¦', 'ä¸­', 'å³'].map(p => `<option value="${p}">${p}</option>`).join('');
        const numInnings = tableBody.parentElement.querySelector('thead tr').children.length - 7;
        let resultInputs = '';
        for (let j = 0; j < numInnings; j++) {
            resultInputs += `<td class="col-inning batting-result-cell align-top p-1">
                                ${createBattingResultDropdowns(null, '')}
                                <button class="add-at-bat-btn text-xs mt-2 bg-blue-100 px-2 py-1 rounded hover:bg-blue-200 w-full font-semibold">ï¼‹ 2æ‰“å¸­ç›®ã‚’è¿½åŠ </button>
                             </td>`;
        }
        newRow.innerHTML = `
            <td class="col-order"></td>
            <td class="col-number"><select class="player-number w-full bg-transparent"><option value=""></option>${numberOptions}</select></td>
            <td class="col-throw-bat">${subThrowBatSelect}</td>
            <td class="col-player pl-4">
                <div class="flex items-center gap-1">
                    <input type="text" class="player-name w-full" placeholder="äº¤ä»£é¸æ‰‹å">
                    <button class="show-player-stats-btn text-lg p-1 text-blue-600 hover:bg-blue-100 rounded" 
                            data-team-name="${teamKey === 'team1' ? match.team1 : match.team2}" 
                            data-player-order-key="${newOrder}" 
                            title="é€šç®—æˆç¸¾ã‚’è¡¨ç¤º">ğŸ“Š</button>
                </div>
            </td>
            <td class="col-pos">
                <div class="flex items-center justify-between">
                    <select class="player-pos w-full bg-transparent"><option value=""></option>${posOptions}</select>
                    <button class="text-xs bg-gray-200 px-1 ml-1 rounded pos-change-btn" data-team-key="${teamKey}">å¤‰æ›´</button>
                </div>
                <span class="text-xs text-gray-500 truncate" title=""></span>
            </td>
            <td class="col-sub-type align-top">
                <select class="sub-type-select w-full bg-transparent mb-1">
                    <option value="" selected>-</option>
                    <option value="PH">ä»£æ‰“</option><option value="PR">ä»£èµ°</option>
                    <option value="DEF">å®ˆå‚™</option><option value="PITCHER">æŠ•æ‰‹</option>
                </select>
                <button class="add-sub-row-btn text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 w-full" data-order="${newOrder}" data-team-key="${teamKey}">
                    + äº¤ä»£
                </button>
            </td>
            ${resultInputs}
        `;
        targetRow.parentNode.insertBefore(newRow, targetRow.nextSibling);
    }
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

    // --- å®ˆå‚™å¤‰æ›´ãƒœã‚¿ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼‰ ---
    if (e.target.matches('.pos-change-btn')) {
        const btn = e.target;
        const teamKey = btn.dataset.teamKey;
        const row = btn.closest('tr');
        const playerNameInput = row.querySelector('.player-name');
        if (!playerNameInput) return;
        const playerName = playerNameInput.value.trim();
        if (!playerName) {
            alert("å…ˆã«é¸æ‰‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        const modal = document.getElementById('substitution-modal');
        document.getElementById('sub-modal-player-name').value = playerName;
        modal.dataset.teamKey = teamKey;
        modal.dataset.playerName = playerName;
        modal.dataset.matchId = currentMatchIdForDetails;
        document.getElementById('sub-modal-inning').value = 1;
        document.getElementById('sub-modal-top-bottom').value = 'è¡¨';
        document.getElementById('sub-modal-timing-start').checked = true;
        document.getElementById('sub-modal-timing-mid').checked = false;
        document.getElementById('sub-modal-mid-inning-details').classList.add('hidden');
        document.getElementById('sub-modal-outs').value = '0';
        document.getElementById('sub-modal-runner1').checked = false;
        document.getElementById('sub-modal-runner2').checked = false;
        document.getElementById('sub-modal-runner3').checked = false;
        document.getElementById('sub-modal-new-pos').value = '';
        modal.classList.remove('hidden');
    }   

    // --- æŠ•æ‰‹è¿½åŠ ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('.add-row-btn')) {
        e.preventDefault();
        const tableId = e.target.dataset.tableId;
        const table = document.getElementById(tableId).querySelector('tbody');
        const newRow = table.insertRow();
        const throwBatOptions = [ { val: "R/R", label: "å³/å³" }, { val: "R/L", label: "å³/å·¦" }, { val: "R/S", label: "å³/ä¸¡" }, { val: "L/L", label: "å·¦/å·¦" }, { val: "L/R", label: "å·¦/å³" }, { val: "L/S", label: "å·¦/ä¸¡" } ];
        const throwStyleOptions = [ { val: "over", label: "ã‚ªãƒ¼ãƒãƒ¼" }, { val: "three_quarter", label: "ã‚¹ãƒªãƒ¼ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¼" }, { val: "side", label: "ã‚µã‚¤ãƒ‰" }, { val: "under", label: "ã‚¢ãƒ³ãƒ€ãƒ¼" } ];
        const pitcherTypeOptions = [ { val: "honkaku", label: "æœ¬æ ¼æ´¾" }, { val: "sokkyu", label: "é€Ÿçƒæ´¾" }, { val: "giko", label: "æŠ€å·§æ´¾" }, { val: "nanto", label: "è»ŸæŠ•æ´¾" } ];
        const velocityOptions = [];
        for (let v = 100; v <= 165; v += 5) { velocityOptions.push({ val: `${v}km`, label: `${v}kmå¸¯` }); }
        const tbOptionsHtml = throwBatOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        const styleOptionsHtml = throwStyleOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        const typeOptionsHtml = pitcherTypeOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        const velocityOptionsHtml = velocityOptions.map(opt => `<option value="${opt.val}">${opt.label}</option>`).join('');
        newRow.innerHTML = `
            <td class="col-pitcher-result"><select class="pitcher-result"><option value="" selected>-</option><option value="W">â—‹</option><option value="L">â—</option><option value="S">S</option><option value="H">H</option></select></td>
            <td class="col-pitcher-name"><input type="text" class="pitcher-name" value=""></td>
            <td class="col-pitcher-throw-bat"><select class="pitcher-throw-bat w-full bg-transparent"><option value="">-æŠ•/æ‰“-</option>${tbOptionsHtml}</select></td>
            <td class="col-pitcher-style"><select class="pitcher-throw-style w-full bg-transparent"><option value="">-æŠ•ã’æ–¹-</option>${styleOptionsHtml}</select></td>
            <td class="col-pitcher-type"><select class="pitcher-type w-full bg-transparent"><option value="">-ã‚¿ã‚¤ãƒ—-</option>${typeOptionsHtml}</select></td>
            <td class="col-pitcher-velocity"><select class="pitcher-velocity w-full bg-transparent"><option value="">-çƒé€Ÿå¸¯-</option>${velocityOptionsHtml}</select></td>
            <td class="col-stat"><input type="text" class="pitcher-innings" value=""></td>
            <td class="col-stat"><input type="number" class="pitcher-batters" value=""></td>
            <td class="col-stat"><input type="number" class="pitcher-pitches" value=""></td>
            <td class="col-stat"><input type="number" class="pitcher-hits" value=""></td>
            <td class="col-stat"><input type="number" class="pitcher-so" value=""></td>
            <td class="col-stat"><input type="number" class="pitcher-walks" value=""></td>
            <td class="col-stat"><input type="number" class="pitcher-runs" value=""></td>
            <td class="col-stat"><input type="number" class="pitcher-er" value=""></td>
        `;
    }

    // --- å…ˆæ”»å¾Œæ”»å…¥ã‚Œæ›¿ãˆãƒœã‚¿ãƒ³ ---
    if (e.target.matches('#swap-teams-btn')) {
        swapTeamDetails(e.target.dataset.matchId);
    }

// â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã€Œæ–°è¦è¿½åŠ ã€ â–¼â–¼â–¼
    // --- ãƒãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç°¡æ˜“ç‰ˆï¼‰ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ ---
    const statusModalCloseBtn = e.target.closest('#status-modal-close');
    if (statusModalCloseBtn) {
        e.preventDefault();
        document.getElementById('team-status-modal').classList.add('hidden');
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    // â˜…â˜…â˜…â˜…â˜… ã“ã“ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…â˜…â˜…
    // --- ãƒãƒ¼ãƒ åã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼‰ ---
    // (ä»–ã®ãƒœã‚¿ãƒ³æ“ä½œã¨ç«¶åˆã—ãªã„ã‚ˆã†ã€ãƒœã‚¿ãƒ³ä»¥å¤–ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯)
    else if (e.target.closest('.clickable-team-name') && !e.target.closest('button')) {
        const clickableTeamName = e.target.closest('.clickable-team-name');
        const teamName = clickableTeamName.dataset.teamName;
        
        if(teamName && teamName !== 'null' && teamName !== '') {
            // â˜… ã“ã“ã‚’å¤‰æ›´ï¼šã„ããªã‚Šè©³ç´°ã§ã¯ãªãã€ãƒãƒ¼ãƒãƒ£ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹
            showVirtualTeamCard(teamName); 
        }
    }
   // â˜…â˜…â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…â˜…â˜…

    // --- è¨˜äº‹è¡¨ç¤ºãƒœã‚¿ãƒ³ï¼ˆé€šå¸¸è¨˜äº‹ã®ã€Œæœ¬æ–‡ã€ï¼‰ ---
    const newsArticleBtn = e.target.closest('.news-article-btn');
    if (newsArticleBtn) {
        const article = tournamentState.news[parseInt(newsArticleBtn.dataset.index, 10)];
        if (article && article.body) {
            document.getElementById('modal-title').textContent = article.title;
            document.getElementById('modal-body').textContent = article.body;
            document.getElementById('modal-meta').innerHTML = `<p>${new Date(article.timestamp).toLocaleDateString('ja-JP')}</p>`;
            newsModal.classList.remove('hidden');
            newsModal.classList.add('flex');
        } else {
            alert('è¨˜äº‹ã®æœ¬æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
        }
    }

    // â–¼â–¼â–¼ ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã€Œæ–°è¦è¿½åŠ ã€(17805è¡Œç›®ã‚ãŸã‚Š) â–¼â–¼â–¼
    // --- è¨˜äº‹è¡¨ç¤ºãƒœã‚¿ãƒ³ï¼ˆæ–°èã®ã€Œæ–°èã‚’èª­ã‚€ã€ï¼‰ ---
   else if (e.target.closest('.newspaper-view-btn')) {
        const newspaperViewBtn = e.target.closest('.newspaper-view-btn');
        const article = tournamentState.news[parseInt(newspaperViewBtn.dataset.index, 10)];
        
        if (article.isNewspaper) {
            if (article.newspaperData) {
                // --- 1. ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†æ™‚ã®ã€Œç‰¹é›†å·ã€ã‚’é–‹ããƒ­ã‚¸ãƒƒã‚¯ ---
                renderNewspaperModal(article.newspaperData);
                newspaperModal.classList.remove('hidden');
                
            // â˜…â˜…â˜… â–¼â–¼â–¼ ä»¥ä¸‹ã® else if ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã€Œæ–°è¦è¿½åŠ ã€ â–¼â–¼â–¼ â˜…â˜…â˜…
            } else if (article.newspaperHtml) {
                // --- 2. ã€Œå€‹åˆ¥ã®è©¦åˆã€ã®æ–°èã‚’é–‹ããƒ­ã‚¸ãƒƒã‚¯ ---
                // ï¼ˆå€‹åˆ¥ã®æ–°èã¯ã€è¨˜äº‹ç”Ÿæˆæ™‚ã«HTMLã‚‚ä¸€ç·’ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ï¼‰
                newspaperModalBody.innerHTML = article.newspaperHtml;
                newspaperModal.classList.remove('hidden');
            // â˜…â˜…â˜… â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² â˜…â˜…â˜…
                
            } else {
                alert('æ–°èãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚(newspaperData ã‚‚ newspaperHtml ã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“)');
            }
        }
    }
    // â–²â–²â–² æ–°è¦è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// â–¼â–¼â–¼ ã“ã® else if ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    else if (e.target.closest('.skip-newspaper-view-btn')) {
        // --- ã€Œã‚¹ã‚­ãƒƒãƒ—æ–°èã‚’èª­ã‚€ã€ãƒœã‚¿ãƒ³ (ãƒ‹ãƒ¥ãƒ¼ã‚¹æ¬„ã‹ã‚‰) ---
        e.preventDefault();
        const btn = e.target.closest('.skip-newspaper-view-btn');
        const index = parseInt(btn.dataset.index, 10);
        const article = tournamentState.news[index];

        if (!article || !article.isSkipNewspaper || !article.articleData || !article.resultsBoxHtml) {
            alert("ã‚¹ã‚­ãƒƒãƒ—æ–°èã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }

        // 1. ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modal = document.getElementById('skip-newspaper-modal');
        const bodyEl = document.getElementById('skip-newspaper-body');
        const dateEl = document.getElementById('skip-newspaper-date');
        const topTitleEl = document.getElementById('skip-newspaper-top-title');
        const resultsTitleEl = document.getElementById('skip-newspaper-results-title');
        
        // 2. ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†æ§‹ç¯‰
        const { articleData, resultsBoxHtml, dateString, roundNumber } = article;
        const roundName = getRoundNameFromMatchId(`L-R${roundNumber}-M1`); // ãƒ©ã‚¦ãƒ³ãƒ‰åã‚’å–å¾—

        dateEl.textContent = dateString || `${tournamentState.tournamentYear}å¹´`;
        topTitleEl.textContent = `ç†±æˆ¦ã®${roundName}ã€é™å²¡ã‚’å¸­å·»`;
        resultsTitleEl.textContent = `${roundName} å…¨è©¦åˆçµæœ`;
        
        bodyEl.innerHTML = `
            <div class="skip-newspaper-main-headline">
                ${articleData.mainHeadline}
            </div>
            <div class="skip-newspaper-main-article">
                <div class="skip-newspaper-main-image">
                    å†™çœŸï¼š${articleData.mainImageCaption}
                </div>
                <p class="skip-newspaper-image-caption">${articleData.mainImageCaption}</p>
                <div class="skip-newspaper-main-body">
                    <h4>${articleData.mainArticleSubHeadline}</h4>
                    <p>${articleData.mainArticleBody.replace(/\n/g, '<br><br>')}</p>
                </div>
            </div>
            <div class="skip-newspaper-side-article right">
                <h3 class="skip-newspaper-side-headline">${articleData.sideArticle1Headline}</h3>
                <div class="skip-newspaper-side-body">
                    <p>${articleData.sideArticle1Body.replace(/\n/g, '<br><br>')}</p>
                </div>
            </div>
            <div class="skip-newspaper-side-article left">
                <h3 class="skip-newspaper-side-headline">${articleData.sideArticle2Headline}</h3>
                <div class="skip-newspaper-side-body">
                    <p>${articleData.sideArticle2Body.replace(/\n/g, '<br><br>')}</p>
                </div>
            </div>
            <div class="skip-newspaper-results-section">
                <h2 id="skip-newspaper-results-title">${roundName} å…¨è©¦åˆçµæœ</h2>
                <div id="skip-newspaper-match-grid" class="skip-newspaper-match-grid">
                    ${resultsBoxHtml}
                </div>
            </div>
        `;

        // 3. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        modal.classList.remove('hidden');
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

    // --- æ²ç¤ºæ¿ã®ã€Œè¿”ä¿¡ã™ã‚‹ã€ãƒœã‚¿ãƒ³ ---
    const replyBtn = e.target.closest('.reply-btn');
    if (replyBtn) {
        e.preventDefault();
        const commentId = replyBtn.dataset.commentId;
        const formContainer = document.getElementById(`reply-form-container-${commentId}`);
        if (formContainer) {
            formContainer.classList.toggle('hidden');
        }
        return; 
    }
    
    // --- AIè¨˜äº‹ã®å†ç”Ÿæˆãƒœã‚¿ãƒ³ï¼ˆã‚¨ãƒ©ãƒ¼è¨˜äº‹ãƒ»æˆåŠŸè¨˜äº‹ã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰ ---
    const regenerateBtn = e.target.closest('.regenerate-btn, .retry-btn');
    if (regenerateBtn) {
        const articleIndex = parseInt(regenerateBtn.dataset.index, 10);
        const originalArticle = tournamentState.news[articleIndex];
        if (!originalArticle || !originalArticle.context) {
            alert("ã“ã®è¨˜äº‹ã¯å†ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚");
            return;
        }
        articleForRegeneration = { index: articleIndex, article: originalArticle };
        document.getElementById('feedback-include').value = '';
        document.getElementById('feedback-exclude').value = '';
        document.getElementById('feedback-modal').classList.remove('hidden');
    }
    
// --- ã€æ–°è¦ã€‘AIåˆ†æã‚’å†å®Ÿè¡Œã™ã‚‹ãƒœã‚¿ãƒ³ ---
    else if (e.target.matches('#run-archive-analysis-btn')) {
        e.preventDefault();
        const targetTeam = e.target.dataset.teamName;
        
        // â˜… å‡¦ç†ã‚’ç›´æ¥ runArchiveAnalysis é–¢æ•°ã«å§”è­²
        runArchiveAnalysis(targetTeam);
    }

    // --- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ã®å†ç”Ÿæˆå®Ÿè¡Œãƒœã‚¿ãƒ³ ---
   else if (e.target.closest('#feedback-submit-btn')) {
        e.preventDefault();
        const feedbackSubmitBtn = e.target.closest('#feedback-submit-btn');

        if (!articleForRegeneration) return;
        const { index, article } = articleForRegeneration;
        const context = article.context; 
        
        feedbackSubmitBtn.textContent = 'ç”Ÿæˆä¸­...';
        feedbackSubmitBtn.disabled = true;
        
        const userFeedback = {
            include: document.getElementById('feedback-include').value,
            exclude: document.getElementById('feedback-exclude').value
        };
        
        document.getElementById('feedback-modal').classList.add('hidden');
        articleForRegeneration = null;
        
        // å¤ã„è¨˜äº‹ã‚’å‰Šé™¤
        tournamentState.news.splice(index, 1);
        renderNews(tournamentState.news);
        
        newsContainer.innerHTML = `<div class="loader">AIè¨˜è€…ãŒã‚ãªãŸã®æŒ‡ç¤ºã‚’åŸºã«è¨˜äº‹ã‚’å†åŸ·ç­†ä¸­ã§ã™...</div>`;
        
        (async () => {
            let articlePromise;
            
            // ã‚¨ãƒ©ãƒ¼è¨˜äº‹ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            const createErrorArticle = () => ({
                title: "è¨˜äº‹ç”Ÿæˆã‚¨ãƒ©ãƒ¼", body: "è¨˜äº‹ã®å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
                timestamp: Date.now(), error: true,
                errorId: context.matchId || context.errorId || `regen-error-${Date.now()}`,
                context: context // å…ƒã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿æŒ
            });

            if (context.isDocumentary) {
                const { type, teamName, matchData } = context;
                articlePromise = generateDocumentaryArticle('intro', type, teamName, matchData, userFeedback);
            
            } else if (context.isBracketAnalysis) {
                articlePromise = generateBracketAnalysisNewsArticle(tournamentState); 
            
            } else if (context.isKoshienNews) {
                // ç”²å­åœ’ãƒ‹ãƒ¥ãƒ¼ã‚¹
                articlePromise = generateKoshienNewsArticle(context, userFeedback);
                
            } else if (context.isCinderellaStory) {
                const { loserName, loserRank, roundNum, ...restOfContext } = context;
                articlePromise = generateCinderellaArticle(loserName, loserRank, roundNum, restOfContext);

            } else if (context.isHadaReport) {
                articlePromise = generateHadaReport(context, userFeedback);
                
            } else if (context.isTopicArticle || context.theme) {
                const rank = calculateRank(context.teamName, tournamentState); 
                articlePromise = createTopicArticle(context.teamName, rank, context.theme); 
                
            } else if (context.isAccident) {
                const { teamName, playerName, accidentType, importance } = context;
                articlePromise = generateAccidentArticle(teamName, playerName, accidentType, {}, importance);

            // â˜…â˜…â˜… æ–°æ©Ÿèƒ½ç”¨ã®åˆ†å²ã‚’è¿½åŠ  â˜…â˜…â˜…
            } else if (context.isKoshienIntro) {
                // ä»£è¡¨æ ¡ç´¹ä»‹è¨˜äº‹ã®å†ç”Ÿæˆ
                articlePromise = generateKoshienTeamIntro(context.teamName);
                
            } else if (context.isFeatureArticle) {
                // æ³¨ç›®é¸æ‰‹10é¸ã®å†ç”Ÿæˆ
                articlePromise = generateTopPlayersArticle();
            // â˜…â˜…â˜… è¿½åŠ ã“ã“ã¾ã§ â˜…â˜…â˜…

            } else {
                // é€šå¸¸è¨˜äº‹ã®å†ç”Ÿæˆ
                articlePromise = generateNewsArticle(context, userFeedback);
            }
            
            const newArticle = await articlePromise;
            
            if (newArticle && !newArticle.error) {
                newArticle.context = context; // å…ƒã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿æŒ
                tournamentState.news.splice(index, 0, newArticle);
                
                // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆç”²å­åœ’ç³»ã®è¨˜äº‹ã¯å³æ™‚åæ˜ ã§ã‚‚OKã§ã™ãŒã€çµ±ä¸€ã—ã¦ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ï¼‰
                // â€»ç”²å­åœ’ãƒ‹ãƒ¥ãƒ¼ã‚¹(isKoshienNews)ãªã©ã¯å³æ™‚åæ˜ ã—ãŸã„å ´åˆã€æ¡ä»¶ã‹ã‚‰é™¤å¤–ã—ã¦ãã ã•ã„
                if (!context.isBracketAnalysis && !context.isHadaReport && !context.isTopicArticle && !context.theme && !context.isCinderellaStory && !context.isAccident && !context.isKoshienNews && !context.isKoshienIntro && !context.isFeatureArticle) {
                    showArticleReviewModal(newArticle);
                }
            } else {
                tournamentState.news.splice(index, 0, createErrorArticle());
            }
            
            saveState();
            renderNews(tournamentState.news);
            feedbackSubmitBtn.textContent = 'ã“ã®æŒ‡ç¤ºã§å†ç”Ÿæˆ';
            feedbackSubmitBtn.disabled = false;
        })();
    }

// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

    // --- è©¦åˆå‰ å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã ã‘ï¼‰ ---
    if (e.target.matches('.pre-game-cheer-btn')) {
        e.preventDefault();
        const btn = e.target;
        const matchId = btn.dataset.matchId;
        const match = findMatchById(matchId);
        if (!match || !match.team1 || !match.team2) {
            alert("å¯¾æˆ¦ã‚«ãƒ¼ãƒ‰ãŒæœªå®šã®ãŸã‚ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚");
            return;
        }
        const modal = document.getElementById('pre-game-modal');
        const titleEl = document.getElementById('pre-game-title');
        const bodyEl = document.getElementById('pre-game-body');
        const tab1 = document.getElementById('pre-game-tab-team1');
        const tab2 = document.getElementById('pre-game-tab-team2');
        titleEl.textContent = `ã€${match.team1} vs ${match.team2}ã€‘è©¦åˆå‰ å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆ`;
        tab1.textContent = `${match.team1} å¿œæ´å¸­`;
        tab2.textContent = `${match.team2} å¿œæ´å¸­`;
        tab1.dataset.matchId = matchId;
        tab1.dataset.teamName = match.team1;
        tab1.dataset.opponentName = match.team2;
        tab2.dataset.matchId = matchId;
        tab2.dataset.teamName = match.team2;
        tab2.dataset.opponentName = match.team1;
        tab1.classList.remove('active', 'text-blue-600', 'border-blue-600');
        tab2.classList.remove('active', 'text-blue-600', 'border-blue-600');
        tab1.classList.add('text-gray-500', 'border-transparent');
        tab2.classList.add('text-gray-500', 'border-transparent');
        bodyEl.innerHTML = `<p class="text-gray-500 text-center p-8">â†‘ è¦‹ãŸã„ãƒãƒ¼ãƒ ã®å¿œæ´å¸­ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ â†‘</p>`;
        modal.classList.remove('hidden');
    }

    // --- å®ˆå‚™äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('#sub-modal-cancel')) {
        document.getElementById('substitution-modal').classList.add('hidden');
    }

    // --- å®ˆå‚™äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã€Œäº¤ä»£ã‚’è¨˜éŒ²ã€ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('#sub-modal-save')) {
        const modal = document.getElementById('substitution-modal');
        const matchId = modal.dataset.matchId;
        const teamKey = modal.dataset.teamKey;
        const playerName = modal.dataset.playerName;
        const match = findMatchById(matchId);
        if (!match) {
            alert("ã‚¨ãƒ©ãƒ¼: è©²å½“ã®è©¦åˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }
        const newPos = document.getElementById('sub-modal-new-pos').value;
        if (!newPos) {
            alert("ã€Œæ–°ã—ã„å®ˆå‚™ä½ç½®ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        const substitutionData = {
            playerName: playerName,
            teamKey: teamKey,
            inning: document.getElementById('sub-modal-inning').value,
            topBottom: document.getElementById('sub-modal-top-bottom').value,
            timing: document.querySelector('input[name="sub-timing"]:checked').value,
            newPos: newPos,
            outs: null,
            runners: null
        };
        if (substitutionData.timing === 'mid') {
            substitutionData.outs = document.getElementById('sub-modal-outs').value;
            substitutionData.runners = {
                r1: document.getElementById('sub-modal-runner1').checked,
                r2: document.getElementById('sub-modal-runner2').checked,
                r3: document.getElementById('sub-modal-runner3').checked
            };
        }
        if (!match.details) match.details = {};
        if (!match.details.positionChanges) match.details.positionChanges = [];
        match.details.positionChanges.push(substitutionData);
        saveState();
        alert(`${substitutionData.inning}å›${substitutionData.topBottom}ã€${playerName}é¸æ‰‹ã‚’${newPos}ã«äº¤ä»£ã—ã¾ã—ãŸã€‚`);
        modal.classList.add('hidden');
    }

    // --- ã€è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã€‘ã€Œâ˜… æ³¨ç›®ã€ãƒœã‚¿ãƒ³ï¼ˆãƒˆã‚°ãƒ«ï¼‰ ---
    if (e.target.matches('.mark-at-bat-btn')) {
        e.preventDefault();
        const btn = e.target;
        const isMarked = btn.dataset.marked === 'true';
        if (isMarked) {
            btn.dataset.marked = 'false';
            btn.classList.remove('bg-yellow-300', 'border-yellow-500', 'text-yellow-900');
            btn.classList.add('bg-gray-100', 'border-gray-300', 'text-gray-500', 'hover:bg-gray-200');
        } else {
            btn.dataset.marked = 'true';
            btn.classList.add('bg-yellow-300', 'border-yellow-500', 'text-yellow-900');
            btn.classList.remove('bg-gray-100', 'border-gray-300', 'text-gray-500', 'hover:bg-gray-200');
        }
    }

    // --- å¿œæ´ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã€Œãƒãƒ¼ãƒ ã‚¿ãƒ–ã€ã‚¯ãƒªãƒƒã‚¯ ---
    // --- å¿œæ´ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã€Œãƒãƒ¼ãƒ ã‚¿ãƒ–ã€ã‚¯ãƒªãƒƒã‚¯ ---
    if (e.target.matches('.pre-game-team-tab')) {
        e.preventDefault();
        const tabBtn = e.target;
        if (tabBtn.classList.contains('active')) return;
        
        // --- ã‚¿ãƒ–ã®UIåˆ‡ã‚Šæ›¿ãˆ ---
        document.querySelectorAll('.pre-game-team-tab').forEach(btn => {
            btn.classList.remove('active', 'text-blue-600', 'border-blue-600');
            btn.classList.add('text-gray-500', 'border-transparent');
        });
        tabBtn.classList.add('active', 'text-blue-600', 'border-blue-600');
        tabBtn.classList.remove('text-gray-500', 'border-transparent');
        
        // --- AIã«æ¸¡ã™ãŸã‚ã®æƒ…å ±åé›† ---
        const teamKey = tabBtn.dataset.teamKey;
        const matchId = tabBtn.dataset.matchId;
        const teamName = tabBtn.dataset.teamName;
        const opponentName = tabBtn.dataset.opponentName;
        const bodyEl = document.getElementById('pre-game-body');
        const cacheKey = `${matchId}_${teamName}`;

        // --- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯ ---
        if (tournamentState.preGameComments[cacheKey]) {
            bodyEl.innerHTML = tournamentState.preGameComments[cacheKey];
            return;
        }

        bodyEl.innerHTML = `<div class="loader text-center py-8">${teamName} å¿œæ´å›£ï¼ˆOB, åœ¨æ ¡ç”Ÿ, åœ°å…ƒãƒ•ã‚¡ãƒ³ï¼‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆä¸­...</div>`;

        // --- â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒæ–°ã—ã„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰ â˜…â˜…â˜… ---
        
        const rankValues = { 'A': 10, 'B': 8, 'C': 5, 'D': 3, 'E': 2 };
        const rank = calculateRank(teamName, tournamentState);
        const opponentRank = calculateRank(opponentName, tournamentState);
        const numComments = rankValues[rank] || 2;
        
        const teamData = TEAM_DATA[teamName] || {};
        const teamRecord = tournamentState.teamRecords[teamName];
        const match = findMatchById(matchId);

        // 1. ãƒãƒ¼ãƒ ã®å‹•çš„æƒ…å ± (æ‰“ç‡ã€é€šç®—ç›—å¡ã€éå»æˆç¸¾ãªã©)
        const dynamicInfo = generateDynamicTeamInfo(teamName, teamData, teamRecord);

        // 2. æ³¨ç›®é¸æ‰‹æƒ…å ± (é™çš„)
        const detailedData = DETAILED_TEAM_DATA[teamName] || null;

        // 3. ä»Šå¤§ä¼šã®å‹ã¡ä¸ŠãŒã‚Š (è©¦åˆã€Œå‰ã€ã®å…¨è»Œè·¡)
        const tournamentPath = getCurrentTournamentPerformance(teamName, matchId);

        // 4. é¸æ‰‹å€‹äººã®Gamelog (ä»Šå¤§ä¼šã®æˆç¸¾å±¥æ­´)
        // (è©¦åˆå‰ãªã®ã§ã€ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡ã¯ãƒãƒ¼ãƒ åã ã‘ã€‚AIãŒæ–‡ä¸­ã®é¸æ‰‹åã‚’èª­ã¿å–ã‚‹)
        const mentionedTeams = new Set([teamName]);
        const playerGamelogs = formatPlayerGamelogsForPrompt(mentionedTeams, teamName, match?.schedule?.date);

        // 5. è©¦åˆæƒ…å ± (çƒå ´ã€å› ç¸)
        const scheduleInfo = match?.schedule 
            ? `è©¦åˆä¼šå ´: ${match.schedule.stadiumFull} (${match.schedule.date} ${['â‘ ', 'â‘¡', 'â‘¢', 'â‘£'][match.schedule.game - 1]})`
            : "è©¦åˆä¼šå ´: æœªå®š";
        const rivalryInfo = (match?.rivalryType || match?.feudType)
            ? `ç‰¹è¨˜äº‹é …: ã“ã‚Œã¯ã€Œ${match.rivalryType || match.feudType}ã€ã¨ã„ã†å› ç¸ã®å¯¾æ±ºã§ã™ã€‚`
            : null;

        const context = {
            name: teamName, 
            rank: rank,
            opponent: opponentName, 
            opponentRank: opponentRank,
            round: getRoundNameFromMatchId(matchId),
            path: tournamentPath,      // â˜…å¼·åŒ– (getCurrentTournamentPerformance)
            detailed: detailedData,
            info: dynamicInfo,         // â˜…å¼·åŒ– (generateDynamicTeamInfo)
            playerGamelogs: playerGamelogs, // â˜…æ–°è¨­ (Gamelog)
            schedule: scheduleInfo,    // â˜…æ–°è¨­ (ä¼šå ´)
            rivalry: rivalryInfo       // â˜…æ–°è¨­ (å› ç¸)
        };
        // --- â˜…â˜…â˜… ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰ã“ã“ã¾ã§ â˜…â˜…â˜… ---

        const comments = await generatePreGameCheerComments(context, numComments);
        let html = '';
        comments.forEach(c => {
            html += `<div class="bbs-comment"><p class="font-semibold text-gray-700 text-sm">${c.personality}</p><p class="text-gray-800 my-1 whitespace-pre-wrap">${c.comment}</p></div>`;
        });
        bodyEl.innerHTML = html;
        tournamentState.preGameComments[cacheKey] = html; // ç”Ÿæˆçµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        saveState();
    }
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

    // --- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³ ---
    if (e.target.matches('#feedback-cancel-btn')) {
        document.getElementById('feedback-modal').classList.add('hidden');
        articleForRegeneration = null;
    }

    // --- æ²ç¤ºæ¿ã‚³ãƒ¡ãƒ³ãƒˆã®ã‚¨ãƒ©ãƒ¼å†ç”Ÿæˆãƒœã‚¿ãƒ³ ---
    if (e.target.matches('.retry-bbs-btn')) {
        const btn = e.target;
        const index = parseInt(btn.dataset.index, 10);
        
        const targetItem = tournamentState.bbsComments[index]; 
        
        const regenType = btn.dataset.type;
        
        if (!targetItem || !targetItem.context) {
            alert("å†ç”Ÿæˆã«å¿…è¦ãªæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }

        btn.textContent = 'ç”Ÿæˆä¸­...';
        btn.disabled = true;
        let newBbsData = null;

        try {
            if (regenType === 'bracket-thread') {
                // çµ„ã¿åˆã‚ã›ã‚¹ãƒ¬ãƒƒãƒ‰ã®å†ç”Ÿæˆ
                newBbsData = await generateBracketBbsThread(tournamentState);
            } 
            else if (regenType === 'match-comments' && targetItem.context.matchId) {
                // è©¦åˆã‚³ãƒ¡ãƒ³ãƒˆã®å†ç”Ÿæˆ
                if (targetItem.context.winnerName && targetItem.context.dbMatch) {
                    
                    const isKoshien = tournamentState.currentTournament === 'summer_koshien';
                    const playerTeam = tournamentState.teams[0];
                    const isPlayerMatch = (targetItem.context.winnerName === playerTeam || targetItem.context.loserName === playerTeam);

                    if (isKoshien && isPlayerMatch) {
                        newBbsData = await generateKoshienBbsComments(targetItem.context);
                    } else {
                        newBbsData = await generateBbsComments(targetItem.context);
                    }

                } else {
                    throw new Error("è©¦åˆå¾Œã‚³ãƒ¡ãƒ³ãƒˆå†ç”Ÿæˆã®ãŸã‚ã®Contextæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
                }
            } else {
                 throw new Error("ä¸æ˜ãªå†ç”Ÿæˆã‚¿ã‚¤ãƒ—ã§ã™: " + regenType);
            }

            if (newBbsData) {
                if (Array.isArray(newBbsData)) {
                    
                    if (targetItem.title) {
                         targetItem.comments = newBbsData.map(c => ({
                             ...c,
                             replies: []
                         }));
                         targetItem.error = false; 
                    } else {
                        tournamentState.bbsComments[index] = {
                             title: "å†ç”Ÿæˆã•ã‚ŒãŸåå¿œ",
                             comments: newBbsData,
                             context: targetItem.context,
                             timestamp: Date.now()
                        };
                    }
                } else if (!newBbsData.error) {
                     tournamentState.bbsComments[index] = newBbsData;
                } else {
                     alert('å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + newBbsData.body);
                     btn.textContent = 'å†ç”Ÿæˆ';
                     btn.disabled = false;
                     return;
                }
            }
        } catch(err) {
             console.error("BBSå†ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼:", err);
             alert('å†ç”Ÿæˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
             btn.textContent = 'å†ç”Ÿæˆ';
             btn.disabled = false;
             return;
        }
        
        renderBbsComments(tournamentState.bbsComments);
        saveState();
    }
});
// <script>ã‚¿ã‚°ã®ã€ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿‘ãã«è¿½åŠ 

document.body.addEventListener('change', (e) => {
    if (e.target.matches('#toggle-article-generation')) {
        tournamentState.settings.enableArticleGeneration = e.target.checked;
        saveState();
    }
    if (e.target.matches('#toggle-bbs-generation')) {
        tournamentState.settings.enableBbsGeneration = e.target.checked;
        saveState();
    }
// â–¼â–¼â–¼ ã“ã® else if ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    // --- å®ˆå‚™äº¤ä»£ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ ---
    else if (e.target.name === 'sub-timing') {
        const detailsDiv = document.getElementById('sub-modal-mid-inning-details');
        if (e.target.value === 'mid') {
            detailsDiv.classList.remove('hidden');
        } else {
            detailsDiv.classList.add('hidden');
        }
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

});



   // ==========================================================
//  2.ã€Œé€ä¿¡ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼ (æ–°è¨­)
// ==========================================================
document.body.addEventListener('submit', async (e) => {
    
    // --- æ²ç¤ºæ¿ã®ã€Œè¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã€ãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆ ---
    if (e.target.matches('.reply-form')) {
        e.preventDefault();
        const form = e.target;
        const parentCommentId = form.dataset.commentId;
        const bbsType = form.dataset.bbsType;
        const textarea = form.querySelector('textarea');
        const userReplyText = textarea.value;

        if (!userReplyText.trim()) return;

        form.innerHTML = `<div class="loader text-xs">AIãŒè¿”ä¿¡ã‚’è€ƒãˆã¦ã„ã¾ã™...</div>`;
        
        const commentSource = bbsType === 'general' ? tournamentState.bbsComments : tournamentState.daiyaBbsComments;
        const parentComment = findCommentById(commentSource, parentCommentId);
        const aiPersona = parentComment.personality;
        const context = { tournamentSummary: getTournamentStatusSummary() };
        
        const aiReply = await generateBbsReply(parentCommentId, userReplyText, bbsType, aiPersona, context);

        if (aiReply) {
            const freshParentComment = findCommentById(commentSource, parentCommentId);
            if (freshParentComment) {
                if (!freshParentComment.replies) {
                    freshParentComment.replies = [];
                }
                freshParentComment.replies.push(aiReply);
            }
            if (bbsType === 'general') renderBbsComments(tournamentState.bbsComments);
            else renderDaiyaBbsComments(tournamentState.daiyaBbsComments);
            saveState();
        } else {
            form.innerHTML = `<textarea class="w-full p-2 border rounded text-sm" placeholder="è¿”ä¿¡ã‚’å…¥åŠ›..." required></textarea><button type="submit" class="mt-1 bg-blue-500 text-white px-3 py-1 text-xs rounded hover:bg-blue-600">é€ä¿¡</button>`;
            alert("AIãŒè¿”ä¿¡ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
        }
    } 
    // --- ãƒ¡ã‚¤ãƒ³ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ãŒé€ä¿¡ã•ã‚ŒãŸå ´åˆ ---
    else if (e.target.matches('#main-comment-form')) {
        e.preventDefault();
        const textarea = document.getElementById('main-comment-textarea');
        const userCommentText = textarea.value;
        if (!userCommentText.trim()) return;

        textarea.disabled = true;
        e.target.querySelector('button').disabled = true;
        e.target.querySelector('button').textContent = 'AIãŒè¿”ä¿¡ä¸­...';

        const userComment = {
            id: crypto.randomUUID(),
            personality: 'ã‚ãªãŸ',
            text: userCommentText,
            timestamp: Date.now(),
            replies: []
        };
        
        const aiReplies = await generateMultipleReplies(userCommentText);
        userComment.replies = aiReplies;

        tournamentState.bbsComments.push(userComment);
        renderBbsComments(tournamentState.bbsComments);
        saveState();

        textarea.value = '';
        textarea.disabled = false;
        e.target.querySelector('button').disabled = false;
        e.target.querySelector('button').textContent = 'æŠ•ç¨¿ã™ã‚‹';
    }

}); // â˜…â˜…â˜… é–‰ã˜ã‚«ãƒƒã‚³ } ã®æ­£ã—ã„ä½ç½®ã¯ã“ã“ã§ã™ â˜…â˜…â˜…

// --- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œã“ã®è¨˜äº‹ã§ç¢ºå®šã€ãƒœã‚¿ãƒ³ ---
    document.getElementById('review-save-btn').addEventListener('click', () => {
        if (articleForReview) {
            // ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ç¾åœ¨ã®å†…å®¹ã§è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            articleForReview.title = document.getElementById('review-title').value;
            articleForReview.body = document.getElementById('review-body').value.replace(/\n/g, '\\n');
            
            // æ›´æ–°ã—ãŸè¨˜äº‹ã‚’ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒªã‚¹ãƒˆã«è¿½åŠ 
            tournamentState.news.push(articleForReview);
            renderNews(tournamentState.news);
            saveState();
            
            closeReviewModal();
        }
    });

    // --- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³ ---
    document.getElementById('review-cancel-btn').addEventListener('click', () => {
        closeReviewModal();
    });

document.body.addEventListener('input', (e) => {
        if (e.target.matches('.match-summary-input')) {
            const matchId = e.target.dataset.matchId;
            let match;
            if (tournamentState.matches[matchId]) {
                match = tournamentState.matches[matchId];
            } else {
                 const [region, bracketId] = matchId.split('-');
                 if (tournamentState.autumnData?.regions[region]) {
                    const regionData = tournamentState.autumnData.regions[region];
                    if(bracketId.startsWith('B')) match = regionData.blocks.find(b=>b.id === `${region}-${bracketId}`).matches[matchId];
                    else if(bracketId === 'CHAMP') match = regionData.champBracket.matches[matchId];
                    else if(bracketId === 'REP') match = regionData.repechageBracket.matches[matchId];
                 }
            }
            if (match) {
                match.summary = e.target.value;
                saveState();
            }
        }

// â–¼â–¼â–¼ ã“ã® else if ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã¾ã‚‹ã”ã¨è¿½åŠ  â–¼â–¼â–¼
    // --- è©¦åˆå‰ã®é›°å›²æ°—/å…¬ç´„ ---
    else if (e.target.matches('.team-atmosphere-input')) {
        const matchId = e.target.dataset.matchId;
        const teamKey = e.target.dataset.teamKey; // 'team1' or 'team2'
        const match = findMatchById(matchId);

        if (match) {
            // 'atmosphere_team1' ã¾ãŸã¯ 'atmosphere_team2' ã¨ã„ã†ã‚­ãƒ¼ã§ä¿å­˜
            match[`atmosphere_${teamKey}`] = e.target.value;
            saveState(); // å…¥åŠ›ã™ã‚‹ãŸã³ã«è‡ªå‹•ä¿å­˜
        }
    }
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

// --- â˜… 283å­¦åœ’ã®é¸æ‰‹åè‡ªå‹•å…¥åŠ› (ï¼† èª¿å­ã‚¢ã‚¤ã‚³ãƒ³ã®å‹•çš„æ›´æ–°) ---
        else if (e.target.matches('.player-name')) {
            const input = e.target;
            const playerName = input.value.trim();
            const row = input.closest('tr');
            const table = input.closest('.batting-table');
            if (!row || !table || !currentMatchIdForDetails) return;

            const match = findMatchById(currentMatchIdForDetails);
            if (!match) return;

            const teamKey = table.id.includes('team1') ? 'team1' : 'team2';
            const teamName = match[teamKey];
            
          // --- 1. é¸æ‰‹åç°¿(Roster)ã‹ã‚‰ã®è‡ªå‹•å…¥åŠ› ---
            const roster = TEAM_ROSTER_MASTER[teamName];
            if (roster) {
                const playerData = roster.find(p => p.name === playerName);
                if (playerData) {
                    const numberSelect = row.querySelector('.player-number');
                    const throwBatSelect = row.querySelector('.player-throw-bat');
                    if (numberSelect) numberSelect.value = playerData.number;
                    if (throwBatSelect) throwBatSelect.value = playerData.throwBat;

                    // â–¼â–¼â–¼ ã“ã“ã«è¿½åŠ : ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ã®è‡ªå‹•åæ˜  â–¼â–¼â–¼
                    const captainBtn = row.querySelector('.captain-btn');
                    if (captainBtn) {
                        if (playerData.isCaptain) {
                            // 1. åŒã˜ãƒãƒ¼ãƒ (ãƒ†ãƒ¼ãƒ–ãƒ«)å†…ã®ä»–ã®ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ã‚’å…¨ã¦è§£é™¤
                            const table = row.closest('table');
                            if (table) {
                                table.querySelectorAll('.captain-btn.active').forEach(btn => btn.classList.remove('active'));
                            }
                            // 2. ã“ã®é¸æ‰‹ã®ãƒœã‚¿ãƒ³ã‚’ONã«ã™ã‚‹
                            captainBtn.classList.add('active');
                        } else {
                            // ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ã˜ã‚ƒãªã„é¸æ‰‹åã«å¤‰ãˆãŸå ´åˆã€OFFã«ã™ã‚‹
                            captainBtn.classList.remove('active');
                        }
                    }
                    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
                }
            }

            // --- 2. èª¿å­ã‚¢ã‚¤ã‚³ãƒ³ã®å‹•çš„æ›´æ–° (å…¨ãƒãƒ¼ãƒ å…±é€š) ---
            const teamRecord = tournamentState.teamRecords[teamName];
            let conditionIconHTML = ""; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç©º
            
            if (playerName && teamRecord?.playerStats?.batting[playerName]) {
                // æ‰“æ’ƒã®èª¿å­ã‚’å–å¾—
                const flag = teamRecord.playerStats.batting[playerName].narrative_flag;
                conditionIconHTML = getPlayerConditionIcon(flag);
            } else if (playerName && teamRecord?.playerStats?.pitching[playerName]) {
                // æŠ•æ‰‹ï¼ˆé‡æ‰‹ã§æ‰“å¸­ã«ç«‹ã£ã¦ãªã„å ´åˆï¼‰ã®èª¿å­ã‚’å–å¾—
                const flag = teamRecord.playerStats.pitching[playerName].narrative_flag;
                conditionIconHTML = getPlayerConditionIcon(flag);
            }

            // 3. ã‚¢ã‚¤ã‚³ãƒ³ã‚’HTMLã«æŒ¿å…¥/ç½®æ›
            const container = input.parentElement;
            let iconSpan = container.querySelector('.condition-icon');
            
            if (conditionIconHTML) { // æ–°ã—ã„ã‚¢ã‚¤ã‚³ãƒ³ãŒã‚ã‚‹å ´åˆ
                if (iconSpan) {
                    // æ—¢å­˜ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ç½®ãæ›ãˆ
                    iconSpan.outerHTML = conditionIconHTML;
                } else {
                    // æ–°ã—ãã‚¢ã‚¤ã‚³ãƒ³ã‚’æŒ¿å…¥ (ğŸ“Šãƒœã‚¿ãƒ³ã®å‰ã«)
                    const statsBtn = container.querySelector('.show-player-stats-btn');
                    if (statsBtn) {
                        statsBtn.insertAdjacentHTML('beforebegin', conditionIconHTML);
                    }
                }
            } else if (iconSpan) {
                // æ–°ã—ã„ã‚¢ã‚¤ã‚³ãƒ³ãŒãªãã€å¤ã„ã‚¢ã‚¤ã‚³ãƒ³ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤
                iconSpan.remove();
            }
        }
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²


// ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ãŒå…¥åŠ›ã•ã‚ŒãŸå ´åˆ
    else if (e.target.closest('#inning-score-table')) {
        updateTotalScores();
    }


    
// â–¼â–¼â–¼ THIS IS THE NEW BLOCK TO ADD â–¼â–¼â–¼
    // --- When an "Inning Event" is typed in ---
    else if (e.target.matches('.inning-events-input')) {
        const teamKey = e.target.dataset.teamKey;
        const inningIndex = parseInt(e.target.dataset.inningIndex, 10);
        if (inningIndex >= 0) {
            updateInningState(teamKey, inningIndex); // Instantly update the out count
        }
    }
    // â–²â–²â–² END OF ADDITION â–²â–²â–²
});
// ==========================================================
//  ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã®ç›£è¦– (change)
// ==========================================================
document.body.addEventListener('change', (e) => {
    // --- æ‰“å¸­çµæœãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆ ---
    if (e.target.matches('.batting-result-part')) {
        const cell = e.target.closest('td.batting-result-cell');
        if (!cell) return;
        
        const inningIndex = Array.from(cell.parentElement.children).indexOf(cell) - 5;
        const teamKey = e.target.closest('table.batting-table').id.includes('team1') ? 'team1' : 'team2';
        
        if (inningIndex >= 0) {
            updateInningState(teamKey, inningIndex); // å³åº§ã«ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
        }
    }
});

    modalBg.addEventListener('click', () => newsModal.classList.add('hidden'));
    modalClose.addEventListener('click', () => newsModal.classList.add('hidden'));
    document.getElementById('details-save').addEventListener('click', saveDetailedStats);
    document.getElementById('details-close').addEventListener('click', () => detailsModal.classList.add('hidden'));
    saveLoadCloseBtn.addEventListener('click', () => saveLoadModal.classList.add('hidden'));
    newspaperCloseBtn.addEventListener('click', () => newspaperModal.classList.add('hidden'));
document.getElementById('skip-newspaper-close-btn').addEventListener('click', closeSkipNewspaper);
// â–¼â–¼â–¼ ã“ã®2è¡Œã‚’ 10953è¡Œç›® ã®ç›´å¾Œã«è¿½åŠ  â–¼â–¼â–¼
    const preGameModalClose = document.getElementById('pre-game-modal-close');
    if (preGameModalClose) preGameModalClose.addEventListener('click', () => document.getElementById('pre-game-modal').classList.add('hidden'));
    // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²
document.getElementById('status-modal-close').addEventListener('click', () => {
    document.getElementById('team-status-modal').classList.add('hidden');
});

        generateSaveCodeBtn.addEventListener('click', () => {
        const jsonString = JSON.stringify(tournamentState);
        const compressed = pako.deflate(jsonString);
        const base64 = uint8ArrayToBase64(compressed);
        const outputEl = document.getElementById('save-code-output');
        outputEl.value = base64; // textContentã§ã¯ãªãvalueã«
        outputEl.select();
        document.execCommand('copy'); // è‡ªå‹•ã‚³ãƒ”ãƒ¼
        alert("åˆã„è¨€è‘‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
    });
    
    loadFromCodeBtn.addEventListener('click', () => {
        try {
            const code = document.getElementById('load-code-input').value;
            const binaryString = atob(code);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }
            const decompressed = pako.inflate(bytes, { to: 'string' });
            const loadedState = JSON.parse(decompressed);
            tournamentState = loadedState;
            saveState();
            location.reload();
        } catch (e) {
            showAlert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
    });

let activeScorecardState = {};

/**
 * ç°¡æ˜“å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã€çŠ¶æ…‹ã‚’åˆæœŸåŒ–ã™ã‚‹
 * (â˜…æ‰“çƒæ–¹å‘ãƒ»æ‰“ç‚¹ãƒ»èµ°å¡å…¥åŠ›ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ )
 */
async function openScorecardModal(matchId) {
    const match = findMatchById(matchId);
    if (!match || !match.team1 || !match.team2) {
        alert("ãƒãƒ¼ãƒ ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }

    // 1. çŠ¶æ…‹(State)ã®åˆæœŸåŒ–
    activeScorecardState = {
        matchId: matchId,
        team1: match.team1,
        team2: match.team2,
        inning: 1,      // ç¾åœ¨ã®ã‚¤ãƒ‹ãƒ³ã‚° (1å§‹ã¾ã‚Š)
        topBottom: 'è¡¨', // 'è¡¨' or 'è£'
        outs: 0,
        score: { team1: 0, team2: 0 },
        runners: [null, null, null], // [1B, 2B, 3B] (ä¸­èº«ã¯é¸æ‰‹å)
        battingOrder: { team1: [], team2: [] },
        batterIndex: { team1: 0, team2: 0 },
        playLog: [], // { teamKey, batterName, resultString, ... }
        
        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
        currentStep: "waiting_for_result", // "waiting_for_result", "waiting_for_direction", "waiting_for_rbi", "waiting_for_runner_sb", "waiting_for_runner_cs"
        pendingPlay: { // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’ä¸€æ™‚çš„ã«ä¿æŒ
            type: null,    // "å®‰", "ã‚´ãƒ­", "ä¸‰æŒ¯" ãªã©
            bases: 0,    // 1, 2, 3, 4
            outs: 0,
            walk: false,
            direction: null, // "éŠ", "ä¸­", "æŠ•"
            rbi: 0       // 0, 1, 2, 3, 4
        }
        // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…
    };

    // 2. ä¸¡ãƒãƒ¼ãƒ ã®æ‰“é †ã‚’å–å¾—
    for (const teamKey of ['team1', 'team2']) {
        const teamName = match[teamKey];
        const roster = TEAM_ROSTER_MASTER[teamName];
        if (roster) {
            activeScorecardState.battingOrder[teamKey] = roster.slice(0, 9).map(p => p.name);
        } else {
            // 2-2. ä»–ãƒãƒ¼ãƒ ãªã‚‰ä»®ã®åå‰ã‚’9äººåˆ†ä½œæˆ
            activeScorecardState.battingOrder[teamKey] = Array.from({length: 9}, (_, i) => `${teamName.slice(0, 3)} ${i+1}ç•ª`);
        }
    }

    // 3. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    document.getElementById('scorecard-modal').classList.remove('hidden');
    document.getElementById('scorecard-modal').classList.add('flex');
    
    // 4. UIã‚’åˆæœŸçŠ¶æ…‹ã«æç”»
    renderScorecard();
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²

/**
 * ç°¡æ˜“å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã®UIã‚’ã€ç¾åœ¨ã® `activeScorecardState` ã«åŸºã¥ã„ã¦æ›´æ–°ã™ã‚‹
 * (â˜…å…¨å…¥åŠ›ã‚¹ãƒ†ãƒƒãƒ—ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã‚’è¿½åŠ )
 */
function renderScorecard() {
    const state = activeScorecardState;
    
    // 1. ãƒ˜ãƒƒãƒ€ãƒ¼
    document.getElementById('scorecard-inning').textContent = `${state.inning}å›${state.topBottom}`;
    document.getElementById('scorecard-team1').textContent = `${state.team1}: ${state.score.team1}`;
    document.getElementById('scorecard-team2').textContent = `${state.team2}: ${state.score.team2}`;
    
    // 2. ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆ
    const outsEl = document.getElementById('scorecard-outs');
    outsEl.innerHTML = `
        <span class="${state.outs >= 1 ? 'text-red-500' : 'text-gray-400'}">â—</span>
        <span class="${state.outs >= 2 ? 'text-red-500' : 'text-gray-400'}">â—</span>
        <span class="${state.outs >= 3 ? 'text-red-500' : 'text-gray-400'}">â—</span>
    `;

    // 3. ãƒ©ãƒ³ãƒŠãƒ¼
    document.getElementById('base-1b').classList.toggle('runner', !!state.runners[0]);
    document.getElementById('base-2b').classList.toggle('runner', !!state.runners[1]);
    document.getElementById('base-3b').classList.toggle('runner', !!state.runners[2]);

    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
    // 4. ç¾åœ¨ã®æ‰“è€… ã¨ å…¥åŠ›ã‚¹ãƒ†ãƒƒãƒ—
    const currentTeamKey = state.topBottom === 'è¡¨' ? 'team1' : 'team2';
    const currentBatterIndex = state.batterIndex[currentTeamKey];
    const currentBatterName = state.battingOrder[currentTeamKey][currentBatterIndex];
    const batterNameEl = document.getElementById('scorecard-batter-name');
    const diamondEl = document.querySelector('.baseball-diamond');
    const resultPanel = document.getElementById('scorecard-result-panel');
    const rbiPanel = document.getElementById('scorecard-rbi-panel');

    // å…¨ã¦ã®ç‰¹æ®Šãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
    diamondEl.classList.remove('direction-mode', 'runner-select-mode');
    resultPanel.classList.add('hidden');
    rbiPanel.classList.add('hidden');

    if (state.currentStep === "waiting_for_direction") {
        batterNameEl.textContent = `(${currentBatterIndex + 1}) ${currentBatterName} - STEP 2: æ‰“çƒæ–¹å‘ã‚’é¸æŠ`;
        diamondEl.classList.add('direction-mode'); // ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆè¡¨ç¤º
    } else if (state.currentStep === "waiting_for_rbi") {
        batterNameEl.textContent = `(${currentBatterIndex + 1}) ${currentBatterName} - STEP 3: æ‰“ç‚¹ / ã‚¢ã‚¦ãƒˆ`;
        rbiPanel.classList.remove('hidden'); // RBIãƒœã‚¿ãƒ³è¡¨ç¤º
    } else if (state.currentStep === "waiting_for_runner_sb") {
        batterNameEl.textContent = `[èµ°å¡] ç›—å¡ã—ãŸãƒ©ãƒ³ãƒŠãƒ¼ã‚’é¸æŠ...`;
        diamondEl.classList.add('runner-select-mode'); // ãƒ©ãƒ³ãƒŠãƒ¼ç‚¹æ»…
    } else if (state.currentStep === "waiting_for_runner_cs") {
        batterNameEl.textContent = `[èµ°å¡] ç›—å¡æ­»ã—ãŸãƒ©ãƒ³ãƒŠãƒ¼ã‚’é¸æŠ...`;
        diamondEl.classList.add('runner-select-mode');
    } else if (state.currentStep === "waiting_for_runner_out") {
        batterNameEl.textContent = `[èµ°å¡] èµ°å¡æ­»ã—ãŸãƒ©ãƒ³ãƒŠãƒ¼ã‚’é¸æŠ...`;
        diamondEl.classList.add('runner-select-mode');
    } else {
        // (C) "waiting_for_result"
        batterNameEl.textContent = `(${currentBatterIndex + 1}) ${currentBatterName} - STEP 1: æ‰“å¸­çµæœã‚’é¸æŠ`;
        resultPanel.classList.remove('hidden'); // çµæœãƒœã‚¿ãƒ³è¡¨ç¤º
    }
    // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

    // 5. ãƒ­ã‚°
    const logContent = document.getElementById('scorecard-log-content');
    logContent.innerHTML = state.playLog.map(log => 
        `[${log.inning}${log.topBottom}] ${log.batterName}: ${log.resultString} (${log.outs}ã‚¢ã‚¦ãƒˆ)`
    ).join('<br>');
    logContent.scrollTop = logContent.scrollHeight;
}
// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²


// â–¼â–¼â–¼ æ—¢å­˜ã®ã€ŒhandleScorecardActionã€ã¨ã€ŒsaveScorecardAndCloseã€ (18510è¡Œç›®ã€œ) ã‚’ã€
// â–¼â–¼â–¼ ä»¥ä¸‹ã®3ã¤ã®é–¢æ•°ã§ã€Œã¾ã‚‹ã”ã¨ç½®ãæ›ãˆã€ â–¼â–¼â–¼

// â–¼â–¼â–¼ æ—¢å­˜ã®ã€ŒhandleScorecardActionã€ã¨ã€ŒprocessPlayã€ (18510è¡Œç›®ã€œ) ã‚’ã€
// â–¼â–¼â–¼ ä»¥ä¸‹ã®2ã¤ã®é–¢æ•°ã§ã€Œã¾ã‚‹ã”ã¨ç½®ãæ›ãˆã€ â–¼â–¼â–¼

// â–¼â–¼â–¼ æ—¢å­˜ã®ã€ŒhandleScorecardActionã€ã¨ã€ŒprocessPlayã€ (18510è¡Œç›®ã€œ) ã‚’ã€
// â–¼â–¼â–¼ ä»¥ä¸‹ã®2ã¤ã®é–¢æ•°ã§ã€Œã¾ã‚‹ã”ã¨ç½®ãæ›ãˆã€ â–¼â–¼â–¼

/**
 * [æ”¹ä¿®] ç°¡æ˜“å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œçµæœã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚’å‡¦ç†ã™ã‚‹
 * (â˜…ä½µæ®ºãƒ»çŠ æ‰“ãƒ»çŠ é£›ã‚’STEP 1ã«çµ±åˆ)
 * @param {string} action - 'hit-1b', 'out-dp', 'run-sb' ãªã©
 */
function handleScorecardAction(action) {
    const state = activeScorecardState;
    if (state.outs >= 3) return; // 3ã‚¢ã‚¦ãƒˆãªã‚‰æ“ä½œä¸å¯

    // --- A. æ‰“å¸­çµæœã®å…¥åŠ› ---
    if (state.currentStep === "waiting_for_result" && action.startsWith('run-') === false) {
        state.pendingPlay = { type: null, bases: 0, outs: 0, walk: false, direction: null, rbi: 0 };
        let needsDirection = true;
        let nextStep = "waiting_for_direction"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ–¹å‘å…¥åŠ›

        switch (action) {
            // ãƒ’ãƒƒãƒˆç³»
            case 'hit-1b': state.pendingPlay.type = 'å®‰'; state.pendingPlay.bases = 1; break;
            case 'hit-2b': state.pendingPlay.type = 'äºŒå¡æ‰“'; state.pendingPlay.bases = 2; break;
            case 'hit-3b': state.pendingPlay.type = 'ä¸‰å¡æ‰“'; state.pendingPlay.bases = 3; break;
            case 'hit-hr': state.pendingPlay.type = 'æœ¬å¡æ‰“'; state.pendingPlay.bases = 4; needsDirection = false; nextStep = "waiting_for_rbi"; break;
            // å››æ­»çƒ
            case 'walk-bb': state.pendingPlay.type = 'å››çƒ'; state.pendingPlay.bases = 1; state.pendingPlay.walk = true; needsDirection = false; nextStep = "waiting_for_rbi"; break;
            case 'walk-hbp': state.pendingPlay.type = 'æ­»çƒ'; state.pendingPlay.bases = 1; state.pendingPlay.walk = true; needsDirection = false; nextStep = "waiting_for_rbi"; break;
            // ã‚¢ã‚¦ãƒˆç³»
            case 'out-k': state.pendingPlay.type = 'ä¸‰æŒ¯'; state.pendingPlay.outs = 1; needsDirection = false; nextStep = "process_play"; break; // â˜…æ‰“ç‚¹ãªã—ãƒ»æ–¹å‘ãªã—
            case 'out-go': state.pendingPlay.type = 'ã‚´ãƒ­'; state.pendingPlay.outs = 1; break;
            case 'out-fo': state.pendingPlay.type = 'é£›'; state.pendingPlay.outs = 1; break;
            // â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ â˜…â˜…â˜…
            case 'out-dp': state.pendingPlay.type = 'ä½µæ®º'; state.pendingPlay.outs = 2; break; // â˜…STEP 2 (æ–¹å‘) -> STEP 3 (æ‰“ç‚¹/0ç‚¹) ã¸
            case 'out-sac-b': state.pendingPlay.type = 'çŠ æ‰“'; state.pendingPlay.outs = 1; break; // â˜…STEP 2 (æ–¹å‘) -> STEP 3 (æ‰“ç‚¹/0ç‚¹) ã¸
            case 'out-sac-f': state.pendingPlay.type = 'çŠ é£›'; state.pendingPlay.outs = 1; break; // â˜…STEP 2 (æ–¹å‘) -> STEP 3 (æ‰“ç‚¹/1ç‚¹) ã¸
            // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…
            // ãã®ä»–
            case 'other-error': state.pendingPlay.type = 'ã‚¨ãƒ©ãƒ¼'; state.pendingPlay.bases = 1; break;
            case 'other-fc': state.pendingPlay.type = 'é‡é¸'; state.pendingPlay.bases = 1; break;
            
            default: return;
        }

        // 2. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆ¤æ–­
        if (nextStep === "process_play") {
            // ä¸‰æŒ¯ãªã©ã€å³æ™‚å‡¦ç†
            state.pendingPlay.direction = "æŠ•"; // ä»®ã®æ–¹å‘
            processPlay();
        } else if (needsDirection) {
            state.currentStep = "waiting_for_direction";
        } else {
            state.pendingPlay.direction = "æŠ•"; // ä»®ã®æ–¹å‘
            state.currentStep = "waiting_for_rbi";
        }
    }
    // --- B. èµ°å¡ãƒ—ãƒ¬ãƒ¼ã®å…¥åŠ› ---
    else if (state.currentStep === "waiting_for_result" && action.startsWith('run-')) {
        if (action === 'run-sb') { // ç›—å¡
            if (state.runners[0] === null && state.runners[1] === null) { alert("ç›—å¡ã§ãã‚‹ãƒ©ãƒ³ãƒŠãƒ¼ãŒã„ã¾ã›ã‚“ã€‚"); return; }
            state.currentStep = "waiting_for_runner_sb";
        }
        else if (action === 'run-cs') { // ç›—å¡æ­»
            if (state.runners[0] === null && state.runners[1] === null) { alert("ç›—å¡ã§ãã‚‹ãƒ©ãƒ³ãƒŠãƒ¼ãŒã„ã¾ã›ã‚“ã€‚"); return; }
            state.currentStep = "waiting_for_runner_cs";
        }
        else if (action === 'run-other-out') { // èµ°å¡æ­»
            if (state.runners.every(r => r === null)) { alert("ãƒ©ãƒ³ãƒŠãƒ¼ãŒã„ã¾ã›ã‚“ã€‚"); return; }
            state.currentStep = "waiting_for_runner_out";
        }
    }
    
    renderScorecard(); // UIã‚’æ›´æ–°
}

/**
 * [æ”¹ä¿®ãƒ»å®Œå…¨ç‰ˆ] ãƒ—ãƒ¬ãƒ¼ã‚’ç¢ºå®šã—ã€ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ›´æ–°ã™ã‚‹
 * (â˜…è©³ç´°å…¥åŠ›ã¨äº’æ›æ€§ã®ã‚ã‚‹æ–‡å­—åˆ—ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ä¿å­˜)
 */
function processPlay() {
    const state = activeScorecardState;
    if (!state.pendingPlay.type) return;

    let { type, bases, outs, walk, direction, rbi } = state.pendingPlay;
    const currentTeamKey = state.topBottom === 'è¡¨' ? 'team1' : 'team2';
    const currentBatterIndex = state.batterIndex[currentTeamKey];
    const currentBatterName = state.battingOrder[currentTeamKey][currentBatterIndex];

    // 1. æ‰“ç‚¹å…¥åŠ›ã«ã‚ˆã‚‹æœ€çµ‚æ±ºå®š
    if (state.currentStep === "waiting_for_rbi") {
        rbi = (rbi === 'dp' || rbi === 'sf' || rbi === 'sh') ? 0 : parseInt(rbi, 10);
        // ä½µæ®ºãƒ»çŠ é£›ãƒ»çŠ æ‰“ã®æ‰“ç‚¹ã¯åˆ¥é€”è¨ˆç®—ï¼ˆrbiå¤‰æ•°ã¯é¸æŠè‚¢ã®IDã¨ã—ã¦ä½¿ã‚ã‚Œã¦ã„ã‚‹ãŸã‚ãƒªã‚»ãƒƒãƒˆï¼‰
        if (state.pendingPlay.rbi === 'sf') rbi = 1; // çŠ é£›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1ç‚¹ï¼ˆé¸æŠè‚¢ãŒãªã„å ´åˆï¼‰
        // â€»ä»Šå›ã®UIã§ã¯ã€Œ[1ç‚¹]ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã•ã›ã‚‹ã®ã§ã€parseInt(rbi) ã§æ­£ã—ã„ç‚¹æ•°ãŒå…¥ã‚‹
    }

    // 2. ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆã‚’åŠ ç®—
    state.outs += outs;

    // 3. ãƒ©ãƒ³ãƒŠãƒ¼ã‚’é€²å¡
    let scoreThisPlay = 0;
    const newRunners = [null, null, null];
    
    if (bases === 4) { // ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³
        if (state.runners[2]) scoreThisPlay++;
        if (state.runners[1]) scoreThisPlay++;
        if (state.runners[0]) scoreThisPlay++;
        state.runners = [null, null, null];
        scoreThisPlay += 1; // æ‰“è€…ç”Ÿé‚„
    } else if (walk) { // å››æ­»çƒ
        if (state.runners[0] && state.runners[1] && state.runners[2]) { // æŠ¼ã—å‡ºã—
            scoreThisPlay = (rbi > 0 ? rbi : 1);
        } else {
            if (state.runners[0] && state.runners[1]) newRunners[2] = state.runners[1];
            if (state.runners[0]) newRunners[1] = state.runners[0];
            newRunners[0] = currentBatterName;
        }
    } else if (bases > 0) { // ãƒ’ãƒƒãƒˆã€ã‚¨ãƒ©ãƒ¼ã€é‡é¸
        scoreThisPlay = rbi; // æ‰“ç‚¹ã‚’ãã®ã¾ã¾åŠ ç®—ï¼ˆç°¡æ˜“ã‚·ãƒŸãƒ¥ï¼‰
        if (state.runners[0]) newRunners[bases] = state.runners[0]; // ç°¡æ˜“çš„ã«æŠ¼ã—å‡ºã—
        newRunners[bases - 1] = currentBatterName;
    } else if (type === 'çŠ é£›' || type === 'ã‚´ãƒ­' || type === 'ä½µæ®º') {
        scoreThisPlay = rbi;
        // ç°¡æ˜“: çŠ é£›ãªã‚‰3å¡ãƒ©ãƒ³ãƒŠãƒ¼ç”Ÿé‚„ã¨ã¿ãªã™
        if (rbi > 0 && state.runners[2]) state.runners[2] = null;
    } else if (type === 'çŠ æ‰“') {
        // ç°¡æ˜“: ãƒ©ãƒ³ãƒŠãƒ¼ã‚’é€²ã‚ã‚‹
        if (state.runners[1]) newRunners[2] = state.runners[1];
        if (state.runners[0]) newRunners[1] = state.runners[0];
    } else {
        // ãã®ä»–ï¼ˆä¸‰æŒ¯ãªã©ï¼‰ã¯ãƒ©ãƒ³ãƒŠãƒ¼å‹•ã‹ãš
        state.runners.forEach((r, i) => newRunners[i] = r);
    }
    
    state.runners = newRunners;
    state.score[currentTeamKey] += scoreThisPlay;

    // 4. ãƒ­ã‚°ï¼ˆè©³ç´°å…¥åŠ›äº’æ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰ã‚’ç”Ÿæˆ
    // â˜…æ–¹å‘ + çµæœ (ä¾‹: "ä¸­å®‰", "éŠã‚´")
    let resultString = direction ? direction + type : type;
    
    // â˜…ç‚¹æ•° (ä¾‹: "ä¸­å®‰2ç‚¹")
    if (scoreThisPlay > 0 && type !== 'æœ¬å¡æ‰“') {
        resultString += `${scoreThisPlay}ç‚¹`;
    } else if (type === 'æœ¬å¡æ‰“' && scoreThisPlay > 0) {
         // æœ¬å¡æ‰“ã¯ç‚¹æ•°ã‚’å«ã‚ãªã„ã®ãŒä¸€èˆ¬çš„ã ãŒã€è©³ç´°å…¥åŠ›ã®ãƒ‘ãƒ¼ã‚¹ã«åˆã‚ã›ã¦ãŠã
         // (è©³ç´°å…¥åŠ›ã¯ "å³æœ¬" ã ã‘ã§æ‰“ç‚¹ã‚’è‡ªå‹•è¨ˆç®—ã—ãªã„ãŸã‚ã€æ˜ç¤ºçš„ã«ç‚¹æ•°ã‚’å…¥ã‚Œã‚‹ã‹ã€ãƒ‘ãƒ¼ã‚¹å´ã§å¯¾å¿œãŒå¿…è¦)
         // ã“ã“ã§ã¯å¿µã®ãŸã‚ç‚¹æ•°ã‚’å…¥ã‚Œã¦ãŠã
         resultString += `${scoreThisPlay}ç‚¹`;
    }

    state.playLog.push({
        inning: state.inning,
        topBottom: state.topBottom,
        batterName: currentBatterName,
        batterOrder: (currentBatterIndex + 1).toString(),
        resultString: resultString,
        outs: state.outs
    });

    // 5. æ¬¡ã®æ‰“è€…ã¸
    state.batterIndex[currentTeamKey] = (currentBatterIndex + 1) % state.battingOrder[currentTeamKey].length;

    // 6. 3ã‚¢ã‚¦ãƒˆãƒã‚§ãƒ³ã‚¸
    if (state.outs >= 3) {
        if (state.topBottom === 'è¡¨') {
            state.topBottom = 'è£';
        } else {
            state.topBottom = 'è¡¨';
            state.inning++;
        }
        state.outs = 0;
        state.runners = [null, null, null];
    }
    
    // 7. çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
    state.currentStep = "waiting_for_result";
    state.pendingPlay = {};
    
    renderScorecard();
}

// â–²â–²â–² ç½®ãæ›ãˆã“ã“ã¾ã§ â–²â–²â–²
// â–¼â–¼â–¼ æ—¢å­˜ã®ã€ŒsaveScorecardAndCloseã€ (18610è¡Œç›®ã€œ) ã‚’ã€ä»¥ä¸‹ã§ã€Œç½®ãæ›ãˆã€ â–¼â–¼â–¼

/**
 * [æ”¹ä¿®ãƒ»å®Œå…¨ç‰ˆ] ç°¡æ˜“å…¥åŠ›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã€Œè©³ç´°å…¥åŠ›ã€ã®å½¢å¼ã«å¤‰æ›ãƒ»ä¿å­˜ãƒ»é›†è¨ˆã™ã‚‹
 * (â˜…dbMatchæœªå®šç¾©ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£)
 */
function saveScorecardAndClose() {
    const state = activeScorecardState;
    const match = findMatchById(state.matchId);
    if (!match) return;

    // 1. æ–°ã—ã„ `details` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æº–å‚™
    const numInnings = Math.max(9, state.inning);
    const details = { 
        inningScore: { team1: Array(numInnings).fill(0), team2: Array(numInnings).fill(0) }, 
        batting: { team1: [], team2: [] }, 
        pitching: { team1: [], team2: [] }, 
        fielding: { team1: [], team2: [] }, 
        playerGameStats: { team1: {}, team2: {} },
        positionChanges: []
    };

    // 2. æ‰“é †ãƒªã‚¹ãƒˆã‚’ details.batting ã«å¤‰æ› (åˆæœŸåŒ–)
    for (const teamKey of ['team1', 'team2']) {
        details.batting[teamKey] = state.battingOrder[teamKey].map((name, index) => ({
            order: (index + 1).toString(),
            name: name,
            number: '', pos: '', throwBat: '', sub_type: null,
            results: Array(numInnings).fill('') 
        }));
    }

    // 3. ãƒ—ãƒ¬ãƒ¼ãƒ­ã‚°(playLog)ã‚’è§£æã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ³¨å…¥
    state.playLog.forEach(log => {
        const inningIndex = log.inning - 1;
        const teamKey = log.topBottom === 'è¡¨' ? 'team1' : 'team2';
        
        // A. ã‚¤ãƒ‹ãƒ³ã‚°ã‚¹ã‚³ã‚¢ã®æ›´æ–°
        const rbiMatch = log.resultString.match(/(\d+)ç‚¹/);
        if (rbiMatch) {
            details.inningScore[teamKey][inningIndex] += parseInt(rbiMatch[1], 10);
        } else if (log.resultString.includes('æœ¬å¡æ‰“')) {
            if (!log.resultString.includes('ç‚¹')) details.inningScore[teamKey][inningIndex] += 1;
        }
        if (log.resultString.includes('ç”Ÿé‚„') || log.resultString.includes('ãƒ›ãƒ¼ãƒ ã‚¤ãƒ³')) {
             if (!log.resultString.includes('ç‚¹') && !log.resultString.includes('æœ¬å¡æ‰“')) {
                 details.inningScore[teamKey][inningIndex] += 1;
             }
        }

        // B. æ‰“å¸­çµæœã®æ ¼ç´
        if (log.batterOrder === '-') {
            // èµ°å¡ãƒ—ãƒ¬ãƒ¼
            const teamBatters = details.batting[teamKey];
            let targetBatter = null;
            for (let i = teamBatters.length - 1; i >= 0; i--) {
                if (teamBatters[i].results[inningIndex]) {
                    targetBatter = teamBatters[i];
                    break;
                }
            }
            if (targetBatter) {
                let currentRes = targetBatter.results[inningIndex];
                if (!currentRes.includes(';')) {
                    targetBatter.results[inningIndex] += `; ${log.resultString}`;
                } else {
                    targetBatter.results[inningIndex] += `, ${log.resultString}`;
                }
            }
        } else {
            // æ‰“æ’ƒãƒ—ãƒ¬ãƒ¼
            const batter = details.batting[teamKey].find(p => p.order === log.batterOrder);
            if (batter) {
                if (batter.results[inningIndex]) {
                    batter.results[inningIndex] += `ã€${log.resultString}`;
                } else {
                    batter.results[inningIndex] = log.resultString;
                }
            }
        }
    });
    
    // 4. ã‚¹ã‚³ã‚¢ã®ä¿å­˜
    match.score1 = details.inningScore.team1.reduce((sum, s) => sum + s, 0);
    match.score2 = details.inningScore.team2.reduce((sum, s) => sum + s, 0);

    // 5. ã‚³ãƒ¼ãƒ«ãƒ‰åˆ¤å®š (ã‚¤ãƒ‹ãƒ³ã‚°æ•°ã«åŸºã¥ã)
    const lastInning = state.inning;
    if (lastInning < 9 && (Math.abs(match.score1 - match.score2) >= 7)) {
         match.calledGame = true;
         match.calledInning = lastInning;
    }

    // 6. match.details ã‚’æ›´æ–°
    match.details = details;

    // 7. é€šç®—æˆç¸¾ã®é›†è¨ˆã‚’å®Ÿè¡Œ
    updatePlayerStatsFromDetails(match);
    
    // 8. ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢HTMLç”Ÿæˆ 
    match.boxScoreHtml = generateBoxScoreHTML(match);

    // 9. ä¿å­˜ã—ã¦é–‰ã˜ã‚‹
    saveState();
    document.getElementById('scorecard-modal').classList.add('hidden');
    document.getElementById('scorecard-modal').classList.remove('flex');
    activeScorecardState = {}; 
    
    renderTournament(tournamentState);
    alert("è©¦åˆçµŒéã‚’ä¿å­˜ã—ã€è©³ç´°ãƒ‡ãƒ¼ã‚¿ã«åæ˜ ã—ã¾ã—ãŸã€‚");
}

/**
 * [NEW] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ»ãƒŠãƒ©ãƒ†ã‚£ãƒ–æ›´æ–°
 * è©¦åˆç›´å¾Œã€åŠ‡çš„ãªå‹åˆ©ï¼ˆã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆã‚­ãƒªãƒ³ã‚°ç­‰ï¼‰ã‚’æŒ™ã’ãŸãƒãƒ¼ãƒ ã®infoã‚’å³åº§ã«æ›¸ãæ›ãˆã‚‹
 */
async function updateNarrativeImmediate(winnerName, loserName, matchContext) {
    const winnerRank = calculateRank(winnerName, tournamentState);
    const loserRank = calculateRank(loserName, tournamentState);
    const rankValues = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1 };
    
    // æ›´æ–°æ¡ä»¶: æ ¼ä¸Šæ’ƒç ´ï¼ˆãƒ©ãƒ³ã‚¯å·®2ä»¥ä¸Šï¼‰ ã¾ãŸã¯ Eãƒ©ãƒ³ã‚¯ãŒå‹åˆ©
    const isGiantKilling = (rankValues[loserRank] - rankValues[winnerRank]) >= 2;
    const isCinderella = (winnerRank === 'E' || winnerRank === 'D') && ['A', 'B'].includes(loserRank);

    // é€šå¸¸ã®å‹åˆ©ã§ã¯æ›´æ–°ã—ãªã„ï¼ˆAPIç¯€ç´„ã¨ã€ç‰¹åˆ¥æ„Ÿã‚’å‡ºã™ãŸã‚ï¼‰
    if (!isGiantKilling && !isCinderella) return;

    const originalInfo = TEAM_DATA[winnerName].info;
    const roundName = getRoundNameFromMatchId(matchContext.matchId);
    const score = `${matchContext.dbMatch.score1}-${matchContext.dbMatch.score2}`;

    // ãƒ‹ãƒ¥ãƒ¼ã‚¹æ¬„ã«æ›´æ–°é€šçŸ¥ã‚’å‡ºã™æ¼”å‡º
    const newsContainer = document.getElementById('news-articles');
    const notifyEl = document.createElement('div');
    notifyEl.className = "bg-blue-50 p-3 rounded border border-blue-200 text-blue-800 text-sm mb-2 animate-pulse";
    notifyEl.innerHTML = `ğŸ”„ <strong>${winnerName}</strong>ã®è©•ä¾¡ãŒæ€¥ä¸Šæ˜‡ã—ã¦ã„ã¾ã™...ï¼ˆç´¹ä»‹æ–‡æ›´æ–°ä¸­ï¼‰`;
    if(newsContainer) newsContainer.prepend(notifyEl);

    const prompt = `ã‚ãªãŸã¯é«˜æ ¡é‡çƒã®ãƒ‡ãƒ¼ã‚¿æ‹…å½“è€…ã§ã™ã€‚
ä»Šã—ãŒãŸè¡Œã‚ã‚ŒãŸè©¦åˆã§ã€ä»¥ä¸‹ã®åŠ‡çš„ãªå‹åˆ©ãŒã‚ã‚Šã¾ã—ãŸã€‚
ã“ã®çµæœã‚’åæ˜ ã—ã¦ã€**å‹åˆ©ãƒãƒ¼ãƒ ã€Œ${winnerName}ã€ã®ãƒãƒ¼ãƒ ç´¹ä»‹æ–‡ï¼ˆinfoï¼‰**ã‚’ã€å³åº§ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚

### çŠ¶æ³
- **ãƒãƒ¼ãƒ :** ${winnerName} (å…ƒã®è©•ä¾¡: ${winnerRank}ãƒ©ãƒ³ã‚¯)
- **å¯¾æˆ¦ç›¸æ‰‹:** ${loserName} (å…ƒã®è©•ä¾¡: ${loserRank}ãƒ©ãƒ³ã‚¯)
- **çµæœ:** ${roundName}ã«ã¦ã€${score} ã§å‹åˆ©
- **ã“ã‚Œã¾ã§ã®ç´¹ä»‹æ–‡:** "${originalInfo}"

### æŒ‡ç¤º
- å…ƒã®ç‰¹å¾´ï¼ˆåœ°åŸŸã‚„å­¦æ ¡ã®ç‰¹è‰²ï¼‰ã‚’æ®‹ã—ã¤ã¤ã€ã€Œå¼·è±ª${loserName}ã‚’æ’ƒç ´ã—ãŸã€ã¨ã„ã†æœ€æ–°ã®å®Ÿç¸¾ã‚’å¼·èª¿ã—ãŸæ–‡ç« ã«ã—ã¦ãã ã•ã„ã€‚
- ã€Œä¸€èºã€ä»Šå¤§ä¼šã®å°é¢¨ã®ç›®ã¨ãªã£ãŸã€ã€Œæ—‹é¢¨ã‚’å·»ãèµ·ã“ã—ã¦ã„ã‚‹ã€ã¨ã„ã£ãŸã€å‹¢ã„ã‚’æ„Ÿã˜ã•ã›ã‚‹è¡¨ç¾ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
- 100æ–‡å­—ä»¥å†…ã€‚

### å‡ºåŠ›å½¢å¼ (JSON)
{"newInfo": "ï¼ˆæ–°ã—ã„ç´¹ä»‹æ–‡ï¼‰"}`;

    try {
        const response = await fetchWithRetry({ contents: [{ role: "user", parts: [{ text: prompt }] }] });
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            const json = parseJsonFromText(result.candidates[0].content.parts[0].text);
            if (json && json.newInfo) {
                console.log(`[Realtime Update] ${winnerName}: ${json.newInfo}`);
                
                // â˜…ãƒ‡ãƒ¼ã‚¿ã‚’å³åº§ã«ä¸Šæ›¸ã
                TEAM_DATA[winnerName].info = json.newInfo;
                
                // é€šçŸ¥ã‚’æ›´æ–°
                notifyEl.classList.remove('animate-pulse', 'bg-blue-50', 'border-blue-200', 'text-blue-800');
                notifyEl.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
                notifyEl.innerHTML = `âœ… <strong>${winnerName}</strong>ã®ãƒãƒ¼ãƒ ç´¹ä»‹æ–‡ãŒã€Œ${roundName}çªç ´ä»•æ§˜ã€ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼`;
                setTimeout(() => notifyEl.remove(), 5000);
            }
        }
    } catch (e) {
        console.error("ãƒŠãƒ©ãƒ†ã‚£ãƒ–æ›´æ–°ã‚¨ãƒ©ãƒ¼", e);
        notifyEl.remove();
    }
}

/**
 * [NEW] è©¦åˆã®è©³ç´°ãƒ‡ãƒ¼ã‚¿(details)ã‚’åŸºã«ã€ãƒãƒ¼ãƒ ã¨å€‹äººã®é€šç®—æˆç¸¾ã‚’æ›´æ–°ã™ã‚‹
 * (saveDetailedStats ã¨ saveScorecardAndClose ã§å…±æœ‰ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯)
 */
function updatePlayerStatsFromDetails(match) {
    const details = match.details;
    if (!details || !details.batting) return;

    // æˆç¸¾ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã¯å‘¼ã³å‡ºã—å…ƒã§è¡Œã†å‰æ

    for (const teamKey of ['team1', 'team2']) {
        const teamName = match[teamKey];
        const teamRecord = tournamentState.teamRecords[teamName];
        if (!teamRecord) continue;

        if (!teamRecord.playerStats) teamRecord.playerStats = { batting: {}, pitching: {} };
        if (!teamRecord.tournamentStats) teamRecord.tournamentStats = { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0, sb: 0, bb: 0, hbp: 0, sf: 0, tb: 0, r: 0, so: 0 };

        const playersAppearedThisGame = new Set();
        const battingData = details.batting[teamKey] || [];
        const playerGameStats = {}; // ã“ã®è©¦åˆã®é›†è¨ˆçµæœã‚’ä¸€æ™‚ä¿å­˜

        // --- A. æ‰“æ’ƒæˆç¸¾ã®é›†è¨ˆ ---
        battingData.forEach(playerData => {
            const playerName = playerData.name;
            if (!playerName) return;

            // åˆæœŸåŒ–
            if (!teamRecord.playerStats.batting[playerName]) {
                teamRecord.playerStats.batting[playerName] = { games: 0, pa: 0, ab: 0, h: 0, hr: 0, rbi: 0, sb: 0, bb: 0, hbp: 0, sf: 0, tb: 0, r: 0, so: 0, gamelogs: [] };
            }
            const careerStats = teamRecord.playerStats.batting[playerName];
            const gameStats = { pa: 0, ab: 0, h: 0, hr: 0, rbi: 0, sb: 0, bb: 0, hbp: 0, sf: 0, tb: 0, r: 0, so: 0, played: false, strongHits: 0, weakHits: 0, strongOuts: 0, weakOuts: 0 };

            // æ‰“å¸­çµæœã®è§£æ
            playerData.results.forEach(inningResultString => {
                (inningResultString || '').split('ã€').forEach(atBatString => {
                    if (!atBatString) return;
                    const [batterPlay, runnerPlaysString] = atBatString.split(';');
                    
                    // æ‰“è€…ãƒ—ãƒ¬ãƒ¼
                    if (batterPlay && batterPlay.trim() !== '') {
                        let clean = batterPlay.trim().replace(/^â˜…:/, '').replace(/^[SW]:/, '');
                        
                        gameStats.played = true; gameStats.pa++;
                        
                        const isHit = BATTING_RESULTS.hits.some(h => clean.includes(h));
                        const isWalk = ['å››çƒ', 'æ­»çƒ', 'æ•¬é '].some(w => clean.includes(w));
                        const isSac = ['çŠ é£›', 'çŠ æ‰“', 'çŠ å¤±'].some(w => clean.includes(w));
                        const isOut = BATTING_RESULTS.outs.some(o => clean.includes(o));

                        if (!isWalk && !isSac && !clean.includes('å¦¨å®³')) { gameStats.ab++; }
                        
                        if (clean.includes('å››çƒ') || clean.includes('æ•¬é ')) gameStats.bb++;
                        if (clean.includes('æ­»çƒ')) gameStats.hbp++;
                        if (clean.includes('çŠ é£›')) gameStats.sf++;

                        if (clean.includes('æœ¬å¡æ‰“')) { gameStats.h++; gameStats.tb += 4; gameStats.hr++; }
                        else if (clean.includes('ä¸‰å¡æ‰“')) { gameStats.h++; gameStats.tb += 3; }
                        else if (clean.includes('äºŒå¡æ‰“')) { gameStats.h++; gameStats.tb += 2; }
                        else if (clean.includes('å®‰')) { gameStats.h++; gameStats.tb += 1; }

                        if (clean.includes('ç‚¹')) { 
                            const rbiValue = (clean.match(/(\d+)ç‚¹/) || [0, 0])[1];
                            gameStats.rbi += parseInt(rbiValue, 10);
                        }
                        if (clean.includes('ä¸‰æŒ¯')) gameStats.so++;
                        
                        // å‹¢ã„é›†è¨ˆ (AIç”¨)
                        if (batterPlay.startsWith('S:')) { if(isHit) gameStats.strongHits++; if(isOut) gameStats.strongOuts++; }
                        if (batterPlay.startsWith('W:')) { if(isHit) gameStats.weakHits++; if(isOut) gameStats.weakOuts++; }
                    }

                    // èµ°å¡ãƒ—ãƒ¬ãƒ¼
                    (runnerPlaysString || '').split(',').forEach(runnerPlay => {
                        const parts = runnerPlay.trim().split(' ');
                        // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: [é¸æ‰‹å, ãƒ—ãƒ¬ãƒ¼, è©³ç´°]
                        // ã“ã“ã§ã¯playerData.nameã¨ä¸€è‡´ã™ã‚‹å ´åˆã®ã¿é›†è¨ˆï¼ˆã¾ãŸã¯runnerPlayå†…ã®åå‰ã‚’ä¿¡ã˜ã‚‹ï¼‰
                        if (parts[0] === playerName) {
                            if (parts[1] === 'ç›—å¡') gameStats.sb++;
                            if (parts[1] === 'ç”Ÿé‚„' || (parts[1] === 'é€²å¡' && parts[2] === 'æœ¬å¡ã¸(ç”Ÿé‚„)')) gameStats.r++;
                        }
                    });
                });
            });

            // é€šç®—æˆç¸¾ã¸ã®åŠ ç®—
            const isNonBattingSub = playerData.sub_type === 'DEF' || playerData.sub_type === 'PR';
            if ((gameStats.played || isNonBattingSub) && !playersAppearedThisGame.has(playerName)) {
                careerStats.games++;
                playersAppearedThisGame.add(playerName);
            }

            for (const key of Object.keys(gameStats)) {
                if (typeof gameStats[key] === 'number') {
                    careerStats[key] = (careerStats[key] || 0) + gameStats[key];
                    // ãƒãƒ¼ãƒ åˆè¨ˆã«ã‚‚åŠ ç®—
                    if (['pa', 'ab', 'h', 'hr', 'rbi', 'sb', 'bb', 'hbp', 'sf', 'tb', 'r', 'so'].includes(key)) {
                        teamRecord.tournamentStats[key] = (teamRecord.tournamentStats[key] || 0) + gameStats[key];
                    }
                }
            }

            // Gamelogä¿å­˜
            playerGameStats[playerName] = gameStats;
            if (!careerStats.gamelogs) careerStats.gamelogs = [];
            const opponentName = teamKey === 'team1' ? match.team2 : match.team1;
            const opponentRank = calculateRank(opponentName, tournamentState);
            
            // æ—¢å­˜ã®ãƒ­ã‚°ãŒã‚ã‚Œã°æ›´æ–°ã€ãªã‘ã‚Œã°è¿½åŠ 
            const existingLogIdx = careerStats.gamelogs.findIndex(l => l.matchId === match.id);
            const newLog = {
                matchId: match.id,
                date: match.schedule?.date || 'ä¸æ˜',
                round: getRoundNameFromMatchId(match.id),
                opponent: opponentName,
                opponentRank: opponentRank,
                order: playerData.order,
                sub_type: playerData.sub_type,
                stats: gameStats
            };
            
            if (existingLogIdx >= 0) careerStats.gamelogs[existingLogIdx] = newLog;
            else careerStats.gamelogs.push(newLog);
        });

        // match.details ã«è©¦åˆã”ã¨ã®ã‚¹ã‚¿ãƒƒãƒ„ã‚’ä¿å­˜
        if (!details.playerGameStats) details.playerGameStats = { team1: {}, team2: {} };
        details.playerGameStats[teamKey] = playerGameStats;
        
        // --- B. æŠ•æ‰‹æˆç¸¾ã®é›†è¨ˆ (ç°¡æ˜“å…¥åŠ›ã§ã¯å…¥åŠ›ã•ã‚Œãªã„ãŒã€æ çµ„ã¿ã¯æ®‹ã™) ---
        // (è©³ç´°å…¥åŠ›ã§å…¥åŠ›ã•ã‚ŒãŸå ´åˆã«å‚™ãˆã¦ã€æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶­æŒ)
        // ... (æŠ•æ‰‹é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯ã¯çœç•¥ã€‚fillPitcherStatsFromBattingãªã©ã‚’ä½¿ã†å‰æ) ...
    }
}

// é€šçŸ¥ãƒãƒŠãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ -> SNSãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    const trendNotification = document.getElementById('trend-notification');
    if (trendNotification) {
        trendNotification.addEventListener('click', () => {
            const snsModal = document.getElementById('sns-modal');
            snsModal.classList.remove('hidden');
            snsModal.classList.add('flex');
            switchSnsTab('trend'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¿ãƒ–
            trendNotification.classList.remove('show'); // é€šçŸ¥ã¯æ¶ˆã™
        });
    }

    // SNSãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    const snsModalClose = document.getElementById('sns-modal-close');
    if (snsModalClose) {
        snsModalClose.addEventListener('click', () => {
            const snsModal = document.getElementById('sns-modal');
            snsModal.classList.add('hidden');
            snsModal.classList.remove('flex');
        });
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆé–¢æ•°ã‚’HTMLå´(onclickå±æ€§)ã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ç™»éŒ²
    window.switchSnsTab = switchSnsTab;

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
    initializeApp();
</script>

<script>
    mermaid.initialize({ startOnLoad: true });
</script>




<div id="homepage-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center z-[200]">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[95vh] flex flex-col">
        <div class="flex-shrink-0 flex justify-between items-center border-b p-4 bg-gray-50 rounded-t-lg">
            <h3 class="text-xl font-bold text-blue-700">283å­¦åœ’ é«˜ç­‰å­¦æ ¡ - ç¡¬å¼é‡çƒéƒ¨</h3>
            <button id="homepage-modal-close" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button>
        </div>
        
        <div id="homepage-scroll-container" class="flex-grow overflow-y-auto" style="font-family: 'Noto Sans JP', sans-serif; background-color: #f4f7fa;">
            
            <header class="homepage-nav">
    <div class="container mx-auto px-6 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-700 rounded flex items-center justify-center text-white font-bold text-lg shadow-sm">2</div>
            <span class="text-xl font-extrabold text-gray-800 tracking-tighter">
                <span class="text-blue-700">283</span>å­¦åœ’
            </span>
        </div>
        <nav class="hidden md:flex space-x-6 text-sm font-bold text-gray-600">
            <a href="#about" class="hover:text-blue-700 transition-colors">ãƒãƒ¼ãƒ </a>
            <a href="#players" class="hover:text-blue-700 transition-colors">é¸æ‰‹</a>
            <a href="#roster" class="hover:text-blue-700 transition-colors">éƒ¨å“¡</a>
            <a href="#results" class="hover:text-blue-700 transition-colors">æˆ¦ç¸¾</a>
            <a href="#access" class="hover:text-blue-700 transition-colors">ã‚¢ã‚¯ã‚»ã‚¹</a>
        </nav>
        <div class="md:hidden">
            <button id="mobile-menu-button" class="text-gray-500 hover:text-blue-700 p-1">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
        </div>
    </div>
    <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-100 absolute w-full shadow-lg">
        <div class="flex flex-col p-2">
            <a href="#about" class="mobile-nav-link block py-3 px-4 text-gray-700 font-bold hover:bg-blue-50 rounded-lg">ãƒãƒ¼ãƒ </a>
            <a href="#players" class="mobile-nav-link block py-3 px-4 text-gray-700 font-bold hover:bg-blue-50 rounded-lg">é¸æ‰‹</a>
            <a href="#roster" class="mobile-nav-link block py-3 px-4 text-gray-700 font-bold hover:bg-blue-50 rounded-lg">éƒ¨å“¡</a>
            <a href="#results" class="mobile-nav-link block py-3 px-4 text-gray-700 font-bold hover:bg-blue-50 rounded-lg">æˆ¦ç¸¾</a>
        </div>
    </div>
</header>

<section class="hero-section">
    <h1 class="text-6xl md:text-8xl font-black text-white tracking-widest mb-2" style="text-shadow: 0 4px 10px rgba(0,0,0,0.5); font-family: 'Yuji Syuku', serif;">å¼·</h1>
    <p class="text-white/90 text-lg md:text-xl font-medium bg-black/30 px-6 py-1 rounded-full backdrop-blur-sm">
        å€‹ã®æŠ€é‡ã«é ¼ã‚‰ãšã€ä¸€äººã²ã¨ã‚Šã®åŠ›ã‚’é›†ã‚ã¦æˆ¦ã†ã€‚
    </p>
</section>

            <div class="container mx-auto px-4 sm:px-6 py-20">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">

                    <main class="lg:col-span-2 space-y-20">

                        <section id="about" class="bg-white p-8 rounded-xl shadow-xl fade-in-section">
                            <h2 class="text-3xl font-bold text-gray-900 section-title mb-6">é‡çƒéƒ¨ã«ã¤ã„ã¦</h2>
                            <span class="inline-block bg-blue-700 text-white text-sm font-bold px-4 py-1 rounded-full mb-6">æ˜¨å¹´åº¦çœŒå¤§ä¼šç‹è€…ãƒ»ç¬¬1ã‚·ãƒ¼ãƒ‰</span>
                            <div class="space-y-5 text-gray-700 leading-relaxed text-base">
                                <p>æ˜¨å¹´åº¦ã€å‰µéƒ¨ã¾ã‚‚ãªãã—ã¦å¤ã®çœŒå¤§ä¼šåˆå„ªå‹ã‚’æœãŸã—ã€ç¬¬1ã‚·ãƒ¼ãƒ‰æ ¡ã¨ã—ã¦ä»Šå¤§ä¼šã«è‡¨ã¿ã¾ã™ã€‚ã—ã‹ã—ã€åˆå‡ºå ´ã¨ãªã£ãŸæ˜¨å¤ã®ç”²å­åœ’ã§ã¯åˆæˆ¦ï¼ˆå¯¾ æµ¦å’Œå­¦é™¢ 7-9ï¼‰ã§æ•—é€€ã€‚å…¨å›½ã®èˆå°ã§ã®ã€Œä¸€å‹ã€ã®é‡ã¿ã‚’ç—›æ„Ÿã—ã¾ã—ãŸã€‚</p>
                                <p>åå°†ãƒ»å¤©äº•åŠªç›£ç£ã®ä¸‹ã€æ˜¨å¹´ã®çµŒé¨“ã‚’ç³§ã«ã€ŒçœŒå¤§ä¼šé€£è¦‡ã€ã¨ã€ãã®å…ˆã®ã€Œç”²å­åœ’ã§ã®ä¸€å‹ã€ã‚’æºã‚‹ããªã„ç›®æ¨™ã¨ã—ã¦æ²ã’ã¦ã„ã¾ã™ã€‚ç‹è€…ã¨ã—ã¦ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‚’ã¯ã­ã®ã‘ã€ãƒãƒ¼ãƒ ã‚¹ãƒ­ãƒ¼ã‚¬ãƒ³ã§ã‚ã‚‹<strong class="font-bold text-blue-700">ã€å¼·ã€</strong>ã‚’ä½“ç¾ã—ã¾ã™ã€‚</p>
                            </div>
                            <div class="mt-10 bg-gray-50 p-6 rounded-lg border border-gray-200">
                                <h4 class="text-xl font-bold text-gray-800 mb-3">ç›£ç£ãƒ»éƒ¨é•·ã‚ã„ã•ã¤</h4>
                                <div class="flex items-start space-x-4">
                                    <div class="flex-shrink-0 w-24 h-24 bg-gray-300 rounded-md flex items-center justify-center text-gray-500 text-xs">[ç›£ç£ã‚¤ãƒ¡ãƒ¼ã‚¸]</div>
                                    <div>
                                        <p class="text-gray-700 italic">ã€Œæˆ‘ã€…ã®å¼·ã¿ã¯ã€å®ˆå‚™ã®ä¸€ä½“æ„Ÿã¨æ‰“ç·šã®ã¤ãªãŒã‚Šã§ã™ã€‚å§«å·ã€ç™½ç€¬ã‚’ä¸­å¿ƒã¨ã—ãŸæŠ•æ‰‹ãƒªãƒ¬ãƒ¼ã¯å…¨å›½ã§ã‚‚ãƒ”ã‚«ã‚¤ãƒã¨è‡ªè² ã—ã¦ã„ã¾ã™ã€‚å€‹ã®åŠ›ã«é ¼ã‚‰ãšã€å…¨å“¡ã®åŠ›ã‚’é›†ã‚ã¦ã€å¼·ã„ã€ãƒãƒ¼ãƒ ã¨ã—ã¦æˆ¦ã„ã¾ã™ã€‚ã€</p>
                                        <p class="text-right font-bold text-gray-800 mt-3">- 283å­¦åœ’é‡çƒéƒ¨ ç›£ç£ã€€å¤©äº• åŠª</p>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <section id="philosophy" class="bg-white p-8 rounded-xl shadow-xl fade-in-section">
                            <h2 class="text-3xl font-bold text-gray-900 section-title mb-8">æŒ‡å°æ–¹é‡ãƒ»ç·´ç¿’å†…å®¹</h2>
                            <div class="space-y-6 text-gray-700 leading-relaxed">
                                <div>
                                    <h4 class="text-xl font-bold text-blue-700 mb-2">1. IDé‡çƒã¨ãƒ‡ãƒ¼ã‚¿è§£æ</h4>
                                    <p>å¤©äº•ç›£ç£ã®æŒ‡å°ã®ä¸‹ã€å…¨è©¦åˆãƒ»å…¨ç·´ç¿’ã‚’æ˜ åƒãƒ‡ãƒ¼ã‚¿åŒ–ã€‚å°‚å±ã‚¢ãƒŠãƒªã‚¹ãƒˆãŒå¸¸é§ã™ã‚‹ã€Œãƒ‡ãƒ¼ã‚¿è§£æå®¤ã€ã«ã¦ã€é¸æ‰‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã€æ‰“çƒå‚¾å‘ã€æŠ•çƒã®å›è»¢æ•°ã«è‡³ã‚‹ã¾ã§ã‚’å¾¹åº•çš„ã«åˆ†æã€‚ç§‘å­¦çš„æ ¹æ‹ ã«åŸºã¥ã„ãŸã€ŒIDé‡çƒã€ãŒãƒãƒ¼ãƒ ã®åŸºç›¤ã§ã™ã€‚</p>
                                </div>
                                <div>
                                    <h4 class="text-xl font-bold text-blue-700 mb-2">2. ã€ŒäºŒè»ã€åˆ¶åº¦ã®å°å…¥ï¼ˆ283å­¦åœ’Bï¼‰</h4>
                                    <p>éƒ¨å“¡æ•°100åè¶…ã«å¯¾å¿œã™ã‚‹ãŸã‚ã€ä»–æ ¡ã«ã¯ãªã„ã€ŒäºŒè»ï¼ˆ283å­¦åœ’Bï¼‰ã€åˆ¶åº¦ã‚’å°å…¥ã€‚ä¸ƒè‰ã¯ã¥ãã‚³ãƒ¼ãƒã®æŒ‡å°ã®ä¸‹ã€Bãƒãƒ¼ãƒ ã‚‚ç‹¬è‡ªã®ç·´ç¿’è©¦åˆã‚’é‡ã­ã€Aãƒãƒ¼ãƒ ã¨å¸¸ã«å…¥ã‚Œæ›¿ãˆæˆ¦ã‚’è¡Œã†ç’°å¢ƒã‚’æ•´å‚™ã€‚ã“ã®ç†¾çƒˆãªå†…éƒ¨ç«¶äº‰ãŒã€ç‹è€…ã¨ã—ã¦ã®å±¤ã®åšã•ã‚’ç”Ÿã¿å‡ºã—ã¦ã„ã¾ã™ã€‚</p>
                                </div>
                            </div>
                        </section>

                        <section id="players" class="bg-white p-8 rounded-xl shadow-xl fade-in-section">
                            <h2 class="text-3xl font-bold text-gray-900 section-title mb-8">æ³¨ç›®é¸æ‰‹</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="player-card border p-5 rounded-lg bg-gray-50"><div class="flex justify-between items-baseline"><h5 class="text-xl font-bold text-blue-700">å§«å· (3å¹´ãƒ»æŠ•æ‰‹)</h5><span class="text-xs font-medium bg-red-100 text-red-800 px-2 py-0.5 rounded-full">ãƒ—ãƒ­æ³¨ç›®</span></div><p class="text-gray-700 mt-2">æŠ•æ‰“ã®ä¸­å¿ƒã€‚MAX151kmã®ç›´çƒã¨ã‚¹ãƒ—ãƒªãƒƒãƒˆã§åœ§å€’ã™ã‚‹æ€ªç‰©ã€‚é«˜æ ¡é€šç®—42æœ¬å¡æ‰“ã€‚</p></div>
                                <div class="player-card border p-5 rounded-lg bg-gray-50"><h5 class="text-xl font-bold text-blue-700">ç™½ç€¬ (3å¹´ãƒ»æŠ•æ‰‹)</h5><p class="text-gray-700 mt-2">çµ¶å¯¾çš„å®ˆè­·ç¥ã€‚MAX155kmã®ä¼¸ã³ä¸ŠãŒã‚‹ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãŒæ­¦å™¨ã€‚æ˜¥ã®é™å²¡é«˜æˆ¦ã§å®Œå…¨è©¦åˆã‚’é”æˆã€‚</p></div>
                                <div class="player-card border p-5 rounded-lg bg-white"><h5 class="text-xl font-bold text-gray-800">èŠ±æµ· å’² (3å¹´ãƒ»ä¸­å …æ‰‹)</h5><p class="text-gray-700 mt-2">1å¹´å¤ã‹ã‚‰ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ã®çµŒé¨“è±Šå¯Œãªã‚¹ãƒ©ãƒƒã‚¬ãƒ¼ã€‚èµ°æ”»å®ˆä¸‰æ‹å­æƒã£ãŸæ”»å®ˆã®è¦ã€‚</p></div>
                                <div class="player-card border p-5 rounded-lg bg-blue-50 border-blue-200"><div class="flex justify-between items-baseline"><h5 class="text-xl font-bold text-blue-700">èŠ±æµ· ä½‘ (1å¹´ãƒ»å³ç¿¼æ‰‹)</h5><span class="text-xs font-medium bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">1å¹´ç”Ÿ</span></div><p class="text-gray-700 mt-2">1å¹´ç”Ÿã®ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¹ã‚¿ãƒ¼ã€‚å…„ãƒ»å’²ã¨ã®é€£æºã‚‚æŠœç¾¤ã€‚å…¥å­¦ä»¥æ¥ã€æ—¢ã«é€šç®—13æœ¬å¡æ‰“ã‚’è¨˜éŒ²ã€‚</p></div>
                            </div>
                        </section>

                        <section id="roster" class="bg-white p-4 md:p-8 rounded-xl shadow-sm border border-gray-200 scroll-mt-24">
    <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 flex items-center">
        <span class="w-1.5 h-6 bg-blue-600 mr-3 rounded-full"></span>éƒ¨å“¡ç´¹ä»‹ (2025å¹´åº¦)
    </h2>
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="player-profile-card">
            <div class="player-profile-header flex items-baseline justify-between border-b pb-2 mb-2">
                <span class="text-3xl font-black text-blue-900 mr-2">1</span>

                                        <span class="player-profile-name">ç™½ç€¬</span>
                                        <span class="player-profile-grade">3å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[æŠ•]</strong> <strong>[å³æŠ•/å³æ‰“]</strong><br>
                                        184cm / 82kg<br>
                                        å‡ºèº«: æ±äº¬ã‚·ãƒ‹ã‚¢
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">2</span>
                                        <span class="player-profile-name">æœ‰æ –å·</span>
                                        <span class="player-profile-grade">3å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[æ•]</strong> <strong>[å³æŠ•/å·¦æ‰“]</strong><br>
                                        178cm / 78kg<br>
                                        å‡ºèº«: ç¥å¥ˆå·ãƒœãƒ¼ã‚¤ã‚º
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">3</span>
                                        <span class="player-profile-name">å§«å·</span>
                                        <span class="player-profile-grade">3å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[æŠ•/ä¸€]</strong> <strong>[å³æŠ•/å³æ‰“]</strong><br>
                                        182cm / 80kg<br>
                                        å‡ºèº«: å¤§é˜ªã‚·ãƒ‹ã‚¢
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">4</span>
                                        <span class="player-profile-name">æ¨‹å£</span>
                                        <span class="player-profile-grade">3å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[äºŒ]</strong> <strong>[å³æŠ•/å³æ‰“]</strong><br>
                                        170cm / 68kg<br>
                                        å‡ºèº«: é™å²¡è‘µä¸­å­¦
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">5</span>
                                        <span class="player-profile-name">å…«å®®</span>
                                        <span class="player-profile-grade">2å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[ä¸‰]</strong> <strong>[å³æŠ•/å³æ‰“]</strong><br>
                                        175cm / 72kg<br>
                                        å‡ºèº«: æµœæ¾ãƒœãƒ¼ã‚¤ã‚º
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">6</span>
                                        <span class="player-profile-name">åç‹</span>
                                        <span class="player-profile-grade">3å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[éŠ]</strong> <strong>[å³æŠ•/å·¦æ‰“]</strong><br>
                                        176cm / 70kg<br>
                                        å‡ºèº«: åå¤å±‹ãƒ‰ãƒªãƒ¼ãƒ ã‚¹
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">7</span>
                                        <span class="player-profile-name">èŠ¹æ²¢</span>
                                        <span class="player-profile-grade">2å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[å¤–]</strong> <strong>[å³æŠ•/ä¸¡æ‰“]</strong><br>
                                        172cm / 69kg<br>
                                        å‡ºèº«: æ²¼æ´¥ã‚·ãƒ‹ã‚¢
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">8</span>
                                        <span class="player-profile-name">èŠ±æµ·ä½‘</span>
                                        <span class="player-profile-grade">1å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[å¤–]</strong> <strong>[å³æŠ•/å³æ‰“]</strong><br>
                                        177cm / 73kg<br>
                                        å‡ºèº«: åŒ—æµ·é“ã‚·ãƒ‹ã‚¢
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">9</span>
                                        <span class="player-profile-name">èŠ±æµ·å’²</span>
                                        <span class="player-profile-grade">3å¹´<span class="player-profile-captain">(ä¸»å°†)</span></span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[å¤–]</strong> <strong>[å·¦æŠ•/å·¦æ‰“]</strong><br>
                                        178cm / 75kg<br>
                                        å‡ºèº«: åŒ—æµ·é“ã‚·ãƒ‹ã‚¢
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">10</span>
                                        <span class="player-profile-name">é»›</span>
                                        <span class="player-profile-grade">2å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[æŠ•]</strong> <strong>[å³æŠ•/å³æ‰“]</strong><br>
                                        180cm / 76kg<br>
                                        å‡ºèº«: å¯Œå£«ã‚·ãƒ‹ã‚¢
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">11</span>
                                        <span class="player-profile-name">å¸‚å·</span>
                                        <span class="player-profile-grade">2å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[æŠ•]</strong> <strong>[å·¦æŠ•/å·¦æ‰“]</strong><br>
                                        179cm / 74kg<br>
                                        å‡ºèº«: é™å²¡è’²åŸä¸­å­¦
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">12</span>
                                        <span class="player-profile-name">ç¦ä¸¸</span>
                                        <span class="player-profile-grade">2å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[æ•]</strong> <strong>[å³æŠ•/å³æ‰“]</strong><br>
                                        176cm / 77kg<br>
                                        å‡ºèº«: ç„¼æ´¥ãƒªãƒˆãƒ«ã‚·ãƒ‹ã‚¢
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">13</span>
                                        <span class="player-profile-name">éˆ´æœ¨</span>
                                        <span class="player-profile-grade">2å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[ä¸€]</strong> <strong>[å³æŠ•/å·¦æ‰“]</strong><br>
                                        181cm / 85kg<br>
                                        å‡ºèº«: æ„›çŸ¥ãƒœãƒ¼ã‚¤ã‚º
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">14</span>
                                        <span class="player-profile-name">æœ‰æ‘</span>
                                        <span class="player-profile-grade">1å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[å†…]</strong> <strong>[å³æŠ•/å³æ‰“]</strong><br>
                                        173cm / 67kg<br>
                                        å‡ºèº«: ç¦å²¡ã‚·ãƒ‹ã‚¢
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">15</span>
                                        <span class="player-profile-name">ç”°ä¸­</span>
                                        <span class="player-profile-grade">3å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[å†…]</strong> <strong>[å³æŠ•/å³æ‰“]</strong><br>
                                        174cm / 70kg<br>
                                        å‡ºèº«: é™å²¡æœç¹”ä¸­å­¦
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">16</span>
                                        <span class="player-profile-name">å¤§å´</span>
                                        <span class="player-profile-grade">1å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[å¤–]</strong> <strong>[å³æŠ•/å·¦æ‰“]</strong><br>
                                        170cm / 68kg<br>
                                        å‡ºèº«: ä¸‰å³¶ãƒªãƒˆãƒ«ã‚·ãƒ‹ã‚¢
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">17</span>
                                        <span class="player-profile-name">é¢¨é‡</span>
                                        <span class="player-profile-grade">2å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[å†…]</strong> <strong>[å³æŠ•/å³æ‰“]</strong><br>
                                        169cm / 65kg<br>
                                        å‡ºèº«: æ–°æ½Ÿã‚·ãƒ‹ã‚¢
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">18</span>
                                        <span class="player-profile-name">è¥¿åŸ</span>
                                        <span class="player-profile-grade">2å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[æŠ•]</strong> <strong>[å³æŠ•/å³æ‰“]</strong><br>
                                        183cm / 81kg<br>
                                        å‡ºèº«: åºƒå³¶ãƒœãƒ¼ã‚¤ã‚º
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">19</span>
                                        <span class="player-profile-name">æµ…å€‰</span>
                                        <span class="player-profile-grade">1å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[å†…]</strong> <strong>[å³æŠ•/å³æ‰“]</strong><br>
                                        168cm / 64kg<br>
                                        å‡ºèº«: é•·å´ã‚·ãƒ‹ã‚¢
                                    </div>
                                </div>
                                <div class="player-profile-card">
                                    <div class="player-profile-header">
                                        <span class="player-profile-number">20</span>
                                        <span class="player-profile-name">æœé‡</span>
                                        <span class="player-profile-grade">1å¹´</span>
                                    </div>
                                    <div class="player-profile-body">
                                        <strong>[å¤–]</strong> <strong>[å·¦æŠ•/å·¦æ‰“]</strong><br>
                                        171cm / 67kg<br>
                                        å‡ºèº«: å®®åŸã‚·ãƒ‹ã‚¢
                                    </div>
                                </div>
                            </div>
                        </section>
                        
                       <section id="facility" class="bg-white p-8 rounded-xl shadow-xl fade-in-section">
                            <h2 class="text-3xl font-bold text-gray-900 section-title mb-8">æ–½è¨­ç´¹ä»‹</h2>
                            <p class="text-gray-700 leading-relaxed mb-6">ãƒŠãƒ ã‚³ã‚°ãƒ«ãƒ¼ãƒ—ã®å…¨é¢çš„ãªæ”¯æ´ã«ã‚ˆã‚Šã€æœ¬æ ¡ã¯å…¨å›½ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã®ç·´ç¿’ç’°å¢ƒã‚’èª‡ã‚Šã¾ã™ã€‚ãƒãƒƒãƒ—ä¸Šã®ã€Œ<span class="font-bold text-blue-700">+</span>ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€å„æ–½è¨­ã‚’ã”è¦§ãã ã•ã„ã€‚</p>
                            
                            <div id="campus-map-container">
                                <img id="campus-map-image" src="https://img.freepik.com/premium-vector/university-campus-map-vector-illustration_147933-461.jpg" alt="283å­¦åœ’ ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒãƒƒãƒ—">

                                <div class="hotspot" style="top: 60%; left: 25%;" data-id="ground"><span>+</span></div>
                                <div class="hotspot" style="top: 35%; left: 45%;" data-id="dome"><span>+</span></div>
                                <div class="hotspot" style="top: 20%; left: 70%;" data-id="data-lab"><span>+</span></div>
                                
                                <div id="hotspot-popup" class="hotspot-popup hidden">
                                    <button id="hotspot-popup-close-btn" class="hotspot-popup-close">&times;</button>
                                    <img id="hotspot-popup-image" src="" alt="æ–½è¨­å†™çœŸ" class="hotspot-popup-image">
                                    <div class="hotspot-popup-content">
                                        <h4 id="hotspot-popup-title" class="hotspot-popup-title"></h4>
                                        <p id="hotspot-popup-text" class="hotspot-popup-text"></p>
                                    </div>
                                </div>
                            </div>
                        </section>                        
                        <section id="school-song" class="bg-white p-8 rounded-xl shadow-xl fade-in-section">
                            <h2 class="text-3xl font-bold text-gray-900 section-title mb-8">283å­¦åœ’ æ ¡æ­Œ</h2>
                            <div class="text-center max-w-lg mx-auto">
                                <p class="text-sm text-gray-600">ä½œè©: å¤©äº• åŠªã€€/ã€€ä½œæ›²: 283å­¦åœ’éŸ³æ¥½ç§‘</p>
                                <div class="mt-6"><p class="text-lg leading-relaxed text-gray-800">ä¸€ã€<br>è’¼ãç©º ä»°ãè¦‹ã‚‹<br>æˆ‘ã‚‰ãŒå­¦ã³èˆ 283å­¦åœ’<br>è‹¥ãç¿¼ï¼ˆã¤ã°ã•ï¼‰ èƒ¸ã«æŠ±ã<br>æœªæ¥ï¼ˆã‚ã™ï¼‰ã¸ã¨ç¾½ã°ãŸã å¼·ã„æ„å¿—<br>ã‚ã‚ è¼ã‘ã‚‹å…‰ã‚ˆ æˆ‘ã‚‰ã«ã‚ã‚Œ</p></div>
                                <div class="mt-8"><p class="text-lg leading-relaxed text-gray-800">äºŒã€<br>é å·ã®é¢¨ å—ã‘ãªãŒã‚‰<br>çœŸç†ï¼ˆã¾ã“ã¨ï¼‰ã‚’æ±‚ã‚ã‚“ å‹ã¨å…±ã«<br>é›ãˆã—çŸ¥æµ ç£¨ãã—æŠ€<br>ã€å¼·ã€ãªã‚‹ç†æƒ³ã‚’ è¿½ã„æ±‚ã‚ã¦<br>ã‚ã‚ èª‡ã‚Šé«˜ã æˆ‘ã‚‰ãŒ 283å­¦åœ’</p></div>
                            </div>
                        </section>

                        <section id="results" class="bg-white p-8 rounded-xl shadow-xl fade-in-section">
                            
                            <h2 class="text-3xl font-bold text-gray-900 section-title mb-8">2025å¹´ é¸æ‰‹æ¨©é™å²¡å¤§ä¼š (æœ€æ–°ã®æˆ¦ç¸¾)</h2>
                            <p class="text-gray-700 leading-relaxed mb-6">
                                ç¾åœ¨é€²è¡Œä¸­ã€ã¾ãŸã¯çµ‚äº†ã—ãŸæœ€æ–°ã®å¤§ä¼šã®æˆ¦ç¸¾ã§ã™ã€‚è©¦åˆãŒçµ‚äº†ã™ã‚‹ã¨ã€ã“ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚‚æ›´æ–°ã•ã‚Œã¾ã™ã€‚
                            </p>
                            <div id="current-tournament-bracket-container" class="bracket-wrapper">
                                <p class="text-center text-gray-500">ï¼ˆç¾åœ¨ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚’èª­ã¿è¾¼ã¿ä¸­...ï¼‰</p>
                            </div>
                            
                            <h2 class="text-3xl font-bold text-gray-900 section-title mb-8 mt-12">2024å¹´ é¸æ‰‹æ¨©é™å²¡å¤§ä¼š (æ˜¨å¹´åº¦)</h2>
                            
                            <p class="text-gray-700 leading-relaxed mb-6">
                                å§«å·(2å¹´)ã€èŠ±æµ·å’²(2å¹´)ã‚‰ã€ç¾3å¹´ç”ŸãŒä¸­å¿ƒã¨ãªã‚Šã€å‰µéƒ¨ä»¥æ¥åˆã®ã€Œå¤ã®ç”²å­åœ’ã€å‡ºå ´ã‚’æœãŸã—ãŸå¤§ä¼šã®å…¨è»Œè·¡ã§ã™ã€‚
                            </p>
                            <div class="bracket-wrapper">
                                <div class="tournament-container">
                                    <div class="bracket-half left">
                                        <div class="round r1">
                                            <div class="round-title">1å›æˆ¦</div>
                                            <div class="matchup"><div class="match"><div class="team winner hp-team-283"><span class="name">283å­¦åœ’</span><span class="score">20</span></div><div class="team loser"><span class="name">æ–°å±…</span><span class="score">0</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">æµœæ¾é–‹èª é¤¨</span><span class="score">7</span></div><div class="team loser"><span class="name">åˆæ˜Ÿå­¦åœ’</span><span class="score">0</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼</span><span class="score">10</span></div><div class="team loser"><span class="name">æµœæ¾ç‰¹æ”¯</span><span class="score">0</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">æ—¥å¤§ä¸‰å³¶</span><span class="score">8</span></div><div class="team loser"><span class="name">è£¾é‡</span><span class="score">1</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">æ›å·è¥¿</span><span class="score">5</span></div><div class="team loser"><span class="name">å¯Œå£«å®®åŒ—</span><span class="score">0</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">æ±æµ·å¤§ç¿”æ´‹</span><span class="score">6</span></div><div class="team loser"><span class="name">ç¾åŸå­¦åœ’</span><span class="score">2</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">è—¤ææ˜èª </span><span class="score">11</span></div><div class="team loser"><span class="name">æ²¼æ´¥é«˜å°‚</span><span class="score">1</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">é™å²¡å­¦åœ’</span><span class="score">9</span></div><div class="team loser"><span class="name">ä¸‰å³¶å—</span><span class="score">2</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">æµœæ¾å¸‚ç«‹</span><span class="score">7</span></div><div class="team loser"><span class="name">å¾¡æ®¿å ´å—</span><span class="score">6</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">ç£ç”°æ±</span><span class="score">4</span></div><div class="team loser"><span class="name">æµœæ¾å­¦é™¢</span><span class="score">3</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">ç„¼æ´¥æ°´ç”£</span><span class="score">5</span></div><div class="team loser"><span class="name">å¾¡æ®¿å ´è¥¿</span><span class="score">1</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">ç§‘å­¦æŠ€è¡“</span><span class="score">8</span></div><div class="team loser"><span class="name">èª æµ</span><span class="score">0</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">é™å²¡</span><span class="score">8</span></div><div class="team loser"><span class="name">å°å±±</span><span class="score">1</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">çŸ¥å¾³</span><span class="score">5</span></div><div class="team loser"><span class="name">è™åºœå³¶ç·åˆ</span><span class="score">4</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">é™æ¸…</span><span class="score">10</span></div><div class="team loser"><span class="name">å¯Œå£«æ±</span><span class="score">9</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner hp-team-283"><span>283å­¦åœ’B</span><span class="score">5</span></div><div class="team loser"><span class="name">ä¼Šè±†ä¼Šæ±</span><span class="score">3</span></div></div></div>
                                        </div>
                                        <div class="round r2">
                                            <div class="round-title">2å›æˆ¦</div>
                                            <div class="matchup"><div class="match"><div class="team winner hp-team-283"><span class="name">283å­¦åœ’</span><span class="score">11</span></div><div class="team loser"><span class="name">æµœæ¾é–‹èª é¤¨</span><span class="score">1</span></div></div><div class="connector-line"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼</span><span class="score">5</span></div><div class="team loser"><span class="name">æ—¥å¤§ä¸‰å³¶</span><span class="score">3</span></div></div><div class="connector-line"></div><div class="connector-path"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">æ›å·è¥¿</span><span class="score">4</span></div><div class="team loser"><span class="name">æ±æµ·å¤§ç¿”æ´‹</span><span class="score">0</span></div></div><div class="connector-line"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">è—¤ææ˜èª </span><span class="score">6</span></div><div class="team loser"><span class="name">é™å²¡å­¦åœ’</span><span class="score">4</span></div></div><div class="connector-line"></div><div class="connector-path"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">ç£ç”°æ±</span><span class="score">7</span></div><div class="team loser"><span class="name">æµœæ¾å¸‚ç«‹</span><span class="score">3</span></div></div><div class="connector-line"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">ç§‘å­¦æŠ€è¡“</span><span class="score">5</span></div><div class="team loser"><span class="name">ç„¼æ´¥æ°´ç”£</span><span class="score">2</span></div></div><div class="connector-line"></div><div class="connector-path"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">é™å²¡</span><span class="score">7</span></div><div class="team loser"><span class="name">çŸ¥å¾³</span><span class="score">0</span></div></div><div class="connector-line"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span>é™æ¸…</span><span class="score">7</span></div><div class="team loser hp-team-283"><span class="name">283å­¦åœ’B</span><span class="score">0</span></div></div><div class="connector-line"></div><div class="connector-path"></div></div>
                                        </div>
                                        <div class="round r3">
                                            <div class="round-title">3å›æˆ¦</div>
                                            <div class="matchup"><div class="match"><div class="team winner hp-team-283"><span class="name">283å­¦åœ’</span><span class="score">10</span></div><div class="team loser"><span class="name">è–éš·ã‚¯ãƒªã‚¹ãƒˆãƒ•ã‚¡ãƒ¼</span><span class="score">2</span></div></div><div class="connector-line"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">è—¤ææ˜èª </span><span class="score">5</span></div><div class="team loser"><span class="name">æ›å·è¥¿</span><span class="score">1</span></div></div><div class="connector-line"></div><div class="connector-path"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">ç§‘å­¦æŠ€è¡“</span><span class="score">3</span></div><div class="team loser"><span class="name">ç£ç”°æ±</span><span class="score">2</span></div></div><div class="connector-line"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">é™å²¡</span><span class="score">4</span></div><div class="team loser"><span class="name">é™æ¸…</span><span class="score">3</span></div></div><div class="connector-line"></div><div class="connector-path"></div></div>
                                        </div>
                                        <div class="round r4">
                                            <div class="round-title">æº–ã€…æ±ºå‹</div>
                                            <div class="matchup"><div class="match"><div class="team winner hp-team-283"><span class="name">283å­¦åœ’</span><span class="score">8</span></div><div class="team loser"><span class="name">è—¤ææ˜èª </span><span class="score">3</span></div></div><div class="connector-line"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">é™å²¡</span><span class="score">7</span></div><div class="team loser"><span class="name">ç§‘å­¦æŠ€è¡“</span><span class="score">0</span></div></div><div class="connector-line"></div><div class="connector-path"></div></div>
                                        </div>
                                        <div class="round r5">
                                            <div class="round-title">æº–æ±ºå‹</div>
                                            <div class="matchup"><div class="match"><div class="team winner hp-team-283"><span class="name">283å­¦åœ’</span><span class="score">6</span></div><div class="team loser"><span class="name">é™å²¡</span><span class="score">1</span></div></div><div class="connector-line"></div></div>
                                        </div>
                                    </div>
                                    <div class="bracket-final">
                                        <div class="round-title">æ±ºå‹</div>
                                        <div class="final-matchup">
                                            <div class="match">
                                                <div class="team winner hp-team-283"><span class="name">283å­¦åœ’</span><span class="score">5</span></div>
                                                <div class="team loser"><span class="name">å¸¸è‘‰èŠå·</span><span class="score">2</span></div>
                                            </div>
                                            <button id="show-boxscore-btn-2024" class="mt-2 w-full text-sm bg-blue-600 text-white font-bold px-4 py-2 rounded hover:bg-blue-700 transition-all">
                                                æ±ºå‹æˆ¦ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢
                                            </button>
                                            </div>
                                        <div class="winner-box">
                                            <h2>ğŸ† å„ªå‹ 283å­¦åœ’</h2>
                                        </div>
                                    </div>
                                    <div class="bracket-half right">
                                        <div class="round r1">
                                            <div class="round-title">1å›æˆ¦</div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span>å¸¸è‘‰èŠå·</span><span class="score">15</span></div><div class="team loser"><span class="name">å·æ ¹</span><span class="score">1</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">æµœæ¾å·¥æ¥­</span><span class="score">6</span></div><div class="team loser"><span class="name">å³¶ç”°å·¥æ¥­</span><span class="score">0</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">765ç·åˆé«˜æ ¡</span><span class="score">8</span></div><div class="team loser"><span class="name">è¢‹äº•</span><span class="score">1</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">å¸¸è‘‰æ©˜</span><span class="score">10</span></div><div class="team loser"><span class="name">æ¡é™½</span><span class="score">1</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">é§¿æ²³ç·åˆ</span><span class="score">7</span></div><div class="team loser"><span class="name">é£›é¾</span><span class="score">0</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">åŠ è—¤å­¦åœ’</span><span class="score">11</span></div><div class="team loser"><span class="name">ç£ç”°å—</span><span class="score">0</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">ä¼Šè±†ç·åˆ</span><span class="score">5</span></div><div class="team loser"><span class="name">å¯Œå£«å®®è¥¿</span><span class="score">4</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">éŸ®å±±</span><span class="score">6</span></div><div class="team loser"><span class="name">å¸‚ç«‹æ²¼æ´¥</span><span class="score">3</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">ä¸‰å³¶åŒ—</span><span class="score">10</span></div><div class="team loser"><span class="name">æ¹–è¥¿</span><span class="score">0</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">å¯Œå£«å¸‚ç«‹</span><span class="score">7</span></div><div class="team loser"><span class="name">ç†±æµ·</span><span class="score">1B</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">ã‚ªã‚¤ã‚¹ã‚«æµœæ¾å›½éš›</span><span class="score">4</span></div><div class="team loser"><span class="name">é™å²¡å¸‚ç«‹</span><span class="score">3</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">æµœæ¾å•†æ¥­</span><span class="score">9</span></div><div class="team loser"><span class="name">åŸå—é™å²¡</span><span class="score">2</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">é™å²¡å•†æ¥­</span><span class="score">7</span></div><div class="team loser"><span class="name">æµœæ¾å—</span><span class="score">0</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">å³¶ç”°</span><span class="score">4</span></div><div class="team loser"><span class="name">ä¼Šè±†ä¸­å¤®</span><span class="score">2</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">æ²¼æ´¥åŸåŒ—</span><span class="score">8</span></div><div class="team loser"><span class="name">æµœæ¾åŸåŒ—å·¥æ¥­</span><span class="score">7</span></div></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">å¤©ç«œ</span><span class="score">5</span></div><div class="team loser"><span class="name">ä¸‹ç”°</span><span class="score">0</span></div></div></div>
                                        </div>
                                        <div class="round r2">
                                            <div class="round-title">2å›æˆ¦</div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">å¸¸è‘‰èŠå·</span><span class="score">9</span></div><div class="team loser"><span class="name">æµœæ¾å·¥æ¥­</span><span class="score">0</span></div></div><div class="connector-line"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span>å¸¸è‘‰æ©˜</span><span class="score">4</span></div><div class="team loser"><span class="name">765ç·åˆé«˜æ ¡</span><span class="score">3</span></div></div><div class="connector-line"></div><div class="connector-path"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">é§¿æ²³ç·åˆ</span><span class="score">5</span></div><div class="team loser"><span class="name">åŠ è—¤å­¦åœ’</span><span class="score">4</span></div></div><div class="connector-line"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">éŸ®å±±</span><span class="score">8</span></div><div class="team loser"><span class="name">ä¼Šè±†ç·åˆ</span><span class="score">1B</span></div></div><div class="connector-line"></div><div class="connector-path"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">ä¸‰å³¶åŒ—</span><span class="score">8</span></div><div class="team loser"><span class="name">å¯Œå£«å¸‚ç«‹</span><span class="score">1G</span></div></div><div class="connector-line"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">æµœæ¾å•†æ¥­</span><span class="score">6</span></div><div class="team loser"><span class="name">ã‚ªã‚¤ã‚¹ã‚«æµœæ¾å›½éš›</span><span class="score">5</span></div></div><div class="connector-line"></div><div class="connector-path"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">é™å²¡å•†æ¥­</span><span class="score">10</span></div><div class="team loser"><span class="name">å³¶ç”°</span><span class="score">0</span></div></div><div class="connector-line"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">å¤©ç«œ</span><span class="score">4</span></div><div class="team loser"><span class="name">æ²¼æ´¥åŸåŒ—</span><span class="score">0</span></div></div><div class="connector-line"></div><div class="connector-path"></div></div>
                                        </div>
                                        <div class="round r3">
                                            <div class="round-title">3å›æˆ¦</div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">å¸¸è‘‰èŠå·</span><span class="score">7</span></div><div class="team loser"><span class="name">å¸¸è‘‰æ©˜</span><span class="score">0</span></div></div><div class="connector-line"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span>éŸ®å±±</span><span class="score">5</span></div><div class="team loser"><span class="name">é§¿æ²³ç·åˆ</span><span class="score">2</span></div></div><div class="connector-line"></div><div class="connector-path"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">ä¸‰å³¶åŒ—</span><span class="score">2</span></div><div class="team loser"><span class="name">æµœæ¾å•†æ¥­</span><span class="score">0</span></div></div><div class="connector-line"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">é™å²¡å•†æ¥­</span><span class="score">6</span></div><div class="team loser"><span class="name">å¤©ç«œ</span><span class="score">1</span></div></div><div class="connector-line"></div><div class="connector-path"></div></div>
                                        </div>
                                        <div class="round r4">
                                            <div class="round-title">æº–ã€…æ±ºå‹</div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">å¸¸è‘‰èŠå·</span><span class="score">7</span></div><div class="team loser"><span class="name">éŸ®å±±</span><span class="score">1</span></div></div><div class="connector-line"></div></div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">é™å²¡å•†æ¥­</span><span class="score">3</span></div><div class="team loser"><span class="name">ä¸‰å³¶åŒ—</span><span class="score">0</span></div></div><div class="connector-line"></div><div class="connector-path"></div></div>
                                        </div>
                                        <div class="round r5">
                                            <div class="round-title">æº–æ±ºå‹</div>
                                            <div class="matchup"><div class="match"><div class="team winner"><span class="name">å¸¸è‘‰èŠå·</span><span class="score">4</span></div><div class_name="name">é™å²¡å•†æ¥­</span><span class="score">3</span></div></div><div class="connector-line"></div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-6 mt-12">
                            <div><h3 class="text-xl font-bold text-gray-800">2023å¹´ï¼ˆ2å¹´ç”Ÿï¼‰</h3><hr class="my-2"><p class="text-sm text-gray-600">ç§‹å­£é™å²¡å¤§ä¼š å„ªå‹ / é¸æ‰‹æ¨©é™å²¡å¤§ä¼š æ±ºå‹æ•—é€€ (å¯¾ 765ç·åˆ 2-3) / æ˜¥å­£é™å²¡å¤§ä¼š æ±ºå‹æ•—é€€ (å¯¾ åŠ è—¤å­¦åœ’ 1-2)</p></div>
                            <div><h3 class="text-xl font-bold text-gray-800">2022å¹´ï¼ˆ1å¹´ç”Ÿï¼‰</h3><hr class="my-2"><p class="text-sm text-gray-600">ç§‹å­£é™å²¡å¤§ä¼š æº–æ±ºå‹æ•—é€€ / é¸æ‰‹æ¨©é™å²¡å¤§ä¼š æº–æ±ºå‹æ•—é€€</p></div>
                            <div><h3 class="text-xl font-bold text-gray-800">2021å¹´ï¼ˆå‰µéƒ¨2å¹´ç›®ï¼‰</h3><hr class="my-2"><p class="text-sm text-gray-600">ç§‹å­£é™å²¡å¤§ä¼š æº–ã€…æ±ºå‹æ•—é€€ / é¸æ‰‹æ¨©é™å²¡å¤§ä¼š 4å›æˆ¦æ•—é€€</p></div>
                            <div><h3 class="text-xl font-bold text-gray-800">2020å¹´ï¼ˆå‰µéƒ¨1å¹´ç›®ï¼‰</h3><hr class="my-2"><p class="text-sm text-gray-600">ç§‹å­£é™å²¡å¤§ä¼š 2å›æˆ¦æ•—é€€ / é¸æ‰‹æ¨©é™å²¡å¤§ä¼š 2å›æˆ¦æ•—é€€</p></div>
                        </div>
                    </section>

                    <section id="ob-career" class="bg-white p-4 md:p-8 rounded-xl shadow-sm border border-gray-200 scroll-mt-24">
    <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 flex items-center">
        <span class="w-1.5 h-6 bg-blue-600 mr-3 rounded-full"></span>OBã®ä¸»ãªé€²è·¯
    </h2>
    <p class="text-sm text-gray-600 leading-relaxed mb-4">
        å‰µéƒ¨ã¾ã‚‚ãªããªãŒã‚‰ã€å’æ¥­ç”Ÿã¯é‡çƒã‚’ç¶™ç¶šã™ã‚‹é“ã‚’é¸ã‚“ã§ã„ã¾ã™ã€‚<br>
        <span class="text-xs text-gray-400">â€»è¡¨ã¯æ¨ªã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã¾ã™</span>
    </p>
    
    <div class="table-scroll-wrapper">
        <table class="w-full min-w-[600px] text-left text-sm whitespace-nowrap">
            <thead class="bg-gray-50 border-b">
                <tr>
                    <th class="px-4 py-3 font-semibold text-gray-700">é¸æ‰‹å</th>
                    <th class="px-4 py-3 font-semibold text-gray-700">å’æ¥­å¹´åº¦</th>
                    <th class="px-4 py-3 font-semibold text-gray-700">ãƒã‚¸ã‚·ãƒ§ãƒ³</th>
                    <th class="px-4 py-3 font-semibold text-gray-700">ä¸»ãªé€²è·¯</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                <tr class="hover:bg-blue-50">
                    <td class="px-4 py-3 font-medium">é«˜å±± ç¿¼</td>
                    <td class="px-4 py-3">2025å¹´3æœˆå’</td>
                    <td class="px-4 py-3">æŠ•æ‰‹</td>
                    <td class="px-4 py-3 font-bold text-blue-800">æ±äº¬å…­å¤§å­¦ãƒªãƒ¼ã‚° (é€²å­¦)</td>
                </tr>
                <tr class="hover:bg-blue-50">
                    <td class="px-4 py-3 font-medium">æ—©å· ç¬</td>
                    <td class="px-4 py-3">2025å¹´3æœˆå’</td>
                    <td class="px-4 py-3">å†…é‡æ‰‹</td>
                    <td class="px-4 py-3 font-bold text-blue-800">ç¤¾ä¼šäººé‡çƒ (ãƒŠãƒ ã‚³G)</td>
                </tr>
                 <tr class="hover:bg-blue-50">
                    <td class="px-4 py-3 font-medium">ä¼Šé›†é™¢ åŒ—æ–—</td>
                    <td class="px-4 py-3">2024å¹´3æœˆå’</td>
                    <td class="px-4 py-3">å¤–é‡æ‰‹</td>
                    <td class="px-4 py-3 font-bold text-blue-800">æ±éƒ½å¤§å­¦ãƒªãƒ¼ã‚° (é€²å­¦)</td>
                </tr>
            </tbody>
        </table>
    </div>
</section>
                    <section id="gallery" class="bg-white p-8 rounded-xl shadow-xl fade-in-section">
                        <h2 class="text-3xl font-bold text-gray-900 section-title mb-8">ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <a href="https://source.unsplash.com/random/1200x800/?baseball,victory" target="_blank" class="gallery-image aspect-video rounded-lg overflow-hidden shadow-md"><img src="https://source.unsplash.com/random/800x600/?baseball,victory" alt="æ˜¨å¤ å„ªå‹ã®ç¬é–“" class="w-full h-full object-cover"></a>
                            <a href="https://source.unsplash.com/random/1200x800/?baseball,pitcher" target="_blank" class="gallery-image aspect-video rounded-lg overflow-hidden shadow-md"><img src="https://source.unsplash.com/random/800x600/?baseball,pitcher" alt="å§«å·ã®æŠ•çƒãƒ•ã‚©ãƒ¼ãƒ " class="w-full h-full object-cover"></a>
                            <a href="https://source.unsplash.com/random/1200x800/?baseball,stadium" target="_blank" class="gallery-image aspect-video rounded-lg overflow-hidden shadow-md"><img src="https://source.unsplash.com/random/800x600/?baseball,stadium" alt="ç”²å­åœ’ã§ã®è©¦åˆé¢¨æ™¯" class="w-full h-full object-cover"></a>
                            <a href="https://source.unsplash.com/random/1200x800/?baseball,batter" target="_blank" class="gallery-image aspect-video rounded-lg overflow-hidden shadow-md"><img src="https://source.unsplash.com/random/800x600/?baseball,batter" alt="èŠ±æµ·ä½‘ã®ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°" class="w-full h-full object-cover"></a>
                            <a href="https://source.unsplash.com/random/1200x800/?baseball,practice" target="_blank" class="gallery-image aspect-video rounded-lg overflow-hidden shadow-md"><img src="https://source.unsplash.com/random/800x600/?baseball,practice" alt="å®¤å†…ç·´ç¿’å ´ã§ã®æ‰“æ’ƒç·´ç¿’" class="w-full h-full object-cover"></a>
                            <a href="https://source.unsplash.com/random/1200x800/?baseball,team" target="_blank" class="gallery-image aspect-video rounded-lg overflow-hidden shadow-md"><img src="https://source.unsplash.com/random/800x600/?baseball,team" alt="ãƒãƒ¼ãƒ å…¨å“¡ã§ã®å††é™£" class="w-full h-full object-cover"></a>
                        </div>
                    </section>

                    <section id="access" class="bg-white p-8 rounded-xl shadow-xl fade-in-section">
                        <h2 class="text-3xl font-bold text-gray-900 section-title mb-8">ã‚¢ã‚¯ã‚»ã‚¹</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div><img src="https://source.unsplash.com/random/800x600/?map" alt="åœ°å›³" class="w-full h-64 object-cover rounded-lg"></div>
                            <div class="text-gray-700">
                                <h4 class="text-lg font-semibold mb-2">283å­¦åœ’ é«˜ç­‰å­¦æ ¡</h4>
                                <p class="mb-4">ã€’430-XXXX é™å²¡çœŒæµœæ¾å¸‚ï¼ˆãƒ€ãƒŸãƒ¼ä½æ‰€ï¼‰</p>
                                <h5 class="font-semibold mb-1">é›»è»Šã§ãŠè¶Šã—ã®å ´åˆ</h5>
                                <p class="mb-4">JRã€Œæµœæ¾é§…ã€ã‚ˆã‚Šãƒã‚¹ã§ç´„20åˆ†ã€ã€Œ283å­¦åœ’å‰ã€ä¸‹è»Šã™ãã€‚</p>
                                <h5 class="font-semibold mb-1">ãŠè»Šã§ãŠè¶Šã—ã®å ´åˆ</h5>
                                <p>æ±åé«˜é€Ÿé“è·¯ã€Œæµœæ¾ICã€ã‚ˆã‚Šç´„15åˆ†ã€‚<br>(â€»æ¥å®¢ç”¨é§è»Šå ´ã«ã¯é™ã‚ŠãŒã”ã–ã„ã¾ã™)</p>
                            </div>
                        </div>
                    </section>

                </main>

                <aside id="news" class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-xl shadow-xl sticky top-24">
                        <h3 class="text-xl font-bold text-blue-800 section-title mb-6">ãŠçŸ¥ã‚‰ã›</h3>
                        
                        <ul id="homepage-dynamic-news-list" class="space-y-4 mb-6 border-b pb-4 hidden">
                            </ul>
                        
                        <ul class="space-y-4">
                            <li><span class="text-sm text-gray-500">2025/11/10</span><p class="font-semibold text-gray-800 hover:text-blue-600 cursor-pointer">æ–‡åŒ–ç¥­ã€Œ283ãƒ•ã‚§ã‚¹ãƒ†ã‚£ãƒãƒ«ã€é–‹å‚¬ã®ãŠçŸ¥ã‚‰ã›</p></li>
                            <li><span class="text-sm text-gray-500">2025/11/05</span><p class="font-semibold text-gray-800 hover:text-blue-600 cursor-pointer">ã€é‡çƒéƒ¨ã€‘å¤ã®é¸æ‰‹æ¨©å¤§ä¼š çµ„ã¿åˆã‚ã›æ±ºå®š</p></li>
                            <li><span class="text-sm text-gray-500">2025/11/01</span><p class="font-semibold text-gray-800 hover:text-blue-600 cursor-pointer">ã€é‡çƒéƒ¨ã€‘æ˜¥å­£å¤§ä¼šå„ªå‹ã€ç¬¬1ã‚·ãƒ¼ãƒ‰æ±ºå®šï¼</p></li>
                            <li><span class="text-sm text-gray-500">2025/10/28</span><p class="font-semibold text-gray-800 hover:text-blue-600 cursor-pointer">ã€é‡çƒéƒ¨ã€‘1å¹´ç”Ÿãƒ»èŠ±æµ·ä½‘ ç·´ç¿’è©¦åˆã§2HR</p></li>
                            <li><span class="text-sm text-gray-500">2025/10/20</span><p class="font-semibold text-gray-800 hover:text-blue-600 cursor-pointer">ã‚ªãƒ¼ãƒ—ãƒ³ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã®ç”³ã—è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚</p></li>
                        </ul>
                    </div>
                </aside>

            </div>
        </div>

        <footer class="homepage-footer">
    <div class="container mx-auto px-6 text-center">
        <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-4">
            <div class="flex items-center gap-2">
                 <div class="w-6 h-6 bg-gray-400 rounded flex items-center justify-center text-white font-bold text-xs">2</div>
                 <p class="font-bold text-lg text-gray-700">283å­¦åœ’ é«˜ç­‰å­¦æ ¡</p>
            </div>
            <span class="hidden md:inline text-gray-300">|</span>
            <p class="text-sm text-gray-500">ç¡¬å¼é‡çƒéƒ¨ å…¬å¼ã‚µã‚¤ãƒˆ</p>
        </div>
        
        <div class="flex justify-center gap-6 mb-4 text-xs font-medium text-gray-400">
            <a href="#" class="hover:text-blue-600 transition">å­¦æ ¡ãƒˆãƒƒãƒ—</a>
            <a href="#" class="hover:text-blue-600 transition">å…¥è©¦æƒ…å ±</a>
            <a href="#" class="hover:text-blue-600 transition">ãŠå•ã„åˆã‚ã›</a>
        </div>

        <p class="text-[10px] text-gray-400">
            &copy; 2025 Tsubasa Gakuen High School. All rights reserved. Powered by Namco Group
        </p>
    </div>
</footer>
 </div>
        </div>
 </div>
        



<div id="boxscore-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 modal-hidden items-center justify-center z-[160]">
    <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl w-full max-w-6xl max-h-[95vh] flex flex-col">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 id="boxscore-modal-title" class="text-xl font-bold text-gray-800">ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢</h3>
            <button id="boxscore-modal-close" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        <div id="boxscore-modal-body" class="overflow-y-auto flex-grow">
            <div class="loader text-center py-16">ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚³ã‚¢ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>
</div>

<div id="scorecard-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center z-[180]">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[95vh] flex flex-col">
        
        <div id="scorecard-header" class="flex-shrink-0 flex justify-between items-center border-b p-3 md:p-4 bg-gray-800 text-white rounded-t-lg">
            <div class="flex items-center">
                <span id="scorecard-inning" class="text-xl md:text-3xl font-bold mr-3">1å›è¡¨</span>
                <span id="scorecard-at-bat" class="text-sm md:text-lg">
                    æ‰“è€…: <span id="scorecard-batter-name" class="font-semibold">---</span>
                </span>
            </div>
            <div class="flex items-center space-x-3 md:space-x-4">
                <div id="scorecard-outs" class="text-lg md:text-xl font-semibold">
                    <span class="text-gray-400">â—</span> <span class="text-gray-400">â—</span> <span class="text-gray-400">â—</span>
                </div>
                <div id="scorecard-teams" class="text-right">
                    <div id="scorecard-team1" class="text-sm md:text-base font-semibold">TEAM A: 0</div>
                    <div id="scorecard-team2" class="text-sm md:text-base font-semibold">TEAM B: 0</div>
                </div>
            </div>
        </div>

        <div class="scorecard-grid flex-grow overflow-y-auto bg-gray-100">

            <div id="baseball-diamond-container" class="flex items-center justify-center p-4">
                <div class="baseball-diamond">
                    <div id="base-1b" class="base"></div>
                    <div id="base-2b" class="base"></div>
                    <div id="base-3b" class="base"></div>
                    <div id="base-home" class="base"></div>
                    <div id="pitchers-mound"></div>
                    
                    <div id="pos-p" class="direction-hotspot" data-direction="æŠ•">æŠ•</div>
                    <div id="pos-c" class="direction-hotspot" data-direction="æ•">æ•</div>
                    <div id="pos-1b" class="direction-hotspot" data-direction="ä¸€">ä¸€</div>
                    <div id="pos-2b" class="direction-hotspot" data-direction="äºŒ">äºŒ</div>
                    <div id="pos-3b" class="direction-hotspot" data-direction="ä¸‰">ä¸‰</div>
                    <div id="pos-ss" class="direction-hotspot" data-direction="éŠ">éŠ</div>
                    <div id="pos-lf" class="direction-hotspot" data-direction="å·¦">å·¦</div>
                    <div id="pos-cf" class="direction-hotspot" data-direction="ä¸­">ä¸­</div>
                    <div id="pos-rf" class="direction-hotspot" data-direction="å³">å³</div>
                </div>
            </div>

           <div id="scorecard-actions" class="p-2 md:p-4">
                
                <div id="scorecard-result-panel">
                    <h4 class="font-bold mb-2 text-gray-700">STEP 1: æ‰“å¸­çµæœ</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <button class="result-btn result-btn-hit" data-action="hit-1b">[ 1B ] ãƒ’ãƒƒãƒˆ</button>
                        <button class="result-btn result-btn-hit" data-action="hit-2b">[ 2B ] äºŒå¡æ‰“</button>
                        <button class="result-btn result-btn-hit" data-action="hit-3b">[ 3B ] ä¸‰å¡æ‰“</button>
                        <button class="result-btn result-btn-hit" data-action="hit-hr">[ HR ] æœ¬å¡æ‰“</button>
                        <button class="result-btn result-btn-walk" data-action="walk-bb">[ BB ] å››çƒ</button>
                        <button class="result-btn result-btn-walk" data-action="walk-hbp">[ HBP ] æ­»çƒ</button>
                        <button class="result-btn result-btn-out" data-action="out-k">[ K ] ä¸‰æŒ¯</button>
                        <button class="result-btn result-btn-out" data-action="out-go">[ GO ] ã‚´ãƒ­</button>
                        <button class="result-btn result-btn-out" data-action="out-fo">[ FO ] ãƒ•ãƒ©ã‚¤</button>
                        <button class="result-btn result-btn-out" data-action="out-dp">[ DP ] ä½µæ®º</button>
                        <button class="result-btn result-btn-out" data-action="out-sac-b">[ SH ] çŠ æ‰“</button>
                        <button class="result-btn result-btn-out" data-action="out-sac-f">[ SF ] çŠ é£›</button>
                        <button class="result-btn result-btn-other" data-action="other-error">[ E ] ã‚¨ãƒ©ãƒ¼</button>
                        <button class="result-btn result-btn-other" data-action="other-fc">[ FC ] é‡é¸</button>
                    </div>
                </div>

                <div id="scorecard-rbi-panel" class="hidden">
                    <h4 class="font-bold mb-2 text-green-700">STEP 3: æ‰“ç‚¹/å¾—ç‚¹</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <button class="rbi-btn" data-rbi="0">[ 0ç‚¹ ]</button>
                        <button class="rbi-btn" data-rbi="1">[ 1ç‚¹ ]</button>
                        <button class="rbi-btn" data-rbi="2">[ 2ç‚¹ ]</button>
                        <button class="rbi-btn" data-rbi="3">[ 3ç‚¹ ]</button>
                        <button class="rbi-btn" data-rbi="4">[ 4ç‚¹ ]</button>
                    </div>
                </div>

                <h4 class="font-bold mt-4 mb-2 text-gray-700">èµ°å¡ãƒ»ãã®ä»–</h4>
                <div class="grid grid-cols-3 gap-2">
                    <button class="result-btn result-btn-hit" data-action="run-sb">[ SB ] ç›—å¡</button>
                    <button class="result-btn result-btn-out" data-action="run-cs">[ CS ] ç›—å¡æ­»</button>
                    <button class="result-btn result-btn-out" data-action="run-other-out">[ OUT ] èµ°å¡æ­»</button>
                </div>
            </div>

            <div id="scorecard-log" class="p-2 md:p-4">
                <h4 class="font-bold mb-2 text-gray-700">ç°¡æ˜“ãƒ­ã‚°</h4>
                <div id="scorecard-log-content" class="h-24 md:h-full w-full bg-gray-200 rounded p-2 text-xs overflow-y-auto font-mono">
                    (ã“ã“ã«ãƒ—ãƒ¬ãƒ¼ãŒè¨˜éŒ²ã•ã‚Œã¾ã™)
                </div>
            </div>

        </div>

        <div class="flex-shrink-0 flex justify-between items-center border-t p-4 bg-gray-50 rounded-b-lg">
            <button id="scorecard-undo-btn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">
                1ãƒ—ãƒ¬ãƒ¼æˆ»ã™
            </button>
            <div>
                <button id="scorecard-save-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 mr-4">
                    ä¿å­˜ã—ã¦é–‰ã˜ã‚‹
                </button>
                <button id="scorecard-close-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </div>
    </div>
</div>

<div id="pre-game-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden flex items-center justify-center z-[200]">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="pre-game-title" class="text-xl font-bold">è©¦åˆå‰ å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
                <button id="pre-game-modal-close" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            
            <div class="flex border-b mb-4">
                <button id="pre-game-tab-team1" class="pre-game-team-tab py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent" data-team-key="team1">
                    ï¼ˆãƒãƒ¼ãƒ 1ï¼‰
                </button>
                <button id="pre-game-tab-team2" class="pre-game-team-tab py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent" data-team-key="team2">
                    ï¼ˆãƒãƒ¼ãƒ 2ï¼‰
                </button>
            </div>
            <div id="pre-game-body" class="overflow-y-auto space-y-3 p-2 bg-gray-50 rounded min-h-[200px]">
                <p class="text-gray-500 text-center p-8">â†‘ è¦‹ãŸã„ãƒãƒ¼ãƒ ã®å¿œæ´å¸­ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ â†‘</p>
            </div>
        </div>
    </div>

<div id="substitution-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center z-[150]">

    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
        <h3 class="text-xl font-bold mb-4 border-b pb-3">å®ˆå‚™äº¤ä»£</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">é¸æ‰‹å</label>
                <input type="text" id="sub-modal-player-name" class="w-full bg-gray-100 p-2 border rounded" readonly>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="sub-modal-inning" class="block text-sm font-medium text-gray-700">ã‚¤ãƒ‹ãƒ³ã‚°</label>
                    <input type="number" id="sub-modal-inning" value="1" min="1" max="20" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="sub-modal-top-bottom" class="block text-sm font-medium text-gray-700">è¡¨ / è£</label>
                    <select id="sub-modal-top-bottom" class="w-full p-2 border rounded bg-white">
                        <option value="è¡¨">è¡¨</option>
                        <option value="è£">è£</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">äº¤ä»£ã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
                <div class="flex gap-4 mt-1">
                    <label><input type="radio" name="sub-timing" id="sub-modal-timing-start" value="start" checked> ã‚¤ãƒ‹ãƒ³ã‚°é–‹å§‹æ™‚</label>
                    <label><input type="radio" name="sub-timing" id="sub-modal-timing-mid" value="mid"> ã‚¤ãƒ‹ãƒ³ã‚°é€”ä¸­</label>
                </div>
            </div>

            <div id="sub-modal-mid-inning-details" class="hidden space-y-3 p-3 bg-gray-50 rounded border">
                <div>
                    <label for="sub-modal-outs" class="block text-sm font-medium text-gray-700">ã‚¢ã‚¦ãƒˆã‚«ã‚¦ãƒ³ãƒˆ</label>
                    <select id="sub-modal-outs" class="w-full p-2 border rounded bg-white">
                        <option value="0">0ã‚¢ã‚¦ãƒˆ</option>
                        <option value="1">1ã‚¢ã‚¦ãƒˆ</option>
                        <option value="2">2ã‚¢ã‚¦ãƒˆ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ãƒ©ãƒ³ãƒŠãƒ¼çŠ¶æ³</label>
                    <div class="flex gap-4 mt-1">
                        <label><input type="checkbox" id="sub-modal-runner1"> 1å¡</label>
                        <label><input type="checkbox" id="sub-modal-runner2"> 2å¡</label>
                        <label><input type="checkbox" id="sub-modal-runner3"> 3å¡</label>
                    </div>
                </div>
            </div>
            <div>
                <label for="sub-modal-new-pos" class="block text-sm font-medium text-gray-700">æ–°ã—ã„å®ˆå‚™ä½ç½®</label>
                <select id="sub-modal-new-pos" class="w-full p-2 border rounded bg-white">
                    <option value="">- é¸æŠ -</option>
                    <option value="æŠ•">æŠ•æ‰‹ (æŠ•)</option>
                    <option value="æ•">æ•æ‰‹ (æ•)</option>
                    <option value="ä¸€">ä¸€å¡æ‰‹ (ä¸€)</option>
                    <option value="äºŒ">äºŒå¡æ‰‹ (äºŒ)</option>
                    <option value="ä¸‰">ä¸‰å¡æ‰‹ (ä¸‰)</option>
                    <option value="éŠ">éŠæ’ƒæ‰‹ (éŠ)</option>
                    <option value="å·¦">å·¦ç¿¼æ‰‹ (å·¦)</option>
                    <option value="ä¸­">ä¸­å …æ‰‹ (ä¸­)</option>
                    <option value="å³">å³ç¿¼æ‰‹ (å³)</option>
                </select>
            </div>
        </div>

        <div class="mt-6 text-center border-t pt-4">
            <button id="sub-modal-save" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 mr-4">
                äº¤ä»£ã‚’è¨˜éŒ²
            </button>
            <button id="sub-modal-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
        </div>
    </div>
</div>


<div id="skip-newspaper-modal" class="newspaper-modal-backdrop hidden">
    <div class="skip-newspaper-container">
        <div class="skip-newspaper-header">
            <span class="skip-newspaper-logo">é™å²¡ ç†±é—˜æ–°è</span>
            <h1 class="skip-newspaper-title" id="skip-newspaper-top-title">ç™½ç†±ã®æˆ¦ã„ã€é™å²¡ã‚’å¸­å·»</h1>
            <p id="skip-newspaper-date" class="skip-newspaper-date">2025å¹´7æœˆ15æ—¥ ç™ºè¡Œ</p>
        </div>
        
        <div id="skip-newspaper-body" class="skip-newspaper-body">
            <div class="skip-newspaper-main-headline">
                æ³¢ä¹±ç¶šå‡º
            </div>
            
            <div class="skip-newspaper-main-article">
                <div class="skip-newspaper-main-image">
                    å†™çœŸï¼šç†±æˆ¦ã®ç¬é–“
                </div>
                <p class="skip-newspaper-image-caption">æ¿€é—˜ã®æœ«ã€å‹åˆ©ã‚’æ´ã‚“ã é¸æ‰‹ãŸã¡ã®é›„å§¿</p>
                <div class="skip-newspaper-main-body">
                    <h4>æ¿€æˆ¦ã‚’åˆ¶ã—ã€æ¬¡ãªã‚‹èˆå°ã¸</h4>
                    <p>æœ¬æ—¥è¡Œã‚ã‚ŒãŸãƒ©ã‚¦ãƒ³ãƒ‰ã§ã¯ã€å„åœ°ã§æ‰‹ã«æ±—æ¡ã‚‹æ¿€æˆ¦ãŒç¹°ã‚Šåºƒã’ã‚‰ã‚ŒãŸã€‚å¼·è±ªæ ¡ãŒé †å½“ã«å‹ã¡ä¸ŠãŒã‚‹ä¸­ã€æ€ã‚ã¬ç•ªç‹‚ã‚ã›ã‚‚ç™ºç”Ÿã€‚é¸æ‰‹ãŸã¡ã®ç†±ã„æ€ã„ãŒè©°ã¾ã£ãŸãƒ—ãƒ¬ãƒ¼ã«ã€è¦³è¡†ã¯æƒœã—ã¿ãªã„æ‹æ‰‹ã‚’é€ã£ãŸã€‚ç‰¹ã«æ³¨ç›®ã•ã‚ŒãŸã®ã¯ã€å„ªå‹å€™è£œã®ä¸€è§’ãŒæ•—ã‚Œã‚‹æ³¢ä¹±ã®ä¸€æˆ¦ã€‚å‹åˆ©ã—ãŸãƒãƒ¼ãƒ ã¯ã€æŒã¡å‰ã®ç²˜ã‚Šå¼·ã•ã‚’ç™ºæ®ã—ã€æ¥æˆ¦ã‚’ã‚‚ã®ã«ã—ãŸã€‚</p>
                    <p>ã“ã®çµæœã€æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ã¸ã®é€²å‡ºã‚’æ±ºã‚ãŸãƒãƒ¼ãƒ ã¯ã€ã•ã‚‰ãªã‚‹é«˜ã¿ã‚’ç›®æŒ‡ã™ã“ã¨ã«ãªã‚‹ã€‚æ•—ã‚ŒãŸãƒãƒ¼ãƒ ã‚‚ã¾ãŸã€ãã®å¥é—˜ã‚’ç§°ãˆã‚‰ã‚Œã€æ¥å¹´ã¸ã®é›ªè¾±ã‚’èª“ã£ãŸã€‚å¤ã®ç”²å­åœ’ã‚’ç›®æŒ‡ã™æˆ¦ã„ã¯ã€ã¾ã™ã¾ã™ç†±æ°—ã‚’å¸¯ã³ã¦ãã¦ã„ã‚‹ã€‚</p>
                </div>
            </div>

            <div class="skip-newspaper-side-article right">
                <h3 class="skip-newspaper-side-headline">ä»Šæ—¥ã®æ³¨ç›®é¸æ‰‹</h3>
                <div class="skip-newspaper-main-image" style="height: 120px;">
                    å†™çœŸï¼šæ³¨ç›®ã®æŠ•æ‰‹
                </div>
                <p class="skip-newspaper-image-caption">èºå‹•ã™ã‚‹ã‚¨ãƒ¼ã‚¹ã®æŠ•çƒ</p>
                <div class="skip-newspaper-side-body">
                    <p>ã€‡ã€‡é«˜æ ¡ã®ã‚¨ãƒ¼ã‚¹ã€ç”°ä¸­é¸æ‰‹ã¯æœ¬æ—¥ã‚‚åœ§å·»ã®ãƒ”ãƒƒãƒãƒ³ã‚°ã‚’æŠ«éœ²ã€‚ç²˜ã‚‹ç›¸æ‰‹æ‰“ç·šã‚’å®Œç’§ã«æŠ‘ãˆè¾¼ã¿ã€ãƒãƒ¼ãƒ ã‚’å‹åˆ©ã«å°ã„ãŸã€‚</p>
                    <p>å½¼ã®ä»Šå¤§ä¼šã§ã®æ´»èºã¯ç›®è¦šã¾ã—ãã€æ¬¡æˆ¦ã§ã®æŠ•çƒã«ã‚‚å¤§ããªæœŸå¾…ãŒå¯„ã›ã‚‰ã‚Œã¦ã„ã‚‹ã€‚</p>
                </div>
            </div>

            <div class="skip-newspaper-side-article left">
                <h3 class="skip-newspaper-side-headline">æ³¢ä¹±ã®èˆå°è£</h3>
                <div class="skip-newspaper-side-body">
                    <p>å„ªå‹å€™è£œã®ä¸€è§’ãŒã¾ã•ã‹ã®æ•—é€€ã‚’å–«ã—ãŸè©¦åˆã§ã¯ã€è©¦åˆå·§è€…ã®ç›¸æ‰‹ãƒãƒ¼ãƒ ãŒè¦‹äº‹ãªé‡‡é…ã§å‹åˆ©ã‚’æ‰‹ç¹°ã‚Šå¯„ã›ãŸã€‚åºç›¤ã‹ã‚‰ãƒªãƒ¼ãƒ‰ã‚’è¨±ã™è‹¦ã—ã„å±•é–‹ãªãŒã‚‰ã€ä¸­ç›¤ã®é›†ä¸­æ‰“ã§é€†è»¢ã€‚å®ˆå‚™é™£ã‚‚å …å®Ÿãªãƒ—ãƒ¬ãƒ¼ã§æµã‚Œã‚’æ¸¡ã•ãªã‹ã£ãŸã€‚</p>
                    <p>ã“ã®çµæœã¯ã€é«˜æ ¡é‡çƒã«ãŠã‘ã‚‹ã€Œä½•ãŒèµ·ã“ã‚‹ã‹ã‚ã‹ã‚‰ãªã„ã€ã¨ã„ã†é†é†å‘³ã‚’æ”¹ã‚ã¦ç¤ºã™ã‚‚ã®ã¨ãªã£ãŸã€‚</p>
                </div>
            </div>

            <div class="skip-newspaper-results-section">
                <h2 id="skip-newspaper-results-title">ç¬¬ã€‡å›æˆ¦ å…¨è©¦åˆçµæœ</h2>
                <div id="skip-newspaper-match-grid" class="skip-newspaper-match-grid">
                    </div>
            </div>
        </div>
        
        <div class="skip-newspaper-footer">
            <button id="skip-newspaper-close-btn" class="bg-gray-500 text-white font-bold py-1.5 px-5 rounded-md hover:bg-gray-600 text-sm">
                é–‰ã˜ã‚‹
            </button>
            <span class="ml-4">Â© 2025 é™å²¡ ç†±é—˜æ–°è å…¨è‘—ä½œæ¨©æ‰€æœ‰</span>
        </div>
    </div>
</div>

<div id="scout-report-view-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center z-[200]">
    <div class="bg-[#f0fdf4] rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col border-t-4 border-green-600">
        
        <div class="flex-shrink-0 flex justify-between items-center border-b border-green-200 px-6 py-4 bg-white rounded-t-lg">
            <h3 class="text-xl font-bold text-green-800 flex items-center" style="font-family: 'Noto Serif JP', serif;">
                <span class="text-2xl mr-2">ğŸ“</span> ç·¨é›†éƒ¨ãƒ»æ —å±±ã®ã‚¹ã‚«ã‚¦ãƒ†ã‚£ãƒ³ã‚°ãƒ¬ãƒãƒ¼ãƒˆ
            </h3>
            <button id="scout-report-view-close" class="text-gray-400 hover:text-green-700 text-3xl transition-colors">&times;</button>
        </div>
        
        <div id="scout-report-view-body" class="flex-grow overflow-y-auto p-6 text-gray-800 leading-loose text-base" style="font-family: 'Noto Serif JP', serif;">
            </div>
        
        <div class="p-4 border-t border-green-200 bg-gray-50 text-center rounded-b-lg">
            <button onclick="document.getElementById('scout-report-view-modal').classList.add('hidden')" class="bg-green-600 text-white font-bold py-2 px-8 rounded hover:bg-green-700 transition-colors shadow">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>
</div>

<div id="hero-interview-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-[300] font-sans transition-opacity duration-300">
    <div class="bg-gray-900 w-full max-w-4xl h-[80vh] rounded-xl shadow-2xl flex flex-col overflow-hidden border border-gray-700 relative">
        
        <div id="camera-flash" class="absolute inset-0 bg-white opacity-0 pointer-events-none z-10"></div>

        <div class="flex-1 bg-gray-800 p-6 flex flex-col items-center justify-center text-center relative">
            <div class="mb-4">
                <div class="w-24 h-24 bg-gray-600 rounded-full mx-auto flex items-center justify-center text-4xl border-4 border-gray-500 shadow-lg">
                    ğŸ¤
                </div>
                <p class="text-gray-400 text-sm mt-2 font-bold">ç¾½ç”° é›„å¹³ï¼ˆæ±æµ·ã‚¹ãƒãƒ¼ãƒ„ï¼‰</p>
            </div>
            
            <div id="interviewer-bubble" class="bg-white text-gray-900 p-6 rounded-2xl rounded-t-none shadow-lg max-w-2xl text-xl font-bold leading-relaxed relative animate-fade-in-up">
                <span class="absolute -top-3 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[10px] border-b-white"></span>
                <p id="interviewer-text">ï¼ˆã“ã“ã«AIè¨˜è€…ã®è³ªå•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...ï¼‰</p>
            </div>
        </div>

        <div class="bg-gray-900 p-6 border-t border-gray-700">
            <div class="max-w-3xl mx-auto">
                <p class="text-blue-400 text-sm font-bold mb-2 text-center">YOUR ANSWER (éŸ³å£°å…¥åŠ›å¯¾å¿œ)</p>
                
                <div class="relative">
                    <textarea id="interview-answer-input" class="w-full bg-gray-800 text-white p-4 pr-16 rounded-lg border border-gray-600 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 outline-none transition-all resize-none text-lg" rows="3" placeholder="ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã—ã¦ãã ã•ã„..."></textarea>
                    
                    <button id="voice-rec-btn" class="absolute right-3 top-3 w-12 h-12 rounded-full bg-gray-700 hover:bg-red-600 text-white flex items-center justify-center transition-all duration-300 shadow-lg group">
                        <span class="text-2xl group-hover:scale-110 transition-transform">ğŸ™ï¸</span>
                        <span class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-ping hidden" id="rec-indicator"></span>
                    </button>
                </div>

                <div class="flex justify-between items-center mt-4">
                    <p id="voice-status" class="text-gray-500 text-sm">å¾…æ©Ÿä¸­...</p>
                    <button id="submit-interview-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-8 rounded-full shadow-lg transform transition hover:scale-105 flex items-center">
                        <span>å›ç­”ã™ã‚‹</span>
                        <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="virtual-card-overlay" class="virtual-card-overlay">
    <div id="virtual-card" class="virtual-card">
        </div>
</div>

<div id="lineup-manager-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden items-center justify-center z-[200] font-sans">
    <div class="bg-slate-800 w-full h-full md:h-[90vh] md:max-w-5xl md:rounded-xl shadow-2xl flex flex-col border border-slate-600">
        
        <div class="flex justify-between items-center p-4 bg-slate-900 border-b border-slate-700 text-white sticky top-0 z-10 flex-shrink-0">
            <div>
                <h3 class="text-lg md:text-xl font-bold flex items-center text-blue-400">
                    <span class="text-xl md:text-2xl mr-2">âš”ï¸</span> ã‚¹ã‚¿ãƒ¡ãƒ³ç·¨æˆ
                </h3>
                <p class="text-xs text-gray-400 mt-1">é¸æ‰‹ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠã—ã€å…¥æ›¿å…ˆã‚’ã‚¿ãƒƒãƒ—</p>
            </div>
            <button id="lineup-manager-close-btn" class="p-2 text-gray-400 hover:text-white text-3xl font-bold leading-none">&times;</button>
        </div>
        
        <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
            
            <div class="w-full md:w-1/2 flex flex-col border-b md:border-b-0 md:border-r border-slate-700 basis-1/2 min-h-0">
                <h4 class="p-3 bg-slate-800/90 text-white font-bold text-sm border-b border-blue-500/50 flex justify-between items-center sticky top-0 z-10 backdrop-blur-sm">
                    <span class="flex items-center gap-2"><span class="w-2 h-2 bg-blue-500 rounded-full"></span>ã‚¹ã‚¿ãƒ¡ãƒ³ (Starting)</span>
                    <button id="reset-lineup-btn" class="text-xs bg-slate-600 hover:bg-slate-500 text-white px-3 py-1.5 rounded border border-slate-500 transition">å…ƒã«æˆ»ã™</button>
                </h4>
                <div id="lineup-starters-container" class="flex-grow overflow-y-auto p-3 space-y-1 scrollbar-thin">
                    </div>
            </div>

            <div class="w-full md:w-1/2 flex flex-col basis-1/2 min-h-0 bg-slate-900/30">
                <h4 class="p-3 bg-slate-800/90 text-white font-bold text-sm border-b border-gray-600 flex items-center sticky top-0 z-10 backdrop-blur-sm">
                    <span class="w-2 h-2 bg-gray-500 rounded-full mr-2"></span>ãƒ™ãƒ³ãƒ (Bench)
                </h4>
                <div id="lineup-bench-container" class="flex-grow overflow-y-auto p-3 space-y-1 scrollbar-thin">
                    </div>
            </div>
        </div>

        <div class="p-4 border-t border-slate-700 bg-slate-900 text-center flex-shrink-0 pb-8 md:pb-4">
            <button id="lineup-manager-save-btn" class="w-full md:w-auto bg-gradient-to-r from-blue-600 to-blue-500 text-white font-bold py-3 px-12 rounded-full hover:from-blue-500 hover:to-blue-400 shadow-lg transform transition active:scale-95 text-lg tracking-wider">
                ã“ã®ã‚ªãƒ¼ãƒ€ãƒ¼ã§æ±ºå®š
            </button>
        </div>
    </div>
</div>

    </body>
</html>F